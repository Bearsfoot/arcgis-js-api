// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.

define(["dojo/_base/lang","dojo/dom-class","dojo/dom-construct","./GridRowStyler","../GridDataUtil","../GridQueryUtil","../gridLayoutCalcUtils/GridLayoutCalculatorQueryUtil","esri/dijit/geoenrichment/utils/DnDUtil","esri/dijit/geoenrichment/utils/TooltipUtil","dojo/i18n!esri/nls/jsapi"],(function(r,e,t,o,n,l,a,i,d,u){u=u.geoenrichment.dijit.ReportPlayer.Grid;var c={ORDER_ASC:"asc",ORDER_DES:"desc",isGridSortable:function(r){return!(!r.allowSorting||!(r.viewModel.dynamicReportInfo||r.presetSorting&&!r.ignorePresetSorting)||!c.isGridSortableInStructure(r))},isGridSortableInStructure:function(r){return!(r.isEmptyTable()||r.store.data.length<3||!c.collectHeaderRowInfoFromData(r))},getSorting:function(r){var e=r._sortInfo||r.presetSorting;return e&&{field:e.field,order:e.order}},applySortingToStoreData:function(r){c.isGridSortable(r)&&c._applySortingToStoreData(r)},setSorting:function(r,e,t){if(c.isGridSortable(r)&&e){if(r.presetSorting=null,r._sortInfo={field:e.field,order:e.order},!t||!t.doNotRefresh)return r.refresh();c._makeSortable(r)}},buildSortControls:function(r){c.isGridSortable(r)&&c._makeSortable(r)},getSortRowIndexMapping:function(r){var e=c.getSorting(r);if(!e||!e.order)return null;var t={},o={};return r._getOriginalData().forEach((function(r,e){o[r.id]=e})),r.store.data.forEach((function(r,e){t[e]=o[r.id]})),t},getSortableDataInfo:function(e){function t(t){var o=[],n=c.collectHeaderRowInfoFromData(e,t);if(!n)return null;for(var l=t?e._getOriginalData().slice():r.clone(e.store.data),a=0;a<n.headerRowIndex+1;a++)o.push(l.shift());return{topData:o,sortableData:l}}var n=t();return n&&(n.styleInfo=o.getStyleInfo(t(!0).sortableData,e.columns)),n},_applySortingToStoreData:function(r){var e=c.getSorting(r);if(e&&e.order){r._saveOriginalData();var t=c.getSortableDataInfo(r),l=e.field,a=r.columns.filter((function(r){return r.field===l}))[0];a&&t.sortableData.sort((function(t,o){function l(e){var t=n.getRenderedValue(r,e,a);return"number"==typeof t.numericValue?t.numericValue:t.formattedValue}var i,d=l(t),u=l(o),s=e.order===c.ORDER_DES;return"number"==typeof d||"number"==typeof u?(i=(d=Number(d))>(u=Number(u))?1:d<u?-1:0,s?-i:i):(d=String(d),u=String(u),i=d.localeCompare(u),s?-i:i)})),t.styleInfo&&o.setAlternatingColors(t.sortableData,r.columns,t.styleInfo),r.store.data=t.topData.concat(t.sortableData)}}};return c.collectHeaderRowInfoFromData=function(r,e){var t=e?r._getOriginalData():r.store.data;function o(e){return function(e){for(var o=t[e],n=0,l=0;l<r.columns.length;l++){var i=a.getColumnSpannedFields(r,o,r.columns[l].field);l+=i&&i.length?i.length-1:0,n++}return n}(e)===r.columns.length}for(var n,l=t.length-2,i=0;i<l;i++)if(o(i)){n=i;break}if(!(n>=0))return null;for(i=n+1;i<t.length;i++)if(!o(i))return null;return{headerRowIndex:n}},c._makeSortable=function(r){var o=c._collectHeaderRowInfoWithCells(r);o&&(o.cells.forEach((function(o){if(!o._sortArrow){var n=t.create("div",{class:"sortArrow sortArrowHoverIndicator"},o.domNode),l=o.getFullStyle();n.style[l&&"left"===l.horizontalAlign?"right":"left"]="5px",o._sortArrow=n,r.viewModel.dynamicReportInfo&&(e.add(o.domNode,"esriGEClickable"),i.addNoDragClickHandler(o.contentBlock,(function(e){r&&r.canSortCellFunc&&!r.canSortCellFunc(o)||c._checkCanSortOnHeaderClick(e)&&c._toggleSortForCell(o)})),i.addNoDragClickHandler(n,(function(r){c._toggleSortForCell(o)})))}})),c._updateArrows(r,o))},c._collectHeaderRowInfoWithCells=function(r){function e(e){return e&&e.length===r.columns.length}for(var t,o,n=r.store.data.length-2,a=0;a<n;a++){var i=l.queryCells(r,{rowIndex:a});if(e(i)){t=i,o=a;break}}if(!t)return null;for(a=o+1;a<r.store.data.length;a++)if(!e(i=l.queryCells(r,{rowIndex:a})))return null;return{cells:t,headerRowIndex:o}},c._toggleSortForCell=function(r){var e=r.parentGrid,t=c.getSorting(e),o=t&&t.field===r.column.field?t.order:null;e.presetSorting=null,e._sortInfo={field:r.column.field,order:null},o?o===c.ORDER_DES?e._sortInfo.order=c.ORDER_ASC:o===c.ORDER_ASC&&(e._sortInfo.order=null):e._sortInfo.order=c.ORDER_DES,e.refresh(),e.onSortingChanged(c.getSorting(e))},c._checkCanSortOnHeaderClick=function(r){if(r&&r.path){if(r.path.some((function(r){return"A"===r.nodeName})))return!1}else if(r&&r.srcElement&&r.srcElement.parentNode&&"A"===r.srcElement.parentNode.nodeName)return!1;return!0},c._updateArrows=function(r,t){t.cells.forEach((function(t){var o=t._sortArrow;if(o){e.remove(o,"sortArrowHoverIndicator sortArrowUp sortArrowDown"),d.setTooltipToNode(o,null);var n=c.getSorting(r);n&&n.field===t.column.field?n.order===c.ORDER_ASC?e.add(o,"sortArrowUp"):n.order===c.ORDER_DES?e.add(o,"sortArrowDown"):(d.setTooltipToNode(o,u.sortTable),e.add(o,"sortArrowHoverIndicator")):(d.setTooltipToNode(o,u.sortTable),e.add(o,"sortArrowHoverIndicator")),setTimeout((function(){o.style.top=(t.getHeight()-o.clientHeight)/2+"px"}),100)}}))},c}));