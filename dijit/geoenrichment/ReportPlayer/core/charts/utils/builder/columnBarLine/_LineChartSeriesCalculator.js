// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.

define(["dojo/_base/lang","../../ThemeCalculator","../../ChartTypes","../../ChartLineStyles","../../ChartLineMarkers","../../AxisUtil","../utils/TooltipInfoBuilder","../ChartPlots","esri/dijit/geoenrichment/utils/ColorUtil","./_AxisBuilder","./_PointLabelUtil","./_StatsBuilder"],(function(e,r,i,a,t,l,n,s,o,u,m,p){var c=function(e,l,n,s){var u=s.comparisonInfo,m=s.themeSettings,p=s.visualProperties,c=e.lineThickness||p.lineThickness||1,S=1,h=1,k=1;p.fillLineArea?(S="number"==typeof p.lineOpacity?p.lineOpacity:p.lineAreaOpacity,h=p.lineAreaOpacity):"number"==typeof p.lineOpacity&&(S=p.lineOpacity);var d=r.calcColorForPoint({point:null,seriesItem:e,pointIndex:0,seriesIndex:l,numSeries:n.length,chartType:i.LINE,themeSettings:m,isComparisonSeries:e.isComparisonSeries,comparisonInfo:u,isMultiFeature:s.isMultiFeatureChart});S<1&&d&&((d=o.toColor(d)).a=S);var I,y,C,M,f=e.lineStyle||a.SOLID,g=e.lineMarkerSize,x=o.toColor(e.fillColor||d);return x.a=h,(C=o.toColor(e.lineMarkerColor||d)).a=S,k="number"==typeof p.lineMarkersFillOpacity?p.lineMarkersFillOpacity:h,(M=o.toColor(e.lineMarkerFillColor||x)).a=k,e.isComparisonSeries&&u?(u.lineThickness&&(c=u.lineThickness),u.lineStyle&&(f=u.lineStyle),u.lineMarkerSize&&(g=u.lineMarkerSize),u.lineMarker?(y=t.getMarkerPath(u.lineMarker),I=t.getMarkerPath(u.lineMarker,g)):(y=r.getComparisonSymbol(),I=r.getComparisonSymbol(g)),u.lineMarkerColor&&((C=o.toColor(u.lineMarkerColor)).a=S),u.lineMarkerFillColor&&((M=o.toColor(u.lineMarkerFillColor)).a=h)):s.viewModel.isGraphicStyle&&(y=e.lineMarker&&t.getMarkerPath(e.lineMarker)||t.getMarkerPathAt(l),I=e.lineMarker&&t.getMarkerPath(e.lineMarker,g)||t.getMarkerPathAt(l,g)),{lineColor:d,width:c,style:a.toGFXValue(f),marker:I,unscaledMarker:y,markerColor:C,markerFillColor:M,fillColor:x}};return{calcSeriesLine:function(r){var t=r.chart,o=r.chartType,S=r.visualProperties,h=r.seriesItems,k=1===h.length,d=r.seriesItemsWithComparison||h,I=r.isSecondaryPlot,y=r.reverseXY||o===i.VERTICAL_LINE,C=r.comparisonInfo,M=r.themeSettings,f=r.viewModel,g=[],x=new p({visualProperties:S,seriesItems:d,viewModel:f,currentFeatureIndex:r.currentFeatureIndex,isMultiFeatureChart:r.isMultiFeatureChart,comparisonFeatureAttributes:r.comparisonFeatureAttributes,chartType:o,isSecondaryPlot:I,oppositeDirections:r.oppositeDirections,excludedSeriesHash:r.excludedSeriesHash}),v=r.primaryPlotStat&&r.primaryPlotStat.pointIndexToTooltipsHash||{};var V=x.getTotalStats();if(d.forEach((function(e,i){if(e.points.length){var l=c(e,i,d,r),u={name:e.label,data:[],isComparisonSeries:e.isComparisonSeries,params:{plot:I?s.SECONDARY:void 0,fill:S.fillLineArea?l.fillColor:"transparent",stroke:{color:l.lineColor,width:l.width,style:l.style},marker:l.marker,unscaledMarker:l.unscaledMarker,markerStroke:{color:l.markerColor,width:l.width,style:a.toGFXValue(a.SOLID)},markerFill:S.fillLineMarkers?l.markerFillColor:"transparent",outline:!1}},p=x.gettatisticsForSeriesAt(i);e.points.forEach((function(a,l){if(!a.hidden){var s=p.values[l],c=s.value,h=c||0,M=l+1;I||m.updatePointIndexToLabelMap(t,M,i,a,f);var g=r.isMultiFeatureChart&&V.crossSeriesStats[l],x={originalValue:c,isUnavailableData:isNaN(c),unsortedIndex:l,originalIndex:a.originalIndex||l,name:m.getPointLabel(a,f),valuesSumsInSeries:p.absSumInSeries,seriesItem:e,seriesIndex:i,point:a,isBenchmarked:s.isBenchmarked,unbenchmarkedValue:s.ownValue};y?(x.x=h*A(),x.y=M+F(),x.valueProp="x"):(x.x=M+F(),x.y=h*A(),x.valueProp="y"),S.showValuesAsWeightInStack?x[y?"x":"y"]=p.weightsInStack?100*p.weightsInStack[l]:0:S.yAxis.showValuesAsWeightsInSeries&&(x[y?"x":"y"]/=p.absSumInSeries/100);var P=n.getTooltipInfo({yValue:c,pointLabel:m.getPointLabel(d[0].points[l]||a,f),seriesLabel:e.label,minInSeriesValue:p.minInSeries,maxInSeriesValue:p.maxInSeries,sumInSeriesValue:p.sumInSeries,absSumInSeriesValue:p.absSumInSeries,avgInSeriesValue:p.avgInSeries,weightInStack:p.weightsInStack&&p.weightsInStack[l],minInAreasValue:g&&g.min,maxInAreasValue:g&&g.max,sumInAreasValue:g&&g.sum,absSumInAreasValue:g&&g.absSum,avgInAreasValue:g&&g.avg,visualProperties:S,chartType:o,isMultiFeature:r.isMultiFeatureChart,conditionalStyling:null,fieldInfo:a.fieldInfo,isThisAreaSpecific:C&&!r.isMultiFeatureChart?!e.isComparisonSeries:void 0,isThisAreaSingleSeries:k,decimals:a.value&&a.value.decimals,fill:u.params.markerFill,stroke:u.params.markerStroke.color,marker:u.params.unscaledMarker||u.params.marker,isBenchmarked:s.isBenchmarked,unbenchmarkedValue:s.ownValue}),b=v[M]=v[M]||[];b.push(P),P.getGroup=function(){return b},x.tooltip=P,u.data.push(x)}function A(){return I&&r.oppositeDirections&&1===i?-1:1}function F(){return I&&!r.oppositeDirections&&2===r.primarySeries.length?0===i?-.15:.15:0}})),g.push(u)}}),this),I){if(r.primaryPlotStat){r.primaryPlotStat.minYValue=Math.min(V.minYValue,r.primaryPlotStat.minYValue),r.primaryPlotStat.maxYValue=Math.max(V.maxYValue,r.primaryPlotStat.maxYValue);var P=l.getPrettifyYAxisParameters(r.primaryPlotStat.minYValue,r.primaryPlotStat.maxYValue,{baseLineValue:S.yAxis.baseLineValue,renderColumnBarsInOppositeDirections:r.oppositeDirections,previewBelowZero:!f.dynamicReportInfo,nonZeroInclusive:S.yAxis.nonZeroInclusive});e.mixin(t.axes.y.opt,{majorTickStep:P.majorTickStep,minorTickStep:P.minorTickStep,min:P.min,max:P.max})}if(1===r.primarySeries.length){var b=y?"y":"x",A=[];r.primarySeries[0].data.forEach((function(e){var r=g[0].data[e.unsortedIndex];r[b]=e.x,A.push(r)})),g[0].data=A}}else u.prettifyYAxis(V.minYValue,V.maxYValue,t,S,o,M,f);return g}}}));