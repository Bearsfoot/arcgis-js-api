// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/aspect","dojo/on","esri/dijit/geoenrichment/when","dojo/dom-class","dojo/dom-construct","dojo/dom-style","dojo/query","./SimpleInfographicViewModes","../../grid/coreUtils/GridDataUtil","./dataDrilling/DataDrillingLibrary","../utils/InfographicJsonUtil","esri/dijit/geoenrichment/utils/DelayUtil","esri/dijit/geoenrichment/utils/DeviceUtil","esri/dijit/geoenrichment/utils/DnDUtil","esri/dijit/geoenrichment/utils/DomUtil","esri/dijit/geoenrichment/utils/MouseUtil","esri/dijit/geoenrichment/utils/TooltipUtil","esri/dijit/geoenrichment/utils/WaitingUtil","../../sections/SectionTypes","../../sections/sectionUtils/SectionJsonUtil","../../supportClasses/ViewModes","./DataDrillingBackgroundUtil","./DataDrillingExportUtil","dojo/i18n!esri/nls/jsapi"],(function(t,i,e,n,o,a,l,s,r,c,d,h,u,g,D,f,m,p,S,w,_,y,v,I,P){P=P.geoenrichment.dijit.ReportPlayer.Infographics;var B={w:700,h:600,minW:400,minH:500},M=t(null,{_drillingSections:null,_drillingSectionsButtons:null,postCreate:function(){var t=this;this.inherited(arguments),e(this.backToMainViewButton,"click",(function(){t._setViewMode(r.VIEW_MAIN,!0)})),g.isMobileDevice()&&this.own(e(window,"resize, orientationchange",(function(){t._setViewMode(r.VIEW_MAIN,!1)}))),f.hide([this.exportButton,this.printButton]),this.viewModel.dynamicReportInfo&&(I.canExportDataDrilling(this)&&(p.setTooltipToNode(this.exportButton,P.exportInfographic),f.show(this.exportButton),e(this.exportButton,"click",(function(){I.exportDataDrilling(t)}))),I.canPrintDataDrilling(this)&&(p.setTooltipToNode(this.printButton,P.printInfographic),f.show(this.printButton),e(this.printButton,"click",(function(){I.printDataDrilling(t)}))))},_getCountryID:function(){return this.viewModel.dynamicReportInfo.infographicOptions.countryID},_addDataDrillingHandlers:function(t,i){var e=this;this.onShowWaiting(n(d.init({variableProvider:this.viewModel.dynamicReportInfo.templateVariableProvider,countryID:this.viewModel.dynamicReportInfo.countryID}),(function(){var n=c.getFieldInfo(i.getFirstCell()),a=h.getDataDrilling(e._currentInfographicJson,n.templateName),l=a&&a.sectionJson?a:null,s=a&&a.isStandard&&d.getDrillingOptions(e._getCountryID(),a.standardId||n),u=s&&s[0];(l||u)&&(o.add(e.domNode,"hasDataDrilling"),t.getTables().forEach((function(t){t.getFieldCells().forEach((function(t){p.setTooltipToNode(t.domNode,null)}))})),e._setUpDataDrillingButton(t,(function(t){var i=e._setViewMode(r.VIEW_DATA_DRILLING,!0,t,l&&l.sectionJson);l?e._renderCustomSectionJson({customDDPanelInfo:l,fieldInfo:n,animationPromise:i}):e._loadStandardDataDrillingView({fieldInfo:n,optionName:u.name,calcState:null,sectionVisualState:null,animationPromise:i})})))})))},_shownButtons:null,_setUpDataDrillingButton:function(t,i){var n,o=this;function s(){var i=a.create("div",{class:"simpleInfographic_drillDataButton"},t.domNode);a.create("div",{class:"dijitInline simpleInfographic_drillDataButtonIcon esriGESpaceAfterBig"},i);var e=a.create("div",{class:"dijitInline simpleInfographic_drillDataButtonLabel",innerHTML:P.drillForMoreData},i),n=[];t.getTables().forEach((function(t){n.push(t.domNode)}));var s=f.uniteNodeBoxes(n,t.domNode);l.set(i,{left:s.x+"px",top:s.y+"px",width:s.w+"px",height:s.h+"px",lineHeight:s.h+"px"});var r=i.clientWidth;return r>s.w&&l.set(i,"left",s.x-(r-s.w)/2+"px"),e.style.maxWidth=r-50+"px",e.style.whiteSpace="normal",o._drillingSectionsButtons.push({destroy:function(){a.destroy(i)}}),i}if(g.isMobileDevice()){var r;function c(t){n.style.opacity=t?1:0,o._shownButtons.splice(o._shownButtons.indexOf(n),1),t&&o._shownButtons.push(n),r&&r.remove()}this._shownButtons=this._shownButtons||[],D.addNoDragClickHandler(this.domNode,(function(){setTimeout((function(){!o._shownButtons.length&&m.isMouseOver(t.domNode,{checkAllChildren:!0})&&(n=n||s(),c(!0),setTimeout((function(){r=D.addNoDragClickHandler(n,(function(){c(!1),i(n)})),e.once(document.body,"touchend",(function(){c(!1)}))})))}))}),{detectLongPress:!0,longPressTimeout:750,ignoreReleaseIfLongPressHappened:!0,longPressCallback:function(){m.isMouseOver(t.domNode,{checkAllChildren:!0})&&(n=n||s(),c(!0),i(n),setTimeout((function(){c(!1)})))}})}else t.own(e.once(this.domNode,"mouseover",(function(){n=n||s(),e(n,"click",(function(){i(n)}))})))},_dataDrillingState:null,_loadStandardDataDrillingView:function(t){var i,e,o,a,l=t.fieldInfo,s=t.optionName,r=t.calcState,c=t.sectionVisualState,u=t.animationPromise,g=this;return this._dataDrillingState={fieldInfo:l,optionName:s,calcState:r,sectionVisualState:c},this._destroyDrillingSections(),this._showDDProgress(!0),n((i=g._getDataDrillingPanelDimensions(),e=h.getDataDrilling(g._currentInfographicJson,l.templateName),o=d.getDrillingOptionInfo(g._getCountryID(),e.standardId||l,s,i.w,i.h,r),a=o.enrichInfos,n(a&&a.length&&g.viewModel.enrichFieldData(a),(function(){return o}))),(function(t){return n(g._renderStandardOptionInfo({drillingDataOptionInfo:t,fieldInfo:l,animationPromise:u,optionName:s,calcState:r,sectionVisualState:c}),(function(){g._showDDProgress(!1)}))}))},_renderStandardOptionInfo:function(t){var i,e=t.drillingDataOptionInfo,o=t.fieldInfo,a=t.animationPromise,l=t.optionName,s=(t.calcState,t.sectionVisualState),r=this;this._destroyDrillingSections();var c=this._getDataDrillingPanelSectionParams();return c.json={type:w.DETAILS,stack:[e.tableJson]},c.calculationStatesGroup=e.calculationStatesGroup,c.onCalculationStateChanged=function(t){r._loadStandardDataDrillingView({fieldInfo:o,optionName:l,calcState:t,sectionVisualState:i.getVisualState(),animationPromise:null})},n(a,(function(){return u.delay((function(){return(i=r._createDataDrillingSection(c)).fitContentNicely(),i.domNode.style.opacity="0.01",n(i.getContentFullPromise(),(function(){return u.delay((function(){i.setVisualState(s),i.domNode.style.opacity="",i.notifyShown()}),100)}))}))}))},_renderCustomSectionJson:function(t){var i,e=t.customDDPanelInfo,o=(t.fieldInfo,t.animationPromise),a=(t.calcState,t.sectionVisualState),l=this;this._destroyDrillingSections(),this._dataDrillingState=null;var s=this._getDataDrillingPanelSectionParams(e.sectionJson);return s.json=e.sectionJson,this._showDDProgress(!0),n(o,(function(){return u.delay((function(){return(i=l._createDataDrillingSection(s,!0)).fitContentNicely(),i.domNode.style.opacity="0.01",n(i.getContentFullPromise(),(function(){return u.delay((function(){i.setVisualState(a),i.domNode.style.opacity="",i.notifyShown(),l._showDDProgress(!1)}))}))}))}))},_getDataDrillingPanelSectionParams:function(t){var i={class:"infographicContainer_dataDrillingSection"};return i.initialWidth=this._getDataDrillingPanelDimensions(t).w,i.initialHeight=this._getDataDrillingPanelDimensions(t).h,i.viewModel=this.viewModel,i.theme=this.theme,i.parentWidget=this,i.isDataDrillingView=!0,i.currentFeatureIndex=this.currentFeatureIndex||0,i.initialViewMode=y.PREVIEW_VALUES,a.empty(this.dynamicSettingsToolbarRoot),i.dynamicSettingsToolbarRoot=this.dynamicSettingsToolbarRoot,i},_createDataDrillingSection:function(t,e){var n=this._getDataDrillingPanelDimensions(e&&t.json),a=this.viewModel.layoutBuilder.createElement("section",t,this.drilledDataViewDivScaler);return this._drillingSections.push(a),o[s(".sectionDynamicSettings_settingsButton",this.dataDrillingViewDiv)[0]?"add":"remove"](this.dataDrillingViewDiv,"hasChartSettingsButton"),this._setUpDDPanelBackgroundColor(),n.scale&&(a.notifyPanelScaleChanged(n.scale),this._applyScaleToDataDrillingToolbarButtons(n.buttonScale||n.scale),i.after(a,"onDynamicSettingsButtonsCreated",function(){this._applyScaleToDataDrillingToolbarButtons(n.buttonScale||n.scale)}.bind(this))),a},_applyScaleToDataDrillingToolbarButtons:function(t){var i=1/t,e=[],n=s(".sectionDynamicSettings_buttonBar",this.dynamicSettingsToolbarRoot)[0];if(n)for(var o=0;o<n.children.length;o++)e.push(n.children[o]);e.push(this.exportButton),e.push(this.printButton),e.push(this.backToMainViewButton),e.forEach((function(t,e){if(t.style.transformOrigin=this.viewModel.showDataDrillingInsidePanel?"100% 0":"100% 100%",t.style.transform="scale("+i+")",t.style["webkit-transform"]="scale("+i+")",e>0){var n=(this.viewModel.showDataDrillingInsidePanel?5:26)*i;n+=32*(i-1),t.style.marginLeft=n+"px"}}),this)},_setUpDDPanelBackgroundColor:function(){var t=this.viewModel.getDocumentDefaultStyles(this.theme),i=t.backgroundImage&&t.backgroundImage.data;this.viewModel.showDataDrillingInsidePanel&&!i||v.setUpDDPanelBackgroundColor({viewModel:this.viewModel,theme:this.theme,infographicJson:this._currentInfographicJson,node:this.dataDrillingViewDiv})},_getDataDrillingPanelDimensions:function(t){if(this.viewModel.showDataDrillingInsidePanel){var i=1/this._panelScale,e=this.width/i,n=this.height/i,o=B.minW>e,a=B.minH>n;return this.dataDrillingViewDiv.style.overflowX=o?"auto":"hidden",this.dataDrillingViewDiv.style.overflowY=a?"auto":"hidden",{scale:i,buttonScale:1/i,w:Math.max(e,B.minW)-(a?f.getScrollbarSize().w/i:0),h:Math.max(n,B.minH)-(o?f.getScrollbarSize().h/i:0)}}var l={w:document.body.clientWidth-(g.isLandscape()?80:40),h:document.body.clientHeight-80};if(t&&t.stack.length>1){var s=_.calcSectionJsonBox(t),r={w:t.style&&t.style.width||Math.max(s.w,B.w),h:t.style&&t.style.height||Math.max(s.h,B.h)};i=Math.min(1,l.w/r.w,l.h/r.h);return g.isMobileDevice()?{w:r.w,h:r.h,scale:i,yOffset:10,animateFromCenter:!0}:{w:r.w,h:r.h,scale:i,yOffset:l.h-30>r.h?0:15}}i=Math.max(.7,Math.min(1,l.w/B.minW,l.h/B.minH));return g.isMobileDevice()?{w:l.w/i,h:l.h/i,scale:i,yOffset:10,animateFromCenter:!0}:{w:Math.min(l.w/i,B.w),h:Math.min(l.h/i,B.h),scale:i,yOffset:l.h-30>B.h?0:15}},_showDDProgress:function(t){var i=this.viewModel.showDataDrillingInsidePanel?this.domNode:this.dataDrillingViewDiv;S[t?"showProgress":"removeProgress"](i),this.topToolbar&&(this.topToolbar.style.opacity=t?"0.001":"")},_getDataDrillingState:function(){return this._dataDrillingState},_setDataDrillingState:function(t){t&&this._loadStandardDataDrillingView({fieldInfo:t.fieldInfo,optionName:t.optionName,calcState:t.calcState,sectionVisualState:t.sectionVisualState,animationPromise:null})},_panelScale:1,notifyPanelScaleChanged:function(t){this._panelScale=t,this.domNode.style.fontSize=13/(t||1)+"px"},_destroyDrillingSections:function(){this._drillingSections=this._drillingSections||[],this._drillingSections.forEach((function(t){t.destroy()})),this._drillingSections.length=0,this.domNode&&a.empty(this.drilledDataViewDivScaler)},_destroyDrillingSectionsButtons:function(){this._drillingSectionsButtons=this._drillingSectionsButtons||[],this._drillingSectionsButtons.forEach((function(t){t.destroy()})),this._drillingSectionsButtons.length=0}});return M.DATA_DRILLING_BOX_ZOOM=B,M}));