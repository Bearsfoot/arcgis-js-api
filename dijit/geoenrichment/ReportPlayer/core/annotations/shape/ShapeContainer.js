// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/sniff","dojo/dom-class","dojo/dom-construct","../../grid/valueField/ValueField","esri/dijit/geoenrichment/utils/DeviceUtil","esri/dijit/geoenrichment/utils/MathUtil","esri/dijit/geoenrichment/utils/ShapeUtil","../utils/AnnotationsUtil","./ShapeThemeUtil","dojo/i18n!esri/nls/jsapi"],(function(e,t,i,s,h,a,n,o,l,r,d,p){p=p.geoenrichment.dijit.ReportPlayer.ReportPlayer;var _={borderColor:"#AAAAAA",fillColor:"#AAAAAA"};return e(a,{isShape:!0,viewModel:null,theme:null,currentFeatureIndex:null,shapeJson:null,alignParams:null,applyThemeStyle:!0,getPreviewValueFunction:null,parentWidget:null,_g:!1,_viewBox:!1,_shapeStyle:null,_shapeThemeStyle:null,_needSaveShapeThemeStyle:!0,_preserveAspectRatio:void 0,_showAsBar:!1,_showBarBackground:!1,_barBackgroundStyle:null,_isPlaceholder:!1,_angle:0,postCreate:function(){var e=h.create("div",{class:"shapeContainer_content"});this.content=e,this.fieldStyle=this.fieldStyle||{},this.fieldStyle.width=this.shapeJson.style.width,this.fieldStyle.height=this.shapeJson.style.height,this._g=this.shapeJson.g,this._viewBox=this.shapeJson.viewBox,this._shapeStyle=this.shapeJson.style||{},this._preserveAspectRatio=this.shapeJson.preserveAspectRatio,this._isPlaceholder=this.shapeJson.isPlaceholder,this._angle=this.shapeJson.style.angle||0,this._processThemeStyle(),this._showAsBar=this.shapeJson.showAsBar,this._showBarBackground=this.shapeJson.showBarBackground,this._barBackgroundStyle=this.shapeJson.barBackgroundStyle,this.inherited(arguments),s.add(this.domNode,"esriGEShapeContainer"),this.setPosition(this.shapeJson.style.left||0,this.shapeJson.style.top||0),this._updateShapeNode(),this._applyRotation(),this.alignParams&&r.alignAnnotationContainer(this,this.alignParams),this.onInitialized()},_processThemeStyle:function(){this.applyThemeStyle&&(this._shapeThemeStyle=d.getThemeStylesFromShapeJson(this.shapeJson,this.parentWidget.parentGrid),this._needSaveShapeThemeStyle=!!this.shapeJson.themeStyle)},getShapeStyle:function(){return t.mixin({},this._shapeThemeStyle,this._getOwnShapeStyleForRendering())},setAngle:function(e){this._angle=o.angleTo180_180Range(Number(e)||0),this._applyRotation()},_applyRotation:function(){this._angle=this._angle>0||this._angle<0?this._angle:0;var e=i("webkit")?"webkitTransform":"transform";this.content.style[e]="rotate("+this._angle+"deg)"},_lastAlignParams:null,resize:function(e,t){e&&(this.setWidth(e.w),this.setHeight(e.h)),this._updateShapeNode(),this._lastAlignParams=t||this._lastAlignParams,r.alignAnnotationContainer(this,this._lastAlignParams)},scaleProportionallyWithinParent:function(e){this.resize({w:this.getWidth()*e.xScale,h:this.getHeight()*e.yScale}),this.setPosition(this._left*e.xScale,this._top*e.yScale)},getShapeBox:function(){return{w:this.getWidth(),h:this.getHeight(),l:this._left,t:this._top}},_left:0,_top:0,getLeft:function(){return this._left},getTop:function(){return this._top},setPosition:function(e,t){void 0!==e&&(this._left=e||0,this.domNode.style.left=this._left+"px"),void 0!==t&&(this._top=t||0,this.domNode.style.top=this._top+"px")},_svgNode:null,getSvgNode:function(){return this._svgNode},_updateShapeNode:function(){var e=this,i=this._viewBox;if(this._shapeStyle.borderAlpha>0&&this._shapeStyle.borderWidth>0){var a=this._shapeStyle.borderWidth;(i=t.mixin({},this._viewBox)).xmin=i.xmin||0,i.ymin=i.ymin||0,i.xmin-=a/4,i.ymin-=a/4,i.width+=a/2,i.height+=a/2}var n,o,r=this.getWidth(),d=this.getHeight(),p=i.width/i.height,g=Math.min(r,d*p);function c(a){var d,p=h.create("div",{class:"shapeContainer_svgContainer esriGEAbsoluteStretched"},e.content);function g(t){var s=l.createSVGNode(i,{width:n+"px",height:o+"px",overflow:"visible"});e._preserveAspectRatio&&s.setAttribute("preserveAspectRatio",e._preserveAspectRatio),e._g.forEach((function(e){var t=l.createNodeByAttributes(e,d,{overrideFillOpacity:!0});t&&s.appendChild(t)}));var a=h.create("div",{class:"shapeContainer_svgContainerElement"},p);a.style.left=t*n+"px",h.place(s,a),e._svgNode=s}a?(s.add(p,"shapeContainer_svgContainerBackground"),d=t.mixin({},e._barBackgroundStyle,_)):d=t.mixin({},e._shapeThemeStyle,e._getOwnShapeStyleForRendering());var c=1;e._showAsBar&&(c=a?1:e.getPreviewValueFunction?e.getPreviewValueFunction().normalizedValue:.5+.5*Math.random(),p.style.width=c*r+"px",s.add(p,"shapeContainer_svgContainerShowAsBar"));var u=e._showAsBar?Math.floor(r/n):1;u=Math.round(c*u);for(var y=0;y<u;y++)g(y)}"none"===this._preserveAspectRatio?(n=r,o=d):(n=g,o=g/p),this.content.style.width=(this._showAsBar?r:n)+"px",this.content.style.height=o+"px",h.empty(this.content),this._isPlaceholder?h.create("div",{class:"shapeContainer_svgPlaceholder"},this.content):(this._showAsBar&&this._showBarBackground&&c(!0),c())},_getOwnShapeStyleForRendering:function(){return this._shapeStyle?(n.device.ie||n.device.edge)&&this._shapeStyle.borderWidth>0?t.mixin({},this._shapeStyle,{borderWidth:.5*this._shapeStyle.borderWidth}):this._shapeStyle:null},onInitialized:function(){},toJson:function(){var e={id:"shape",g:this._g,viewBox:this._viewBox,preserveAspectRatio:this._preserveAspectRatio,isPlaceholder:this._isPlaceholder,style:t.mixin({},this._shapeStyle,{left:this._left,top:this._top,width:this.getWidth(),height:this.getHeight(),angle:this._angle}),themeStyle:this._needSaveShapeThemeStyle?this._shapeThemeStyle:void 0,showAsBar:this._showAsBar,showBarBackground:this._showBarBackground,barBackgroundStyle:this._barBackgroundStyle};return t.clone(e)}})}));