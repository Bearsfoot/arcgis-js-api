// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.

define(["dojo/_base/lang","esri/dijit/geoenrichment/utils/ColorUtil","esri/dijit/geoenrichment/utils/ImageUtil","esri/dijit/geoenrichment/utils/JsonXmlConverter","../../ConversionUtil","esri/dijit/geoenrichment/ReportPlayer/core/charts/utils/ChartJsonUtil","esri/dijit/geoenrichment/ReportPlayer/core/charts/utils/ChartTypes","esri/dijit/geoenrichment/ReportPlayer/core/charts/legends/ChartLegendTypes","esri/dijit/geoenrichment/ReportPlayer/core/charts/legends/ChartLegendPlacements","esri/dijit/geoenrichment/ReportPlayer/core/charts/legends/ChartLegendSymbols","esri/dijit/geoenrichment/ReportPlayer/core/charts/utils/ChartDataLabelsTypes","esri/dijit/geoenrichment/ReportPlayer/core/charts/utils/ChartBarThickness","esri/dijit/geoenrichment/ReportPlayer/core/charts/utils/ChartSorting","esri/dijit/geoenrichment/ReportPlayer/core/charts/utils/ChartLineStyles","esri/dijit/geoenrichment/ReportPlayer/core/charts/utils/ChartLineMarkers","esri/dijit/geoenrichment/ReportPlayer/core/charts/utils/plots/supportClasses/GaugeLabelPlacements","esri/dijit/geoenrichment/ReportPlayer/core/charts/utils/plots/supportClasses/WaffleLabelPlacements","esri/dijit/geoenrichment/ReportPlayer/core/charts/utils/plots/supportClasses/WaffleDirections","esri/dijit/geoenrichment/ReportPlayer/core/charts/utils/plots/supportClasses/WaffleFlowStyles","./_FieldInfoBuilder","dojo/i18n!esri/nls/jsapi"],(function(e,t,i,a,l,r,o,n,s,u,c,g,d,p,b,y,f,h,S,m,L){L=L.geoenrichment.dijit.ReportPlayer.ReportPlayer;var C={};function v(e,t){var i=Number(e);return isNaN(i)?void 0:t?t(i):i}function w(e,t){return v(e,t.revisionVersion>=1.7?l.ptToPx:null)}function P(e){return l.ptToPxObj(l.parseStyleString(e))}function k(t,i,a){var l={gridLines:t.gridlines,gridLinesCentered:t.gridlinesCentered,gridLinesOpacity:v(t.gridlinesOpacity),gridLinesColor:O(t.gridlinesColor),gridLinesThickness:w(t.gridlinesThickness,a),gridLinesStyle:p.isSupported(t.gridlinesStyle)?t.gridlinesStyle:void 0,gridStripes:t.gridStripes,gridStripesColor:O(t.gridStripesColor),gridStripesColorAlt:O(t.gridStripesColorAlt)};return i&&e.mixin(l,{hideBaseLine:void 0!==t.baseLine?!t.baseLine:t.hideBaseLine,baseLineColor:O(t.baseLineColor),baseLineOpacity:v(t.baseLineOpacity),baseLineThickness:w(t.baseLineThickness,a),baseLineStyle:p.isSupported(t.baseLineStyle)?t.baseLineStyle:void 0,baseLineValue:v(t.baseLineValue)}),l}function A(e){return"string"!=typeof e?0:"0"===(e=e.replace("%",""))?0:e.replace("0.","").length}function O(e){return e&&"string"==typeof e&&(e=6===e.length&&-1===e.indexOf("#")?"#"+e:t.toCSSColor(e)),e}return C.portalToEditor=function(t,C,T){if(!o.isSupported(t.attributes.type))throw new Error("Chart type is not supported.");var x,M=a.queryJson(t,"comparisonInfo")[0];if(M){var B=M.attributes,I=B.name,F=T.templateJson.metadata.comparisonCalculatorsHash[I];F&&(x={calculatorName:I,chartType:B.chartType,color:O(B.color),lineThickness:w(B.lineThickness,T),lineStyle:p.isSupported(B.lineStyle)?B.lineStyle:void 0,lineMarker:b.isSupported(B.lineMarker)?B.lineMarker:void 0,lineMarkerColor:O(B.lineMarkerColor),lineMarkerSize:v(B.lineMarkerSize,l.ptToPx),lineMarkerFillColor:O(B.lineMarkerFillColor),levels:F.levels,defaultLevel:B.defaultLevel})}var V=function(e,t,i){return a.queryJson(e,"series",!0)[0].tags.map((function(i){if(!i.tags)return null;i.attributes=i.attributes||{};var n={_originalAttrs:i.attributes,label:i.attributes.Text||"",color:O(i.attributes.color),points:i.tags.map((function(l,n){l.attributes=l.attributes||{};var s=(e.attributes.type===o.GAUGE||e.attributes.type===o.WAFFLE)&&n===i.tags.length-1,u=l.tags&&l.tags[0],c=u&&u.attributes&&u.attributes.f,g=c&&m.getCalculatorOrScriptFieldInfo(c,t);if(g||s){if(s&&(g=null),g&&g.isMissing){var d=l.attributes.Text;if(!d&&t.variableProvider.isPlayerOnly){var p=t.variableProvider.toCalculator(g.templateName);d=p&&p.variable.alias}g.alias=d?d+" ("+L.missingVariable+")":L.missingVariable}var b=l.attributes.CaptionField,y=b&&m.getCalculatorOrScriptFieldInfo(b,t),f=a.queryJson(l,"pointIcon")[0],h=f&&t.parsers.getParser("field").parseField(f.tags[0],f,null,t);return r.createChartPoint(g,l.attributes.Text||"",O(l.attributes.color),h,y)}})).filter((function(e){return!!e}))};if(o.isLineLike(e.attributes.type)){n.lineStyle=p.isSupported(i.attributes.lineStyle)?i.attributes.lineStyle:void 0,n.lineMarker=b.isSupported(i.attributes.lineMarker)?i.attributes.lineMarker:void 0,n.lineMarkerColor=O(i.attributes.lineMarkerColor),n.lineMarkerSize=v(i.attributes.lineMarkerSize,l.ptToPx),n.lineMarkerFillColor=O(i.attributes.lineMarkerFillColor),n.fillColor=O(i.attributes.fillColor);var s=a.queryJson(i,"multiFeatureLineStyles")[0];s&&(n.multiFeatureLineStyles=[],s.tags.forEach((function(e){var t={};e.attributes&&(t.color=O(e.attributes.color),t.lineStyle=p.isSupported(e.attributes.lineStyle)?e.attributes.lineStyle:void 0,t.lineMarker=b.isSupported(e.attributes.lineMarker)?e.attributes.lineMarker:void 0,t.lineMarkerColor=O(e.attributes.lineMarkerColor),t.lineMarkerSize=v(e.attributes.lineMarkerSize,l.ptToPx),t.lineMarkerFillColor=O(e.attributes.lineMarkerFillColor),t.lineThickness=v(e.attributes.lineThickness,l.ptToPx),t.fillColor=O(e.attributes.fillColor)),n.multiFeatureLineStyles.push(t)})))}return n})).filter((function(e){return e&&e.points&&!!e.points.length}))}(t,T);if(!V.length)return null;var R=t.attributes,j=a.queryJson(t,"chartTitle")[0],J=a.queryJson(t,"legend")[0],W=a.queryJson(t,"xAxis")[0],D=a.queryJson(t,"yAxis")[0],G=a.queryJson(t,"chartIcon"),q=a.queryJson(t,"floatingIcon"),N=a.queryJson(t,"floatingText"),E=a.queryJson(t,"trigger"),H=a.queryJson(t,"filter")[0];j.attributes=j.attributes||{};var U=W&&W.attributes,_=D&&D.attributes,z=U,X=_;T.isGraphicReport&&T.revisionVersion<1.3&&(z=_,X=U);var Z,K=W&&W.tags&&W.tags[0].attributes&&W.tags[0].attributes,Q=D&&D.tags&&D.tags[0].attributes&&D.tags[0].attributes,Y=function(e){var t=a.queryJson(e,"BackImage")[0];return t&&t.tags&&t.tags[0].text?i.base64DataToDataURL(t.tags[0].text):null}(t),$={isChart:!0,type:R._type||R.type,isMultiFeatureChart:!!R.isMultiFeatureChart,seriesItems:V,visualProperties:e.mixin({barBorders:R.barBorders,view3D:!!R.view3D,origin:v(R.origin),width:l.ptToPx(R.width),height:l.ptToPx(R.height),marginTop:v(R.marginTop,l.ptToPx),marginRight:v(R.marginRight,l.ptToPx),marginBottom:v(R.marginBottom,l.ptToPx),marginLeft:v(R.marginLeft,l.ptToPx),backgroundColor:O(R.backColor),backgroundColorOpacity:v(R.backgroundColorOpacity),plotAreaOutlineColor:O(R.plotAreaOutlineColor),plotAreaOutlineOpacity:v(R.plotAreaOutlineOpacity),plotAreaOutlineThickness:v(R.plotAreaOutlineThickness,l.ptToPx),plotAreaOutlineStyle:p.isSupported(R.plotAreaOutlineStyle)?R.plotAreaOutlineStyle:void 0,panelBackgroundColor:O(R.panelBackgroundColor),backgroundImageData:Y,title:{text:j.attributes.text,align:j.attributes.align&&j.attributes.align.toLowerCase(),style:P(j.attributes.style),verticalShift:v(j.attributes.verticalShift,l.ptToPx)},xAxis:U&&e.mixin({show:"None"!==U.placement,hideLine:void 0!==U.line?!U.line:U.hideLine,showTicks:U.ticks,ticksInside:U.ticksInside||void 0,hideLabels:U.hideLabels||void 0,placement:"OtherSide"===U.placement?"OtherSide":void 0,title:K&&K.text,titleStyle:K&&P(K.style),style:P(U.style),labelsAngle:v(U.labelsAngle),lineColor:O(U.lineColor)},k(z,!1,T)),yAxis:_&&e.mixin({show:"None"!==_.placement,hideLine:void 0!==_.line?!_.line:_.hideLine,showTicks:_.ticks,ticksInside:_.ticksInside,hideLabels:_.hideLabels||void 0,placement:"OtherSide"===_.placement?"OtherSide":void 0,title:Q&&Q.text,titleStyle:Q&&P(Q.style),style:P(_.style),labelsAngle:v(_.labelsAngle),lineColor:O(_.lineColor),showPercentSymbol:_.showPercentSymbol,showCurrencySymbol:_.showCurrencySymbol,showSymbolForAllLabels:_.showSymbolForAllLabels,showValuesAsWeightsInSeries:_.showValuesAsWeightsInSeries,nonZeroInclusive:_.nonZeroInclusive},k(X,!0,T)),isStacked:R.isStacked,showValuesAsWeightInStack:R.showValuesAsWeightInStack,columnBarGap:v(R.columnBarGap,l.ptToPx),columnBarOpacity:v(R.columnBarOpacity),renderColumnBarsInOppositeDirections:R.renderColumnBarsInOppositeDirections,showColumnBarBackground:R.showColumnBarBackground,columnBarBackgroundColor:O(R.columnBarBackgroundColor),columnBarBackgroundOpacity:v(R.columnBarBackgroundOpacity),fillOpacity:v(R.fillOpacity),outlineOpacity:v(void 0!==R.columnBarLineOpacity?R.columnBarLineOpacity:R.outlineOpacity),outlineColor:O(void 0!==R.columnBarLineColor?R.columnBarLineColor:R.outlineColor),outlineThickness:v(void 0!==R.columnBarLineThickness?R.columnBarLineThickness:R.outlineThickness,l.ptToPx),outlineStyle:void 0!==R.columnBarLineStyle?p.isSupported(R.columnBarLineStyle)?R.columnBarLineStyle:void 0:p.isSupported(R.outlineStyle)?R.outlineStyle:void 0,lineOpacity:v(void 0!==R.lineOpacity?R.lineOpacity:R.lineAreaOpacity),fillLineMarkers:void 0!==R.fillLineMarkers?R.fillLineMarkers:R.fillLineArea,lineMarkersFillOpacity:v(void 0!==R.lineMarkersFillOpacity?R.lineMarkersFillOpacity:R.lineAreaOpacity),fillLineArea:R.fillLineArea,lineAreaOpacity:v(R.lineAreaOpacity),donutHolePercent:v(R.donutHolePercent),donutGap:v(R.donutGap),donutArcPercent:v(R.donutArcPercent),gaugeHolePercent:v(R.gaugeHolePercent),gaugeRangeMin:v(R.gaugeRangeMin),gaugeRangeMax:v(R.gaugeRangeMax),gaugeGap:v(R.gaugeGap),gaugeStartAngle:v(R.gaugeStartAngle),gaugeArcPercent:v(R.gaugeArcPercent),gaugeLabelStyle:P(R.gaugeLabelStyle),gaugeLabelPlacement:R.gaugeLabelPlacement?y.toSupportedValue(R.gaugeLabelPlacement):void 0,gaugeShowArrow:R.gaugeShowArrow||void 0,gaugeArrowLineColor:O(R.gaugeArrowLineColor),gaugeArrowFillColor:O(R.gaugeArrowFillColor),gaugeConditionalStylingOthers:void 0!==R.gaugeConditionalStylingIgnoreOthers?R.gaugeConditionalStylingIgnoreOthers:R.gaugeConditionalStylingOthers||void 0,gaugeConditionalStylingLabel:R.gaugeConditionalStylingLabel||void 0,gaugeShowFromToLabels:R.gaugeShowFromToLabels||void 0,gaugeFromLabelStyle:P(R.gaugeFromLabelStyle),gaugeToLabelStyle:P(R.gaugeToLabelStyle),waffleDirection:R.waffleDirection?h.toSupportedValue(R.waffleDirection):void 0,waffleFlowStyle:S.isSupported(R.waffleFlowStyle)?R.waffleFlowStyle:void 0,waffleShowWholePictures:R.waffleShowWholePictures||void 0,waffleStretchIconsToFill:R.waffleStretchIconsToFill||void 0,waffleRangeMin:v(R.waffleRangeMin),waffleRangeMax:v(R.waffleRangeMax),waffleLabelPlacement:R.waffleLabelPlacement?f.toSupportedValue(R.waffleLabelPlacement):void 0,waffleLabelOffset:v(R.waffleLabelOffset,l.ptToPx),waffleHideValue:R.waffleHideValue||void 0,waffleHideLabel:R.waffleHideLabel||void 0,waffleShowLabelAbove:R.waffleShowLabelAbove||void 0,waffleValueStyle:P(R.waffleValueStyle),waffleLabelStyle:P(R.waffleLabelStyle),waffleColumnSpace:v(R.waffleColumnSpace,l.ptToPx),waffleRowSpace:v(R.waffleRowSpace,l.ptToPx),waffleConditionalStylingOthers:void 0!==R.waffleConditionalStylingIgnoreOthers?R.waffleConditionalStylingIgnoreOthers:R.waffleConditionalStylingOthers||void 0,waffleConditionalStylingValue:R.waffleConditionalStylingValue||void 0,waffleConditionalStylingLabel:R.waffleConditionalStylingLabel||void 0,waffleNumIcons:v(R.waffleNumIcons),waffleNumRows:v(R.waffleNumRows),waffleNumColumns:v(R.waffleNumColumns),ringBackgroundColor:O(R.ringBackgroundColor),ringBackgroundOpacity:v(R.ringBackgroundOpacity),columnBarShowWholePictures:void 0!==R.showWholePictures?R.showWholePictures:R.columnBarShowWholePictures,showAxisIcons:R.showAxisIcons,showChartIcons:R.showChartIcons,sorting:d.isSupported(R.sorting)?R.sorting:void 0},(Z=R,{dataLabels:c.toSupportedValue(Z.dataLabels),dataLabelsShowLabelUnder:Z.dataLabelsShowLabelUnder,dataLabelsDecimals:A(Z.CustomPercentFormat||Z.CustomValueFormat),dataLabelsStyle:P(Z.dataLabelsStyle),dataLabelsLabelStyle:Z.dataLabelsLabelStyle?P(Z.dataLabelsLabelStyle):P(Z.dataLabelsStyle),dataLabelsAltColor:O(Z.dataLabelsAltColor),dataLabelsEnableAltColor:Z.dataLabelsEnableAltColor,dataLabelsInside:Z.dataLabelsInside,dataLabelsStackedInColumns:Z.dataLabelsStackedInColumns,dataLabelsHorizontalAlign:Z.dataLabelsHorizontalAlign,dataLabelsVerticalAlign:Z.dataLabelsVerticalAlign,dataLabelsShowValuePercentSymbol:Z.dataLabelsShowValuePercentSymbol,dataLabelsShowValueCurrencySymbol:Z.dataLabelsShowValueCurrencySymbol,dataLabelsAngle:v(Z.dataLabelsAngle),dataLabelsMaxWidth:v(Z.dataLabelsMaxWidth,l.ptToPx)}))},ee=v(V[0]._originalAttrs.thickness);if(o.isColumnBarLike(R.type)?$.visualProperties.columnThickness=ee>1?g.LARGE:ee<1?g.SMALL:g.MEDIUM:o.isLineLike(R.type)&&($.visualProperties.lineThickness=w(ee,T),V.forEach((function(e){e._originalAttrs.thickness!==ee&&(e.lineThickness=v(e._originalAttrs.thickness,l.ptToPx))}))),V.forEach((function(e){delete e._originalAttrs})),J){var te=J&&J.attributes||{};$.visualProperties.legend={type:n.toSupportedValue(te.type)},$.visualProperties.legend.type===n.MIN_MAX?e.mixin($.visualProperties.legend,{minMax:{placement:s.toSupportedValue(te.placement),placementOffset:v(te.placementOffset),titleStyle:P(te.titleStyle),minVariableLabelStyle:P(te.minVariableLabelStyle),maxVariableLabelStyle:P(te.maxVariableLabelStyle)}}):e.mixin($.visualProperties.legend,{series:{placement:s.toSupportedValue(te.placement),placementOffset:v(te.placementOffset),hasBorder:te.hasBorder,labelParts:te.labelParts,style:P(te.style),symbol:u.isSupported(te.symbol)?te.symbol:void 0,hideOthers:te.hideOthers||void 0,showComparison:te.showComparison||void 0}})}T.revisionVersion<1.2&&(void 0!==$.visualProperties.donutGap&&($.visualProperties.donutGap/=2*Math.PI),void 0!==$.visualProperties.gaugeGap&&($.visualProperties.gaugeGap/=2*Math.PI)),G&&G.length&&($.visualProperties.chartIcons=G.map((function(e){return e.tags&&e.tags[0]?T.parsers.getParser("field").parseField(e.tags[0],e,null,T):null}))),q&&q.length&&($.visualProperties.floatingIcons=q.map((function(e){return T.parsers.getParser("section").parseTable(e.tags[0],T)}))),N&&N.length&&($.visualProperties.floatingTexts=N.map((function(e){return T.parsers.getParser("section").parseTable(e.tags[0],T)}))),E&&E.length&&($.visualProperties.conditionalStyling=T.parsers.getParser("field").parseFieldTrigger(E[0])),H&&($.visualProperties.filter=T.parsers.getParser("filter").getFilter(H)),$.comparisonInfo=x;var ie={};return C.attributes&&C.attributes.style&&e.mixin(ie,l.parseStyleString(C.attributes.style)),l.ptToPxObj(ie),r.provideDefaultValueForMissing($,{font:ie}),T.postProcessChartJson(t,$),$},C}));