// COPYRIGHT © 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.

define(["esri/dijit/geoenrichment/when","esri/dijit/geoenrichment/promise/all","esri/dijit/geoenrichment/Deferred","./tasks/EnrichAreasTask","./tasks/RunReportTask","./data/AreaDataUtil","./data/AreaCalculatorsUtil","./data/VariablesUtil","./CustomReportsManager","esri/dijit/geoenrichment/utils/DateUtil","../../core/supportClasses/templateJsonUtils/fieldInfo/FieldLibrary","../../core/infographics/simpleInfographic/dataDrilling/EnrichUtil","../../core/supportClasses/templateJsonUtils/fieldInfo/FieldInfoNameUtil","../../core/infographics/utils/InfographicJsonUtil"],(function(e,a,t,r,i,n,o,s,l,u,c,f,d,p){return{populateReportDataFromAttachmentsStore:function(t,r){var i=[];return r.supportsMultipleAreas&&r.setCurrentAnalysisAreaIndex(0),i.push(e(r.getNotes(),(function(e){e&&e.length&&(t.fieldData.metadata[c.SITENOTES_FIELD_NAME]=e.map((function(e){return e.text})).join("<br/><br/>"),e.forEach((function(e,a){t.fieldData.metadata[c.getSiteNoteFieldNameAt(a+1)]=e.text})))}))),i.push(e(r.getAttributes(),(function(e){if(!e||!e.length)return null;var a={attributes:{}};e.forEach((function(e){a.attributes[e.name]=e})),t.analysisAreas.forEach((function(e,r){var i=t.fieldData.areaData[r];i&&o.addFeatureAttributesCalculator(a,i)}))}))),a(i)},runReportAndGetData:function(e,r){return a([l.getCustomReportByID(e),r]).then((function(a){var r=a[0],n=a[1];return(new i).execute({portalUrl:e.portalUrl,analysisAreas:e.analysisAreas,countryID:e.countryID,hierarchy:e.hierarchy,report:{reportID:r.reportID,portalUrl:r.templateData.getPortalUrl(!0),modified:r.modified,isMultiFeature:r.isMultiFeature},attachmentsStore:n,cacheResult:!0}).then((function(e){return{taskIDs:e.taskIDs,selectedReport:r,areaData:e.areaData}}),(function(a){return e.fieldData.errors.push(a),(new t).reject(a)}))}))},runReportFromVariables:function(e){var a={};return e.variables.fullNames.forEach((function(e){var t=d.createFieldNameFromVariable(e);a[e.substr(e.indexOf(".")+1)]=t})),(new r).enrichAreas({portalUrl:e.portalUrl,analysisAreas:e.analysisAreas,countryID:e.countryID,hierarchy:e.hierarchy,fields:s.convertForEnrich(e.variables),comparisonLevels:e.comparisonLevels||p.getDefaultLevels()}).then((function(t){var r=e.analysisAreas.map((function(){return{}}));return o.addEnrichFeatures(t,a,d.DATA_COLLECTIONS_CALCULATOR_NAME,r),{areaData:r}}),(function(a){return e.fieldData.errors.push(a),(new t).reject(a)}))},applyRunReportAndGetDataResults:function(e,a){e&&e.areaData&&(a.fieldData.runReportTaskIDs=e.taskIDs,a.fieldData.areaData=e.areaData,a.analysisAreas&&this._reportDataFromAreas(a.analysisAreas,a.fieldData.areaData),e.selectedReport&&this._reportDataFromReport(e.selectedReport,a.fieldData,a.combinedAreasInfo))},_reportDataFromAreas:function(e,a){e.forEach((function(e,t){var r=e.feature,i=a[t];i&&(o.addFeatureAttributesCalculator(r,i),o.addAreaInfoCalculator(e,i))}))},_reportDataFromReport:function(e,a,t){var r=a.metadata;e&&!r.Title&&(r.Title=e.title),r.Source="Esri",r.Date=u.getReportFooterDate(),r.Copyright="© "+u.getFullYear()+" Esri",r.ProductLabel="",r.ProductUrl="",r.PhoneNumber="",r.TrialUrlText="",e.isMultiFeature&&(r.SITE_NAME=t.locationName||t.name,r.STORE_NAME=t.locationName||t.name,r.AREA_DESC2=t.description||t.name,r.STORE_ADDR=t.address)},enrichFieldData:function(t,i){function s(e,a,t){t=t||d.ENRICHED_DATA_NO_LEVELS;var r=[],o={};return e.forEach((function(e){var a;(a=e.fieldName,i.fieldData.areaData.every((function(e,r){return void 0!==n.getAreaDataValue({fieldName:a,fieldData:i.fieldData,calculatorName:t,featureIndex:r,ignoreMetadata:!0})})))||(r.push(e.mapTo),o[e.mapTo]=e.fieldName,o[e.mapTo.substr(e.mapTo.indexOf(".")+1)]=e.fieldName)})),r.length?{fields:r,fieldsMap:o,comparisonLevels:a,calculatorName:t}:null}var u=[];if((t=f.optimizeInfos(t)).forEach((function(e){var a;(e.isGeneral||e.isChart)&&(a=s(e.fields,e.levels,e.calculatorName)),a&&u.push(a)})),u.length)return e(l.getCustomReportByID(i),(function(e){function t(e){i.fieldData.errors.push(e)}return a(u.map((function(e){return(new r).enrichAreas({portalUrl:i.portalUrl,analysisAreas:i.analysisAreas,countryID:i.countryID,hierarchy:i.hierarchy,fields:e.fields,comparisonLevels:e.comparisonLevels}).then((function(a){o.addEnrichFeatures(a,e.fieldsMap,e.calculatorName,i.fieldData.areaData)}),t)})))}))}}}));