// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.

define(["require","dojo/_base/declare","dojo/_base/lang","esri/dijit/geoenrichment/promise/all","esri/dijit/geoenrichment/Deferred","esri/dijit/geoenrichment/when","./supportClasses/ReportDataProcessor","./supportClasses/tasks/parsers/DataXMLParser","./supportClasses/tasks/RunReportTask","./supportClasses/areas/AnalysisAreaUtil","./supportClasses/areas/AnalysisAreaJsonUtil","./supportClasses/CustomReportsManager","./supportClasses/GEUtil","../core/supportClasses/ReportTemplateTypes","../core/conversion/PortalToEditorConverter"],(function(e,r,t,a,s,o,n,i,l,p,c,m,u,f,g){var d,v,h,A,U;function y(){var r=new s;return e(["./supportClasses/attachments/AttachmentsStoreSerializer","../core/supportClasses/templateJsonUtils/TemplateJsonSerializer","../core/conversion/portalToEditorUtils/variables/PlayerVariableProvider","./commands/mapToImage/MapToURLUtil","esri/dijit/geoenrichment/utils/ProjectionUtil"],(function(e,t,a,s,o){d=e,v=t,h=a,A=s,U=o,r.resolve()})),r.promise}return r(null,{reportDataToServerData:function(e){var r=e.getReportData();return y().then((function(){return a({files:r.reportObject.templateData.getFiles(),attachmentsProvider:r.attachmentsStore&&d.getAttachmentsStoreJson(r.attachmentsStore,{numAreas:r.analysisAreas.length,saveImages:!0})}).then((function(e){var a=l.CreateReportResultCache.getResults()[0].originalXMLs[0];e.files.push({name:"data.xml",data:a});var s={reportItem:{properties:{isMultiFeature:r.reportObject.isMultiFeature?"true":"false"},resources:e.files},customLogo:r.customLogo,portalUrl:r.config.portalUrl,geometryServiceUrl:r.config.geometryServiceUrl,printMapTaskUrl:r.config.printMapTaskUrl,reverseAnalysisAreasOnMap:r.reverseAnalysisAreasOnMap},o=c.areasToJson(r.analysisAreas),n=r.combinedAreasInfo&&c.combinedAreasInfoToJson(r.combinedAreasInfo);return s.sites=n.groups.map((function(r,a){var s=t.mixin({},r);if(s.areas=r.indexes.map((function(e){return o[e]})),delete s.indexes,e.attachmentsProvider&&e.attachmentsProvider.supportsMultipleAreas||0===a){var n=e.attachmentsProvider.areaAttachments[r.indexes[0]];n&&(s.images=n.images,s.attributes=n.attributes,s.notes=n.notes)}return s})),console.log(s),s}))}))},reportDataFromServerData:function(e){var r,t=this,a=e.reportItem.resources;if(Array.isArray(a))r=a;else for(var s in r=[],a)r.push({name:s,data:a[s]});function l(e){return t._infographicOptionsProvider.getInfographicOptions({geoenrichmentUrl:"",countryID:"",reportID:"",analysisAreas:e})}return y().then((function(){var t=new h;return o(function(t){var a=m.prepareCustomReportFromItem(e.reportItem);return a.isGraphicReport=!0,a.portalJson={files:r},o(g.provideEditorJson(a,{variableProvider:t}),(function(){return a.templateJson=v.deserialize(a.templateJson),delete a.portalJson,a}))}(t),(function(a){p.parseSites(e);var s=c.areasFromJson(e.analysisAreas),m={isClassic:!1,isMultiFeature:a.isMultiFeature&&s.length>1,reportType:a.type||f.STANDARD,reportTitle:a.title||"",templateJson:a.templateJson,reportObject:a,fieldData:{metadata:{},areaData:[],errors:[]},analysisAreas:s,combinedAreasInfo:e.combinedAreasInfo&&c.combinedAreasInfoFromJson(e.combinedAreasInfo)||{},reverseAnalysisAreasOnMap:e.reverseAnalysisAreasOnMap,infographicOptions:l(s),attachmentsStore:e.attachmentsProvider&&d.getAttachmentsStoreFromJson(e.attachmentsProvider),geClient:null,templateVariableProvider:t,config:{portalUrl:e.portalUrl,geoenrichmentUrl:null,geometryServiceUrl:e.geometryServiceUrl,printMapTaskUrl:e.printMapTaskUrl,countryID:null,hierarchy:null,reportID:a.reportID,variables:null},customLogo:e.customLogo};return p.populateCombinedAreasInfo(m.combinedAreasInfo,m.analysisAreas),function(e,t){var a=r.filter((function(e){return"data.xml"===e.name}))[0],s=/.*\.(png|jpg|jpeg|json)$/i,o={};r.forEach((function(e){s.test(e.name)&&(o[e.name]=e.data)}));var l={selectedReport:e,areaData:i.parse(a.data,(function(e,r){return o[r]||r}))};n.applyRunReportAndGetDataResults(l,t)}(a,m),u.setGeoenrichmentUrl(m.config.geoenrichmentUrl),m.config.geometryServiceUrl&&U.setGeometryServiceUrl(m.config.geometryServiceUrl),m.config.printMapTaskUrl&&A.setPrintMapTaskUrl(m.config.printMapTaskUrl),o(m.attachmentsStore&&n.populateReportDataFromAttachmentsStore(m,m.attachmentsStore),(function(){return m}))}))}))}})}));