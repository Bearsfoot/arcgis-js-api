// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/dom-class","dojo/dom-construct","dojo/dom-geometry","dojo/dom-style","dojo/on","dojo/mouse","dojo/sniff","dijit/Tooltip","dijit/place","./DeviceUtil","./DnDUtil","./DomUtil","./MouseUtil","dojo/domReady!"],(function(o,e,t,i,s,n,l,r,d,a,c,p,u,h,T){var v={};function f(){}var N,m,_=o(a._MasterTooltip,{_customClasses:null,addCustomClasses:function(o){o&&(t.add(this.domNode,o),this._customClasses=o)},show:function(o,t,s,n,l,r,d){if(!this.aroundNode||this.aroundNode!==t||this.containerNode.innerHTML!=o)if("playing"!=this.fadeOut.status()){"string"==typeof o?this.containerNode.innerHTML=o:(this.containerNode.innerHTML="",i.place(o.domNode||o,this.containerNode)),l&&this.set("textDir",l),this.containerNode.align=n?"right":"left";var p=c.around(this.domNode,t,s&&s.length?s:a.defaultPosition,!n,e.hitch(this,"orient")),u=p.aroundNodePos;"M"==p.corner.charAt(0)&&"M"==p.aroundCorner.charAt(0)?(this.connectorNode.style.top=u.y+(u.h-this.connectorNode.offsetHeight>>1)-p.y+"px",this.connectorNode.style.left=""):"M"==p.corner.charAt(1)&&"M"==p.aroundCorner.charAt(1)?this.connectorNode.style.left=u.x+(u.w-this.connectorNode.offsetWidth>>1)-p.x+"px":(this.connectorNode.style.left="",this.connectorNode.style.top=""),this.domNode.style.opacity="0",this.fadeIn.play(),this.isShowingNow=!0,this.aroundNode=t,this.onMouseEnter=r||f,this.onMouseLeave=d||f}else this._onDeck=arguments},orient:function(o,e,t,i,n){this.connectorNode.style.top="";var l=i.h,r=i.w;o.className="dijitTooltip "+{"MR-ML":"dijitTooltipRight","ML-MR":"dijitTooltipLeft","TM-BM":"dijitTooltipAbove","BM-TM":"dijitTooltipBelow","BL-TL":"dijitTooltipBelow dijitTooltipABLeft","TL-BL":"dijitTooltipAbove dijitTooltipABLeft","BR-TR":"dijitTooltipBelow dijitTooltipABRight","TR-BR":"dijitTooltipAbove dijitTooltipABRight","BR-BL":"dijitTooltipRight","BL-BR":"dijitTooltipLeft"}[e+"-"+t],this.addCustomClasses(this._customClasses),this.domNode.style.width="auto";var a=s.position(this.domNode);(d("ie")||d("trident"))&&(a.w+=2);var c=Math.min(Math.max(r,1),a.w);if(s.setMarginBox(this.domNode,{w:c}),"B"==t.charAt(0)&&"B"==e.charAt(0)){var p=s.position(o),u=this.connectorNode.offsetHeight;if(p.h>l){var h=l-(n.h+u>>1);this.connectorNode.style.top=h+"px",this.connectorNode.style.bottom=""}else this.connectorNode.style.bottom=Math.min(Math.max(n.h/2-u/2,0),p.h-u)+"px",this.connectorNode.style.top=""}else this.connectorNode.style.top="",this.connectorNode.style.bottom="";return Math.max(0,a.w-r)}}),M=function(o,e,t,i){"string"==typeof t&&(t=[t]),t=t&&t.map((function(o){return{after:"after-centered",before:"before-centered"}[o]||o}));var s=new _;return s.addCustomClasses(i),s.show(o,e,t),s};return v.setTooltipToNode=function(o,e,t){if(t=t||{},o&&(v.hideTooltipForNode(o),o.__setTooltipToNodeMouseEnterHandle&&o.__setTooltipToNodeMouseEnterHandle.remove(),e)){var i=!1;return p.isMobileDevice()?o.__setTooltipToNodeMouseEnterHandle=u.addNoDragClickHandler(o,s):o.__setTooltipToNodeMouseEnterHandle=l(o,r.enter,s),t.showTooltip&&s(),{remove:function(){e=null,v.hideTooltipForNode(o)},suspend:function(){v.hideTooltipForNode(o),i=!0},resume:function(){i=!1},refresh:function(){o._shownTooltip&&s()}}}function s(){!i&&v.showTooltipForNode(o,e,t)}},v.showTooltipForNode=function(o,e,i){if(o){v.hideTooltipForNode(o);var s="function"==typeof e?e():e;if(s){var n;i.textAlign&&(s="<div class='"+("start"===i.textAlign?"esriGEStart":"end"===i.textAlign?"esriGEEnd":"")+"'>"+s+"</div>"),t.add(o,"esriGESimpleTextTooltip"),a();var d=v.hideTooltipForNode.bind(v,o);return p.isMobileDevice()?o.__setTooltipToNodeMouseLeaveHandle=l(document.body,"touchstart",(function(e){T.isMouseOver(o,{event:e})||d()})):o.__setTooltipToNodeMouseLeaveHandle=l.once(o,r.leave,(function(){!i.stayOnHover&&d()})),i.ignoreNodeRemoval||(o.__setTooltipToNodeInLayoutHandle=setInterval((function(){!h.isNodeInLayout(o)&&d()}),300)),p.isMobileDevice()||(o.__setTooltipToNodeMouseOverHandle=setInterval((function(){(!i.stayOnHover||!T.isMouseOver(n.domNode))&&!T.isMouseOver(o)&&d()}),300),o.__setTooltipToNodeClickHandle=l(o,"click",(function(e){i.hideOnClick?d():!o._shownTooltip&&a()})),i.stayOnHover&&(o.__setTooltipToNodeMouseLeaveMasterHandle=l(n.domNode,r.leave,d))),o._shownTooltip}}function a(){v.hideTooltipForNode(o);var e=Array.isArray(i.classes)?i.classes.join(" "):i.classes;e=(e||"")+" esriGETooltip",i.notRestricted&&(e+=" notRestricted"),o._shownTooltip=n=M(s,o,i.position||["after","before"],e)}},v.hideTooltipForNode=function(o){o&&(delete o.title,t.remove(o,"esriGESimpleTextTooltip"),o._shownTooltip&&o._shownTooltip.destroy(),delete o._shownTooltip,o.__setTooltipToNodeMouseLeaveHandle&&o.__setTooltipToNodeMouseLeaveHandle.remove(),clearInterval(o.__setTooltipToNodeInLayoutHandle),clearInterval(o.__setTooltipToNodeMouseOverHandle),o.__setTooltipToNodeClickHandle&&o.__setTooltipToNodeClickHandle.remove(),o.__setTooltipToNodeMouseLeaveMasterHandle&&o.__setTooltipToNodeMouseLeaveMasterHandle.remove())},v.autoTooltip=function(o){l(o,".TrimWithEllipses:mouseover",(function(){if(this!==N&&this.offsetWidth<this.scrollWidth){function o(){N=null,m&&(m.tooltip.destroy(),m.mouseOutH.remove(),m.mouseMoveH.remove(),m=null)}o(),m={tooltip:M((N=this).textContent,N,["above","below"]),mouseOutH:l.once(N,"mouseout, mousedown, touchstart",o),mouseMoveH:l(document.body,"mousemove",(function(){T.isMouseOver(N)||o()}))}}}))},v.showClosableTooltip=function(o){var e=v._createClosableTooltip(o.message,o.tooltipClass,o.position);return v._placeClosableTooltip(e,o.node,o.timeout,o.position,o.onClosed)},v.removeClosableTooltip=function(o){o&&o._removeFunc&&o._removeFunc()},v._createClosableTooltip=function(o,e,s){var n,l,r=i.create("div",{class:"esriGEClosableTooltip esriGENonSelectable "+(e||"")},document.body);function d(){var o=i.create("div",{class:"esriGEClosableTooltipTip"},r);t.add(o,"right"===s?"esriGEClosableTooltipTipRight":"esriGEClosableTooltipTipLeft")}function a(){n=i.create("div",{class:"esriGEClosableTooltipBody"},r),i.create("div",{innerHTML:o,class:"esriGEClosableTooltipLabel"},n),l=i.create("div",{class:"esriGEClosableTooltipCloseButton"},n)}return"right"!==s?(a(),d()):(d(),a()),r.style.position="fixed",{tooltip:r,body:n,closeButton:l}},v._placeClosableTooltip=function(o,e,t,i,r){var d,a,c,p,u,T,v="rtl"===document.dir&&"right"!==i||"rtl"!==document.dir&&"right"===i;function f(){var t=s.position(e),i=t.x+";"+t.y+";"+t.w+";"+t.h;if(i!==d){d=i;var l=s.getMarginBox(o.tooltip);n.set(o.tooltip,{left:(v?t.x+t.w:t.x-l.w)+"px",top:t.y+t.h/2-l.h/2+"px"})}}f();var N=function(){a&&clearTimeout(a),c&&clearInterval(c),p&&clearInterval(p),u&&u.remove(),o.tooltip.parentNode&&o.tooltip.parentNode.removeChild(o.tooltip)};return c=setInterval((function(){h.isNodeInLayout(e)&&e.parentNode||(T=!1,N()),h.isNodeVisible(e)&&h.isNodeOnscreen(e)?(T=!0,h.show(o.tooltip)):(T=!1,h.hide(o.tooltip))}),0),p=setInterval((function(){T&&f()}),0),t&&(a=setTimeout(N,t)),u=l(o.closeButton,"click",(function(){N(),r&&r()})),o.tooltip._removeFunc=N,o.tooltip},v}));