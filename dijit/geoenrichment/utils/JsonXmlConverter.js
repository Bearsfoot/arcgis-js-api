// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.

define(["dojo/_base/declare","./RegExpUtil"],(function(e,t){function n(e){var n="";for(var a in e){var r=e[a];Array.isArray(r)&&(r=r.join(";")),null==r||""===r||"number"==typeof r&&isNaN(r)||(n+=" "+a+'="'+t.encodeXML(r,!0)+'"')}return n}function a(e,t){if(!t)return"";for(var n="",a=0;a<e;a++)n+="     ";return n}var r=e(null,{parseJson:function(e,r){var i=r&&r.addDocumentOptions,s=r&&r.prettify,o="";return i&&(o+='<?xml version="1.0" encoding="utf-8"?>'),function e(r,i){r.text||"#text"===r.name?o+=function(e,n,r){return e=t.encodeXML(e,!1),a(n,r)+e+(r?"\n":"")}(r.text,i,s):r.name&&(r.tags&&r.tags.length?(o+=function(e,t,r,i){return a(r,i)+"<"+e+(t?n(t):"")+">"+(i?"\n":"")}(r.name,r.attributes,i,s),r.tags&&r.tags.forEach((function(t){e(t,i+1)})),o+=function(e,t,n){return a(t,n)+"</"+e+">"+(n?"\n":"")}(r.name,i,s)):o+=function(e,t,r,i){return a(r,i)+"<"+e+(t?n(t):"")+" />"+(i?"\n":"")}(r.name,r.attributes,i,s))}(e,0),o=decodeURIComponent(encodeURIComponent(o).replace("%19",""))},parseXml:function(e,n){var a=(n=n||{}).parseNumbers,r=n.ignoreWhiteSpacedTextNodes;function i(e){return"#text"!==e.nodeName||(r?e.nodeValue.trim():e.nodeValue)}r=void 0===r||r;var s={};for(var o,l=(new DOMParser).parseFromString(e,"text/xml").childNodes,u=0;u<l.length;u++)if(1===l[u].nodeType){o=l[u];break}return o&&function e(r,s){if(r.name=s.nodeName,n.saveInnerHTML&&(r.innerHTML=s.innerHTML),s.attributes&&s.attributes.length){r.attributes={};for(var o=0;o<s.attributes.length;o++){var l=s.attributes[o],u=l.value;if(!0===u||"true"===u)u=!0;else if(!1===u||"false"===u)u=!1;else if(a&&u){var m=Number(u);isNaN(m)||(u=m)}r.attributes[l.nodeName]=u}}if(s.childNodes&&s.childNodes.length){r.tags=[];for(var c=0;c<s.childNodes.length;c++){var g=s.childNodes[c];if(i(g)){var d={};r.tags.push(d),e(d,g)}}}else"#text"===s.nodeName&&(delete r.name,r.text=t.decodeXML(s.nodeValue))}(s,o),s},queryJson:function(e,t,n){var a=[];return function e(r,i){r.tags&&r.tags.forEach((function(r){(t.test?t.test(r.name):r.name===t)&&a.push(r),n&&0===i||e(r,i+1)}))}(e,0),a},traverseJson:function(e,t){var n=!1;!function e(a){n||(!0!==t(a)?a.tags&&a.tags.forEach(e):n=!0)}(e)},getInnerHTML:function(e){return e.innerHTML?e.innerHTML.trim():this.parseJson(e).replace(/^<[^<]*>/,"").replace(/<\/[^<]*>$/,"").trim()},_IS_RICH_RE:/<.+>.*<\/.+>|<br\s*\/>|<\/br>/,_UNRICH_RE:/<.*?>/g,isRichText:function(e){var t=String(e);return t&&this._IS_RICH_RE.test(t)},unrichHTML:function(e){return e?(0===(e=t.decodeXML(String(e).trim()).replace(this._UNRICH_RE,"")).indexOf("<")&&-1!==e.indexOf(">")&&(e=""),e):""}}),i=r();return i.runTest=function(){!function(){console.log("------------------------------Testing JsonXmlConverter.js (1)------------------------------");var e={name:"HTMLReport",attributes:{pagesize:"letter",orientation:"portrait",left:"15.75",label:"10 < 5"},tags:[{name:"section",attributes:{type:"PageHeader"},tags:[{text:"Plain text 1 <b>Bold Text</b>"}]},{text:"Plain text 2"}]},t=new r;e=JSON.parse(JSON.stringify(e));var n=t.parseJson(e),a=t.parseXml(n),i=t.parseJson(a);console.log("Compare JSON1 and JSON2: "+(JSON.stringify(e)===JSON.stringify(a))),console.log("Compare XML1 and XML2: "+(n===i)),console.log("------------------------------Testing JsonXmlConverter.js (1)------------------------------")}(),function(){console.log("------------------------------Testing JsonXmlConverter.js (2)------------------------------");var e={name:"DataCollection",attributes:{Title:"2016 Crime Indices",ScriptLanguage:"Python"},tags:[{name:"Metadata",tags:[{name:"name",tags:[{text:"Crime"}]},{name:"shortDescription",tags:[{text:"Data Collection of Esri's Crime Index variables for the United States"}]},{name:"longDescription",tags:[{text:"This data collection includes Esri's Crime Index variables incorporating information from the AGS national CrimeRisk database that is based on an extensive analysis of several years of crime incidents reported by most US law enforcement jurisdictions. The Crime Indexes database includes standardized indexes for a range of serious crimes against both persons and property.  The data vintage is 2016A."}]},{name:"keywords",tags:[{text:"Crime"}]},{name:"coverage",tags:[{text:"US"}]},{name:"author",tags:[{text:"Esri"}]},{name:"datasets"},{name:"countries",tags:[{name:"country",tags:[{text:"US"}]}]},{name:"categories"},{name:"filters",tags:[{name:"filter",attributes:{ID:"Year",Name:"Year",Type:"Enumeration",aliasname:"Year",enumValues:"2016"}},{name:"filter",attributes:{ID:"Source",Name:"Source",Type:"Enumeration",aliasname:"Source",enumValues:"Applied Geographic Solutions (AGS)"}}]}]},{name:"Parameters"},{name:"Calculators",tags:[{name:"FeatureService",attributes:{Name:"Crime",url:"http://demographics5dev.arcgis.com/arcgis/rest/services/USA_Crime/MapServer/2"}},{name:"Fields",tags:[{name:"Field",attributes:{Name:"CRMCYTOTC",Alias:"2016 Total Crime Index",baseType:"NONE",MapTo:"CRMCYTOTC",summaryType:"AVG",weightField:"POP WEIGHT",FieldCategory:"2016 Crime Indices",Type:"Double",Decimals:"0",Units:"COUNT",Vintage:"2016"},tags:[{name:"Tag",attributes:{ID:"Year",Name:"Year",Value:"2016"}},{name:"Tag",attributes:{ID:"Source",Name:"Source",Value:"Applied Geographic Solutions (AGS)"}}]}]}]}]},t=new r;e=JSON.parse(JSON.stringify(e));var n=t.parseJson(e),a=t.parseXml(n),i=t.parseJson(a);console.log("Compare JSON1 and JSON2: "+(JSON.stringify(e)===JSON.stringify(a))),console.log("Compare XML1 and XML2: "+(n===i)),console.log("------------------------------Testing JsonXmlConverter.js (2)------------------------------")}()},i}));