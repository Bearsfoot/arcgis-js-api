// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../Color","../../core/Logger","../../geometry/support/jsonUtils","../cim/CIMCursor","../cim/CIMEffects","../cim/CIMOperators","../cim/CIMPlacements","./CIMSymbolDrawHelper","./packingUtils"],(function(e,r,a,t,i,o,s,n,l,c,f){Object.defineProperty(r,"__esModule",{value:!0});var m=Math.PI,y=m/2,h=t.getLogger("esri.symbols.cim.CIMSymbolHelper");function v(e,r){switch(r.type){case"CIMSymbolReference":var a={type:"point",x:0,y:0};e.drawSymbol(r.symbol,a);break;case"CIMPointSymbol":a={type:"point",x:0,y:0};e.drawSymbol(r,a);break;case"CIMTextSymbol":break;case"CIMVectorMarker":var t=new l.Placement;e.drawMarker(r,t)}return e.envelope()}var S=function(){function e(){}return e.getEnvelope=function(e){var r=new c.EnvDrawHelper;if(Array.isArray(e)){for(var a=void 0,t=0,i=e;t<i.length;t++){var o=i[t];a?a.union(v(r,o)):a=v(r,o)}return a}return v(r,e)},e.getTextureAnchor=function(e){var r=this.getEnvelope(e);if(!r||r.width<=0||r.height<=0)return[0,0];var a=(r.x+.5*r.width)*(96/72),t=-(r.y+.5*r.height)*(96/72);return[a/(r.width*(96/72)+2),t/(r.height*(96/72)+2)]},e.rasterize=function(e,r,a){void 0===a&&(a=!0);var t=this.getEnvelope(r);if(!t||t.width<=0||t.height<=0)return[null,0,0,0,0];var i=(t.x+.5*t.width)*(96/72),o=(t.y+.5*t.height)*(96/72);e.width=t.width*(96/72)+2,e.height=t.height*(96/72)+2;var s=e.getContext("2d"),n=c.Transformation.createScale(96/72,-96/72);n.translate(.5*e.width-i,.5*e.height+o);var f=new c.CanvasDrawHelper(s,n);switch(r.type){case"CIMPointSymbol":f.drawSymbol(r,{type:"point",x:0,y:0});break;case"CIMVectorMarker":var m=new l.Placement;f.drawMarker(r,m)}var y=s.getImageData(0,0,e.width,e.height),h=new Uint8Array(y.data);if(a)for(var v=void 0,S=0;S<h.length;S+=4)v=h[S+3]/255,h[S]=h[S]*v,h[S+1]=h[S+1]*v,h[S+2]=h[S+2]*v;return[h,e.width,e.height,-i/e.width,-o/e.height]},e.fromSimpleMarker=function(e){var r,a,t,i=e.style;if("circle"===i||"esriSMSCircle"===i){var o=Math.acos(.995),s=Math.ceil(m/o/4);0===s&&(s=1),o=y/s,s*=4;var n=[];n.push([50,0]);for(var l=1;l<s;l++)n.push([50*Math.cos(l*o),-50*Math.sin(l*o)]);n.push([50,0]),r={rings:[n]},a={xmin:-50,ymin:-50,xmax:50,ymax:50}}else if("cross"===i||"esriSMSCross"===i){r={rings:[[[c=0,50],[c,c],[50,c],[50,-c],[c,-c],[c,-50],[-c,-50],[-c,-c],[-50,-c],[-50,c],[-c,c],[-c,50],[c,50]]]},a={xmin:-50,ymin:-50,xmax:50,ymax:50}}else if("diamond"===i||"esriSMSDiamond"===i)r={rings:[[[-50,0],[0,50],[50,0],[0,-50],[-50,0]]]},a={xmin:-50,ymin:-50,xmax:50,ymax:50};else if("square"===i||"esriSMSSquare"===i)r={rings:[[[-50,-50],[-50,50],[50,50],[50,-50],[-50,-50]]]},a={xmin:-50,ymin:-50,xmax:50,ymax:50};else if("x"===i||"esriSMSX"===i){var c;r={rings:[[[0,c=0],[50-c,50],[50,50-c],[c,0],[50,c-50],[50-c,-50],[0,-c],[c-50,-50],[-50,c-50],[-c,0],[-50,50-c],[c-50,50],[0,c]]]},a={xmin:-50,ymin:-50,xmax:50,ymax:50}}else if("triangle"===i||"esriSMSTriangle"===i){var f=57.735026918962575,h=-f,v=2/3*100-100;r={rings:[[[h,v],[0,2/3*100],[f,v],[h,v]]]},a={xmin:h,ymin:v,xmax:f,ymax:2/3*100}}if(r&&a){var S=[{type:"CIMSolidFill",enable:!0,color:e.color}];e.outline&&S.push({type:"CIMSolidStroke",enable:!0,width:e.outline.width,color:e.outline.color});var p={type:"CIMPolygonSymbol",symbolLayers:S};t={type:"CIMPointSymbol",symbolLayers:[{type:"CIMVectorMarker",enable:!0,rotation:e.angle,size:e.size,offsetX:e.xoffset,offsetY:e.yoffset,frame:a,markerGraphics:[{type:"CIMMarkerGraphic",geometry:r,symbol:p}]}]}}return t},e.getFillColor=function(r){if(!r)return null;switch(r.type){case"CIMPolygonSymbol":if(r.symbolLayers)for(var a=0,t=r.symbolLayers;a<t.length;a++){var i=t[a],o=e.getFillColor(i);if(null!=o)return o}break;case"CIMTextSymbol":return e.getFillColor(r.symbol);case"CIMSolidFill":return r.color}},e.getStrokeColor=function(r){if(r)switch(r.type){case"CIMPolygonSymbol":case"CIMLineSymbol":if(r.symbolLayers)for(var a=0,t=r.symbolLayers;a<t.length;a++){var i=t[a],o=e.getStrokeColor(i);if(void 0!==o)return o}break;case"CIMTextSymbol":return e.getStrokeColor(r.symbol);case"CIMSolidStroke":return r.color}},e.getStrokeWidth=function(r){if(r)switch(r.type){case"CIMPolygonSymbol":case"CIMLineSymbol":if(r.symbolLayers)for(var a=0,t=r.symbolLayers;a<t.length;a++){var i=t[a],o=e.getStrokeWidth(i);if(void 0!==o)return o}break;case"CIMTextSymbol":return e.getStrokeWidth(r.symbol);case"CIMSolidStroke":case"CIMGradientStroke":case"CIMPictureStroke":return r.width}},e.getSize=function(r){if(r)switch(r.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":var a=0;if(r.symbolLayers)for(var t=0,i=r.symbolLayers;t<i.length;t++){var o=i[t],s=e.getSize(o);s>a&&(a=s)}return a;case"CIMSolidStroke":case"CIMPictureStroke":case"CIMGradientStroke":return r.width;case"CIMCharacterMarker":case"CIMPictureMarker":case"CIMVectorMarker":return r.size}},e.getMarkerScaleRatio=function(e){if(e)switch(e.type){case"CIMVectorMarker":if(!1!==e.scaleSymbolsProportionally&&e.frame){var r=e.frame.ymax-e.frame.ymin;return e.size/r}}return 1},e.executeEffects=function(e,r,a){void 0===a&&(a=!1);var t=e?e.length:0;t&&a&&--t;for(var i=0;i<t;++i){var o=e[i];if(o){var s=n.getEffectOperator(o);s&&(r=s.execute(r,o,96/72))}}return r},e.processEffects=function(r,a,t){var n;if(r.effects&&r.effects.length>0){var l=o.deltaEncodeGeometry(t);n=new s.SimpleGeometryCursor(l),n=e.executeEffects(r.effects,n)}var c=r.symbolLayers[a];if(c.effects&&c.effects.length>0){var f=!1;if("CIMGeometricEffectDashes"===c.effects[c.effects.length-1].type&&(f=!0),!n){l=o.deltaEncodeGeometry(t);n=new s.SimpleGeometryCursor(l)}n=e.executeEffects(c.effects,n,f)}if(!n)return t;for(var m=[],y=n.next();y;)m.push(y),y=n.next();var h=m.length;switch(h){case 0:return null;case 1:return o.deltaEncodeGeometry(m[0]);default:for(var v=m[0],S=1;S<h;++S){var p=m[S];i.isPolygon(v)&&i.isPolygon(p)&&Array.prototype.push.apply(v.rings,p.rings),i.isPolyline(v)&&i.isPolyline(p)&&Array.prototype.push.apply(v.paths,p.paths)}return o.deltaEncodeGeometry(v)}},e}();r.CIMSymbolHelper=S;var p=function(){function e(){}return e.rasterizeSimpleFill=function(e,r){"solid"!==r&&"none"!==r&&"esriSFSSolid"!==r&&"esriSFSNull"!==r||console.error("Unexpected: style does not require rasterization");e.width=8,e.height=8;var a=e.getContext("2d");a.strokeStyle="#FFFFFF",a.lineWidth=1,a.beginPath(),"vertical"!==r&&"cross"!==r&&"esriSFSCross"!==r&&"esriSFSVertical"!==r||(a.moveTo(0,0),a.lineTo(0,8)),"horizontal"!==r&&"cross"!==r&&"esriSFSCross"!==r&&"esriSFSHorizontal"!==r||(a.moveTo(0,0),a.lineTo(8,0)),"forward-diagonal"!==r&&"diagonal-cross"!==r&&"esriSFSDiagonalCross"!==r&&"esriSFSForwardDiagonal"!==r||(a.moveTo(0,0),a.lineTo(8,8)),"backward-diagonal"!==r&&"diagonal-cross"!==r&&"esriSFSBackwardDiagonal"!==r&&"esriSFSDiagonalCross"!==r||(a.moveTo(8,0),a.lineTo(0,8)),a.stroke();for(var t,i=a.getImageData(0,0,e.width,e.height),o=new Uint8Array(i.data),s=0;s<o.length;s+=4)t=o[s+3]/255,o[s]=o[s]*t,o[s+1]=o[s+1]*t,o[s+2]=o[s+2]*t;return[o,e.width,e.height]},e.rasterizeSimpleLine=function(e,r){var a;switch(r){case"butt":a="Butt";break;case"square":a="Square";break;default:a="Round"}var t,i="Butt"===a;switch(e){case"dash":case"esriSLSDash":t=i?[4,3]:[3,4];break;case"dash-dot":case"esriSLSDashDot":t=i?[4,3,1,3]:[3,4,0,4];break;case"dot":case"esriSLSDot":t=i?[1,3]:[0,4];break;case"long-dash":case"esriSLSLongDash":t=i?[8,3]:[7,4];break;case"long-dash-dot":case"esriSLSLongDashDot":t=i?[8,3,1,3]:[7,4,0,4];break;case"long-dash-dot-dot":case"esriSLSDashDotDot":t=i?[8,3,1,3,1,3]:[7,4,0,4,0,4];break;case"short-dash":case"esriSLSShortDash":t=i?[4,1]:[3,2];break;case"short-dash-dot":case"esriSLSShortDashDot":t=i?[4,1,1,1]:[3,2,0,2];break;case"short-dash-dot-dot":case"esriSLSShortDashDotDot":t=i?[4,1,1,1,1,1]:[3,2,0,2,0,2];break;case"short-dot":case"esriSLSShortDot":t=i?[1,1]:[0,2];break;case"solid":case"esriSLSSolid":case"none":h.error("Unexpected: style does not require rasterization"),t=[0,0];break;default:h.error("Tried to rasterize SLS, but found an unexpected style: "+e+"!"),t=[0,0]}return this.rasterizeDash(t,a)},e.rasterizeDash=function(e,r){for(var a="Butt"===r,t="Square"===r,i=!a&&!t,o=0,s=0,n=e;s<n.length;s++){o+=n[s]}for(var l=15*o,c=31*l,m=new Float32Array(c),y=i?225:15,h=0;h<c;++h)m[h]=y;for(var v=0,S=0,p=!0,d=0,u=e;d<u.length;d++){v=S,S+=15*u[d];for(var M=v;M<S;){for(var g=0;g<31;){h=g*l+M;var b=i?(g-15)*(g-15):Math.abs(g-15);m[h]=p?a?Math.max(Math.max(v+7.5-M,b),Math.max(M-S+7.5,b)):b:i?Math.min((M-v)*(M-v)+b,(M-S)*(M-S)+b):t?Math.min(Math.max(M-v,b),Math.max(S-M,b)):Math.min(Math.max(M-v+7.5,b),Math.max(S+7.5-M,b)),g++}M++}p=!p}var C=m.length,k=new Uint8Array(4*C);for(h=0;h<C;++h){var I=(i?Math.sqrt(m[h]):m[h])/15;f.packFloatRGBA(I,k,4*h)}return[k,l,31]},e}();r.SymbolHelper=p;var d=function(){function e(){}return e.findApplicableOverrides=function(r,a,t){if(a){if(r.primitiveName){for(var i=!1,o=0,s=t;o<s.length;o++){if((c=s[o]).primitiveName===r.primitiveName){i=!0;break}}if(!i)for(var n=0,l=a;n<l.length;n++){var c;(c=l[n]).primitiveName===r.primitiveName&&t.push(c)}}switch(r.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":if(r.effects)for(var f=0,m=r.effects;f<m.length;f++){var y=m[f];e.findApplicableOverrides(y,a,t)}if(r.symbolLayers)for(var h=0,v=r.symbolLayers;h<v.length;h++){var S=v[h];e.findApplicableOverrides(S,a,t)}break;case"CIMTextSymbol":break;case"CIMSolidStroke":case"CIMPictureStroke":case"CIMGradientStroke":case"CIMSolidFill":case"CIMPictureFill":case"CIMHatchFill":case"CIMGradientFill":case"CIMVectorMarker":case"CIMCharacterMarker":case"CIMPictureMarker":if(r.effects)for(var p=0,d=r.effects;p<d.length;p++){y=d[p];e.findApplicableOverrides(y,a,t)}if(r.markerPlacement&&e.findApplicableOverrides(r.markerPlacement,a,t),"CIMVectorMarker"===r.type){if(r.markerGraphics)for(var u=0,M=r.markerGraphics;u<M.length;u++){var g=M[u];e.findApplicableOverrides(g,a,t),e.findApplicableOverrides(g.symbol,a,t)}}else"CIMCharacterMarker"===r.type?e.findApplicableOverrides(r.symbol,a,t):"CIMHatchFill"===r.type&&e.findApplicableOverrides(r.lineSymbol,a,t)}}},e.applyOverrides=function(r,a,t,i){if(a){var o;if(r.primitiveName)for(var s=0,n=a;s<n.length;s++){var l=n[s];if(l.primitiveName===r.primitiveName){var c=(o=l.propertyName)?o.charAt(0).toLowerCase()+o.substr(1):o;if(i&&i.push({cim:r,nocapPropertyName:c,value:r[c]}),l.expression&&(l.value=e.toValue(l.propertyName,l.expression)),t){for(var f=!1,m=0,y=t;m<y.length;m++){y[m].primitiveName===r.primitiveName&&(f=!0)}f||t.push(l)}r[c]=l.value}}switch(r.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":if(r.effects)for(var h=0,v=r.effects;h<v.length;h++){var S=v[h];e.applyOverrides(S,a,t,i)}if(r.symbolLayers)for(var p=0,d=r.symbolLayers;p<d.length;p++){var u=d[p];e.applyOverrides(u,a,t,i)}break;case"CIMTextSymbol":break;case"CIMSolidStroke":case"CIMSolidFill":case"CIMVectorMarker":if(r.effects)for(var M=0,g=r.effects;M<g.length;M++){S=g[M];e.applyOverrides(S,a,t,i)}if("CIMVectorMarker"===r.type&&r.markerGraphics)for(var b=0,C=r.markerGraphics;b<C.length;b++){var k=C[b];e.applyOverrides(k,a,t,i),e.applyOverrides(k.symbol,a,t,i)}}}},e.restoreOverrides=function(e){for(var r=0,a=e;r<a.length;r++){var t=a[r];t.cim[t.nocapPropertyName]=t.value}},e.buildOverrideKey=function(e){for(var r="",a=0,t=e;a<t.length;a++){var i=t[a];void 0!==i.value&&(r+=""+i.primitiveName+i.propertyName+JSON.stringify(i.value))}return r},e.toValue=function(e,r){if("DashTemplate"===e)return r.split(" ").map((function(e){return Number(e)}));if("Color"===e){var t=new a(r).toRgba();return t[3]*=255,t}return r},e}();r.OverrideHelper=d}));