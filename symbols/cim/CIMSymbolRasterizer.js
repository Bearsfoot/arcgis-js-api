// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/generatorHelper","../../core/tsSupport/awaiterHelper","../../request","../../core/promiseUtils","../../core/screenUtils","../../geometry/support/jsonUtils","./cimAnalyzer","./Rasterizer","./TextRasterizer","./utils","../support/cimSymbolUtils","../support/Symbol3DAnchorPosition2D"],(function(e,t,a,r,i,n,o,s,l,c,u,h,p,m){var f=function(e,t){return e&&e.targetSize?e.targetSize/t.referenceSize:e&&e.scaleFactor?e.scaleFactor:1};return function(){function e(e,t){this._spatialReference=e,this._avoidSDF=t,this._resourceCache=new Map,this._rasterizer=new c.default,this._textRasterizer=new u.default,this._pictureMarkerCache=new Map}return e.prototype.rasterizeCIMSymbolAsync=function(e,t,i,n,o,l,c){return r(this,void 0,void 0,(function(){var r,u;return a(this,(function(a){switch(a.label){case 0:return r=t?null!==t.centroid?"esriGeometryPolygon":s.getJsonType(t.geometry):null,[4,this.analyzeCIMSymbol(e,t?(h=t.attributes,p=h?Object.keys(h):[],m=p.map((function(e){return{name:e,alias:e,type:"string"==typeof h[e]?"esriFieldTypeString":"esriFieldTypeDouble"}})),m):null,i,r,c)];case 1:return u=a.sent(),[2,this.rasterizeCIMSymbol(u,t,n,o,l)]}var h,p,m}))}))},e.prototype.analyzeCIMSymbol=function(e,t,i,o,s){return r(this,void 0,void 0,(function(){var r,c,u,h,m,f,g;return a(this,(function(a){switch(a.label){case 0:return[4,p.fetchSymbol(e,s)];case 1:return r=a.sent(),c=[],t?u=function(e,t,a){return{geometryType:t,spatialReference:a,fields:e}}(t,o,this._spatialReference):((r=r.clone()).data.primitiveOverrides=[],u=null),[4,l.analyzeCIMSymbol(r.data,i,u,c,this._avoidSDF)];case 2:for(a.sent(),n.throwIfAborted(s),m=0,f=c;m<f.length;m++)"CIMPictureMarker"===(g=f[m]).cim.type&&(h||(h=[]),h.push(this.fetchPictureMarkerResource(g,s)));return h?[4,n.all(h)]:[3,4];case 3:a.sent(),a.label=4;case 4:return[2,c]}}))}))},e.prototype.fetchPictureMarkerResource=function(e,t){return r(this,void 0,void 0,(function(){var r,n,o;return a(this,(function(a){switch(a.label){case 0:return r=e.materialHash,this._pictureMarkerCache.get(r)?[3,2]:[4,i(e.cim.url,{responseType:"image",signal:t&&t.signal})];case 1:n=a.sent(),o=n.data,this._pictureMarkerCache.set(r,o),a.label=2;case 2:return[2]}}))}))},e.prototype.rasterizeCIMSymbol=function(e,t,a,r,i){for(var n=[],o=0,s=e;o<s.length;o++){var l=s[o];!a||"function"!=typeof a.scaleFactor||"marker"!==l.type&&"text"!==l.type||(a.scaleFactor=a.scaleFactor(t,r,i));var c=this._getRasterizedResource(l,t,a,r,i);null!=c&&n.push({cimLayer:l,rasterizedResource:c})}return this.getSymbolImage(n,t,a,r,i)},e.prototype.getSymbolImage=function(e,t,a,r,i){for(var n=document.createElement("canvas"),s=n.getContext("2d"),l=0,c=0,u=0,p=0,g=[],v=0;v<e.length;v++){var y=e[v],d=y.rasterizedResource;if(d){var z=y.cimLayer;if("line"!==z.type&&"fill"!==z.type){var C=f(a,z),w=d.size,_=h.evaluateValueOrFunction(z.offsetX,t,r,i)*C,b=h.evaluateValueOrFunction(z.offsetY,t,r,i)*C;_=_||0,b=b||0;var x=y.rasterizedResource.anchorX,M=y.rasterizedResource.anchorY,F=!1,I=z.type,S=void 0;if("marker"===z.type&&(S=h.evaluateValueOrFunction(z.rotation,t,r,i),F=!!z.rotateClockwise&&z.rotateClockwise),"text"===z.type){if(S=h.evaluateValueOrFunction(z.angle,t,r,i),void 0!==z.horizontalAlignment)switch(z.horizontalAlignment){case"left":x=-.5;break;case"right":x=.5;break;default:x=0}if(void 0!==z.verticalAlignment)switch(z.verticalAlignment){case"top":M=.5;break;case"bottom":M=-.5;break;case"baseline":M=-.25;break;default:M=0}}var R=o.pt2px(_)-w[0]*(.5+x),D=o.pt2px(b)-w[1]*(.5+M),O=R+w[0],k=D+w[1];if(S){F&&(S=-S);var A=Math.sin(S*Math.PI/180),V=Math.cos(S*Math.PI/180),P=R*V-D*A,T=R*A+D*V,X=R*V-k*A,Y=R*A+k*V,H=O*V-k*A,U=O*A+k*V,E=O*V-D*A,J=O*A+D*V;R=Math.min(P,X,H,E),D=Math.min(T,Y,U,J),O=Math.max(P,X,H,E),k=Math.max(T,Y,U,J)}l=R<l?R:l,c=D<c?D:c,u=O>u?O:u,p=k>p?k:p;var N=s.createImageData(d.size[0],d.size[1]);N.data.set(new Uint8ClampedArray(d.image.buffer));var j={offsetX:_,offsetY:b,rotateClockwise:F,type:I,angle:S,rasterizedImage:N,anchorX:x,anchorY:M};g.push(j)}}}n.width=u-l,n.height=p-c;var q=-l,L=p;for(v=0;v<g.length;v++){j=g[v];var G=this._imageDataToCanvas(j.rasterizedImage),B=j.rasterizedImage.width,K=j.rasterizedImage.height,Q=q-B*(.5+j.anchorX),W=L-K*(.5-j.anchorY);if(j.angle){var Z=(360-j.angle)*Math.PI/180;s.save(),s.translate(o.pt2px(j.offsetX),-o.pt2px(j.offsetY)),s.translate(q,L),s.rotate(Z),s.translate(-q,-L),s.drawImage(G,Q,W),s.restore()}else s.drawImage(G,Q+o.pt2px(j.offsetX),W-o.pt2px(j.offsetY))}var $=new m.default({x:q/n.width-.5,y:L/n.height-.5});return{imageData:0!==n.width&&0!==n.height?s.getImageData(0,0,n.width,n.height):s.createImageData(1,1),anchorPosition:$}},e.prototype._imageDataToCanvas=function(e){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));var t=this._imageDataCanvas,a=t.getContext("2d");return t.width=e.width,t.height=e.height,a.putImageData(e,0,0),t},e.prototype._imageTo32Array=function(e,t,a){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));var r=this._imageDataCanvas,i=r.getContext("2d");return r.width=t,r.height=a,i.drawImage(e,0,0,t,a),new Uint32Array(i.getImageData(0,0,t,a).data.buffer)},e.prototype._getRasterizedResource=function(e,t,a,r,i){var n,s;if("text"===e.type)n=e.cim,s=this._rasterizeTextResource(e,t,a,r,i);else{var c=this._resourceCache,u=void 0;if("function"==typeof e.materialHash)u=(0,e.materialHash)(t,r,i),n=l.analyzeCIMResource(e.cim,e.materialOverrides);else u=e.materialHash,a&&(u+=JSON.stringify(a)),n=e.cim;if(c.has(u))return c.get(u);var p=f(a,e);if("CIMPictureMarker"===e.cim.type){var m=h.evaluateValueOrFunction(e.cim.size,t,r,i)*p,g=this._pictureMarkerCache.get(e.materialHash);if(!g)return null;var v=g.height/g.width,y=v>1?o.pt2px(m):o.pt2px(m)/v,d=v>1?o.pt2px(m)*v:o.pt2px(m);s={image:this._imageTo32Array(g,y,d),size:[y,d],sdf:!1,simplePattern:!1,anchorX:e.anchorPoint?e.anchorPoint.x:0,anchorY:e.anchorPoint?e.anchorPoint.y:0}}else n.size*=p,s=this._rasterizer.rasterizeJSONResource(n,this._avoidSDF);c.set(u,s)}return s},e.prototype._rasterizeTextResource=function(e,t,a,r,i){var n=f(a,e),o=h.evaluateValueOrFunction(e.text,t,r,i);if(!o||0===o.length)return null;var s=h.evaluateValueOrFunction(e.fontName,t,r,i),l=h.evaluateValueOrFunction(e.style,t,r,i),c=h.evaluateValueOrFunction(e.weight,t,r,i),u=h.evaluateValueOrFunction(e.decoration,t,r,i),p=h.evaluateValueOrFunction(e.size,t,r,i)*n,m=h.evaluateValueOrFunction(e.horizontalAlignment,t,r,i),g=h.evaluateValueOrFunction(e.verticalAlignment,t,r,i),v=h.colorToArray(h.evaluateValueOrFunction(e.color,t,r,i)),y=h.colorToArray(h.evaluateValueOrFunction(e.outlineColor,t,r,i)),d={color:v,size:p,horizontalAlignment:m,verticalAlignment:g,font:{family:s,style:l,weight:c,decoration:u},halo:{size:h.evaluateValueOrFunction(e.outlineSize,t,r,i)||0,color:y,style:l},pixelRatio:1,premultiplyColors:!this._avoidSDF};return this._textRasterizer.rasterizeText(o,d)},e}()}));