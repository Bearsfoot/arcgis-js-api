// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/generatorHelper","../../core/tsSupport/awaiterHelper","../../core/tsSupport/assignHelper","../../core/compilerUtils","../../core/maybe","../../core/promiseUtils","../../support/arcadeOnDemand","./previewCIMSymbol","./previewSymbol2D","./previewSymbol3D","./previewWebStyleSymbol","./utils"],(function(e,t,r,l,a,i,o,n,s,c,u,p,d,h){Object.defineProperty(t,"__esModule",{value:!0});var y=null;function b(e,t){return Math.floor(Math.random()*(t-e+1)+e)}t.renderDotDensityPreviewHTML=function(e,t,r){var l=e.backgroundColor,a=e.outline,i=e.dotSize,o=r&&r.swatchSize||22,n=Math.round(o*o/Math.pow(i,2)*.8),s=window.devicePixelRatio,c=document.createElement("canvas"),u=o*s;c.width=u,c.height=u,c.style.width=c.width/s+"px",c.style.height=c.height/s+"px";var p=c.getContext("2d");if(l&&(p.fillStyle=l.toCss(!0),p.fillRect(0,0,u,u),p.fill()),p.fillStyle=t.toCss(!0),y&&y.length/2===n)for(var d=0;d<2*n;d+=2){var h=y[d],v=y[d+1];p.fillRect(h,v,i*s,i*s),p.fill()}else{y=[];for(d=0;d<2*n;d+=2){h=b(0,u),v=b(0,u);y.push(h,v),p.fillRect(h,v,i*s,i*s),p.fill()}}a&&(a.color&&(p.strokeStyle=a.color.toCss(!0)),p.lineWidth=a.width,p.strokeRect(0,0,u,u));var m=new Image(o,o);return m.src=c.toDataURL(),m},t.renderColorRampPreviewHTML=function(e,t){void 0===t&&(t={});var r="horizontal"===t.align,l=r?75:24,a=r?24:75,i=t.width,o=void 0===i?l:i,n=t.height,s=void 0===n?a:n,c=t.gradient,u=void 0===c||c,p=window.devicePixelRatio,d=o*p,h=s*p,y=document.createElement("canvas");y.width=d,y.height=h,y.style.width=o+"px",y.style.height=s+"px";var b=y.getContext("2d"),v=r?d:0,m=r?0:h;if(u){var g=b.createLinearGradient(0,0,v,m),f=1/(e.length-1);e.forEach((function(e,t){return g.addColorStop(t*f,e.toString())})),b.fillStyle=g,b.fillRect(0,0,d,h)}else for(var S=r?d/e.length:d,w=r?h:h/e.length,C=0,R=0,x=0,V=e;x<V.length;x++){var M=V[x];b.fillStyle=M.toString(),b.fillRect(C,R,S,w),C=r?C+S:0,R=r?0:R+w}var D=document.createElement("div");return D.style.width=o+"px",D.style.height=s+"px",D.appendChild(y),D},t.renderPreviewHTML=function e(t,r){switch(t.type){case"web-style":return d.previewWebStyleSymbol(t,e,r);case"label-3d":case"line-3d":case"mesh-3d":case"point-3d":case"polygon-3d":return p.previewSymbol3D(t,r);case"simple-marker":case"simple-line":case"simple-fill":case"picture-marker":case"picture-fill":case"text":return u.previewSymbol2D(t,r);case"cim":return c.previewCIMSymbol(t,r);default:return void i.neverReached(t)}},t.getDisplayedSymbol=function(t,i){return l(this,void 0,void 0,(function(){var l,c,u,p,d,y,b,v,m,g,f,S,w,C,R,x,V,M,D,k,L,T,z;return r(this,(function(r){switch(r.label){case 0:return t?(l=function e(t){return t&&"opacity"in t?t.opacity*e(t.parent):1}(t.layer||t.sourceLayer),!o.isSome(t.symbol)||o.isSome(i)&&!0===i.ignoreGraphicSymbol?[3,4]:"web-style"!==t.symbol.type?[3,2]:[4,t.symbol.fetchSymbol(o.isSome(i)?i.abortOptions:null)]):[2,void 0];case 1:return u=r.sent(),[3,3];case 2:u=t.symbol.clone(),r.label=3;case 3:return c=u,h.applyColorToSymbol(c,null,l),[2,c];case 4:return[4,(p=t.get("layer.renderer")||t.get("sourceLayer.renderer")).getSymbolAsync(t)];case 5:return(d=r.sent())?"web-style"!==d.type?[3,7]:[4,d.fetchSymbol(o.isSome(i)?i.abortOptions:null)]:[2,void 0];case 6:return d=r.sent(),[3,8];case 7:d=d.clone(),r.label=8;case 8:return!("visualVariables"in p)||"visualVariables"in p&&!p.visualVariables||"visualVariables"in p&&p.visualVariables&&!p.visualVariables.length?[2,d]:p.arcadeRequiredForVisualVariables&&(o.isNone(i)||o.isNone(i.arcade))?(y=a({},o.unwrap(i)),b=y,[4,s.loadArcade()]):[3,10];case 9:b.arcade=r.sent(),i=y,r.label=10;case 10:return[4,n.create((function(t){return e(["../../renderers/visualVariables/support/visualVariableUtils"],t)}))];case 11:for(v=r.sent(),m=[],g=[],f=[],S=[],w=0,C=p.visualVariables;w<C.length;w++)switch((R=C[w]).type){case"color":m.push(R);break;case"opacity":g.push(R);break;case"rotation":S.push(R);break;case"size":R.target||f.push(R)}return x=!!m.length&&m[m.length-1],V=x?v.getColor(x,t,i):null,M=!!g.length&&g[g.length-1],D=M?v.getOpacity(M,t,i):null,null!=l&&(D=null!=D?D*l:l),h.applyColorToSymbol(d,V,D),f.length?(k=v.getAllSizes(f,t,i),[4,h.applySizesToSymbol(d,k)]):[3,13];case 12:r.sent(),r.label=13;case 13:for(L=0,T=S;L<T.length;L++)z=T[L],h.applyRotationToSymbol(d,v.getRotationAngle(z,t,i),z.axis);return[2,d]}}))}))}}));