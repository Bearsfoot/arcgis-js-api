// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/assignHelper","../../core/colorUtils","../../core/compilerUtils","../../core/Error","../../core/Logger","../../core/maybe","../../core/promiseUtils","../../core/screenUtils","./gfxUtils","./IconSymbol3DLayerResource","./ObjectSymbol3DLayerResource","./previewUtils","./renderUtils","./styleUtils","./utils"],(function(e,a,r,t,s,l,o,i,n,h,p,u,c,m,f,v,y){Object.defineProperty(a,"__esModule",{value:!0});var d=e.toUrl("../../images/Legend/legend3dsymboldefault.png"),b=o.getLogger("esri.symbols.support.previewSymbol3D");function g(e){var a=e.outline,r=i.isSome(e.material)?e.material.color:null,t=i.isSome(r)?r.toRgba().toString():null;if(i.isNone(a))return"fill"===e.type&&"255,255,255,1"===t?{color:"#bdc3c7",width:.75}:null;var s=h.pt2px(a.size)||0;return{color:"rgba("+(i.isSome(a.color)?a.color.toRgba():"255,255,255,1")+")",width:Math.min(s,80)}}function x(e,a){void 0===a&&(a=1);var r=e.a,s=t.toHSV(e),l=s.h,o=s.s/a,i=100-(100-s.v)/a,n=t.toRGB({h:l,s:o,v:i});return[n.r,n.g,n.b,r]}function k(e,a){return Math.round(Math.min(Math.max(e+255*a*.75,0),255))}function M(e){return"water"===e.type?i.isNone(e.color)?null:e.color:i.isNone(e.material)||i.isNone(e.material.color)?null:e.material.color}function S(e,a){void 0===a&&(a=0);var r=M(e);if(!r){var t=k(p.defaultThematicColor.r,a);return[t,t,t,100]}for(var s=r.toRgba(),l=0;l<3;l++)s[l]=k(s[l],a);return s}function w(e){return e.outline?g(e):{color:"rgba(0, 0, 0, 1)",width:1.5}}function L(e,a){var r=M(e);if(!r)return null;var t="rgba(";return t+=k(r.r,a)+",",t+=k(r.g,a)+",",(t+=k(r.b,a)+",")+r.a+");"}function z(e,a){var r=L(e,a);return r?{color:r,width:Math.min(e.size?h.pt2px(e.size):.75,80)}:{}}function U(e,a,r){var t=.75*r;return{type:"linear",x1:t?.25*t:0,y1:t?.5*t:0,x2:t||4,y2:t?.5*t:4,colors:[{color:e,offset:0},{color:a,offset:1}]}}function j(e,a){var r,t=a&&a.size?h.pt2px(a.size):null,l=a&&a.maxSize?h.pt2px(a.maxSize):null,o=a&&a.disableUpsampling,i=e.symbolLayers,p=[],x=0,k=0,M=i.getItemAt(i.length-1);return M&&"icon"===M.type&&(r=M.size&&h.pt2px(M.size)),i.forEach((function(i){if("icon"===i.type||"object"===i.type){var b="icon"===i.type?i.size&&h.pt2px(i.size):0,M=t||b?Math.ceil(Math.min(t||b,l||120)):22;if(i&&i.resource&&i.resource.href){var L=function(e,a){var r=a&&a.resource,t=r&&r.href;return e.thumbnail&&e.thumbnail.url?n.resolve(e.thumbnail.url):t&&"object"!==a.type?n.resolve(y.getIconHref(e,a)):e.styleOrigin&&(e.styleOrigin.styleName||e.styleOrigin.styleUrl)?v.resolveWebStyleSymbol(e.styleOrigin,{portal:e.styleOrigin.portal},"webRef").catch((function(e){return e})).then((function(e){return e&&e.thumbnail&&e.thumbnail.url||d})):n.resolve(d)}(e,i).then((function(e){var a=i.get("material.color"),r=function(e){return"icon"===e.type?"multiply":"tint"}(i);return f.tintImageWithColor(e,M,a,r,o)})).then((function(e){var a=e.width,r=e.height;return x=Math.max(x,a),k=Math.max(k,r),[{shape:{type:"image",x:0,y:0,width:a,height:r,src:e.url},fill:null,stroke:null}]}));p.push(L)}else{var z=M;"icon"===i.type&&r&&t&&(z=M*(b/r));var j=a&&"tall"===a.symbolConfig||"object"===i.type&&function(e){var a=e.depth,r=e.height,t=e.width;return t&&a&&r&&t===a&&t<r}(i);x=Math.max(x,j?20:z),k=Math.max(k,z),p.push(n.resolve(function(e,a,r){var t=[];if(!e)return t;switch(e.type){case"icon":var l=a,o=a;switch(i=e.resource&&e.resource.primitive||u.defaultPrimitive){case"circle":t.push({shape:{type:"circle",cx:0,cy:0,r:.5*a},fill:S(e,0),stroke:g(e)});break;case"square":t.push({shape:{type:"path",path:[{command:"M",values:[0,o]},{command:"L",values:[0,0]},{command:"L",values:[l,0]},{command:"L",values:[l,o]},{command:"Z",values:[]}]},fill:S(e,0),stroke:g(e)});break;case"triangle":t.push({shape:{type:"path",path:[{command:"M",values:[0,o]},{command:"L",values:[.5*l,0]},{command:"L",values:[l,o]},{command:"Z",values:[]}]},fill:S(e,0),stroke:g(e)});break;case"cross":t.push({shape:{type:"path",path:[{command:"M",values:[.5*l,0]},{command:"L",values:[.5*l,o]},{command:"M",values:[0,.5*o]},{command:"L",values:[l,.5*o]}]},stroke:w(e)});break;case"x":t.push({shape:{type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[l,o]},{command:"M",values:[l,0]},{command:"L",values:[0,o]}]},stroke:w(e)});break;case"kite":t.push({shape:{type:"path",path:[{command:"M",values:[0,.5*o]},{command:"L",values:[.5*l,0]},{command:"L",values:[l,.5*o]},{command:"L",values:[.5*l,o]},{command:"Z",values:[]}]},fill:S(e,0),stroke:g(e)});break;default:s.neverReached(i)}break;case"object":var i;switch(i=e.resource&&e.resource.primitive||c.defaultPrimitive){case"cone":var n=U(S(e,0),S(e,-.6),r?20:a),h=m.getConeShapes(a,r);t.push({shape:h[0],fill:n}),t.push({shape:h[1],fill:n});break;case"inverted-cone":var p=S(e,0),f=U(p,S(e,-.6),a),v=m.getInvertedConeShapes(a);t.push({shape:v[0],fill:f}),t.push({shape:v[1],fill:p});break;case"cube":var y=m.getCubeShapes(a,r);t.push({shape:y[0],fill:S(e,0)}),t.push({shape:y[1],fill:S(e,-.3)}),t.push({shape:y[2],fill:S(e,-.5)});break;case"cylinder":var d=U(S(e,0),S(e,-.6),r?20:a),b=m.getCylinderShapes(a,r);t.push({shape:b[0],fill:d}),t.push({shape:b[1],fill:d}),t.push({shape:b[2],fill:S(e,0)});break;case"diamond":var x=m.getDiamondShapes(a);t.push({shape:x[0],fill:S(e,-.3)}),t.push({shape:x[1],fill:S(e,0)}),t.push({shape:x[2],fill:S(e,-.3)}),t.push({shape:x[3],fill:S(e,-.7)});break;case"sphere":var k=U(S(e,0),S(e,-.6));k.x1=0,k.y1=0,k.x2=.25*a,k.y2=.25*a,t.push({shape:{type:"circle",cx:0,cy:0,r:.5*a},fill:k});break;case"tetrahedron":var M=m.getTetrahedronShapes(a);t.push({shape:M[0],fill:S(e,-.3)}),t.push({shape:M[1],fill:S(e,0)}),t.push({shape:M[2],fill:S(e,-.6)});break;default:s.neverReached(i)}}return t}(i,z,j)))}}})),n.eachAlways(p).then((function(e){var r=[];return e.forEach((function(e){e.value?r.push(e.value):e.error&&b.warn("error while building swatchInfo!",e.error)})),f.renderSymbol(r,[x,k],{node:a&&a.node,scale:!1,opacity:a&&a.opacity})}))}a.getSymbolLayerFill=S,a.previewSymbol3D=function(e,a){if(0===e.symbolLayers.length)return n.reject(new l("symbolPreview: renderPreviewHTML3D","No symbolLayers in the symbol."));var t=null;switch(e.type){case"point-3d":t=j(e,a);break;case"line-3d":t=function(e,a){var t,s=e.symbolLayers,l=[],o=y.isVolumetricSymbol(e),i=a&&a.size?h.pt2px(a.size):null,p=(a&&a.maxSize?h.pt2px(a.maxSize):null)||80,u=0,c=0;return s.forEach((function(e,a){if(e&&("line"===e.type||"path"===e.type)){var s=[];switch(e.type){case"line":var o=(g=z(e,0))&&g.width||0;0===a&&(t=o);var n=Math.min(i||o,p),h=0===a?n:i?n*(o/t):n,f=h>20?2*h:40;c=Math.max(c,h),u=Math.max(u,f),g.width=h,s.push({shape:{type:"path",path:[{command:"M",values:[0,.5*c]},{command:"L",values:[u,.5*c]}]},stroke:g});break;case"path":var v=Math.min(i||22,p),y=S(e,0),d=S(e,-.2),b=L(e,-.4),g=b?{color:b,width:1}:{};if("quad"===e.profile){var x=e.width||e.size,k=e.height||e.size,M=x&&k?x/k:1,w=m.getPathSymbolShapes(M),U=r({},g,{join:"bevel"});s.push({shape:w[0],fill:d,stroke:U}),s.push({shape:w[1],fill:d,stroke:U}),s.push({shape:w[2],fill:y,stroke:U})}else s.push({shape:m.shapes.pathSymbol3DLayer[0],fill:d,stroke:g}),s.push({shape:m.shapes.pathSymbol3DLayer[1],fill:y,stroke:g});c=Math.max(c,v),u=c}l.push(s)}})),n.resolve(f.renderSymbol(l,[u,c],{node:a&&a.node,scale:o,opacity:a&&a.opacity}))}(e,a);break;case"polygon-3d":case"mesh-3d":t=function(e,a){for(var t="mesh-3d"===e.type,s=e.symbolLayers,l=a&&a.size?h.pt2px(a.size):null,o=a&&a.maxSize?h.pt2px(a.maxSize):null,i=l||22,p=[],u=0,c=0,v=!1,y=0;y<s.length;y++){var d=s.getItemAt(y),b=[];if(!t||"fill"===d.type){var k=m.shapes.fill[0];switch(d.type){case"fill":var w=g(d),L=Math.min(i,o||120);u=Math.max(u,L),c=Math.max(c,L),v=!0,b.push({shape:k,fill:S(d,0),stroke:w});break;case"line":var U={stroke:z(d,0),shape:k};u=Math.max(u,22),c=Math.max(c,22),b.push(U);break;case"extrude":var j=r({join:"round"},z(d,-.4)),D=S(d,0),R=S(d,-.2),I=Math.min(i,o||120),C=m.getExtrudeSymbolShapes(I);j.width=1,b.push({shape:C[0],fill:R,stroke:j}),b.push({shape:C[1],fill:R,stroke:j}),b.push({shape:C[2],fill:D,stroke:j});var O=22*.7+.5*I;u=Math.max(u,22),c=Math.max(c,O);break;case"water":var P=M(d),N=(D=x(P),x(P,2)),E=x(P,3),H=m.getWaterSymbolShapes();v=!0,b.push({shape:H[0],fill:D}),b.push({shape:H[1],fill:N}),b.push({shape:H[2],fill:E});L=Math.min(i,o||120);u=Math.max(u,L),c=Math.max(c,L)}p.push(b)}}return n.resolve(f.renderSymbol(p,[u,c],{node:a&&a.node,scale:v,opacity:a&&a.opacity}))}(e,a)}return t||n.reject(new l("symbolPreview: swatchInfo3D","symbol not supported."))}}));