// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/assignHelper","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","../config","../kernel","../request","../core/cookie","../core/Error","../core/Evented","../core/global","../core/lang","../core/object","../core/promiseUtils","../core/string","../core/urlUtils","../core/urlUtils","../core/accessorSupport/decorators","./IdentityForm","./IdentityModal","./OAuthCredential","./OAuthInfo","./ServerInfo"],(function(e,r,t,i,n,s,o,a,l,u,h,c,d,p,f,v,_,g,m,S,w,y,I,k){Object.defineProperty(r,"__esModule",{value:!0});var A={},U=function(e){var r=new g.Url(e.owningSystemUrl).host,t=new g.Url(e.server).host,i=/.+\.arcgis\.com$/i;return i.test(r)&&i.test(t)},x=function(e,r){return!!(U(e)&&r&&r.some((function(r){return r.test(e.server)})))},T=function(e){function r(){var r=e.call(this)||this;return r._portalConfig=c.esriGeowConfig,r.serverInfos=[],r.oAuthInfos=[],r.credentials=[],r._soReqs=[],r._xoReqs=[],r._portals=[],r.defaultOAuthInfo=null,r.defaultTokenValidity=60,r.dialog=null,r.formConstructor=S,r.tokenValidity=null,r.signInPage=null,r.useSignInPage=!0,r.normalizeWebTierAuth=!1,r._busy=null,r._rejectOnPersistedPageShow=!1,r._oAuthHash=null,r._gwTokenUrl="/sharing/rest/generateToken",r._agsRest="/rest/services",r._agsPortal=/\/sharing(\/|$)/i,r._agsAdmin=/(https?:\/\/[^\/]+\/[^\/]+)\/admin\/?(\/.*)?$/i,r._adminSvcs=/\/rest\/admin\/services(\/|$)/i,r._agolSuffix=".arcgis.com",r._gwDomains=[{regex:/^https?:\/\/www\.arcgis\.com/i,customBaseUrl:"maps.arcgis.com",tokenServiceUrl:"https://www.arcgis.com/sharing/rest/generateToken"},{regex:/^https?:\/\/(?:dev|[a-z\d-]+\.mapsdev)\.arcgis\.com/i,customBaseUrl:"mapsdev.arcgis.com",tokenServiceUrl:"https://dev.arcgis.com/sharing/rest/generateToken"},{regex:/^https?:\/\/(?:devext|[a-z\d-]+\.mapsdevext)\.arcgis\.com/i,customBaseUrl:"mapsdevext.arcgis.com",tokenServiceUrl:"https://devext.arcgis.com/sharing/rest/generateToken"},{regex:/^https?:\/\/(?:qaext|[a-z\d-]+\.mapsqa)\.arcgis\.com/i,customBaseUrl:"mapsqa.arcgis.com",tokenServiceUrl:"https://qaext.arcgis.com/sharing/rest/generateToken"},{regex:/^https?:\/\/[a-z\d-]+\.maps\.arcgis\.com/i,customBaseUrl:"maps.arcgis.com",tokenServiceUrl:"https://www.arcgis.com/sharing/rest/generateToken"}],r._legacyFed=[],r._regexSDirUrl=/http.+\/rest\/services\/?/gi,r._regexServerType=/(\/(MapServer|GeocodeServer|GPServer|GeometryServer|ImageServer|NAServer|FeatureServer|GeoDataServer|GlobeServer|MobileServer|GeoenrichmentServer|VectorTileServer|SceneServer)).*/gi,r._gwUser=/http.+\/users\/([^\/]+)\/?.*/i,r._gwItem=/http.+\/items\/([^\/]+)\/?.*/i,r._gwGroup=/http.+\/groups\/([^\/]+)\/?.*/i,r._rePortalTokenSvc=/\/sharing(\/rest)?\/generatetoken/i,r._createDefaultOAuthInfo=!0,r._hasTestedIfAppIsOnPortal=!1,r._getOAuthHash(),window.addEventListener("pageshow",(function(e){r._pageShowHandler(e)})),r}return i(r,e),r.prototype.registerServers=function(e){var r=this,t=this.serverInfos;t?(e=e.filter((function(e){return!r.findServerInfo(e.server)})),this.serverInfos=t.concat(e)):this.serverInfos=e,e.forEach((function(e){e.owningSystemUrl&&r._portals.push(e.owningSystemUrl),e.hasPortal&&r._portals.push(e.server)}))},r.prototype.registerOAuthInfos=function(e){var r=this,t=this.oAuthInfos;t?(e=e.filter((function(e){return!r.findOAuthInfo(e.portalUrl)})),this.oAuthInfos=t.concat(e)):this.oAuthInfos=e},r.prototype.registerToken=function(e){e=t({},e);var r,i=this._sanitizeUrl(e.server),n=this._isServerRsrc(i),s=this.findServerInfo(i),o=!0;s||((s=new k).server=this._getServerInstanceRoot(i),n?s.hasServer=!0:(s.tokenServiceUrl=this._getTokenSvcUrl(i),s.hasPortal=!0),this.registerServers([s])),(r=this._findCredential(i))?(delete e.server,d.mixin(r,e),o=!1):((r=new O({userId:e.userId,server:s.server,token:e.token,expires:e.expires,ssl:e.ssl,scope:n?"server":"portal"})).resources=[i],this.credentials.push(r)),r.emitTokenChange(!1),o||r.refreshServerTokens()},r.prototype.toJSON=function(){return d.fixJson({serverInfos:this.serverInfos.map((function(e){return e.toJSON()})),oAuthInfos:this.oAuthInfos.map((function(e){return e.toJSON()})),credentials:this.credentials.map((function(e){return e.toJSON()}))})},r.prototype.initialize=function(e){var r=this;if(e){"string"==typeof e&&(e=JSON.parse(e));var t=e.serverInfos,i=e.oAuthInfos,n=e.credentials;if(t){var s=[];t.forEach((function(e){e.server&&e.tokenServiceUrl&&s.push(e.declaredClass?e:new k(e))})),s.length&&this.registerServers(s)}if(i){var o=[];i.forEach((function(e){e.appId&&o.push(e.declaredClass?e:new I(e))})),o.length&&this.registerOAuthInfos(o)}n&&n.forEach((function(e){e.server&&e.token&&e.expires&&e.expires>Date.now()&&((e=e.declaredClass?e:new O(e)).emitTokenChange(),r.credentials.push(e))}))}},r.prototype.findServerInfo=function(e){var r;e=this._sanitizeUrl(e);for(var t=0,i=this.serverInfos;t<i.length;t++){var n=i[t];if(this._hasSameServerInstance(n.server,e)){r=n;break}}return r},r.prototype.findOAuthInfo=function(e){var r;e=this._sanitizeUrl(e);for(var t=0,i=this.oAuthInfos;t<i.length;t++){var n=i[t];if(this._hasSameServerInstance(n.portalUrl,e)){r=n;break}}return r},r.prototype.findCredential=function(e,r){var t,i;if(e=this._sanitizeUrl(e),i=this._isServerRsrc(e)?"server":"portal",r)for(var n=0,s=this.credentials;n<s.length;n++){var o=s[n];if(this._hasSameServerInstance(o.server,e)&&r===o.userId&&o.scope===i){t=o;break}}else for(var a=0,l=this.credentials;a<l.length;a++){o=l[a];if(this._hasSameServerInstance(o.server,e)&&-1!==this._getIdenticalSvcIdx(e,o)&&o.scope===i){t=o;break}}return t},r.prototype.getCredential=function(e,r){var i,n,s=!0;r&&(i=!!r.token,n=r.error,s=!1!==r.prompt),r=t({},r),e=this._sanitizeUrl(e);var o=f.createAbortController(),a=f.createResolver((function(){o.abort()}));if(r.signal&&f.onAbort(r.signal,(function(){o.abort()})),f.onAbort(o,(function(){a.reject(new u("identity-manager:user-aborted","ABORTED"))})),f.isAborted(o))return a.promise;r.signal=o.signal;var h,c=this._isAdminResource(e),d=i&&this._doPortalSignIn(e)?this._getEsriAuthCookie():null,p=i?this.findCredential(e):null;if(p&&n&&n.details&&498===n.details.httpStatus)p.destroy(),d&&d.token===r.token&&(l.writeCookie("esri_auth",null,{expires:-1,path:"/",domain:document.domain}),v.endsWith(window.location.hostname,".arcgis.com")&&l.writeCookie("esri_auth",null,{expires:-1,path:"/",domain:"arcgis.com"}));else if(d||p){var _=d&&d.email||p&&p.userId;return h=new u("identity-manager:not-authorized","You are currently signed in as: '"+_+"'. You do not have access to this resource: "+e,{error:n}),a.reject(h),a.promise}var g=this._findCredential(e,r);if(g)return a.resolve(g),a.promise;var m=this.findServerInfo(e);if(m)!m.hasServer&&this._isServerRsrc(e)&&(m._restInfoPms=this._getTokenSvcUrl(e),m.hasServer=!0);else{var S=this._getTokenSvcUrl(e);if(!S)return h=new u("identity-manager:unknown-resource","Unknown resource - could not find token service endpoint."),a.reject(h),a.promise;(m=new k).server=this._getServerInstanceRoot(e),"string"==typeof S?(m.tokenServiceUrl=S,m.hasPortal=!0):(m._restInfoPms=S,m.hasServer=!0),this.registerServers([m])}return s&&m.hasPortal&&void 0===m._selfReq&&!this._findOAuthInfo(e)&&(m._selfReq={owningTenant:r&&r.owningTenant,selfDfd:this._getPortalSelf(m.tokenServiceUrl.replace(this._rePortalTokenSvc,"/sharing/rest/portals/self"),e)}),this._enqueue(e,m,r,a,c)},r.prototype.getResourceName=function(e){return this._isRESTService(e)?e.replace(this._regexSDirUrl,"").replace(this._regexServerType,"")||"":this._gwUser.test(e)&&e.replace(this._gwUser,"$1")||this._gwItem.test(e)&&e.replace(this._gwItem,"$1")||this._gwGroup.test(e)&&e.replace(this._gwGroup,"$1")||""},r.prototype.generateToken=function(e,r,t){var i,n,s,o,l,h,c,p,f,v,m=this._rePortalTokenSvc.test(e.tokenServiceUrl),S=new g.Url(window.location.href.toLowerCase()),w=this._getEsriAuthCookie(),y=e.shortLivedTokenValidity;return r&&(v=this.tokenValidity||y||this.defaultTokenValidity)>y&&y>0&&(v=y),t&&(n=t.isAdmin,s=t.serverUrl,o=t.token,c=t.signal,p=t.ssl,e.customParameters=t.customParameters),n?l=e.adminTokenServiceUrl:(l=e.tokenServiceUrl,h=new g.Url(l.toLowerCase()),w&&(i=(i=w.auth_tier)&&i.toLowerCase()),("web"===i||e.webTierAuth)&&t&&t.serverUrl&&!p&&"http"===S.scheme&&(_.hasSameOrigin(S.uri,l,!0)||"https"===h.scheme&&S.host===h.host&&"7080"===S.port&&"7443"===h.port)&&(l=l.replace(/^https:/i,"http:").replace(/:7443/i,":7080"))),f=d.mixin({query:d.mixin({request:"getToken",username:r&&r.username,password:r&&r.password,serverUrl:s,token:o,expiration:v,referer:n||m?window.location.host:null,client:n?"referer":null,f:"json"},e.customParameters),method:"post",authMode:"anonymous",useProxy:this._useProxy(e,t),signal:c},t&&t.ioArgs),m||(f.withCredentials=!1),a(l,f).then((function(t){var i=t.data;if(!i||!i.token)return new u("identity-manager:authentication-failed","Unable to generate token");var n=e.server;return A[n]||(A[n]={}),r&&(A[n][r.username]=r.password),i.validity=v,i}))},r.prototype.isBusy=function(){return!!this._busy},r.prototype.checkSignInStatus=function(e){return this.checkAppAccess(e,"").then((function(e){return e.credential}))},r.prototype.checkAppAccess=function(e,r,t){var i=this,n=!1;return this.getCredential(e,{prompt:!1}).then((function(s){var o,l={f:"json"};if("portal"===s.scope)if(r&&(i._doPortalSignIn(e,!0)||t&&t.force))o=s.server+"/sharing/rest/oauth2/validateAppAccess",l.client_id=r;else{if(!s.token)return{credential:s};o=s.server+"/sharing/rest"}else{if(!s.token)return{credential:s};o=s.server+"/rest/services"}return s.token&&(l.token=s.token),a(o,{query:l,authMode:"anonymous"}).then((function(e){if(!1===e.data.valid)throw new u("identity-manager:not-authorized","You are currently signed in as: '"+s.userId+"'.");return n=!!e.data.viewOnlyUserTypeApp,{credential:s}})).catch((function(e){if("identity-manager:not-authorized"===e.name)throw e;var r=e.details&&e.details.httpStatus;if(498===r)throw s.destroy(),new u("identity-manager:not-authenticated","User is not signed in.");if(400===r)throw new u("identity-manager:invalid-request");return{credential:s}}))})).then((function(e){return{credential:e.credential,viewOnly:n}}))},r.prototype.setOAuthResponseHash=function(e){var r=this._oAuthDfd;if(this._oAuthDfd=null,r&&e){clearInterval(this._oAuthIntervalId),"#"===e.charAt(0)&&(e=e.substring(1));var t=_.queryToObject(e);if(t.error){var i="access_denied"===t.error,n=new u(i?"identity-manager:user-aborted":"identity-manager:authentication-failed",i?"ABORTED":"OAuth: "+t.error+" - "+t.error_description);r.reject(n)}else{var s=r.sinfo_,o=r.oinfo_._oAuthCred,a=new O({userId:t.username,server:s.server,token:t.access_token,expires:Date.now()+1e3*Number(t.expires_in),ssl:"true"===t.ssl,_oAuthCred:o});o.storage=t.persist?window.localStorage:window.sessionStorage,o.token=a.token,o.expires=a.expires,o.userId=a.userId,o.ssl=a.ssl,o.save(),r.resolve(a)}}},r.prototype.setRedirectionHandler=function(e){this._redirectFunc=e},r.prototype.setOAuthRedirectionHandler=function(e){this._oAuthRedirectFunc=e},r.prototype.setProtocolErrorHandler=function(e){this._protocolFunc=e},r.prototype.signIn=function(e,r,t){var i=this;void 0===t&&(t={});var n=f.createResolver(),s=function(){l&&l.remove(),h&&h.remove(),a&&a.destroy(),i.dialog&&i.dialog.destroy(),i.dialog=null},o=function(){s(),i._oAuthDfd=null,n.reject(new u("identity-manager:user-aborted","ABORTED"))};t.signal&&f.onAbort(t.signal,(function(){o()}));var a=new this.formConstructor;a.resource=this.getResourceName(e),a.server=r.server,this.dialog=new w,this.dialog.content=a,this.dialog.open=!0,this.emit("dialog-create");var l=a.on("cancel",o),h=a.on("submit",(function(e){i.generateToken(r,e,{isAdmin:t.isAdmin,signal:t.signal}).then((function(i){s();var o=new O({userId:e.username,server:r.server,token:i.token,expires:null!=i.expires?Number(i.expires):null,ssl:!!i.ssl,isAdmin:t.isAdmin,validity:i.validity});n.resolve(o)})).catch((function(e){a.error=e,a.signingIn=!1}))}));return n.promise},r.prototype.oAuthSignIn=function(e,r,t,i){var n=this;this._oAuthDfd=f.createResolver();var s=this._oAuthDfd;i&&i.signal&&f.onAbort(i.signal,(function(){var e=n._oAuthDfd&&n._oAuthDfd.oAuthWin_;e&&!e.closed?e.close():n.dialog&&l()})),s.resUrl_=e,s.sinfo_=r,s.oinfo_=t;var o=!i||!1!==i.oAuthPopupConfirmation;if(!t.popup||!o)return this._doOAuthSignIn(e,r,t),s.promise;var a=new this.formConstructor;a.oAuthPrompt=!0,a.server=r.server,this.dialog=new w,this.dialog.content=a,this.dialog.open=!0,this.emit("dialog-create");var l=function(){d(),n._oAuthDfd=null,s.reject(new u("identity-manager:user-aborted","ABORTED"))},h=a.on("cancel",l),c=a.on("submit",(function(){d(),n._doOAuthSignIn(e,r,t)})),d=function(){h.remove(),c.remove(),a.destroy(),n.dialog.destroy(),n.dialog=null};return s.promise},r.prototype.destroyCredentials=function(){this.credentials&&this.credentials.slice().forEach((function(e){e.destroy()}));this.emit("credentials-destroy")},r.prototype._getOAuthHash=function(){var e=window.location.hash;if(e){"#"===e.charAt(0)&&(e=e.substring(1));var r=_.queryToObject(e),t=!1;r.access_token&&r.expires_in&&r.state&&r.hasOwnProperty("username")?(r.state=JSON.parse(r.state),this._oAuthHash=r,t=!0):r.error&&r.error_description&&(console.log("IdentityManager OAuth Error: ",r.error," - ",r.error_description),"access_denied"===r.error&&(t=!0)),t&&(window.location.hash="object"==typeof r.state&&r.state.hash||"")}},r.prototype._pageShowHandler=function(e){if(e.persisted&&this.isBusy()&&this._rejectOnPersistedPageShow){var r=new u("identity-manager:user-aborted","ABORTED");this._errbackFunc(r)}},r.prototype._findCredential=function(e,r){var t,i,n,s,o=this,a=-1,l=r&&r.token,u=r&&r.resource,h=this._isServerRsrc(e)?"server":"portal",c=this.credentials.filter((function(r){return o._hasSameServerInstance(r.server,e)&&r.scope===h}));if(e=u||e,c.length)if(1===c.length){if(t=c[0],s=this.findServerInfo(t.server),i=s&&s.owningSystemUrl,n=i&&this.findCredential(i,t.userId),a=this._getIdenticalSvcIdx(e,t),!l)return-1===a&&t.resources.push(e),this._addResource(e,n),t;-1!==a&&(t.resources.splice(a,1),this._removeResource(e,n))}else{var d,p;if(c.some((function(r){return-1!==(p=o._getIdenticalSvcIdx(e,r))&&(d=r,s=o.findServerInfo(d.server),i=s&&s.owningSystemUrl,n=i&&o.findCredential(i,d.userId),a=p,!0)})),l)d&&(d.resources.splice(a,1),this._removeResource(e,n));else if(d)return this._addResource(e,n),d}},r.prototype._findOAuthInfo=function(e){var r=this.findOAuthInfo(e);if(!r)for(var t=0,i=this.oAuthInfos;t<i.length;t++){var n=i[t];if(this._isIdProvider(n.portalUrl,e)){r=n;break}}return r},r.prototype._addResource=function(e,r){r&&-1===this._getIdenticalSvcIdx(e,r)&&r.resources.push(e)},r.prototype._removeResource=function(e,r){var t=-1;r&&(t=this._getIdenticalSvcIdx(e,r))>-1&&r.resources.splice(t,1)},r.prototype._useProxy=function(e,r){return r&&r.isAdmin&&!_.hasSameOrigin(e.adminTokenServiceUrl,window.location.href)||!this._isPortalDomain(e.tokenServiceUrl)&&"10.1"===String(e.currentVersion)&&!_.hasSameOrigin(e.tokenServiceUrl,window.location.href)},r.prototype._getOrigin=function(e){var r=new g.Url(e);return r.scheme+"://"+r.host+(null!=r.port?":"+r.port:"")},r.prototype._getServerInstanceRoot=function(e){var r=e.toLowerCase(),t=r.indexOf(this._agsRest);return-1===t&&this._isAdminResource(e)&&(t=this._agsAdmin.test(e)?e.replace(this._agsAdmin,"$1").length:e.search(this._adminSvcs)),-1===t&&(t=r.indexOf("/sharing")),-1===t&&"/"===r.substr(-1)&&(t=r.length-1),t>-1?e.substring(0,t):e},r.prototype._hasSameServerInstance=function(e,r){return"/"===e.substr(-1)&&(e=e.slice(0,-1)),e=e.toLowerCase(),r=this._getServerInstanceRoot(r).toLowerCase(),e=this._normalizeAGOLorgDomain(e),r=this._normalizeAGOLorgDomain(r),(e=e.substr(e.indexOf(":")))===(r=r.substr(r.indexOf(":")))},r.prototype._normalizeAGOLorgDomain=function(e){var r=/^https?:\/\/(?:cdn|[a-z\d-]+\.maps)\.arcgis\.com/i,t=/^https?:\/\/(?:cdndev|[a-z\d-]+\.mapsdevext)\.arcgis\.com/i,i=/^https?:\/\/(?:cdnqa|[a-z\d-]+\.mapsqa)\.arcgis\.com/i;return r.test(e)?e=e.replace(r,"https://www.arcgis.com"):t.test(e)?e=e.replace(t,"https://devext.arcgis.com"):i.test(e)&&(e=e.replace(i,"https://qaext.arcgis.com")),e},r.prototype._sanitizeUrl=function(e){var r=(s.request.proxyUrl||"").toLowerCase(),t=r?e.toLowerCase().indexOf(r+"?"):-1;return-1!==t&&(e=e.substring(t+r.length+1)),e=_.normalize(e),_.urlToObject(e).path},r.prototype._isRESTService=function(e){return e.indexOf(this._agsRest)>-1},r.prototype._isAdminResource=function(e){return this._agsAdmin.test(e)||this._adminSvcs.test(e)},r.prototype._isServerRsrc=function(e){return this._isRESTService(e)||this._isAdminResource(e)},r.prototype._isIdenticalService=function(e,r){var t;if(this._isRESTService(e)&&this._isRESTService(r)){var i=this._getSuffix(e).toLowerCase(),n=this._getSuffix(r).toLowerCase();if(!(t=i===n)){var s=/(.*)\/(MapServer|FeatureServer).*/gi;t=i.replace(s,"$1")===n.replace(s,"$1")}}else this._isAdminResource(e)&&this._isAdminResource(r)?t=!0:this._isServerRsrc(e)||this._isServerRsrc(r)||!this._isPortalDomain(e)||(t=!0);return t},r.prototype._isPortalDomain=function(e){var r=this,t=new g.Url(e.toLowerCase()),i=this._portalConfig,n=t.authority&&-1!==t.authority.indexOf(this._agolSuffix);return!n&&i&&(n=this._hasSameServerInstance(this._getServerInstanceRoot(i.restBaseUrl),t.uri)),n||s.portalUrl&&(n=_.hasSameOrigin(e,s.portalUrl,!0)),n||(n=this._portals.some((function(e){return r._hasSameServerInstance(e,t.uri)}))),n=n||this._agsPortal.test(t.path)},r.prototype._isIdProvider=function(e,r){var t=-1,i=-1;this._gwDomains.forEach((function(n,s){-1===t&&n.regex.test(e)&&(t=s),-1===i&&n.regex.test(r)&&(i=s)}));var n=!1;if(t>-1&&i>-1&&(0===t||4===t?0!==i&&4!==i||(n=!0):1===t?1!==i&&2!==i||(n=!0):2===t?2===i&&(n=!0):3===t&&3===i&&(n=!0)),!n){var s=this.findServerInfo(r),o=s&&s.owningSystemUrl;o&&U(s)&&this._isPortalDomain(o)&&this._isIdProvider(e,o)&&(n=!0)}return n},r.prototype._getIdenticalSvcIdx=function(e,r){for(var t=-1,i=0;i<r.resources.length;i++){var n=r.resources[i];if(this._isIdenticalService(e,n)){t=i;break}}return t},r.prototype._getSuffix=function(e){return e.replace(this._regexSDirUrl,"").replace(this._regexServerType,"$1")},r.prototype._getTokenSvcUrl=function(e){var r,t=this;if(this._isRESTService(e)||this._isAdminResource(e)){var i=this._getServerInstanceRoot(e);return{adminUrl:i+"/admin/generateToken",promise:a(e=i+"/rest/info",{query:{f:"json"}}).then((function(e){return e.data}))}}if(this._isPortalDomain(e)){var n="";if(this._gwDomains.some((function(r){return r.regex.test(e)&&(n=r.tokenServiceUrl),!!n})),n||this._portals.some((function(r){return t._hasSameServerInstance(r,e)&&(n=r+t._gwTokenUrl),!!n})),n||-1!==(r=e.toLowerCase().indexOf("/sharing"))&&(n=e.substring(0,r)+this._gwTokenUrl),n||(n=this._getOrigin(e)+this._gwTokenUrl),n){var s=new g.Url(e).port;/^http:\/\//i.test(e)&&"7080"===s&&(n=n.replace(/:7080/i,":7443")),n=n.replace(/http:/i,"https:")}return n}if(-1!==e.toLowerCase().indexOf("premium.arcgisonline.com"))return"https://premium.arcgisonline.com/server/tokens"},r.prototype._getPortalSelf=function(e,r){var t;if(this._gwDomains.some((function(r){return r.regex.test(e)&&(t=r.customBaseUrl),!!t})),t)return f.resolve({allSSL:!0,currentVersion:"4.4",customBaseUrl:t,portalMode:"multitenant",supportsOAuth:!0});"https:"===window.location.protocol?e=e.replace(/^http:/i,"https:").replace(/:7080/i,":7443"):/^http:/i.test(r)&&(e=e.replace(/^https:/i,"http:").replace(/:7443/i,":7080"));return a(e,{query:{f:"json"},authMode:"anonymous",withCredentials:!0}).then((function(e){return e.data}))},r.prototype._hasPortalSession=function(){return!!this._getEsriAuthCookie()},r.prototype._getEsriAuthCookie=function(){var e=null;if(navigator.cookieEnabled){for(var r=this._getAllCookies("esri_auth"),t=void 0,i=0;i<r.length;i++){if((o=JSON.parse(r[i])).portalApp){e=o;break}t?t.push(o):t=[o]}if(!e&&t)for(var n=0,s=t;n<s.length;n++){var o;if((o=s[n]).urlKey&&window.location.hostname===o.urlKey.toLowerCase()+"."+o.customBaseUrl){e=o;break}}}if(e){var a=null;e.expires&&("number"==typeof e.expires?a=e.expires:"string"==typeof e.expires&&(a=Date.parse(e.expires)),isNaN(a)&&(a=null),e.expires=a),a&&a<Date.now()&&(e=null)}return e},r.prototype._getAllCookies=function(e){var r=[],t=document.cookie.match(new RegExp("(?:^|; )"+v.escapeRegExpString(e)+"=([^;]*)","g"));if(t)for(var i=0;i<t.length;i++){var n=t[i],s=n.indexOf("=");s>-1&&(n=n.substring(s+1),r.push(decodeURIComponent(n)))}return r},r.prototype._doPortalSignIn=function(e,r){if(navigator.cookieEnabled){var t=this._getEsriAuthCookie(),i=this._portalConfig,n=window.location.href,s=this.findServerInfo(e);if((r||this.useSignInPage)&&(i||this._isPortalDomain(n)||t)&&(s?s.hasPortal||s.owningSystemUrl&&this._isPortalDomain(s.owningSystemUrl):this._isPortalDomain(e))&&(this._isIdProvider(n,e)||i&&(this._hasSameServerInstance(this._getServerInstanceRoot(i.restBaseUrl),e)||this._isIdProvider(i.restBaseUrl,e))||_.hasSameOrigin(n,e,!0)))return!0}return!1},r.prototype._canUsePortalSignInWorkflow=function(e){return this._doPortalSignIn(e)&&(window===window.top||this._hasPortalSession())},r.prototype._checkProtocol=function(e,r,t,i){var n=!0,s=i?r.adminTokenServiceUrl:r.tokenServiceUrl;0===s.trim().toLowerCase().indexOf("https:")&&0!==window.location.href.toLowerCase().indexOf("https:")&&_.getProxyRule(s)&&((n=!!this._protocolFunc&&!!this._protocolFunc({resourceUrl:e,serverInfo:r}))||t(new u("identity-manager:aborted","Aborted the Sign-In process to avoid sending password over insecure connection.")));return n},r.prototype._enqueue=function(e,r,t,i,n,s){return i||(i=f.createResolver()),i.resUrl_=e,i.sinfo_=r,i.options_=t,i.admin_=n,i.refresh_=s,this._busy?this._hasSameServerInstance(this._getServerInstanceRoot(e),this._busy.resUrl_)?(this._oAuthDfd&&this._oAuthDfd.oAuthWin_&&this._oAuthDfd.oAuthWin_.focus(),this._soReqs.push(i)):this._xoReqs.push(i):this._doSignIn(i),i.promise},r.prototype._doSignIn=function(e){var r=this;this._busy=e,this._rejectOnPersistedPageShow=!1;var t=function(t){var i=e.options_&&e.options_.resource,n=e.resUrl_,s=e.refresh_,o=!1;-1===r.credentials.indexOf(t)&&(s&&-1!==r.credentials.indexOf(s)?(s.userId=t.userId,s.token=t.token,s.expires=t.expires,s.validity=t.validity,s.ssl=t.ssl,s.creationTime=t.creationTime,o=!0,t=s):r.credentials.push(t)),t.resources||(t.resources=[]),t.resources.push(i||n),t.scope=r._isServerRsrc(n)?"server":"portal",t.emitTokenChange();var a=r._soReqs,l={};r._soReqs=[],a.forEach((function(e){if(!r._isIdenticalService(n,e.resUrl_)){var i=r._getSuffix(e.resUrl_);l[i]||(l[i]=!0,t.resources.push(e.resUrl_))}})),e.resolve(t),a.forEach((function(e){r._hasSameServerInstance(r._getServerInstanceRoot(n),e.resUrl_)?e.resolve(t):r._soReqs.push(e)})),r._busy=e.resUrl_=e.sinfo_=e.refresh_=null,o||r.emit("credential-create",{credential:t}),r._soReqs.length?r._doSignIn(r._soReqs.shift()):r._xoReqs.length&&r._doSignIn(r._xoReqs.shift())},i=function(t){e.reject(t),r._busy=e.resUrl_=e.sinfo_=e.refresh_=null,r._soReqs.length?r._doSignIn(r._soReqs.shift()):r._xoReqs.length&&r._doSignIn(r._xoReqs.shift())},n=function(n,s,o,a){var l,h,c=e.sinfo_,d=!e.options_||!1!==e.options_.prompt,p=c.hasPortal&&r._findOAuthInfo(e.resUrl_);if(r._canUsePortalSignInWorkflow(e.resUrl_)){var f=r._getEsriAuthCookie(),v=r._portalConfig;if(f){if(!c.webTierAuth)"web"===(f.auth_tier&&f.auth_tier.toLowerCase())&&(c.webTierAuth=!0);return void t(new O({userId:f.email,server:c.server,token:c.webTierAuth?null:f.token,expires:f.expires}))}if(d){var _="",g=window.location.href;return _=(_=r.signInPage?r.signInPage:v?v.baseUrl+v.signin:r._isIdProvider(g,e.resUrl_)?r._getOrigin(g)+"/home/signin.html":c.tokenServiceUrl.replace(r._rePortalTokenSvc,"")+"/home/signin.html").replace(/http:/i,"https:"),v&&!1===v.useSSL&&(_=_.replace(/https:/i,"http:")),void(0===g.toLowerCase().replace("https","http").indexOf(_.toLowerCase().replace("https","http"))?(h=new u("identity-manager:unexpected-error","Cannot redirect to Sign-In page from within Sign-In page. URL of the resource that triggered this workflow: "+e.resUrl_),i(h)):(r._rejectOnPersistedPageShow=!0,r._redirectFunc?r._redirectFunc({signInPage:_,returnUrlParamName:"returnUrl",returnUrl:g,resourceUrl:e.resUrl_,serverInfo:c}):window.location.href=_+"?returnUrl="+encodeURIComponent(g)))}h=new u("identity-manager:not-authenticated","User is not signed in."),i(h)}else if(n)t(new O({userId:n,server:c.server,token:o,expires:null!=a?Number(a):null,ssl:!!s}));else if(p){var m=p._oAuthCred;if(!m){var S=new y(p,window.localStorage),w=new y(p,window.sessionStorage);S.isValid()&&w.isValid()?S.expires>w.expires?(m=S,w.destroy()):(m=w,S.destroy()):m=S.isValid()?S:w,p._oAuthCred=m}if(m.isValid())t(new O({userId:m.userId,server:c.server,token:m.token,expires:m.expires,ssl:m.ssl,_oAuthCred:m}));else if(r._oAuthHash&&r._oAuthHash.state.portalUrl===p.portalUrl){var I=r._oAuthHash;l=new O({userId:I.username,server:c.server,token:I.access_token,expires:Date.now()+1e3*Number(I.expires_in),ssl:"true"===I.ssl,oAuthState:I.state,_oAuthCred:m}),m.storage=I.persist?window.localStorage:window.sessionStorage,m.token=l.token,m.expires=l.expires,m.userId=l.userId,m.ssl=l.ssl,m.save(),r._oAuthHash=null,t(l)}else d?e._pendingDfd=r.oAuthSignIn(e.resUrl_,c,p,e.options_).then(t,i):(h=new u("identity-manager:not-authenticated","User is not signed in."),i(h))}else if(d){if(r._checkProtocol(e.resUrl_,c,i,e.admin_)){var k=e.options_;e.admin_&&((k=k||{}).isAdmin=!0),e._pendingDfd=r.signIn(e.resUrl_,c,k).then(t,i)}}else h=new u("identity-manager:not-authenticated","User is not signed in."),i(h)},s=function(){var n,s,o,a,l=e.sinfo_,u=l.owningSystemUrl,h=e.options_;if(h&&(n=h.token,s=h.error,o=h.prompt),!(a=r._findCredential(u,{token:n,resource:e.resUrl_})))for(var c=0,d=r.credentials;c<d.length;c++){var p=d[c];if(r._isIdProvider(u,p.server)){a=p;break}}if(a){var f=r.findCredential(e.resUrl_,a.userId);if(f)t(f);else if(x(l,r._legacyFed)){(p=a.toJSON()).server=l.server,p.resources=null,t(new O(p))}else{(e._pendingDfd=r.generateToken(r.findServerInfo(a.server),null,{serverUrl:e.resUrl_,token:a.token,signal:e.options_.signal,ssl:a.ssl})).then((function(r){t(new O({userId:a.userId,server:l.server,token:r.token,expires:null!=r.expires?Number(r.expires):null,ssl:!!r.ssl,isAdmin:e.admin_,validity:r.validity}))}),i)}}else{r._busy=null,n&&(e.options_.token=null),(e._pendingDfd=r.getCredential(u.replace(/\/?$/,"/sharing"),{resource:e.resUrl_,owningTenant:l.owningTenant,signal:e.options_.signal,token:n,error:s,prompt:o})).then((function(){r._enqueue(e.resUrl_,e.sinfo_,e.options_,e,e.admin_)}),(function(e){i(e)}))}};this._errbackFunc=i;var o=e.sinfo_.owningSystemUrl,a=this._isServerRsrc(e.resUrl_),l=e.sinfo_._restInfoPms;l?l.promise.then((function(t){var i=e.sinfo_;if(i._restInfoPms){i.adminTokenServiceUrl=i._restInfoPms.adminUrl,i._restInfoPms=null,i.tokenServiceUrl=p.getDeepValue("authInfo.tokenServicesUrl",t)||p.getDeepValue("authInfo.tokenServiceUrl",t)||p.getDeepValue("tokenServiceUrl",t),i.shortLivedTokenValidity=p.getDeepValue("authInfo.shortLivedTokenValidity",t),i.currentVersion=t.currentVersion,i.owningTenant=t.owningTenant;var o=i.owningSystemUrl=t.owningSystemUrl;o&&r._portals.push(o)}a&&i.owningSystemUrl?s():n()}),(function(){e.sinfo_._restInfoPms=null;var r=new u("identity-manager:server-identification-failed","Unknown resource - could not find token service endpoint.");i(r)})):a&&o?s():e.sinfo_._selfReq?e.sinfo_._selfReq.selfDfd.then((function(t){var i,n,s,o,a={};return t&&(i=t.user&&t.user.username,a.username=i,a.allSSL=t.allSSL,n=t.supportsOAuth,s=t.currentVersion,"multitenant"===t.portalMode&&(o=t.customBaseUrl)),e.sinfo_.webTierAuth=!!i,i&&r.normalizeWebTierAuth?r.generateToken(e.sinfo_,null,{ssl:a.allSSL}).catch((function(){return null})).then((function(e){return a.portalToken=e&&e.token,a.tokenExpiration=e&&e.expires,a})):!i&&n&&parseFloat(s)>=4.4&&!r._canUsePortalSignInWorkflow(e.resUrl_)?r._generateOAuthInfo({portalUrl:e.sinfo_.server,customBaseUrl:o,owningTenant:e.sinfo_._selfReq.owningTenant}).catch((function(){return null})).then((function(){return a})):a})).catch((function(){return null})).then((function(r){e.sinfo_._selfReq=null,r?n(r.username,r.allSSL,r.portalToken,r.tokenExpiration):n()})):n()},r.prototype._generateOAuthInfo=function(e){var r,t,i=this,n=e.portalUrl,s=e.customBaseUrl,o=e.owningTenant,l=!this.defaultOAuthInfo&&this._createDefaultOAuthInfo&&!this._hasTestedIfAppIsOnPortal;if(l){var u=(t=window.location.href).indexOf("?");u>-1&&(t=t.slice(0,u)),u=t.search(/\/(apps|home)\//),t=u>-1?t.slice(0,u):null}return l&&t?(this._hasTestedIfAppIsOnPortal=!0,r=a(t+"/sharing/rest",{query:{f:"json"}}).then((function(){i.defaultOAuthInfo=new I({appId:"arcgisonline",popup:!0,popupCallbackUrl:t+"/home/oauth-callback.html"})}))):r=f.resolve(),r.then((function(){if(i.defaultOAuthInfo)return n=n.replace(/^http:/i,"https:"),a(n+"/sharing/rest/oauth2/validateRedirectUri",{query:{accountId:o,client_id:i.defaultOAuthInfo.appId,redirect_uri:_.makeAbsolute(i.defaultOAuthInfo.popupCallbackUrl),f:"json"}}).then((function(e){if(e.data.valid){var r=i.defaultOAuthInfo.clone();e.data.urlKey&&s?r.portalUrl="https://"+e.data.urlKey.toLowerCase()+"."+s:r.portalUrl=n,i.oAuthInfos.push(r)}}))}))},r.prototype._doOAuthSignIn=function(e,r,t){var i=this,n={portalUrl:t.portalUrl};!t.popup&&t.preserveUrlHash&&window.location.hash&&(n.hash=window.location.hash);var s={client_id:t.appId,response_type:"token",state:JSON.stringify(n),expiration:t.expiration,locale:t.locale,redirect_uri:t.popup?_.makeAbsolute(t.popupCallbackUrl):window.location.href.replace(/#.*$/,"")};t.forceLogin&&(s.force_login=!0);var o=t.portalUrl.replace(/^http:/i,"https:")+"/sharing/oauth2/authorize",a=o+"?"+_.objectToQuery(s);if(t.popup){var l=window.open(a,"esriJSAPIOAuth",t.popupWindowFeatures);if(l)l.focus(),this._oAuthDfd.oAuthWin_=l,this._oAuthIntervalId=setInterval((function(){if(l.closed){clearInterval(i._oAuthIntervalId);var e=i._oAuthDfd;if(e){var r=new u("identity-manager:user-aborted","ABORTED");e.reject(r)}}}),500);else{var h=new u("identity-manager:popup-blocked","ABORTED");this._oAuthDfd.reject(h)}}else this._rejectOnPersistedPageShow=!0,this._oAuthRedirectFunc?this._oAuthRedirectFunc({authorizeParams:s,authorizeUrl:o,resourceUrl:e,serverInfo:r,oAuthInfo:t}):window.location.href=a},r=n([m.subclass("esri.identity.IdentityManagerBase")],r)}(m.declared(h));r.IdentityManagerBase=T;var O=function(e){function r(r){var t=e.call(this,r)||this;return t._oAuthCred=null,t.tokenRefreshBuffer=2,r&&r._oAuthCred&&(t._oAuthCred=r._oAuthCred),t}return i(r,e),r.prototype.initialize=function(){this.resources=this.resources||[],null==this.creationTime&&(this.creationTime=Date.now())},r.prototype.refreshToken=function(){var e,r,t=this,i=o.id.findServerInfo(this.server),n=i&&i.owningSystemUrl,s=!!n&&"server"===this.scope,a=s&&x(i,o.id._legacyFed),l=i.webTierAuth,u=l&&o.id.normalizeWebTierAuth,h=A[this.server],c=h&&h[this.userId],d=this.resources&&this.resources[0],p=s&&o.id.findServerInfo(n),f={username:this.userId,password:c};if((!l||u)&&(s&&!p&&o.id.serverInfos.some((function(e){return o.id._isIdProvider(n,e.server)&&(p=e),!!p})),e=p&&o.id.findCredential(p.server,this.userId),!s||e)){if(!a){if(s)r={serverUrl:d,token:e&&e.token,ssl:e&&e.ssl};else if(u)f=null,r={ssl:this.ssl};else{if(!c){var v=void 0;return d&&(d=o.id._sanitizeUrl(d),this._enqueued=1,(v=o.id._enqueue(d,i,null,null,this.isAdmin,this)).then((function(){t._enqueued=0,t.refreshServerTokens()})).catch((function(){t._enqueued=0}))),v}this.isAdmin&&(r={isAdmin:!0})}return o.id.generateToken(s?p:i,s?null:f,r).then((function(e){t.token=e.token,t.expires=null!=e.expires?Number(e.expires):null,t.creationTime=Date.now(),t.validity=e.validity,t.emitTokenChange(),t.refreshServerTokens()})).catch((function(){}))}e.refreshToken()}},r.prototype.refreshServerTokens=function(){var e=this;"portal"===this.scope&&o.id.credentials.forEach((function(r){var t=o.id.findServerInfo(r.server),i=t&&t.owningSystemUrl;r!==e&&r.userId===e.userId&&i&&"server"===r.scope&&(o.id._hasSameServerInstance(e.server,i)||o.id._isIdProvider(i,e.server))&&(x(t,o.id._legacyFed)?(r.token=e.token,r.expires=e.expires,r.creationTime=e.creationTime,r.validity=e.validity,r.emitTokenChange()):r.refreshToken())}))},r.prototype.emitTokenChange=function(e){clearTimeout(this._refreshTimer);var r=this.server&&o.id.findServerInfo(this.server),t=r&&r.owningSystemUrl,i=t&&o.id.findServerInfo(t);!1===e||t&&"portal"!==this.scope&&(!i||!i.webTierAuth||o.id.normalizeWebTierAuth)||null==this.expires&&null==this.validity||this._startRefreshTimer(),this.emit("token-change")},r.prototype.destroy=function(){this.userId=this.server=this.token=this.expires=this.validity=this.resources=this.creationTime=null,this._oAuthCred&&(this._oAuthCred.destroy(),this._oAuthCred=null);var e=o.id.credentials.indexOf(this);e>-1&&o.id.credentials.splice(e,1),this.emitTokenChange(),this.emit("destroy")},r.prototype.toJSON=function(){var e=d.fixJson({userId:this.userId,server:this.server,token:this.token,expires:this.expires,validity:this.validity,ssl:this.ssl,isAdmin:this.isAdmin,creationTime:this.creationTime,scope:this.scope}),r=this.resources;return r&&r.length>0&&(e.resources=r.slice()),e},r.prototype._startRefreshTimer=function(){clearTimeout(this._refreshTimer);var e=6e4*this.tokenRefreshBuffer,r=(this.validity?this.creationTime+6e4*this.validity:this.expires)-Date.now();r<0&&(r=0),this._refreshTimer=setTimeout(this.refreshToken.bind(this),r>e?r-e:r)},n([m.property()],r.prototype,"creationTime",void 0),n([m.property()],r.prototype,"expires",void 0),n([m.property()],r.prototype,"isAdmin",void 0),n([m.property()],r.prototype,"oAuthState",void 0),n([m.property()],r.prototype,"resources",void 0),n([m.property()],r.prototype,"scope",void 0),n([m.property()],r.prototype,"server",void 0),n([m.property()],r.prototype,"ssl",void 0),n([m.property()],r.prototype,"token",void 0),n([m.property()],r.prototype,"tokenRefreshBuffer",void 0),n([m.property()],r.prototype,"userId",void 0),n([m.property()],r.prototype,"validity",void 0),r=n([m.subclass("esri.identity.Credential")],r)}(m.declared(h.EventedAccessor));r.Credential=O}));