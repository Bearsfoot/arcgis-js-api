// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/generatorHelper","../../core/tsSupport/awaiterHelper","../../Basemap","../../Ground","../../WebScene","../../core/compilerUtils","../../core/accessorSupport/ensureType","../../core/accessorSupport/extensions/serializableProperty/type","../../layers/GroupLayer","../../layers/KMLLayer","../../layers/mixins/OperationalLayer","./utils"],(function(e,t,r,n,a,u,s,p,i,o,y,l,c,f){function d(e,t,a){return n(this,void 0,void 0,(function(){return r(this,(function(r){switch(r.label){case 0:switch(t.typeName){case"array":return[3,1];case"union":return[3,3];case"json":return[3,5];case"native":return[3,7];case"enum":return[3,9]}return[3,11];case 1:return[4,h(e,t,a)];case 2:return r.sent(),[3,12];case 3:return[4,b(e,t,a)];case 4:return r.sent(),[3,12];case 5:return[4,w(e,t,a)];case 6:return r.sent(),[3,12];case 7:return[4,v(e,t,a)];case 8:return r.sent(),[3,12];case 9:return[4,m(e,t,a)];case 10:return r.sent(),[3,12];case 11:p.neverReached(t),r.label=12;case 12:return[2]}}))}))}function v(e,t,a){return n(this,void 0,void 0,(function(){return r(this,(function(r){return a.addProperty({name:e,type:_(t),default:t.default}),[2]}))}))}function m(e,t,a){return n(this,void 0,void 0,(function(){var n;return r(this,(function(r){var u,s;return n=t.values.slice(),t.nullable&&n.push(null),a.currentClass&&a.currentClass.typeValue&&"type"===e?a.addProperty({name:e,type:"string",enum:'"'+a.currentClass.typeValue+'"'}):a.addProperty({name:e,type:_(t),enum:(u=n,s=u.slice(),s.sort(),s).map((function(e){return"string"==typeof e?'"'+e+'"':""+e})).join("|"),default:t.default}),[2]}))}))}function h(e,t,a){return n(this,void 0,void 0,(function(){return r(this,(function(r){switch(r.label){case 0:return[4,d(e+"[]",t.elementType,a)];case 1:return r.sent(),[2]}}))}))}function b(e,t,a){return n(this,void 0,void 0,(function(){var n,u,s,p,i;return r(this,(function(r){switch(r.label){case 0:n=[],u=0,s=t.types,r.label=1;case 1:return u<s.length?"native"!==(p=s[u]).type.typeName&&t.key?[3,2]:(n.push(p.type),[3,4]):[3,5];case 2:return[4,d(e+"<"+function(e,t){if("json"===e.typeName){var r=e.type.__accessorMetadata__,n=r&&r.properties&&r.properties&&r.properties.type,a=n&&A(n),u=a&&a.type,s=u||n&&n.type;if(s&&Array.isArray(s)&&1===s.length&&"string"==typeof s[0])return u?s[0]:C(n,s[0])}return t}(p.type,p.value)+">",p.type,a)];case 3:r.sent(),r.label=4;case 4:return u++,[3,1];case 5:return n.length&&(i=n.map(_),t.nullable&&i.push("null"),i.sort(),a.addProperty({type:i.join("|"),name:e,default:t.default})),[2]}}))}))}function g(e,t){return n(this,void 0,void 0,(function(){return r(this,(function(r){return e.type===s&&"layers"===t?[2,T("web-scene/operational-layers")]:e.type!==a||"baseLayers"!==t&&"baseMapLayers"!==t?e.type===a&&"elevationLayers"===t?[2,T("web-scene/ground")]:e.type===u&&"layers"===t?[2,T("web-scene/ground")]:e.type===y&&"layers"===t?[2,T("web-scene/operational-layers",(function(e){return e!==y}))]:[2,null]:[2,T("web-scene/basemap")]}))}))}function N(e,t,a){return n(this,void 0,void 0,(function(){var n;return r(this,(function(r){switch(r.label){case 0:return[4,g(e,t)];case 1:return(n=r.sent())?[2,n]:[2,k(a)]}}))}))}function w(e,t,a){return n(this,void 0,void 0,(function(){var n,u,s,p,i,o,y,l,c,f,v,m,h,b,g,w;return r(this,(function(r){switch(r.label){case 0:if(n=t.type.__accessorMetadata__,T=t.type,u=T.prototype.declaredClass.replace(/\./g,"/"),!(s=n&&n.properties))return e&&a.addProperty({name:e,type:"unknown"}),[2,null];if(p=u,i=null,(o=e&&e.match(/<([^>]+)>$/))&&(p+="--"+o[1],i=o[1]),(y=a.seen.get(p))&&e)return a.addProperty({name:e,type:y}),[2,y];for(f in l={type:t.type,name:u,id:p,properties:[]},e&&(a.addProperty({name:e,type:l}),l.typeValue=i),a.push(e,l),c=[],s)c.push(f);v=0,r.label=1;case 1:return v<c.length?(m=c[v],h=s[m],(b=L(h))&&b.enabled?"string"!=typeof(g=b.target)&&null!=g?[3,4]:[4,N(t,m,h)]:[3,6]):[3,7];case 2:return(w=r.sent())?[4,d("string"==typeof g?g:m,w,a)]:[3,6];case 3:return r.sent(),[3,6];case 4:return[4,j(t,g,a)];case 5:r.sent(),r.label=6;case 6:return v++,[3,1];case 7:return[2,a.pop()]}var T}))}))}function j(e,t,a){return n(this,void 0,void 0,(function(){var n,u,s,p,i,o;return r(this,(function(r){switch(r.label){case 0:for(u in n=[],t)n.push(u);s=0,r.label=1;case 1:return s<n.length?(p=n[s],[4,g(e,p)]):[3,5];case 2:return(i=r.sent())||(o=t[p],(i=o.types?S(o.types):O(o.type)).default=o.default,i=M(i)),[4,d(p,i,a)];case 3:r.sent(),r.label=4;case 4:return s++,[3,1];case 5:return[2]}}))}))}function T(e,t){return n(this,void 0,void 0,(function(){var n,a,u,s,p,i,o;return r(this,(function(r){switch(r.label){case 0:for(s in n=c.supportedTypes[e],a={typeName:"union",key:"layerType",types:[]},u=[],n)u.push(s);p=0,r.label=1;case 1:return p<u.length?(i=u[p],[4,c.typeModuleMap[i]()]):[3,4];case 2:if(!(o=r.sent()))return[3,3];if(t&&!t(o))return[3,3];if(o===l)return[3,3];a.types.push({type:{typeName:"json",type:o},value:i}),r.label=3;case 3:return p++,[3,1];case 4:return 0===a.types.length?[2,null]:[2,{typeName:"array",elementType:1===a.types.length?a.types[0].type:a}]}}))}))}function _(e){switch(e.typeName){case"array":return _(e.elementType)+"[]";case"union":var t=e.types.map((function(e){return _(e.type)}));return e.nullable&&t.push("null"),t.sort(),""+t.join(" | ");case"native":switch(e.type){case Number:return"number";case i.Integer:return"integer";case String:return"string";case Boolean:return"boolean";case Object:return"object";default:return"unknown"}case"json":return e.type.prototype.declaredClass;case"enum":return"string";default:return void p.neverReached(e)}}function M(e){if("array"===e.typeName)return e.elementType=M(e.elementType),e;var t=function(e){if("json"!==e.typeName)return null;var t=e.type.__accessorMetadata__,r=t&&t.properties&&t.properties.type,n=r&&A(r),a=n&&n.type,u=a||r&&r.type;return u&&Array.isArray(u)&&"string"==typeof u[0]?a||r.type.map((function(e){return C(r,e)})):null}(e);return t?{typeName:"union",key:"type",types:t.map((function(t){return{value:t,type:e}}))}:e}function k(e){var t=A(e);return t.types?S(t.types):!t.type&&e.types?S(e.types):M(function(e){var t=A(e),r=L(e),n=O(t&&t.type||e.type);t&&void 0!==t.default&&"function"!=typeof t.default&&(n.default=C(e,t.default));r.allowNull&&(n.nullable=!0);return n}(e))}function S(e){if(Array.isArray(e))return{typeName:"array",elementType:S(e[0])};var t=[];for(var r in e.typeMap){var n=e.typeMap[r];t.push({type:O(n),value:P(n)?null:r})}return{typeName:"union",key:"string"==typeof e.key?e.key:"type",types:t}}function C(e,t){var r,n=L(e);if(null!=(r=n.writer)&&r.name&&-1!==r.name.indexOf("JSONMapWrite")){var a={value:""};return n.writer(t,a,"value"),a.value}return t}function O(e){return e?i.isLongFormType(e)?function e(t){switch(t.type){case"native":return{typeName:"native",type:t.value};case"array":return{typeName:"array",elementType:O(t.value)};case"one-of":return{typeName:"union",key:null,types:t.values.map((function(t){return{type:e(t),value:null}}))};default:return void p.neverReached(t)}}(e):Array.isArray(e)?"string"==typeof e[0]||"number"==typeof e[0]?{typeName:"enum",values:e}:e.length>1?{typeName:"union",key:null,types:e.map((function(e){return{type:O(e),value:null}}))}:{typeName:"array",elementType:O(e[0])}:o.isCollection(e)?function(e){var t=e.prototype.itemType&&e.prototype.itemType.Type;if(!t)return{typeName:"array",elementType:{typeName:"native",type:null}};if("function"==typeof t)return{typeName:"array",elementType:O(t)};if(t.typeMap){var r=[];for(var n in t.typeMap){var a=t.typeMap[n];r.push({type:O(a),value:P(a)?null:n})}return{typeName:"array",elementType:{typeName:"union",key:"string"==typeof t.key?t.key:"type",types:r}}}}(e):P(e)?{typeName:"native",type:e}:function(e){var t=e._meta&&e._meta.bases;if(!t)return!1;return t.some((function(e){return e&&e.prototype&&("esri.core.JSONSupport"===e.prototype.declaredClass||"esri.core.MultiOriginJSONSupport"===e.prototype.declaredClass)}))}(e)?{typeName:"json",type:e}:{typeName:"native",type:null}:{typeName:"native",type:null}}function P(e){return e===String||e===Boolean||e===Number||e===i.Integer||e===Object}function A(e){if(!e.json)return null;var t=e.json.origins,r=e.json,n=t&&t["web-scene"],a=t&&t["web-document"];return n||a||r||null}function L(e){if(!e.json)return null;var t=e.json.origins,r=e.json.write,n=t&&t["web-scene"]&&t["web-scene"].write,a=t&&t["web-document"]&&t["web-document"].write;return n||a||r||null}Object.defineProperty(t,"__esModule",{value:!0}),t.scan=function(e){return n(this,void 0,void 0,(function(){var t;return r(this,(function(r){return t=new f.ScanContext,[2,w(null,{typeName:"json",type:e},t)]}))}))}}));