// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../core/CircularArray","../core/maybe","./geohashUtils"],(function(t,e,i,o,a){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t){this._pool=new i.default(8024),this._nodes=0,this._root=new s(0,0,0),this._fields=t}return t.prototype._acquire=function(t,e,i){var a=this._pool.dequeue();return this._nodes++,o.isSome(a)?a.realloc(t,e,i):new s(t,e,i)},t.prototype._release=function(t){this._nodes--,this._pool.enqueue(t)},Object.defineProperty(t.prototype,"count",{get:function(){return this._root.count},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"size",{get:function(){return this._nodes},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"poolSize",{get:function(){return this._pool.size},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"depth",{get:function(){var t=0;return this._forEachNode((function(e){return t=Math.max(t,e.depth)})),t},enumerable:!0,configurable:!0}),t.prototype.dropLevels=function(t){var e=this;this._forEachNode((function(i){if(i.depth>=t)for(var o=0;o<i.children.length;o++){var a=i.children[o];i.children[o]=null,a&&e._release(a)}}))},t.prototype.insert=function(t,e,i){void 0===i&&(i=0);for(var o=this._root,a=0,n=0,s=0;null!==o;){if(o.depth>=i&&(o.count+=1,o.xTotal+=t.geometry.coords[0],o.yTotal+=t.geometry.coords[1],o.xGeohashTotal+=t.geohashX,o.yGeohashTotal+=t.geohashY,this._updateStatistics(t,o,1)),a>=e)return;var r=Math.ceil((a+1)/2),h=Math.floor((a+1)/2),l=1-a%2,c=30-(3*r+2*h),u=30-(2*r+3*h),d=7*l+3*(1-l)<<c,f=3*l+7*(1-l)<<u,p=8*l+4*(1-l),v=(t.geohashX&d)>>c,y=(t.geohashY&f)>>u,g=v+y*p;n=n<<3*l+2*(1-l)|v,s=s<<2*l+3*(1-l)|y,null==o.children[g]&&(o.children[g]=this._acquire(n,s,a+1)),a+=1,o=o.children[g]}},t.prototype.remove=function(t,e){for(var i=this._root,o=0;null!==i;){if(i.count-=1,i.xTotal-=t.geometry.coords[0],i.yTotal-=t.geometry.coords[1],i.xGeohashTotal-=t.geohashX,i.yGeohashTotal-=t.geohashY,this._updateStatistics(t,i,-1),o>=e)return;var a=Math.ceil((o+1)/2),n=Math.floor((o+1)/2),s=1-o%2,r=30-(3*a+2*n),h=30-(2*a+3*n),l=7*s+3*(1-s)<<r,c=3*s+7*(1-s)<<h,u=8*s+4*(1-s),d=((t.geohashX&l)>>r)+((t.geohashY&c)>>h)*u,f=i.children[d];1===f.count&&(this._release(f),i.children[d]=null),o+=1,i=f}},t.prototype.find=function(t,e,i){return this._root.find(t,e,i,0,0,0)},t.prototype.findSingleOccupancyNode=function(t,e,i,o,a){for(var n=this._root;null!==n;){var s=n.depth,r=n.xNode,h=n.yNode,l=1-s%2,c=n.xGeohashTotal/n.count,u=n.yGeohashTotal/n.count;if(1===n.count&&t<c&&c<=i&&e<u&&u<=o)return n;if(s>=a)n=n.next;else{for(var d=Math.ceil((s+1)/2),f=Math.floor((s+1)/2),p=30-(3*d+2*f),v=30-(2*d+3*f),y=~((1<<p)-1),g=~((1<<v)-1),x=(t&y)>>p,_=(e&g)>>v,m=(i&y)>>p,T=(o&g)>>v,N=r<<3*l+2*(1-l),b=h<<2*l+3*(1-l),S=N+8*l+4*(1-l),M=b+4*l+8*(1-l),G=Math.max(N,x),k=Math.max(b,_),z=Math.min(S,m),C=Math.min(M,T),F=null,w=null,P=k;P<=C;P++)for(var O=G;O<=z;O++){var X=O-N+(P-b)*(8*l+4*(1-l)),Y=n.children[X];Y&&(F||((F=Y).next=n.next),w&&(w.next=Y),w=Y,Y.next=n.next)}n=F||n.next}}return null},t.prototype.getRegionStatistics=function(t,e,i,o,a){for(var n=this._root,s=0,r=0,h=0,l={};null!==n;){var c=n.depth,u=n.xNode,d=n.yNode;if(c>=a){var f=n.xGeohashTotal/n.count,p=n.yGeohashTotal/n.count;t<f&&f<=i&&e<p&&p<=o&&(s+=n.count,r+=n.xTotal,h+=n.yTotal,this._aggregateStatistics(l,n.statistics)),n=n.next}else{for(var v=Math.ceil((c+1)/2),y=Math.floor((c+1)/2),g=1-c%2,x=30-(3*v+2*y),_=30-(2*v+3*y),m=~((1<<x)-1),T=~((1<<_)-1),N=(t&m)>>x,b=(e&T)>>_,S=(i&m)>>x,M=(o&T)>>_,G=u<<3*g+2*(1-g),k=d<<2*g+3*(1-g),z=G+8*g+4*(1-g),C=k+4*g+8*(1-g),F=Math.max(G,N),w=Math.max(k,b),P=Math.min(z,S),O=Math.min(C,M),X=null,Y=null,j=w;j<=O;j++)for(var q=F;q<=P;q++){var E=q-G+(j-k)*(8*g+4*(1-g)),L=n.children[E];if(L){if(j!==w&&j!==O&&q!==F&&q!==P){f=L.xGeohashTotal/L.count,p=L.yGeohashTotal/L.count;t<f&&f<=i&&e<p&&p<=o&&(s+=L.count,r+=L.xTotal,h+=L.yTotal,this._aggregateStatistics(l,L.statistics));continue}X||((X=L).next=n.next),Y&&(Y.next=L),Y=L,L.next=n.next}}n=X||n.next}}return{count:s,attributes:this._normalizeStatistics(l,s),xTotal:r,yTotal:h}},t.prototype._forEachNode=function(t){for(var e=this._root;null!==e;){var i=this._linkChildren(e)||e.next;t(e),e=i}},t.prototype._linkChildren=function(t){for(var e=null,i=null,o=0;o<=t.children.length;o++){var a=t.children[o];a&&(e||((e=a).next=t.next),i&&(i.next=a),i=a,a.next=t.next)}return e},t.prototype._updateStatistics=function(t,e,i){for(var o=0,a=this._fields;o<a.length;o++){var n=a[o],s=n.name,r=n.outStatistic.onStatisticField,h=t.attributes[r];switch(n.outStatistic.statisticType){case"norm":e.statistics[s]||(e.statistics[s]={});var l=n.outStatistic.onStatisticNormalizationField,c=t.attributes[l],u=e.statistics[s].onStatisticField||0,d=e.statistics[s].onStatisticNormalizationField||0;null==h||isNaN(h)||null==c||0===c||isNaN(c)||(e.statistics[s].onStatisticField=u+i*h,e.statistics[s].onStatisticNormalizationField=d+i*c);break;case"avg":e.statistics[s]||(e.statistics[s]={value:0,nanCount:0});var f=e.statistics[s].value,p=e.statistics[s].nanCount;null==h||isNaN(h)?e.statistics[s].nanCount=p+i:e.statistics[s].value=f+i*h;break;case"avg_angle":e.statistics[s]||(e.statistics[s]={x:0,y:0,nanCount:0});var v=e.statistics[s].x,y=e.statistics[s].y,g=(p=e.statistics[s].nanCount,Math.PI/180);null==h||isNaN(h)?e.statistics[s].nanCount=p+i:(e.statistics[s].x=v+i*Math.cos(h*g),e.statistics[s].y=y+i*Math.sin(h*g));break;case"mode":e.statistics[s]||(e.statistics[s]={});f=e.statistics[s][h]||0;e.statistics[s][h]=f+i}}},t.prototype._aggregateStatistics=function(t,e){for(var i=0,o=this._fields;i<o.length;i++){var a=o[i],n=a.name;switch(a.outStatistic.statisticType){case"avg":case"avg_angle":case"mode":case"norm":for(var s in t[n]||(t[n]={}),e[n]){var r=t[n][s]||0;t[n][s]=r+e[n][s]}}}},t.prototype._normalizeStatistics=function(t,e){for(var i={},o=0,a=this._fields;o<a.length;o++){var n=a[o],s=n.name;switch(n.outStatistic.statisticType){case"norm":var r=t[s];if(e&&null==r.onStatisticNormalizationField)break;if(e&&r.onStatisticNormalizationField){i[s]=r.onStatisticField/r.onStatisticNormalizationField;break}i[s]=0;break;case"avg":if(!e)break;var h=t[s],l=h.value;if(!(e-(c=h.nanCount)))break;i[s]=l/(e-c);break;case"avg_angle":if(!e)break;var c,u=t[s],d=u.x,f=u.y;if(!(e-(c=u.nanCount)))break;var p=d/(e-c),v=f/(e-c),y=180/Math.PI,g=Math.atan2(v,p)*y;i[s]=g;break;case"mode":var x=t[s],_=0,m=null;for(var T in x){var N=x[T];N>_&&(_=N,m=T)}i[s]="null"===m?null:m}}return i},t}();e.GeohashTree=n;var s=function(){function t(t,e,i){this.count=0,this.xTotal=0,this.yTotal=0,this.statistics={},this.next=null,this.depth=0,this.xNode=0,this.yNode=0,this.xGeohashTotal=0,this.yGeohashTotal=0,this.children=new Array(32);for(var o=0;o<this.children.length;o++)this.children[o]=null;this.xNode=t,this.yNode=e,this.depth=i}return t.prototype.realloc=function(t,e,i){for(var o=0;o<this.children.length;o++)this.children[o]=null;return this.xNode=t,this.yNode=e,this.depth=i,this.next=null,this.xGeohashTotal=0,this.yGeohashTotal=0,this.xTotal=0,this.yTotal=0,this.count=0,this.statistics={},this},t.prototype.getLngLatBounds=function(){var t=this.depth,e=Math.ceil(t/2),i=Math.floor(t/2),o=30-(3*e+2*i),n=30-(2*e+3*i),s=this.xNode<<o,r=this.yNode<<n;return a.decodeGeohashXY({geohashX:s,geohashY:r},this.depth)},t.prototype.find=function(t,e,i,o,a,n){if(o>=i)return this;var s=1-o%2,r=3*s+2*(1-s),h=2*s+3*(1-s),l=30-a-r,c=30-n-h,u=((t&7*s+3*(1-s)<<l)>>l)+((e&3*s+7*(1-s)<<c)>>c)*(8*s+4*(1-s)),d=this.children[u];return null==d?null:d.find(t,e,i,o+1,a+r,n+h)},t}()}));