// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/extendsHelper","../core/tsSupport/assignHelper","../request","./featureSetCollection","./featureset/sources/FeatureLayerDynamic","./featureset/sources/FeatureLayerMemory","./featureset/sources/FeatureLayerRelated","./featureset/support/cache","./featureset/support/shared","../core/promiseUtils","../layers/FeatureLayer","../portal/Portal","../portal/PortalItem","./featureset/actions/OrderBy","./featureset/actions/Top","./featureset/actions/SpatialFilter","./featureset/actions/AttributeFilter","./featureset/actions/GroupBy"],(function(e,t,r,a,n,i,l,o,u,s,c,d,f,h,p){function y(e,t){if(s.applicationCache){var r=s.applicationCache.getLayerInfo(e);if(r)return r.then((function(r){return d.resolve(new f({url:e,outFields:t,sourceJSON:r}))}));var a=new f({url:e,outFields:t}),n=d.create((function(e,t){a.load().then((function(){e(a.sourceJSON)}),(function(e){t(e)}))}));return s.applicationCache&&(s.applicationCache.setLayerInfo(e,n),n=n.catch((function(t){throw s.applicationCache.clearLayerInfo(e),t}))),n.then((function(){return d.resolve(a)}))}return d.resolve(new f({url:e,outFields:t}))}function m(e,t,r,a,n){return y(e,["*"]).then((function(e){return d.resolve(v(e,t,r,a,n))}))}function v(e,t,r,a,n){return void 0===t&&(t=null),void 0===r&&(r=null),void 0===a&&(a=!0),void 0===n&&(n=null),!0===e._hasMemorySource()?new o({layer:e,spatialReference:t,outFields:r,includeGeometry:a,lrucache:n}):new l({layer:e,spatialReference:t,outFields:r,includeGeometry:a,lrucache:n})}function L(e){if(null!==s.applicationCache){var t=s.applicationCache.getLayerInfo(e);if(null!==t)return t}var r=n(e,{responseType:"json",query:{f:"json"}}).then((function(e){if(e.data){var t=e.data;return t.layers||(t.layers=[]),t.tables||(t.tables=[]),d.resolve(t)}return d.resolve({layers:[],tables:[]})}));return null!==s.applicationCache&&(s.applicationCache.setLayerInfo(e,r),r=r.catch((function(t){throw s.applicationCache.clearLayerInfo(e),t}))),r}Object.defineProperty(t,"__esModule",{value:!0}),t.initialiseMetaDataCache=function(){null===s.applicationCache&&(s.applicationCache=new s)},t.constructFeatureSetFromUrl=m,t.constructFeatureSet=v,t.constructAssociationMetaDataFeatureSetFromUrl=function(e,t){var r={metadata:null,networkId:-1,terminals:[],queryelem:null,layerNameLkp:{},lkp:null};return L(e).then((function(a){if(r.metadata=a,a.controllerDatasetLayers&&void 0!==a.controllerDatasetLayers.utilityNetworkLayerId&&null!==a.controllerDatasetLayers.utilityNetworkLayerId){if(a.layers)for(var i=0,l=a.layers;i<l.length;i++){var o=l[i];r.layerNameLkp[o.id]=o.name}if(a.tables)for(var u=0,c=a.tables;u<c.length;u++){o=c[u];r.layerNameLkp[o.id]=o.name}var f=a.controllerDatasetLayers.utilityNetworkLayerId;return r.networkId=f,function(e,t){var r="QUERYDATAELEMTS:"+t.toString()+":"+e;if(null!==s.applicationCache){var a=s.applicationCache.getLayerInfo(r);if(null!==a)return a}var i=n(e+"/queryDataElements",{method:"post",responseType:"json",query:{layers:JSON.stringify([t.toString()]),f:"json"}}).then((function(e){if(e.data){var t=e.data;if(t.layerDataElements&&t.layerDataElements[0])return t.layerDataElements[0]}throw new Error("Not Found")}));return null!==s.applicationCache&&(s.applicationCache.setLayerInfo(r,i),i=i.catch((function(e){throw s.applicationCache.clearLayerInfo(r),e}))),i}(e,f).then((function(a){if(a){r.queryelem=a,r.lkp={},r.queryelem.dataElement.domainNetworks||(r.queryelem.dataElement.domainNetworks=[]);for(var i=0,l=r.queryelem.dataElement.domainNetworks;i<l.length;i++){for(var o=l[i],u=0,c=o.edgeSources?o.edgeSources:[];u<c.length;u++){(v={layerId:(y=c[u]).layerId,sourceId:y.sourceId,className:r.layerNameLkp[y.layerId]?r.layerNameLkp[y.layerId]:null}).className&&(r.lkp[v.className]=v)}for(var h=0,p=o.junctionSources?o.junctionSources:[];h<p.length;h++){var y,v;(v={layerId:(y=p[h]).layerId,sourceId:y.sourceId,className:r.layerNameLkp[y.layerId]?r.layerNameLkp[y.layerId]:null}).className&&(r.lkp[v.className]=v)}}if(r.queryelem.dataElement.terminalConfigurations)for(var L=0,I=r.queryelem.dataElement.terminalConfigurations;L<I.length;L++)for(var S=0,_=I[L].terminals;S<_.length;S++){var F=_[S];r.terminals.push({terminalId:F.terminalId,terminalName:F.terminalName})}return function(e){if(null!==s.applicationCache){var t=s.applicationCache.getLayerInfo(e);if(null!==t)return t}var r=n(e,{responseType:"json",query:{f:"json"}}).then((function(e){if(e.data){var t=e.data;return d.resolve(t)}return d.resolve(null)}));return null!==s.applicationCache&&(s.applicationCache.setLayerInfo(e,r),r=r.catch((function(t){throw s.applicationCache.clearLayerInfo(e),t}))),r}(e+"/"+f).then((function(a){return a.systemLayers&&void 0!==a.systemLayers.associationsTableId&&null!==a.systemLayers.associationsTableId?m(e+"/"+a.systemLayers.associationsTableId.toString(),t,["OBJECTID","FROMNETWORKSOURCEID","TONETWORKSOURCEID","FROMGLOBALID","TOGLOBALID","TOTERMINALID","FROMTERMINALID","ASSOCIATIONTYPE","ISCONTENTVISIBLE","GLOBALID"],!1,null).then((function(e){return e.load()})).then((function(e){return{lkp:r.lkp,associations:e,terminals:r.terminals}})):{associations:null,lkp:null,terminals:[]}}))}return{associations:null,lkp:null,terminals:[]}}))}return{associations:null,lkp:null,terminals:[]}}))},t.constructFeatureSetFromRelationship=function(e,t,r,a,n,i,l){void 0===a&&(a=null),void 0===n&&(n=null),void 0===i&&(i=!0),void 0===l&&(l=null);var o=e.serviceUrl();return o?m(o="/"===o.charAt(o.length-1)?o+t.relatedTableId.toString():o+"/"+t.relatedTableId.toString(),a,n,i,l).then((function(o){return new u({layer:e,relatedLayer:o,relationship:t,objectId:r,spatialReference:a,outFields:n,includeGeometry:i,lrucache:l})})):null};var I=function(e){function t(t,r,a){void 0===r&&(r=null),void 0===a&&(a=null);var n=e.call(this)||this;return n._map=t,n._overridespref=r,n.lrucache=a,n._instantLayers=[],n}return r(t,e),t.prototype.makeAndAddFeatureSet=function(e,t,r){void 0===t&&(t=!0),void 0===r&&(r=null);var a=v(e,this._overridespref,null===r?["*"]:r,t,this.lrucache);return this._instantLayers.push({featureset:a,opitem:e,includeGeometry:t,outFields:JSON.stringify(r)}),a},t.prototype.featureSetByName=function(e,t,r){var n=this;if(void 0===t&&(t=!0),void 0===r&&(r=null),void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return this._map.load().then((function(){try{return n.featureSetByName(e,t,r)}catch(e){return d.reject(e)}}));null===r&&(r=["*"]),r=(r=r.slice(0)).sort();for(var i=JSON.stringify(r),l=0;l<this._instantLayers.length;l++){var o=this._instantLayers[l];if(o.opitem.title===e&&o.includeGeometry===t&&o.outFields===i)return this.resolvePromise(this._instantLayers[l].featureset)}var u=this._map.layers.find((function(t){return t instanceof f&&t.title===e}));if(u)return this.resolvePromise(this.makeAndAddFeatureSet(u,t,r));if(this._map.tables){var s=this._map.tables.find((function(t){return!!(t.title&&t.title===e||t.title&&t.title===e)}));if(s){if(s._materializedTable);else{var c=s.outFields?s:a({},s,{outFields:["*"]});s._materializedTable=new f(c)}return s._materializedTable.load().then((function(){return n.resolvePromise(n.makeAndAddFeatureSet(s._materializedTable,t,r))}))}}return this.resolvePromise(null)},t.prototype.featureSetById=function(e,t,r){var n=this;if(void 0===t&&(t=!0),void 0===r&&(r=["*"]),void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return this._map.load().then((function(){try{return n.featureSetById(e,t,r)}catch(e){return d.reject(e)}}));null===r&&(r=["*"]),r=(r=r.slice(0)).sort();for(var i=JSON.stringify(r),l=0;l<this._instantLayers.length;l++){var o=this._instantLayers[l];if(o.opitem.id===e&&o.includeGeometry===t&&o.outFields===i)return this.resolvePromise(this._instantLayers[l].featureset)}var u=this._map.layers.find((function(t){return t instanceof f&&t.id===e}));if(u)return this.resolvePromise(this.makeAndAddFeatureSet(u,t,r));if(this._map.tables){var s=this._map.tables.find((function(t){return t.id===e}));if(s){if(s._materializedTable);else{var c=a({},s,{outFields:["*"]});s._materializedTable=new f(c)}return s._materializedTable.load().then((function(){return n.resolvePromise(n.makeAndAddFeatureSet(s._materializedTable,t,r))}))}}return this.resolvePromise(null)},t}(i),S=function(e){function t(t,r,a){void 0===r&&(r=null),void 0===a&&(a=null);var n=e.call(this)||this;return n._url=t,n._overridespref=r,n.lrucache=a,n.metadata=null,n._instantLayers=[],n}return r(t,e),Object.defineProperty(t.prototype,"url",{get:function(){return this._url},enumerable:!0,configurable:!0}),t.prototype.makeAndAddFeatureSet=function(e,t,r){void 0===t&&(t=!0),void 0===r&&(r=null);var a=v(e,this._overridespref,null===r?["*"]:r,t,this.lrucache);return this._instantLayers.push({featureset:a,opitem:e,includeGeometry:t,outFields:JSON.stringify(r)}),a},t.prototype._loadMetaData=function(){var e=this;return L(this._url).then((function(t){return e.metadata=t,t}))},t.prototype.load=function(){return this._loadMetaData()},t.prototype.clone=function(){return new t(this._url,this._overridespref,this.lrucache)},t.prototype.featureSetByName=function(e,t,r){var a=this;void 0===t&&(t=!0),void 0===r&&(r=null),null===r&&(r=["*"]),r=(r=r.slice(0)).sort();for(var n=JSON.stringify(r),i=0;i<this._instantLayers.length;i++){var l=this._instantLayers[i];if(l.opitem.title===e&&l.includeGeometry===t&&l.outFields===n)return this.resolvePromise(this._instantLayers[i].featureset)}return this._loadMetaData().then((function(n){for(var i=null,l=0,o=n.layers?n.layers:[];l<o.length;l++){(c=o[l]).name===e&&(i=c)}if(!i)for(var u=0,s=n.tables?n.tables:[];u<s.length;u++){var c;(c=s[u]).name===e&&(i=c)}return i?y(a._url+"/"+i.id,["*"]).then((function(e){return a.makeAndAddFeatureSet(e,t,r)})):a.resolvePromise(null)}))},t.prototype.featureSetById=function(e,t,r){var a=this;void 0===t&&(t=!0),void 0===r&&(r=["*"]),null===r&&(r=["*"]),r=(r=r.slice(0)).sort();var n=JSON.stringify(r);e=null!=e?e.toString():"";for(var i=0;i<this._instantLayers.length;i++){var l=this._instantLayers[i];if(l.opitem.id===e&&l.includeGeometry===t&&l.outFields===n)return this.resolvePromise(this._instantLayers[i].featureset)}return this._loadMetaData().then((function(n){for(var i=null,l=0,o=n.layers?n.layers:[];l<o.length;l++){null!==(c=o[l]).id&&void 0!==c.id&&c.id.toString()===e&&(i=c)}if(!i)for(var u=0,s=n.tables?n.tables:[];u<s.length;u++){var c;null!==(c=s[u]).id&&void 0!==c.id&&c.id.toString()===e&&(i=c)}return i?y(a._url+"/"+i.id,["*"]).then((function(e){return a.makeAndAddFeatureSet(e,t,r)})):a.resolvePromise(null)}))},t}(i);t.createFeatureSetCollectionFromMap=function(e,t,r){return void 0===r&&(r=null),new I(e,t,r)},t.createFeatureSetCollectionFromService=function(e,t,r){return void 0===r&&(r=null),new S(e,t,r)},t.getPortal=function(e,t){return null===e?t:new h({url:e.field("url")})},t.constructFeatureSetFromPortalItem=function(e,t,r,a,n,i,l){if(s.applicationCache){var o=s.applicationCache.getLayerInfo(e+":"+i.url);if(o)return o.then((function(e){try{var i=new f({url:c.extractServiceUrl(e.url)+"/"+t,outFields:["*"]});return d.resolve(v(i,r,a,n,l))}catch(e){return d.reject(e)}}),(function(e){return d.reject(e)}))}return d.create((function(o,u){var d=new p({id:e,portal:i}).load();s.applicationCache&&s.applicationCache.setLayerInfo(e+":"+i.url,d),d.then((function(e){try{var i=new f({url:c.extractServiceUrl(e.url)+"/"+t,outFields:["*"]});o(v(i,r,a,n,l))}catch(e){u(e)}}),(function(t){s.applicationCache&&s.applicationCache.clearLayerInfo(e+":"+i.url),u(t)}))}))}}));