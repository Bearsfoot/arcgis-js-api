// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/decorateHelper","../../../core/tsSupport/assignHelper","../../../geometry","../../../core/compilerUtils","../../../core/Evented","../../../core/maybe","../../../core/screenUtils","../../../core/accessorSupport/utils","../../../core/libs/gl-matrix-2/mat3","../../../core/libs/gl-matrix-2/mat3f64","../../../core/libs/gl-matrix-2/mat4","../../../core/libs/gl-matrix-2/mat4f64","../../../core/libs/gl-matrix-2/vec2","../../../core/libs/gl-matrix-2/vec3","../../../core/libs/gl-matrix-2/vec3f64","../../../geometry/support/aaBoundingRect","../../../layers/graphics/dehydratedFeatures","../../3d/support/ElevationProvider","../../3d/support/geometryUtils","../../3d/support/projectionUtils","../../3d/support/stack","../../3d/webgl-engine/lib/Camera","../../3d/webgl-engine/lib/Layer","../../3d/webgl-engine/lib/Object3D"],(function(e,t,i,n,r,o,a,s,c,l,h,d,u,f,_,p,g,v,m,y,b,j,S,L,O,w){Object.defineProperty(t,"__esModule",{value:!0});var R=function(){function e(e){for(var t in this.camera=new L.default,this._elevation={offset:0,override:0},this.collisionType={type:"point"},this.collisionPriority=0,this._renderObjects=[],this.autoScaleRenderObjects=!0,this._available=!0,this._noDisplayCount=0,this._radius=10,this._worldSized=!1,this.focusMultiplier=2,this.touchMultiplier=2.5,this.worldOriented=!1,this._modelTransform=f.mat4f64.create(),this._worldFrame=null,this._renderLocation=g.vec3f64.create(),this._renderLocationDirty=!0,this._elevationAlignedLocation=new r.Point,this._elevationAlignedLocationDirty=!0,this.interactive=!0,this.selectable=!1,this.cursor=null,this._grabbing=!1,this.dragging=!1,this._hovering=!1,this._selected=!1,this._state=0,this._focused=!1,this.events=new a({target:this}),this._screenLocation={screenPointArray:c.createScreenPointArray(),renderScreenPointArray:c.createRenderScreenPointArray3(),pixelSize:0},this._screenLocationDirty=!0,this._applyObjectTransform=null,this._engineResourcesAddedToStage=!1,this._engineResources=null,this._attached=!1,this._engineLayerId=null,this._materialIdReferences=null,this._location=new r.Point({x:0,y:0,z:0,spatialReference:e.view.spatialReference}),e)this[t]=e[t];this.view.state&&this.view.state.camera&&this.camera.copyFrom(this.view.state.camera)}return e.prototype.destroy=function(){this._removeResourcesFromStage(),this._engineResources=null,this.view=null,this.camera=null},Object.defineProperty(e.prototype,"elevationInfo",{get:function(){return this._elevationInfo},set:function(e){this._elevationInfo=e,this._elevationAlignedLocationDirty=!0,this._updateEngineObject()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"renderObjects",{get:function(){return this._renderObjects},set:function(e){this._removeResourcesFromStage(),this._engineResources=null,this._renderObjects=e.slice(),this._updateEngineObject()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"available",{get:function(){return this._available},set:function(e){e!==this._available&&(this._available=e,this._updateEngineObject())},enumerable:!0,configurable:!0}),e.prototype.disableDisplay=function(){var e=this;return this._noDisplayCount++,1===this._noDisplayCount&&this._updateEngineObject(),{remove:l.once((function(){e._noDisplayCount--,0===e._noDisplayCount&&e._updateEngineObject()}))}},Object.defineProperty(e.prototype,"radius",{get:function(){return this._radius},set:function(e){e!==this._radius&&(this._radius=e,this._updateEngineObject())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"worldSized",{get:function(){return this._worldSized},set:function(e){e!==this._worldSized&&(this._worldSized=e,this._updateEngineObject())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"modelTransform",{get:function(){return this._modelTransform},set:function(e){P(e)&&(this._screenLocationDirty=!0),u.mat4.copy(this._modelTransform,e),this._updateEngineObject()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"renderLocation",{get:function(){return this._renderLocationDirty&&(this._renderLocationDirty=!1,this.view.renderCoordsHelper.toRenderCoords(this.elevationAlignedLocation,this._renderLocation),this.worldOriented?(this._worldFrame||(this._worldFrame=f.mat4f64.create()),j.computeLinearTransformation(this.view.renderSpatialReference,this._renderLocation,this._worldFrame,this.view.renderSpatialReference),this._worldFrame[12]=0,this._worldFrame[13]=0,this._worldFrame[14]=0):this._worldFrame&&(this._worldFrame=null)),this._renderLocation},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"location",{get:function(){return this._location},set:function(e){m.clonePoint(e,this._location),this._renderLocationDirty=!0,this._screenLocationDirty=!0,this._elevationAlignedLocationDirty=!0,this._updateEngineObject(),this.events.emit("location-update",{location:this._location})},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"elevationAlignedLocation",{get:function(){return this._elevationAlignedLocationDirty?(this._evaluateElevationAlignment(),this._updateElevationAlignedLocation(),this._elevationAlignedLocation):this._elevationAlignedLocation},set:function(e){m.clonePoint(e,this._location),this._evaluateElevationAlignment(),this._location.z-=this._elevation.offset,this._updateElevationAlignedLocation(),this._updateEngineObject(),this.events.emit("location-update",{location:this._location})},enumerable:!0,configurable:!0}),e.prototype._updateElevationAlignedLocation=function(){this._elevationAlignedLocation.x=this.location.x,this._elevationAlignedLocation.y=this.location.y;var e=s.isSome(this._elevation.override)?this._elevation.override:this.location.z||0;this._elevationAlignedLocation.z=e+this._elevation.offset,this._elevationAlignedLocation.spatialReference=this.location.spatialReference,this._renderLocationDirty=!0,this._screenLocationDirty=!0,this._elevationAlignedLocationDirty=!1},Object.defineProperty(e.prototype,"grabbing",{get:function(){return this._grabbing},set:function(e){e!==this._grabbing&&(this._grabbing=e,this._setFocused(this._hovering||this._grabbing),this._updateEngineObject())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"hovering",{get:function(){return this._hovering},set:function(e){e!==this._hovering&&(this._hovering=e,this._setFocused(this._hovering||this._grabbing),this._updateEngineObject())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"selected",{get:function(){return this._selected},set:function(e){e!==this._selected&&(this._selected=e,this._updateEngineObject(),this.events.emit("select-changed",{action:e?"select":"deselect"}))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"state",{get:function(){return this._state},set:function(e){e!==this._state&&(this._state=e,this._updateEngineObject())},enumerable:!0,configurable:!0}),e.prototype.updateStateEnabled=function(e,t){t?this.state|=e:this.state&=~e},e.prototype._setFocused=function(e){e!==this._focused&&(this._focused=e,this.events.emit("focus-changed",{action:!0===e?"focus":"unfocus"}))},Object.defineProperty(e.prototype,"focused",{get:function(){return this._focused},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"screenLocation",{get:function(){return this.ensureScreenLocation(),this._screenLocation},enumerable:!0,configurable:!0}),e.prototype.ensureScreenLocation=function(){if(this._screenLocationDirty){var e;if(this._screenLocation.pixelSize=this.camera.computeScreenPixelSizeAt(this.renderLocation),this._screenLocationDirty=!1,P(this._modelTransform)){var t=this._calculateModelTransformOffset(W);e=p.vec3.add(t,t,this.renderLocation)}else e=this.renderLocation;this.camera.projectPoint(e,this._screenLocation.renderScreenPointArray),this.camera.renderToScreen(this._screenLocation.renderScreenPointArray,this._screenLocation.screenPointArray)}},Object.defineProperty(e.prototype,"applyObjectTransform",{get:function(){return this._applyObjectTransform},set:function(e){this._applyObjectTransform=e,this._screenLocationDirty=!0,this._updateEngineObject()},enumerable:!0,configurable:!0}),e.prototype.intersectionDistance=function(e,t){if(!this.available)return null;var i=c.screenPointObjectToArray(e,T),n=this._getCollisionRadius(t),r=-1*this.collisionPriority;switch(this.collisionType.type){case"point":if(_.vec2.squaredDistance(this.screenLocation.screenPointArray,i)<n*n)return this.screenLocation.renderScreenPointArray[2]+r;break;case"line":for(var a=this.collisionType.paths,s=this._getWorldToScreenObjectScale(),l=this._calculateObjectTransform(s,I),d=n*this.screenLocation.pixelSize,u=b.ray.fromScreen(this.camera,i,E),f=0,g=a;f<g.length;f++){if(0!==(U=g[f]).length)for(var v=p.vec3.transformMat4(x,U[0],l),m=1;m<U.length;m++){var y=p.vec3.transformMat4(z,U[m],l);if(null!=(q=b.lineSegment.closestRayDistance2(b.lineSegment.fromPoints(v,y,A),u))&&q<d*d){var j=p.vec3.add(S.sv3d.get(),v,y);p.vec3.scale(j,j,.5);var L=c.castRenderScreenPointArray(S.sv3d.get());return this.camera.projectPoint(j,L),L[2]+r}p.vec3.copy(v,y)}}break;case"disc":var O=this.collisionType.direction,w=(s=this._getWorldToScreenObjectScale(),l=this._calculateObjectTransform(s,I),d=n*this.screenLocation.pixelSize,u=b.ray.fromScreen(this.camera,i,E),h.mat3.fromMat4(D,l)),R=p.vec3.transformMat3(k,O,w),P=this._calculateModelTransformPosition(N);b.plane.fromPositionAndNormal(P,R,M);var F=C;if(b.plane.intersectRay(M,u,F)&&p.vec3.squaredDistance(F,P)<d*d)return this.screenLocation.renderScreenPointArray[2]+r;break;case"ribbon":var W=this.collisionType;a=W.paths,O=W.direction,s=this._getWorldToScreenObjectScale(),l=this._calculateObjectTransform(s,I),d=n*this.camera.computeScreenPixelSizeAt(this.renderLocation),u=b.ray.fromScreen(this.camera,i,E),w=h.mat3.fromMat4(D,l),R=p.vec3.transformMat3(k,O,w),P=this._calculateModelTransformPosition(N);b.plane.fromPositionAndNormal(P,R,M);F=C;if(!b.plane.intersectRay(M,u,F))break;for(var B=0,H=a;B<H.length;B++){var U;if(0!==(U=H[B]).length)for(v=p.vec3.transformMat4(x,U[0],l),m=1;m<U.length;m++){var q;y=p.vec3.transformMat4(z,U[m],l);if(null!=(q=b.lineSegment.distance2(b.lineSegment.fromPoints(v,y,A),F))&&q<d*d){j=p.vec3.add(S.sv3d.get(),v,y);p.vec3.scale(j,j,.5);L=c.castRenderScreenPointArray(S.sv3d.get());return this.camera.projectPoint(j,L),L[2]+r}p.vec3.copy(v,y)}}break;default:o.neverReached(this.collisionType)}return null},e.prototype.attach=function(e){if(void 0===e&&(e={manipulator3D:{}}),this.view._stage){var t=e.manipulator3D;if(this._engineLayerId=t.engineLayerId,s.isNone(this._engineLayerId)){var i=new O("manipulator-3d",{isPickable:!1});this.view._stage.add(0,i),this.view._stage.addToViewContent([i.id]),this._engineLayerId=i.id,t.engineLayerId=i.id}t.engineLayerReferences=(t.engineLayerReferences||0)+1,this._materialIdReferences=t.materialIdReferences,s.isNone(this._materialIdReferences)&&(this._materialIdReferences=new Map,t.materialIdReferences=this._materialIdReferences),this.camera.copyFrom(this.view.state.camera),this._attached=!0,this._updateEngineObject(),j.canProject(this._location.spatialReference,this.view.spatialReference)||(this.location=new r.Point({x:0,y:0,z:0,spatialReference:this.view.spatialReference}))}},e.prototype.detach=function(e){void 0===e&&(e={manipulator3D:{}});var t=e.manipulator3D;t.engineLayerReferences--;var i=0===t.engineLayerReferences;i&&(t.engineLayerId=null),this._removeResourcesFromStage(i),this._engineResources=null,this._engineLayerId=null,this._materialIdReferences=null,this._attached=!1},e.prototype.onViewChange=function(){this.camera.copyFrom(this.view.state.camera),this._screenLocationDirty=!0,this._updateEngineObject()},e.prototype.onElevationChange=function(e){v.containsPointObject(e.extent,this.location)&&(this.location=this._location)},e.prototype._evaluateElevationAlignment=function(e){if(void 0===e&&(e=this.location),s.isNone(this.elevationInfo))return!1;var t=null,i=0,n=s.unwrapOr(this.elevationInfo.offset,0);switch(this.elevationInfo.mode){case"on-the-ground":t=y.getElevationAtPoint(this.view.elevationProvider,e,"ground")||0;break;case"relative-to-ground":i=(y.getElevationAtPoint(this.view.elevationProvider,e,"ground")||0)+n;break;case"relative-to-scene":i=(y.getElevationAtPoint(this.view.elevationProvider,e,"scene")||0)+n;break;case"absolute-height":i=n}return(i!==this._elevation.offset||t!==this._elevation.override)&&(this._elevation.offset=i,this._elevation.override=t,!0)},e.prototype._updateEngineObject=function(){if(this._attached)if(this.available){var e=this._getWorldToScreenObjectScale(),t=I;if(!0===this.autoScaleRenderObjects){var i=this._getFocusedSize(this._radius,this.focused)*e;this._calculateObjectTransform(i,t)}else this._calculateObjectTransform(e,t);for(var n=this._ensureEngineResources().objectsByState,r=(this.focused?2:1)|(this.selected?8:4),o=this._noDisplayCount>0,a=0,s=n;a<s.length;a++){var c=s[a],l=c.stateMask,h=c.objects;if(o)for(var d=0,u=h;d<u.length;d++){(y=u[d]).hide()}else{var f=!(0!=(15&l))||(r&l)==(15&l),_=!(0!=(65520&l))||(this.state&l)==(65520&l);if(f&&_)for(var p=0,g=h;p<g.length;p++){(y=g[p]).unhide(),y.objectTransformation=t}else for(var v=0,m=h;v<m.length;v++){var y;(y=m[v]).hide()}}}}else this._removeResourcesFromStage()},e.prototype._ensureEngineResources=function(){if(s.isNone(this._engineResources)){var e=this.view._stage.getContent(0,s.expect(this._engineLayerId)),t=[],i=new Set;this.renderObjects.forEach((function(e){var n=e.material;i.has(n)||(t.push(n),i.add(n))}));var n=new Map;this.renderObjects.forEach((function(e){var t=new w({idHint:"manipulator",castShadow:!1});!function(e,t){var i=t.geometry,n=t.material,r=t.transform;Array.isArray(i)?i.forEach((function(t){return e.addGeometry(t,n,r)})):e.addGeometry(i,n,r)}(t,e);var i=e.stateMask||0,r=n.get(i)||[];r.push(t),n.set(i,r)}));var r=[];n.forEach((function(e,t){r.push({stateMask:t,objects:e})})),this._engineResources={objectsByState:r,layer:e,materials:t}}return this._addResourcesToStage(),this._engineResources},e.prototype._addResourcesToStage=function(){var e=this;if(!this._engineResourcesAddedToStage&&!s.isNone(this._engineResources)){var t=this._engineResources,i=t.objectsByState,n=t.layer;t.materials.forEach((function(t){var i=s.expect(e._materialIdReferences),n=i.get(t.id)||0;0===n&&e.view._stage.add(3,t),i.set(t.id,n+1)})),i.forEach((function(t){t.objects.forEach((function(t){n.addObject(t),e.view._stage.add(1,t)}))})),this._engineResourcesAddedToStage=!0}},e.prototype._removeResourcesFromStage=function(e){var t=this;if(void 0===e&&(e=!1),this._engineResourcesAddedToStage&&!s.isNone(this._engineResources)){var i=this._engineResources,n=i.objectsByState,r=i.layer,o=i.materials;n.forEach((function(e){e.objects.forEach((function(e){r.removeObject(e),t.view._stage.remove(1,e.id)}))})),o.forEach((function(e){var i=s.expect(t._materialIdReferences),n=i.get(e.id);1===n?(t.view._stage.remove(3,e.id),i.delete(e.id)):i.set(e.id,n-1)})),e&&this.view._stage.remove(0,r.id),this._engineResourcesAddedToStage=!1}},e.prototype._getCollisionRadius=function(e){return this._getFocusedSize(this.radius,!0)*("touch"===e?this.touchMultiplier:1)},e.prototype._getFocusedSize=function(e,t){return e*(t?this.focusMultiplier:1)},e.prototype._getWorldToScreenObjectScale=function(){return this._worldSized?1:this.screenLocation.pixelSize},e.prototype._calculateModelTransformPosition=function(e){var t=this._getWorldToScreenObjectScale(),i=this._calculateObjectTransform(t,F);return p.vec3.set(e,i[12],i[13],i[14])},e.prototype._calculateModelTransformOffset=function(e){var t=this._calculateModelTransformPosition(e);return p.vec3.subtract(e,t,this.renderLocation)},e.prototype._calculateObjectTransform=function(e,t){return u.mat4.set(t,e,0,0,0,0,e,0,0,0,0,e,0,0,0,0,1),this._worldFrame&&u.mat4.multiply(t,t,this._worldFrame),u.mat4.multiply(t,t,this._modelTransform),t[12]+=this.renderLocation[0],t[13]+=this.renderLocation[1],t[14]+=this.renderLocation[2],t[15]=1,s.isSome(this._applyObjectTransform)&&this._applyObjectTransform(t),t},e}();function P(e){return 0!==e[12]||0!==e[13]||0!==e[14]}t.Manipulator3D=R;var T=c.createScreenPointArray(),A=b.lineSegment.create(),E=b.ray.create(),D=d.mat3f64.create(),F=f.mat4f64.create(),I=f.mat4f64.create(),M=b.plane.create(),x=g.vec3f64.create(),z=g.vec3f64.create(),C=g.vec3f64.create(),k=g.vec3f64.create(),N=g.vec3f64.create(),W=g.vec3f64.create()}));