// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/declareExtendsHelper","../../../../../core/tsSupport/decorateHelper","../../../../../core/Handles","../../../../../core/mathUtils","../../../../../core/screenUtils","../../../../../core/libs/gl-matrix-2/mat4","../../../../../core/libs/gl-matrix-2/mat4f64","../../../../../core/libs/gl-matrix-2/vec2","../../../../../core/libs/gl-matrix-2/vec3","../../../../../core/libs/gl-matrix-2/vec3f64","../../manipulatorUtils","../support/Label","../support/LabelSegment","../support/labelUtils","../support/PathSegmentInterpolator","../support/viewUtils","../../../support/ElevationProvider","../../../support/geometryUtils","../../../support/LaserLineRenderer","../../../support/projectionUtils","../../../support/stack","../../../webgl-engine/lib/Geometry","../../../webgl-engine/lib/GeometryData","../../../webgl-engine/lib/GeometryUtil","../../../webgl-engine/lib/Intersector","../../../webgl-engine/lib/Layer","../../../webgl-engine/lib/Object3D","../../../webgl-engine/materials/ColorMaterial","../../../webgl-engine/materials/lineStippleUtils","../../../webgl-engine/materials/MeasurementArrowMaterial","../../../webgl-engine/materials/RibbonLineMaterial"],(function(e,t,i,r,o,n,s,a,l,d,c,h,_,u,p,g,v,m,b,w,L,P,f,j,y,O,S,G,C,A,M,D,R){var z=[1,.5,0,.75],E={laserLineGlowColor:[1,.5,0],laserLineGlowWidth:8,laserLineGlowFalloff:8,laserLineInnerColor:[1,1,1],laserLineInnerWidth:.75,laserLineGlobalAlpha:.75,laserLineEnabled:!0,handleColor:[1,.5,0],handleOpacity:.5,handleRadius:5,triangleColor:z,triangleLineWidth:3,triangleCornerSize:32,triangleSubdivisions:128,arrowWidth:16,arrowOutlineColor:[1,.5,0,1],arrowOutlineWidth:.2,arrowStripeEvenColor:[1,1,1,1],arrowStripeOddColor:[1,.5,0,1],arrowStripeLength:16,arrowSubdivisions:128,geodesicProjectionLineWidth:2,geodesicProjectionLineColor:z,guideLineWidth:2,guideLineColor:z,guideStippleLengthPixels:6,labelDistance:25},H=function(){function e(e,t){void 0===t&&(t={}),this._visible=!1,this._laserLineRenderer=null,this._directDistanceLabel=new u,this._horizontalDistanceLabel=new u,this._verticalDistanceLabel=new u,this._handles=new o,this._listenerHandles=null,this._cursorPosition=h.vec3f64.create(),this._startPosition=h.vec3f64.create(),this._endPosition=h.vec3f64.create(),this._centerPosition=h.vec3f64.create(),this._cornerPosition=h.vec3f64.create(),this._arrowLabelSegment=new p,this._horizontalLabelSegment=new p,this._verticalLabelSegment=new p,this._geodesicProjectionLabelSegment=new p,this._origin=h.vec3f64.create(),this._originTransform=l.mat4f64.create(),this._lastDraggedHandle=null,this._model=e,this._view=e.sceneView,this._params=m.copyParameter(E,t),this._layer=new G("point-to-point-measurement",{isPickable:!1}),this._createMaterials(),this._createObjects(),this._intersector=new S.Intersector(this._view.viewingMode),this._intersector.options.store=0}return e.prototype.destroy=function(){this.hide(),this._handles.destroy(),this._handles=null},Object.defineProperty(e.prototype,"requiresCursorPoint",{get:function(){return"initial"===this._model.state&&this._model.active},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"cameraAboveGround",{get:function(){return this._view.state.camera.aboveGround},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"visible",{get:function(){return this._visible},set:function(e){e?this.show():this.hide()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"testData",{get:function(){return{labels:{direct:this._directDistanceLabel,horizontal:this._horizontalDistanceLabel,vertical:this._verticalDistanceLabel},laserLineRenderer:this._laserLineRenderer}},enumerable:!0,configurable:!0}),e.prototype.createManipulators=function(){var e=this,t=function(){var t=_.createSphereManipulator(e._view,e._params.handleColor,e._params.handleOpacity);return t.visible=!1,t.hideOnGrab=!0,t.radius=e._params.handleRadius,t},i=t(),r=t();this._model.startPoint&&(i.mapPoint=this._model.startPoint,i.visible=!0),this._model.endPoint&&(r.mapPoint=this._model.endPoint,r.visible=!0);var o=function(){var t=e._lastDraggedHandle;i.grabbing&&!r.grabbing&&(t="start"),r.grabbing&&!i.grabbing&&(t="end"),i.grabbing||r.grabbing||(t=null);var o=t!==e._lastDraggedHandle;e._lastDraggedHandle=t,o&&e.visible&&e._updateLaserLine()};return this._handles.add([i.watch("grabbing",(function(){o()})),r.watch("grabbing",(function(){o()}))]),{start:i,end:r}},e.prototype.show=function(){if(!this._visible){this._visible=!0;var e=this._view._stage,t={innerColor:this._params.laserLineInnerColor,innerWidth:this._params.laserLineInnerWidth,glowColor:this._params.laserLineGlowColor,glowWidth:this._params.laserLineGlowWidth,glowFalloff:this._params.laserLineGlowFalloff,globalAlpha:this._params.laserLineGlobalAlpha};this._laserLineRenderer=new L.LaserLineRenderer(this._view.renderCoordsHelper,t),e.addRenderPlugin(this._laserLineRenderer.renderSlots,this._laserLineRenderer),this._addToStage(e),this._directDistanceLabel.addToView(this._view),this._horizontalDistanceLabel.addToView(this._view),this._verticalDistanceLabel.addToView(this._view),this._initializeListeners(),this._updateCursorPosition(),this._updateStartPosition(),this._updateEndPosition(),this._updateLaserLine(),this._updateView()}},e.prototype.hide=function(){if(this._visible){this._visible=!1;var e=this._view._stage;e.removeRenderPlugin(this._laserLineRenderer),this._laserLineRenderer=null,this._removeFromStage(e),this._directDistanceLabel.removeFromView(this._view),this._horizontalDistanceLabel.removeFromView(this._view),this._verticalDistanceLabel.removeFromView(this._view),this._destroyListeners(),this._view.cursor=null}},e.prototype.pick=function(t){var i=this._view.spatialReference,r=s.screenPointObjectToArray(t.screenPoint);this._view.sceneIntersectionHelper.intersectToolIntersectorScreen(r,this._intersector);var o=this._intersector.results.min,n=h.vec3f64.create();if(!o.getIntersectionPoint(n))return new e.PickResult;var a=this._view.renderCoordsHelper.fromRenderCoords(n,i),l="TerrainRenderer"===o.intersector?"ground":"feature";return new e.PickResult(l,n,a)},e.prototype.getElevation=function(e){return this._view.basemapTerrain.ready&&b.getElevationAtPoint(this._view.elevationProvider,e)||0},e.prototype.overlappingHandles=function(e,t){return m.pointToPointScreenDistance(e,t,this._view)<=this._params.handleRadius},e.prototype._createMaterials=function(){this._triangleLineMaterial=new R({width:this._params.triangleLineWidth,color:this._params.triangleColor,polygonOffset:!0},"triangle-line"),this._triangleLineMaterial.renderOccluded=4,this._triangleCornerMaterial=new A({color:this._params.triangleColor,transparent:!0,writeDepth:!1,polygonOffset:!0},"triangle-corner"),this._triangleCornerMaterial.renderOccluded=4,this._arrowMaterial=new D({outlineColor:this._params.arrowOutlineColor,stripeEvenColor:this._params.arrowStripeEvenColor,stripeOddColor:this._params.arrowStripeOddColor,polygonOffset:!0},"arrow"),this._arrowMaterial.renderOccluded=4,this._geodesicProjectionLineMaterial=new R({width:this._params.geodesicProjectionLineWidth,color:this._params.geodesicProjectionLineColor,polygonOffset:!0},"geodesic-line"),this._geodesicProjectionLineMaterial.renderOccluded=4,this._geodesicGuideLineMaterial=new R({width:this._params.guideLineWidth,color:this._params.geodesicProjectionLineColor,polygonOffset:!0,stipplePattern:M.createStipplePatternSimple(this._params.guideStippleLengthPixels),stippleIntegerRepeats:!1},"geodesic-guide"),this._geodesicGuideLineMaterial.renderOccluded=4},e.prototype._createObjects=function(){this._triangleLineObject=new C,this._layer.addObject(this._triangleLineObject),this._triangleCornerObject=new C,this._layer.addObject(this._triangleCornerObject),this._arrowObject=new C,this._layer.addObject(this._arrowObject),this._geodesicProjectionLineObject=new C,this._layer.addObject(this._geodesicProjectionLineObject),this._geodesicProjectionStartGuideObject=new C,this._layer.addObject(this._geodesicProjectionStartGuideObject),this._geodesicProjectionEndGuideObject=new C,this._layer.addObject(this._geodesicProjectionEndGuideObject)},e.prototype._addToStage=function(e){e.add(0,this._layer),e.add(3,this._triangleLineMaterial),e.add(3,this._triangleCornerMaterial),e.add(3,this._arrowMaterial),e.add(3,this._geodesicProjectionLineMaterial),e.add(3,this._geodesicGuideLineMaterial),e.add(1,this._triangleLineObject),e.add(1,this._triangleCornerObject),e.add(1,this._arrowObject),e.add(1,this._geodesicProjectionLineObject),e.add(1,this._geodesicProjectionStartGuideObject),e.add(1,this._geodesicProjectionEndGuideObject),e.addToViewContent([this._layer.id])},e.prototype._removeFromStage=function(e){e.removeFromViewContent([this._layer.id]),e.remove(0,this._layer.id),e.remove(3,this._triangleLineMaterial.id),e.remove(3,this._triangleCornerMaterial.id),e.remove(3,this._arrowMaterial.id),e.remove(3,this._geodesicProjectionLineMaterial.id),e.remove(3,this._geodesicGuideLineMaterial.id),e.remove(1,this._triangleLineObject.id),e.remove(1,this._triangleCornerObject.id),e.remove(1,this._arrowObject.id),e.remove(1,this._geodesicProjectionLineObject.id),e.remove(1,this._geodesicProjectionStartGuideObject.id),e.remove(1,this._geodesicProjectionEndGuideObject.id)},e.prototype._getLabelPositions=function(e,t,i,r,o){var a=this._model.triangleView.collapsed,l=s.castRenderScreenPointArray3(f.sv3d.get()),c=s.castRenderScreenPointArray3(f.sv3d.get());o.projectPoint(i,l),o.projectPoint(t,c);var h={direct:a?"top":"bottom",horizontal:"top",vertical:l[0]<c[0]?"left":"right"};if(!a){var _=f.sv2d.get(),u=f.sv2d.get();if(m.screenSpaceTangent(e,i,_,o),m.screenSpaceTangent(e,t,u,o),d.vec2.dot(_,u)>=V)h.direct=n.sign(_[1])===n.sign(u[1])?g.mirrorPosition(h.vertical):h.vertical;else{var p=s.castRenderScreenPointArray(f.sv2d.get());m.screenSpaceTangent(i,t,p,o),d.vec2.dot(p,u)>=V&&(h.direct=n.sign(p[0])===n.sign(u[0])?g.mirrorPosition(h.horizontal):h.horizontal)}}if("below-the-surface"===r){var v=function(e){return"top"===e?"bottom":"top"};h.direct=v(h.direct),h.horizontal=v(h.horizontal),h.vertical=v(h.vertical)}return h},e.prototype._updateView=function(){var e;if(this._view.ready){var t=this._view._stage.getCamera(),i=this._view.renderCoordsHelper,r=this._model.triangleView;if(!r.visible)return this._triangleLineObject.removeAllGeometries(),this._triangleCornerObject.removeAllGeometries(),this._arrowObject.removeAllGeometries(),this._geodesicProjectionLineObject.removeAllGeometries(),this._geodesicProjectionStartGuideObject.removeAllGeometries(),this._geodesicProjectionEndGuideObject.removeAllGeometries(),this._directDistanceLabel.visible=!1,this._horizontalDistanceLabel.visible=!1,void(this._verticalDistanceLabel.visible=!1);var o="camera-dependent"===this._model.measurementSurfaceLocation?this._view.state.camera.aboveGround?"above-the-surface":"below-the-surface":this._model.measurementSurfaceLocation,n=this._startPosition,s=this._endPosition,l="above-the-surface"===o?1:-1,d=l*(i.getAltitude(s)-i.getAltitude(n));d<0&&(n=(e=[s,n])[0],s=e[1]);var h=this._cornerPosition;i.worldUpAtPosition(n,h),c.vec3.scale(h,h,l*Math.abs(d)),c.vec3.add(h,h,n);var _=this._centerPosition;m.midpoint([n,s,h],_),c.vec3.copy(this._origin,_),a.mat4.identity(this._originTransform),a.mat4.translate(this._originTransform,this._originTransform,this._origin),r.collapsed?(this._triangleLineObject.removeAllGeometries(),this._triangleCornerObject.removeAllGeometries()):this._updateTriangleObjects(this._triangleLineObject,this._triangleCornerObject,n,s,h,this._origin,this._originTransform,t,this._horizontalLabelSegment,this._verticalLabelSegment),this._updateArrowObject(this._arrowObject,this._startPosition,this._endPosition,this._origin,this._originTransform,r.stripeLength,t,r.mode,this._arrowLabelSegment);var u=this._requiresGeodesicVisualElements(this._startPosition,this._endPosition,t,r.mode);this._updateGeodesicProjectionLineObject(this._geodesicProjectionLineObject,this._startPosition,this._endPosition,this._origin,this._originTransform,u,this._geodesicProjectionLabelSegment),this._updateGeodesicProjectionGuideObjects(u);var p=this._params.labelDistance,g=this._getLabelPositions(n,s,h,o,t);this._updateAuxiliaryMeasureLabels(r,t,g),"geodesic"!==r.mode?this._updateLabel(this._directDistanceLabel,this._arrowLabelSegment,p,g.direct,r.directLabel,r.visible,16,t):(this._updateLabel(this._horizontalDistanceLabel,u?this._geodesicProjectionLabelSegment:this._arrowLabelSegment,p,g.horizontal,r.horizontalLabel,r.visible,16,t),this._directDistanceLabel.visible=!1)}},e.prototype._updateAuxiliaryMeasureLabels=function(e,t,i){if(e.collapsed)return this._horizontalDistanceLabel.visible=!1,void(this._verticalDistanceLabel.visible=!1);var r=this._params.labelDistance;this._updateLabel(this._horizontalDistanceLabel,this._horizontalLabelSegment,r,i.horizontal,e.horizontalLabel,!0,12,t),this._updateLabel(this._verticalDistanceLabel,this._verticalLabelSegment,r,i.vertical,e.verticalLabel,!0,12,t)},e.prototype._updateTriangleObjects=function(e,t,i,r,o,n,s,a,l,d){var h=[c.vec3.subtract(f.sv3d.get(),i,n),c.vec3.subtract(f.sv3d.get(),o,n),c.vec3.subtract(f.sv3d.get(),r,n)];l.update(o,r),d.update(i,o);var _=new j(O.createPolylineGeometry(h),"triangle-line");e.removeAllGeometries(),e.addGeometry(_,this._triangleLineMaterial,s);var u=f.sv3d.get(),p=f.sv3d.get();c.vec3.subtract(u,o,i),c.vec3.normalize(u,u),c.vec3.subtract(p,r,o),c.vec3.normalize(p,p);var g=.33*Math.min(c.vec3.distance(o,i),c.vec3.distance(o,r)),v=this._params.triangleCornerSize*a.computeScreenPixelSizeAt(o),m=Math.min(g,v),b=new j(this._quadGeometryData(o,u,p,m,n),"triangle-corner");t.removeAllGeometries(),t.addGeometry(b,this._triangleCornerMaterial,s)},e.prototype._updateArrowObject=function(e,t,i,r,o,n,s,a,l){this._createInterpolatedLineGeometry(e,this._arrowMaterial,"arrow",t,i,r,o,a,this._arrowLabelSegment);var d=s.computeScreenPixelSizeAt(l.origin);this._arrowMaterial.setParameterValues({width:this._params.arrowWidth*d,stripeLength:n})},e.prototype._getSegmentInterpolator=function(e,t){var i=this._view.spatialReference,r=this._view.renderCoordsHelper.spatialReference;return P.canProject(i,P.SphericalECEFSpatialReference)?new v.Spherical(e,t,r,r):new v.Linear(e,t)},e.prototype._updateGeodesicProjectionLineObject=function(e,t,i,r,o,n,s){if(n){var a=this._view.renderCoordsHelper,l=c.vec3.copy(f.sv3d.get(),t),d=c.vec3.copy(f.sv3d.get(),i);a.setAltitude(0,l),a.setAltitude(0,d),this._createInterpolatedLineGeometry(e,this._geodesicProjectionLineMaterial,"geodesicProjectionLine",l,d,r,o,"geodesic",s)}else e.removeAllGeometries()},e.prototype._requiresGeodesicVisualElements=function(e,t,i,r){return!("geodesic"!==r||!this._model.geodesicDistanceExceeded)&&(this._requiresGeodesicGuideAt(e,i)||this._requiresGeodesicGuideAt(t,i))},e.prototype._requiresGeodesicGuideAt=function(e,t){var i=this._view.renderCoordsHelper,r=t.computeScreenPixelSizeAt(e);return i.getAltitude(e)/r>=10},e.prototype._updateGeodesicProjectionGuideObjects=function(e){if(!e)return this._geodesicProjectionStartGuideObject.removeAllGeometries(),void this._geodesicProjectionEndGuideObject.removeAllGeometries();var t=this._view.renderCoordsHelper,i=c.vec3.copy(f.sv3d.get(),this._startPosition),r=c.vec3.copy(f.sv3d.get(),this._endPosition);t.setAltitude(0,i),t.setAltitude(0,r),this._createInterpolatedLineGeometry(this._geodesicProjectionStartGuideObject,this._geodesicGuideLineMaterial,"geodesicGuideLine",i,this._startPosition,this._origin,this._originTransform,"euclidean"),this._createInterpolatedLineGeometry(this._geodesicProjectionEndGuideObject,this._geodesicGuideLineMaterial,"geodesicGuideLine",r,this._endPosition,this._origin,this._originTransform,"euclidean")},e.prototype._createInterpolatedLineGeometry=function(e,t,i,r,o,n,s,a,l){var d=this._view.renderCoordsHelper,h=[],_=[],u=function(e,t){var i=f.sv3d.get();c.vec3.subtract(i,e,n),h.push(i),_.push(t)};if("euclidean"===a){var p=f.sv3d.get();m.midpoint([r,o],p);var g=f.sv3d.get();d.worldUpAtPosition(p,g),u(r,g),u(o,g),l&&l.update(r,o)}else{for(var v=this._getSegmentInterpolator(r,o),b=this._params.arrowSubdivisions+1&-2,w=null,L=null,P=0;P<b;++P){var y=P/(b-1),S=f.sv3d.get();g=f.sv3d.get();v.eval(y,S),d.worldUpAtPosition(S,g),P===b/2-1?w=S:P===b/2&&(L=S),u(S,g)}l&&l.update(w,L)}var G=new j(O.createPolylineGeometry(h,_),i);e.removeAllGeometries(),e.addGeometry(G,t,s)},e.prototype._quadGeometryData=function(e,t,i,r,o){var n=f.sv3d.get(),s=[],a=f.sv3d.get();c.vec3.scale(a,i,r);var l=f.sv3d.get();c.vec3.scale(l,t,-r);for(var d=0;d<4;++d)c.vec3.copy(n,e),c.vec3.subtract(n,n,o),1&d&&c.vec3.add(n,n,a),2&d&&c.vec3.add(n,n,l),s.push(n[0],n[1],n[2]);return new y.GeometryData({position:{size:3,data:s}},{position:new Uint32Array([0,1,2,1,2,3])})},e.prototype._updateLabel=function(e,t,i,r,o,n,a,l){var d=s.castScreenPointArray(f.sv2d.get()),c=s.castScreenPointArray(f.sv2d.get()),h=g.computeLabelPositionFromSegment(l,t,i,r,d,c);e.updatePosition(d,c),e.text=o,e.visible=h&&n,e.fontSize=a},e.prototype._updateCursorPosition=function(){this._model.cursorPoint&&this._view.renderCoordsHelper.toRenderCoords(this._model.cursorPoint,this._cursorPosition),this._updateLaserLine()},e.prototype._updateStartPosition=function(){this._model.startPoint&&this._view.renderCoordsHelper.toRenderCoords(this._model.startPoint,this._startPosition)},e.prototype._updateEndPosition=function(){this._model.endPoint&&this._view.renderCoordsHelper.toRenderCoords(this._model.endPoint,this._endPosition)},e.prototype._getFocusPosition=function(){var e=this._model,t=e.triangleView.visible&&e.triangleView.collapsed&&"euclidean"===e.measurementMode;switch(e.state){case"drawing":return t?this._startPosition:e.endPoint?this._endPosition:this._startPosition;case"editing":return t?"start"===this._lastDraggedHandle?this._endPosition:this._startPosition:"start"===this._lastDraggedHandle?this._startPosition:this._endPosition;default:return e.cursorPoint?this._cursorPosition:null}},e.prototype._getFocusSpherePosition=function(){return"drawing"===this._model.state||"end"===this._lastDraggedHandle?this._startPosition:this._endPosition},e.prototype._updateLaserLine=function(){var e=this._model,t=this._getFocusPosition(),i=this._params.laserLineEnabled&&!!t&&"measured"!==e.state&&e.active;i?(this._laserLineRenderer.heightPlaneEnabled=i&&"euclidean"===e.measurementMode,this._laserLineRenderer.pointDistanceEnabled=i&&!!e.startPoint&&"geodesic"===e.measurementMode,this._laserLineRenderer.heightPlanePosition=t,this._laserLineRenderer.pointDistanceOrigin=this._getFocusSpherePosition(),this._laserLineRenderer.pointDistanceTarget=t,this._laserLineRenderer.lineVerticalPlaneEnabled=i&&e.triangleView.visible&&!e.triangleView.collapsed,this._laserLineRenderer.lineVerticalPlaneSegment=w.lineSegment.fromPoints(this._startPosition,this._endPosition,T)):(this._laserLineRenderer.heightPlaneEnabled=!1,this._laserLineRenderer.pointDistanceEnabled=!1,this._laserLineRenderer.lineVerticalPlaneEnabled=!1)},e.prototype._initializeListeners=function(){var e=this;this._listenerHandles=new o,this._listenerHandles.add([this._model.watch("state",(function(){e._updateLaserLine()})),this._model.watch("measurementMode",(function(){e._updateLaserLine()})),this._model.watch("hoveredHandle",(function(){e._updateView()})),this._model.watch("cursorPoint",(function(){e._updateCursorPosition()})),this._model.watch("startPoint",(function(){e._updateStartPosition(),e._updateView(),e._updateLaserLine()})),this._model.watch("endPoint",(function(){e._updateEndPosition(),e._updateView(),e._updateLaserLine()})),this._model.watch("unit",(function(){e._updateView()})),this._model.watch("active",(function(){e._updateLaserLine(),e._updateView()})),this._view.state.watch("camera",(function(){e._updateView()}))])},e.prototype._destroyListeners=function(){this._listenerHandles.destroy(),this._listenerHandles=null},e}();!function(e){var t=function(){};e.PickRequest=t;var i=function(e,t,i){void 0===e&&(e=null),void 0===t&&(t=null),void 0===i&&(i=null),this.type=e,this.scenePoint=t,this.mapPoint=i};e.PickResult=i}(H||(H={}));var V=Math.cos(n.deg2rad(12)),T=w.lineSegment.create();return H}));