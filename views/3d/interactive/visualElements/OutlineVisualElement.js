// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/decorateHelper","../../../../core/tsSupport/assignHelper","../../../../core/Evented","../../../../core/maybe","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../../../core/libs/gl-matrix-2/vec4","../../../../core/libs/gl-matrix-2/vec4f32","../../../../geometry/support/aaBoundingBox","../../../../layers/graphics/dehydratedFeatures","./DrapedVisualElementResources","./LaserlineVisualElement","./VisualElementResources","../../layers/graphics/ElevationContext","../../layers/graphics/lineUtils","../../support/projectionUtils","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/geometryDataUtils","../../webgl-engine/lib/RenderGeometry","../../webgl-engine/materials/RibbonLineMaterial","../../webgl-engine/shaders/RibbonLineTechnique"],(function(e,t,r,i,s,n,o,a,l,c,u,h,d,p,f,m,g,y,b,_,v,O,P){Object.defineProperty(t,"__esModule",{value:!0});var R=function(){function e(e){var t=this;this.view=null,this._attachmentOrigin=h.makeDehydratedPoint(0,0,0,null),this._attachmentOriginDirty=!0,this.events=new s,this._isDraped=!1,this._geometry=null,this._width=1,this._color=c.vec4f32.fromValues(1,0,1,1),this._innerWidth=1,this._innerColor=c.vec4f32.fromValues(1,1,1,1),this._stipplePattern=null,this._stippleOffColor=null,this._falloff=0,this._elevationInfo=null,this._laserlineStyle=null,this._laserlineEnabled=!1,this._occludedMode=8,this.resources=new f.VisualElementResources({view:e.view,createResources:function(e){return t.createResources(e)},recreateGeometry:function(e,r){return e.geometries.length=0,t.recreateGeometry(r,e.material,e.geometries),e.geometries}}),this._attachmentOrigin.spatialReference=e.view.spatialReference,this.drapedResources=new d.DrapedVisualElementResources({view:e.view,createResources:function(){return t.createDrapedResources()},recreateGeometry:function(e){e.geometries=t.createRenderGeometriesDraped(e.material),t.attachmentOriginChanged()}});var r=!0;for(var i in this._laserline=new p.LaserlineVisualElement({view:e.view}),e)i in this?"attached"===i?r=e[i]:this[i]=e[i]:console.error("Cannot set unknown property",i);this.attached=r}return e.prototype.destroy=function(){this.resources.destroy(),this.drapedResources.destroy(),this._laserline.destroy()},Object.defineProperty(e.prototype,"isDraped",{get:function(){return this._isDraped},set:function(e){e!==this._isDraped&&(this._isDraped=e,this.updateAttached(this.attached),this._laserline.attached=this.laserlineAttached)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"laserlineAttached",{get:function(){return this.attached&&!this.hidden&&n.isSome(this._laserlineStyle)&&!this.isDraped&&this.laserlineEnabled},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"hidden",{get:function(){return this.resources.hidden},set:function(e){this.resources.hidden=e,this.drapedResources.hidden=e,this._laserline.attached=this.laserlineAttached},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"attached",{get:function(){return this.resources.attached||this.drapedResources.attached},set:function(e){this.updateAttached(e)},enumerable:!0,configurable:!0}),e.prototype.updateAttached=function(e){this.resources.attached=!this.isDraped&&e,this.drapedResources.attached=this.isDraped&&e,this._laserline.attached=this.laserlineAttached,this.attached&&this.attachmentOriginChanged()},Object.defineProperty(e.prototype,"geometry",{get:function(){return this._geometry},set:function(e){this._geometry=e,this.resources.recreateGeometry(),this.drapedResources.recreateGeometry()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"width",{get:function(){return this._width},set:function(e){e!==this._width&&(this._width=e,this.updateMaterial())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"color",{get:function(){return this._color},set:function(e){l.vec4.exactEquals(e,this._color)||(l.vec4.copy(this._color,e),this.updateMaterial())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"innerWidth",{get:function(){return this._innerWidth},set:function(e){e!==this._innerWidth&&(this._innerWidth=e,this.updateMaterial())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"innerColor",{get:function(){return this._innerColor},set:function(e){l.vec4.exactEquals(e,this._innerColor)||(l.vec4.copy(this._innerColor,e),this.updateMaterial())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"stipplePattern",{get:function(){return this._stipplePattern},set:function(e){var t=n.isSome(e)!==n.isSome(this._stipplePattern);this._stipplePattern=e,t?this.resources.recreate():this.updateMaterial()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"stippleOffColor",{get:function(){return this._stippleOffColor},set:function(e){e&&this._stippleOffColor&&l.vec4.exactEquals(e,this._stippleOffColor)||(this._stippleOffColor=e?c.vec4f32.clone(e):null,this.updateMaterial())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"falloff",{get:function(){return this._falloff},set:function(e){e!==this._falloff&&(this._falloff=e,this.updateMaterial())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"elevationInfo",{get:function(){return this._elevationInfo},set:function(e){this._elevationInfo=e,this.resources.recreateGeometry()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"laserlineStyle",{get:function(){return this._laserlineStyle},set:function(e){this._laserlineStyle=e,this._laserline.attached=this.laserlineAttached,n.isSome(e)&&(this._laserline.style=e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"laserlineEnabled",{get:function(){return this._laserlineEnabled},set:function(e){this._laserlineEnabled!==e&&(this._laserlineEnabled=e,this._laserline.attached=this.laserlineAttached)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"occludedMode",{get:function(){return this._occludedMode},set:function(e){e!==this._occludedMode&&(this._occludedMode=e,n.isSome(this.resources.resources)&&(this.resources.resources.material.renderOccluded=e),n.isSome(this.drapedResources.resources)&&(this.drapedResources.resources.material.renderOccluded=e))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"attachmentOrigin",{get:function(){if(!this._attachmentOriginDirty)return this._attachmentOrigin;var e=n.isSome(this.resources.resources)?this.resources.resources.geometries:null;if(!e||0===e.length)return null;o.vec3.set(D,0,0,0);for(var t=P.RibbonVertexAttributeConstants.POSITION,r=0,i=n.expect(this.resources.resources).material.getParameters().isClosed,s=0,a=e;s<a.length;s++){var l=a[s];_.computeAttachmentOriginLines(l.getAttribute(t),l.getIndices(t),i,C)&&(o.vec3.add(D,D,C),r++)}return 0===r?null:(o.vec3.scale(D,D,1/r),this.view.renderCoordsHelper.fromRenderCoords(D,this._attachmentOrigin),this._attachmentOriginDirty=!1,this._attachmentOrigin)},enumerable:!0,configurable:!0}),e.prototype.updateMaterial=function(){n.isSome(this.resources.resources)&&this.resources.resources.material.setParameterValues(this.materialParameters),n.isSome(this.drapedResources.resources)&&this.drapedResources.resources.material.setParameterValues(this.materialParameters)},Object.defineProperty(e.prototype,"isClosed",{get:function(){return n.isSome(this.geometry)&&"polygon"===this.geometry.type},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"materialParameters",{get:function(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,isClosed:this.isClosed,falloff:this._falloff,innerColor:this._innerColor,innerWidth:this._innerWidth,join:"round",stippleIntegerRepeats:!0,polygonOffset:!0}},enumerable:!0,configurable:!0}),e.prototype.recreateGeometry=function(e,t,r){for(var i=0,s=this.createRenderGeometries();i<s.length;i++){var n=s[i];e.addGeometry(n,t),r.push(n)}this.attachmentOriginChanged()},e.prototype.attachmentOriginChanged=function(){this._attachmentOriginDirty=!0,this.events.emit("attachment-origin-changed")},e.prototype.createResources=function(e){var t=new O(this.materialParameters,"lineVisualElement");t.renderOccluded=8;var r=[];return this.recreateGeometry(e,t,r),{material:t,geometries:r,forEach:function(e){e(t),r.forEach(e)}}},e.prototype.createDrapedResources=function(){var e=new O(this.materialParameters,"lineVisualElement");return e.renderOccluded=4,{material:e,geometries:this.createRenderGeometriesDraped(e)}},e.prototype.createRenderGeometriesDraped=function(e){var t=this.geometry;if(n.isNone(t))return[];for(var r=[],i=0,s=g.geometryToRenderInfoDraped(t,this.view.basemapTerrain.spatialReference).lines;i<s.length;i++){var a=s[i].position,l={attributeData:{position:a},removeDuplicateStartEnd:this.isClosed?1:0},c=new v(g.createGeometryData(l));c.material=e;var h=u.empty(w);u.expandWithBuffer(h,a),o.vec3.set(c.center,.5*(h[0]+h[3]),.5*(h[1]+h[4]),0),c.bsRadius=.5*Math.sqrt((h[3]-h[0])*(h[3]-h[0])+(h[4]-h[1])*(h[4]-h[1])),r.push(c)}return r},e.prototype.calculateMapBounds=function(e){if(n.isNone(this.resources.resources))return!1;for(var t=this.view.renderCoordsHelper,r=0,i=this.resources.resources.geometries;r<i.length;r++){var s=i[r].data.getAttribute("position"),o=s.data,a=new Float64Array(o.length);y.bufferToBuffer(s.data,t.spatialReference,0,a,this.view.spatialReference,0,o.length/3),u.expandWithBuffer(e,a)}return!0},e.prototype.createRenderGeometries=function(){var e=this.geometry;if(n.isNone(e))return[];for(var t=[],r=[],i=0,s=g.geometryToRenderInfo(e,this.view.elevationProvider,this.view.renderCoordsHelper,m.fromElevationInfo(this.elevationInfo)).lines;i<s.length;i++){var o=s[i],a=o.position,l={attributeData:{position:a,mapPosition:o.mapPosition},removeDuplicateStartEnd:this.isClosed?1:0},c=g.createGeometryData(l);t.push(new b(c,"geometryOutlineVisualElement")),r.push(a)}return this._laserline.pathVerticalPlane=r,t},e}();t.OutlineVisualElement=R;var w=u.create(),C=a.vec3f64.create(),D=a.vec3f64.create()}));