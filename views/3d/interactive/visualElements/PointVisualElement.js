// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/decorateHelper","../../../../core/tsSupport/assignHelper","../../../../core/mathUtils","../../../../core/maybe","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../../../core/libs/gl-matrix-2/vec4","../../../../core/libs/gl-matrix-2/vec4f64","../../../../geometry/support/aaBoundingBox","./VisualElementResources","../../layers/graphics/elevationAlignmentUtils","../../layers/graphics/ElevationContext","../../layers/graphics/sdfPrimitives","../../support/projectionUtils","../../support/stack","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryUtil","../../webgl-engine/lib/Texture","../../webgl-engine/lib/Util","../../webgl-engine/materials/HUDMaterial"],(function(e,t,r,i,o,n,s,a,u,c,l,p,h,f,m,y,d,g,v,b,_,S){Object.defineProperty(t,"__esModule",{value:!0});var x=function(){function e(e){var t=this;this.view=null,this._geometry=null,this._size=3,this._color=c.vec4f64.fromValues(1,0,1,1),this._primitive="square",this._outlineSize=1,this._outlineColor=c.vec4f64.fromValues(1,1,1,1),this._elevationInfo=null,this.resources=new p.VisualElementResources({view:e.view,createResources:function(e){return t.createResources(e)},recreateGeometry:function(e,r){return e.geometry=t.recreateGeometry(r,e.material),n.isSome(e.geometry)?[e.geometry]:[]}});var r=!0;for(var i in e)i in this?"attached"===i?r=e[i]:this[i]=e[i]:console.error("Cannot set unknown property",i);this.attached=r}return e.prototype.destroy=function(){this.resources.destroy()},Object.defineProperty(e.prototype,"hidden",{get:function(){return this.resources.hidden},set:function(e){this.resources.hidden=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"attached",{get:function(){return this.resources.attached},set:function(e){this.resources.attached=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"geometry",{get:function(){return this._geometry},set:function(e){this._geometry=e,this.resources.recreateGeometry()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"size",{get:function(){return this._size},set:function(e){if(e!==this._size){var t=this.preferredTextureSize;this._size=e,t<this.preferredTextureSize?n.isSome(this.resources)&&this.resources.recreate():this.updateSizeAttribute()}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"color",{get:function(){return this._color},set:function(e){u.vec4.exactEquals(e,this._color)||(u.vec4.copy(this._color,e),this.updateMaterial())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"primitive",{get:function(){return this._primitive},set:function(e){this._primitive!==e&&(this._primitive=e,n.isSome(this.resources)&&this.resources.recreate())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"outlineSize",{get:function(){return this._outlineSize},set:function(e){e!==this._outlineSize&&(this._outlineSize=e,this.updateMaterial())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"outlineColor",{get:function(){return this._outlineColor},set:function(e){u.vec4.exactEquals(e,this._outlineColor)||(u.vec4.copy(this._outlineColor,e),this.updateMaterial())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"elevationInfo",{get:function(){return this._elevationInfo},set:function(e){this._elevationInfo=e,this.resources&&this.resources.recreateGeometry()},enumerable:!0,configurable:!0}),e.prototype.updateMaterial=function(){var e=this.resources.resources;n.isNone(e)||e.material.setParameterValues(this.materialParameters(e.texture.id))},e.prototype.updateSizeAttribute=function(){var e=this.resources.resources,t=this.resources.object;if(!n.isNone(e)&&!n.isNone(t)){var r=e.geometry;if(!n.isNone(r)){var i=r.data.getVertexAttr()[_.VertexAttrConstants.SIZE].data,o=this.geometrySize;i[0]=o,i[1]=o,t.geometryVertexAttrsUpdated(0)}}},e.prototype.materialParameters=function(e){return{color:this._color,textureIsSignedDistanceField:!0,distanceFieldBoundingBox:P,occlusionTest:!1,outlineColor:this._outlineColor,outlineSize:this._outlineSize,textureId:e,polygonOffset:!1,shaderPolygonOffset:0,drawInSecondSlot:!0,depthEnabled:!1}},Object.defineProperty(e.prototype,"geometrySize",{get:function(){return this._size/z},enumerable:!0,configurable:!0}),e.prototype.recreateGeometry=function(e,t){var r=this.createRenderGeometry();return n.isSome(r)&&e.addGeometry(r,t),r},e.prototype.createResources=function(e){var t=this.createTexture(),r=new S(this.materialParameters(t.id),"pointVisualElement");r.renderOccluded=8;var i=this.recreateGeometry(e,r);return{material:r,texture:t,geometry:i,forEach:function(e){e(t),e(r),n.isSome(this.geometry)&&e(this.geometry)}}},Object.defineProperty(e.prototype,"preferredTextureSize",{get:function(){return o.clamp(o.nextHighestPowerOfTwo(2*this.geometrySize),16,128)},enumerable:!0,configurable:!0}),e.prototype.createTexture=function(){var e=this.preferredTextureSize;return new b(m.createType(this._primitive,e,e*z),"pointVisualElement",{mipmap:!1,wrap:{s:33071,t:33071},width:e,height:e,components:4,noUnpackFlip:!0})},e.prototype.calculateMapBounds=function(e){if(n.isNone(this.resources.resources)||n.isNone(this.resources.resources.geometry))return!1;var t=this.resources.resources.geometry.data.getAttribute("position");return y.vectorToVector(t.data,this.view.renderCoordsHelper.spatialReference,w,this.view.spatialReference),l.expandWithBuffer(e,w),!0},e.prototype.createRenderGeometry=function(){var e=this.geometry;if(n.isNone(e))return null;var t=this.view.renderCoordsHelper,r=h.evaluateElevationAlignmentAtPoint(e,this.view.elevationProvider,f.fromElevationInfo(this.elevationInfo),t),i=s.vec3.set(d.sv3d.get(),e.x,e.y,r),o=d.sv3d.get();y.vectorToVector(i,e.spatialReference,o,t.spatialReference);var a=this.geometrySize,u=v.createPointGeometry(null,o,null,[a,a],[0,0,0,1]);return new g(u)},e}();t.PointVisualElement=x;var z=.5,P=[z/2,z/2,1-z/2,1-z/2],w=a.vec3f64.create()}));