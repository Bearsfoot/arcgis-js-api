// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/decorateHelper","../../../../core/tsSupport/assignHelper","../../../../core/maybe","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../../../core/libs/gl-matrix-2/vec4","../../../../core/libs/gl-matrix-2/vec4f32","./LaserlineVisualElement","./VisualElementResources","../../support/geometryUtils","../../support/geometryUtils/clipRay","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryUtil","../../webgl-engine/materials/RibbonLineMaterial","../../webgl-engine/shaders/RibbonLineTechnique"],(function(e,t,i,r,n,s,o,a,l,c,u,h,f,d,p,_,y,b){Object.defineProperty(t,"__esModule",{value:!0});var m=function(){function e(e){var t=this;this.view=null,this._ray=f.ray.create(),this._isWorldDown=!1,this._start=a.vec3f64.create(),this._end=a.vec3f64.fromValues(1,0,0),this._width=1,this._color=c.vec4f32.fromValues(1,0,1,1),this._innerWidth=1,this._innerColor=c.vec4f32.fromValues(1,1,1,1),this._stipplePattern=null,this._stippleOffColor=null,this._falloff=0,this._infinite=0,this._laserlineStyle=null,this._laserlineEnabled=!1,this._occludedMode=4,this.resources=new h.VisualElementResources({view:e.view,cameraChanged:function(){return t.updateGeometry()},createResources:function(e){return t.createResources(e)}}),this._laserline=new u.LaserlineVisualElement({view:e.view});var i=!0;for(var r in e)r in this?"attached"===r?i=e[r]:this[r]=e[r]:console.error("Cannot set unknown property",r);this.attached=i}return e.prototype.destroy=function(){this.resources.destroy(),this._laserline.destroy()},Object.defineProperty(e.prototype,"laserlineAttached",{get:function(){return this.attached&&!this.hidden&&this._laserlineEnabled&&n.isSome(this._laserlineStyle)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"hidden",{get:function(){return this.resources.hidden},set:function(e){this.resources.hidden=e,this._laserline.attached=this.laserlineAttached},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"attached",{get:function(){return this.resources.attached},set:function(e){this.resources.attached=e,this._laserline.attached=this.laserlineAttached},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"worldDownAtLocation",{set:function(e){this._isWorldDown=!0,o.vec3.copy(this._start,e),this.view.renderCoordsHelper.worldUpAtPosition(e,this._end),o.vec3.subtract(this._end,e,this._end),f.ray.fromPoints(this._start,this._end,this._ray),this.updateGeometry()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"start",{get:function(){return this._start},set:function(e){this._isWorldDown=!1,o.vec3.exactEquals(this._start,e)||(o.vec3.copy(this._start,e),f.ray.fromPoints(this._start,this._end,this._ray),this.updateGeometry())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"end",{get:function(){return this._end},set:function(e){this._isWorldDown=!1,o.vec3.exactEquals(this._end,e)||(o.vec3.copy(this._end,e),f.ray.fromPoints(this._start,this._end,this._ray),this.updateGeometry())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"width",{get:function(){return this._width},set:function(e){e!==this._width&&(this._width=e,this.updateMaterial())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"color",{get:function(){return this._color},set:function(e){l.vec4.exactEquals(e,this._color)||(l.vec4.copy(this._color,e),this.updateMaterial())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"innerWidth",{get:function(){return this._innerWidth},set:function(e){e!==this._innerWidth&&(this._innerWidth=e,this.updateMaterial())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"innerColor",{get:function(){return this._innerColor},set:function(e){l.vec4.exactEquals(e,this._innerColor)||(l.vec4.copy(this._innerColor,e),this.updateMaterial())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"stipplePattern",{get:function(){return this._stipplePattern},set:function(e){var t=n.isSome(e)!==n.isSome(this._stipplePattern);this._stipplePattern=e,t?this.resources.recreate():this.updateMaterial()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"stippleOffColor",{get:function(){return this._stippleOffColor},set:function(e){(n.isNone(e)||n.isNone(this._stippleOffColor)||!l.vec4.exactEquals(e,this._stippleOffColor))&&(this._stippleOffColor=n.isSome(e)?c.vec4f32.clone(e):null,this.updateMaterial())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"falloff",{get:function(){return this._falloff},set:function(e){e!==this._falloff&&(this._falloff=e,this.updateMaterial())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"infinite",{get:function(){return this._infinite},set:function(e){e!==this._infinite&&(this._infinite=e,this.updateGeometry())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"laserlineStyle",{get:function(){return this._laserlineStyle},set:function(e){this._laserlineStyle=e,this._laserline.attached=this.laserlineAttached,n.isSome(e)&&(this._laserline.style=e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"laserlineEnabled",{get:function(){return this._laserlineEnabled},set:function(e){this._laserlineEnabled!==e&&(this._laserlineEnabled=e,this._laserline.attached=this.laserlineAttached)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"occludedMode",{get:function(){return this._occludedMode},set:function(e){e!==this._occludedMode&&(this._occludedMode=e,n.isSome(this.resources.resources)&&(this.resources.resources.material.renderOccluded=e))},enumerable:!0,configurable:!0}),e.prototype.updateMaterial=function(){var e=this.resources.resources;n.isNone(e)||e.material.setParameterValues(this.materialParameters)},Object.defineProperty(e.prototype,"materialParameters",{get:function(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,innerWidth:this._innerWidth,innerColor:this._innerColor,falloff:this._falloff}},enumerable:!0,configurable:!0}),e.prototype.updateGeometry=function(){var e=this.resources.object;n.isNone(e)||this.updateVertices(e)},e.prototype.updateVertices=function(e){if(this._infinite){var t=this.view.state.camera;switch(d.fromRay(this._ray,g),this._infinite){case 2:g.c0=-Number.MAX_VALUE;break;case 1:case 3:var i=this._ray.origin,r=this.view.elevationProvider.getElevation(i[0],i[1],i[2],this.view.renderCoordsHelper.spatialReference,"ground"),n=this.view.renderCoordsHelper.getAltitude(i);this._isWorldDown&&n<r&&o.vec3.negate(g.ray.direction,g.ray.direction),3===this._infinite&&null!=r&&(g.c1=Math.abs(n-r))}if(!f.frustum.intersectClipRay(t.frustum.planes,g))return void this.updateVertexAttributes(e,this._start,this._end);var s=d.getStart(g,v),a=d.getEnd(g,P);this.updateVertexAttributes(e,s,a),this._laserline.intersectsLine=f.lineSegment.fromPoints(s,a,w)}else this.updateVertexAttributes(e,this._start,this._end),this._laserline.intersectsLine=f.lineSegment.fromPoints(this._start,this._end,w)},e.prototype.updateVertexAttributes=function(e,t,i){var r=e.geometryRecords[0].geometry.data.getVertexAttr()[b.RibbonVertexAttributeConstants.POSITION].data;r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=i[0],r[4]=i[1],r[5]=i[2],e.geometryVertexAttrsUpdated(0)},e.prototype.createResources=function(e){var t=[a.vec3f64.create(),a.vec3f64.create()],i=new p(_.createPolylineGeometry(t),"lineVisualElement"),r=new y(this.materialParameters,"lineVisualElement");return r.renderOccluded=this._occludedMode,e.addGeometry(i,r,s.mat4f64.IDENTITY),this.updateVertices(e),{material:r,geometry:i,forEach:function(e){return e(r),e(i)}}},e}();t.LineVisualElement=m;var g=d.create(),v=a.vec3f64.create(),P=a.vec3f64.create(),w=f.lineSegment.create()}));