// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/decorateHelper","../../../../core/tsSupport/declareExtendsHelper","../../../../core/handleUtils","../../../../core/mathUtils","../../../../core/maybe","../../../../core/watchUtils","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../../../support/elevationInfoUtils","../Manipulator3D","./ManipulatorState","./settings","../visualElements/LaserlineVisualElement","../visualElements/LineVisualElement","../visualElements/OutlineVisualElement","../../layers/graphics/GraphicState"],(function(e,t,a,n,i,l,s,r,o,c,u,d,h,p,g,v,m,b){function f(e){return s.isSome(e.geometry)&&("polygon"===e.geometry.type||"polyline"===e.geometry.type)}Object.defineProperty(t,"__esModule",{value:!0}),t.createVisualElements=function(e){var t=e.view,a=e.graphic,n=new b.GraphicState({graphic:a}),c=[],y=function(e,t,a){var n=e.view,l=e.graphic,s=new m.OutlineVisualElement({view:n,geometry:f(l)?l.geometry:null,elevationInfo:u.getGraphicEffectiveElevationInfo(l),attached:!1}),r=function(){s.attached=t.displaying&&p.settings.visualElements.lineGraphics.outlineEnabled};return a.push(p.settings.visualElements.lineGraphics.outline.bindStyle(s),t.watch("displaying",r),p.settings.visualElements.lineGraphics.watch("outlineEnabled",r),t.watch("isDraped",(function(e){return s.isDraped=e})),t.on("changed",(function(){return s.geometry=f(l)?l.geometry:null})),i.destroyHandle(s)),r(),s}(e,n,c);return function(e,t,a,n){var c=e.graphic,m=e.view,b=u.getGraphicEffectiveElevationInfo(c),y="on-the-ground"===b.mode||!b.offset&&"absolute-height"!==b.mode,w=new h.ManipulatorState,S=new v.LineVisualElement({view:m,infinite:p.settings.visualElements.zVerticalLine.infiniteType,attached:!1}),G=l.deg2rad(p.settings.visualElements.heightPlaneAngleCutoff),M=new g.LaserlineVisualElement({view:m,attached:!1,angleCutoff:G}),L=(D=null,{remove:i.refHandle((function(){return D})).remove,update:function(e){var t=!1;switch(p.settings.zManipulator.enabled){case"always":t=!0;break;case"not-grab-z":t=!e.grabbingState}t&&s.isSome(D)?(D.remove(),D=null):!t&&s.isNone(D)&&s.isSome(e.zManipulator)&&(D=e.zManipulator.disableDisplay())}}),V=p.settings.visualElements.lineGraphics.shadowStyle.bindStyle(t),z=p.settings.visualElements.pointGraphics.shadowStyle.bindStyle(S),A=p.settings.visualElements.heightPlane.bindStyle(M),H=function(){if(w.update(e),L.update(w),S.infinite=p.settings.visualElements.zVerticalLine.infiniteType,!a.displaying||y&&(a.isDraped||!f(c)||!c.geometry.hasZ))return t.laserlineEnabled=!1,S.attached=!1,void(M.attached=!1);!function(e,t,a){var n=!1;switch(p.settings.visualElements.lineGraphics.shadowEnabled){case"always":n=!0;break;case"grab-xy":n=!!(4&t.grabbingState)}4&t.grabbingState?a.updateGlobalAlpha(p.settings.visualElements.laserlineAlphaMultiplier):a.updateGlobalAlpha(1);e.laserlineEnabled=n}(t,w,V),function(e,t,a){var n=!1;switch(p.settings.visualElements.pointGraphics.shadowEnabled){case"always":n=!0;break;case"grab-xy":n=!!(4&t.grabbingState)}4&t.grabbingState?a.updateGlobalAlpha(p.settings.visualElements.laserlineAlphaMultiplier):a.updateGlobalAlpha(1);if(n||p.settings.visualElements.zVerticalLine.enabled){e.laserlineEnabled=n;var i=1===t.numSelected?t.firstSelected:t.numSelected>1&&s.isSome(t.firstGrabbedXY)?t.firstGrabbedXY:null;s.isSome(i)?(p.settings.visualElements.zVerticalLine.infinite&&(e.worldDownAtLocation=i.renderLocation),e.attached=!0):e.attached=!1}else e.attached=!1}(S,w,z),function(e,t,a,n,i){var l=!1;switch(p.settings.visualElements.heightPlane.enabled){case"always":l=!0;break;case"grab-z":l=!!(2&n.grabbingState)}2&n.grabbingState?i.updateGlobalAlpha(p.settings.visualElements.laserlineAlphaMultiplier):i.updateGlobalAlpha(1);if(!l)return void(a.attached=!1);if(n.numSelected>0){o.vec3.set(E,0,0,0);var r=0;e.forEachManipulator((function(e,t){1===t&&e.selected&&e instanceof d.Manipulator3D&&(o.vec3.add(E,E,e.renderLocation),r++)})),r>0?(a.heightPlane=o.vec3.scale(E,E,1/r),a.attached=!0):a.attached=!1}else{var c=t.attachmentOrigin;s.isSome(c)&&e.view.renderCoordsHelper.toRenderCoords(c,E)?(a.heightPlane=E,a.attached=!0):a.attached=!1}}(e,t,M,w,A)};var D;n.push(V,r.init(p.settings.visualElements.lineGraphics,"shadowEnabled",H),a.on("changed",H),a.watch("displaying",H),p.settings.visualElements.zVerticalLine.bindStyle(S),p.settings.visualElements.zVerticalLine.watch(["enabled","infinite"],H),z,p.settings.visualElements.pointGraphics.watch("shadowEnabled",H),p.settings.zManipulator.watch("enabled",H),A,p.settings.visualElements.heightPlane.watch("enabled",H),t.events.on("attachment-origin-changed",H),i.destroyHandle(S),i.destroyHandle(M),L);var P=[],k=function(){i.handlesGroup(P).remove(),P.length=0,e.forEachManipulator((function(e){return P.push(e.events.on("grab-changed",H))})),e.forEachManipulator((function(e){return P.push(e.events.on("select-changed",H))})),H()};k(),n.push(e.onManipulatorsChanged(k),i.refHandle((function(){return i.handlesGroup(P)})))}(e,y,n,c),c.push(t.maskOccludee(a)),c.push(t.trackGraphicState(n)),{visualElement:y,remove:function(){i.handlesGroup(c).remove()}}};var E=c.vec3f64.create()}));