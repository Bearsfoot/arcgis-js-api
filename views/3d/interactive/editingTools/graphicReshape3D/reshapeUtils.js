// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/decorateHelper","../../../../../core/tsSupport/extendsHelper","../../../../../core/arrayUtils","../../../../../core/maybe","../../../../../core/libs/gl-matrix-2/vec2","../../../../../core/libs/gl-matrix-2/vec2f64","../../../../../core/libs/gl-matrix-2/vec3","../../../../../core/libs/gl-matrix-2/vec3f64","../../../../../core/libs/gl-matrix-2/vec4","../../../../../core/libs/gl-matrix-2/vec4f64","../../../../../geometry/support/coordsUtils","../../../../../geometry/support/spatialReferenceUtils"],(function(e,t,r,n,o,i,s,a,p,c,u,l,f,h){Object.defineProperty(t,"__esModule",{value:!0});var v=function(){function e(){this.vertices=[],this.edges=[],this.index=null}return e.prototype.makeVertex=function(e,t,r){void 0===t&&(t=null),void 0===r&&(r=null);var n={pos:e,unnormalizedPos:e,left:t,right:r,type:"vertex",component:this,index:null};return this.vertices.push(n),n},e.prototype.makeEdge=function(e,t){var r={v0:e,v1:t,type:"edge",component:this};return e.right=r,t.left=r,this.edges.push(r),r},e.prototype.removeVertex=function(e){this.vertices.splice(this.vertices.indexOf(e),1),e.left&&this.removeEdge(e.left),e.right&&this.removeEdge(e.right)},e.prototype.removeEdge=function(e){this.edges.splice(this.edges.indexOf(e),1),e.v0.right=null,e.v1.left=null},e}();function m(){return new v}t.Component=v;var d=function(){function e(){}return e.prototype.createNew=function(){return a.vec2f64.create()},e.prototype.fromArray=function(e){return a.vec2f64.fromValues(e[0],e[1])},e.prototype.toArray=function(e){return[e[0],e[1]]},e.prototype.toPoint=function(e,t){return t.x=e[0],t.y=e[1],t.hasZ=!1,t.hasM=!1,t},e.prototype.lerp=function(e,t,r,n){return s.vec2.lerp(n,e,t,r)},e.prototype.addDelta=function(e,t,r){e[0]+=t,e[1]+=r},e}();t.CoordinateHelper2D=d;var y=function(){function e(e){this.ztype=e}return e.prototype.createNew=function(){return c.vec3f64.create()},e.prototype.fromArray=function(e){return c.vec3f64.fromValues(e[0],e[1],e[2]||0)},e.prototype.toArray=function(e){return[e[0],e[1],e[2]]},e.prototype.toPoint=function(e,t){return t.x=e[0],t.y=e[1],0===this.ztype?(t.z=e[2],t.hasZ=!0,t.hasM=!1):(t.m=e[2],t.hasZ=!1,t.hasM=!0),t},e.prototype.lerp=function(e,t,r,n){return p.vec3.lerp(n,e,t,r)},e.prototype.addDelta=function(e,t,r,n){e[0]+=t,e[1]+=r,0===this.ztype&&(e[2]+=n)},e}();t.CoordinateHelper3D=y;var g=function(){function e(){}return e.prototype.createNew=function(){return l.vec4f64.create()},e.prototype.fromArray=function(e){return l.vec4f64.fromValues(e[0],e[1],e[2]||0,e[3]||0)},e.prototype.toArray=function(e){return[e[0],e[1],e[2],e[3]]},e.prototype.toPoint=function(e,t){return t.x=e[0],t.y=e[1],t.z=e[2],t.m=e[3],t.hasZ=!0,t.hasM=!0,t},e.prototype.lerp=function(e,t,r,n){return u.vec4.lerp(n,e,t,r)},e.prototype.addDelta=function(e,t,r,n){e[0]+=t,e[1]+=r,e[2]+=n},e}();t.CoordinateHelper4D=g;var x=function(){function e(e,t,r){this.geometry=e,this.doUnnormalization=t,this.coordinateHelper=r,this.components=[];var n=h.getInfo(this.geometry.spatialReference);this._tmpMapPoint=r.createNew(),n?(this._spanMin=n.valid[0],this._spanMax=n.valid[1],this._span=this._spanMax-this._spanMin):this.doUnnormalization=!1}return e.prototype.addDelta=function(e,t,r,n){this.coordinateHelper.addDelta(e.pos,t,r,n)},e.prototype.getVertexPositionAsPoint=function(e,t){return this.coordinateHelper.toPoint(e.pos,t),t.spatialReference=this.geometry.spatialReference,t},e.prototype.getEdgePosition=function(e,t,r){return void 0===r&&(r=this.coordinateHelper.createNew()),this.coordinateHelper.lerp(e.v0.unnormalizedPos,e.v1.unnormalizedPos,t,r)},e.prototype.getEdgePositionAsPoint=function(e,t,r){var n=this.getEdgePosition(e,t,this._tmpMapPoint);return this.coordinateHelper.toPoint(n,r),r.spatialReference=this.geometry.spatialReference,r},e.prototype.canRemoveVertex=function(e){return!0},e.prototype.removeVertex=function(e){var t=e.component,r=e.left,n=e.right;return t.removeVertex(e),r&&n?t.makeEdge(r.v0,n.v1):null},e.prototype.splitEdge=function(e,t){var r=e.component,n=r.makeVertex(this.getEdgePosition(e,t)),o=e.v0,i=e.v1;return r.removeEdge(e),r.makeEdge(o,n),r.makeEdge(n,i),n},e}();t.ReshapeHelper=x;var P=function(e){function t(t,r,n){var o=e.call(this,t,r,n)||this;o.geometry=t;for(var i=o.geometry.rings,s=0;s<i.length;++s){for(var a=i[s],p=m(),c=a.length-1,u=0;u<c;++u){var l=n.fromArray(a[u]);p.makeVertex(l).index=u}for(var h=p.vertices.length-1,v=0;v<h;++v){var d=p.vertices[v],y=p.vertices[v+1];p.makeEdge(d,y)}p.makeEdge(p.vertices[p.vertices.length-1],p.vertices[0]),o.doUnnormalization&&f.computeUnnormalizedVertexPositionsOnDateLineCrossing(p.vertices,o._spanMin,o._spanMax,o._span),p.index=s,o.components.push(p)}return o}return n(t,e),t.prototype.canRemoveVertex=function(e){return e.component.vertices.length>3},t.prototype.commit=function(){var e=this,t=[],r=this.coordinateHelper.toArray;return this.components.forEach((function(n,o){n.index=o;var i=[];e.doUnnormalization&&f.computeUnnormalizedVertexPositionsOnDateLineCrossing(n.vertices,e._spanMin,e._spanMax,e._span);var s=n.vertices[0],a=s,p=a,c=0;do{a.index=c++,i.push(r(a.unnormalizedPos)),a=a.right.v1}while(a&&a!==p);i.push(r(s.unnormalizedPos)),t.push(i)})),this.geometry.rings=t,this.geometry},t}(x),z=function(e){function t(t,r,n){var o=e.call(this,t,r,n)||this;o.geometry=t;for(var i=o.geometry.paths,s=0;s<i.length;++s){for(var a=i[s],p=m(),c=a.length,u=0;u<c;++u){var l=n.fromArray(a[u]);p.makeVertex(l).index=u}for(var h=p.vertices.length-1,v=0;v<h;++v){var d=p.vertices[v],y=p.vertices[v+1];p.makeEdge(d,y)}o.doUnnormalization&&f.computeUnnormalizedVertexPositionsOnDateLineCrossing(p.vertices,o._spanMin,o._spanMax,o._span),p.index=s,o.components.push(p)}return o}return n(t,e),t.prototype.canRemoveVertex=function(e){return e.component.vertices.length>2},t.prototype.commit=function(){var e=this,t=[],r=this.coordinateHelper.toArray;return this.components.forEach((function(n,i){n.index=i;var s=[];e.doUnnormalization&&f.computeUnnormalizedVertexPositionsOnDateLineCrossing(n.vertices,e._spanMin,e._spanMax,e._span);var a=o.find(n.vertices,(function(e){return null==e.left})),p=a,c=0;do{a.index=c++,s.push(r(a.unnormalizedPos)),a=a.right?a.right.v1:null}while(a&&a!==p);t.push(s)})),this.geometry.paths=t,this.geometry},t}(x);t.isReshapeGeometry=function(e){return i.isSome(e)&&("polygon"===e.type||"polyline"===e.type)},t.createReshapeHelper=function(e,t){if(i.isNone(e))return null;var r=function(e){if(e.hasZ&&e.hasM)return new g;if(e.hasM)return new y(1);if(e.hasZ)return new y(0);return new d}(e);return"polygon"===e.type?new P(e,t,r):new z(e,t,r)}}));