// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/decorateHelper","../../../../../core/tsSupport/declareExtendsHelper","../../../../../core/tsSupport/assignHelper","../../../../../core/compilerUtils","../../../../../core/Evented","../../../../../core/Handles","../../../../../core/handleUtils","../../../../../core/maybe","../../../../../core/watchUtils","../../../../../core/accessorSupport/decorators","../../../../../core/libs/gl-matrix-2/vec3","../../../../../layers/graphics/dehydratedFeatures","../../../../../support/elevationInfoUtils","../../Manipulator3D","../../manipulatorUtils","../manipulatorDragUtils","../manipulatorUtils","../settings","../visualElementUtils","./reshapeUtils","../manipulations/config","../manipulations/MoveManipulation","../manipulations/moveUtils","../manipulations/MoveXYGraphicManipulation","../../visualElements/OutlineVisualElement","../../../layers/graphics/GraphicState","../../../support/stack","../../../webgl-engine/lib/Geometry","../../../webgl-engine/lib/GeometryUtil"],(function(e,t,a,i,r,n,o,l,s,p,u,h,c,d,m,v,g,M,_,f,y,x,b,S,G,O,E,H,P,w,D){Object.defineProperty(t,"__esModule",{value:!0});var I=function(e){function t(t){var a=e.call(this,t)||this;return a._vertexManipulatorMaterial=g.createManipulatorMaterial(f.settings.colorToVec4(f.settings.reshapeManipulators.vertex.color),f.settings.reshapeManipulators.vertex.renderOccludedFlag),a._vertexManipulatorOutlineMaterial=g.createManipulatorOutlineMaterial(f.settings.colorToVec4(f.settings.reshapeManipulators.vertex.outlineColor),f.settings.reshapeManipulators.vertex.renderOccludedFlag),a._vertexManipulatorHoverOutlineMaterial=g.createManipulatorOutlineMaterial(f.settings.colorToVec4(f.settings.reshapeManipulators.vertex.hoverOutlineColor),f.settings.reshapeManipulators.vertex.renderOccludedFlag),a._edgeManipulatorMaterial=g.createManipulatorMaterial(f.settings.colorToVec4(f.settings.reshapeManipulators.edge.color),f.settings.reshapeManipulators.edge.renderOccludedFlag),a._edgeManipulatorOutlineMaterial=g.createManipulatorOutlineMaterial(f.settings.colorToVec4(f.settings.reshapeManipulators.edge.outlineColor),f.settings.reshapeManipulators.edge.renderOccludedFlag),a._selectedManipulatorMaterial=g.createManipulatorMaterial(f.settings.colorToVec4(f.settings.reshapeManipulators.selected.color),f.settings.reshapeManipulators.selected.renderOccludedFlag),a._selectedManipulatorOutlineMaterial=g.createManipulatorOutlineMaterial(f.settings.colorToVec4(f.settings.reshapeManipulators.selected.outlineColor),f.settings.reshapeManipulators.selected.renderOccludedFlag),a._selectedManipulatorHoverOutlineMaterial=g.createManipulatorOutlineMaterial(f.settings.colorToVec4(f.settings.reshapeManipulators.selected.hoverOutlineColor),f.settings.reshapeManipulators.selected.renderOccludedFlag),a._selectedIndex=0,a._vertexManipulatorGeometry=null,a._vertexManipulatorOutlineGeometry=null,a._edgeManipulatorGeometry=null,a._edgeManipulatorOutlineGeometry=null,a._handles=new l,a._manipulatorHandles=new l,a._manipulatorInfos=[],a._reshapeHelper=null,a._graphicMoveManipulation=null,a._moveManipulation=null,a._numGrabbing=0,a._numDragging=0,a._reshapeEventState=0,a._outlineVisualElement=null,a.tool=null,a.outputGeometry=null,a._vertexLaserLineVisualElement=null,a._emitter.target=null,a}return i(t,e),t.prototype.initialize=function(){var e=this,t=new H.GraphicState({graphic:this.graphic});this._graphicState=t,this._handles.add([t.watch("displaying",(function(t){for(var a=0,i=e._manipulatorInfos;a<i.length;a++){i[a].manipulator.available=t}})),f.settings.zManipulator.watch(f.settings.zManipulator.keys(),(function(){return e._recreateManipulators()})),f.settings.reshapeManipulators.vertex.watch(["size","outlineSize","collisionPadding"],(function(){e._vertexManipulatorGeometry=null,e._vertexManipulatorOutlineGeometry=null,e._recreateManipulators()})),f.settings.reshapeManipulators.edge.watch(["size","outlineSize","collisionPadding"],(function(){e._edgeManipulatorGeometry=null,e._edgeManipulatorOutlineGeometry=null,e._recreateManipulators()})),f.settings.reshapeManipulators.watch("hoverSize",(function(){return e._recreateManipulators()})),f.settings.reshapeManipulators.vertex.bindColorMaterial("color",this._vertexManipulatorMaterial),f.settings.reshapeManipulators.vertex.bindColorMaterial("outlineColor",this._vertexManipulatorOutlineMaterial),f.settings.reshapeManipulators.vertex.bindColorMaterial("hoverOutlineColor",this._vertexManipulatorHoverOutlineMaterial),f.settings.reshapeManipulators.edge.bindColorMaterial("color",this._edgeManipulatorMaterial),f.settings.reshapeManipulators.edge.bindColorMaterial("outlineColor",this._edgeManipulatorOutlineMaterial),f.settings.reshapeManipulators.selected.bindColorMaterial("color",this._selectedManipulatorMaterial),f.settings.reshapeManipulators.selected.bindColorMaterial("outlineColor",this._selectedManipulatorOutlineMaterial),f.settings.reshapeManipulators.selected.bindColorMaterial("hoverOutlineColor",this._selectedManipulatorHoverOutlineMaterial),this.view.trackGraphicState(t)])},t.prototype.destroy=function(){this._clear(),this._handles.destroy()},Object.defineProperty(t.prototype,"inputGeometry",{get:function(){return p.isSome(this._reshapeHelper)?this._reshapeHelper.geometry:null},set:function(e){this._recreateManipulators(e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"manipulators",{get:function(){return this.tool.manipulators},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"view",{get:function(){return this.tool.view},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"graphic",{get:function(){return this.tool.graphic},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"enableZ",{get:function(){return this.tool.enableZ},enumerable:!0,configurable:!0}),t.prototype.removeSelectedVertices=function(){var e=this._manipulatorInfos.filter((function(e){return e.manipulator.selected&&"vertex"===e.handle.type}));this._removeVertices(e)},t.prototype.manipulatorSelectionChanged=function(){this.emit("manipulators-changed")},t.prototype._clear=function(){this._moveManipulation&&this._moveManipulation.destroy(),this._graphicMoveManipulation&&this._graphicMoveManipulation.destroy(),this._manipulatorHandles.removeAll(),this.manipulators.removeAll(),this._manipulatorInfos=[],this._graphicMoveManipulation=null,this._moveManipulation=null,this._reshapeHelper=null,this._numGrabbing=0,this._numDragging=0},t.prototype._recreateManipulators=function(e){if(void 0===e&&(e=this.inputGeometry),this._clear(),this._reshapeHelper=x.createReshapeHelper(e,"global"===this.view.viewingMode),!p.isNone(this._reshapeHelper)){for(var t=m.getGraphicEffectiveElevationInfo(this.graphic),a=0,i=this._reshapeHelper.components;a<i.length;a++){for(var r=i[a],n=0,o=r.vertices;n<o.length;n++){var l=o[n];this._createPerVertexManipulator(l,t)}for(var s=0,u=r.edges;s<u.length;s++){var h=u[s];this._createPerVertexManipulator(h,t)}}this._createGraphicMoveManipulators(t)}},t.prototype._perGraphicManipulatorDragAction=function(e,t){if("end"!==t.action){for(var a=[],i=this._manipulatorInfos.some((function(e){return"vertex"===e.handle.type&&e.manipulator.selected})),r=1===e&&i,n=p.expect(this._reshapeHelper),o=0,l=this._manipulatorInfos;o<l.length;o++){"vertex"===(c=l[o]).handle.type&&(c.manipulator.grabbing||r&&!c.manipulator.selected||(p.expect(n).addDelta(c.handle,t.mapDeltaX,t.mapDeltaY,t.mapDeltaZ),a.push(c.handle.pos),this._updateManipulatorPosition(c)))}if(0!==a.length){for(var s=0,u=0,h=this._manipulatorInfos;u<h.length;u++){var c;"vertex"===(c=h[u]).handle.type&&s++}if(this.outputGeometry=n.commit(),a.length===s){if(this._updateEventState(1),this.destroyed)return;if(this.emit("move",{type:"move",dx:t.screenDeltaX,dy:t.screenDeltaY,mover:this.graphic}),this.destroyed)return}else{if(this._updateEventState(2),this.destroyed)return;if(this.emit("reshape",{type:"reshape",mover:this.graphic}),this.destroyed)return}}}},t.prototype._perVertexManipulatorDragAction=function(e,t){if(this._updateEventState(2),!this.destroyed){var a=t.mapDeltaX,i=t.mapDeltaY,r=t.mapDeltaZ;if(a||i||r){for(var n=[],o=0,l=this._manipulatorInfos;o<l.length;o++){var s=l[o];k(s)&&(s.manipulator.selected&&!s.manipulator.grabbing||s===e)&&n.push(s)}for(var u=p.expect(this._reshapeHelper),h=0,c=n;h<c.length;h++){var d=c[h];u.addDelta(d.handle,a,i,r)}this.outputGeometry=u.commit();for(var m=0,v=n;m<v.length;m++){d=v[m];this._updateManipulatorPosition(d)}this.emit("reshape",{type:"reshape",mover:this.graphic})}}},t.prototype._updateEventState=function(e){if(e===this._reshapeEventState)return!1;switch(e){case 0:if(0!==this._numGrabbing||0!==this._numDragging)return!1;switch(this._reshapeEventState){case 1:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic});break;case 2:this.emit("reshape",{type:"reshape-stop",mover:this.graphic})}break;case 1:switch(this._reshapeEventState){case 0:this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic});break;case 2:this.emit("reshape",{type:"reshape-stop",mover:this.graphic}),this.destroyed||this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic})}break;case 2:switch(this._reshapeEventState){case 0:this.emit("reshape",{type:"reshape-start",mover:this.graphic});break;case 1:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic}),this.destroyed||this.emit("reshape",{type:"reshape-start",mover:this.graphic})}}if(this.destroyed)return!1;var t=this._reshapeEventState!==e;return this._reshapeEventState=e,t},t.prototype._createGraphicMoveManipulators=function(e){var t=this;this._graphicMoveManipulation=new O.MoveXYGraphicManipulation({tool:this.tool,view:this.view,graphicState:this._graphicState}),this._manipulatorHandles.add(this._graphicMoveManipulation.createDragPipeline((function(e,a,i){a.next((function(e){return t._trackNumDragging(e)})).next((function(e){t._perGraphicManipulatorDragAction(0,e)})),i.next(t._cancelDragOperation())}))),this._graphicMoveManipulation.forEachManipulator((function(e){return t._manipulatorHandles.add([t._watchAndUpdateGrabState(e,!1),e.events.on("immediate-click",(function(e){t._manipulatorInfos.some((function(e){return e.manipulator.selected}))?t._clearSelection():t.emit("immediate-click"),e.stopPropagation()}))])})),this._moveManipulation=new S.MoveManipulation({tool:this.tool,view:this.view,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZ&&_.canMoveZ(this.graphic),snapToScene:!1,radius:S.MoveManipulation.radiusForSymbol(this.graphic.symbol)}),this._moveManipulation.forEachManipulator((function(e){t._handles.add([t._watchAndUpdateGrabState(e,!1),e.events.on("immediate-click",(function(a){t._moveManipulation.zManipulation.hasManipulator(e)||t._manipulatorInfos.some((function(e){return e.manipulator.selected}))||t.emit("immediate-click"),a.stopPropagation()}))])})),this._moveManipulation.elevationInfo={mode:"absolute-height",offset:0};var a=p.expect(this.graphic.geometry).spatialReference;this._handles.add([this._moveManipulation.createDragPipeline((function(e,a,i){a.next((function(e){return t._trackNumDragging(e)})).next(M.addMapDelta()).next((function(e){t._perGraphicManipulatorDragAction(1,e)})),i.next(t._cancelDragOperation())}),e,a),u.init(this._graphicState,"displaying",(function(e){t._moveManipulation.xyManipulation.available=e,t._moveManipulation.xyAxisManipulation.available=!0,t._moveManipulation.zManipulation.available=e&&t.enableZ&&_.canMoveZ(t.graphic),t._updateMoveManipulationPosition()})),this._graphicState.on("changed",(function(){return t._updateMoveManipulationPosition()}))]),this._updateMoveManipulationPosition();var i=y.createVisualElements({view:this.view,graphic:this.graphic,forEachManipulator:function(e){if(!t.destroyed){t._graphicMoveManipulation.forEachManipulator(e);for(var a=0,i=t._manipulatorInfos;a<i.length;a++){e(i[a].manipulator,1)}t._moveManipulation.forEachManipulator(e)}},onManipulatorsChanged:function(e){return t.on("manipulators-changed",e)}});this._outlineVisualElement=i.visualElement instanceof E.OutlineVisualElement?i.visualElement:null,p.isSome(this._outlineVisualElement)&&this._manipulatorHandles.add([this._outlineVisualElement.events.on("attachment-origin-changed",(function(){t._graphicState.isDraped||t._updateMoveManipulationPosition()})),this._graphicState.watch("isDraped",(function(){return t._updateMoveManipulationPosition()}))]),this._manipulatorHandles.add(i)},t.prototype._createPerVertexManipulator=function(e,t){var a=this;if(void 0===t&&(t=m.getGraphicEffectiveElevationInfo(this.graphic)),p.isNone(this._vertexManipulatorGeometry)||p.isNone(this._vertexManipulatorOutlineGeometry)){var i=f.settings.reshapeManipulators.vertex,r=(o=i.size/2)/(l=o+i.collisionPadding);this._vertexManipulatorGeometry=new w(D.createSphereGeometry(r,16,16),"reshape-manipulator");var n=(o+i.outlineSize)/l;this._vertexManipulatorOutlineGeometry=new w(D.createSphereGeometry(n,16,16),"reshape-manipulator-outline")}if(p.isNone(this._edgeManipulatorGeometry)||p.isNone(this._edgeManipulatorOutlineGeometry)){var o,l,u=f.settings.reshapeManipulators.edge;r=(o=u.size/2)/(l=o+u.collisionPadding);this._edgeManipulatorGeometry=new w(D.createSphereGeometry(r,16,16),"reshape-manipulator");n=(o+u.outlineSize)/l;this._edgeManipulatorOutlineGeometry=new w(D.createSphereGeometry(n,16,16),"reshape-manipulator-outline")}var h=new v.Manipulator3D({view:this.view,renderObjects:[{geometry:this._vertexManipulatorGeometry,material:this._vertexManipulatorMaterial,stateMask:4|C.Vertex},{geometry:this._vertexManipulatorOutlineGeometry,material:this._vertexManipulatorOutlineMaterial,stateMask:5|C.Vertex},{geometry:this._vertexManipulatorOutlineGeometry,material:this._vertexManipulatorHoverOutlineMaterial,stateMask:6|C.Vertex},{geometry:this._edgeManipulatorGeometry,material:this._vertexManipulatorMaterial,stateMask:6|C.Edge},{geometry:this._vertexManipulatorOutlineGeometry,material:this._vertexManipulatorHoverOutlineMaterial,stateMask:6|C.Edge},{geometry:this._edgeManipulatorGeometry,material:this._edgeManipulatorMaterial,stateMask:5|C.Edge},{geometry:this._edgeManipulatorOutlineGeometry,material:this._edgeManipulatorOutlineMaterial,stateMask:5|C.Edge},{geometry:this._vertexManipulatorGeometry,material:this._selectedManipulatorMaterial,stateMask:8},{geometry:this._vertexManipulatorOutlineGeometry,material:this._selectedManipulatorOutlineMaterial,stateMask:9},{geometry:this._vertexManipulatorOutlineGeometry,material:this._selectedManipulatorHoverOutlineMaterial,stateMask:10}],elevationInfo:t,focusMultiplier:1,touchMultiplier:1,available:!(!this.graphic.visible||!this.graphic.layer.visible)});this._setTypeSpecificManipulatorSettings(h,e);var c="edge"===e.type?{manipulator:h,handle:e,locationUpdateHandle:null,type:"edge",selectedIndex:0}:{manipulator:h,handle:e,type:"vertex",selectedIndex:0};if(this._manipulatorInfos.push(c),this.manipulators.add(h),this._updateManipulatorPosition(c),"edge"===c.type){var d=this._getManipulatorInfoFromHandle(c.handle.v0).manipulator.events.on("location-update",(function(){return a._updateManipulatorPosition(c)})),g=this._getManipulatorInfoFromHandle(c.handle.v1).manipulator.events.on("location-update",(function(){return a._updateManipulatorPosition(c)}));c.locationUpdateHandle=s.handlesGroup([d,g]),this._manipulatorHandles.add(c.locationUpdateHandle,h)}this._manipulatorHandles.add(this._watchAndUpdateGrabState(h,!0),h);var _=M.createManipulatorDragEventPipeline(h,(function(e,t,i){t.next((function(e){return a._trackNumDragging(e)})).next((function(e){return A(c)&&a._splitEdgeManipulator(c),e})).next(M.screenToMapXYForGraphicAtLocation(a.view,a.graphic,e.elevationAlignedLocation,e.location.spatialReference)).next(M.addMapDelta()).next((function(e){"vertex"===c.type?a._perVertexManipulatorDragAction(c,e):console.error("drag operation on non-vertex manipulator not allowed")})),i.next(a._cancelDragOperation())}));return this._manipulatorHandles.add(_,h),this._manipulatorHandles.add([h.events.on("immediate-click",(function(e){return a._manipulatorClickCallback(e,c)})),h.events.on("select-changed",(function(){c.selectedIndex=++a._selectedIndex,a._updateMoveManipulationPosition()}))]),this.emit("manipulators-changed"),h},t.prototype._trackNumDragging=function(e){switch(e.action){case"start":this._numDragging++;break;case"end":this._numDragging--}return e},t.prototype._cancelDragOperation=function(){var e=this,t=p.isSome(this._reshapeHelper)?this._reshapeHelper.geometry.clone():null;return function(){switch(e._numDragging--,e.inputGeometry=t,e.outputGeometry=t,e._reshapeEventState){case 0:break;case 1:e.emit("move",{type:"move",dx:0,dy:0,mover:e.graphic});break;case 2:e.emit("reshape",{type:"reshape",mover:e.graphic})}e.destroyed||e._updateEventState(0)}},t.prototype._setTypeSpecificManipulatorSettings=function(e,t){switch(t.type){case"vertex":e.state=C.Vertex,e.selectable=!0,e.cursor="move",e.collisionPriority=2,e.radius=f.settings.reshapeManipulators.vertex.size/2+f.settings.reshapeManipulators.vertex.collisionPadding;break;case"edge":e.state=C.Edge,e.selectable=!1,e.cursor="copy",e.collisionPriority=-1,e.radius=f.settings.reshapeManipulators.edge.size/2+f.settings.reshapeManipulators.edge.collisionPadding;break;default:n.neverReached(t)}},t.prototype._watchAndUpdateGrabState=function(e,t){var a=this;return e.events.on("grab-changed",(function(i){if("start"===i.action)t&&a._updateSelection(e),a._numGrabbing++;else if(a._numGrabbing--,a._updateEventState(0),a.destroyed)return;a._moveManipulation.interactive=!a._numGrabbing}))},t.prototype._clearSelection=function(){for(var e=0,t=this._manipulatorInfos;e<t.length;e++){var a=t[e];a.manipulator.grabbing||(a.manipulator.selected=!1)}},t.prototype._updateSelection=function(e){e.grabbing&&!e.selected&&e.selectable&&(this._clearSelection(),e.selected=!0,this.emit("manipulators-changed"))},t.prototype._removeManipulator=function(e){e&&(this._manipulatorHandles.remove(e.manipulator),this._manipulatorInfos.splice(this._manipulatorInfos.indexOf(e),1),this.manipulators.remove(e.manipulator),this.emit("manipulators-changed"))},t.prototype._getManipulatorInfoFromHandle=function(e){if(e)for(var t=0,a=this._manipulatorInfos;t<a.length;t++){var i=a[t];if(e===i.handle)return i}return null},t.prototype._updateManipulatorPosition=function(e){if(e){var t=p.expect(this._reshapeHelper);if("vertex"===e.handle.type)e.manipulator.location=t.getVertexPositionAsPoint(e.handle,z),e.manipulator.grabbing&&p.isSome(this._vertexLaserLineVisualElement)&&(this._vertexLaserLineVisualElement.visualElement.intersectsWorldUpAtLocation=e.manipulator.renderLocation);else if("edge"===e.handle.type){var a=this._getManipulatorInfoFromHandle(e.handle.v0).manipulator.elevationAlignedLocation,i=this._getManipulatorInfoFromHandle(e.handle.v1).manipulator.elevationAlignedLocation,r=a.x+.5*(i.x-a.x),n=a.y+.5*(i.y-a.y),o=a.hasZ&&i.hasZ?a.z+.5*(i.z-a.z):void 0;e.manipulator.elevationAlignedLocation=d.makeDehydratedPoint(r,n,o,t.geometry.spatialReference)}}},t.prototype._splitEdgeManipulator=function(e){var t=p.expect(this._reshapeHelper),a=t.splitEdge(e.handle,.5);e.locationUpdateHandle.remove(),e.locationUpdateHandle=void 0;var i=e;i.handle=a,i.type="vertex",this._setTypeSpecificManipulatorSettings(e.manipulator,e.handle),a.left&&this._createPerVertexManipulator(a.left),a.right&&this._createPerVertexManipulator(a.right),this.outputGeometry=t.commit(),this._updateManipulatorPosition(i),this._updateSelection(e.manipulator);var r=t.coordinateHelper.toArray(i.handle.unnormalizedPos);this.emit("vertex-add",{type:"vertex-add",vertices:[{coordinates:r,componentIndex:p.expect(a.component.index),vertexIndex:p.expect(a.index)}],added:r})},t.prototype._updateMoveManipulationPosition=function(){var e=this,t=P.sv3d.get();c.vec3.set(t,0,0,0);for(var a=0,i=!1,r=null,n=null,o=0,l=this._manipulatorInfos;o<l.length;o++){var s=l[o];k(s)&&(s.manipulator.selected?(a++,c.vec3.add(t,t,s.manipulator.renderLocation),p.isNone(r)||s.selectedIndex>r.selectedIndex?(n=r,r=s):(p.isNone(n)||s.selectedIndex>n.selectedIndex)&&(n=s)):i=!0)}if(this._moveManipulation.xyAxisManipulation.orthogonalAvailable=!0,this._moveManipulation.xyAxisManipulation.available=!0,0!==a){var u=0;if(p.isSome(r)){var h=r.handle.unnormalizedPos,d=p.isSome(n)?n.handle.unnormalizedPos:r.handle.left&&r.handle.left.v0?r.handle.left.v0.unnormalizedPos:null,m=!p.isSome(n)&&r.handle.right&&r.handle.right.v1?r.handle.right.v1.unnormalizedPos:null;d&&m?this._moveManipulation.xyAxisManipulation.available=!1:d?u=V(d,h):m&&(u=V(h,m))}this._moveManipulation.xyAxisManipulation.orthogonalAvailable=1!==a,this._moveManipulation.angle=u,this._moveManipulation.radius=b.DISC_RADIUS_SMALL}else this._moveManipulation.angleDeferred=function(){return G.primaryShapeOrientation(p.expect(e.graphic.geometry))},this._moveManipulation.radius=S.MoveManipulation.radiusForSymbol(this.graphic.symbol);0!==a&&i?(c.vec3.scale(t,t,1/a),z.spatialReference=p.expect(this._reshapeHelper).geometry.spatialReference,this.view.renderCoordsHelper.fromRenderCoords(t,z),this._moveManipulation.elevationAlignedLocation=z):p.isSome(this._outlineVisualElement)&&!this._graphicState.isDraped&&p.isSome(this._outlineVisualElement.attachmentOrigin)?this._moveManipulation.elevationAlignedLocation=this._outlineVisualElement.attachmentOrigin:g.placeAtGraphic(this.view,this._moveManipulation,this.graphic)},t.prototype._removeVertices=function(e){for(var t=[],a=p.expect(this._reshapeHelper),i=0,r=e;i<r.length;i++){var n=r[i];if("vertex"===n.handle.type&&a.canRemoveVertex(n.handle)){t.push(n.handle),this._removeManipulator(n),this._removeManipulator(this._getManipulatorInfoFromHandle(n.handle.left)),this._removeManipulator(this._getManipulatorInfoFromHandle(n.handle.right));var o=a.removeVertex(n.handle);o&&this._createPerVertexManipulator(o)}}if(t.length>0){var l=t.map((function(e){return{coordinates:a.coordinateHelper.toArray(e.unnormalizedPos),componentIndex:p.expect(e.component.index),vertexIndex:p.expect(e.index)}}));this.outputGeometry=a.commit();var s=this._updateEventState(2);if(this.destroyed)return;if(this.emit("vertex-remove",{type:"vertex-remove",removed:l.map((function(e){return e.coordinates})),vertices:l}),this.destroyed)return;if(s&&(this._updateEventState(0),this.destroyed))return;this._updateMoveManipulationPosition()}},t.prototype._manipulatorClickCallback=function(e,t){e.shiftKey||this._clearSelection(),"vertex"===t.handle.type&&(t.manipulator.selected=!t.manipulator.selected),"vertex"===t.handle.type&&2===e.button&&this._removeVertices([t]),A(t)&&0===e.button&&this._splitEdgeManipulator(t),e.stopPropagation()},a([h.property({constructOnly:!0})],t.prototype,"tool",void 0),a([h.property()],t.prototype,"inputGeometry",null),a([h.property()],t.prototype,"outputGeometry",void 0),t=a([h.subclass("esri.views.3d.interactive.editingTools.graphicReshape3D.ReshapeOperation")],t)}(h.declared(o.EventedAccessor));function V(e,t){return Math.atan2(t[1]-e[1],t[0]-e[0])+Math.PI/2}function k(e){return"vertex"===e.handle.type}function A(e){return"edge"===e.handle.type}t.ReshapeOperation=I;var C,z=d.makeDehydratedPoint(0,0,null,null);!function(e){e.Vertex=16,e.Edge=32}(C||(C={}))}));