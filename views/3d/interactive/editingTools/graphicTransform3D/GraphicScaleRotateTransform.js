// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/decorateHelper","../../../../../core/tsSupport/declareExtendsHelper","../../../../../core/tsSupport/generatorHelper","../../../../../core/tsSupport/awaiterHelper","../../../../../core/tsSupport/assignHelper","../../../../../core/Evented","../../../../../core/Handles","../../../../../core/mathUtils","../../../../../core/maybe","../../../../../core/scheduling","../../../../../core/screenUtils","../../../../../core/watchUtils","../../../../../core/libs/gl-matrix-2/mat4","../../../../../core/libs/gl-matrix-2/mat4f64","../../../../../core/libs/gl-matrix-2/vec3","../../../../../core/libs/gl-matrix-2/vec3f64","../../../../../core/libs/gl-matrix-2/math/common","../../../../../support/elevationInfoUtils","../../Manipulator3D","../../manipulatorUtils","../manipulatorDragUtils","../manipulations/config","../../../support/geometryUtils","../../../support/mathUtils","../../../support/stack","../../../webgl-engine/lib/Geometry","../../../webgl-engine/lib/GeometryUtil","../../../webgl-engine/materials/ColorMaterial"],(function(t,e,a,r,o,i,n,s,l,c,u,d,p,g,h,m,R,f,S,D,I,v,_,A,T,y,E,M,N,b){var O;Object.defineProperty(e,"__esModule",{value:!0}),function(t){t.ScaleIn=32,t.ScaleOut=64,t.RotateLeft=128,t.RotateRight=256,t.Unlocked=1024,t.DelayedFocused=2048,t.TouchInput=32768}(O||(O={}));var C=function(){function t(t){var e=this;this.mode=null,this._handles=new l,this._scaleRotateDragData=null,this._activeAnimation=null,this.events=new s,this.getFocused=function(){return e.ringManipulator.focused},this.getScale=function(){return u.isSome(e._scaleRotateDragData)&&"scale"===e._scaleRotateDragData.mode?e._scaleRotateDragData.scale:1},this.tool=t.tool,this.mode=t.mode,this.createManipulator(),this.updateDragState(),this.updateManipulatorTransform()}return t.prototype.destroy=function(){u.isSome(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation=null),this._handles.removeAll(),this.tool.manipulators.remove(this.ringManipulator),this.ringManipulator=null},t.prototype.startAnimation=function(t){var e=this;this.cancelActiveAnimation(),t.start();var a=d.addFrameTask({update:function(a){var r=a.deltaTime;t.update(r)&&e.cancelActiveAnimation()}});this._activeAnimation=n({},t,{frameTask:a})},t.prototype.cancelActiveAnimation=function(){u.isSome(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation.destroy(),this._activeAnimation=null)},t.prototype.forEachManipulator=function(t){t(this.ringManipulator,2)},t.prototype.createManipulator=function(){var t=this;this.ringManipulator=this.createRingManipulator(),this.tool.manipulators.add(this.ringManipulator);var e=this.ringManipulator,a=this.tool.graphicState.graphic,r=_.createManipulatorDragEventPipeline(e,(function(e,r,o){t._scaleRotateDragData=null;var i=function(t,e){var a=t.allLayerViews.find((function(t){return t.layer===e.layer}));if(u.isNone(e.symbol))return null;var r=e.symbol;return{symbolLayers:r.symbolLayers.map((function(t){var e=null;return"object"===t.type&&(e=t.heading),{heading:e,size:a.getSymbolLayerSize(r,t)}})).toArray()}}(t.tool.view,a);if(u.isNone(i))return t.updateDragState(),null;var n={mode:"none",origin:f.vec3f64.clone(e.renderLocation),angle:0,startAngle:t.tool.symbolRotationAngle,angleDir:0,scale:1,scaleDir:0,startSymbolData:i};t._scaleRotateDragData=n,t.updateDragState();var s=E.sv3d.get();t.tool.view.renderCoordsHelper.worldUpAtPosition(e.renderLocation,s),r.next(_.screenToRenderPlane(t.tool.view,T.plane.fromPositionAndNormal(e.renderLocation,s))).next((function(e){var r=e.plane,o=v.calculateInputRotationTransform(e.renderStart,e.renderEnd,n.origin,r),i=y.cyclicalPI.shortestSignedDiff(n.angle,o);n.angleDir=c.clamp(n.angleDir+i,-A.ROTATE_INDICATOR_DIRECTION_BUFFER,A.ROTATE_INDICATOR_DIRECTION_BUFFER),n.angle=o;var s=function(t,e){var a=R.vec3.subtract(E.sv3d.get(),e.renderStart,t.origin),r=R.vec3.subtract(E.sv3d.get(),e.renderEnd,t.origin),o=R.vec3.length(a),i=R.vec3.length(r);if(0===o)return 0;return i/o}(n,e),l=s-n.scale;if(n.scaleDir=c.clamp(n.scaleDir+l,-A.SCALE_INDICATOR_DIRECTION_BUFFER,A.SCALE_INDICATOR_DIRECTION_BUFFER),n.scale=s,t.onScaleChanged(),"none"===n.mode){var d=t.mode||function(t,e,a,r){var o=t.renderStart,i=t.renderEnd,n=F(o,r,E.sv3d.get()),s=F(i,r,E.sv3d.get());if(R.vec3.squaredDistance(n,s)<A.DRAG_THRESHOLD_PX*A.DRAG_THRESHOLD_PX)return null;var l=R.vec3.subtract(E.sv3d.get(),o,a),c=R.vec3.cross(E.sv3d.get(),l,e),u=o,d=R.vec3.add(E.sv3d.get(),u,c),p=F(a,r,E.sv3d.get()),g=n,h=F(d,r,E.sv3d.get()),m=R.vec3.subtract(E.sv3d.get(),h,g),f=R.vec3.subtract(E.sv3d.get(),n,p),S=T.ray.wrap(g,m),D=T.ray.wrap(p,f);if(T.ray.distance2(S,s)<T.ray.distance2(D,s))return"rotate";return"scale"}(e,e.plane,n.origin,t.tool.view.state.camera);if(u.isSome(d)){switch(d){case"rotate":t.tool.emit("graphic-rotate-start",{graphic:a,angle:n.angle});break;case"scale":t.tool.emit("graphic-scale-start",{graphic:a,scale:n.scale})}n.mode=d}}if(t.updateDragState(),u.isSome(a.symbol)){var p=a.symbol.clone(),g=0,h=1;switch(n.mode){default:case"none":break;case"scale":h=n.scale;break;case"rotate":g=n.angle}t.applySymbolData(p,n.startSymbolData,g,h),a.symbol=p,t.updateManipulatorTransform()}switch(e.action){case"start":case"update":switch(n.mode){case"rotate":t.tool.emit("graphic-rotate",{graphic:a,angle:n.angle});break;case"scale":t.tool.emit("graphic-scale",{graphic:a,scale:n.scale})}break;case"end":switch(n.mode){case"rotate":t.tool.emit("graphic-rotate-stop",{graphic:a,angle:n.angle});break;case"scale":t.tool.emit("graphic-scale-stop",{graphic:a,scale:n.scale});break;default:case"none":}}"end"===e.action&&(t.startAnimation(w(t,(function(){return t.onScaleChanged()}))),t._scaleRotateDragData=null,t.updateDragState())})),o.next(_.resetSymbol(a)).next((function(){if(u.isSome(t._scaleRotateDragData)){switch(t._scaleRotateDragData.mode){case"none":break;case"rotate":t.tool.emit("graphic-rotate-stop",{graphic:a,angle:t._scaleRotateDragData.startAngle});break;case"scale":t.tool.emit("graphic-scale-stop",{graphic:a,scale:1})}t.startAnimation(w(t,(function(){return t.onScaleChanged()}))),t._scaleRotateDragData=null}}))}));this._handles.add(r),this._handles.add([this.ringManipulator.events.on("focus-changed",(function(e){var a,r,o,i,n;"focus"===e.action?t.startAnimation((a=t,r=function(){return t.updateDelayedFocusedState()},o=0,i=null,n=function(){return!1},{start:function(){i=a.getFocused,a.getFocused=n,o=0,r()},update:function(t){return o+=t,!i()||o>A.RING_INDICATOR_DELAY_MS?1:0},destroy:function(){a.getFocused=i,r()}})):t.updateDelayedFocusedState()})),this.ringManipulator.events.on("immediate-click",(function(t){t.stopPropagation()})),g.init(this.tool.graphicState,"displaying",(function(e){return t.ringManipulator.available=e})),this.tool.graphicState.on("changed",(function(){return v.placeAtGraphic(t.tool.view,t.ringManipulator,a)}))]),v.placeAtGraphic(this.tool.view,this.ringManipulator,a)},t.prototype.onScaleChanged=function(){this.events.emit("scale-changed"),this.updateManipulatorTransform()},t.prototype.updateDelayedFocusedState=function(){this.ringManipulator.updateStateEnabled(O.DelayedFocused,this.getFocused())},t.prototype.updateDragState=function(){if(this.ringManipulator.updateStateEnabled(O.Unlocked,!(u.isSome(this._scaleRotateDragData)&&"none"!==this._scaleRotateDragData.mode)),u.isSome(this._scaleRotateDragData))switch(this._scaleRotateDragData.mode){case"rotate":this.ringManipulator.updateStateEnabled(O.ScaleIn|O.ScaleOut,!1),this.ringManipulator.updateStateEnabled(O.RotateLeft,this._scaleRotateDragData.angleDir<0),this.ringManipulator.updateStateEnabled(O.RotateRight,this._scaleRotateDragData.angleDir>=0);break;case"scale":this.ringManipulator.updateStateEnabled(O.RotateLeft|O.RotateRight,!1),this.ringManipulator.updateStateEnabled(O.ScaleIn,this._scaleRotateDragData.scaleDir<0),this.ringManipulator.updateStateEnabled(O.ScaleOut,this._scaleRotateDragData.scaleDir>=0)}else this.ringManipulator.updateStateEnabled(O.ScaleIn|O.ScaleOut|O.RotateLeft|O.RotateRight,!1)},t.prototype.updateManipulatorTransform=function(){var t=h.mat4.identity(E.sm4d.get()),e=this.tool.symbolRotationAngle;h.mat4.rotate(t,t,e,f.vec3f64.fromValues(0,0,1));var a=this.getScale(),r=h.mat4.fromScaling(E.sm4d.get(),R.vec3.set(E.sv3d.get(),a,a,a)),o=h.mat4.identity(E.sm4d.get());h.mat4.multiply(o,r,t),this.ringManipulator.modelTransform=o},t.prototype.createRingManipulator=function(){for(var t=function(t,e,a){for(var r=[],o=Math.ceil(A.GEOMETRY_SEGMENTS*(e-t)/(2*Math.PI)),i=0;i<o+1;i++){var n=t+i*(e-t)/o;r.push(f.vec3f64.fromValues(a*Math.cos(n),a*Math.sin(n),0))}return r},e=function(e){return t(0,2*Math.PI,e)},a=function(t,e){return new M(N.createPathExtrusionGeometry(function(t){return[[-t/2,0],[t/2,0],[t/2,A.RING_HEIGHT/2],[-t/2,A.RING_HEIGHT/2]]}(e),t,[],[],!1),"graphic-transform-ring")},r=e(A.RING_RADIUS),o=a(r,A.RING_THICKNESS),i={left:[],right:[]},n=[],s=0;s<2;s++){var l=(T=s*Math.PI-Math.PI/4)+(y=Math.PI/2-A.ROTATE_INDICATOR_ARC_LENGTH),c=T+Math.PI/2-y,u=a(E=t(l,c,A.INNER_INDICATOR_RADIUS),A.INDICATOR_THICKNESS);n.push(E),n.push(t(l,c,A.OUTER_INDICATOR_RADIUS-A.RING_THICKNESS/2)),i.left.push(u),i.right.push(u);for(var d=0;d<2;d++){var p=0===d,g=m.mat4f64.create();if(p){h.mat4.scale(g,g,[1,-1,1]),h.mat4.rotate(g,g,-l,[0,0,1]);var R=Math.round(A.ROTATE_INDICATOR_ARROW_PLACEMENT_PERCENTAGE*(E.length-1));g[12]=E[R][0],g[13]=E[R][1],g[14]=E[R][2]}else{h.mat4.rotate(g,g,c,[0,0,1]);R=Math.round((1-A.ROTATE_INDICATOR_ARROW_PLACEMENT_PERCENTAGE)*(E.length-1));g[12]=E[R][0],g[13]=E[R][1],g[14]=E[R][2]}var S=N.createExtrudedTriangle(A.ROTATE_INDICATOR_ARROW_TIP_LENGTH,0,A.ROTATE_INDICATOR_ARROW_TIP_RADIUS,A.RING_HEIGHT);N.transformInPlace(S,g);var v=new M(S,"graphic-transform-ring-rotate");(p?i.left:i.right).push(v)}}var _=[];for(s=0;s<2;s++){l=(T=s*Math.PI-Math.PI/4)+(y=Math.PI/2-A.SCALE_INDICATOR_ARC_LENGTH),c=T+Math.PI/2-y;var T,y,E=t(l,c,A.OUTER_INDICATOR_RADIUS);_.push(a(E,A.INDICATOR_THICKNESS))}var b=e(A.RING_RADIUS+A.SCALE_INDICATOR_OFFSET1),C=e(A.RING_RADIUS+A.SCALE_INDICATOR_OFFSET2),F=a(b,A.INDICATOR_THICKNESS),w=a(C,A.INDICATOR_THICKNESS),P=e(A.RING_RADIUS-A.SCALE_INDICATOR_OFFSET1),G=e(A.RING_RADIUS-A.SCALE_INDICATOR_OFFSET2),L=a(P,A.INDICATOR_THICKNESS),k=a(G,A.INDICATOR_THICKNESS),H=this.createMaterial(),U=this.createMaterial(.66),x=this.createMaterial(.5),K=this.createMaterial(.33),z=[{geometry:o,material:H,stateMask:O.DelayedFocused},{geometry:o,material:x,stateMask:0}];this.mode&&"scale"!==this.mode||(z=z.concat([{geometry:_,material:H,stateMask:O.DelayedFocused|O.Unlocked},{geometry:F,material:U,stateMask:O.DelayedFocused|O.ScaleIn},{geometry:w,material:K,stateMask:O.DelayedFocused|O.ScaleIn},{geometry:L,material:U,stateMask:O.DelayedFocused|O.ScaleOut},{geometry:k,material:K,stateMask:O.DelayedFocused|O.ScaleOut}])),this.mode&&"rotate"!==this.mode||(z=z.concat([{geometry:i.right,material:H,stateMask:O.DelayedFocused|O.Unlocked},{geometry:i.left,material:H,stateMask:O.DelayedFocused|O.RotateLeft},{geometry:i.right,material:H,stateMask:O.DelayedFocused|O.RotateRight}]));var j=[r].concat(n);return new I.Manipulator3D({view:this.tool.view,renderObjects:z,autoScaleRenderObjects:!1,worldOriented:!0,radius:A.RING_THICKNESS,focusMultiplier:1,touchMultiplier:1.5,elevationInfo:D.getGraphicEffectiveElevationInfo(this.tool.graphicState.graphic),collisionType:{type:"ribbon",paths:j,direction:f.vec3f64.fromValues(0,0,1)}})},t.prototype.createMaterial=function(t){void 0===t&&(t=1);var e=A.HANDLE_COLOR.concat([t]),a=new b({color:e,transparent:1!==t,cullFace:2},"graphic-transform");return a.renderOccluded=2,a},t.prototype.applySymbolData=function(t,e,a,r){var o=this;t.symbolLayers.forEach((function(t,i){var n=e.symbolLayers[i],s=n.heading,l=n.size;"object"===t.type&&(t.heading=(u.isSome(s)?s:0)-S.toDegree(a),u.isSome(l)&&"width"in l&&(l.width=o.enforceNonZeroSize(l.width),l.height=o.enforceNonZeroSize(l.height),l.depth=o.enforceNonZeroSize(l.depth),t.width=l.width*r,t.depth=l.depth*r,t.height=l.height*r))}))},t.prototype.enforceNonZeroSize=function(t){return t||this.tool.view.state.camera.computeRenderPixelSizeAt(this.ringManipulator.renderLocation)},Object.defineProperty(t.prototype,"test",{get:function(){return{ringManipulator:this.ringManipulator}},enumerable:!0,configurable:!0}),t}();function F(t,e,a){var r=e.projectPoint(t,p.castRenderScreenPointArray(P)),o=e.renderToScreen(r,G);return R.vec3.set(a,o[0],o[1],0)}function w(t,e){var a=null,r=1,o=function(){return r};return{start:function(){r=t.getScale(),a=t.getScale,t.getScale=o,e()},update:function(t){return r+=((r+1)/2-r)*Math.min(t*A.RING_RESET_ANIMATION_SPEED_FACTOR,1),e(),Math.abs(r-1)<.01?1:0},destroy:function(){t.getScale=a,e()}}}e.GraphicScaleRotateTransform=C;var P=f.vec3f64.create(),G=p.createScreenPointArray()}));