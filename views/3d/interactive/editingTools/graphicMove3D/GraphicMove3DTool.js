// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/decorateHelper","../../../../../core/tsSupport/declareExtendsHelper","../../../../../core/tsSupport/assignHelper","../../../../../core/Collection","../../../../../core/Evented","../../../../../core/Handles","../../../../../core/handleUtils","../../../../../core/maybe","../../../../../core/accessorSupport/decorators","../../../../../layers/graphics/dehydratedFeatures","../../../../../support/elevationInfoUtils","../../manipulatorUtils","../manipulatorDragUtils","../manipulatorUtils","../settings","../visualElementUtils","./isSupportedGraphic","../manipulations/config","../manipulations/MoveManipulation","../manipulations/moveUtils","../manipulations/MoveXYGraphicManipulation","../../visualElements/OutlineVisualElement","../../../layers/graphics/GraphicState","../../../../interactive/InteractiveToolBase"],(function(t,e,a,n,i,o,r,l,s,p,u,c,h,d,v,g,f,m,M,y,_,b,w,E,x,G){Object.defineProperty(e,"__esModule",{value:!0});var S=function(t){this.allGraphics=t,this.type="graphic-move-start"};e.GraphicMoveStartEvent=S;var D=function(t,e,a,n){this.dx=t,this.dy=e,this.dz=a,this.allGraphics=n,this.type="graphic-move"};e.GraphicMoveEvent=D;var A=function(t){this.allGraphics=t,this.type="graphic-move-stop"};e.GraphicMoveStopEvent=A;var O=function(t){function e(e){var a=t.call(this,e)||this;return a.graphics=new o,a.enableZ=!0,a.type="move-3d",a._toolHandles=new l,a._handles=new l,a}return n(e,t),e.prototype.initialize=function(){var t=this;this._toolHandles.add([this.graphics.on("change",(function(){t._refreshManipulators()})),f.settings.zManipulator.watch(f.settings.zManipulator.keys(),(function(){return t._refreshManipulators()}))]),this._refreshManipulators()},e.prototype.destroy=function(){this._handles.destroy(),this._handles=null,this._toolHandles.destroy(),this._toolHandles=null,this.graphics.removeAll(),this._set("view",null)},e.prototype.reset=function(){},e.prototype._refreshManipulators=function(){var t=this;this._handles.removeAll(),this._moveManipulation&&this._moveManipulation.destroy(),this.manipulators.removeAll();var e=this.graphics.toArray().filter((function(t){return 0===M.isSupportedGraphic(t)})).map((function(t){return new X(t)}));e.length&&(this.createManipulators(e),this.createVisualElements(e),this._handles.add(e.map((function(e){return t.view.trackGraphicState(e.state)}))),this.updateMoveManipulation(e))},e.prototype.createManipulators=function(t){for(var e=this,a=function(a){var o=a.state;a.manipulationXY=new w.MoveXYGraphicManipulation({tool:n,view:n.view,graphicState:o}),a.manipulationXY.forEachManipulator((function(t){return e._handles.add(t.events.on("immediate-click",(function(t){e.emit("immediate-click",i({},t,{graphic:o.graphic})),t.stopPropagation()})))})),n._handles.add(a.manipulationXY.createDragPipeline((function(a,n,i){return e.buildDragEventPipeline(a,n,i,t)})))},n=this,o=0,r=t;o<r.length;o++){a(r[o])}this.createMoveManipulation(t)},e.prototype.createMoveManipulation=function(t){var e=this,a=new _.MoveManipulation({tool:this,view:this.view,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:1===t.length?_.MoveManipulation.radiusForSymbol(t[0].graphic.symbol):y.DISC_RADIUS});this._moveManipulation=a,a.elevationInfo={mode:"absolute-height",offset:0},a.forEachManipulator((function(t){e._handles.add(t.events.on("immediate-click",(function(n){a.zManipulation.hasManipulator(t)||1!==e.graphics.length||e.emit("immediate-click",i({},n,{graphic:e.graphics.getItemAt(0)})),n.stopPropagation()})))}));for(var n=function(){return e.updateMoveManipulation(t)},o=0,r=t;o<r.length;o++){var l=r[o];this._handles.add([l.state.on("changed",n),l.state.watch("displaying",n)])}var s=t[t.length-1];this._handles.add(s.state.on("changed",(function(){return e.updateMoveManipulationAngle(s)}))),this._handles.add(a.createDragPipeline((function(a,n,i){e.buildDragEventPipeline(a,n,i,t)}),h.getGraphicEffectiveElevationInfo(s.graphic),p.expect(s.graphic.geometry).spatialReference)),this.updateMoveManipulationAngle(s)},e.prototype.createVisualElements=function(t){for(var e=this,a=function(a){var i=a.graphic,o=m.createVisualElements({view:n.view,graphic:i,forEachManipulator:function(t){a.manipulationXY.forEachManipulator(t),e._moveManipulation.forEachManipulator(t)},onManipulatorsChanged:function(){return s.makeHandle()}});a.geometryRepresentation=o.visualElement,a.geometryRepresentation instanceof E.OutlineVisualElement&&n._handles.add([a.geometryRepresentation.events.on("attachment-origin-changed",(function(){a.state.isDraped||e.updateMoveManipulation(t)})),a.state.watch("isDraped",(function(){return e.updateMoveManipulation(t)}))]),n._handles.add(o)},n=this,i=0,o=t;i<o.length;i++){a(o[i])}},e.prototype.updateMoveManipulationAngle=function(t){this._moveManipulation.angleDeferred=function(){return b.primaryShapeOrientation(t.graphic.geometry)}},e.prototype.updateMoveManipulation=function(t){for(var e=c.makeDehydratedPoint(0,0,0,this.view.spatialReference),a=0,n=!1,i=this._moveManipulation,o=0,r=t;o<r.length;o++){var l=r[o];if(l.state.displaying){var s=l.state.graphic;this.enableZ&&g.canMoveZ(s)&&(n=!0);var u=l.geometryRepresentation instanceof E.OutlineVisualElement&&!l.state.isDraped?l.geometryRepresentation.attachmentOrigin:d.getGraphicAttachmentOrigin(this.view,s);p.isSome(u)&&(e.x+=u.x,e.y+=u.y,e.z+=u.z,a++)}}a>0?(e.x/=a,e.y/=a,e.z/=a,i.location=e,i.xyManipulation.available=!0,i.xyAxisManipulation.available=!0,i.zManipulation.available=n):i.available=!1},e.prototype.buildDragEventPipeline=function(t,e,a,n){var i=this,o=[],r=[],l=null,s=null,p=function(){for(var t=0,e=o;t<e.length;t++){e[t].dragging=!1}o.length=0,r.length=0,l=null,s=null,i._moveManipulation.interactive=!0};e.next((function(e){if("start"===e.action){o.length=0,r.length=0;for(var a=0,p=n;a<p.length;a++){var u=p[a];u.dragging||!u.manipulationXY.hasManipulator(t)&&u.manipulationXY.grabbing||(o.push(u),r.push(u.graphic),u.dragging=!0)}if(0!==r.length&&(i._moveManipulation.interactive=!1,l=v.dragGraphicMany(r),s=v.resetGraphicMany(r),i.emit("graphic-move-start",new S(r)),i.destroyed))return null}return 0!==r.length?e:null})).next((function(t){return l(t)})).next((function(t){switch(t.action){case"start":case"update":if((t.translationX||t.translationY||t.translationZ)&&(i.emit("graphic-move",new D(t.translationX,t.translationY,t.translationZ,r)),i.destroyed))return null;break;case"end":if(i.emit("graphic-move-stop",new A(r)),i.destroyed)return null;p()}})),a.next((function(t){return s(t)})).next((function(){if(i.emit("graphic-move-stop",new A(r)),i.destroyed)return null;p()}))},a([u.property({constructOnly:!0,nonNullable:!0})],e.prototype,"view",void 0),a([u.property({readOnly:!0})],e.prototype,"graphics",void 0),a([u.property({constructOnly:!0,nonNullable:!0})],e.prototype,"enableZ",void 0),a([u.property({readOnly:!0})],e.prototype,"type",void 0),e=a([u.subclass("esri.views.3d.interactive.editingTools.graphicMove3D.GraphicMove3DTool")],e)}(u.declared(r.EventedMixin(G.InteractiveToolBase)));e.GraphicMove3DTool=O;var X=function(){function t(t){this.state=null,this.geometryRepresentation=null,this.manipulationXY=null,this.dragging=!1,this.state=new x.GraphicState({graphic:t})}return Object.defineProperty(t.prototype,"graphic",{get:function(){return this.state.graphic},enumerable:!0,configurable:!0}),t}()}));