// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/assignHelper","../../../../core/tsSupport/extendsHelper","../../../../geometry","../../../../core/handleUtils","../../../../core/mathUtils","../../../../core/mathUtils","../../../../core/maybe","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../../../geometry/support/webMercatorUtils","../../../../support/elevationInfoUtils","../../support/geometryUtils","../../support/geometryUtils","../../support/projectionUtils","../../support/stack","../../../draw/support/drawUtils"],(function(e,r,n,t,a,o,c,i,u,l,s,p,d,m,f,v,S,y,E){function x(e,r){var n=null,t=null;return e.events.on("drag",(function(a){if("cancel"!==a.action){var o={action:a.action,screenStart:a.start,screenEnd:a.screenPoint};"start"===a.action&&u.isNone(n)&&(n=new U,t=new U,r(e,n,t,o)),u.isSome(n)&&n.execute(o),"end"===a.action&&u.isSome(n)&&(n=null,t=null)}else u.isSome(t)&&(t.execute({}),n=null,t=null)}))}function g(e,r){var t=p.vec3f64.create(),a=p.vec3f64.create(),o=!1;return function(c){if("start"===c.action){var i=l.screenPointObjectToArray(c.screenStart,l.castScreenPointArray(y.sv2d.get())),u=v.ray.fromScreen(e.state.camera,i,j);o=v.plane.intersectRay(r,u,t)}if(!o)return null;var s=l.screenPointObjectToArray(c.screenEnd,l.castScreenPointArray(y.sv2d.get())),p=v.ray.fromScreen(e.state.camera,s,j);return v.plane.intersectRay(r,p,a)?n({},c,{renderStart:t,renderEnd:a,plane:r}):null}}function h(e,r,t,a){void 0===a&&(a=null);var o=null;return function(c){if("start"===c.action&&(o=e.sceneIntersectionHelper.intersectElevationFromScreen(l.createScreenPointArray(c.screenStart.x,c.screenStart.y),r,t),u.isSome(o)&&u.isSome(a)&&!S.pointToPoint(o,o,a)))return null;if(u.isNone(o))return null;var i=e.sceneIntersectionHelper.intersectElevationFromScreen(l.createScreenPointArray(c.screenEnd.x,c.screenEnd.y),r,t);return u.isSome(i)?u.isSome(a)&&!S.pointToPoint(i,i,a)?null:n({},c,{mapStart:o,mapEnd:i}):null}}function P(e,r,n,t){return void 0===t&&(t=null),h(e,n,m.getZForElevationMode(r,e,n),t)}function M(e,r,n,t){return void 0===t&&(t=null),P(e,n,m.getGraphicEffectiveElevationInfo(r),t)}function w(e,r){var t=null,a=u.isSome(e[r])?e[r].spatialReference:null;return function(o){var c,i;if("start"===o.action&&u.isSome(e[r])&&(c=e[r],i=o.mapStart.spatialReference,t=u.isNone(c)||"mesh"===c.type?null:c.spatialReference.equals(i)?c.clone():d.canProject(c,i)?d.project(c,i):null),u.isNone(t))return null;var l=o.mapEnd.x-o.mapStart.x,s=o.mapEnd.y-o.mapStart.y,p=o.mapEnd.z-o.mapStart.z,m=E.move(t.clone(),l,s,p);return m.spatialReference.equals(a)?e[r]=m:e[r]=d.project(m,a),n({},o,{translationX:l,translationY:s,translationZ:p})}}function b(e){return w(e,"geometry")}function D(e){var r=u.isSome(e.geometry)?e.geometry.clone():null;return function(n){return e.geometry=r,n}}function A(e,r){var n=p.vec3f64.create(),t=s.vec3.length(r);e.renderCoordsHelper.worldUpAtPosition(r,n);var a=p.vec3f64.create(),o=p.vec3f64.create(),c=function(a){(s.vec3.subtract(a,a,r),f.vector.projectPoint(n,a,a),"global"===e.viewingMode)&&(s.vec3.length(a)*i.sign(s.vec3.dot(n,a))<.001-t&&s.vec3.subtract(a,s.vec3.scale(a,n,.001),r));return s.vec3.add(a,a,r),a};return function(e){return e.renderStart=c(s.vec3.copy(a,e.renderStart)),e.renderEnd=c(s.vec3.copy(o,e.renderEnd)),e}}function T(e,r){var t=e.renderCoordsHelper;return function(e){var o=t.fromRenderCoords(e.renderStart,new a.Point,r),c=t.fromRenderCoords(e.renderEnd,new a.Point,r);return u.isSome(o)&&u.isSome(c)?n({},e,{mapStart:o,mapEnd:c}):null}}Object.defineProperty(r,"__esModule",{value:!0}),r.createManipulatorDragEventPipeline=x,r.createManipulatorDragEventPipelineMany=function(e,r){for(var n=[],t=0,a=e;t<a.length;t++){var c=a[t];n.push(x(c,r))}return o.handlesGroup(n)},r.screenToRenderPlane=g,r.screenToMapXY=h,r.screenToMapXYAtLocation=P,r.screenToMapXYForGraphicAtLocation=M,r.screenToMapXYForGraphic=function(e,r,n,t){var a=r.toMap(e.screenStart,{include:[n]});return u.isSome(a)?M(r,n,a,t):null},r.screenToZConstrained=function(e,r,n){var t=null,a=new U;return a.next(g(e,function(e,r){var n=R,t=F,a=v.plane.create();e.renderCoordsHelper.worldUpAtPosition(r,n);var o=s.vec3.cross(a,n,s.vec3.subtract(t,r,e.state.camera.eye));return s.vec3.cross(o,o,n),v.plane.fromPositionAndNormal(r,o,a)}(e,r))).next(A(e,r)).next(T(e,n)).next((function(e){e.mapEnd.x=e.mapStart.x,e.mapEnd.y=e.mapStart.y,t=e})),function(e){return t=null,a.execute(e),t}},r.constrainToMapAxis=function(e,r){var n=[e.x,e.y,e.z],t=r,a=[Math.cos(t),Math.sin(t)],o=Math.sqrt(a[0]*a[0]+a[1]*a[1]);if(0===o)return null;a[0]/=o,a[1]/=o;var c=function(e){var r=(e.x-n[0])*a[0]+(e.y-n[1])*a[1];e.x=n[0]+r*a[0],e.y=n[1]+r*a[1]};return function(e){return c(e.mapStart),c(e.mapEnd),e}},r.dragGeometry=w,r.dragGraphic=b,r.dragGraphicMany=function(e){var r=e.map((function(e){return u.unwrap(b(e))})).filter((function(e){return u.isSome(e)}));return function(e){var t=e.mapEnd.x-e.mapStart.x,a=e.mapEnd.y-e.mapStart.y,o=e.mapEnd.z-e.mapStart.z;return r.forEach((function(r){return r(e)})),n({},e,{translationX:t,translationY:a,translationZ:o})}},r.resetGraphic=D,r.resetGraphicMany=function(e){var r=e.map((function(e){return u.unwrap(D(e))})).filter((function(e){return u.isSome(e)}));return function(e){return r.forEach((function(r){return r(e)})),e}},r.resetSymbol=function(e){var r=u.isSome(e.symbol)?e.symbol.clone():null;return function(n){return e.symbol=r,n}},r.horizontalDegreesOfFreedom=3,r.verticalDegreesOfFreedom=4,r.allDegreesOfFreedom=7,r.addMapDelta=function(e){void 0===e&&(e=r.allDegreesOfFreedom);var t=0,a=0,o=0;return function(r){"start"===r.action&&(t=r.mapStart.x,a=r.mapStart.y,o=r.mapStart.z);var c=1&e?r.mapEnd.x-t:0,i=2&e?r.mapEnd.y-a:0,u=4&e?r.mapEnd.z-o:0;return t=r.mapEnd.x,a=r.mapEnd.y,o=r.mapEnd.z,n({},r,{mapDeltaX:c,mapDeltaY:i,mapDeltaZ:u,mapDeltaSpatialReference:r.mapStart.spatialReference})}},r.addScreenDelta=function(e){void 0===e&&(e=r.allDegreesOfFreedom);var t=0,a=0;return function(r){"start"===r.action&&(t=r.screenStart.x,a=r.screenStart.y);var o=1&e?r.screenEnd.x-t:0,c=2&e?r.screenEnd.y-a:0;return t=r.screenEnd.x,a=r.screenEnd.y,n({},r,{screenDeltaX:o,screenDeltaY:c})}},r.dragAtLocation=function(e,r){var n=null,t=0,a=0;return function(o){if("start"===o.action&&((n=e.toScreen(r)).x<0||n.x>e.width||n.y<0||n.y>e.height?n=null:(t=o.screenStart.x-n.x,a=o.screenStart.y-n.y)),null==n)return null;var i=c.clamp(o.screenEnd.x-t,0,e.width),u=c.clamp(o.screenEnd.y-a,0,e.height),s=l.createScreenPoint(i,u);return o.screenStart=n,o.screenEnd=s,o}},r.projectToWorldUp=A,r.convertToMapCoordinates=T;var U=function(){function e(){this.execute=function(){}}return e.prototype.next=function(r,n){return void 0===n&&(n=new e),u.isSome(r)&&(this.execute=function(e){var t=r(e);u.isSome(t)&&n.execute(t)}),n},e}();r.EventPipeline=U;var R=p.vec3f64.create(),F=p.vec3f64.create(),j=v.ray.create()}));