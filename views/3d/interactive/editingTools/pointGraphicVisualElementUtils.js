// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/decorateHelper","../../../../core/tsSupport/declareExtendsHelper","../../../../core/compilerUtils","../../../../core/handleUtils","../../../../core/mathUtils","../../../../core/maybe","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/aaBoundingRect","../../../../support/elevationInfoUtils","./ManipulatorState","./settings","../visualElements/LaserlineVisualElement","../visualElements/LineVisualElement","../visualElements/PointVisualElement","../../layers/graphics/elevationAlignmentUtils","../../layers/graphics/ElevationContext","../../layers/graphics/GraphicState","../../support/projectionUtils"],(function(e,t,a,n,i,l,s,r,o,c,u,p,g,d,h,v,m,f,b,y,E,w){function S(e){return r.isSome(e.geometry)&&"point"===e.geometry.type}Object.defineProperty(t,"__esModule",{value:!0}),t.createVisualElements=function(e){var t=e.view,a=e.graphic,n=new E.GraphicState({graphic:a}),c=[],L=function(e,t,a){var n=e.view,i=e.graphic,s=new f.PointVisualElement({view:n,geometry:S(i)?i.geometry:null,elevationInfo:g.getGraphicEffectiveElevationInfo(i),attached:!1});return function(e,t,a,n){var i=function(){t.attached=a.displaying&&h.settings.visualElements.pointGraphics.outlineEnabled};(function(e,t,a,n){var i=e.view,s=e.graphic,o=null,c=function(){r.isSome(o)&&(o.remove(),o=null),a.isDraped&&S(s)&&(o=function(e,t,a){var n=e.elevationProvider.spatialReference;w.pointToVector(t,V,n);var i=V[0],l=V[1];return e.elevationProvider.on("elevation-change",(function(e){p.containsXY(e.extent,i,l)&&a()}))}(i,s.geometry,(function(){t.geometry=s.geometry})))},u=function(){c(),t.geometry=S(s)?s.geometry:null};n.push(a.on("changed",u),l.refHandle((function(){return o}))),u()})(e,t,a,n),n.push(h.settings.visualElements.pointGraphics.outline.bindStyle(t),a.watch("displaying",i),h.settings.visualElements.pointGraphics.watch("outlineEnabled",i)),i()}(e,s,t,a),a.push(l.destroyHandle(s)),s}(e,n,c);return function(e,t,a,n){var c=e.view,p=e.graphic,f=new m.LineVisualElement({view:c,infinite:h.settings.visualElements.zVerticalLine.infiniteType,attached:!1}),E=new v.LaserlineVisualElement({view:c,intersectsLineInfinite:!0,attached:!1}),L=s.deg2rad(h.settings.visualElements.heightPlaneAngleCutoff),z=new v.LaserlineVisualElement({view:c,attached:!1,angleCutoff:L}),A=null,M=g.getGraphicEffectiveElevationInfo(e.graphic),H=y.fromElevationInfo(M),P="on-the-ground"===M.mode||!M.offset&&"absolute-height"!==M.mode,x=new d.ManipulatorState,k=h.settings.visualElements.heightPlane.bindStyle(z),R=h.settings.visualElements.pointGraphics.shadowStyle.bindStyle(E),U=function(){x.update(e);var a=!1;f.infinite=h.settings.visualElements.zVerticalLine.infiniteType;var l=P&&(t.isDraped||!S(p)||!p.geometry.hasZ);if(!l)switch(h.settings.visualElements.pointGraphics.shadowEnabled){case"always":a=!0;break;case"grab-xy":a=!!(4&x.grabbingState)}var s=!1;switch(h.settings.zManipulator.enabled){case"always":s=!0;break;case"not-grab-z":s=!x.grabbingState}s&&r.isSome(A)?(A.remove(),A=null):!s&&r.isNone(A)&&r.isSome(x.zManipulator)&&(A=x.zManipulator.disableDisplay());var g=!0;if(!l&&S(p)){var d=p.geometry,v=b.evaluateElevationAlignmentAtPoint(p.geometry,c.elevationProvider,H,c.renderCoordsHelper);o.vec3.set(V,d.x,d.y,v),w.vectorToVector(V,d.spatialReference,V,c.renderCoordsHelper.spatialReference),f.worldDownAtLocation=V,E.intersectsWorldUpAtLocation=V}else g=!1;var m=u.empty(G),y=!1;if(!l)switch(h.settings.visualElements.heightPlane.enabled){case"always":y=!0;break;case"grab-z":y=!!(2&x.grabbingState)}2&x.grabbingState?k.updateGlobalAlpha(h.settings.visualElements.laserlineAlphaMultiplier):k.updateGlobalAlpha(1),y&&t.displaying&&n.calculateMapBounds(m)&&w.vectorToVector(u.getMin(m,V),c.spatialReference,V,c.renderCoordsHelper.spatialReference)?(z.heightPlane=V,z.attached=!0):z.attached=!1;var L=!1;switch(h.settings.visualElements.zVerticalLine.enabled){case"never":L=!1;break;case"always":L=!0;break;case"grab":L=!!(1&x.grabbingState);break;case"grab-xy":L=!!(4&x.grabbingState);break;case"grab-z":L=!!(2&x.grabbingState);break;default:i.neverReached(h.settings.visualElements.zVerticalLine.enabled)}4&x.grabbingState?R.updateGlobalAlpha(h.settings.visualElements.laserlineAlphaMultiplier):R.updateGlobalAlpha(1),E.attached=g&&t.displaying&&!l&&a,f.attached=g&&t.displaying&&!l&&a&&L};a.push(h.settings.zManipulator.watch("enabled",U),h.settings.visualElements.pointGraphics.watch("shadowEnabled",U),h.settings.visualElements.zVerticalLine.bindStyle(f),h.settings.visualElements.zVerticalLine.watch(["enabled","infinite"],U),R,t.watch(["displaying","isDraped"],U),t.on("changed",U),l.refHandle((function(){return A})),k),e.forEachManipulator((function(e){a.push(e.events.on("grab-changed",U))})),a.push(l.destroyHandle(E)),a.push(l.destroyHandle(f)),a.push(l.destroyHandle(z)),U()}(e,n,c,L),c.push(t.trackGraphicState(n)),{visualElement:L,remove:function(){l.handlesGroup(c).remove()}}};var V=c.vec3f64.create(),G=u.create()}));