// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../core/mathUtils","../../../core/maybe","../../../core/unitUtils","../../../core/libs/gl-matrix-2/mat4","../../../core/libs/gl-matrix-2/vec3","../../../core/libs/gl-matrix-2/vec3f64","../../../geometry/Point","../../../geometry/SpatialReference","../../../geometry/support/aaBoundingRect","../../../layers/graphics/dehydratedFeatures","./earthUtils","../webgl-engine/lib/BufferVectorMath"],(function(e,n,t,a,r,i,l,o,c,u,s,f,h,p){var R,m,d,v,M,x,S,T;function I(e,n,t,a){return 2===e.length?(B[0]=e[0],B[1]=e[1],B[2]=0,e=B):e===t&&(l.vec3.copy(B,e),e=B),y(e,n,0,t,a,0,1)}function y(e,n,t,r,i,l,o){void 0===o&&(o=1);var c=N(n,i,W);if(a.isNone(c))return!1;if(c===E){if(e===r&&t===l)return!0;for(var u=t+3*o,s=t,f=l;s<u;s++,f++)r[f]=e[s];return!0}var h=t+3*o;for(s=t,f=l;s<h;s+=3,f+=3)c(e,s,r,f);return!0}function P(e,t){return t.spatialReference===e?t.spatialReferenceId:(t.spatialReference=e,"metersPerUnit"in t&&(t.metersPerUnit=r.getMetersPerUnitForSR(e,1)),e.wkt===n.SphericalECEFSpatialReference.wkt?t.spatialReferenceId=1:e.isWGS84?t.spatialReferenceId=2:e.isWebMercator?t.spatialReferenceId=3:e.wkt===n.WGS84ECEFSpatialReference.wkt?t.spatialReferenceId=4:4490===e.wkid?t.spatialReferenceId=5:t.spatialReferenceId=0)}function E(e,n,t,a){t[a++]=e[n++],t[a++]=e[n++],t[a]=e[n]}function g(e,n,t,a){t[a++]=Y*(e[n++]/h.earthRadius),t[a++]=Y*(Math.PI/2-2*Math.atan(Math.exp(-1*e[n++]/h.earthRadius))),t[a]=e[n]}function G(e,n,a,r){var i=.4999999*Math.PI,l=t.clamp(F*e[n+1],-i,i),o=Math.sin(l);a[r++]=F*e[n]*h.earthRadius,a[r++]=h.halfEarthRadius*Math.log((1+o)/(1-o)),a[r]=e[n+2]}function b(e,n,t){var r=P(n,j),i=O[r][6];return!a.isNone(i)&&(i(e,0,B,0),t!==B&&(t[0]=B[0],t[1]=B[1],t.length>2&&(t[2]=B[2])),!0)}function U(e,n){return B[0]=e.x,B[1]=e.y,B[2]=e.hasZ?e.z:0,b(B,e.spatialReference,n)}function z(e,n,t,a){var r=h.earthRadius+e[n+2],i=F*e[n+1],l=F*e[n],o=Math.cos(i);t[a++]=Math.cos(l)*o*r,t[a++]=Math.sin(l)*o*r,t[a]=Math.sin(i)*r}function A(e,n,a,r){var i=p.Vec3Compact.length(e,n),l=t.asinClamped(e[n+2]/(0===i?1:i)),o=Math.atan2(e[n+1],e[n]);a[r++]=Y*o,a[r++]=Y*l,a[r]=i-h.earthRadius}function w(e,n,t,a){var r=k,i=F*e[n],l=F*e[n+1],o=e[n+2],c=Math.sin(l),u=Math.cos(l),s=r.a/Math.sqrt(1-r.e2*c*c);t[a++]=(s+o)*u*Math.cos(i),t[a++]=(s+o)*u*Math.sin(i),t[a++]=(s*(1-r.e2)+o)*c}function C(e,n,t,a){var r,i,l,o,c,u,s,f,h,p,R,m,d,v,M,x,S,T,I,y,P,E=k,g=e[n],G=e[n+1],b=e[n+2];r=Math.abs(b),i=g*g+G*G,l=Math.sqrt(i),o=i+b*b,c=Math.sqrt(o),y=Math.atan2(G,g),u=b*b/o,s=i/o,v=E.a2/c,M=E.a3-E.a4/c,s>.3?(f=r/c*(1+s*(E.a1+v+u*M)/c),I=Math.asin(f),p=f*f,h=Math.sqrt(1-p)):(h=l/c*(1-u*(E.a5-v-s*M)/c),I=Math.acos(h),p=1-h*h,f=Math.sqrt(p)),R=1-E.e2*p,m=E.a/Math.sqrt(R),I+=T=(x=h*(M=r-(d=E.a6*m)*f)-f*(v=l-m*h))/(d/R+(S=h*v+f*M)),P=S+x*T/2,b<0&&(I=-I),t[a++]=Y*y,t[a++]=Y*I,t[a]=P}Object.defineProperty(n,"__esModule",{value:!0}),n.SphericalECEFSpatialReference=new u({wkt:'GEOCCS["Spherical geocentric",\n  DATUM["Not specified",\n    SPHEROID["Sphere",\' + earthUtils.earthRadius + \',0]],\n  PRIMEM["Greenwich",0.0,\n    AUTHORITY["EPSG","8901"]],\n  UNIT["m",1.0],\n  AXIS["Geocentric X",OTHER],\n  AXIS["Geocentric Y",EAST],\n  AXIS["Geocentric Z",NORTH]\n]'}),n.WGS84ECEFSpatialReference=new u({wkt:'GEOCCS["WGS 84",\n  DATUM["WGS_1984",\n    SPHEROID["WGS 84",6378137,298.257223563,\n      AUTHORITY["EPSG","7030"]],\n    AUTHORITY["EPSG","6326"]],\n  PRIMEM["Greenwich",0,\n    AUTHORITY["EPSG","8901"]],\n  UNIT["m",1.0,\n    AUTHORITY["EPSG","9001"]],\n  AXIS["Geocentric X",OTHER],\n  AXIS["Geocentric Y",OTHER],\n  AXIS["Geocentric Z",NORTH],\n  AUTHORITY["EPSG","4978"]\n]'}),n.canProject=function(e,n){return!!N(e,n,W)},n.vectorToVector=I,n.pointToPoint=function(e,n,t,a){void 0===t&&(t=n.spatialReference),void 0===a&&(a=0),B[0]=e.x,B[1]=e.y;var r=e.z;return B[2]=void 0!==r?r:a,!!y(B,e.spatialReference,0,B,t,0,1)&&(n.x=B[0],n.y=B[1],n.spatialReference=t,void 0!==r?(n.z=B[2],n.hasZ=!0):(n.z=void 0,n.hasZ=!1),!0)},n.pointToVector=function(e,n,t,a){void 0===a&&(a=0),B[0]=e.x,B[1]=e.y;var r=e.z;return B[2]=void 0!==r?r:a,y(B,e.spatialReference,0,n,t,0,1)},n.vectorToPoint=function(e,n,t,a){var r;return t instanceof c?(r=t,a=a||r.spatialReference):f.isPoint(t)?((r=t).hasZ=!0,a=a||r.spatialReference):r=new c({spatialReference:a=t}),y(e,n,0,B,a,0,1)?(r.x=B[0],r.y=B[1],r.z=B[2],r.spatialReference=a,r):null},n.xyzToVector=function(e,n,t,a,r,i){return B[0]=e,B[1]=n,B[2]=t,y(B,a,0,r,i,0,1)},n.bufferToBuffer=y,n.localLinearScaleFactors=function(e,n,t,a){var r=P(n,j),i=P(a,q);if(r===i&&0!==r||n.equals(a))return t[0]=1,t[1]=1,t[2]=1,!0;if(1===r){var o=l.vec3.length(e),c=o/Math.sqrt(e[0]*e[0]+e[1]*e[1]),u=o/h.earthRadius;if(3===i)return t[0]=c*u,t[1]=c*u,t[2]=1,!0;if(2===i||5===i){var s=180/(h.earthRadius*Math.PI);return t[0]=s*c*u,t[1]=s*u,t[2]=1,!0}}return!1},n.computeLinearTransformation=function(e,n,t,r){var l=P(e,j),o=P(r,q);if(l===o&&1!==o&&(0!==l||e.equals(r)))return i.mat4.identity(t),i.mat4.translate(t,t,n),!0;if(1===o){var c=O[l][6],u=O[6][o];if(a.isNone(c)||a.isNone(u))return!1;c(n,0,V,0),u(V,0,Z,0);var s=F*V[0],f=F*V[1],h=Math.sin(s),p=Math.cos(s),R=Math.sin(f),m=Math.cos(f),d=t;return d[0]=-h,d[4]=-R*p,d[8]=m*p,d[12]=Z[0],d[1]=p,d[5]=-R*h,d[9]=m*h,d[13]=Z[1],d[2]=0,d[6]=m,d[10]=R,d[14]=Z[2],d[3]=0,d[7]=0,d[11]=0,d[15]=1,!0}if(3===o&&(2===l||1===l)){c=O[l][6];if(a.isNone(c))return!1;c(n,0,V,0);var v=F*V[1];G(V,0,Z,0),i.mat4.identity(t),i.mat4.translate(t,t,Z);var M=1/Math.cos(v);return i.mat4.scale(t,t,[M,M,1]),!0}return!1},n.transformDirection=function(e,n,t,a,r){l.vec3.copy(D,e),l.vec3.add(_,e,n),I(D,t,D,r),I(_,t,_,r),l.vec3.subtract(a,_,D),l.vec3.normalize(a,a)},n.mbsToMbs=function(e,n,t,r){var i=H(n,r,X);if(i.projector===E)return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],!0;if(a.isNone(i.projector))return!1;var l=i.source,o=i.dest;if(3===o.spatialReferenceId){var c=O[l.spatialReferenceId][2];if(a.isNone(c))return!1;c(e,0,V,0);var u=Math.abs(F*V[1])+Math.asin(e[3]/(h.earthRadius+e[2]));if(G(V,0,t,0),u>.9999*Math.PI)t[3]=Number.MAX_VALUE;else{var s=1/Math.cos(u);t[3]=s*e[3]}return!0}return i.projector(e,0,t,0),t[3]=e[3]*l.metersPerUnit/o.metersPerUnit,!0},n.extentToBoundingBox=function(e,n,t){if(null==e)return!1;var a=!0;return B[0]=null!=e.xmin?e.xmin:0,B[1]=null!=e.ymin?e.ymin:0,B[2]=null!=e.zmin?e.zmin:0,a=a&&y(B,e.spatialReference,0,n,t,0,1),B[0]=null!=e.xmax?e.xmax:0,B[1]=null!=e.ymax?e.ymax:0,B[2]=null!=e.zmax?e.zmax:0,a=a&&y(B,e.spatialReference,0,n,t,3,1),null==e.xmin&&(n[0]=-1/0),null==e.ymin&&(n[1]=-1/0),null==e.zmin&&(n[2]=-1/0),null==e.xmax&&(n[3]=1/0),null==e.ymax&&(n[4]=1/0),null==e.zmax&&(n[5]=1/0),a},n.extentToBoundingRect=function(e,n,t){if(null==e)return!1;var a=!0;return B[0]=null!=e.xmin?e.xmin:0,B[1]=null!=e.ymin?e.ymin:0,B[2]=null!=e.zmin?e.zmin:0,a=a&&y(B,e.spatialReference,0,B,t,0,1),n[0]=B[0],n[1]=B[1],B[0]=null!=e.xmax?e.xmax:0,B[1]=null!=e.ymax?e.ymax:0,B[2]=null!=e.zmax?e.zmax:0,a=a&&y(B,e.spatialReference,0,B,t,0,1),n[2]=B[0],n[3]=B[1],null==e.xmin&&(n[0]=-1/0),null==e.ymin&&(n[1]=-1/0),null==e.xmax&&(n[2]=1/0),null==e.ymax&&(n[3]=1/0),a},n.boundingRectToBoundingRect=function(e,n,t,a){return null!=e&&(n.equals(a)?(s.set(t,e),!0):(B[0]=e[0],B[1]=e[1],B[2]=0,!!y(B,n,0,B,a,0,1)&&(t[0]=B[0],t[1]=B[1],B[0]=e[2],B[1]=e[3],B[2]=0,!!y(B,n,0,B,a,0,1)&&(t[2]=B[0],t[3]=B[1],!0))))},function(e){e.x2lon=function(e){return e/h.earthRadius},e.y2lat=function(e){return Math.PI/2-2*Math.atan(Math.exp(-1*e/h.earthRadius))},e.lon2x=function(e){return e*h.earthRadius},e.lat2y=function(e){var n=Math.sin(e);return h.earthRadius/2*Math.log((1+n)/(1-n))}}(n.webMercator||(n.webMercator={})),n.canProjectToWGS84ComparableLonLat=function(e){var n=P(e,j);return!!O[n][6]},n.vectorToWGS84ComparableLonLat=b,n.pointToWGS84ComparableLonLat=U,n.pointToWGS84ComparableLonLatPoint=function(e,n){var t=P(n.spatialReference,q);return!a.isNone(O[6][t])&&(!!U(e,B)&&(n.x=B[0],n.y=B[1],n.z=B[2],!0))},n.wgs84ComparableLonLatToECEF=function(e,n,t,a){void 0===a&&(a=0);var r=h.earthRadius+a,i=Math.cos(t);e[0]=Math.cos(n)*i*r,e[1]=Math.sin(n)*i*r,e[2]=Math.sin(t)*r};var O=((R={})[2]=((m={})[5]=null,m[6]=E,m[1]=z,m[0]=null,m[3]=G,m[2]=E,m[4]=w,m),R[5]=((d={})[5]=E,d[6]=E,d[1]=z,d[0]=null,d[3]=null,d[2]=null,d[4]=w,d),R[3]=((v={})[5]=null,v[6]=g,v[1]=function(e,n,t,a){g(e,n,t,a),z(t,a,t,a)},v[0]=null,v[3]=E,v[2]=g,v[4]=function(e,n,t,a){g(e,n,t,a),w(t,a,t,a)},v),R[4]=((M={})[5]=C,M[6]=C,M[1]=function(e,n,t,a){C(e,n,t,a),z(t,a,t,a)},M[0]=null,M[3]=function(e,n,t,a){C(e,n,t,a),G(t,a,t,a)},M[2]=C,M[4]=E,M),R[1]=((x={})[5]=A,x[6]=A,x[1]=E,x[0]=null,x[3]=function(e,n,t,a){A(e,n,t,a),G(t,a,t,a)},x[2]=A,x[4]=function(e,n,t,a){A(e,n,t,a),w(t,a,t,a)},x),R[0]=((S={})[5]=null,S[6]=null,S[1]=null,S[0]=E,S[3]=null,S[2]=null,S[4]=null,S),R[6]=((T={})[5]=null,T[6]=E,T[1]=z,T[0]=null,T[3]=null,T[2]=E,T[4]=w,T),R);function N(e,n,t){return void 0===t&&(t=L()),H(e,n,t).projector}function H(e,n,t){if(t.source.spatialReference===e&&t.dest.spatialReference===n)return t;var a=P(e,t.source),r=P(n,t.dest);return 0===a&&0===r?e.equals(n)?t.projector=E:t.projector=null:t.projector=O[a][r],t}function L(){return{source:{spatialReference:null,spatialReferenceId:0,metersPerUnit:1},dest:{spatialReference:null,spatialReferenceId:0,metersPerUnit:1},projector:E}}n.getProjector=N;var j={spatialReference:null,spatialReferenceId:0},q={spatialReference:null,spatialReferenceId:0},W=L(),X=L(),F=t.deg2rad(1),Y=t.rad2deg(1),k={a:6378137,e2:.006694379990137799,a1:42697.67270715754,a2:1823091254.6075456,a3:142.91722289812412,a4:4557728136.518864,a5:42840.589930055656,a6:.9933056200098622},B=o.vec3f64.create(),V=o.vec3f64.create(),Z=o.vec3f64.create(),D=o.vec3f64.create(),_=o.vec3f64.create()}));