// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../core/libs/gl-matrix-2/mat3","../../../core/libs/gl-matrix-2/mat3f64","../../../core/libs/gl-matrix-2/quat","../../../core/libs/gl-matrix-2/quatf32","../../../core/libs/gl-matrix-2/quatf64","../../../core/libs/gl-matrix-2/vec3","../../../core/libs/gl-matrix-2/vec3f32","../../../core/libs/gl-matrix-2/vec3f64","../../../core/libs/gl-matrix-2/vec4","../../../core/libs/gl-matrix-2/vec4f64","../../../geometry/support/aaBoundingBox","./dito","./geometryUtils"],(function(e,a,t,r,n,i,c,f,o,u,s,l,h,v,b){Object.defineProperty(a,"__esModule",{value:!0});var m=c.quatf64.create(),z=u.vec3f64.create(),S=u.vec3f64.create(),M=l.vec4f64.create(),g=r.mat3f64.create(),q=function(e){var a=56*e;this.buffer=new ArrayBuffer(a),this.obbs=new Array(e);for(var t=0;t<e;t++)this.obbs[t]={center:u.vec3f64.createView(this.buffer,56*t+0),halfSize:o.vec3f32.createView(this.buffer,56*t+24),quaternion:i.quatf32.createView(this.buffer,56*t+36)}};function p(e,a,t){return{center:u.vec3f64.clone(e),halfSize:o.vec3f32.clone(a),quaternion:i.quatf32.clone(t)}}function x(e,a){var t=b.plane.signedDistance(a,e.center),r=A(e,a);return t>r?1:t<-r?-1:0}a.ObbArray=q,a.create=p,a.clone=function(e){return p(e.center,e.halfSize,e.quaternion)},a.set=function(e,a){f.vec3.copy(a.center,e.center),f.vec3.copy(a.halfSize,e.halfSize),n.quat.copy(a.quaternion,e.quaternion)},a.compute=function(e,a){return a||(a=p([0,0,0],[-1,-1,-1],[0,0,0,1])),v.computeOBB(e,a),a},a.intersectPlane=x,a.toAaBoundingBox=function(e,a){a||(a=h.create());var r=t.mat3.fromQuat(g,e.quaternion),n=e.halfSize[0]*Math.abs(r[0])+e.halfSize[1]*Math.abs(r[3])+e.halfSize[2]*Math.abs(r[6]),i=e.halfSize[0]*Math.abs(r[1])+e.halfSize[1]*Math.abs(r[4])+e.halfSize[2]*Math.abs(r[7]),c=e.halfSize[0]*Math.abs(r[2])+e.halfSize[1]*Math.abs(r[5])+e.halfSize[2]*Math.abs(r[8]);return a[0]=e.center[0]-n,a[1]=e.center[1]-i,a[2]=e.center[2]-c,a[3]=e.center[0]+n,a[4]=e.center[1]+i,a[5]=e.center[2]+c,a},a.minimumDistancePlane=function(e,a){return b.plane.signedDistance(a,e.center)-A(e,a)},a.maximumDistancePlane=function(e,a){return b.plane.signedDistance(a,e.center)+A(e,a)},a.isVisible=function(e,a){return x(e,a.planes[0])<=0&&x(e,a.planes[1])<=0&&x(e,a.planes[2])<=0&&x(e,a.planes[3])<=0&&x(e,a.planes[4])<=0&&x(e,a.planes[5])<=0},a.intersectLine=function(e,a,t,r){void 0===r&&(r=0),n.quat.conjugate(m,e.quaternion),f.vec3.subtract(z,a,e.center);for(var i=f.vec3.transformQuat(z,z,m),c=f.vec3.transformQuat(S,t,m),o=-1/0,u=1/0,s=0;s<3;s++)if(Math.abs(c[s])>1e-6){var l=(r+e.halfSize[s]-i[s])/c[s],h=(-r-e.halfSize[s]-i[s])/c[s];o=Math.max(o,Math.min(l,h)),u=Math.min(u,Math.max(l,h))}else if(i[s]>e.halfSize[s]+r||i[s]<-e.halfSize[s]-r)return!1;return o<=u},a.projectedArea=function(e,a,r,i,c){n.quat.conjugate(m,e.quaternion),f.vec3.sub(z,a,e.center),f.vec3.transformQuat(z,z,m);var o=z[0]<-e.halfSize[0]?-1:z[0]>e.halfSize[0]?1:0,u=z[1]<-e.halfSize[1]?-1:z[1]>e.halfSize[1]?1:0,l=z[2]<-e.halfSize[2]?-1:z[2]>e.halfSize[2]?1:0,h=Math.abs(o)+Math.abs(u)+Math.abs(l);if(0===h)return 1/0;var v=1===h?4:6,b=6*(o+3*u+9*l+13);t.mat3.fromQuat(g,e.quaternion),t.mat3.scale(g,g,e.halfSize);for(var S=0;S<v;S++){var q=w[b+S];f.vec3.set(z,((1&q)<<1)-1,(2&q)-1,((4&q)>>1)-1),f.vec3.transformMat3(z,z,g),f.vec3.add(M,e.center,z),M[3]=1,s.vec4.transformMat4(M,M,r);var p=1/Math.max(1e-6,M[3]);j[2*S]=M[0]*p,j[2*S+1]=M[1]*p}var x=2*v-2,d=j[0]*(j[3]-j[x+1])+j[x]*(j[1]-j[x-1]);for(S=2;S<x;S+=2)d+=j[S]*(j[S+3]-j[S-1]);return Math.abs(d)*i*c*.125};var d,y,B,j=[.1,.2,.3,.4,.5,.6,.7,.8,.9,1,1.1,1.2],w=(d=new Int8Array(162),y=0,(B=function(e){for(var a=0;a<e.length;a++)d[y+a]=e[a];y+=6})([6,2,3,1,5,4]),B([0,2,3,1,5,4]),B([0,2,3,7,5,4]),B([0,1,3,2,6,4]),B([0,1,3,2,0,0]),B([0,1,5,7,3,2]),B([0,1,3,7,6,4]),B([0,1,3,7,6,2]),B([0,1,5,7,6,2]),B([0,1,5,4,6,2]),B([0,1,5,4,0,0]),B([0,1,3,7,5,4]),B([0,2,6,4,0,0]),B([0,0,0,0,0,0]),B([1,3,7,5,0,0]),B([2,3,7,6,4,0]),B([2,3,7,6,0,0]),B([2,3,1,5,7,6]),B([0,1,5,7,6,2]),B([0,1,5,7,6,4]),B([0,1,3,7,6,4]),B([4,5,7,6,2,0]),B([4,5,7,6,0,0]),B([4,5,1,3,7,6]),B([0,2,3,7,5,4]),B([6,2,3,7,5,4]),B([6,2,3,1,5,4]),d);function A(e,a){n.quat.conjugate(m,e.quaternion),f.vec3.transformQuat(z,a,m);var t=e.halfSize;return Math.abs(z[0]*t[0])+Math.abs(z[1]*t[1])+Math.abs(z[2]*t[2])}a.projectedRadius=A}));