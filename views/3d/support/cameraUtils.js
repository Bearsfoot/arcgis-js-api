// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/assignHelper","../../../core/tsSupport/generatorHelper","../../../core/tsSupport/awaiterHelper","../../../Camera","../../../core/Logger","../../../core/mathUtils","../../../core/promiseUtils","../../../core/libs/gl-matrix-2/vec3","../../../core/libs/gl-matrix-2/vec3f64","../../../geometry/Point","../../../geometry/SpatialReference","../../../geometry/support/scaleUtils","../camera/intersectionUtils","./cameraUtilsPlanar","./cameraUtilsSpherical","./earthUtils","./ElevationProvider","./mathUtils","./projectionUtils","../../support/spatialReferenceSupport"],(function(e,t,r,n,i,a,o,c,l,s,u,f,v,d,p,m,g,h,T,y,x,R){Object.defineProperty(t,"__esModule",{value:!0});var S=o.getLogger("esri.views.3d.support.cameraUtils"),M=u.vec3f64.create(),w=u.vec3f64.create(),C=u.vec3f64.create(),b={heading:0,tilt:0},z=new f,P=new y.Cyclical(-20037508.342788905,20037508.342788905),E=new y.Cyclical(-180,180);function A(e){return e.spatialReference||v.WGS84}function U(e){return"global"===e.viewingMode?g:m}function H(e,t,r){var n=e.state.camera,i=n.fovX,a=n.width/2/n.pixelRatio;"global"===e.viewingMode&&null!=r&&(t*=Math.cos(c.deg2rad(r)));return a/(96*39.37/(t/=e.renderCoordsHelper.unitInMeters))/Math.tan(i/2)}function V(e,t,r){var n=e.state.camera,i=n.fovX,a=t*Math.tan(i/2),o=96*39.37/(n.width/2/n.pixelRatio/a);return"global"===e.viewingMode&&(o/=Math.cos(c.deg2rad(r))),o*=e.renderCoordsHelper.unitInMeters}function D(e,t,r,n,i,a){if(W(a)){var o=G(a.signal);return O(e,n.heading,n.tilt,t,r,i,o),void o.resolver.promise.then((function(t){return a.resolver.resolve(q(e,t,n.fov))}),(function(e){return a.resolver.reject(e)}))}var c=O(e,n.heading,n.tilt,t,r,i);return q(e,c,n.fov,a)}function I(e,t,r,n,i){return U(e).directionToHeadingTilt(t,r,n,i)}function O(e,t,r,a,o,c,l){var v=a&&a instanceof f?a:null;if(!W(l)){var d=function(e,t){var r=u.vec3f64.create();if(t&&t instanceof f){if(x.pointToVector(t,r,e.renderSpatialReference),null==t.z&&null!=e.basemapTerrain){var n=T.getElevationAtPoint(e.elevationProvider,t);null!=n&&e.renderCoordsHelper.setAltitude(n,r)}}else t?s.vec3.copy(r,t):s.vec3.copy(r,e.state.camera.center);return r}(e,a);return j(e,t,r,v,d,o,c,l)}(function(e,t,r){return i(this,void 0,void 0,(function(){var i,a;return n(this,(function(n){switch(n.label){case 0:return i=u.vec3f64.create(),t?[3,1]:(s.vec3.copy(i,e.state.camera.center),[3,5]);case 1:return t instanceof f?(x.pointToVector(t,i,e.renderSpatialReference),null!=t.z||null==e.basemapTerrain?[3,3]:[4,e.elevationProvider.queryElevation(t.x,t.y,t.z,t.spatialReference,r)]):[3,4];case 2:return null!=(a=n.sent())&&e.renderCoordsHelper.setAltitude(a,i),[2,i];case 3:return[3,5];case 4:s.vec3.copy(i,t),n.label=5;case 5:return[2,i]}}))}))})(e,a,l.signal).then((function(n){j(e,t,r,v,n,o,c,l)}),(function(e){return l.resolver.reject(e)}))}function j(e,t,r,a,o,c,l,s){if(!a){var f=e.renderSpatialReference,v=A(e);a=x.vectorToPoint(o,f,v)}c=Math.max(c,e.state.constraints.minimumPoiDistance);var d=function(e,t,r,n,i,a){var o=0;1===a&&function(e,t,r){var n=e.pointsOfInterest.centerOnSurfaceFrequent.distance;if(Math.log(r/n)/Math.LN2>8)return!0;var i=e.renderSpatialReference,a=A(e),o=x.vectorToPoint(t,i,a),c=x.vectorToPoint(e.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,i,a),l=Math.tan(.5*e.state.camera.fov)*n;return c.distance(o)/l>5}(e,n,i)?(t=0,o=function(e,t,r,n){var i=e.state.constraints.tilt(t);i.max=Math.min(i.max,.5*Math.PI);var a=i.min*(1-.7)+.7*i.max,o=L(e,n,t,r);return Math.min(o,a)}(e,i,r,n)):o=L(e,n,i,r);return o=e.state.constraints.clampTilt(i,o),r=F(e,n,i,o),{heading:t,tilt:r}}(e,t,r,o,c,l),p=(0,U(e).eyeForCenterWithHeadingTilt)(o,c,d.heading,d.tilt);if(1===l&&"global"===e.viewingMode&&r>0){var m=function(){var n=F(e,o,c,function(e,t,r,n){var i=e.state.constraints.tilt(t),a=L(e,n,t,r);return a=Math.min(a,.5*Math.PI),i.min*(1-.7)+.7*a}(e,c,r,o));return j(e,t,n,a,o,c,l=r-n<1?0:1,s)},g=e.map.ground.navigationConstraint;if(!g||"stay-above"===g.type){if(function(e,t){return!!(e.basemapTerrain&&e.renderCoordsHelper.fromRenderCoords(t,z,e.spatialReference)&&T.getElevationAtPoint(e.elevationProvider,z)>z.z-1)}(e,p.eye))return m();if(W(s))return void function(e,t,r){return i(this,void 0,void 0,(function(){return n(this,(function(n){switch(n.label){case 0:return e.renderCoordsHelper.fromRenderCoords(t,z,e.spatialReference)?[4,e.elevationProvider.queryElevation(z.x,z.y,z.z,z.spatialReference,r)]:[2,!1];case 1:return[2,n.sent()>z.z-1]}}))}))}(e,p.eye,s.signal).then((function(e){if(e)return m();s.resolver.resolve({eye:p.eye,up:p.up,center:u.vec3f64.clone(o),heading:p.heading,tilt:p.tilt})}))}}var h=!s||W(s)?{center:u.vec3f64.create(),eye:u.vec3f64.create(),up:u.vec3f64.create(),tilt:0,heading:0}:s;return h.eye=p.eye,h.up=p.up,h.center=u.vec3f64.clone(o),h.heading=p.heading,h.tilt=p.tilt,W(s)&&s.resolver.resolve(h),h}t.headingTiltToDirectionUp=function(e,t,r,n,i){return U(e).headingTiltToDirectionUp(t,r,n,i)},t.externalToInternal=function(e,t){var r=e.renderSpatialReference,n=U(e).headingTiltToDirectionUp,i=u.vec3f64.create();if(!x.pointToVector(t.position,i,r))return null;var a=n(i,t.heading,t.tilt);s.vec3.scale(a.direction,a.direction,e.state.camera.distance),s.vec3.add(a.direction,a.direction,i);var o=p.cameraOnContentAlongViewDirection(e,i,a.direction,a.up);return o.fov=c.deg2rad(t.fov),o},t.internalToExternal=function(e,t,r){var n=e.renderSpatialReference,i=s.vec3.copy(C,t.viewForward),o=I(e,t.eye,i,t.up,b),l=A(e);return x.vectorToVector(t.eye,n,M,l)||(l=v.WGS84,x.vectorToVector(t.eye,n,M,l)),r?(r.position.x=M[0],r.position.y=M[1],r.position.z=M[2],r.position.spatialReference=l,r.heading=o.heading,r.tilt=o.tilt,r.fov=c.rad2deg(t.fov),r):new a(new f(M,l),o.heading,o.tilt,c.rad2deg(t.fov))},t.scaleToDistance=H,t.distanceToScale=V,t.fromCenterScale=function(e,t,r,n,i,a){return D(e,t,H(e,r,t.latitude),n,i,a)},t.fromCenterDistance=D,t.directionToHeadingTilt=I,t.getObserverForPointAtDistance=O,t.fromExtent=function(e,t,r,n,i,a){var o,c,l,s,u=0;if(null!=t.zmax&&null!=t.zmin&&(o=(t.zmax+t.zmin)/2,u=t.zmax-t.zmin),"global"===e.viewingMode){if(!R.isSpatialReferenceSupported(t.spatialReference,"global"))return W(a)&&a.resolver.reject(),null;var v=new f(t.xmin,t.ymin,t.spatialReference),d=new f(t.xmax,t.ymax,t.spatialReference),p=t.spatialReference.isGeographic?E:P;c=new f(p.center(v.x,d.x),(d.y+v.y)/2,t.spatialReference),null!=o&&(c.z=o);var m=h.getGreatCircleSpanAt(c,v,d);l=m.lon,s=m.lat,p.diff(v.x,d.x)>p.range/2&&(l+=h.halfEarthCircumference),l=Math.min(l,h.halfEarthCircumference),s=Math.min(s,h.halfEarthCircumference)}else{var g=A(e);l=t.xmax-t.xmin,s=t.ymax-t.ymin,c=new f({x:t.xmin+.5*l,y:t.ymin+.5*s,z:o,spatialReference:g})}var T=e.state.camera,y=1/Math.tan(T.fovX/2),x=1/Math.tan(T.fovY/2),S=1/Math.tan(T.fov/2),M=Math.max(.5*l*y,.5*s*x,.5*u*S)/1;if(W(a)){var w=G(a.signal);return O(e,r,n,c,M,i,w),void w.resolver.promise.then((function(t){return a.resolver.resolve(q(e,t,e.camera.fov))}),(function(e){return a.resolver.reject(e)}))}var C=O(e,r,n,c,M,i);return q(e,C,e.camera.fov,a)},t.toExtent=function(e,t,r){var n=e.renderSpatialReference,i=s.vec3.dist(t.eye,r),a=x.vectorToPoint(r,n,A(e)),o=2*i*Math.tan(t.fovX/2)*1,c=2*i*Math.tan(t.fovY/2)*1;return"global"===e.viewingMode?g.toExtent(e,a,o,c):m.toExtent(e,a,o,c)};function F(e,t,r,n){return U(e).lookAtTiltToEyeTilt(n,t,r)}function L(e,t,r,n){return U(e).eyeTiltToLookAtTilt(n,t,r)}function q(e,t,r,n){var i=e.renderSpatialReference,o=A(e),c=x.vectorToPoint(t.eye,i,o);return c?n?(n.position=c,n.heading=t.heading,n.tilt=t.tilt,n.fov=r,n):new a(c,t.heading,t.tilt,r):null}function G(e){return{resolver:l.createResolver(),signal:e}}function W(e){return e&&"resolver"in e}t.observerToCamera=q,t.scaleToZoom=function(e,t){var r=e.basemapTerrain&&e.basemapTerrain.tilingScheme;if(r)return r.levelAtScale(t);S.error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme")},t.zoomToScale=function(e,t){var r=e.basemapTerrain&&e.basemapTerrain.tilingScheme;if(r)return r.scaleAtLevel(t);S.error("#zoomToScale()","Cannot compute scale from zoom without a tiling scheme")},t.scaleToResolution=function(e,t){return e.spatialReference?d.getResolutionForScale(t,e.spatialReference):void 0},t.computeScale=function(e,t,r){var n,i,o=e.renderSpatialReference;t||(t=e.state.camera);var c=v.WGS84;return t instanceof a?(n=t.position.latitude,x.pointToVector(t.position,M,o),x.pointToVector(r,w,o),i=s.vec3.distance(M,w)):(x.vectorToVector(t.center,o,w,c),n=w[1],i=t.distance),V(e,i,n)},t.createAsyncContext=G,t.isAsyncContext=W}));