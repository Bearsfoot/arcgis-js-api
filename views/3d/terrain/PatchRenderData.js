// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../core/arrayUtils","../../../core/mathUtils","../../../core/maybe","../../../core/now","../../../core/libs/gl-matrix-2/vec2","../../../core/libs/gl-matrix-2/vec2f64","../../../core/libs/gl-matrix-2/vec4f64","../../../geometry/support/aaBoundingBox","../support/buffer/glUtil","./PatchGeometryFactory","./TerrainConst","./tileUtils","../webgl-engine/lib/DefaultVertexAttributeLocations","../../webgl/BufferObject","../../webgl/VertexArrayObject"],(function(e,t,r,i,n,s,a,l,u,o,c,f,h,p,g,x,y){Object.defineProperty(t,"__esModule",{value:!0});var m=function(){function e(){this.overlayTexOffset=l.vec2f64.create(),this.geometryInfo={indices:null,vertexAttributes:null,boundingBox:o.empty(),numSurfaceIndices:0,numSkirtIndices:0,numWithoutSkirtIndices:0,numVertsPerRow:0,skirtLength:0,uvOffsetAndScale:u.vec4f64.create()},this._textureReferences=new Array}return e.prototype.init=function(e){this.tile=e;var t=this.geometryInfo;for(t.indices=null,t.vertexAttributes=null,o.empty(t.boundingBox),t.numSurfaceIndices=0,t.numSkirtIndices=0,t.numWithoutSkirtIndices=0,t.numVertsPerRow=0,this.geometryState={numVertsPerRow:0,samplerData:null,clippingArea:null,wireframe:!1},this._vao=null;this._textureReferences.length>0;)this._textureReferences.pop().texture.release();if(this.opacity=1,this.overlays)for(var r=0,i=this.overlays;r<i.length;r++){var n=i[r];n.renderTargetIds.color=null,n.renderTargetIds.highlight=null,n.renderTargetIds.water=null,n.renderTargetIds.occluded=null,a.vec2.set(n.texScale,1,1),a.vec2.set(n.texOffset,0,0)}else{this.overlays=[null,null];for(var s=0;s<2;s++)this.overlays[s]={renderTargetIds:{color:null,highlight:null,water:null,occluded:null},texScale:[1,1],texOffset:[0,0]}}this.overlayOpacity=1,this.localOrigin=null},e.prototype.updateGeometry=function(e,t){return!!this._updateGeometryState(t)&&(this._releaseGeometry(),this._createGeometry(e),!0)},e.prototype.releaseGeometry=function(){return!!this._releaseGeometry()&&(this.geometryState={numVertsPerRow:0,samplerData:null,clippingArea:null,wireframe:!1},!0)},e.prototype.ensureTexture=function(e,t){return n.isSome(this._texture)&&this._texture.descriptor.width!==e&&this.releaseTexture(),this._texture||(this._texture=t(),this.tile.setMemoryDirty()),this._texture},e.prototype.releaseTexture=function(){this._expireTextureReference(),n.isSome(this._texture)&&(this._texture.release(),this._texture=null,this.tile.setMemoryDirty())},e.prototype._expireTextureReference=function(){if(0!==this._textureReferences.length)if(this.tile.surface.textureFadeDuration<=0)for(;this._textureReferences.length>0;)this._textureReferences.pop().texture.release();else{for(;this._textureReferences.length>2;)this._textureReferences.pop().texture.release();var e=this._textureReferences[this._textureReferences.length-1];0===e.age&&(e.age=s())}},e.prototype._updateGeometryState=function(e){var t=this._getElevationInfo(),n=this.tile.level,s=n<8?this.tile.numSubdivisionsAtLevel[n]+1:2;if(t.samplerData){var a=this.tile.vlevel-n,l=Math.max(n-t.maxTileLevel,h.ELEVATION_DESIRED_RESOLUTION_LEVEL-a),u=this.tile.maxTesselation;s=i.clamp(1+(u>>l),2,u+1)}var o=this.tile.clippingArea;this.tile.intersectsClippingArea&&!this.tile.isWithinClippingArea||(o=null);var c=this.geometryState,f=!1;return c.numVertsPerRow!==s&&(c.numVertsPerRow=s,f=!0),t.changed&&(c.samplerData=t.samplerData,f=!0),r.equals(c.clippingArea,o)||(c.clippingArea=o,f=!0),c.wireframe!==e&&(c.wireframe=e,f=!0),f},e.prototype._createGeometry=function(e){this.tile.createGeometry(this.geometryState,this.localOrigin);var t=this.geometryInfo.vertexAttributes,r=this.geometryInfo.indices,i=e.gl;this._vao=new y(e,g.Default3D,{geometry:c.glLayout(t.layout)},{geometry:x.createVertex(e,i.STATIC_DRAW,t.buffer)},x.createIndex(e,i.STATIC_DRAW,r))},e.prototype._releaseGeometry=function(){return!!this._vao&&(this._vao.dispose(),this._vao=null,f.releaseGeometry(this.geometryInfo),!0)},Object.defineProperty(e.prototype,"vao",{get:function(){return this._vao},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"textureReference",{get:function(){if(0===this._textureReferences.length)return null;var e=this._textureReferences[0];if(e.age>0&&s()-e.age>this._fadeDuration){e.texture.release(),this._textureReferences.shift();var t=this._textureReferences[0];t&&t.age>0&&(t.age=s())}switch(this._textureReferences.length){case 0:return null;case 1:return this._textureReferences[0].texture;default:return this._textureReferences[1].texture}},enumerable:!0,configurable:!0}),e.prototype.setTextureReference=function(e,t,r,i){this._expireTextureReference(),n.isSome(e)&&this._textureReferences.push(new d(e,t,r,i))},Object.defineProperty(e.prototype,"texOffsetAndScale",{get:function(){switch(this._textureReferences.length){case 0:return _;case 1:return this._textureReferences[0].offsetAndScale;default:return this._textureReferences[1].offsetAndScale}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"oldTextureReference",{get:function(){return this._textureReferences.length<2?null:this._textureReferences[0].texture},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"oldTexOffsetAndScale",{get:function(){return this._textureReferences.length<2?_:this._textureReferences[0].offsetAndScale},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"textureFadeFactor",{get:function(){if(this._textureReferences.length<2)return 1;var e=s()-this._textureReferences[0].age,t=this._fadeDuration;return e>t?1:e/t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"_fadeDuration",{get:function(){switch(this._textureReferences.length){case 0:case 1:case 2:return this.tile.surface.textureFadeDuration;default:return.5*this.tile.surface.textureFadeDuration}},enumerable:!0,configurable:!0}),e.prototype._getElevationInfo=function(){for(var e=this.geometryState.samplerData,t=this.tile.layerInfo[0],r=t.length,i=new Array(r),n=0,s=0,a=!1,l=0;l<r;l++){var u=t[l];if(u.upsampleInfo){var o=u.upsampleInfo.tile,c=(h=o.layerInfo[0][l].data)&&h.samplerData;e&&e[n]===c||(a=!0),i[n++]=c,s=Math.max(s,o.lij[0])}else if(u.data){var f=this.tile.surface.layerViewByIndex(l,0);if(p.fallsWithinLayer(this.tile,f.layer,!1)){var h=u.data;e&&e[n]===h.samplerData||(a=!0),i[n++]=h.samplerData,s=this.tile.lij[0]}}}return e&&e.length!==n&&(a=!0),n>0?i.length=n:i=null,{changed:a,samplerData:i,maxTileLevel:s}},Object.defineProperty(e.prototype,"estimatedGeometryMemoryUsage",{get:function(){return this.geometryInfo.indices.byteLength+this.geometryInfo.vertexAttributes.byteLength},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"textureDescriptor",{get:function(){return n.isSome(this._texture)?this._texture.descriptor:null},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"test",{get:function(){return{hasTexture:null!=this._texture}},enumerable:!0,configurable:!0}),e}();t.PatchRenderData=m;var d=function(e,t,r,i){this.texture=e,this.age=0,e.retain(),this.offsetAndScale=u.vec4f64.fromValues(t,r,i,i)},_=u.vec4f64.fromValues(0,0,1,1)}));