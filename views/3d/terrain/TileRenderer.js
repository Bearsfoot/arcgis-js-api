// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../core/mathUtils","../../../core/maybe","../../../core/libs/gl-matrix-2/vec2","../../../core/libs/gl-matrix-2/vec2f64","../../2d/engine/vectorTiles/tileRendererHelper3D","../../2d/engine/vectorTiles/VectorTile","../support/StreamDataLoader","./BlendLayersTechnique","./terrainUtils","./TileTexture","./support/FBOPool","../webgl-engine/lib/DefaultVertexBufferLayouts","../webgl-engine/lib/glUtil3D","../../webgl/Util"],(function(e,t,r,a,i,o,s,n,u,l,c,f,d,h,p,y){var T=function(){function e(e,t,r,a){this._context=e,this.tileSize=t,this._setNeedsRender=a,this._backgroundTexture=null,this._blackTex=null,this._context.capabilities.textureFilterAnisotropic&&(this._maxAnisotropy=this._context.parameters.maxMaxAnisotropy),this._vaoQuad=p.createQuadVAO(this._context,h.Pos2Tex);var i=new l.BlendLayersTechniqueConfiguration;i.mode=2,this._blendLayersTechnique=r.acquireAndReleaseExisting(l.BlendLayersTechnique,i,this._blendLayersTechnique),i.mode=1,this._applyOpacityTechnique=r.acquireAndReleaseExisting(l.BlendLayersTechnique,i,this._applyOpacityTechnique),this._blackTex=new f.TileTexture(p.createColorTexture(this._context,[0,0,0,1])),this._fboPool=new d.FBOPool(this._context)}return e.prototype.dispose=function(){this._fboPool&&(this._fboPool.clear(),this._fboPool=null),this._vaoQuad&&(this._vaoQuad.dispose(),this._vaoQuad=null),a.isSome(this._backgroundTexture)&&(this._backgroundTexture.release(),this._backgroundTexture=null),this._blackTex&&(this._blackTex.release(),this._blackTex=null),this._blendLayersTechnique&&(this._blendLayersTechnique.dispose(),this._blendLayersTechnique=null),this._applyOpacityTechnique&&(this._applyOpacityTechnique.dispose(),this._applyOpacityTechnique=null)},e.prototype.updateTileTexture=function(e){for(var t=e.layerInfo[1],i=0,o=t;i<o.length;i++){o[i].pendingUpdates&=-65}if(e.renderData){for(var s=e.surface,n=s.baseOpacity,u=0,l=this.tileSize,f=!1,d=1,h=t.length,p=0;p<t.length&&!f;p++){var y=s.layerViewByIndex(p,1),T=y.fullOpacity;if(d=y.view.pixelRatio,b[p]=T,this._isBaseLayer(y.layer)&&h>=t.length&&(h=p),0!==T){var x=_(e,p,m);x&&(c.isVectorTileLayerView(y)?l=Math.max(l,this.tileSize*y.view.pixelRatio):1===n&&1===T&&(y.isOpaque||this._dataToTexture(x)&&a.isSome(x.sourceLayerInfo.data)&&x.sourceLayerInfo.data.descriptor.isOpaque)&&(f=!0),u++)}}this._cleanupFBOPool(d,t.length);var g=(l=function(e){var t=r.nextHighestPowerOfTwo(e),a=t*t,i=e*e;if(a===i)return e;var o=t/2;return a-i<i-o*o?t:o}(l))/this.tileSize,L=p-1;0===u&&this._backgroundTexture?this._useBackgroundTexture(e):1===u&&f?this._useLayerTexture(e,L):this._composeMapLayers(e,L,h,f,b,l,g),this._setNeedsRender()}},e.prototype.setBackground=function(e){a.isSome(this._backgroundTexture)&&this._backgroundTexture.release(),e instanceof HTMLImageElement?this._backgroundTexture=this._buildTexture(e):this._backgroundTexture=new f.TileTexture(p.createColorTexture(this._context,e))},e.prototype._buildTexture=function(e){if(a.isNone(e))return null;var t,r={target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9987,maxAnisotropy:this._maxAnisotropy,flipped:!0,hasMipmap:!0},i=this._context;if("number"==typeof e)r.width=r.height=e,t=new f.TileTexture(i,r);else if(e instanceof u.ImageWithType)r.isOpaque="image/jpeg"===e.type,t=new f.TileTexture(i,r,e.image),e.release();else try{t=new f.TileTexture(i,r,e)}catch(e){t=new f.TileTexture(p.createEmptyTexture(i)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}return i.bindTexture(t.texture),t.generateMipmap(),t},e.prototype._drawRasterData=function(e,t,r,i,o){if(void 0===o&&(o=1),!a.isNone(t)){var s=this._context,n=e.program,u=this._vaoQuad;s.setPipelineState(e.pipeline),s.bindProgram(n),s.bindVAO(u),n.assertCompatibleVertexAttributeLocations(u),s.bindTexture(t,0),n.setUniform1i("tex",0),n.setUniform1f("scale",r),n.setUniform2f("offset",i[0],i[1]),n.setUniform1f("opacity",o),s.drawArrays(5,0,y.vertexCount(u,"geometry"))}},e.prototype._drawVectorData=function(e,t,r,i,o,n,u){var l=t.sourceLayerInfo.data;if(a.isNone(l))return u;var c,f=this._context,d=t.tile.surface.layerViewByIndex(t.layerIndex,1);f.setPipelineState(e.pipeline);var h=i<1;return h?(c=this._fboPool.acquire(o),f.bindFramebuffer(c),f.setClearColor(1,1,1,0),f.clearSafe(16640)):u&&f.clearSafe(256),s.renderVectorTile(f,t.sourceLod,l,d.painter,d.layer.styleRepository,d.schemaHelper,Math.round(1/t.scale),t.offset,this.tileSize,r),!h||(f.bindFramebuffer(n),this._drawRasterData(e,c.colorTexture,1,[0,0],i),this._fboPool.release(c),u)},e.prototype._useBackgroundTexture=function(e){e.renderData.releaseTexture(),e.renderData.opacity=e.surface.baseOpacity,e.renderData.setTextureReference(this._backgroundTexture,0,0,1)},e.prototype._useLayerTexture=function(e,t){e.renderData.releaseTexture();var r=_(e,t,m);if(this._dataToTexture(r)){var a=r.offset;e.renderData.setTextureReference(r.sourceLayerInfo.data,a[0],a[1],r.scale)}e.renderData.opacity=e.surface.baseOpacity},e.prototype._composeMapLayers=function(e,t,r,i,s,n,u){var l=this;e.renderData.releaseTexture();var c=e.renderData.ensureTexture(n,(function(){return l._buildTexture(n)}));if(!a.isNone(c)){var f=this._context,d=this._fboPool.acquire(n);f.bindFramebuffer(d),f.setViewport(0,0,n,n),f.setClearColor(0,0,0,0),f.setClearDepth(1),f.clearSafe(16640);var h=!1;!i&&a.isSome(this._backgroundTexture)&&this._drawRasterData(this._blendLayersTechnique,this._backgroundTexture.texture,1,o.vec2f64.ZEROS);for(var p=e.surface.baseOpacity,y=!1,T=t;T>=0;T--){var b=_(e,T,m);b&&(T<r&&p<1&&!y&&(this._drawRasterData(this._applyOpacityTechnique,this._blackTex.texture,1,o.vec2f64.ZEROS,p),y=!0),0!==s[T]&&(x(b)?h=this._drawVectorData(this._blendLayersTechnique,b,u,s[T],n,d,h):this._dataToTexture(b)&&a.isSome(b.sourceLayerInfo.data)&&this._drawRasterData(this._blendLayersTechnique,b.sourceLayerInfo.data.texture,b.scale,b.offset,s[T])))}f.bindTexture(c.texture);var g=c.descriptor;f.gl.copyTexImage2D(f.gl.TEXTURE_2D,0,g.pixelFormat,0,0,g.width,g.height,0),c.generateMipmap(),f.bindFramebuffer(null),this._fboPool.release(d),e.renderData.opacity=y?1:p,e.renderData.setTextureReference(c,0,0,1)}},e.prototype._dataToTexture=function(e){return function(e){var t=e&&e.sourceLayerInfo&&e.sourceLayerInfo.data;return t instanceof HTMLImageElement||t instanceof u.ImageWithType||t instanceof HTMLCanvasElement}(e)&&this._rasterDataToTexture(e),function(e){return e&&e.sourceLayerInfo&&e.sourceLayerInfo.data instanceof f.TileTexture}(e)},e.prototype._rasterDataToTexture=function(e){var t=e.sourceLayerInfo;t.data=this._buildTexture(t.data),e.tile.setMemoryDirty()},e.prototype._isBaseLayer=function(e){return e.parent&&"esri.Basemap"===e.parent.declaredClass&&e.parent.baseLayers.indexOf(e)>-1},e.prototype._cleanupFBOPool=function(e,t){e===this._lastPixelRatio&&t===this._lastNumLayers||(this._fboPool.clear(),this._lastPixelRatio=e,this._lastNumLayers=t)},e}();function x(e){return e&&e.sourceLayerInfo&&e.sourceLayerInfo.data instanceof n.VectorTile}function _(e,t,r){r.layerIndex=t;var a=e.layerInfo[1][t];if(a.data)return i.vec2.set(r.offset,0,0),r.tile=e,r.scale=1,r.sourceLod=e.lij,r.sourceLayerInfo=a,r;var o=a.upsampleInfo;if(o){var s=o.tile.layerInfo[1][t];return r.tile=o.tile,i.vec2.copy(r.offset,o.offset),r.scale=o.scale,r.sourceLod=o.tile.lij,r.sourceLayerInfo=s,r}return null}var b=new Array,m={tile:null,sourceLayerInfo:null,sourceLod:null,offset:[0,0],scale:1,layerIndex:0};return T}));