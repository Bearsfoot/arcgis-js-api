// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","../../../core/Logger","../../../core/MapUtils","../../../core/maybe","../../../core/PooledArray","../../../core/SetUtils","../../../core/accessorSupport/decorators/declared","../../../core/libs/gl-matrix-2/mat4","../../../core/libs/gl-matrix-2/vec3f64","../support/debugFlags","../webgl-engine/core/shaderTechnique/CommonUniformStore","../webgl-engine/core/shaderTechnique/ShaderTechniqueRepository","../webgl-engine/lib/AutoDisposable","../webgl-engine/lib/Camera","../webgl-engine/lib/GLMaterialRep","../webgl-engine/lib/glUtil3D","../webgl-engine/lib/GridLocalOriginFactory","../webgl-engine/lib/intersectorUtils","../webgl-engine/lib/RenderContext","../webgl-engine/lib/renderStats","../webgl-engine/lib/SortedRenderGeometryRenderer","../webgl-engine/lib/TextureTechnique","../webgl-engine/lighting/Lightsources","../webgl-engine/lighting/SceneLighting","../webgl-engine/materials/lineStippleUtils","../../webgl/FramebufferObject","../../webgl/Texture","../../webgl/Util"],(function(e,r,t,i,n,a,s,o,d,u,l,h,p,g,c,y,f,m,_,R,w,v,x,b,T,O,P,U,C,M,L){Object.defineProperty(r,"__esModule",{value:!0});var S=n.getLogger("esri.views.3d.webgl-engine.lib.OverlayRenderer"),q=function(e){function n(t){var i=e.call(this)||this;return i._hasHighlights=!1,i._rendersOccluded=!1,i._lighting=new P.SceneLighting,i._localOrigins=new R,i._layerViewHandles=new Map,i._layerRenderers=new Map,i._sortedLayerRenderersDirty=!1,i._sortedLayerRenderers=new o,i._stats=new x.RenderStatsAggregator,i._geometries=new Map,i._renderTargets={},i._uniqueIdx=0,i.longitudeCyclical=null,i._rctx=t.renderingContext,i._renderContext=new v(i._rctx,null,null,null,null,null),i._stippleTextureRepository=new U.StippleTextureRepository,i._shaderTechniqueRepository=new c.ShaderTechniqueRepository({rctx:i._rctx,viewingMode:1,commonUniformStore:new g.CommonUniformStore,stippleTextureRepository:i._stippleTextureRepository}),i._materialRepository=new m(t.textureRepository,i._shaderTechniqueRepository),i._materialRepository.onMaterialChanged=function(e){(e.renderOccluded&r.overlayRenderOccludedFlag)>0!==i._rendersOccluded&&i.updateRendersOccluded(),i.emitContentChanged()},i._compositingHelper=t.compositingHelper,i._bindParameters={slot:null,fovY:0,highlightDepthTexture:_.createEmptyDepthTexture(i._rctx),nearFar:[V.near,V.far],origin:null,pixelRatio:null,proj:null,shadowMappingEnabled:!1,slicePlane:null,ssaoEnabled:!1,view:null,viewInvTransp:null,viewport:null,hasOccludees:!1},i._lighting.set({lights:[new O.AmbientLight(h.vec3f64.fromValues(1,1,1))],groundLightingFactor:1,globalFactor:0}),i}return t(n,e),n.prototype.dispose=function(){for(var e in this._layerRenderers.forEach((function(e){return e.dispose()})),this._layerRenderers.clear(),this._renderTargets)this._renderTargets[e].dispose();this._renderTargets=null,this._bindParameters.highlightDepthTexture.dispose(),this._bindParameters.highlightDepthTexture=null},n.prototype.disposeRenderTarget=function(e){var r=this._renderTargets[e];r&&r.dispose(),delete this._renderTargets[e]},Object.defineProperty(n.prototype,"updating",{get:function(){return this._sortedLayerRenderersDirty||a.someMap(this._layerRenderers,(function(e){return e.updating}))},enumerable:!0,configurable:!0}),n.prototype.commitChanges=function(){var e=this,r=!1;this._layerRenderers.forEach((function(t,i){if(t.commitChanges()&&(r=!0),t.isEmpty){e._layerRenderers.delete(i),e._sortedLayerRenderersDirty=!0;var n=e._layerViewHandles.get(i);n&&(n.remove(),e._layerViewHandles.delete(i))}})),this._sortedLayerRenderersDirty&&(this.updateSortedLayerRenderers(),r=!0),this.emitUpdatingChanged(),r&&(this.emitContentChanged(),this.updateHasHighlights(),this.updateRendersOccluded())},n.prototype.getRenderTargetTexture=function(e){var r=this._renderTargets[e];return r?r.colorTexture:null},n.prototype.addGeometries=function(e,r,t){for(var i=0,n=e;i<n.length;i++){var a=n[i];null==a.origin&&(a.origin=this._localOrigins.getOrigin(a.center)),a.uniqueName||(a.uniqueName="ov:"+this._uniqueIdx++),this._geometries.set(a.uniqueName,a)}this.ensureLayerRenderer(r).add(e),2===t&&this.notifyGraphicUpdate(e,r,2)},n.prototype.removeGeometries=function(e,r,t){for(var i=0,n=e;i<n.length;i++){var a=n[i];this._geometries.delete(a.uniqueName)}var s=this._layerRenderers.get(r);s?(s.remove(e),2===t&&this.notifyGraphicUpdate(e,r,2)):S.warn("Attempted to remove geometry for nonexistent layer")},n.prototype.updateGeometries=function(e,r,t){var i=this._layerRenderers.get(r);i?(i.modify(e,t),this.notifyUpdateGeometries(e,r,t)):S.warn("Attempted to update geometry for nonexistent layer")},n.prototype.notifyUpdateGeometries=function(e,r,t){var i=4===t||2===t?2:1===t?1:0;this.notifyGraphicUpdate(e,r,i)},n.prototype.notifyGraphicUpdate=function(e,r,t){if(0!==t)for(var i=-1,n=0,a=e;n<a.length;n++){var s=a[n].data.graphicUid;s!==i&&(r.notifyGraphicUpdate(s,t),i=s)}},n.prototype.updateHighlights=function(e,r){var t=this._layerRenderers.get(r);t?t.modify(e,8):S.warn("Attempted to update highlights for nonexistent layer")},n.prototype.isEmpty=function(){return 0===this._geometries.size&&!p.OVERLAY_DRAW_DEBUG_TEXTURE},Object.defineProperty(n.prototype,"hasHighlights",{get:function(){return this._hasHighlights},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"hasWater",{get:function(){return a.someMap(this._layerRenderers,(function(e){return e.hasWater}))},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"rendersOccluded",{get:function(){return this._rendersOccluded},enumerable:!0,configurable:!0}),n.prototype.updateLogic=function(e){var r=!1;return this._layerRenderers.forEach((function(t){t.updateLogic(e)&&(r=!0)})),r},n.prototype.updateLayerOrder=function(){this._sortedLayerRenderersDirty=!0},n.prototype.draw=function(e,r){return this.drawPass(0,e,r)},n.prototype.drawWithoutRasterImage=function(e,r){return this.drawPass(0,e,r,2)},n.prototype.drawNormals=function(e,r){return this.drawPass(2,e,r)},n.prototype.drawHighlights=function(e,r){return this.drawPass(4,e,r)},n.prototype.drawOccluded=function(e,r){return this.drawPass(0,e,r,1)},n.prototype.drawPass=function(e,t,i,n){var a=this;if(void 0===n&&(n=0),0===i.numViews)return!1;if(this._pixelRatio=i.pixelRatio*Math.abs(i.views[0].extent[2]-i.views[0].extent[0])/Math.abs(i.views[0].viewport[2]-i.views[0].viewport[0]),this.isEmpty()||4===e&&!this.hasHighlights||2===e&&!this.hasWater)return!1;if(!this.hasNonZeroSizedView(i))return!1;var o=i.width,d=i.height,u=this._renderTargets[t];if(!u)return!1;u.resize(o,d);var l=this._rctx,h=V;if(h.pixelRatio=i.pixelRatio||1,this._renderContext.pass=e,this._bindParameters.pixelRatio=h.pixelRatio,l.bindFramebuffer(u),l.setClearColor(0,0,0,0),l.clearSafe(16384),this.updateLightingUniforms(),1===n&&(this._renderContext.renderOccludedMask=r.overlayRenderOccludedFlag),p.OVERLAY_DRAW_DEBUG_TEXTURE&&1!==n)for(var g=0;g<i.numViews;g++)this.setViewParameters(i.views[g],h),this.drawDebugTexture(o,d,H[i.index%H.length]);return this._layerRenderers.size>0&&this._sortedLayerRenderers.forEach((function(r){var t=r.layerView,p=r.renderer;if(2!==n||!s.isSome(t)||0!==t.drapeSourceType){var g=s.isSome(t)&&s.isSome(t.fullOpacity)&&t.fullOpacity<1&&0===e;g&&(a.bindTemporaryFramebuffer(o,d),l.clearSafe(16384));for(var c=0;c<i.numViews;c++)a.setViewParameters(i.views[c],h),p.draw(a._renderContext,a._bindParameters,a._stats);g&&(l.bindFramebuffer(u),a._compositingHelper.composite(a.temporaryTexture,2,s.expect(s.expect(t).fullOpacity)))}})),l.bindFramebuffer(null),u.colorTexture.descriptor.hasMipmap&&u.colorTexture.generateMipmap(),this._renderContext.resetRenderOccludedMask(),!0},n.prototype.createRenderTarget=function(e,r){for(var t=e,i=0;this._renderTargets[t];)t=e+"_"+ ++i;return this._renderTargets[t]=new C(this._rctx,{colorTarget:0,depthStencilTarget:0},{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9987,hasMipmap:r,maxAnisotropy:8,width:0,height:0}),t},n.prototype.disposeRenderTargetMemory=function(e){var r=this._renderTargets[e];r&&r.resize(0,0)},n.prototype.bindTemporaryFramebuffer=function(e,r){s.isNone(this._temporaryRenderTargetId)&&(this._temporaryRenderTargetId=this.createRenderTarget("temp",!1));var t=this._renderTargets[this._temporaryRenderTargetId];t.resize(e,r),this._rctx.bindFramebuffer(t)},Object.defineProperty(n.prototype,"temporaryTexture",{get:function(){return this._renderTargets[s.expect(this._temporaryRenderTargetId)].colorTexture},enumerable:!0,configurable:!0}),n.prototype.getGpuMemoryUsage=function(){var e=0;for(var r in this._renderTargets){var t=this._renderTargets[r];e+=L.getGpuMemoryUsage(t)}return e},n.prototype.getStats=function(){return this._stats.getAggregatedStats()},n.prototype.intersect=function(e,r,t){var i=this,n=0;this._geometries.forEach((function(a){if(!t||t(a)){i.intersectRenderGeometry(a,r,0,e,n);var s=i.longitudeCyclical;s&&(a.center[0]-a.bsRadius<s.min&&i.intersectRenderGeometry(a,r,s.range,e,n),a.center[0]+a.bsRadius>s.max&&i.intersectRenderGeometry(a,r,-s.range,e,n)),n++}}))},n.prototype.intersectRenderGeometry=function(e,r,t,i,n){var a=this,o=0;s.isSome(e.transformation)&&(t+=e.transformation[12],o=e.transformation[13]),E[0]=r[0]-t,E[1]=r[1]-o,E[2]=1,A[0]=r[0]-t,A[1]=r[1]-o,A[2]=0,e.pixelRatio=this._pixelRatio,e.material.intersect(e,null,e.getShaderTransformation(),i,E,A,(function(r,t,s){a.addIntersectionResult(s,e.material.renderPriority,n,i,e.data.layerUid,e.data.graphicUid)}),e.calculateShaderTransformation,!0)},n.prototype.addIntersectionResult=function(e,r,t,i,n,a){var s={type:"external",metadata:{layerUid:n,graphicUid:a}},o=function(n){n.set(s,null,i.results.ground.dist,i.results.ground.normal,i.results.ground.transformation,r,null,null,e,t),n.intersector="OverlayRenderer"};if((null==i.results.min.drapedLayerOrder||r>=i.results.min.drapedLayerOrder)&&(null==i.results.min.dist||i.results.ground.dist<=i.results.min.dist)&&o(i.results.min),0!==i.options.store&&(null==i.results.max.drapedLayerOrder||r<i.results.max.drapedLayerOrder)&&(null==i.results.max.dist||i.results.ground.dist>i.results.max.dist)&&o(i.results.max),2===i.options.store){var d=new w.IntersectorResult(i.ray);o(d),i.results.all.push(d)}},n.prototype.ensureLayerRenderer=function(e){var r=this,t=this._layerRenderers.get(e);return t||(t=new b.SortedRenderGeometryRenderer(this._rctx,this._materialRepository,(function(){return r.emitUpdatingChanged()})),this._layerRenderers.set(e,t),this._sortedLayerRenderersDirty=!0,this._layerViewHandles.set(e,e.watch("fullOpacity",(function(){return r.emitContentChanged()})))),t},n.prototype.updateSortedLayerRenderers=function(){var e=this;if(this._sortedLayerRenderersDirty&&(this._sortedLayerRenderersDirty=!1,this._sortedLayerRenderers.clear(),0!==this._layerRenderers.size)){var r=a.firstKeyOfMap(this._layerRenderers).view.allLayerViews,t=d.createSetFromValues(a.valuesOfMap(this._layerRenderers));r.forEach((function(r){var i=r,n=e._layerRenderers.get(i);n&&(e._sortedLayerRenderers.push(new D(i,n)),t.delete(n))})),t.forEach((function(r){e._sortedLayerRenderers.push(new D(null,r))}))}},n.prototype.setViewParameters=function(e,r){r.viewport=e.viewport;var t=e.extent;l.mat4.ortho(r.projectionMatrix,0,t[2]-t[0],0,t[3]-t[1],r.near,r.far),l.mat4.identity(r.viewMatrix),l.mat4.translate(r.viewMatrix,r.viewMatrix,[-e.extent[0],-e.extent[1],0]),r.setGLViewport(this._rctx),this._renderContext.camera=r,this._bindParameters.view=r.viewMatrix,this._bindParameters.proj=r.projectionMatrix,this._bindParameters.viewInvTransp=r.viewInverseTransposeMatrix,this._bindParameters.viewport=r.fullViewport,this._shaderTechniqueRepository.getProgramsUsingUniform("proj").forEach((function(e){e.setUniformMatrix4fv("proj",r.projectionMatrix)}))},n.prototype.updateLightingUniforms=function(){var e=this;this._shaderTechniqueRepository.getProgramsUsingUniform("lightingMainDirection").forEach((function(r){e._lighting.setUniforms(r)}))},n.prototype.hasNonZeroSizedView=function(e){for(var r=0;r<e.numViews;r++){var t=e.views[r];if(t.extent[0]!==t.extent[2]&&t.extent[1]!==t.extent[3])return!0}return!1},n.prototype.emitContentChanged=function(){this.onContentChanged&&this.onContentChanged()},n.prototype.emitUpdatingChanged=function(){this.onUpdatingChanged&&this.onUpdatingChanged()},n.prototype.updateHasHighlights=function(){var e=a.someMap(this._layerRenderers,(function(e){return e.hasHighlights}));e!==this._hasHighlights&&(this._hasHighlights=e,this.onHasHighlightsChanged&&this.onHasHighlightsChanged(this._hasHighlights))},n.prototype.updateRendersOccluded=function(){var e=a.someMap(this._layerRenderers,(function(e){return e.rendersOccluded}));e!==this._rendersOccluded&&(this._rendersOccluded=e,this.onRendersOccludedChanged&&this.onRendersOccludedChanged(this.rendersOccluded))},n.prototype.drawDebugTexture=function(e,r,t){var i=this._rctx;this.ensureDebugPatternResources(e,r);var n=this._debugPatternProgram;i.bindProgram(n),i.setPipelineState(this._debugPatternPipelineState),n.setUniform4f("color",t[0],t[1],t[2],1),n.setUniform1i("tex",0),i.bindTexture(this._debugPatternTexture,0),i.bindVAO(this._quadVAO),i.drawArrays(5,0,L.vertexCount(this._quadVAO,"geometry"))},n.prototype.ensureDebugPatternResources=function(e,r){if(!this._debugPatternTexture){for(var t=new Uint8Array(e*r*4),i=0,n=0;n<r;n++)for(var a=0;a<e;a++){var s=Math.floor(a/10),o=Math.floor(n/10);s<2||o<2||10*s>e-20||10*o>r-20?(t[i++]=255,t[i++]=255,t[i++]=255,t[i++]=255):(t[i++]=255,t[i++]=255,t[i++]=255,t[i++]=1&s&&1&o?1&a^1&n?0:255:1&s^1&o?0:128)}this._debugPatternTexture=new M(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:e,height:r},t);var d=new T.TextureTechniqueConfiguration;d.hasAlpha=!0,this._debugTextureTechnique=this._shaderTechniqueRepository.acquireAndReleaseExisting(T.TextureTechnique,d,this._debugTextureTechnique),this._debugPatternProgram=this._debugTextureTechnique.program,this._debugPatternPipelineState=this._debugTextureTechnique.pipeline,this._quadVAO=_.createQuadVAO(this._rctx)}},Object.defineProperty(n.prototype,"test",{get:function(){return{layerRenderers:this._layerRenderers}},enumerable:!0,configurable:!0}),i([y.autoDispose()],n.prototype,"_shaderTechniqueRepository",void 0),i([y.autoDispose()],n.prototype,"_stippleTextureRepository",void 0),n}(u.declared(y.AutoDisposable));r.OverlayRenderer=q;var D=function(e,r){this.layerView=e,this.renderer=r},H=[[1,.5,.5],[.5,.5,1],[.5,1,.5]],V=new f.default;V.near=1,V.far=1e4;var E=h.vec3f64.create(),A=h.vec3f64.create();r.DRAPED_Z=-2,r.overlayRenderOccludedFlag=4}));