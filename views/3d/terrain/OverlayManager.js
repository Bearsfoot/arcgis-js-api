// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","../../../Graphic","../../../core/Accessor","../../../core/Handles","../../../core/has","../../../core/mathUtils","../../../core/mathUtils","../../../core/now","../../../core/scheduling","../../../core/accessorSupport/decorators","../../../core/libs/gl-matrix-2/vec2","../../../core/libs/gl-matrix-2/vec3","../../../core/libs/gl-matrix-2/vec3f64","../../../core/libs/gl-matrix-2/vec4","../../../core/libs/gl-matrix-2/vec4f64","../../../geometry/Point","../../../geometry/support/aaBoundingRect","../../../layers/support/timeUtils","../../../symbols/SimpleMarkerSymbol","../state/utils/viewUtils","../support/animationUtils","../support/debugFlags","../support/debugFlags","../support/earthUtils","../support/geometryUtils","../support/mathUtils","../support/projectionUtils","./OverlayRenderer","../webgl-engine/lib/Intersector","../webgl-engine/lib/localOrigin","../../support/Scheduler"],(function(e,t,r,i,a,s,n,o,l,d,c,h,u,p,y,v,g,_,f,T,m,w,O,R,x,S,D,M,C,I,b,E,U,P){Object.defineProperty(t,"__esModule",{value:!0});var A,V=[[-.1,-2,3.9,2],[-.1,-3.9,3.9,.1],[-2,-3.9,2,.1],[-3.9,-3.9,.1,.1],[-3.9,-2,.1,2],[-3.9,-.1,.1,3.9],[-2,-.1,2,3.9],[-.1,-.1,3.9,3.9]],H=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._handles=new n,t._overlaySR=null,t._renderSR=null,t._overlaySREqualsRenderSR=!0,t._drapeSources=new Map,t._drapeTargets=new Set,t._overlays=null,t._drapeSourceTypes=[0,0],t._drapeTargetTypes=[0,0],t._renderedAltitude=0,t._placementDirty=!1,t._drawTexturesDirty=!1,t._drawTexturesAnimateDirty=!1,t._hasUnusedRenderTargets=!1,t._isSpherical=!1,t._longitudeCyclical=null,t._latestOriginId=0,t._maxResolution=o("esri-mobile")?2048:4096,t._animationTimeLast=0,t._forceAnimation=!1,t}return r(t,e),Object.defineProperty(t.prototype,"updating",{get:function(){return this.needsUpdate()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hasHighlights",{get:function(){return this._renderer.hasHighlights},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"rendersOccluded",{get:function(){return this._renderer.rendersOccluded},enumerable:!0,configurable:!0}),t.prototype.initialize=function(){var e=this;this._stage=this.view._stage,this._renderer=new b.OverlayRenderer(this._stage.renderView),this._stage.renderView.updateLogicClients.add(this._renderer),this._drapeTargetTypes[0]++,this._renderer.onHasHighlightsChanged=function(){e.setDrawTexturesDirty(),e.notifyChange("hasHighlights")},this._renderer.onRendersOccludedChanged=function(){e.setDrawTexturesDirty(),e.notifyChange("rendersOccluded")},this._renderer.onContentChanged=function(){return e.setDrawTexturesDirty()},this.groundIntersector=new E.Intersector(this.view.viewingMode),this.groundIntersector.options.backfacesTerrain=!0,this.groundIntersector.options.invisibleTerrain=!0,this.groundIntersector.options.hud=!1,this._handles.add([this.view.watch(["pointsOfInterest.renderPointOfView","pointsOfInterest.centerOnSurfaceFrequent.location","pixelRatio"],(function(){return e.setOverlayPlacementDirty()})),this.terrainSurface.on("elevation-change",(function(){return e.setOverlayPlacementDirty()})),this.view.on("resize",(function(){return e.setOverlayPlacementDirty()})),h.addFrameTask({preRender:function(t){e._renderer.commitChanges(),e.hasOverlays()&&(e._dispatchRendererUpdate(t),e._drawOverlayTextures()),e._hasUnusedRenderTargets&&e._collectUnusedRenderTargetMemory()}}),this.view.resourceController.scheduler.registerTask(P.Task.OVERLAY_MANAGER,(function(){return e.updateOverlays()}),(function(){return e.needsUpdate()})),this.view._stage.renderView.events.on("force-camera-for-screenshot",(function(t){e.updateOverlays(t),e._drawOverlayTextures()}))])},t.prototype.destroy=function(){var e=this;this._drapeSources.forEach((function(t,r){return e._unregisterDrapeSource(r)})),this._drapeTargets.forEach((function(t,r){return e._unregisterDrapeTarget(r)})),this._drapeTargetTypes[0]--,this._disposeOverlays(),this._stage.renderView.updateLogicClients.remove(this._renderer),this._renderer.dispose(),this._handles&&(this._handles.destroy(),this._handles=null)},Object.defineProperty(t.prototype,"renderer",{get:function(){return this._renderer},enumerable:!0,configurable:!0}),t.prototype.onHasHighlightsChanged=function(){this.setOverlayContentDirty(),this.notifyChange("hasHighlights")},t.prototype.hasOverlays=function(){return!!this._overlays},t.prototype.setSpatialReference=function(e,t){this._overlaySR=e,this._longitudeCyclical=null,e?(this._renderSR=this.view.renderSpatialReference,this._overlaySREqualsRenderSR=this._overlaySR.equals(this._renderSR),this._isSpherical=t,t&&(this._longitudeCyclical=e.isWebMercator?new C.Cyclical(-20037508.342787,20037508.342787):new C.Cyclical(-180,180),this._renderer.longitudeCyclical=this._longitudeCyclical)):this._disposeOverlays(),this.notifyChange("updating")},t.prototype.getGpuMemoryUsage=function(){return this._renderer.getGpuMemoryUsage()},t.prototype.updateLayerViews=function(e){for(var t=this,r=0,i=this.view.allLayerViews.items;r<i.length;r++){var a=i[r];"drapeSourceType"in a&&!this._drapeSources.has(a)&&this._registerDrapeSource(a),"drapeTargetType"in a&&!this._drapeTargets.has(a)&&this._registerDrapeTarget(a)}this._drapeSources.forEach((function(r,i){e.has(i.uid)||t._unregisterDrapeSource(i)})),this._drapeTargets.forEach((function(r){e.has(r.uid)||t._unregisterDrapeTarget(r)})),this._renderer.updateLayerOrder(),this.setDrawTexturesDirty()},t.prototype._registerDrapeSource=function(e){var t=this,r=e.on("draped-data-change",(function(){return t.setOverlayContentDirty()}));this._drapeSourceTypes[e.drapeSourceType]++,this._drapeSources.set(e,[r]),this._overlays&&e.setDrapingExtent&&this._overlays.forEach((function(r,i){return t._updateDrapeSource(e,i,r)})),this.setOverlayContentDirty()},t.prototype._updateDrapeSource=function(e,t,r){e.setDrapingExtent&&e.setDrapingExtent(t,r.extent,this._overlaySR,r.resolution,r.renderLocalOrigin,r.pixelRatio)},t.prototype._unregisterDrapeSource=function(e){if(this._drapeSources.has(e)){var t=this._drapeSources.get(e);t&&t.forEach((function(e){return e.remove()})),this._drapeSourceTypes[e.drapeSourceType]--,this._drapeSources.delete(e),this.setOverlayContentDirty()}},t.prototype._registerDrapeTarget=function(e){this._drapeTargets.add(e),this._updateDrapeTarget(e),this._drapeTargetTypes[e.drapeTargetType]++},t.prototype._updateDrapeTarget=function(e){var t=this;this._overlays&&this._overlays.forEach((function(r,i){var a=r.renderTargets,s=t.needsColorWithoutRasterImage()?a.colorWithoutRasterImage:t.hasDrapedFeatures()?a.color:null,n=a.highlight,o=a.water;e.setDrapingTextures(i,r.extent,s&&s.valid?t.renderer.getRenderTargetTexture(s.id):null,n.valid?t.renderer.getRenderTargetTexture(n.id):null,o.valid?t.renderer.getRenderTargetTexture(o.id):null)}))},t.prototype._unregisterDrapeTarget=function(e){this._drapeTargets.delete(e),this._drapeTargetTypes[e.drapeTargetType]--},t.prototype.setOverlayContentDirty=function(){this.setOverlayPlacementDirty(),this.setDrawTexturesDirty()},t.prototype.setOverlayPlacementDirty=function(){this._placementDirty=!0,this.notifyChange("updating")},t.prototype.updateOverlays=function(e){if(void 0===e&&(e=this.view.state.camera),this._overlaySR){var t,r,i,a=(t=e.fullWidth,r=e.fullHeight,i=Math.max(t,r)+256,l.nextHighestPowerOfTwo(i)),s=Math.min(a,this._maxResolution);this._computeOverlayExtents(e,a,q);var n=T.width(q.inner)/T.width(q.outer);this._initOverlays();var o=this._updateOverlay(0,q.inner,s,1),d=this._updateOverlay(1,q.outer,s,n);(o||d)&&(this.terrainSurface.updateTileOverlayParams(),this.setDrawTexturesDirty()),this._placementDirty=!1,this.terrainSurface.updateOverlayOpacity(),this.notifyChange("updating")}},t.prototype._updateOverlay=function(e,t,r,i){var a=this,s=this._overlays[e];if(!function(e,t){for(var r=x.TESTS_DISABLE_UPDATE_THRESHOLDS?0:1e-5*Math.max(e[2]-e[0],e[3]-e[1],t[2]-t[0],t[3]-t[1]),i=0;i<4;i++)if(Math.abs(t[i]-e[i])>r)return!0;return!1}(t,s.extent)&&r===s.resolution&&s.pixelRatio===i)return!1;T.set(s.extent,t),s.resolution=r,s.pixelRatio=i;var n=T.center(s.extent);return s.renderLocalOrigin=U.fromValues(n[0],n[1],0,"OV_"+this._latestOriginId++),this._drapeSources.forEach((function(t,r){return a._updateDrapeSource(r,e,s)})),!0},t.prototype.needsUpdate=function(){return this._placementDirty&&(this._drapeSources.size>0||this.view.graphics.length>0||S.OVERLAY_DRAW_DEBUG_TEXTURE)&&!!this._overlaySR&&!this._get("suspended")&&this.terrainSurface.ready},t.prototype.updateOpacity=function(e){return this._overlays?this._getAltitudeBasedOpacity(e,this._renderedAltitude):1},t.prototype._getAltitudeBasedOpacity=function(e,t){if(3.5*e<t){var r=(e-t/10)/(t/3.5-t/10);return Math.sqrt(l.clamp(r,0,1))}return 1},t.prototype.setTileParameters=function(e,t,r){if(this._overlays){var i=this._overlays[0],a=this._overlays[1],s=T.intersection(e.extent,e.surface.extent,j);this._rectInsideRect(s,i.extent)?(this._setTileOverlayData(s,i,t.overlays[0]),this._invalidateTileOverlayData(t.overlays[1])):this._rectanglesOverlap(s,i.extent)?(this._setTileOverlayData(s,i,t.overlays[0]),this._setTileOverlayData(s,a,t.overlays[1])):this._rectanglesOverlap(s,a.extent)?(this._setTileOverlayData(s,a,t.overlays[0]),this._invalidateTileOverlayData(t.overlays[1])):(this._invalidateTileOverlayData(t.overlays[0]),this._invalidateTileOverlayData(t.overlays[1]))}else this._invalidateTileOverlayData(t.overlays[0]),this._invalidateTileOverlayData(t.overlays[1]);t.overlayOpacity=void 0!==r?r:1},t.prototype.overlayPixelSizeInMapUnits=function(e){if(!this._overlays)return 0;var t=this._overlays[0],r=this._overlays[1],i=this._pointIsInExtent(e,t.extent)?t:r;return(i.extent[2]-i.extent[0])/i.resolution},t.prototype._setTileOverlayData=function(e,t,r){var i=t.extent;r.texScale[0]=(e[2]-e[0])/(i[2]-i[0]),r.texScale[1]=(e[3]-e[1])/(i[3]-i[1]);var a=e[0];if(this._longitudeCyclical){a=this._longitudeCyclical.minimalMonotonic(i[0],a);var s=this._longitudeCyclical.minimalMonotonic(i[0],e[2]);a>s&&(a=s-(e[2]-e[0]))}r.texOffset[0]=(a-i[0])/(i[2]-i[0]),r.texOffset[1]=(e[1]-i[1])/(i[3]-i[1]);var n=t.renderTargets;r.renderTargetIds.color=n.color.valid?n.color.id:null,r.renderTargetIds.highlight=n.highlight.valid?n.highlight.id:null,r.renderTargetIds.water=n.water.valid?n.water.id:null,r.renderTargetIds.occluded=n.occluded.valid?n.occluded.id:null},t.prototype._invalidateTileOverlayData=function(e){e.renderTargetIds.color=null,e.renderTargetIds.highlight=null,e.renderTargetIds.water=null,e.renderTargetIds.occluded=null},t.prototype._createEmptyOverlay=function(e){return{extent:T.create(),resolution:0,renderTargets:{color:{id:this._renderer.createRenderTarget("overlay"+e,!0),valid:!1,lastUsed:1/0},colorWithoutRasterImage:{id:this._renderer.createRenderTarget("overlayWithoutRasterImage"+e,!0),valid:!1,lastUsed:1/0},highlight:{id:this._renderer.createRenderTarget("overlayHighlight"+e,!1),valid:!1,lastUsed:1/0},water:{id:this._renderer.createRenderTarget("overlayWaterMask"+e,!0),valid:!1,lastUsed:1/0},occluded:{id:this._renderer.createRenderTarget("overlayOccluded"+e,!0),valid:!1,lastUsed:1/0}},renderLocalOrigin:U.fromValues(0,0,0,"O"),pixelRatio:1}},t.prototype._initOverlays=function(){this._overlays||(this._overlays=[this._createEmptyOverlay(0),this._createEmptyOverlay(1)])},t.prototype._disposeOverlays=function(){var e=this;this._overlays&&(this._overlays.forEach((function(t){e._renderer.disposeRenderTarget(t.renderTargets.color.id),e._renderer.disposeRenderTarget(t.renderTargets.colorWithoutRasterImage.id),e._renderer.disposeRenderTarget(t.renderTargets.highlight.id),e._renderer.disposeRenderTarget(t.renderTargets.water.id),e._renderer.disposeRenderTarget(t.renderTargets.occluded.id)})),this._overlays=null)},t.prototype.forceAnimation=function(){this._forceAnimation=!0},t.prototype._dispatchRendererUpdate=function(e){var t=m.Milliseconds(e.time-this._animationTimeLast);t<R.DESIRED_DRAPED_ANIMATION_MS&&!this._forceAnimation||(this._forceAnimation=!1,this._animationTimeLast=e.time,this._renderer.updateLogic({dt:t,camera:this._stage.getCamera()})&&(this._drawTexturesAnimateDirty=!0))},t.prototype.setDrawTexturesDirty=function(){this._overlays?this._drawTexturesDirty=!0:this.setOverlayPlacementDirty()},t.prototype._intersectGroundFromView=function(e,t,r,i){var a=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(e,Y,t,r),s=a.origin,n=y.vec3.add(B,a.origin,a.direction);return this.groundIntersector.reset(s,n),this.groundIntersector.intersect([],null,e),this.view.basemapTerrain.intersect(this.groundIntersector,null,s,n),this.groundIntersector.results.min.getIntersectionPoint(i)},t.prototype._findHorizonBasedPointOfInterest=function(e,t,r){var i=.5;if("global"===this.view.viewingMode){var a=v.vec3f64.clone(e.eye);y.vec3.normalize(a,a),y.vec3.negate(a,a);var s=y.vec3.length(t),n=Math.asin(s/y.vec3.length(e.eye)),o=Math.acos(y.vec3.dot(e.viewForward,a)),d=n-(o-.5*e.fovY),c=l.clamp(d/e.fovY,0,1),h=-n-(o-.5*e.fovY),u=l.clamp(h/e.fovY,0,1);i=1===c&&0===u?.5:u+.55*(c-u)}else{var p=.5*Math.PI-Math.acos(-e.viewForward[2]),f=Math.tan(p),T=_.vec4f64.fromValues(0,f,1,0),m=g.vec4.transformMat4(T,T,e.projectionMatrix)[1],w=l.clamp(.5+.5*m,0,1);i=1===w||0===w?.5:e.eye[2]>0?.55*w:1-.55*(1-w)}return!!this._intersectGroundFromView(e,.5,i,r)},t.prototype._computeOverlayExtents=function(e,t,r){var i=this.terrainSurface.extent,s=this.view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,n=v.vec3f64.create();this._findHorizonBasedPointOfInterest(e,s,n)||y.vec3.copy(n,s),this._renderedAltitude=this.view.renderCoordsHelper.getAltitude(e.eye);var o=y.vec3.distance(e.eye,n),l=O.viewAngle(this.view.renderCoordsHelper,s,e.eye),c=Math.PI/2-Math.abs(l-Math.PI/2);if(S.OVERLAY_SHOW_CENTER){var h=new w({color:[255,0,0],outline:{color:[255,255,255],width:2}}),u=new f;I.vectorToPoint(n,this._renderSR,u,this._overlaySR);var _=new a({geometry:u,symbol:h});void 0!==A&&this.view.graphics.remove(A),this.view.graphics.add(_),A=_}this._overlaySREqualsRenderSR||I.vectorToVector(n,this._renderSR,n,this._overlaySR);var m=t*e.perRenderPixelRatio*o/2,R=!1,x=1/0;this._isSpherical&&(this._overlaySR.isWebMercator?(m/=Math.cos(I.webMercator.y2lat(n[1])),x=this.terrainSurface.extent[3]):(R=!0,m/=D.metersPerDegree,x=90),m>=x&&(m=x,n[1]=0,this._overlaySR.isWebMercator&&(n[0]=0)));var M=1;R&&m*(M=1/Math.max(.2,Math.cos(Math.abs(d.deg2rad(n[1])))))>180&&(M=180/m);var C=Math.log(2)/12,b=(m=Math.exp(Math.round(Math.log(m)/C)*C))*M,E=.5*t/(32*b),U=.5*t/(32*m);n[0]=Math.round(n[0]*E)/E,n[1]=Math.round(n[1]*U)/U;var P=r.inner;P[0]=n[0]-b,P[1]=n[1]-m,P[2]=n[0]+b,P[3]=n[1]+m,this._isSpherical&&this._shiftExtentToFitBounds(P,1/0,x);var H=r.outer;if(T.set(H,P),6*b>i[2]-i[0])T.set(H,i);else if(c<=.25*Math.PI)H[0]-=b,H[1]-=m,H[2]+=b,H[3]+=m;else{I.vectorToVector(e.eye,this._renderSR,B,this._overlaySR),p.vec2.subtract(G,n,B);var W=-Math.atan2(G[1],G[0])+.125*Math.PI;W<0&&(W+=2*Math.PI);var L=Math.floor(W/(.25*Math.PI));g.vec4.scale(G,V[L],2*m),G[0]*=M,G[2]*=M,g.vec4.add(H,H,G)}if(this._isSpherical&&(H[0]=this._longitudeCyclical.clamp(H[0]),H[2]=this._longitudeCyclical.clamp(H[2]),H[1]=Math.max(H[1],-x),H[3]=Math.min(H[3],x)),!this._isSpherical&&i){var F=T.intersection(P,i,j),q=T.intersection(H,i,z);T.contains(F,q)&&(H[2]=H[0],H[3]=H[1])}},t.prototype._drawOverlayTextures=function(){var e=this;if(this._drawTexturesDirty||this._drawTexturesAnimateDirty){var t=this._drawOverlay(0),r=this._drawOverlay(1);0!==t&&0!==r||this.terrainSurface.updateTileOverlayParams(),this._collectUnusedRenderTargetMemory(),this._drapeTargets.forEach((function(t){return e._updateDrapeTarget(t)})),this._drawTexturesDirty?(this._drawTexturesDirty=!1,this._drawTexturesAnimateDirty=!1,this.terrainSurface.requestRender(),this.terrainSurface.setPendingUpdates()):(this._drawTexturesAnimateDirty=!1,this.terrainSurface.requestRender(0))}},t.prototype._setupGeometryViewsCyclical=function(e,t,r){this._setupGeometryViewsDirect(e,t,r);var i=.001*this._longitudeCyclical.range;if(t[0]-i<=this._longitudeCyclical.min){var a=e.views[e.numViews++];g.vec4.set(a.viewport,0,0,r,r),T.offset(t,this._longitudeCyclical.range,0,a.extent)}if(t[2]+i>=this._longitudeCyclical.max){a=e.views[e.numViews++];g.vec4.set(a.viewport,0,0,r,r),T.offset(t,-this._longitudeCyclical.range,0,a.extent)}},t.prototype._setupGeometryViewsDirect=function(e,t,r){e.numViews=1;var i=e.views[0];T.set(i.extent,t),g.vec4.set(i.viewport,0,0,r,r)},t.prototype._drawOverlay=function(e){var t=this._overlays[e],r=W(t),i=t.extent,a=t.resolution,s=t.pixelRatio;this._longitudeCyclical?this._setupGeometryViewsCyclical(F,i,a):this._setupGeometryViewsDirect(F,i,a),F.width=a,F.height=a,F.pixelRatio=s*this.view.state.camera.pixelRatio,F.index=e;var n=this._renderer,o=t.renderTargets;return o.color.valid=n.draw(o.color.id,F),o.highlight.valid=n.drawHighlights(o.highlight.id,F),o.water.valid=n.drawNormals(o.water.id,F),o.occluded.valid=n.drawOccluded(o.occluded.id,F),o.colorWithoutRasterImage.valid=this.needsColorWithoutRasterImage()&&n.drawWithoutRasterImage(o.colorWithoutRasterImage.id,F),r^W(t)?0:1},t.prototype.needsColorWithoutRasterImage=function(){return this._drapeSourceTypes[0]>0&&this._drapeSourceTypes[1]>0&&this._drapeTargetTypes[1]>0},t.prototype.hasDrapedFeatures=function(){return this._drapeSourceTypes[1]>0},t.prototype._collectUnusedRenderTargetMemory=function(){var e=c();this._hasUnusedRenderTargets=!1;for(var t=0,r=this._overlays;t<r.length;t++){var i=r[t];for(var a in i.renderTargets){var s=i.renderTargets[a];s.valid?s.lastUsedTimestamp=e:e-s.lastUsedTimestamp>L?(this._renderer.disposeRenderTargetMemory(s.id),s.lastUsedTimestamp=1/0):s.lastUsedTimestamp<1/0&&(this._hasUnusedRenderTargets=!0)}}},t.prototype._rectanglesOverlap=function(e,t){return this._longitudeCyclical?(this._longitudeCyclical.contains(t[0],t[2],e[0])||this._longitudeCyclical.contains(t[0],t[2],e[2])||this._longitudeCyclical.contains(e[0],e[2],t[0]))&&!(e[1]>t[3]||e[3]<t[1]):T.intersects(e,t)},t.prototype._rectInsideRect=function(e,t){return this._longitudeCyclical?this._longitudeCyclical.contains(t[0],t[2],e[0])&&this._longitudeCyclical.contains(t[0],t[2],e[2])&&e[1]>t[1]&&e[3]<t[3]:T.contains(t,e)},t.prototype._pointIsInExtent=function(e,t){if(this._longitudeCyclical)return this._longitudeCyclical.contains(t[0],t[2],e.x)&&e.y>=t[1]&&e.y<=t[3];var r=e.x,i=e.y;return r>t[0]&&r<t[2]&&i>t[1]&&i<t[3]},t.prototype._shiftExtentToFitBounds=function(e,t,r){var i=0,a=0;e[0]<-t?i=e[0]+t:e[2]>t&&(i=t-e[2]),e[1]<-r?a=e[1]+r:e[3]>r&&(a=r-e[3]),T.offset(e,i,a)},Object.defineProperty(t.prototype,"test",{get:function(){return{overlays:this._overlays,renderer:this._renderer}},enumerable:!0,configurable:!0}),i([u.property()],t.prototype,"view",void 0),i([u.property()],t.prototype,"terrainSurface",void 0),i([u.property({readOnly:!0,aliasOf:"terrainSurface.suspended"})],t.prototype,"suspended",void 0),i([u.property({readOnly:!0,dependsOn:["terrainSurface.ready","suspended"]})],t.prototype,"updating",null),i([u.property({type:Boolean})],t.prototype,"hasHighlights",null),i([u.property({type:Boolean})],t.prototype,"rendersOccluded",null),t=i([u.subclass("esri.views.3d.terrain.OverlayManager")],t)}(u.declared(s));function W(e){var t=e.renderTargets;return+t.color.valid|+t.colorWithoutRasterImage.valid<<1|+t.highlight.valid<<2|+t.water.valid<<3|+t.occluded.valid<<4}t.OverlayManager=H;var L=1e3,F={width:0,height:0,pixelRatio:0,views:[{viewport:T.create(),extent:T.create()},{viewport:T.create(),extent:T.create()},{viewport:T.create(),extent:T.create()}],numViews:0,index:0},G=_.vec4f64.create(),B=v.vec3f64.create(),q={inner:T.create(),outer:T.create()},j=T.create(),z=T.create(),Y=M.ray.create()}));