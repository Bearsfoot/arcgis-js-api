// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/generatorHelper","../../../core/tsSupport/awaiterHelper","../../../request","../../../core/asyncUtils","../../../core/Error","../../../core/Logger","../../../core/promiseUtils","../../../core/watchUtils","../../../core/libs/gl-matrix-2/mat4","../../../core/libs/gl-matrix-2/mat4f64","./StarsTechnique","../support/buffer/glUtil","../support/buffer/InterleavedLayout","../webgl-engine/lib/DefaultVertexAttributeLocations","../../webgl/BufferObject","../../webgl/VertexArrayObject"],(function(t,e,r,a,i,o,s,n,f,u,l,c,h,d,_,p,b,m){var y=n.getLogger("esri.views.3d.environment.Stars"),g=function(){function e(t){this.slot=14,this.numBinaryFloats=2,this.numBinaryUInt8=1,this.bytesPerStar=9,this._loadDataController=f.createAbortController(),this._numStars=0,this._modelMatrix=c.mat4f64.create(),this._destroyed=!1,this.view=t,this._loadDataPromise=this._loadBrightStarCatalogue()}return Object.defineProperty(e.prototype,"canRender",{get:function(){return null!=this._vao},enumerable:!0,configurable:!0}),e.prototype.destroy=function(){this._destroyed=!0,this._loadDataController&&(this._loadDataController.abort(),this._loadDataController=null),this._dateHandle&&(this._dateHandle.remove(),this._dateHandle=null),this._vao&&(this._vao.dispose(),this._vao=null)},e.prototype.initializeRenderContext=function(t){var e=this;this._initContext=t;var r=t.rctx;this._starsTechnique=new h.StarsTechnique({rctx:r,viewingMode:"local"===this.view.viewingMode?1:0},null),this._dateHandle=u.init(this.view,"environment.lighting.date",(function(t){return e._update(t)})),this._loadDataPromise.then((function(){if(!e._destroyed){e._numStars=e._starData.byteLength/e.bytesPerStar;var a=new Float32Array(e._starData,0,e._numStars*e.numBinaryFloats),i=new Uint8Array(e._starData,e._numStars*e.numBinaryFloats*4,e._numStars*e.numBinaryUInt8);e._vao=e._createVertexArrayObject(r,a,i),t.requestRender()}}))},e.prototype.uninitializeRenderContext=function(){this.destroy()},e.prototype.render=function(t){if(t.slot!==this.slot||0!==t.pass)return!1;var e=t.rctx,r=this._starsTechnique.program;return e.bindProgram(r),this._starsTechnique.bindPass(e,t.camera),r.setUniformMatrix4fv("model",this._modelMatrix),this._starsTechnique.bindPipelineState(e),e.bindVAO(this._vao),r.assertCompatibleVertexAttributeLocations(this._vao),e.drawArrays(0,0,this._numStars),!0},e.prototype._computeDayDuration=function(t){var e=t,r=new Date(t.getFullYear(),0,1,11,58,56);return(+e-+r)/(+new Date(t.getFullYear()+1,0,1,11,58,55)-+r)},e.prototype._update=function(t){if(t){var e=(t.getHours()/12+t.getMinutes()/60*(2/24)+t.getSeconds()/60*(2/1440)-.9972222)%2,r=2*this._computeDayDuration(t),a=this._modelMatrix;l.mat4.copy(a,D),l.mat4.rotateZ(a,a,-r*Math.PI),l.mat4.multiply(a,w,a),l.mat4.rotateZ(a,a,-e*Math.PI),this._initContext.requestRender()}},e.prototype._hexToRGB=function(t){return[parseInt(t.substring(0,2),16),parseInt(t.substring(2,4),16),parseInt(t.substring(4,6),16)]},e.prototype._unpackUint8Attributes=function(t){return t>=192?[2.9,t-192]:t>=160?[2.5,t-160]:t>=128?[2,t-128]:t>=96?[1.5,t-96]:t>=64?[1,t-64]:t>=32?[.7,t-32]:[.4,t]},e.prototype._createVertexArrayObject=function(t,e,r){for(var a=S.createBuffer(this._numStars),i=a.position,o=a.color,s=a.size,n=0;n<this._numStars;n++){var f=e[2*n+0],u=e[2*n+1];i.set(n,0,-Math.cos(f)*Math.sin(u)),i.set(n,1,-Math.sin(f)*Math.sin(u)),i.set(n,2,-Math.cos(u));var l=this._unpackUint8Attributes(r[n]),c=this._hexToRGB(v[l[1]]);o.set(n,0,255*c[0]),o.set(n,1,255*c[1]),o.set(n,2,255*c[2]),o.set(n,3,255),s.set(n,l[0])}return new m(t,p.Default3D,{geometry:d.glLayout(S)},{geometry:b.createVertex(t,35044,a.buffer)})},e.prototype._verifyStartData=function(t){if(!t)throw new s("stars:no-data-received","Failed to create stars because star catalogue is missing");var e=t.byteLength/this.bytesPerStar;if(e%1!=0||e>5e4||e<5e3)throw new s("stars:invalid-data","Failed to create stars because star catalogue data is invalid")},e.prototype._loadBrightStarCatalogue=function(){return a(this,void 0,void 0,(function(){var e,a,s;return r(this,(function(r){switch(r.label){case 0:return x?(this._starData=x,[2]):[4,o.result(i(t.toUrl("./resources/stars.wsv"),{responseType:"array-buffer",signal:this._loadDataController.signal}))];case 1:if(e=r.sent(),this._loadDataController=null,!1===e.ok){if(f.isAbortError(e.error))throw e.error;return y.error("loadBrightStarCatalogue",e.error.message),[2]}a=e.value,s=a.data;try{this._verifyStartData(s)}catch(t){throw y.error("loadBrightStarCatalogue",t),t}return x=s,this._starData=s,[2]}}))}))},e}(),v=["9bb2ff","9eb5ff","aabfff","bbccff","ccd8ff ","dae2ff","e4e9ff","eeefff","f8f6ff","fff9fb","fff5ef","fff1e5","ffeddb","ffe9d2","ffe6ca","ffe3c3","ffe0bb","ffddb4","ffdaad","ffd6a5","ffd29c","ffcc8f","ffc178","ffa94b","ff7b00"],w=c.mat4f64.fromValues(1,0,0,0,0,.9174771405229186,.39778850739794974,0,0,-.39778850739794974,.9174771405229186,0,0,0,0,1),D=c.mat4f64.fromValues(1,0,0,0,0,.9174771405229186,-.39778850739794974,0,0,.39778850739794974,.9174771405229186,0,0,0,0,1),S=_.newLayout().vec3f("position").vec4u8("color").f32("size"),x=null;return g}));