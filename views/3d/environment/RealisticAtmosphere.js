// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/generatorHelper","../../../core/tsSupport/awaiterHelper","../../../core/Handles","../../../core/promiseUtils","../../../core/watchUtils","../../../core/libs/gl-matrix-2/vec2","../../../core/libs/gl-matrix-2/vec2f64","../../../core/libs/gl-matrix-2/vec3","../../../core/libs/gl-matrix-2/vec3f64","../../../core/libs/gl-matrix-2/vec4","../../../core/libs/gl-matrix-2/vec4f64","./atmosphereUtils","./RealisticAtmosphereTechnique","../support/earthUtils","../support/buffer/glUtil","../support/buffer/InterleavedLayout","../webgl-engine/lib/DefaultVertexAttributeLocations","../../webgl/BufferObject","../../webgl/VertexArrayObject"],(function(e,t,a,r,i,s,n,o,h,c,d,l,u,p,m,f,v,_,g,D,R){Object.defineProperty(t,"__esModule",{value:!0});var b=function(){function e(e,t){this._view=e,this.canRender=!0,this._skyslot=14,this._hazeSlot=15,this._renderData={texDepth:h.vec2f64.create(),cameraPosition:d.vec3f64.create(),cameraUp:d.vec3f64.create(),cameraRight:d.vec3f64.create(),cameraDir:d.vec3f64.create(),halfSizeNearPlane:h.vec2f64.create(),cameraCenterOffset:h.vec2f64.create(),heightParameters:u.vec4f64.create(),atmosphereParameters1:u.vec4f64.create(),atmosphereParameters2:u.vec4f64.create(),atmosphereParameters3:d.vec3f64.create(),invWavelength:P,invWavelengthScaled:w,radii:h.vec2f64.create(),scale:0,scaleDepth:S,lowerAlphaBlendBound:0,scaleOverScaleDepth:0,oneOverScaleDepth:0,scaleDepthBlue:x,oneOverScaleDepthBlue:U,scaleOverScaleDepthBlue:0,g:H,g2:H*H,miePhaseCoefficients:C,nearFar:h.vec2f64.create(),cameraHeight:0,cameraHeightSq:0,C:0,CSur:0,innerFadeDistance:0,altitudeFade:0},this._lowerElevationBoundRadius=0,this._earthRadius=f.earthRadius,this._updateRadius(f.earthRadius),this._techniqueRepository=t,this._atmosphereTechniqueConfig=new m.RealisticAtmosphereTechniqueConfiguration}return e.prototype.destroy=function(){this._handles&&(this._handles.destroy(),this._handles=null),this._vao&&(this._vao.dispose(),this._vao=null)},e.prototype.when=function(){return s.resolve()},e.prototype.initializeRenderContext=function(e){var t=this,a=e.rctx;this._handles=new i,this._updateElevation({spatialReference:this._view.basemapTerrain.spatialReference,tile:this._view.basemapTerrain.rootTiles[0],extent:this._view.basemapTerrain.rootTiles[0].extent,context:"ground"}),this._handles.add(n.on(this._view,"basemapTerrain","elevation-change",(function(e){return t._updateElevation(e)}),(function(){return t._updateElevation()}))),this._handles.add(n.on(this._view,"basemapTerrain","elevation-bounds-change",(function(){return t._updateVisibleElevationBounds()}),(function(){return t._updateVisibleElevationBounds()}))),this._atmosphereTechniqueConfig.haze=!1,this._atmosphereTechnique=this._techniqueRepository.acquireAndReleaseExisting(m.RealisticAtmosphereTechnique,this._atmosphereTechniqueConfig,this._atmosphereTechnique),this._atmosphereTechniqueConfig.haze=!0,this._atmosphereHazeTechnique=this._techniqueRepository.acquireAndReleaseExisting(m.RealisticAtmosphereTechnique,this._atmosphereTechniqueConfig,this._atmosphereHazeTechnique),this._vao=this._createVertexArrayObject(a)},e.prototype.uninitializeRenderContext=function(){this.destroy()},e.prototype.render=function(e){return(e.slot===this._hazeSlot||e.slot===this._skyslot)&&0===e.pass&&(this._update(e.camera),e.slot===this._skyslot&&this._renderSky(e),e.slot===this._hazeSlot&&this._renderHaze(e),!0)},e.prototype._renderSky=function(e){var t=e.rctx,a=this._atmosphereTechnique.program;t.bindProgram(a),this._atmosphereTechnique.bindPipelineState(t),a.setUniform3fv("atmosphereParameters3",this._renderData.atmosphereParameters3),this._renderCommon(a,e)},e.prototype._renderHaze=function(e){var t=this,a=e.rctx,r=e.offscreenRenderingHelper,i=this._atmosphereHazeTechnique.program;a.bindProgram(i),this._atmosphereHazeTechnique.bindPipelineState(a),r.renderDepthDetached((function(){var s=r.depthTexture;a.bindTexture(s,0),i.setUniform1i("depthTex",0),t._renderCommon(i,e)}))},e.prototype._renderCommon=function(e,t){var a=t.rctx;e.setUniform3fv("invWavelength",this._renderData.invWavelength),e.setUniform3fv("invWavelengthScaled",this._renderData.invWavelengthScaled),t.scenelightingData.setLightDirectionUniform(e),e.setUniform4fv("heightParameters",this._renderData.heightParameters),e.setUniform3fv("cameraPosition",this._renderData.cameraPosition),e.setUniform3fv("cameraUp",this._renderData.cameraUp),e.setUniform3fv("cameraRight",this._renderData.cameraRight),e.setUniform3fv("cameraDir",this._renderData.cameraDir),e.setUniform2fv("nearFar",this._renderData.nearFar),e.setUniform2fv("halfSizeNearPlane",this._renderData.halfSizeNearPlane),e.setUniform2fv("cameraCenterOffset",this._renderData.cameraCenterOffset),e.setUniform2fv("radii",this._renderData.radii),e.setUniform4fv("atmosphereParameters1",this._renderData.atmosphereParameters1),e.setUniform4fv("atmosphereParameters2",this._renderData.atmosphereParameters2),e.setUniform1f("innerFadeDistance",this._renderData.innerFadeDistance),e.setUniform1f("altitudeFade",this._renderData.altitudeFade),a.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),a.drawArrays(5,0,4)},e.prototype._createVertexArrayObject=function(e){var t=V.createBuffer(4);return t.position.setVec(0,[-1,-1,1]),t.position.setVec(1,[1,-1,1]),t.position.setVec(2,[-1,1,1]),t.position.setVec(3,[1,1,1]),t.uv0.setVec(0,[0,0]),t.uv0.setVec(1,[1,0]),t.uv0.setVec(2,[0,1]),t.uv0.setVec(3,[1,1]),new R(e,g.Default3D,{geometry:v.glLayout(V)},{geometry:D.createVertex(e,35044,t.buffer)})},e.prototype._adjustRadiusForTesselation=function(e){var t=Math.PI/Math.pow(2,4)/16;return e*Math.cos(t)},e.prototype._updateElevation=function(e){var t=e?e.tile:this._view.basemapTerrain.rootTiles[0];if(0===t.lij[0]){var a=this._adjustRadiusForTesselation(f.earthRadius+t.elevationBounds[0]);a!==this._lowerElevationBoundRadius&&(this._lowerElevationBoundRadius=a,this._earthRadius=-1,this._updateVisibleElevationBounds())}},e.prototype._updateVisibleElevationBounds=function(){var e=this._adjustRadiusForTesselation(f.earthRadius+this._view.basemapTerrain.elevationBounds.min);(this._earthRadius<0||e<this._earthRadius)&&this._updateRadius(e)},e.prototype._updateRadius=function(e){this._earthRadius=e;var t=e,a=t/10*10.25,r=1/(a-t),i=r/S,s=r/x,n=.3*(a-t)+t,h=this._renderData;l.vec4.set(h.atmosphereParameters1,r,S,i,q),l.vec4.set(h.atmosphereParameters2,H,x,s,U),c.vec3.set(h.atmosphereParameters3,H*H,C,n),o.vec2.set(h.radii,t,a),h.scale=r,h.lowerAlphaBlendBound=n,h.scaleOverScaleDepth=i,h.scaleOverScaleDepthBlue=s;var d=p.INNER_ATMOSPHERE_DEPTH;h.innerFadeDistance=2*Math.sqrt((2*e-d)*d)},e.prototype._update=function(e){if(e){c.vec3.negate(this._renderData.cameraDir,e.viewForward),c.vec3.copy(this._renderData.cameraUp,e.viewUp),c.vec3.copy(this._renderData.cameraRight,e.viewRight),this._renderData.cameraHeight=c.vec3.length(e.eye),this._renderData.cameraHeightSq=this._renderData.cameraHeight*this._renderData.cameraHeight,this._renderData.C=this._renderData.cameraHeightSq-this._renderData.radii[1]*this._renderData.radii[1],this._renderData.CSur=this._renderData.cameraHeightSq-this._renderData.radii[0]*this._renderData.radii[0],this._renderData.heightParameters=u.vec4f64.fromValues(this._renderData.cameraHeight,this._renderData.cameraHeightSq,this._renderData.C,this._renderData.CSur),c.vec3.copy(this._renderData.cameraPosition,e.eye),o.vec2.set(this._renderData.halfSizeNearPlane,Math.tan(e.fovX/2)/(e.width/e.fullWidth),Math.tan(e.fovY/2)/(e.height/e.fullHeight));var t=(e.padding[3]+e.width/2)/e.fullWidth,a=(e.padding[2]+e.height/2)/e.fullHeight;o.vec2.set(this._renderData.cameraCenterOffset,t-.5,a-.5),o.vec2.set(this._renderData.nearFar,e.near,e.far),this._renderData.altitudeFade=p.computeInnerAltitudeFade(this._renderData.cameraHeight-this._earthRadius)}},e.isSupported=function(e){return e.rctx.capabilities.depthTexture},e}();t.RealisticAtmosphere=b;var y=.02*Math.PI,T=.004*Math.PI,P=d.vec3f64.fromValues(1/Math.pow(.65,4),1/Math.pow(.57,4),1/Math.pow(.475,4)),w=d.vec3f64.clone(P);c.vec3.scale(w,w,y),c.vec3.add(w,w,d.vec3f64.fromValues(T,T,T));var S=.25,x=.05,q=1/S,U=1/x,H=-.99999,C=(1-H*H)/(2+H*H)*1.5,V=_.newLayout().vec3f("position").vec2f("uv0")}));