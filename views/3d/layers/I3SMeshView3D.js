// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/assignHelper","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","../../../core/tsSupport/generatorHelper","../../../core/tsSupport/awaiterHelper","../../../Color","../../../Graphic","../../../core/Collection","../../../core/has","../../../core/Logger","../../../core/MapUtils","../../../core/mathUtils","../../../core/maybe","../../../core/promiseUtils","../../../core/scheduling","../../../core/typedArrayUtil","../../../core/unitUtils","../../../core/watchUtils","../../../core/workers","../../../core/accessorSupport/decorators","../../../core/libs/gl-matrix-2/mat3","../../../core/libs/gl-matrix-2/mat3f32","../../../core/libs/gl-matrix-2/mat4","../../../core/libs/gl-matrix-2/mat4f64","../../../core/libs/gl-matrix-2/vec3f64","../../../core/libs/gl-matrix-2/vec4","../../../geometry/support/aaBoundingBox","../../../layers/graphics/controllers/I3SOnDemandController","../../../layers/support/fieldUtils","../../../layers/support/layerUtils","../../../renderers/visualVariables/support/visualVariableUtils","../../../support/arcadeOnDemand","../../../symbols/Symbol3D","../../../symbols/support/unitConversionUtils","./I3SMeshViewLabeler","./SceneLayerWorker","./graphics/graphicUtils","./i3s/Highlights","./i3s/I3SElevationProvider","./i3s/I3SGeometryUtil","./i3s/I3SIntersectionHandler","./i3s/I3SUtil","./i3s/IDBCache","./support/attributeUtils","./support/layerViewUpdatingProperties","../support/debugFlags","../support/orientedBoundingBox","../support/projectionUtils","../support/buffer/glUtil","../webgl-engine/collections/Component/SourceGeometry","../webgl-engine/core/material/RenderTexture","../webgl-engine/core/shaderLibrary/util/AlphaDiscard.glsl","../webgl-engine/lib/Texture","../webgl-engine/lib/TextureBackedBuffer/BufferManager","@dojo/framework/shim/Promise"],(function(e,t,r,i,o,n,a,s,l,d,u,c,h,p,f,g,_,y,m,b,v,x,I,M,S,C,w,O,D,T,E,F,V,A,j,P,R,N,H,G,B,U,k,L,q,K,z,W,J,Q,X,Y,Z,$,ee,te){Object.defineProperty(t,"__esModule",{value:!0});var re=c.getLogger("esri.views.3d.layers.SceneLayerView3D"),ie=[1,1,1,1],oe=function(e,t,r,i,o,n,a){this.node=e,this.featureIds=t,this.objectHandle=r,this.cachedRendererVersion=i,this.attributeInfo=o,this.material=n,this.textures=a,this.cachedEdgeMaterials=new Array,this.cachedSymbology=null};t.I3SMeshView3D=function(t){return function(t){function s(){var e=null!==t&&t.apply(this,arguments)||this;return e._elevationProvider=null,e._intersectionHandler=null,e._worker=new N,e._workerThread=null,e._nodeId2Meta=new Map,e._addTasks=new Map,e._rendererVersion=0,e._colorVariable=null,e._opacityVariable=null,e._rendererFields=null,e._symbologyFields=null,e._symbologyOverride=null,e._symbologyOverrideFields=null,e._symbolInfos=new Map,e._idbCache=new q.IDBCache("esri-scenelayer-cache","geometries"),e._labeler=null,e._hasColors=!1,e._hasTextures=!1,e._hasData=!1,e.slicePlaneEnabled=!1,e._layerUrl="",e._cacheKeySuffix=null,e._arcade=null,e._tmpAttributeOnlyGraphic=new l(null,null,{}),e}return i(s,t),Object.defineProperty(s.prototype,"layerUid",{get:function(){return this.layer&&this.layer.uid},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"sublayerUid",{get:function(){return null},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"updatingMeshView3D",{get:function(){return!(!this._controller||!this._controller.updating)||!!this._visibleGeometryChangedSchedulerHandle||f.isSome(this._labeler)&&this._labeler.updating},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"hasTexturesOrVertexColors",{get:function(){return this._hasData?this._hasTextures||this._hasColors?"yes":"probably-not":"unknown"},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"rendererTextureUsage",{get:function(){return L.rendererNeedsTextures(this._currentRenderer)?63:44},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"elevationOffset",{get:function(){var e=null!=this.layer?this.layer.elevationInfo:null;if(null!=e&&"absolute-height"===e.mode){var t=m.getMetersPerVerticalUnitForSR(this.layer.spatialReference),r=P.getMetersPerUnit(e.unit);return f.unwrapOr(e.offset,0)*r/t}return 0},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"uncompressedTextureDownsamplingEnabled",{get:function(){return this.view&&this.view.qualitySettings.sceneService.uncompressedTextureDownsamplingEnabled&&!this.useCompressedTextures},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"useCompressedTextures",{get:function(){var e=this.layer.version,t=!u("trident")||e.major>1||1===e.major&&e.minor>3;return this.view._stage.renderView.has("s3tc")&&t},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"_enableMipMaps",{get:function(){return!this.uncompressedTextureDownsamplingEnabled},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"_enableAtlasMipMaps",{get:function(){return this._enableMipMaps},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"_atlasBiasCompensationEnabled",{get:function(){return this.view&&this.view._stage&&!this.view._stage.renderView.has("shaderTextureLOD")&&this._enableAtlasMipMaps},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"_disableAtlasAnisotropy",{get:function(){return this._atlasBiasCompensationEnabled},enumerable:!0,configurable:!0}),s.prototype.initialize=function(){var t=this;if(v.open("SceneLayerWorker").then((function(e){t.destroyed?e.close():t._workerThread=e})),L.checkSceneLayerValid(this.layer),L.checkSceneLayerCompatibleWithView(this.layer,this.view),this._layerUrl=this.layer.parsedUrl.path,this._controller=new T({layerView:this}),this.gpuMemoryEstimate=0,this.texMemoryEstimate=0,this.geoMemoryEstimate=0,this._stage=this.view._stage,this._collection=this._stage.renderView.componentObjectCollection,this._highlights=new G({collection:this._collection,forAllFeatures:function(e){return t._forAllFeatures(e,null,1)},forAllFeaturesOfNode:function(e,r){return t._forAllFeaturesOfNode(e,r)}}),this._isIntegratedMesh||!this.layer.store.defaultGeometrySchema)this._hasSymbolColors=!1;else{var r=this.layer.store.defaultGeometrySchema.featureAttributes;this._hasSymbolColors=!!(r&&r.faceRange&&r.id)}this._hasVertexColors=null!=this.layer.store.defaultGeometrySchema.vertexAttributes.color&&(null==this.layer.cachedDrawingInfo||!this.layer.cachedDrawingInfo.color),this._isIntegratedMesh||(this._edgeView=this._stage.renderView.ensureEdgeView()),this._memCache=this.view.resourceController.memoryController.getMemCache(this.layer.uid,(function(e){return t._deleteComponentObject(e)})),this._intersectionHandler=new k.I3SIntersectionHandler({layerUid:this.layerUid,sublayerUid:this.sublayerUid,collection:this._collection,slicePlaneEnabled:this.slicePlaneEnabled,isGround:this._isIntegratedMesh,forEach:function(e){return t._nodeId2Meta.forEach((function(t){return e(t.node,t.objectHandle)}))}}),this._elevationProvider=new B({layerView:this,intersectionHandler:this._intersectionHandler}),this.updatingHandles.add(this,"view.clippingArea",(function(){return t._clippingAreaChanged()}),2),this.updatingHandles.add(this,"fullOpacity",(function(e){return t._opacityChange(e)})),this.updatingHandles.add(this,"slicePlaneEnabled",(function(e){return t._slicePlaneEnabledChange(e)})),this.updatingHandles.add(this,"elevationOffset",(function(e,r){return t._reloadAll(r)})),this.updatingHandles.add(this,"filter",(function(){return t._filterChange()}),2),this.updatingHandles.add(this,"view.qualitySettings.physicallyBasedRenderingEnabled",(function(){return t._updatePBR()}));var i=function(){t._reloadAll(),t._memCache.clear()};this.updatingHandles.add(this,"rendererTextureUsage",i),this.updatingHandles.add(this,"uncompressedTextureDownsamplingEnabled",i),this.updatingHandles.add(this,"suspended",(function(e){return t._suspendedChange(e)}),2),this.updatingHandles.add(this.layer,"labelsVisible",(function(){return t._labelingChanged()}),2),this.updatingHandles.add(this.layer,"labelingInfo",(function(){return t._labelingChanged()}),2),this.handles.add(b.init(W,"I3S_TREE_SHOW_TILES",(function(r){if(r&&!t._treeDebugger){var i=t._controller.crsIndex;new Promise((function(t,r){e(["./support/I3STreeDebugger"],t,r)})).then((function(e){var r=e.I3STreeDebugger;!t._treeDebugger&&W.I3S_TREE_SHOW_TILES&&(t._treeDebugger=new r({lv:t,view:t.view,nodeSR:i}))}))}else r||!t._treeDebugger||W.I3S_TREE_SHOW_TILES||(t._treeDebugger.destroy(),t._treeDebugger=null)}))),this._cacheKeySuffix=L.getCacheKeySuffix(this.layer.spatialReference,this.view.renderSpatialReference),this._idbCache.init().catch((function(e){return re.warn("Failed to initialize IndexedDB cache: "+e)})),this._componentColorManager=this._hasSymbolColors?new te.BufferManager(this._stage.renderView.renderingContext):null},s.prototype.destroy=function(){this._clearAddTasks(),this._elevationProvider&&(this._elevationProvider.layerChanged(),this.view.elevationProvider.unregister(this._elevationProvider),this._elevationProvider=null),this._intersectionHandler&&(this._stage.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler),this._intersectionHandler=null),this._workerThread&&(this._workerThread.close(),this._workerThread=null),this._removeAllNodeDataFromStage(),this._memCache.destroy(),this._memCache=null,this._collection=null,this._stage=null,f.isSome(this._labeler)&&(this._labeler.destroy(),this._labeler=null),this._treeDebugger&&(this._treeDebugger.destroy(),this._treeDebugger=null),this._controller&&(this._controller.destroy(),this._controller=null),this._highlights.destroy(),this._nodeId2Meta=null,this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)},s.prototype.memEstimateTextureAdded=function(e){var t=e.estimatedTexMemRequired;return this.gpuMemoryEstimate+=t,this.texMemoryEstimate+=t,t},s.prototype.memEstimateTextureRemoved=function(e){var t=e.estimatedTexMemRequired;this.gpuMemoryEstimate-=t,this.texMemoryEstimate-=t},s.prototype.memEstimateGeometryAdded=function(e){var t=this._collection.getObjectMemoryUsageGPU(e);return this.gpuMemoryEstimate+=t,this.geoMemoryEstimate+=t,t},s.prototype.memEstimateGeometryRemoved=function(e){var t=this._collection.getObjectMemoryUsageGPU(e);this.gpuMemoryEstimate-=t,this.geoMemoryEstimate-=t},s.prototype.isNodeLoaded=function(e){return this._nodeId2Meta.has(e)},s.prototype.getUsedMemory=function(){var e=f.isSome(this._labeler)?this._labeler.usedMemory:0;return this._nodeId2Meta.forEach((function(t){return e+=t.node.memory})),e},s.prototype.getUnloadedMemory=function(){return(this._controller?this._controller.unloadedMemoryEstimate:0)+(f.isSome(this._labeler)?this._labeler.unloadedMemoryEstimate:0)},s.prototype.ignoresMemoryFactor=function(){return!1},s.prototype._labelingChanged=function(){var e=this;if(F.areLabelsVisible(this.layer)&&this._supportsLabeling){if(!f.isSome(this._labeler)){var t=new R.default({view:this.view,layer:this.layer,collection:this._collection});this._nodeId2Meta.forEach((function(r){return e._addMetaToLabeler(t,r)})),this._labeler=t}}else f.isSome(this._labeler)&&(this._labeler.destroy(),this._labeler=null)},s.prototype._addMetaToLabeler=function(e,t){var r=this;e.addNodeMeta(t,(function(e,t){return r._createAttributes(e,t)}))},s.prototype._suspendedChange=function(e){e?(this._removeAllNodeDataFromStage(),this.view.elevationProvider&&this.view.elevationProvider.unregister(this._elevationProvider),this._stage.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler)):(this.view.elevationProvider.register(this._elevationContext,this._elevationProvider),this._stage.sceneIntersectionHelper.addIntersectionHandler(this._intersectionHandler))},s.prototype.getLoadedAttributes=function(e){var t=this._nodeId2Meta.get(e);if(t&&t.attributeInfo)return t.attributeInfo.loadedAttributes},s.prototype.getAttributeData=function(e){var t=this._nodeId2Meta.get(e);if(t&&t.attributeInfo)return t.attributeInfo.attributeData},s.prototype.setAttributeData=function(e,t){var r=this,i=this._nodeId2Meta.get(e);i&&(i.attributeInfo=t,i.cachedRendererVersion=this._getInvalidRendererVersion(),i.filteredIds=null,f.isSome(this._labeler)&&this._labeler.setNodeMetaAttributes(i,(function(e,t){return r._createAttributes(e,t)})),this._updateEngineObject(i))},s.prototype.getLoadedNodeIds=function(){var e=[];return this._nodeId2Meta.forEach((function(t){return e.push(t.node.id)})),e.sort()},s.prototype.getLoadedNodes=function(){var e=new Array;return this._nodeId2Meta.forEach((function(t){return e.push(t.node)})),e},s.prototype.getLoadedNodeIndices=function(e){this._nodeId2Meta.forEach((function(t,r){return e.push(r)}))},s.prototype._createTexture=function(e,t,r,i){if(f.isNone(r)||null==r.data)return null;var o,n=r.data,a=r.encoding,s=t.wrapTextures,l=1&r.usage?"opaque"===t.alphaMode?3:4:3,d=!0;if(a===L.DDS_ENCODING_STRING)o=ee.DDS_ENCODING;else{var u=n;d=p.isPowerOfTwo(u.width)&&p.isPowerOfTwo(u.height)}var c=i,h=(c?this._enableAtlasMipMaps:this._enableMipMaps)&&d,g={mipmap:h,wrap:c||!s?{s:33071,t:33071}:{s:10497,t:10497},disableAnisotropy:c&&h&&this._disableAtlasAnisotropy,encoding:o,noUnpackFlip:!0,components:l},_=new ee(n,e.id+"/"+r.id,g);return this._stage.add(4,_),e.memory+=this.memEstimateTextureAdded(_),_},s.prototype._getVertexBufferLayout=function(e,t){var r={hasTexture:ue(e.params.material),hasNormals:null!=t.vertexAttributes.normal,hasRegions:null!=t.vertexAttributes.uvRegion};return X.glLayout(Y.createVertexBufferLayout(this._getGeometryParameters(r)))},s.prototype._getObjectIdField=function(){return this.layer.objectIdField||"OBJECTID"},s.prototype._findGraphicNodeAndIndex=function(e){var t=K.attributeLookup(e.attributes,this._getObjectIdField()),r=null;return h.someMap(this._nodeId2Meta,(function(e){var i=e.featureIds.indexOf(t);return-1!==i&&(r={node:e.node,index:i},!0)})),r},s.prototype._getGraphicIndices=function(e,t){var r=this._nodeId2Meta.get(e.index);if(!r)return[];for(var i=[],o=this._getObjectIdField(),n=0,a=t;n<a.length;n++){var s=a[n],l=K.attributeLookup(s.attributes,o),d=r.featureIds.indexOf(l);-1!==d&&i.push(d)}return i},s.prototype.whenGraphicBounds=function(e){var t=this._findGraphicNodeAndIndex(e);if(!t)return g.reject();var r=this._nodeId2Meta.get(t.node.index).objectHandle,i=U.boundingBoxCornerPoints(t.index,this._collection,r,new Float64Array(24)),o=this.view.renderSpatialReference,n=this.view.spatialReference;if(Q.bufferToBuffer(i,o,0,i,n,0,8)){var a=D.empty();return D.expandWithBuffer(a,i,0,8),g.resolve({boundingBox:a,screenSpaceObjects:[]})}},s.prototype.whenGraphicAttributes=function(e,t){var r=this;return L.whenGraphicAttributes(this.layer,e,this._getObjectIdField(),t,(function(e){for(var t=new Map,i=[],o=0,n=e;o<n.length;o++){var a=n[o],s=r._findGraphicNodeAndIndex(a),l=t.get(s.node);l||(l={node:s.node,indices:[],graphics:[]},i.push(l)),l.indices.push(s.index),l.graphics.push(a)}return i}),{populateObjectId:!0})},s.prototype.getGraphicFromIntersectorMetadata=function(e){if(null==e.nodeIndex||null==e.componentIndex)return null;var t=this._nodeId2Meta.get(e.nodeIndex);return null==t||null==t.featureIds||e.componentIndex>=t.featureIds.length?null:this._createGraphic(e.componentIndex,t)},s.prototype._getCacheKey=function(e){return this._layerUrl+"/v12/"+e.id+this._cacheKeySuffix},s.prototype._getMemCacheKey=function(e,t){return void 0===t&&(t=this.elevationOffset),e+"#"+t},s.prototype._cachingEnabled=function(){return!this._controller.disableIDBCache&&0===this.elevationOffset&&null!=this._cacheKeySuffix},s.prototype.loadCachedGPUData=function(e){return this._memCache.pop(this._getMemCacheKey(e.index))},s.prototype.loadMissingTextures=function(e,t,r,i){var o=this,n=e.filter((function(e,r){if(0==(e.usage&o.rendererTextureUsage))return!1;if(f.isNone(t))return!0;var i=L.selectEncoding(e.encodings,o.useCompressedTextures),n=t[r];return!!(f.isNone(n)||null==n.data||i&&n.encoding!==i.encoding)}));return 0===n.length?g.resolve(!1):r(n,i).then((function(r){for(var i=0,o=0;o<e.length;o++)i<r.length&&r[i].id===e[o].id&&(t[o]=r[i],i++);return!0}))},s.prototype.loadCachedNodeData=function(e,t,r){var i=this;return this._cachingEnabled()?this._idbCache.get(this._getCacheKey(e),t).then((function(o){return null==o?null:o.nodeVersion!==e.version?(i._idbCache.remove(i._getCacheKey(e)),null):(e.obb||i._setComputedObb(e,o.nodeObb),i.loadMissingTextures(o.requiredTextures,o.textureData,r,t).then((function(r){return r&&i._idbCache.initialized&&f.isSome(o.textureData)&&(o.byteSize=he(o.transformedGeometries,o.textureData),o.textureData.every(ce)&&pe(e,o)&&i._idbCache.put(i._getCacheKey(e),o).catch((function(t){return re.warn("Failed to update node with textures in IndexedDB cache: "+e.id+": "+t)}))),g.throwIfAborted(t),o})))})):g.resolve(null)},s.prototype.addNodeData=function(e,t){var i=this;return 0===t.allGeometryData.length||0===t.allGeometryData[0].geometries.length?g.resolve():(1!==t.allGeometryData.length&&re.warn("Node with",t.allGeometryData.length,"geometries is unsupported"),this._addData(e,t.attributeDataInfo,(function(){return i._transformNode(e,t).then((function(o){return i._controller.reschedule(e.index,(function(){e.obb||i._setComputedObb(e,o.obb),t.allGeometryData[0].componentOffsets=o.componentOffsets,o.featureIds&&(t.allGeometryData[0].featureIds=Array.prototype.slice.call(o.featureIds));var n={geometryData:t.allGeometryData[0],transformedGeometries:o.transformedGeometries,requiredTextures:t.requiredTextures,textureData:t.textureData,nodeVersion:e.version,nodeObb:e.obb,byteSize:i._cachingEnabled()?he(o.transformedGeometries,t.textureData):0};if(pe(e,n)&&i._idbCache.initialized){var a=f.isSome(n.textureData)?n.textureData.map((function(e){return ce(e)?e:null})):null;i._idbCache.put(i._getCacheKey(e),r({},n,{textureData:a})).catch((function(t){return re.warn("Failed to store node in IndexedDB cache: "+e.id+": "+t)}))}return i._addCachedNodeData(e,n)}))}))})))},s.prototype._setComputedObb=function(e,t){e.obb=J.clone(t),e.isComputedObb=!0,this._controller.updateVisibility(e.index)},s.prototype._transformNode=function(e,t){for(var r=this,i=t.allGeometryData[0].geometries,o=new Array(i.length),n=0;n<i.length;++n)o[n]=this._getVertexBufferLayout(i[n],t.geometryIndex);var a={geometryBuffer:t.geometryBuffer,geometryData:t.allGeometryData[0],geometryIndex:t.geometryIndex,layouts:o,mbs:e.mbs,obb:e.obb,elevationOffset:this.elevationOffset,needNormals:!this._isIntegratedMesh&&this._controller.isMeshPyramid,normalReferenceFrame:this.layer.normalReferenceFrame||"none",indexSR:this._controller.crsIndex.toJSON(),vertexSR:this._controller.crsVertex.toJSON(),renderSR:this.view.renderSpatialReference.toJSON()};return this._workerThread?this._workerThread.invoke("process",a,{transferList:[t.geometryBuffer]}):N.ensureDracoDecoder(a).then((function(){return r._controller.reschedule(e.index,(function(){return r._worker.transform(a)}))}))},s.prototype.addCachedGPUData=function(e,t,r){if(this._controller.isGeometryVisible(e))f.isSome(this._labeler)&&this._addMetaToLabeler(this._labeler,t),this._addNodeMeta(e.index,t),this.updateNodeStatus(e.index,r),this._collection.setObjectVisibility(t.objectHandle,!0),this._updateMaterial(t),this._updateEngineObject(t),this._highlights.objectCreated(t),this._treeDebugger&&this._treeDebugger.update();else{var i=this._controller.indexDepth-e.level;this._memCache.put(this._getMemCacheKey(e.index),t,e.memory,i)}},s.prototype.addCachedNodeData=function(e,t,r){var i=this;return this._addData(e,r,(function(){return i._addCachedNodeData(e,t)}))},s.prototype._addCachedNodeData=function(e,t){var r=this;if(this.suspended||!this._controller.isGeometryVisible(e))return g.resolve();var i=t.geometryData,o=t.transformedGeometries,n=f.isSome(t.textureData)?t.textureData.filter((function(e){return f.isSome(e)&&0!=(e.usage&r.rendererTextureUsage)})):null;e.memory=0;var a=i.componentOffsets,s=i.geometries,l=i.featureIds,d=null,u=null;if(this._hasSymbolColors){d=this._componentColorManager.getBuffer(l.length),u=new Uint16Array(l.length);for(var c=0;c<l.length;c++)u[c]=d.acquireIndex()}var h=this._collection,p=s[0],_=o[0],y=this._materialParameters(p,_.layout),m=a||new Uint16Array([0,_.indices?_.indices.length:_.interleavedVertexData.byteLength/_.layout[0].stride]),b={vertices:{data:_.interleavedVertexData,count:_.interleavedVertexData.byteLength/_.layout[0].stride,layoutParameters:y.geometryParams},positionData:{positions:_.positionData.data,indices:_.positionData.indices},indices:_.indices,primitiveType:4,componentOffsets:m},v=p.transformation?C.mat4f64.clone(p.transformation):C.mat4f64.create();S.mat4.multiply(v,_.corMatrices.globalTrafo,v);var x=S.mat4.getTranslation(w.vec3f64.create(),v),O=I.mat3.fromMat4(M.mat3f32.create(),v),D=this.view.renderSpatialReference,T=this.view.basemapTerrain.spatialReference,E=w.vec3f64.create(),F=[1,1,1];Q.localLinearScaleFactors(x,D,F,T),Q.vectorToVector(x,D,E,T);var V=h.createObject({toMapSpace:[E[0],E[1],F[0],F[1]],geometry:b,obb:e.renderObb,transform:{position:x,rotationScale:O},visible:!1}),A={isSchematic:p.params.material.isSchematic},j=f.isSome(n)?n.map((function(t){return r._createTexture(e,y.material,t,2===y.geometryParams.textureCoordinates)})):[];this._configureMaterial(V,p.params.material,j,n),e.memory+=this.memEstimateGeometryAdded(V);var P=this._addTasks.get(e.index),R=new oe(e,l,V,this._getInvalidRendererVersion(),P.attributeInfo,A,j);return P.meta=R,!this._hasTextures&&t.requiredTextures.some((function(e){return 0!=(19&e.usage)}))&&(this._hasTextures=!0),this._hasData=!0,this._hasColors=this._hasColors||_.hasColors,this._hasTextures=this._hasTextures||!!e.resources.texture,this.notifyChange("hasTexturesOrVertexColors"),this._addOrUpdateEdgeRendering(R).then((function(t){return t&&r._edgeView.updateObjectVisibility(R.objectHandle,!1),r._controller.reschedule(e.index,(function(){var i=r._addTasks.get(e.index);if(i)if(f.isSome(r._labeler)&&r._addMetaToLabeler(r._labeler,R),r._addNodeMeta(e.index,R),r.suspended)r._removeNodeStageData(e.index,r.elevationOffset);else{h.setObjectVisibility(V,!0),t&&r._edgeView.updateObjectVisibility(R.objectHandle,!0),R.attributeInfo=i.attributeInfo;var o=R.cachedRendererVersion!==r._rendererVersion;r._setObjectSymbolColors(R),r._applyFiltersToNode(R),(o||t)&&r._addOrUpdateEdgeRendering(R),r.visibleGeometryChanged(R),r._highlights.objectCreated(R),r._updateMaterial(R),r._markParentsAsHole(e.index),r._treeDebugger&&r._treeDebugger.update()}}))})).catch((function(e){throw f.isSome(P.meta)&&r._deleteComponentObject(P.meta),e}))},s.prototype._addNodeMeta=function(e,t){this._nodeId2Meta.has(e)&&(re.error("Removing duplicated node"),this._deleteComponentObject(this._nodeId2Meta.get(e))),this._nodeId2Meta.set(e,t)},s.prototype._materialParameters=function(e,t){var r=e.params.material,i=t.some((function(e){return"uvRegion"===e.name})),o=t.some((function(e){return"normalCompressed"===e.name})),n=ue(r);return{geometryParams:this._getGeometryParameters({hasTexture:n,hasNormals:o,hasRegions:i}),material:r}},s.prototype._configureMaterial=function(e,t,r,i){var o=this,n=this.rendererTextureUsage,a=function(e){return function(e,t,r){if(f.isNone(e)||0===r)return null;for(var i=0;i<e.length;i++){var o=e[i];if(f.isSome(o)&&0!=(o.usage&r))return t[i].id}return null}(i,r,e&n)};this._collection.updateMaterial(e,(function(e){var r=t.metallicRoughness.baseColorFactor,i=p.clamp(t.metallicRoughness.baseColorFactor[3],0,1);e.baseColor=[r[0],r[1],r[2],i],e.objectOpacity=o.fullOpacity,e.mrrFactors=[t.metallicRoughness.metallicFactor,t.metallicRoughness.roughnessFactor,t.isSchematic?.2:.5],e.emissiveFactor=t.emissiveFactor,e.usePBR=o._usePBR(t.isSchematic),e.isIntegratedMesh=o._isIntegratedMesh,e.alphaCutoff="mask"===t.alphaMode?t.alphaCutoff:$.defaultMaskAlphaCutoff,e.alphaDiscardMode="opaque"===t.alphaMode?1:"mask"===t.alphaMode?2:3;var n=o._stage.renderView.textureRepository,s=a(33);s&&(e.baseColorTexture=new Z.RenderTexture(n,s));var l=a(2);l&&(e.metallicRoughnessTexture=new Z.RenderTexture(n,l));var d=a(16);d&&(e.emissionTexture=new Z.RenderTexture(n,d));var u=a(8);u&&(e.occlusionTexture=new Z.RenderTexture(n,u));var c=a(4);c&&(e.normalTexture=new Z.RenderTexture(n,c)),e.commonMaterialParameters.slicePlaneEnabled=o.slicePlaneEnabled,e.commonMaterialParameters.doubleSided=t.doubleSided,e.commonMaterialParameters.cullFace=t.cullFace,o._updateMaterialOverlay(e)}))},s.prototype._getGeometryParameters=function(e){return{textureCoordinates:e.hasTexture?e.hasRegions?2:1:0,colors:this._hasVertexColors,normals:e.hasNormals&&!this._isIntegratedMesh}},s.prototype._addData=function(e,t,i){var o=this,n=this._addTasks.get(e.index);return n?n.attributeInfo=t:(n=r({},g.createResolver(),{attributeInfo:t,meta:null}),this._addTasks.set(e.index,n),i().then(n.resolve,n.reject).then((function(){return o._addTasks.delete(e.index)})).catch((function(t){throw o._addTasks.delete(e.index),t}))),n.promise},s.prototype._clearAddTasks=function(){var e=this;this._addTasks.forEach((function(t){f.isSome(t.meta)&&e._deleteComponentObject(t.meta)})),this._addTasks.clear()},s.prototype._markParentsAsHole=function(e){if(this._isIntegratedMesh)for(var t=this._controller,r=t.getParentIndex(e);r;r=t.getParentIndex(r))this.updateNodeStatus(r,"hole")},s.prototype._clippingAreaChanged=function(){var e=D.create();Q.extentToBoundingBox(this.view.clippingArea,e,this.view.renderSpatialReference)?this._clippingArea=e:this._clippingArea=null,this._filterChange(),this._controller&&this._controller.updateClippingArea(this.view.clippingArea)},s.prototype._filterChange=function(){this._applyFilters(!1)},s.prototype._applyFilters=function(e){var t=this;this._filters=this.getFilters(),e?this._controller&&this._controller.requestUpdate():this._nodeId2Meta.forEach((function(e){t._applyFiltersToNode(e)&&(t._addOrUpdateEdgeRendering(e),t.visibleGeometryChanged(e))}))},s.prototype.getFilters=function(){var e=this,t=[];return this._clippingArea&&t.push((function(t,r){return e._boundingboxFilter(t,r,e._clippingArea)})),t},s.prototype.addSqlFilter=function(e,t,r,i){var o=this;t&&r&&e.push((function(e,n){return o._sqlFilter(e,n,t,r,i)}))},s.prototype._sqlFilter=function(e,t,r,i,o){var n={},a=this._createLayerGraphic(n),s=this.layer.objectIdField,l=t.featureIds,d=t.attributeInfo.attributeData;i.every((function(e){return null!=d[e]||e===s}))&&L.filterInPlace(e,l,(function(e){n[s]=l[e];for(var t=0,u=i;t<u.length;t++){var c=u[t];c!==s&&(n[c]=L.getCachedAttributeValue(d[c],e))}try{if(Array.isArray(r)){for(var h=0,p=r;h<p.length;h++){if(p[h].testFeature(a))return!0}return!1}return r.testFeature(a)}catch(e){return o(e),!1}}))},s.prototype._boundingboxNodeTest=function(e,t){return Q.mbsToMbs(e.node.mbs,this._controller.crsIndex,de,this.view.renderSpatialReference),L.intersectBoundingBoxWithMbs(t,de)},s.prototype._boundingboxFeatureTest=function(e,t,r){return D.intersects(r,this._collection.getComponentAABB(e.objectHandle,t,ne))},s.prototype._boundingboxFilter=function(e,t,r){var i=this,o=this._collection,n=this._boundingboxNodeTest(t,r);if(3!==n)if(0!==n){var a=o.getComponentCount(t.objectHandle);if(a.invisible+a.visible===t.featureIds.length){var s=this._transformAABB(ae,r,t.objectHandle);L.filterInPlace(e,t.featureIds,(function(e){return i._boundingboxFeatureTest(t,e,s)}))}}else e.length=0},s.prototype._transformAABB=function(e,t,r){var i=this._collection.getObjectTransform(r),o=i.position,n=i.rotationScale;return e[0]=(t[0]-o[0])/n[0],e[1]=(t[1]-o[1])/n[4],e[2]=(t[2]-o[2])/n[8],e[3]=(t[3]-o[0])/n[0],e[4]=(t[4]-o[1])/n[4],e[5]=(t[5]-o[2])/n[8],e},s.prototype._addOrUpdateEdgeRendering=function(e,t){if(void 0===t&&(t=!0),!this._edgeView)return g.resolve(!1);var r=e.objectHandle,i=this._edgeView.hasObject(r),o=this._extractObjectEdgeMaterials(e),n=o.hasEdges,a=o.perFeatureEdgeMaterials,s={slicePlaneEnabled:this.slicePlaneEnabled};return n?i?(this._edgeView.updateAllComponentMaterials(r,a,s,t),this._edgeView.updateObjectVisibility(r,!0),g.resolve(!0)):this._collection.addEdges(r,this._edgeView,a,s).then((function(){return!0})):(i&&this._edgeView.removeObject(r),g.resolve(!1))},s.prototype._removeEdgeRendering=function(e){this._edgeView&&this._edgeView.hasObject(e.objectHandle)&&this._edgeView.removeObject(e.objectHandle)},s.prototype._applyFiltersToNode=function(e){return!!this._applyFiltersToNodeComponents(e)&&(f.isSome(this._labeler)&&this._labeler.applyFilterChange(e),!0)},s.prototype._applyFiltersToNodeComponents=function(e){var t=this._collection,r=0===t.getComponentCount(e.objectHandle).invisible;if(t.setAllComponentVisibilities(e.objectHandle,"all"),0===this._filters.length)return e.filteredIds=null,!r;if(this._updateCachedFilteredIds(e),e.filteredIds===e.featureIds)return!r;var i=this._computeFilteredComponentIndices(e);return t.setAllComponentVisibilities(e.objectHandle,i),!0},s.prototype._updateCachedFilteredIds=function(e){null!=e.filteredIds&&e.appliedFilters===this._filters||(e.filteredIds=this._computeFilteredIds(e),e.appliedFilters=this._filters)},s.prototype._computeFilteredIds=function(e){for(var t=e.featureIds.slice(),r=0,i=this._filters;r<i.length;r++){if((0,i[r])(t,e),0===t.length)break}return t.length===e.featureIds.length?e.featureIds:t},s.prototype._computeFilteredComponentIndices=function(e){var t=new Array;return e.featureIds.forEach((function(r,i){e.filteredIds[t.length]===r&&t.push(i)})),t},s.prototype._removeAllNodeDataFromStage=function(e){var t=this;void 0===e&&(e=this.elevationOffset),this._nodeId2Meta.forEach((function(r,i){return t._removeNodeStageData(i,e)}))},s.prototype.removeNodeData=function(e,t){for(var r=this.elevationOffset;e.length>0&&!t.done;){var i=e.pop();this._removeNodeStageData(i,r),t.madeProgress()}},s.prototype._removeNodeStageData=function(e,t){var r=this._nodeId2Meta.get(e);if(r){this._collection.setObjectVisibility(r.objectHandle,!1),this.visibleGeometryChanged(r),this._removeEdgeRendering(r),f.isSome(this._labeler)&&this._labeler.removeNodeMeta(r),this._nodeId2Meta.delete(e),this._highlights.objectDeleted(r);var i=this._controller.indexDepth-r.node.level+1;this._memCache.put(this._getMemCacheKey(e,t),r,r.node.memory,i),this._treeDebugger&&this._treeDebugger.update()}},s.prototype._deleteComponentObject=function(e){if(this._edgeView&&this._edgeView.removeObject(e.objectHandle),this.memEstimateGeometryRemoved(e.objectHandle),this._collection.destroyObject(e.objectHandle),e.textures)for(var t=0,r=e.textures;t<r.length;t++){var i=r[t];this.memEstimateTextureRemoved(i),this._stage.remove(4,i.id)}},s.prototype.updateNodeStatus=function(e,t){var r=this._nodeId2Meta.get(e);r&&this._collection.updateMaterial(r.objectHandle,(function(e){e.polygonOffsetEnabled="hole"===t}))},s.prototype._invalidateAllSymbols=function(){this._rendererVersion=L.addWraparound(this._rendererVersion,1),this._controller&&this._controller.requestUpdate()},s.prototype._getInvalidRendererVersion=function(){return L.addWraparound(this._rendererVersion,-1)},s.prototype._rendererChange=function(e){return a(this,void 0,void 0,(function(){var t,r,i,o,a,s,l,d,u,c;return n(this,(function(n){switch(n.label){case 0:return this._currentRenderer=e,this.notifyChange("rendererTextureUsage"),this._rendererVersion=L.addWraparound(this._rendererVersion,1),this._rendererFields=null,this._colorVariable=null,this._opacityVariable=null,this._invalidateAllSymbols(),e?(t=this,r=E.fixFields,i=[this.layer.fields],[4,e.getRequiredFields(this.layer.fields)]):[3,2];case 1:t._rendererFields=r.apply(void 0,i.concat([n.sent()])),n.label=2;case 2:return this._updateSymbologyFields(),!this._arcade&&e&&"arcadeRequired"in e&&e.arcadeRequired?(o=this,[4,A.loadArcade()]):[3,4];case 3:o._arcade=n.sent(),n.label=4;case 4:if(e&&"visualVariables"in e&&e.visualVariables)for(a=0,s=e.visualVariables;a<s.length;a++)"color"===(l=s[a]).type?this._colorVariable=l:"opacity"===l.type?this._opacityVariable=l:re.warn("Unsupported visual variable type for 3D Object Scene Services: "+l.type);if(e)for(d=0,u=e.getSymbols();d<u.length;d++)"mesh-3d"!==(c=u[d]).type&&re.error("Symbols of type '"+c.type+"' are not supported for 3D Object Scene Services.");return this._controller&&this._controller.requestUpdate(),[2]}}))}))},s.prototype._getCachedEdgeMaterials=function(e){return this._hasSymbolColors&&e.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(e),e.cachedEdgeMaterials},s.prototype._getSymbolColors=function(e){this._hasSymbolColors&&e.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(e);var t=e.cachedSymbology;return function(e,r){var i=5*e;O.vec4.set(r.externalColor,t[i+0]/255,t[i+1]/255,t[i+2]/255,t[i+3]/255),r.externalColorMixMode=15&t[i+4],r.castShadows=0!=(16&t[i+4]),r.pickable=0!=(32&t[i+4])}},s.prototype._getSymbolInfo=function(e,t){var r=e&&e.getSymbol(t,{arcade:this._arcade});if(!(r instanceof j))return null;var i=r.id;if(this._symbolInfos.has(i))return this._symbolInfos.get(i);var o=L.getSymbolInfo(r);return this._symbolInfos.set(i,o),o},s.prototype._setSymbologyOverride=function(e,t){this._symbologyOverride!==e&&(this._symbologyOverride=e,this._symbologyOverrideFields=t,this._invalidateAllSymbols(),this._updateSymbologyFields())},s.prototype._updateSymbologyFields=function(){this._symbologyFields=f.isSome(this._symbologyOverrideFields)&&this._symbologyOverrideFields.length>0?f.isSome(this._rendererFields)&&this._rendererFields.length>0?E.fixFields(this.layer.fields,this._rendererFields.concat(this._symbologyOverrideFields)):this._symbologyOverrideFields:this._rendererFields},s.prototype._updateCachedRendererData=function(e){if(e.cachedRendererVersion=this._rendererVersion,this._hasSymbolColors){var t=this._tmpAttributeOnlyGraphic,r={};t.attributes=r;var i=this._currentRenderer,o=e.attributeInfo.attributeData,n=null!=e.featureIds?this.layer.objectIdField:null,a=null!=o&&f.isSome(this._symbologyFields)&&this._symbologyFields.length>0,s=a?[]:null,l=a?[]:null;if(a&&f.isSome(this._symbologyFields))for(var d=0,u=this._symbologyFields;d<u.length;d++){var c=u[d],h=o[c];h&&(s.push(c),l.push(h))}e.cachedSymbology||(e.cachedSymbology=new Uint8Array(5*e.featureIds.length));for(var p={color:se,castShadows:!0,pickable:!0,colorMixMode:1,edgeMaterial:null},g=0,_=0;_<e.featureIds.length;_++){if(null!=n&&(r[n]=e.featureIds[_]),a)for(var y=0;y<s.length;y++)r[s[y]]=L.getCachedAttributeValue(l[y],_);var m=this._getSymbolInfo(i,t),b=null,v=null;if(i&&"visualVariables"in i){if(this._colorVariable){var x=V.getColor(this._colorVariable,t,{color:le,arcade:this._arcade});x&&((b=se)[0]=x.r/255,b[1]=x.g/255,b[2]=x.b/255,this._opacityVariable||null===x.a||(v=x.a))}this._opacityVariable&&(v=V.getOpacity(this._opacityVariable,t,{arcade:this._arcade}))}if(m&&m.material){var I=m.material;b=f.isNone(b)||f.isNone(v)?H.overrideColor(b,v,I.color,I.alpha,ie,se):H.overrideColor(b,v,null,null,ie,se)}f.isNone(b)&&((b=se)[0]=1,b[1]=1,b[2]=1,b[3]=1),p.pickable=!0,p.castShadows=!m||m.castShadows,p.colorMixMode=m&&m.material?m.material.colorMixMode:1,p.edgeMaterial=m?m.edgeMaterial:null,f.isSome(this._symbologyOverride)&&(p.color=b,this._symbologyOverride(t,p),b=p.color),e.cachedEdgeMaterials[_]=p.edgeMaterial,e.cachedSymbology[g+0]=Math.round(255*b[0]),e.cachedSymbology[g+1]=Math.round(255*b[1]),e.cachedSymbology[g+2]=Math.round(255*b[2]),e.cachedSymbology[g+3]=Math.round(255*b[3]),e.cachedSymbology[g+4]=p.colorMixMode|+p.castShadows<<4|+p.pickable<<5,g+=5}}},s.prototype._extractObjectEdgeMaterials=function(e){var t=e.objectHandle,i=e.featureIds?e.featureIds.length:1,o=new Array(i),n={opacity:this.fullOpacity,objectTransparency:2};this._collection.updateMaterial(t,(function(e){n.objectTransparency=e.hasVisibleComponents?e.hasTransparency?1:2:0}));for(var a=!1,s=null,l=null,d=this._getCachedEdgeMaterials(e),u=0;u<i;u++)o[u]=L.transparentEdgeMaterial;return this._collection.forEachVisibleComponent(t,(function(e){var t=d[e];return!!f.isNone(t)||(l!==t&&(l=t,(s=f.isSome(t)?r({},t,n):null)&&(a=!0)),o[e]=f.isSome(s)?s:L.transparentEdgeMaterial,!0)})),{hasEdges:a,perFeatureEdgeMaterials:o}},s.prototype._setObjectSymbolColors=function(e){if(this._hasSymbolColors){var t=e.objectHandle,r=this._getSymbolColors(e);this._collection.setComponentData(t,r),this._stage.renderView.setNeedsRender()}},s.prototype._reloadAll=function(e){void 0===e&&(e=this.elevationOffset),this._removeAllNodeDataFromStage(e),null!=this._controller&&this._controller.restartNodeLoading()},s.prototype._opacityChange=function(e){var t=this;this._nodeId2Meta.forEach((function(r){t._collection.updateMaterial(r.objectHandle,(function(t){return t.objectOpacity=e})),t._updateEdgeRendering(r)}))},s.prototype._updateMaterial=function(e){var t=this;this._collection.updateMaterial(e.objectHandle,(function(r){r.commonMaterialParameters.slicePlaneEnabled=t.slicePlaneEnabled,r.usePBR=t._usePBR(e.material.isSchematic),r.objectOpacity=t.fullOpacity,t._updateMaterialOverlay(r)}))},s.prototype._updateMaterialOverlay=function(e){},s.prototype._updateEngineObject=function(e){this._setObjectSymbolColors(e),this._applyFiltersToNode(e),this._addOrUpdateEdgeRendering(e),this.visibleGeometryChanged(e)},s.prototype._slicePlaneEnabledChange=function(e){var t=this;this._intersectionHandler&&(this._intersectionHandler.slicePlane=e),f.isSome(this._labeler)&&(this._labeler.slicePlaneEnabled=e),this._nodeId2Meta.forEach((function(r){t._collection.updateMaterial(r.objectHandle,(function(t){t.commonMaterialParameters.slicePlaneEnabled=e})),t._updateEdgeRendering(r,!1)}))},s.prototype._updatePBR=function(){var e=this;this._nodeId2Meta.forEach((function(t){e._collection.updateMaterial(t.objectHandle,(function(r){r.usePBR=e._usePBR(t.material.isSchematic)}))}))},s.prototype._usePBR=function(e){return!this._isIntegratedMesh&&(!e||this.view.qualitySettings.physicallyBasedRenderingEnabled)},s.prototype._updateEdgeRendering=function(e,t){void 0===t&&(t=!0),this._edgeView&&this._edgeView.hasObject(e.objectHandle)&&this._addOrUpdateEdgeRendering(e,t)},s.prototype._forAllNodes=function(e){this._nodeId2Meta.forEach(e)},s.prototype._forAllFeatures=function(e,t,r){var i=this;void 0===r&&(r=0),h.someMap(this._nodeId2Meta,(function(o){if(f.isSome(t))switch(t(o)){case 0:return!0;case 2:return!1}var n=1;switch(r){case 1:n=i._forAllFeaturesOfNode(o,e);break;case 0:n=i._forVisibleFeaturesOfNode(o,e);break;case 2:n=i._forAllFeaturesOfNodeInClippingArea(o,e)}return 0===n}))},s.prototype._forAllFeaturesOfNode=function(e,t){for(var r=1,i=e.featureIds,o=0;o<i.length;o++)if(0===(r=t(i[o],o,e)))return r;return r},s.prototype._forVisibleFeaturesOfNode=function(e,t){var r=1,i=e.featureIds;return this._collection.forEachVisibleComponent(e.objectHandle,(function(o){return 1===(r=t(i[o],o,e))})),r},s.prototype._forAllFeaturesOfNodeInClippingArea=function(e,t){if(null==this._clippingArea)return this._forAllFeaturesOfNode(e,t);var r=this._boundingboxNodeTest(e,this._clippingArea);if(0===r)return 1;if(3===r)return this._forAllFeaturesOfNode(e,t);for(var i=e.featureIds,o=e.objectHandle,n=L.getClipAABB(this._clippingArea,this._collection.getObjectTransform(o)),a=0;a<i.length;a++)if(this._boundingboxFeatureTest(e,a,n)){var s=t(i[a],a,e);if(0===s)return s}return 1},s.prototype._createAttributes=function(e,t){var r={};null!=t.featureIds&&(r[this._getObjectIdField()]=t.featureIds[e]);var i=t.attributeInfo.attributeData;if(null!=i)for(var o=0,n=Object.keys(i);o<n.length;o++){var a=n[o];r[a]=L.getCachedAttributeValue(i[a],e)}return r},s.prototype._createGraphic=function(e,t){return this._createLayerGraphic(this._createAttributes(e,t))},s.prototype.highlight=function(e){var t=this,r=this._highlights;if("number"==typeof e?e=[e]:e instanceof l?e=[e]:e instanceof d&&(e=e.toArray()),Array.isArray(e)&&e.length>0){if(e[0]instanceof l){var i=e.map((function(e){return K.attributeLookup(e.attributes,t._getObjectIdField())})),o=r.acquireSet(),n=o.set,a=o.handle;return r.setFeatureIds(n,i),a}if("number"==typeof e[0]){i=e;var s=r.acquireSet();n=s.set,a=s.handle;return r.setFeatureIds(n,i),a}}return fe},s.prototype.visibleGeometryChanged=function(e){var t=this;this._elevationProvider&&(this._elevationProvider.objectChanged(e.node),null==this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle=_.schedule((function(){t.emit("visible-geometry-changed"),t._visibleGeometryChangedSchedulerHandle=null}))))},Object.defineProperty(s.prototype,"performanceInfo",{get:function(){var e={displayedNumberOfFeatures:0,maximumNumberOfFeatures:0,totalNumberOfFeatures:0,core:null,index:0,nodes:this._nodeId2Meta.size,"Total GPU Memory Estimate":(this.gpuMemoryEstimate/1048576).toFixed(1)+"MB","Geometry Memory Estimate":(this.geoMemoryEstimate/1048576).toFixed(1)+"MB","Texture Memory Estimate":(this.texMemoryEstimate/1048576).toFixed(1)+"MB"};return this._controller&&(this._cachingEnabled()&&(e.IDBCache=Math.round(100*this._idbCache.getHitRate())+"% hit"),this._controller.updateStats(e)),e},enumerable:!0,configurable:!0}),s.prototype.test=function(){var e=this;return{controller:this._controller,labeler:this._labeler,get visibleObjectIds(){var t=[];return e._forAllFeatures((function(e){return t.push(e),1}),null,0),t.sort((function(e,t){return e-t})),t},get numNodes(){return e._nodeId2Meta.size}}},o([x.property()],s.prototype,"_visibleGeometryChangedSchedulerHandle",void 0),o([x.property()],s.prototype,"view",void 0),o([x.property()],s.prototype,"layer",void 0),o([x.property()],s.prototype,"_controller",void 0),o([x.property()],s.prototype,"_labeler",void 0),o([x.property({dependsOn:["updatingMeshView3D"]})],s.prototype,"updating",void 0),o([x.property({dependsOn:["_controller.updating","_visibleGeometryChangedSchedulerHandle","_labeler.updating"]})],s.prototype,"updatingMeshView3D",null),o([x.property({dependsOn:["_controller.rootNodeVisible"]})],s.prototype,"suspended",void 0),o([x.property(z.updatingProgress)],s.prototype,"updatingProgress",void 0),o([x.property({readOnly:!0,aliasOf:"_controller.updatingProgress"})],s.prototype,"updatingProgressValue",void 0),o([x.property({readOnly:!0})],s.prototype,"hasTexturesOrVertexColors",null),o([x.property({readOnly:!0})],s.prototype,"rendererTextureUsage",null),o([x.property({readOnly:!0,dependsOn:["layer.elevationInfo"]})],s.prototype,"elevationOffset",null),o([x.property({type:Boolean})],s.prototype,"slicePlaneEnabled",void 0),o([x.property({dependsOn:["view.qualitySettings.sceneService.uncompressedTextureDownsamplingEnabled","useCompressedTextures"]})],s.prototype,"uncompressedTextureDownsamplingEnabled",null),o([x.property({dependsOn:["layer.version"]})],s.prototype,"useCompressedTextures",null),s=o([x.subclass("esri.views.3d.layers.I3SMeshView3D")],s)}(x.declared(t))};var ne=D.create(),ae=D.create(),se=[0,0,0,0],le=new s([0,0,0,0]),de=[0,0,0,0];function ue(e){var t=e.metallicRoughness;return t&&t.baseColorTextureId>=0||t&&t.metallicRoughnessTextureId>=0||e.normalTextureId>=0||e.emissiveTextureId>=0||e.occlusionTextureId>=0}function ce(e){return f.isSome(e)&&y.isArrayBuffer(e.data)}function he(e,t){for(var r=1024,i=0,o=e;i<o.length;i++){var n=o[i];r+=n.interleavedVertexData.byteLength+(n.indices?n.indices.byteLength:0),r+=n.positionData.data.byteLength+n.positionData.indices.byteLength}if(f.isSome(t))for(var a=0,s=t;a<s.length;a++){var l=s[a];f.isSome(l)&&y.isArrayBuffer(l.data)&&(r+=l.data.byteLength)}return r}function pe(e,t){return t.byteSize>104857600?(re.warn("Node is too big to store in IndexedDB cache: "+e.id+" ("+t.byteSize+" bytes)"),!1):t.byteSize>0}var fe={remove:function(){},pause:function(){},resume:function(){}}}));