// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../core/arrayUtils","../../../../core/promiseUtils","../../../../core/libs/gl-matrix-2/vec2f32","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f32","../../../../core/libs/gl-matrix-2/vec3f64","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/meshUtils/deduplicate","../../support/projectionUtils","../../webgl-engine/lib/Util"],(function(e,r,t,n,a,o,i,s,c,f,u,l,d,v,p){Object.defineProperty(r,"__esModule",{value:!0});var E=new Uint8Array(64);function y(e){switch(e){case 5120:return"Int8";case 5126:return"Float32";case 5124:return"Int32";case 5122:return"Int16";case 5121:return"UInt8";case 5125:return"UInt32";case 5123:return"UInt16"}throw new Error("Unhandled data type: "+e)}function g(e){return e%Uint32Array.BYTES_PER_ELEMENT==0}function m(e){return e>0&&e%Uint32Array.BYTES_PER_ELEMENT==0}function b(e){return new Error("I3SGeometryUtil processing failed: "+e)}function h(e){var r=e.normals,t=e.positions,n=e.normalInd,a=e.positionInd;p.assert(e.normalInd.length===e.positionInd.length);for(var o=c.vec3f32.create(),f=c.vec3f32.create(),u=i.vec2f32.create(),l=t.data,d=t.offsetIdx,v=t.strideIdx,E=r.data,y=r.offsetIdx,g=r.strideIdx,m=0;m<a.length;m+=3){var b=a[m],h=d+v*b,T=l[h],w=l[h+1],A=l[h+2];h=d+v*(b=a[m+1]),o[0]=l[h]-T,o[1]=l[h+1]-w,o[2]=l[h+2]-A,h=d+v*(b=a[m+2]),f[0]=l[h]-T,f[1]=l[h+1]-w,f[2]=l[h+2]-A,s.vec3.cross(o,o,f),p.encodeNormal(o,u);for(var S=0;S<3;S++){var M=y+g*n[m+S];E[M]=p.encodeInt16(u[0]),E[M+1]=p.encodeInt16(u[1])}}}r.interleaveGeometryBuffer=function(e,r,t,n,a){void 0===n&&(n=[]),void 0===a&&(a=[]);var o=e.params.vertexAttributes,i=o.position.count;if(!m(t[0].stride))throw b("Layout stride must use "+Uint32Array.BYTES_PER_ELEMENT+"-byte words");for(var s=t[0].stride/Uint32Array.BYTES_PER_ELEMENT,c=new Uint32Array(s*i),f=function(e){if(-1!==a.indexOf(e.name))return"continue";var t=o[e.name],s=function(e){switch(e){case 5120:return Int8Array;case 5126:return Float32Array;case 5124:return Int32Array;case 5122:return Int16Array;case 5121:return Uint8Array;case 5125:return Uint32Array;case 5123:return Uint16Array}throw new Error("Unhandled data type: "+e)}(e.type),f=void 0,u=!1;if(null==t){var l=n.filter((function(r){return r.name===e.name}))[0];if(!l)throw b("Geometry definition is missing attribute");t={valueType:y(e.type),byteOffset:0,count:i,valuesPerElement:e.count};for(var d=0;d<E.length;d++)E[d]=l.byteValue;f=E.buffer,u=!0}else f=r;if(y(e.type)!==t.valueType)throw b("Geometry definition type must match attribute type");if(!g(t.byteOffset)||!g(e.offset))throw b(e.name+" offset must use "+Uint32Array.BYTES_PER_ELEMENT+"-byte words");if(!m(t.valuesPerElement*s.BYTES_PER_ELEMENT)||!m(e.count*s.BYTES_PER_ELEMENT))throw b(e.name+" data must use "+Uint32Array.BYTES_PER_ELEMENT+"-byte words");var v=new Uint32Array(f),p=t.byteOffset/Uint32Array.BYTES_PER_ELEMENT,h=t.valuesPerElement*s.BYTES_PER_ELEMENT/Uint32Array.BYTES_PER_ELEMENT,T=e.offset/Uint32Array.BYTES_PER_ELEMENT,w=e.stride/Uint32Array.BYTES_PER_ELEMENT;u?function(e,r,t,n,a,o){switch(r){case 1:for(var i=0;i<o;i++)t[n]=e,n+=a;break;case 2:for(i=0;i<o;i++)t[n]=e,t[n+1]=e,n+=a;break;case 3:for(i=0;i<o;i++)t[n]=e,t[n+1]=e,t[n+2]=e,n+=a;break;case 4:for(i=0;i<o;i++)t[n]=e,t[n+1]=e,t[n+2]=e,t[n+3]=e,n+=a;break;default:throw b("Unhandled stride size "+r)}}(v[0],h,c,T,w,i):function(e,r,t,n,a,o,i){switch(t){case 1:for(var s=0;s<i;s++)n[a]=e[r],r+=1,a+=o;break;case 2:for(s=0;s<i;s++)n[a]=e[r],n[a+1]=e[r+1],r+=2,a+=o;break;case 3:for(s=0;s<i;s++)n[a]=e[r],n[a+1]=e[r+1],n[a+2]=e[r+2],r+=3,a+=o;break;case 4:for(s=0;s<i;s++)n[a]=e[r],n[a+1]=e[r+1],n[a+2]=e[r+2],n[a+3]=e[r+3],r+=4,a+=o;break;default:throw b("Unhandled stride size "+t)}}(v,p,h,c,T,w,i)},u=0,l=t=t.slice(0).sort((function(e,r){return e.offset-r.offset}));u<l.length;u++){f(l[u])}return c.buffer},r.processAndInterleaveNormals=function(e,r,t,n){if("none"===e)h(n);else{var a="earth-centered"===e?t:null;!function(e,r,t){var n=e.length/3,a=r.data,o=r.offsetIdx,i=r.strideIdx;if(null!=t)for(var s=t,c=s[0],f=s[1],u=s[2],l=s[4],d=s[5],v=s[6],E=s[8],y=s[9],g=s[10],m=0;m<n;m++){var b=e[3*m],h=e[3*m+1],T=e[3*m+2];U[0]=c*b+f*h+u*T,U[1]=l*b+d*h+v*T,U[2]=E*b+y*h+g*T,p.encodeNormal(U,_),a[o+m*i]=p.encodeInt16(_[0]),a[o+m*i+1]=p.encodeInt16(_[1])}else for(m=0;m<n;m++)U[0]=e[3*m],U[1]=e[3*m+1],U[2]=e[3*m+2],p.encodeNormal(U,_),a[o+m*i]=p.encodeInt16(_[0]),a[o+m*i+1]=p.encodeInt16(_[1])}(r,n.normals,a)}},r.computeCompressedNormals=h;var T;function w(){return!!T}function A(e,r){return T.intersects(e,r)?T.contains(e,r)?0:2:1}function S(e,r){return T.intersects(e,r)?T.contains(e,r)?1:2:0}r.extractPositionData=function(e,r,t){var n=r[0];if(null==n||"position"!==n.name||5126!==n.type)return null;for(var a=new Float32Array(e),o=n.stride/4,i=n.offset/4,s=3*a.length/o,c=new Float32Array(s),f=0;f<s/3;f++)c[3*f]=a[f*o+i],c[3*f+1]=a[f*o+i+1],c[3*f+2]=a[f*o+i+2];var u=d.default(c.buffer,3,t);return u.uniqueCount<65536?{data:new Float32Array(u.buffer),indices:new Uint16Array(u.indices)}:{data:new Float32Array(u.buffer),indices:u.indices}},r.isGeometryEngineLoaded=w,r.loadGeometryEngine=function(){return n(this,void 0,void 0,(function(){return t(this,(function(r){switch(r.label){case 0:return w()?[2,T]:[4,o.create((function(r){return e(["../../../../geometry/geometryEngine"],r)}))];case 1:return[2,T=r.sent()]}}))}))},r.processFilterGeometry=function(e,r){if(!e)return null;if("disjoint"===r&&"polygon"===e.type){for(var t=new Array(e.rings.length),n=0;n<e.rings.length;++n){var o=l.fromValues(1/0,1/0,-1/0,-1/0);l.expandWithNestedArray(o,e.rings[n]),t[n]={type:"polygon",rings:[e.rings[n]],spatialReference:e.spatialReference,aabr:o}}t.sort((function(e,r){return e.aabr[0]-r.aabr[0]}));var i=new Set,s=new a.PositionHint,c=function(e){for(var r=t[e],n=e+1;n<t.length;++n){var o=t[n];if(o.aabr[0]>=r.aabr[2])break;i.add(o)}i.forEach((function(e){if(r!==e)if(e.aabr[2]<=r.aabr[0])i.delete(e);else if(T.intersects(r,e)){r.rings=r.rings.concat(e.rings),l.expand(r.aabr,e.aabr),delete r._geVersion,i.delete(e);var n=a.indexOf(t,e,t.length,s);t.splice(n,1)}})),i.add(r)};for(n=0;n<t.length;++n)c(n);for(var f=0,u=t;f<u.length;f++){delete u[f].aabr}return t}return[e]},r.acquireMaskFilterContext=function(e,r,t,n,a){var o,i,s=r.renderSpatialReference,c=new Map,f={rings:[[[0,0,0],[0,0,0],[0,0,0],[0,0,0]]],hasZ:!1,hasM:!1,type:"polygon",spatialReference:t};switch(f.rings[0][3]=f.rings[0][0],e){case"intersects":o=function(e,r){return T.intersects(e,r)?0:2},i=A;break;case"contains":o=function(e,r){return T.contains(e,r)?2:1},i=A;break;case"disjoint":default:o=function(e,r){return T.disjoint(e,r)?2:1},i=S}return{collection:n,object:a,type:e,maskSR:t,renderSR:s,aabbCache:c,triangle:f,positions:{indices:null,data:null,stride:0,startIndex:0,endIndex:0},triangleTest:o,geometryTest:i}},r.computeMaskNodeMBS=function(e,r){var t={x:e[0],y:e[1],hasZ:!1,hasM:!1,type:"point",spatialReference:r.maskSR};return!r.maskSR.isWGS84&&!r.maskSR.isWebMercator?T.buffer(t,e[3],1,!0):T.geodesicBuffer(t,e[3],1,!0)},r.testMaskWithGeometry=function(e,r,t){switch(t){case"intersects":case"contains":return A(e,r);case"disjoint":return S(e,r)}};var M=Math.pow(2,-32);r.filterWithMask=function(e,r,t){var n=t.collection,a=t.object,o=t.renderSR,i=t.maskSR,c=t.geometryTest,f=t.aabbCache,u=f.get(r);if(!u){var l=n.getObjectTransform(a);n.getComponentAABB(a,r,I);for(var d=[[I[0],I[1],0],[I[0],I[4],0],[I[3],I[4],0],[I[3],I[1],0]],p=0;p<4;++p)s.vec3.transformMat3(d[p],d[p],l.rotationScale),s.vec3.add(d[p],d[p],l.position),v.vectorToVector(d[p],o,d[p],i);(u={rings:[d],hasZ:!1,hasM:!1,type:"polygon",spatialReference:i}).rings[0][4]=u.rings[0][0],f.set(r,u)}switch(c(e,u)){case 1:return!1;case 0:return!0}var E=t.triangle,y=t.triangleTest,g=t.positions,m=E.rings[0][0],b=E.rings[0][1],h=E.rings[0][2],T=n.getObjectTransform(a);n.getComponentPositions(a,r,g);var w=g.indices,A=g.data,S=g.stride,U=g.startIndex,_=g.endIndex;for(p=U;p<_;p+=3){var B=S*w[p+0],R=S*w[p+1],x=S*w[p+2];s.vec3.set(m,A[B+0],A[B+1],A[B+2]),s.vec3.set(b,A[R+0],A[R+1],A[R+2]),s.vec3.set(h,A[x+0],A[x+1],A[x+2]),s.vec3.transformMat3(m,m,T.rotationScale),s.vec3.transformMat3(b,b,T.rotationScale),s.vec3.transformMat3(h,h,T.rotationScale),s.vec3.add(m,m,T.position),s.vec3.add(b,b,T.position),s.vec3.add(h,h,T.position),v.vectorToVector(m,o,m,i),v.vectorToVector(b,o,b,i),v.vectorToVector(h,o,h,i);var P=b[0]-m[0],k=b[1]-m[1],N=h[0]-m[0],L=h[1]-m[1];if(!(Math.abs(P*L-k*N)<M))switch(delete E._geVersion,y(e,E)){case 1:return!1;case 0:return!0}}switch(t.type){case"intersects":return!1;case"contains":case"disjoint":default:return!0}},r.boundingBoxCornerPoints=function(e,r,t,n){for(var a=r.getComponentAABB(t,e,I),o=r.getObjectTransform(t),i=0;i<8;++i)B[0]=1&i?a[0]:a[3],B[1]=2&i?a[1]:a[4],B[2]=4&i?a[2]:a[5],s.vec3.transformMat3(B,B,o.rotationScale),s.vec3.add(B,B,o.position),n[3*i]=B[0],n[3*i+1]=B[1],n[3*i+2]=B[2];return n},r.boundingBoxTop=function(e,r,t,n){var a=r.getComponentAABB(t,e,I),o=r.getObjectTransform(t);n[0]=0,n[1]=0,n[2]=0;for(var i=0;i<8;++i)B[0]=1&i?a[0]:a[3],B[1]=2&i?a[1]:a[4],B[2]=a[5],s.vec3.transformMat3(B,B,o.rotationScale),s.vec3.add(B,B,o.position),n[0]+=B[0],n[1]+=B[1],n[2]+=B[2];return n[0]/=8,n[1]/=8,n[2]/=8,n};var I=u.create(),U=c.vec3f32.create(),_=i.vec2f32.create(),B=f.vec3f64.create()}));