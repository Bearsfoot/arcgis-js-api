// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../../core/maybe","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/mat4f32","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f32","../../../../core/libs/gl-matrix-2/vec3f64","../../../../core/libs/gl-matrix-2/vec4","../../../../geometry/support/aaBoundingBox","./PointHighlights","../../support/geometryUtils","../../support/geometryUtils","../../support/orientedBoundingBox","../../webgl-engine/core/shaderLibrary/Slice.glsl","../../webgl-engine/core/shaderLibrary/output/OutputHighlight.glsl","../../webgl-engine/lib/ComponentUtils","../../webgl-engine/lib/DefaultVertexAttributeLocations","../../webgl-engine/lib/intersectorUtils","../../webgl-engine/shaders/PointRendererTechnique","../../../webgl/BufferObject","../../../webgl/VertexArrayObject"],(function(e,t,i,n,r,s,o,a,l,c,h,u,d,f,p,g,m,v,_,b,x,y,S){Object.defineProperty(t,"__esModule",{value:!0});var P={positions:[{name:"position",count:3,type:5126,offset:0,stride:12,normalized:!1}],colors:[{name:"color",count:3,type:5121,offset:0,stride:3,normalized:!0}]},z=function(){function e(e){var t=this;this._params=e,this.type="Point",this.isGround=!1,this._highlights=new u.PointHighlights({forEachNode:function(e){return t.forEachNode(e)},addHighlight:function(e,i,n){return t.addHighlight(e,i,n)},removeHighlight:function(e,i){return t.removeHighlight(e,i)}}),this.canRender=!0,this.layerUid="",this._useFixedSizes=!1,this._scaleFactor=1,this._minSizePx=0,this._useRealWorldSymbolSizes=!1,this._size=0,this._sizePx=0,this._slicePlaneEnabled=!1,this._clipBox=h.create(h.POSITIVE_INFINITY),this._techniqueConfig=new x.PointRendererTechniqueConfiguration,this.tempMatrix4=r.mat4f32.create(),this.tempVec3=a.vec3f32.create(),this.nodes=[]}return Object.defineProperty(e.prototype,"needsHighlight",{get:function(){return this._highlights.hasHighlights},enumerable:!0,configurable:!0}),e.prototype.initializeRenderContext=function(e){this._initContext=e,this._techniqueRep=this._initContext.shaderTechniqueRep,e.requestRender()},e.prototype.uninitializeRenderContext=function(){},e.prototype.intersect=function(e,t,i,n){var r=this,a=l.vec3f64.create(),u=l.vec3f64.create(),g=l.vec3f64.create(),m=l.vec3f64.create(),v=f.plane.create(),_=e.camera.perScreenPixelRatio/2,x=e.camera.near,y=this._getSizeParams();o.vec3.subtract(u,n,i);var S=1/o.vec3.length(u);o.vec3.scale(u,u,S),o.vec3.negate(g,u),c.vec4.set(v,u[0],u[1],u[2],-o.vec3.dot(u,i));var P=function(){this.node=null,this.pointId=null,this.point=null,this.dist=null,this.normal=null,this.layerUid=""},z=new P,R=new P,M=[],H=h.create(),I=h.create(this._clipBox);h.offset(I,-i[0],-i[1],-i[2],I);for(var O=function(s){var c=s.splatSize*F._scaleFactor,d=p.minimumDistancePlane(s.obb,v),f=p.maximumDistancePlane(s.obb,v);d-=w(c,d+x,y,_,s.isLeaf);var b=(f-=w(c,f+x,y,_,s.isLeaf))<0,O=null!=z.dist&&null!=R.dist&&z.dist<d*S&&R.dist>f*S;if(b||O)return"continue";var U=q(c,f+x,y,_,s.isLeaf);if(!p.intersectLine(s.obb,i,u,U))return"continue";var V=U*U;p.toAaBoundingBox(s.obb,H),h.offset(H,-i[0],-i[1],-i[2],H);var C=!h.contains(I,H);o.vec3.subtract(m,s.origin,i);for(var E=s.coordinates.length/3,T=function(d){if(a[0]=m[0]+s.coordinates[3*d],a[1]=m[1]+s.coordinates[3*d+1],a[2]=m[2]+s.coordinates[3*d+2],C&&!h.containsPoint(I,a))return"continue";var f=o.vec3.dot(a,u),p=o.vec3.squaredLength(a)-f*f;if(p>V)return"continue";var v=f+x,b=w(c,v,y,_,s.isLeaf);if(f-b<0)return"continue";var H=q(c,v-=b,y,_,s.isLeaf);if(p>H*H)return"continue";var O=(f-b)*S,F=function(e){e.point=function(e,t,i){null==i&&(i=l.vec3f64.create());return i[0]=e.origin[0]+e.coordinates[3*t],i[1]=e.origin[1]+e.coordinates[3*t+1],i[2]=e.origin[2]+e.coordinates[3*t+2],i}(s,d,e.point),e.dist=O,e.normal=g,e.node=s,e.pointId=d,e.layerUid=r.layerUid};if((null==z.dist||O<z.dist)&&(null==t||t(i,n,O))&&F(z),0!==e.options.store&&(null==R.dist||O>R.dist)&&(null==t||t(i,n,O))&&F(R),2===e.options.store&&(null==t||t(i,n,O))){var U=new P;F(U),M.push(U)}},j=0;j<E;j++)T(j)},F=this,U=0,V=this.nodes;U<V.length;U++){O(V[U])}var C=function(e,t){var i=function(e){var t=e.layerUid,i=e.node,n=e.pointId;return{type:"external",point:e.point,metadata:{layerUid:t,createGraphic:function(){return r._params.createGraphic(i,n,e.point)}}}}(t),n=t.layerUid+"/"+t.node.id+"/"+t.pointId;e.set(i,n,t.dist,t.normal,s.mat4f64.IDENTITY,void 0),e.intersector="PointRenderer"};if(null!=z.dist){var E=e.results.min;(null==E.dist||z.dist<E.dist)&&C(E,z)}if(null!=R.dist&&0!==e.options.store){var T=e.results.max;(null==T.dist||R.dist>T.dist)&&C(T,R)}if(2===e.options.store)for(var j=d.ray.fromPoints(i,n),N=0,B=M;N<B.length;N++){var A=B[N],L=new b.IntersectorResult(j);C(L,A),e.results.all.push(L)}},e.prototype.render=function(e){if(0!==e.pass&&1!==e.pass&&4!==e.pass)return!1;for(var t=1===e.pass,i=e.rctx,r=0,s=this.nodes;r<s.length;r++){null==(x=s[r]).vao&&this._initNode(e,x)}var a=this._getSizeParams(),l=this.selectTechnique(e,a),c=l.program;if(null==c||0===this.nodes.length)return!0;var u=this._clipBox,d=!h.equals(u,h.POSITIVE_INFINITY,(function(e,t){return e===t}));if(d||(o.vec3.set(this.tempVec3,-1/0,-1/0,-1/0),c.setUniform3fv("uClipMin",this.tempVec3),o.vec3.set(this.tempVec3,1/0,1/0,1/0),c.setUniform3fv("uClipMax",this.tempVec3)),i.bindProgram(c),l.bindPipelineState(i),c.setUniformMatrix4fv("uProjectionMatrix",e.camera.projectionMatrix),t&&c.setUniform2f("nearFar",e.camera.near,e.camera.far),e.isHighlightPass){var f={viewport:e.camera.fullViewport,highlightDepthTexture:e.highlightDepthTexture};m.OutputHighlight.bindOutputHighlight(i,c,f)}var p=e.camera.pixelRatio;a.drawFixedSize&&c.setUniform2f("uPointScale",a.fixedSize*p,e.camera.fullHeight);for(var v=this._slicePlaneEnabled?e.sliceHelper&&e.sliceHelper.plane:null,_=0,b=this.nodes;_<b.length;_++){var x;if(0!==(x=b[_]).coordinates.length&&(!e.isHighlightPass||x.highlights)){if(c.setUniform2f("uScreenMinMaxSize",a.screenMinSize*p,R(x.isLeaf)*p),!a.drawFixedSize){var y=x.splatSize*this._scaleFactor;c.setUniform2f("uPointScale",y*p,e.camera.fullHeight/p)}var S=x.origin;d&&(o.vec3.set(this.tempVec3,u[0]-S[0],u[1]-S[1],u[2]-S[2]),c.setUniform3fv("uClipMin",this.tempVec3),o.vec3.set(this.tempVec3,u[3]-S[0],u[4]-S[1],u[5]-S[2]),c.setUniform3fv("uClipMax",this.tempVec3)),n.mat4.identity(this.tempMatrix4),n.mat4.translate(this.tempMatrix4,this.tempMatrix4,S),n.mat4.multiply(this.tempMatrix4,e.camera.viewMatrix,this.tempMatrix4),c.setUniformMatrix4fv("uModelViewMatrix",this.tempMatrix4),g.Slice.bindUniforms(c,l.configuration,v,S),i.bindVAO(x.vao),e.isHighlightPass?this._renderHighlightFragments(i,x):i.drawArrays(0,0,x.coordinates.length/3)}}return!0},e.prototype._renderHighlightFragments=function(e,t){var n=t.highlights;if(n){for(var r=i.unwrap(n[0].component),s=r+1,o=1;o<n.length;o++){var a=i.unwrap(n[o].component);if(a!==s){var l=s-r;l>0&&e.drawArrays(0,r,l),r=a}s=a+1}var c=s-r;c>0&&e.drawArrays(0,r,c)}},Object.defineProperty(e.prototype,"useFixedSizes",{get:function(){return this._useFixedSizes},set:function(e){this._useFixedSizes!==e&&(this._useFixedSizes=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"scaleFactor",{get:function(){return this._scaleFactor},set:function(e){this._scaleFactor!==e&&(this._scaleFactor=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"minSizePx",{get:function(){return this._minSizePx},set:function(e){this._minSizePx!==e&&(this._minSizePx=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"useRealWorldSymbolSizes",{get:function(){return this._useRealWorldSymbolSizes},set:function(e){this._useRealWorldSymbolSizes!==e&&(this._useRealWorldSymbolSizes=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"size",{get:function(){return this._size},set:function(e){this._size!==e&&(this._size=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"sizePx",{get:function(){return this._sizePx},set:function(e){this._sizePx!==e&&(this._sizePx=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"clippingBox",{set:function(e){h.set(this._clipBox,e||h.POSITIVE_INFINITY)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"slicePlane",{get:function(){return this._slicePlaneEnabled},set:function(e){this._slicePlaneEnabled!==e&&(this._slicePlaneEnabled=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"intersectionHandlerId",{get:function(){return this.layerUid},enumerable:!0,configurable:!0}),e.prototype.addNode=function(e){this.nodes.push(e),this._highlights.nodeAdded(e),this._requestRender()},e.prototype.removeNode=function(e){var t=this,i=null;return this.nodes=this.nodes.filter((function(n){return n.id!==e||(i=n,n.vao&&(n.vao.dispose(!0),n.vao=null),t._highlights.nodeRemoved(n),!1)})),this._requestRender(),i},e.prototype.forEachNode=function(e){this.nodes.forEach(e)},e.prototype.removeAll=function(){this.nodes.forEach((function(e){e.vao&&(e.vao.dispose(!0),e.vao=null)})),this._highlights.removeAll(),this.nodes=[],this._requestRender()},e.prototype.highlight=function(e){return this._highlights.add(e)},e.prototype.addHighlight=function(e,t,i){e.highlights=v.addHighlight(e.highlights,t,i),this._requestRender()},e.prototype.removeHighlight=function(e,t){e.highlights=v.removeHighlight(e.highlights,t),this._requestRender()},e.prototype._initNode=function(e,t){var i=e.rctx;t.vao=new S(i,_.Default3D,P,{positions:y.createVertex(i,35044,t.coordinates),colors:y.createVertex(i,35044,t.rgb)})},e.prototype._requestRender=function(){this._initContext&&this._initContext.requestRender()},e.prototype._getSizeParams=function(){var e=this._useFixedSizes,t=e&&!this._useRealWorldSymbolSizes,i=t?this._sizePx:this._size,n=this._minSizePx;return e&&(n=0),{drawScreenSpace:t,drawFixedSize:e,fixedSize:i,screenMinSize:n}},e.prototype.selectTechnique=function(e,t){return this._techniqueConfig.drawScreenSize=t.drawScreenSpace,this._techniqueConfig.slicePlaneEnabled=this._slicePlaneEnabled,this._techniqueConfig.sceneHasOcludees=e.hasOccludees,this._techniqueConfig.output=1===e.pass?1:4===e.pass?4:0,this._techniqueRep.acquireAndReleaseExisting(x.PointRendererTechnique,this._techniqueConfig,this._technique)},e}();function R(e){return e?256:64}function q(e,t,i,n,r){if(i.drawScreenSpace)return i.fixedSize*t*n;var s=R(r)*t*n;return i.drawFixedSize?Math.min(i.fixedSize/2,s):i.screenMinSize>0?Math.min(Math.max(i.screenMinSize*t*n,e/2),s):Math.min(e/2,s)}function w(e,t,i,n,r){return i.drawScreenSpace?0:q(e,t,i,n,r)}t.PointRenderer=z,function(e){e.isInstanceOfNode=function(e){return e.hasOwnProperty("splatSize")}}(z=t.PointRenderer||(t.PointRenderer={})),t.PointRenderer=z}));