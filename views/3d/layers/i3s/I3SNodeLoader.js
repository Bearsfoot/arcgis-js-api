// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../core/asyncUtils","../../../../core/has","../../../../core/lang","../../../../core/promiseUtils","../../../../core/urlUtils","../../../../libs/draco/DracoDecoder","./I3SBinaryReader","./I3SMaterialUtil","./I3SUtil"],(function(e,t,r,n,i,o,a,s,u,l,d,f,c){var m=function(){function e(e,t,r,n,i,o){if(this.streamDataController=t,this.logger=r,this.defaultGeometrySchema=n,this.requiredAttributes=i,this.options=o,this.layerUrl=e.parsedUrl.path,this.geometryDefinitions=e.geometryDefinitions,e.materialDefinitions){var a=e.textureSetDefinitions;this.materialAndTextures=e.materialDefinitions.map((function(e){return f.getMaterialAndTextures(a,e)}))}}return e.prototype.load=function(e,t,r){return this.streamDataController.request(e,t,{signal:r})},e.prototype.loadAttribute=function(e,t,r){var n=this.layerUrl+"/nodes/"+e.resources.attributes+"/attributes/"+t.key+"/0";return this.load(n,"binary",r).then((function(e){return d.readBinaryAttribute(t,e)}))},e.prototype.loadAttributes=function(e,t,r){var n=this;return s.eachAlways(t.map((function(t){return n.loadAttribute(e,t.attributeStorageInfo,r)}))).then((function(r){for(var i={},o=0;o<t.length;++o)if(r[o].value)i[t[o].name]=r[o].value;else{if(s.isAbortError(r[o].error))throw r[o].error;n.logger.error("Failed to load attributeData for '"+t[o].name+"' on node '"+e.id+"'",r[o].error)}return i}))},e.prototype.loadNodeData=function(e,t){return n(this,void 0,void 0,(function(){var n,s,u,c,m,h,g,p,y,b,D,x,v,A,I,T,S,F,w,G,U,C,k,q,N,R,E,M,j;return r(this,(function(r){switch(r.label){case 0:return n=null!=this.requiredAttributes&&e.resources.attributes?i.result(this.loadAttributes(e,this.requiredAttributes,t)):null,s=function(e,t){var r={bufferDefinition:null,bufferIndex:0};if(null==e||t.resources.geometryDefinition<0)return r;var n=t.resources.geometryDefinition>=0?e[t.resources.geometryDefinition].geometryBuffers:null;if(null==n)return r;for(var i=0;i<n.length;i++)if(null==n[i].compressedAttributes)r.bufferIndex=i,r.bufferDefinition=n[i];else if("draco"===n[i].compressedAttributes.encoding&&l.isSupported()&&!o("disable-feature:i3s-draco"))return r.bufferIndex=i,r.bufferDefinition=n[i],r;return r}(this.geometryDefinitions,e),u=s.bufferDefinition,c=s.bufferIndex,m=e.resources.geometry?i.result(this.loadGeometry(e,c,t)):null,e.resources.hasSharedResource?[4,this.loadShared(e,t)]:[3,2];case 1:return g=r.sent(),[3,3];case 2:g=null,r.label=3;case 3:return h=g,p=this.materialAndTextures&&e.resources.materialDefinition>=0?this.materialAndTextures[e.resources.materialDefinition]:null!=h?f.getMaterialAndTexturesFromShared(h):null,y=p&&p.material,b=p&&p.textures,this.options.loadFeatureData?[4,this.loadFeatureData(e,t)]:[3,5];case 4:return x=r.sent(),[3,6];case 5:x=null,r.label=6;case 6:return D=x,v=this.options.loadFeatureData?this.collectGeometries(D):this.meshPyramidGeometryData(y),A=null!=b&&b.length>0?i.result(this.loadTextures(e,b,t)):null,I=null,T=null,m?(F=(S=i).assertResult,[4,m]):[3,8];case 7:I=F.apply(S,[r.sent()]),w=function(e,t){if(!e||!t||!t.materialDefinitions)return e;var r=Object.keys(t.materialDefinitions)[0];!t.materialDefinitions[r].params.vertexRegions&&e.vertexAttributes.region&&delete(e=a.clone(e)).vertexAttributes.region;return e}(this.defaultGeometrySchema,h),G=!(!u||!u.compressedAttributes||"draco"!==u.compressedAttributes.encoding),T=G?d.createGeometryIndexFromAttributes(u.compressedAttributes.attributes):u?d.createGeometryIndexFromDefinition(u,e.vertexCount,e.numFeatures):d.createGeometryIndexFromSchema(I,w),r.label=8;case 8:return A?(q=(k=i).assertResult,[4,A]):[3,10];case 9:return C=q.apply(k,[r.sent()]),[3,11];case 10:C=null,r.label=11;case 11:return U=C,n?(M=(E=i).assertResult,[4,n]):[3,13];case 12:return R=M.apply(E,[r.sent()]),[3,14];case 13:R={},r.label=14;case 14:return j=(N=R)?{attributeData:N,loadedAttributes:this.requiredAttributes}:null,[2,{allGeometryData:v,attributeDataInfo:j,geometryBuffer:I,geometryIndex:T,requiredTextures:b,textureData:U}]}}))}))},e.addAbsoluteHrefTexture=function(e,t){var r=e.textureDefinitions;if(null!=r)for(var n=0,i=Object.keys(r);n<i.length;n++)for(var o=0,a=r[i[n]].images;o<a.length;o++){var s=a[o];Array.isArray(s.href)?s.hrefConcat=s.href.map((function(e){return u.makeAbsolute(e,t)})):s.hrefConcat=u.makeAbsolute(s.href,t)}},e.fixTextureEncodings=function(e){var t=e.textureDefinitions;if(null!=t)for(var r in t){var n=t[r];if(Array.isArray(n.encoding))for(var i=0;i<n.encoding.length;i++){var o;"data:"===(o=n.encoding[i]).substring(0,5)&&(n.encoding[i]=o.substring(5))}else"data:"===(o=n.encoding).substring(0,5)&&(n.encoding=o.substring(5))}},e.prototype.loadShared=function(t,r){var n=this.layerUrl+"/nodes/"+t.resources.geometry+"/shared";return this.load(n,"json",r).then((function(t){return e.fixTextureEncodings(t),e.addAbsoluteHrefTexture(t,n),t}))},e.prototype.loadTexture=function(e,t,r,n,i,o){return i===c.DDS_ENCODING_STRING?this.load(e,"binary",o).then((function(e){return{id:t,usage:r,data:e,encoding:i}})):this.load(e,"image",o).then((function(e){var o=e;if(n&&e.width*e.height>=4096){var a=Math.ceil(e.width/2),s=Math.ceil(e.height/2),u=document.createElement("canvas");u.width=a,u.height=s,u.getContext("2d").drawImage(e,0,0,a,s),o=u}return{id:t,usage:r,data:o,encoding:i}}))},e.prototype.loadTextures=function(t,r,n){var i=this,o=this.options.textureFormat===e.TextureFormat.Compressed,a=this.options.textureFormat===e.TextureFormat.Downsampled,u=this.options.textureUsageMask;return s.all(r.map((function(e){if(0==(e.usage&u))return null;var r=c.selectEncoding(e.encodings,o);if(null==r)return i.logger.error("No known encoding for texture found on node "+t.id),s.reject();var l=t.resources.texture||t.id,d=i.layerUrl+"/nodes/"+l+"/textures/"+r.name;return i.loadTexture(d,e.id,e.usage,a,r.encoding,n)})))},e.prototype.meshPyramidGeometryData=function(e){return[{featureIds:[],geometries:[{type:"ArrayBufferView",params:{material:e}}],featureDataPosition:[0,0,0]}]},e.prototype.collectGeometries=function(e){for(var t=new Array,r=0,n=e.featureData;r<n.length;r++){var i=n[r],o=i.geometries;if(null!=o)for(var a=0,s=o;a<s.length;a++){var u=s[a];t.push({featureIds:[i.id],featureDataPosition:i.position,geometries:[u]})}else null!=i.position&&t.push({featureIds:[i.id],featureDataPosition:i.position,geometries:null})}return t},e.prototype.loadFeatureData=function(e,t){var r=this.layerUrl+"/nodes/"+e.id+"/features/0";return this.load(r,"json",t)},e.prototype.loadGeometry=function(e,t,r){var n=this.layerUrl+"/nodes/"+e.resources.geometry+"/geometries/"+t;return this.load(n,"binary",r)},e}();return function(e){!function(e){e[e.Compressed=0]="Compressed",e[e.Normal=1]="Normal",e[e.Downsampled=2]="Downsampled"}(e.TextureFormat||(e.TextureFormat={}))}(m||(m={})),m}));