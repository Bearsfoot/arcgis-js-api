// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/assignHelper","../../../../core/mathUtils","../../../../core/maybe","../../../../core/typedArrayUtil","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../../../geometry/support/triangulationUtils","./constants","./elevationAlignmentUtils","../../support/projectionUtils","../../terrain/OverlayRenderer","../../webgl-engine/lib/GeometryData","../../webgl-engine/shaders/RibbonLineTechnique"],(function(t,e,r,n,a,i,o,s,u,b,l,f,I,c,d){function p(t,e,r){for(var n=new Array,a=0,i=t;a<i.length;a++){var o=i[a],s=o.index,u=o.count;if(!(u<=1)){var b=3*s,l=b+3*u;n.push({position:e.subarray(b,l),mapPosition:r?r.subarray(b,l):void 0})}}return n}Object.defineProperty(e,"__esModule",{value:!0}),e.createGeometryData=function(t){var e={},r={};!function(t,e,r){for(var n=t.attributeData.position,a=t.removeDuplicateStartEnd,o=(I=n,c=void 0,c=I.length,I[0]===I[c-3]&&I[1]===I[c-2]&&I[2]===I[c-1]&&1===a),s=n.length/3-(o?1:0),u=new Uint32Array(2*(s-1)),b=o?i.slice(n,0,n.length-3):n,l=0,f=0;f<s-1;f++)u[l++]=f,u[l++]=f+1;var I,c;e[d.RibbonVertexAttributeConstants.POSITION]={size:3,data:b,offsetIdx:0,strideIdx:3},r[d.RibbonVertexAttributeConstants.POSITION]=u}(t,r,e);var s=new Uint32Array(e[d.RibbonVertexAttributeConstants.POSITION].length);return function(t,e,r){var n=t.attributeData.mapPosition;if(a.isNone(n))return;r.mapPos=r[d.RibbonVertexAttributeConstants.POSITION],e.mapPos={size:3,data:n,offsetIdx:0,strideIdx:3}}(t,r,e),function(t,e,r,n){if(a.isSome(t.attributeData.colorFeature))return;var i=t.attributeData.color;e[d.RibbonVertexAttributeConstants.COLOR]={size:4,data:a.unwrapOr(i,b.WHITE_UNIT),offsetIdx:0,strideIdx:4},r[d.RibbonVertexAttributeConstants.COLOR]=n}(t,r,e,s),function(t,e,r,n){if(a.isSome(t.attributeData.sizeFeature))return;var i=t.attributeData.size;e[d.RibbonVertexAttributeConstants.SIZE]={size:1,data:new Float32Array([a.unwrapOr(i,1)]),offsetIdx:0,strideIdx:1},r[d.RibbonVertexAttributeConstants.SIZE]=n}(t,r,e,s),function(t,e,r,n){var i=t.attributeData.colorFeature;if(a.isNone(i))return;e[d.RibbonVertexAttributeConstants.COLORFEATUREATTRIBUTE]={size:1,data:new Float32Array([i]),offsetIdx:0,strideIdx:1},r[d.RibbonVertexAttributeConstants.COLOR]=n}(t,r,e,s),function(t,e,r,n){var i=t.attributeData.sizeFeature;if(a.isNone(i))return;e[d.RibbonVertexAttributeConstants.SIZEFEATUREATTRIBUTE]={size:1,data:new Float32Array([i]),offsetIdx:0,strideIdx:1},r[d.RibbonVertexAttributeConstants.SIZEFEATUREATTRIBUTE]=n}(t,r,e,s),function(t,e,r,n){var i=t.attributeData.opacityFeature;if(a.isNone(i))return;e[d.RibbonVertexAttributeConstants.OPACITYFEATUREATTRIBUTE]={size:1,data:new Float32Array([i]),offsetIdx:0,strideIdx:1},r[d.RibbonVertexAttributeConstants.OPACITYFEATUREATTRIBUTE]=n}(t,r,e,s),function(t,e,r){if("round"!==t.join)return;var i=e[d.RibbonVertexAttributeConstants.POSITION].data,s=i.length/3,u=new Float32Array(s),b=A,l=x;o.vec3.set(b,0,0,0);for(var f=a.unwrapOr(t.uniformSize,1),I=-1;I<s;++I){var c=I<0?s+I:I,p=(I+1)%s;if(o.vec3.set(l,i[3*p+0]-i[3*c+0],i[3*p+1]-i[3*c+1],i[3*p+2]-i[3*c+2]),o.vec3.normalize(l,l),I>=0){var v=1*((Math.PI-n.acosClamped(o.vec3.dot(b,l)))*R)*(T=f,1.863798+-2.0062872/Math.pow(1+T/18.2313,.8856294));u[I]=Math.max(Math.floor(v),0)}o.vec3.scale(b,l,-1)}var T;e[d.RibbonVertexAttributeConstants.SUBDIVISIONS]={size:1,data:u,offsetIdx:0,strideIdx:1},r[d.RibbonVertexAttributeConstants.SUBDIVISIONS]=r[d.RibbonVertexAttributeConstants.POSITION]}(t,r,e),new c.GeometryData(r,e,c.GeometryData.DefaultOffsets,"line")},e.geometryToRenderInfo=function(t,e,r,n){var a="polygon"===t.type?1:0,i="polygon"===t.type?t.rings:t.paths,o=u.pathsToTriangulationInfo(i,t.hasZ,a),s=o.position,b=o.outlines,f=new Float64Array(s.length),I=l.applyPerVertexElevationAlignment(s,t.spatialReference,0,f,0,s,0,s.length/3,e,r,n),c=null!=I;return{lines:c?p(b,s,f):[],projectionSuccess:c,sampledElevation:I}},e.geometryToRenderInfoDraped=function(t,e){for(var r="polygon"===t.type?1:0,n="polygon"===t.type?t.rings:t.paths,a=u.pathsToTriangulationInfo(n,!1,r),i=a.position,o=a.outlines,s=f.bufferToBuffer(i,t.spatialReference,0,i,e,0,i.length/3),b=2;b<i.length;b+=3)i[b]=I.DRAPED_Z;return{lines:s?p(o,i):[],projectionSuccess:s}};var A=s.vec3f64.create(),x=s.vec3f64.create(),R=4/Math.PI}));