// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/assignHelper","../../../../core/tsSupport/extendsHelper","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../Color","../../../../core/maybe","../../../../core/unitUtils","../../../../core/libs/earcut/earcut","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/vec2","../../../../core/libs/gl-matrix-2/vec2f64","../../../../core/libs/gl-matrix-2/vec4","../../../../core/libs/gl-matrix-2/math/common","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/aaBoundingRect","./ElevationAligners","./elevationAlignmentUtils","./Graphics3DDrapedGraphicLayer","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolLayer","./polygonUtils","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/RenderGeometry","../../webgl-engine/materials/WaterMaterial","../../webgl-engine/materials/internal/waterMaterialUtils"],(function(e,t,r,a,i,o,n,s,l,u,c,p,d,h,m,y,g,v,f,_,x,b,D,S,E,C,T,G){Object.defineProperty(t,"__esModule",{value:!0});var w=function(e){function t(t,r,a,i){return e.call(this,t,r,a,i)||this}return a(t,e),t.prototype.doLoad=function(){return o(this,void 0,void 0,(function(){return i(this,(function(e){return[2]}))}))},t.prototype.destroy=function(){e.prototype.destroy.call(this),s.isSome(this._material)&&(this._context.stage.remove(3,this._material.id),this._material=null)},t.prototype.createGraphics3DGraphic=function(e){var r=e.graphic;if(!this._validateGeometryType(r.geometry,t.validGeometryTypes,this.symbolLayer.type))return null;if(!this._validateGeometry(r.geometry))return null;var a="graphic"+r.uid,i=this.getGraphicElevationContext(r);return this.ensureDrapedStatus("on-the-ground"===i.mode),this.ensureMaterial(),this.draped?this._createAsOverlay(r,a):this._createAs3DShape(r,i,a,r.uid)},t.prototype.ensureMaterial=function(){if(!s.isSome(this._material)){var e=r({},G.defaultWaterMaterialParameters),a=this.symbolLayer.color;s.isSome(a)&&(e.color=n.toUnitRGBA(a));var i=this._getCombinedOpacity(a,{hasIntrinsicColor:!0});e.color=[e.color[0],e.color[1],e.color[2],i],e.transparent=i<1||this.needsDrivenTransparentPass,e.waveDirection=s.isSome(this.symbolLayer.waveDirection)?t.headingVectorFromAngle(this.symbolLayer.waveDirection):d.vec2f64.fromValues(0,0);var o=this.symbolLayer.waveStrength+"-"+this.symbolLayer.waterbodySize,l=G.wavePresets[o];e.waveStrength=l.waveStrength,e.waveTextureRepeat=l.textureRepeat,e.waveVelocity=l.waveVelocity,e.flowStrength=l.perturbationStrength,e.slicePlaneEnabled=this._context.slicePlaneEnabled,e.isDraped=this.draped,this._material=new T.WaterMaterial(e,"water"),this._context.stage.add(3,this._material)}},t.prototype.layerOpacityChanged=function(){if(s.isNone(this._material))return!0;var e=this._material.getParameters().color,t=this._getCombinedOpacity(this.symbolLayer.color,{hasIntrinsicColor:!0}),r=t<1||this.needsDrivenTransparentPass;return this._material.setParameterValues({color:[e[0],e[1],e[2],t],transparent:r}),!0},t.prototype.layerElevationInfoChanged=function(e,r,a){var i=this._elevationContext.mode,o=f.elevationModeChangeUpdateType(t.elevationModeChangeTypes,a,i);if(o!==f.SymbolUpdateType.UPDATE)return o;var n=f.needsElevationUpdates2D(i);return this.updateGraphics3DGraphicElevationInfo(e,r,(function(){return n}))},t.prototype.slicePlaneEnabledChanged=function(){return s.isSome(this._material)&&this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0},t.prototype.physicalBasedRenderingChanged=function(){return!0},t.prototype.pixelRatioChanged=function(){return!0},t.prototype._createAs3DShape=function(e,t,r,a){var i=D.geometryAsPolygon(e.geometry);if(s.isNone(i))return null;R.renderData=D.geometryToRenderInfo(i,this._context.elevationProvider,this._context.renderCoordsHelper,t);var o=R.renderData.position.length/3;if(R.uvCoords=new Float64Array(2*o),R.idHint=r,R.outNum=0,R.outGeometries=[],R.outTransforms=[],R.outMaterials=[],this._create3DShapeGeometries(R),this._logGeometryCreationWarnings(R.renderData,i.rings,"rings","WaterSymbol3DLayer"),0===R.outNum)return null;this._createUVCoordsFromVertices(R.uvCoords,R.renderData.mapPosition,o,this._context.elevationProvider.spatialReference);var n=new E({geometries:R.outGeometries,materials:R.outMaterials,transformations:R.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:a},idHint:r}),l=v.perVertexElevationAligner,u=new x(this,n,R.outGeometries,null,null,l,t);return u.alignedSampledElevation=R.renderData.sampledElevation,u.needsElevationUpdates=f.needsElevationUpdates2D(t.mode),u},t.prototype._createUVCoordsFromVertices=function(e,r,a,i){var o=l.getMetersPerUnitForSR(i);g.empty(U);for(var n=0;n<a;n++)p.vec2.set(A,r[3*n+0],r[3*n+1]),g.expandPointInPlace(U,A);h.vec4.scale(U,U,o);var s=U[0]%t.unitSizeOfTexture,u=U[1]%t.unitSizeOfTexture;P[0]=U[0]-s,P[1]=U[1]-u;for(n=0;n<a;n++)e[2*n+0]=(r[3*n+0]*o-P[0])/t.unitSizeOfTexture,e[2*n+1]=(r[3*n+1]*o-P[1])/t.unitSizeOfTexture},t.prototype._create3DShapeGeometries=function(e){for(var t=e.renderData.polygons,r=e.uvCoords,a=0,i=t;a<i.length;a++){var o=i[a],n=o.count,l=o.index,p=o.position,d=o.mapPosition,h=o.holeIndices;if(!s.isSome(this._context.clippingExtent)||(y.empty(M),y.expandWithBuffer(M,d),y.intersectsClippingArea(M,this._context.clippingExtent))){var m=u.earcut(d,h,3);if(0!==m.length){var g=new Uint32Array(m),v=new Float64Array(r.buffer,2*l*r.BYTES_PER_ELEMENT,2*n),f=D.createWaterGeometryData({indices:g,attributeData:{position:p,uv0:v,mapPosition:d}}),_=new S(f,e.idHint);e.outGeometries.push(_),e.outMaterials.push(s.expect(this._material)),e.outTransforms.push(c.mat4f64.IDENTITY),e.outNum++}}}},t.prototype._createAsOverlay=function(e,t){var r=D.geometryAsPolygon(e.geometry);if(s.isNone(r))return null;s.expect(this._material).renderPriority=this._renderPriority+this._renderPriorityDelta/2,B.renderData=D.geometryToRenderInfoDraped(r,this._context.overlaySR),B.idHint=t;var a=B.renderData.position.length/3;return B.uvCoords=new Float64Array(2*a),B.outNum=0,B.outGeometries=[],B.outBoundingBox=y.empty(),B.layerUid=this._context.layer.uid,B.graphicsUid=e.uid,this._createAsOverlayWater(B),this._logGeometryCreationWarnings(B.renderData,r.rings,"rings","WaterSymbol3DLayer"),0===B.outNum?null:(this._createUVCoordsFromVertices(B.uvCoords,B.renderData.position,a,r.spatialReference),B.outNum>0?new _(this,B.outGeometries,B.outBoundingBox):null)},t.prototype._createAsOverlayWater=function(e){for(var t=e.uvCoords,r=0,a=e.renderData.polygons;r<a.length;r++){var i=a[r],o=i.position,n=i.holeIndices,l=i.index,c=i.count;if(y.empty(M),y.expandWithBuffer(M,o),y.intersectsClippingArea(M,this._context.clippingExtent)){y.expand(e.outBoundingBox,M);var p=u.earcut(o,n,3);if(0!==p.length){var d=new Uint32Array(p),h=new Float64Array(t.buffer,2*l*t.BYTES_PER_ELEMENT,2*c),m=D.createWaterGeometryData({indices:d,attributeData:{position:o,uv0:h}}),g=new C(m);g.data.layerUid=e.layerUid,g.data.graphicUid=e.graphicsUid,g.material=s.expect(this._material);var v=M;g.center=[.5*(v[0]+v[3]),.5*(v[1]+v[4]),0],g.bsRadius=.5*Math.sqrt((v[3]-v[0])*(v[3]-v[0])+(v[4]-v[1])*(v[4]-v[1])),e.outGeometries.push(g),e.outNum++}}}},t.headingVectorFromAngle=function(e){var t=d.vec2f64.create(),r=m.toRadian(e);return t[0]=Math.sin(r),t[1]=Math.cos(r),t},Object.defineProperty(t.prototype,"test",{get:function(){var e=this;return{create3DShape:function(t){return e._createAs3DShape(t.graphic,t.elevationContext,t.idHint,t.graphicUid)},ensureMaterial:function(){return e.ensureMaterial()}}},enumerable:!0,configurable:!0}),t.validGeometryTypes=["polyline","polygon","extent"],t.unitSizeOfTexture=100,t.elevationModeChangeTypes={definedChanged:f.SymbolUpdateType.RECREATE,staysOnTheGround:f.SymbolUpdateType.NONE,onTheGroundChanged:f.SymbolUpdateType.RECREATE},t}(b.default);t.Graphics3DWaterSymbolLayer=w;var P=d.vec2f64.create(),U=g.create(),A=d.vec2f64.create(),M=y.create(),R={idHint:null,renderData:null,uvCoords:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null},B={idHint:null,renderData:null,uvCoords:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null};t.default=w}));