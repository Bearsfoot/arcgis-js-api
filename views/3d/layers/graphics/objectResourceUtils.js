// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../core/tsSupport/assignHelper","../../../../core/devEnvironmentUtils","../../../../core/maybe","../../../../core/libs/gl-matrix-2/mat3","../../../../core/libs/gl-matrix-2/mat3f64","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../../../geometry/support/aaBoundingBox","../../glTF/DefaultLoadingContext","../../glTF/loader","../../glTF/internal/indexUtils","./wosrLoader","../../support/buffer/BufferView","../../support/buffer/math","../../support/buffer/utils","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryData","../../webgl-engine/lib/Texture","../../webgl-engine/materials/DefaultMaterial"],(function(e,t,r,o,s,i,a,u,n,l,c,m,f,d,g,p,x,v,b,h,B,w,M,S,R,y){function V(e){var t=e.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return t?{fileType:"gltf",url:t[1],specifiedLodIndex:null!=t[4]?Number(t[4]):null}:e.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:e,specifiedLodIndex:null}:{fileType:"unknown",url:e,specifiedLodIndex:null}}function T(e,t,r,o){var s=e.model,a=l.mat3f64.create(),c=new Array,m=new Map,f=new Map;return s.lods.forEach((function(e,l){if(void 0===o||l===o){var d=0,p={name:e.name,stageResources:{textures:new Array,materials:new Array,geometries:new Array},lodThreshold:u.isSome(e.lodThreshold)?e.lodThreshold:null,pivotOffset:[0,0,0],numberOfVertices:0,boundingBox:g.empty()};c.push(p),e.parts.forEach((function(o){var l=o.material+(o.attributes.normal?"_normal":"")+(o.attributes.color?"_color":"")+(o.attributes.texCoord0?"_texCoord0":"")+(o.attributes.tangent?"_tangent":""),c=s.materials.get(o.material),x=u.isSome(o.attributes.texCoord0),b=u.isSome(o.attributes.normal);if(!m.has(l)){if(x){if(u.isSome(c.textureColor)&&!f.has(c.textureColor)){var V=s.textures.get(c.textureColor),T=i({},V.parameters,{preMultiplyAlpha:!0});f.set(c.textureColor,new R(V.data,c.textureColor,T))}if(u.isSome(c.textureNormal)&&!f.has(c.textureNormal)){V=s.textures.get(c.textureNormal),T=i({},V.parameters,{preMultiplyAlpha:!0});f.set(c.textureNormal,new R(V.data,c.textureNormal,T))}if(u.isSome(c.textureOcclusion)&&!f.has(c.textureOcclusion)){V=s.textures.get(c.textureOcclusion),T=i({},V.parameters,{preMultiplyAlpha:!0});f.set(c.textureOcclusion,new R(V.data,c.textureOcclusion,T))}if(u.isSome(c.textureEmissive)&&!f.has(c.textureEmissive)){V=s.textures.get(c.textureEmissive),T=i({},V.parameters,{preMultiplyAlpha:!0});f.set(c.textureEmissive,new R(V.data,c.textureEmissive,T))}if(u.isSome(c.textureMetallicRoughness)&&!f.has(c.textureMetallicRoughness)){V=s.textures.get(c.textureMetallicRoughness),T=i({},V.parameters,{preMultiplyAlpha:!0});f.set(c.textureMetallicRoughness,new R(V.data,c.textureMetallicRoughness,T))}}var E=y.COLOR_GAMMA,O=Math.pow(c.color[0],1/E),A=Math.pow(c.color[1],1/E),F=Math.pow(c.color[2],1/E),I=Math.pow(c.emissiveFactor[0],1/E),L=Math.pow(c.emissiveFactor[1],1/E),N=Math.pow(c.emissiveFactor[2],1/E);m.set(l,new y(i({},t,{transparent:"BLEND"===c.alphaMode,textureAlphaMode:C(c.alphaMode),textureAlphaCutoff:c.alphaCutoff,diffuse:[O,A,F],ambient:[O,A,F],opacity:c.opacity,doubleSided:c.doubleSided,doubleSidedType:"winding-order",cullFace:c.doubleSided?0:2,vertexColors:!!o.attributes.color,vertexTangents:!!o.attributes.tangent,normals:b?"default":"screenDerivative",castShadows:!0,receiveSSAO:!0,textureId:u.isSome(c.textureColor)&&x?f.get(c.textureColor).id:void 0,colorMixMode:c.colorMixMode,normalTextureId:u.isSome(c.textureNormal)&&x?f.get(c.textureNormal).id:void 0,textureAlphaPremultiplied:!0,occlusionTextureId:u.isSome(c.textureOcclusion)&&x?f.get(c.textureOcclusion).id:void 0,emissiveTextureId:u.isSome(c.textureEmissive)&&x?f.get(c.textureEmissive).id:void 0,metallicRoughnessTextureId:u.isSome(c.textureMetallicRoughness)&&x?f.get(c.textureMetallicRoughness).id:void 0,emissiveFactor:[I,L,N],mrrFactors:[c.metallicFactor,c.roughnessFactor,t.mrrFactors[2]],isSchematic:!1},r),l))}var _=function(e,t){switch(t){case 4:return v.trianglesToTriangles(e);case 5:return v.triangleStripToTriangles(e);case 6:return v.triangleFanToTriangles(e)}}(o.indices||o.attributes.position.count,o.primitiveType),D={},z={},P=o.attributes.position.count,G=w.createBuffer(h.BufferViewVec3f,P);if(B.vec3.transformMat4(G,o.attributes.position,o.transform),z.position={data:G.typedBuffer,size:G.elementCount},D.position=_,u.isSome(o.attributes.normal)){var U=w.createBuffer(h.BufferViewVec3f,P);n.mat3.normalFromMat4(a,o.transform),B.vec3.transformMat3(U,o.attributes.normal,a),z.normal={data:U.typedBuffer,size:U.elementCount},D.normal=_}if(u.isSome(o.attributes.tangent)){var j=w.createBuffer(h.BufferViewVec4f,P);n.mat3.normalFromMat4(a,o.transform),B.vec4.transformMat3(j,o.attributes.tangent,a),z.tangent={data:j.typedBuffer,size:j.elementCount},D.tangent=_}if(u.isSome(o.attributes.texCoord0)){var H=w.createBuffer(h.BufferViewVec2f,P);w.vec2.normalizeIntegerBuffer(H,o.attributes.texCoord0),z.uv0={data:H.typedBuffer,size:H.elementCount},D.uv0=_}if(u.isSome(o.attributes.color)){var W=w.createBuffer(h.BufferViewVec4u8,P);if(4===o.attributes.color.elementCount)o.attributes.color instanceof h.BufferViewVec4f?B.vec4.scale(W,o.attributes.color,255):o.attributes.color instanceof h.BufferViewVec4u8?w.vec4.copy(W,o.attributes.color):o.attributes.color instanceof h.BufferViewVec4u16&&B.vec4.scale(W,o.attributes.color,1/256);else{w.vec4.fill(W,255,255,255,255);var q=new h.BufferViewVec3u8(W.buffer,0,4);o.attributes.color instanceof h.BufferViewVec3f?B.vec3.scale(q,o.attributes.color,255):o.attributes.color instanceof h.BufferViewVec3u8?w.vec3.copy(q,o.attributes.color):o.attributes.color instanceof h.BufferViewVec3u16&&B.vec3.scale(q,o.attributes.color,1/256)}z.color={data:W.typedBuffer,size:W.elementCount},D.color=_}var k=new M(new S.GeometryData(z,D),"gltf_"+e.name+"_"+d++);p.stageResources.geometries.push(k),p.stageResources.materials.push(m.get(l)),x&&(u.isSome(c.textureColor)&&p.stageResources.textures.push(f.get(c.textureColor)),u.isSome(c.textureNormal)&&p.stageResources.textures.push(f.get(c.textureNormal)),u.isSome(c.textureOcclusion)&&p.stageResources.textures.push(f.get(c.textureOcclusion)),u.isSome(c.textureEmissive)&&p.stageResources.textures.push(f.get(c.textureEmissive)),u.isSome(c.textureMetallicRoughness)&&p.stageResources.textures.push(f.get(c.textureMetallicRoughness))),p.numberOfVertices+=P;var $=k.boundingInfo;g.expand(p.boundingBox,$.getBBMin()),g.expand(p.boundingBox,$.getBBMax())}))}})),c}function C(e){switch(e){case"BLEND":return"blend";case"MASK":return"mask";case"OPAQUE":return"opaque";default:return"blend"}}Object.defineProperty(t,"__esModule",{value:!0}),t.fetch=function(e,t){return s(this,void 0,void 0,(function(){var r,s,n,l,g,v,B,M,S,R,y,C;return o(this,(function(o){switch(o.label){case 0:return"wosr"!==(r=V(a.adjustStaticAGOUrl(e))).fileType?[3,2]:[4,t.cache?t.cache.loadWOSR(r.url,t):b.load(r.url,t)];case 1:return s=o.sent(),[2,{lods:[n=b.processLoadResult(s,t)],referenceBoundingBox:n.boundingBox,isEsriSymbolResource:!1,isWosr:!0,remove:s.remove}];case 2:return[4,t.cache?t.cache.loadGLTF(r.url,t):x.load(new p.DefaultLoadingContext(t.streamDataRequester),r.url,t)];case 3:return l=o.sent(),g=u.get(l.model.meta,"ESRI_proxyEllipsoid"),l.meta.isEsriSymbolResource&&u.isSome(g)&&-1!==l.meta.uri.indexOf("/RealisticTrees/")&&function(e,t){for(var r=0;r<e.model.lods.length;++r){var o=e.model.lods[r];e.customMeta.esriTreeRendering=!0;for(var s=0,i=o.parts;s<i.length;s++){var a=i[s],n=a.attributes.normal;if(u.isNone(n))return;for(var l=a.attributes.position,g=l.count,p=d.vec3f64.create(),x=d.vec3f64.create(),v=d.vec3f64.create(),b=w.createBuffer(h.BufferViewVec4u8,g),B=w.createBuffer(h.BufferViewVec3f,g),M=c.mat4.invert(m.mat4f64.create(),a.transform),S=0;S<g;S++){l.getVec(S,x),n.getVec(S,p),f.vec3.transformMat4(x,x,a.transform),f.vec3.subtract(v,x,t.center),f.vec3.divide(v,v,t.radius);var R=v[2],y=f.vec3.length(v),V=Math.min(.45+.55*y*y,1);f.vec3.divide(v,v,t.radius),f.vec3.transformMat4(v,v,M),f.vec3.normalize(v,v),r+1!==e.model.lods.length&&e.model.lods.length>1&&(R>-1?f.vec3.lerp(v,v,p,.2):f.vec3.lerp(v,v,p,Math.min(-4*R-3.8,1))),B.setVec(S,v),b.set(S,0,255*V),b.set(S,1,255*V),b.set(S,2,255*V),b.set(S,3,255)}a.attributes.normal=B,a.attributes.color=b}}}(l,g),v=l.meta.isEsriSymbolResource?{usePBR:t.usePBR,isSchematic:!1,treeRendering:l.customMeta.esriTreeRendering,mrrFactors:[0,1,.2]}:{usePBR:!0,isSchematic:!1,mrrFactors:[0,1,.5]},B=i({},t.materialParamsMixin,{treeRendering:l.customMeta.esriTreeRendering}),null!=r.specifiedLodIndex?(M=T(l,v,B,r.specifiedLodIndex),S=M[0].boundingBox,0!==r.specifiedLodIndex&&(R=T(l,v,B,0),S=R[0].boundingBox),[2,{lods:M,referenceBoundingBox:S,isEsriSymbolResource:l.meta.isEsriSymbolResource,isWosr:!1,remove:l.remove}]):(y=T(l,v,B),C=y[0].boundingBox,[2,{lods:y,referenceBoundingBox:C,isEsriSymbolResource:l.meta.isEsriSymbolResource,isWosr:!1,remove:l.remove}])}}))}))},t.parseUrl=V,t.gltfToEngineResources=T}));