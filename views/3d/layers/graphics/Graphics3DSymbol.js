// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../core/asyncUtils","../../../../core/maybe","../../../../core/promiseUtils","./Graphics3DGraphic","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolLayerFactory","./Loadable","./symbolComplexity"],(function(e,r,t,o,s,a,i,n,y,l,c,h,u){var p=function(e){function r(r,t,o){var s=e.call(this)||this;return s._symbol=r,s._context=t,s._backgroundLayers=o,s._destroyed=!1,s.symbolLayers=[],s.referenced=0,s}return t(r,e),Object.defineProperty(r.prototype,"symbol",{get:function(){return this._symbol},set:function(e){if(this._symbol=e,this.symbolLayers)for(var r=0;r<e.symbolLayers.length;r++){var t=this.symbolLayers[r];i.isNone(t)||(t.symbol=e,t.symbolLayer=e.symbolLayers.items[r])}},enumerable:!0,configurable:!0}),r.prototype.doLoad=function(e){return s(this,void 0,void 0,(function(){var r,t,y,l,h,u=this;return o(this,(function(p){switch(p.label){case 0:for(r=this._symbol.symbolLayers,this._backgroundLayers&&(r=this._backgroundLayers.concat(r)),t=r.length;this.symbolLayers.length<r.length;)this.symbolLayers.push(null);for(this.symbolLayers.length=r.length,y=function(o){var s=r.getItemAt(o);if(!1===s.enabled)return"continue";f.renderPriority=1-(1+o)/t,f.renderPriorityStep=1/t,f.ignoreDrivers=s._ignoreDrivers;var a=c.make(l.symbol,s,l._context,f);n.onAbortOrThrow(e,(function(){u.symbolLayers[o]=null,a.destroy()})),l.symbolLayers[o]=a},l=this,h=0;h<t;h++)y(h);return[4,a.forEach(this.symbolLayers,(function(e,r){return s(u,void 0,void 0,(function(){return o(this,(function(t){switch(t.label){case 0:if(!i.isSome(e))return[3,4];t.label=1;case 1:return t.trys.push([1,3,,4]),[4,e.load()];case 2:return t.sent(),[3,4];case 3:return t.sent(),this.symbolLayers[r]=null,[3,4];case 4:return[2]}}))}))}))];case 1:if(p.sent(),n.throwIfAborted(e),this.symbolLayers.length&&!this.symbolLayers.some((function(e){return!!e})))throw new Error;return[2]}}))}))},r.prototype.getSymbolLayerSize=function(e){var r=this.symbolLayers[e];return i.isSome(r)?r.getCachedSize():null},r.prototype.createGraphics3DGraphic=function(e,r){for(var t=e.graphic,o=new Array(this.symbolLayers.length),s=0;s<this.symbolLayers.length;s++){var a=this.symbolLayers[s];o[s]=i.isSome(a)?a.createGraphics3DGraphic(e):null}var n=this._context.arcade||this._context.featureExpressionInfoContext&&this._context.featureExpressionInfoContext.arcade&&this._context.featureExpressionInfoContext.arcade.modules||null;return new y(t,r||this,o,e.layer,n)},Object.defineProperty(r.prototype,"complexity",{get:function(){return u.totalSymbolComplexities(this.symbolLayers.map((function(e){return i.isSome(e)&&e.complexity})))},enumerable:!0,configurable:!0}),r.prototype.globalPropertyChanged=function(e,r){for(var t=this.symbolLayers.length,o=function(t){var o=s.symbolLayers[t];if(i.isSome(o)&&!o.globalPropertyChanged(e,r,(function(e){var r=e._graphics[t];return r instanceof l?r:null})))return{value:!1}},s=this,a=0;a<t;a++){var n=o(a);if("object"==typeof n)return n.value}return!0},r.prototype.applyRendererDiff=function(e,r){return 1===this.loadStatus&&this.symbolLayers.reduce((function(t,o){return t&&(i.isNone(o)||o.applyRendererDiff(e,r))}),!0)},r.prototype.prepareSymbolPatch=function(e){if(2!==this.loadStatus&&"partial"===e.diff.type){var r=e.diff.diff;if(r.symbolLayers&&"partial"===r.symbolLayers.type){var t=r.symbolLayers.diff;this.symbolLayers.forEach((function(r,o){var s;if(!i.isNone(r)){var a=t[o];if(a){var n={diff:a,graphics3DGraphicPatches:[],symbolLayerStatePatches:[]};r.prepareSymbolLayerPatch(n),(s=e.symbolStatePatches).push.apply(s,n.symbolLayerStatePatches),n.graphics3DGraphicPatches.length&&e.graphics3DGraphicPatches.push((function(e,r){var t=e._graphics[o];i.isSome(t)&&n.graphics3DGraphicPatches.forEach((function(e){return e(t,r)}))}))}}}))}}},r.prototype.updateGeometry=function(e,r){for(var t=0;t<this.symbolLayers.length;t++){var o=this.symbolLayers[t];if(!i.isNone(o)){var s=e._graphics[t];if(i.isSome(s)&&!o.updateGeometry(s,r))return!1}}return!0},r.prototype.onRemoveGraphic=function(e){for(var r=0;r<this.symbolLayers.length;r++){var t=this.symbolLayers[r];if(!i.isNone(t)){var o=e._graphics[r];i.isSome(o)&&t.onRemoveGraphic(o)}}},r.prototype.getFastUpdateStatus=function(){var e=0,r=0,t=0;return this.symbolLayers.forEach((function(o){i.isNone(o)||(0===o.loadStatus?e++:o.isFastUpdatesEnabled()?t++:r++)})),{loading:e,slow:r,fast:t}},r.prototype.destroy=function(){if(this.destroyed)console.error("Graphics3DSymbol.destroy called when already destroyed!");else{this.abortLoad();for(var e=0,r=this.symbolLayers;e<r.length;e++){var t=r[e];i.isSome(t)&&t.destroy()}this.symbolLayers.length=0,this._destroyed=!0}},Object.defineProperty(r.prototype,"destroyed",{get:function(){return this._destroyed},enumerable:!0,configurable:!0}),r}(h.Loadable),f={renderPriority:0,renderPriorityStep:1,ignoreDrivers:!1};return p}));