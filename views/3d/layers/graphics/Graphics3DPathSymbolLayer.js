// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/tsSupport/assignHelper","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../core/Error","../../../../core/lang","../../../../core/mathUtils","../../../../core/maybe","../../../../core/libs/gl-matrix-2/mat2","../../../../core/libs/gl-matrix-2/vec2","../../../../core/libs/gl-matrix-2/vec2f64","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f32","../../../../core/libs/gl-matrix-2/vec3f64","../../../../geometry/support/aaBoundingBox","../../../../layers/graphics/dehydratedFeatures","./elevationAlignmentUtils","./elevationAlignmentUtils","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolLayer","./graphicUtils","../support/FastSymbolUpdates","../../support/projectionUtils","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/pathGeometryUtils","../../webgl-engine/materials/DefaultMaterial","../../webgl-engine/materials/PathMaterial"],(function(e,t,a,r,i,s,o,n,l,c,h,p,d,u,m,v,f,y,g,_,b,S,x,D,w,R,P,U,C,V){Object.defineProperty(t,"__esModule",{value:!0});var E=function(e){function r(t,a,r,i){var s=e.call(this,t,a,r,i)||this;return s._intrinsicSize=d.vec2f64.fromValues(1,1),s.upVectorAlignment="path",s.stencilWidth=.1,s.ensureDrapedStatus(!1),s}return a(r,e),r.prototype.doLoad=function(){return s(this,void 0,void 0,(function(){var e,a,r,s,l,h,d,u,m,f,y,g,_;return i(this,(function(i){switch(e=c.isSome(this.symbolLayer.width)?this.symbolLayer.width:c.isSome(this.symbolLayer.height)?this.symbolLayer.height:this.symbolLayer.size,a=c.isSome(this.symbolLayer.height)?this.symbolLayer.height:e,this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[e,1,a],unitInMeters:this._context.renderCoordsHelper.unitInMeters,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}},this._context.renderer&&this._context.renderer.visualVariables&&this._context.renderer.visualVariables.length>0?this._fastUpdates=D.initFastSymbolUpdatesState(this._context.renderer,this._vvConvertOptions):this._fastUpdates={enabled:!1},r=this.symbolLayer.anchor||"center",this.upVectorAlignment="path","heading"===this.symbolLayer.profileRotation&&(this.upVectorAlignment="world"),s=this.symbolLayer.profile||"circle"){case"circle":default:this._profile=U.Profile.circle(t.NUM_CIRCLE_PROFILE_SUBDIVISIONS);break;case"quad":this._profile=U.Profile.rect()}switch(l=[0,0],"center"!==r&&(l={left:[.5,0],right:[-.5,0],top:[0,-.5],bottom:[0,.5]}[r],this._profile.translate(l[0],l[1])),this.symbolLayer.join||"simple"){case"round":this._extruder=new U.MiterExtruder(0,t.NUM_ROUND_JOIN_SUBDIVISIONS);break;case"bevel":this._extruder=new U.MiterExtruder(0,1);break;case"miter":this._extruder=new U.MiterExtruder(.8*Math.PI,1);break;case"simple":default:this._extruder=new U.SimpleExtruder}switch(h=this.symbolLayer.cap||"butt"){case"none":this._startCap=new U.NoCapBuilder,this._endCap=new U.NoCapBuilder;break;case"butt":default:this._startCap=new U.TriangulationCapBuilder(this._profile,0),this._endCap=new U.TriangulationCapBuilder(this._profile,0,!0);break;case"square":this._startCap=new U.TriangulationCapBuilder(this._profile,-.5),this._endCap=new U.TriangulationCapBuilder(this._profile,.5,!0);break;case"round":d="quad"===s,this._startCap=new U.RoundCapBuilder({profile:this._profile,flip:!1,breakNormals:d,subdivisions:t.NUM_ROUND_CAP_EXTRUSION_SUBDIVISIONS}),this._endCap=new U.RoundCapBuilder({profile:this._profile,flip:!0,breakNormals:d,subdivisions:t.NUM_ROUND_CAP_EXTRUSION_SUBDIVISIONS})}if(u=this._getIdHint(),m=c.get(this.symbolLayer,"material","color"),f=this._getCombinedOpacityAndColor(m),y=v.vec3f64.fromArray(f),g=f[3],_={diffuse:y,ambient:y,opacity:g,transparent:g<1||this.needsDrivenTransparentPass,vertexColors:!1,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,cullFace:"none"===h?0:void 0,offsetTransparentBackfaces:!0},!this._drivenProperties.size&&(p.vec2.set(this._intrinsicSize,e,a),!x.isValidSize(this._intrinsicSize[0])||!x.isValidSize(this._intrinsicSize[1])))throw new o("graphics3dpathsymbollayer:invalid-size","Symbol sizes may not be negative values");return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size||p.vec2.scale(this._intrinsicSize,this._intrinsicSize,1/this._context.renderCoordsHelper.unitInMeters),this._fastUpdates.enabled?(n.mixin(_,this._fastUpdates.materialParameters,{size:[this._intrinsicSize[0],this._intrinsicSize[1],0]}),this._material=new V(_,u+"_pathmat")):(_.vertexColors=this._drivenProperties.color||this._drivenProperties.opacity,this._material=new C(_,u+"_pathmat")),this._material.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),this._context.stage.add(3,this._material),[2]}))}))},r.prototype.destroy=function(){e.prototype.destroy.call(this),this._material&&(this._context.stage.remove(3,this._material.id),this._material=null)},r.prototype.createGraphics3DGraphic=function(e){var t=e.graphic;if(!this._validateGeometryType(t.geometry,r.validGeometryTypes,this.symbolLayer.type))return null;if(!this._validateGeometry(t.geometry))return null;var a="graphic"+t.uid,i=this.getGraphicElevationContext(t),s=e.renderingInfo;return this._createAs3DShape(t,s,i,a,t.uid)},r.prototype.layerOpacityChanged=function(){var e=c.get(this.symbolLayer,"material","color"),t=this._getCombinedOpacity(e),a=t<1||this.needsDrivenTransparentPass;return this._material.setParameterValues({opacity:t,transparent:a}),!0},r.prototype.layerElevationInfoChanged=function(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,_.needsElevationUpdates3D)},r.prototype.slicePlaneEnabledChanged=function(){return this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0},r.prototype.physicalBasedRenderingChanged=function(){return this._material.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0},r.prototype.pixelRatioChanged=function(){return!0},r.prototype.applyRendererDiff=function(e,t){for(var a in e.diff)switch(a){case"visualVariables":if(!D.updateFastSymbolUpdatesState(this._fastUpdates,t,this._vvConvertOptions))return!1;this._material.setParameterValues(this._fastUpdates.materialParameters);break;default:return!1}return!0},r.prototype.getVertexData=function(e){for(var t=0,a=e.paths,r=[],i=e.spatialReference,s=this._context.elevationProvider.spatialReference,o=this._context.renderCoordsHelper.spatialReference,n=0,l=a;n<l.length;n++){t+=(v=l[n]).length}for(var c=new Float64Array(3*t),h=new Float64Array(3*t),p=new Float64Array(3*t),d=0,u=0,m=a;u<m.length;u++){var v=m[u];r.push({index:d,numVertices:v.length});for(var f=0,y=v;f<y.length;f++){var g=y[f];c[d++]=g[0],c[d++]=g[1],c[d++]=e.hasZ?g[2]:0}}var _=!0;return i.equals(s)?this._copyVertices(c,0,h,0,t):_=w.bufferToBuffer(c,i,0,h,s,0,t),s.equals(o)?this._copyVertices(h,0,p,0,t):w.bufferToBuffer(h,s,0,p,o,0,t),{pathVertexDataInfos:r,vertexDataGS:c,vertexDataES:h,vertexDataRS:p,projectionSuccess:_,terrainElevation:0}},r.prototype._copyVertices=function(e,t,a,r,i){t*=3,r*=3;for(var s=0;s<i;++s)a[r++]=e[t++],a[r++]=e[t++],a[r++]=e[t++]},r.prototype._createAs3DShape=function(e,t,a,r,i){var s=e.geometry,o=[],n=[],l=[],h=s.spatialReference,p=this._context.elevationProvider.spatialReference,d=f.create(),m=this._context.renderCoordsHelper;N.spatialReference=h,B.spatialReference=p;var v=this.getVertexData(s);if(!v.projectionSuccess)return this.logger.warn("PathSymbol3DLayer geometry failed to be created (failed to project geometry to view spatial reference)"),null;if(v.pathVertexDataInfos.length>0){for(var y=0;y<v.pathVertexDataInfos.length;++y){var x=v.pathVertexDataInfos[y],D=x.index,w=x.numVertices;if(w<2)this.logger.warn("PathSymbol3DLayer geometry failed to be created (paths should contain at least 2 vertices)");else if(!c.isSome(this._context.clippingExtent)||(f.empty(d),f.expandWithBuffer(d,v.vertexDataES,3*D,w),f.intersectsClippingArea(d,this._context.clippingExtent))){for(var C=[],V=D;V<D+3*w;){var E=V++,L=V++,O=V++,M=new U.PathVertex;u.vec3.set(M.posGS,v.vertexDataGS[E],v.vertexDataGS[L],v.vertexDataGS[O]),u.vec3.set(M.posES,v.vertexDataES[E],v.vertexDataES[L],v.vertexDataES[O]),B.x=M.posES[0],B.y=M.posES[1],B.z=M.posES[2];var F=g.evaluateElevationAlignmentAtPoint(B,this._context.elevationProvider,a,m,null);u.vec3.set(G,v.vertexDataRS[E],v.vertexDataRS[L],v.vertexDataRS[O]),m.setAltitude(F,G),u.vec3.set(M.pos,G[0],G[1],G[2]),C.push(M)}var T=new U.Path(C);I(T,this.upVectorAlignment,this._context.renderCoordsHelper);var k=new U.Builder(T,this._profile,this._extruder,this._startCap,this._endCap),H=null;if(this._fastUpdates.enabled){var j=this._fastUpdates.visualVariables,q=j.size?S.getAttributeValue(j.size.field,e):0,W=j.color?S.getAttributeValue(j.color.field,e):0,X=j.opacity?S.getAttributeValue(j.opacity.field,e):0;H=new U.FastUpdatePathGeometry(k,q,W,X)}else{var J=[this._intrinsicSize[0],this._intrinsicSize[1]];this._drivenProperties.size&&(J[0]*=A(t.size[0],"symbol-value"===t.size[2]?this.symbolLayer.height||0:t.size[2],this.symbolLayer.width||0),J[1]*=A(t.size[2],"symbol-value"===t.size[0]?this.symbolLayer.width||0:t.size[0],this.symbolLayer.height||0));var Z=null;this._drivenProperties.color&&(Z=t.color),this._drivenProperties.opacity&&null!=t.opacity&&(Z=Z?[Z[0],Z[1],Z[2],t.opacity]:[1,1,1,t.opacity]);var K=new U.StaticPathGeometry(k);K.bake(J),Z&&K.bakeVertexColors(Z),H=K}var Q=H.createGeometryData(),Y=new R(Q,r+"path"+y),$={pathGeometry:H,geometrySR:h,upVectorAlignment:this.upVectorAlignment,stencilWidth:this.stencilWidth};Y.metadata=$,o.push(Y),n.push(this._material),l.push(H.xform)}}var ee={layerUid:this._context.layer.uid,graphicUid:i};if(o.length>0){var te=new P({geometries:o,materials:n,transformations:l,castShadow:!0,metadata:ee,idHint:r}),ae=new b(this,te,o,null,null,z,a);return ae.alignedSampledElevation=v.terrainElevation,ae.needsElevationUpdates=_.needsElevationUpdates3D(a.mode),ae}}else this.logger.warn("PathSymbol3DLayer geometry failed to be created (no paths were defined)");return null},r.validGeometryTypes=["polyline"],r}(S.Graphics3DSymbolLayer);function I(e,t,a){switch(t){case"world":for(var r=0,i=e.vertices;r<i.length;r++){var s=i[r];u.vec3.add(M,s.pos,e.offset),a.worldUpAtPosition(M,G),s.setFrameFromUpVector(G),s.computeRotationAxisAndAngleFromUpVector()}break;case"path":u.vec3.add(M,e.vertices[0].pos,e.offset),a.worldUpAtPosition(M,G),U.computeMinimumRotationTangentFrame(e,G);for(var o=0,n=e.vertices;o<n.length;o++){s=n[o];var c=l.sign(u.vec3.dot(s.frame.right,s.vRight));u.vec3.cross(s.rotationFrame.up,s.vRight,s.vLeft),u.vec3.scale(s.rotationFrame.up,s.rotationFrame.up,c),u.vec3.normalize(s.rotationFrame.up,s.rotationFrame.up);var p=u.vec3.dot(s.rotationFrame.up,s.frame.up),d=u.vec3.dot(s.rotationFrame.up,s.frame.right);if(u.vec3.scale(M,s.frame.up,-d),u.vec3.scale(F,s.frame.right,p),u.vec3.add(M,M,F),u.vec3.normalize(s.rotationFrame.right,M),U.vertexSpaceToProfileSpace(s.rotationRight,s.frame,s.rotationFrame.right),u.vec3.negate(M,s.vLeft),s.rotationAngle=-c*(Math.PI-l.acosClamped(u.vec3.dot(M,s.vRight))),Math.abs(s.rotationAngle)>0){var m=l.reciprocalClamped(Math.cos(.5*s.rotationAngle));h.mat2.set(s.miterStretch,1+(m-1)*s.rotationRight[0]*s.rotationRight[0],(m-1)*s.rotationRight[0]*s.rotationRight[1],(m-1)*s.rotationRight[0]*s.rotationRight[1],1+(m-1)*s.rotationRight[1]*s.rotationRight[1])}var v=Math.PI-s.rotationAngle;s.maxStretchDistance=Math.abs(Math.min(s.vLeftLength,s.vRightLength)*l.reciprocalClamped(Math.cos(.5*v)))}}}function A(e,t,a){switch(e){case"symbol-value":return a;case"proportional":return t;default:return e}}function L(e,t,a,r){for(var i=0,s=0,o=e.vertices;s<o.length;s++){var n=o[s];B.x=n.posES[0],B.y=n.posES[1],B.z=n.posES[2];var l=g.evaluateElevationAlignmentAtPoint(B,a,t,r,T);i+=T.sampledElevation,u.vec3.add(G,n.pos,e.offset),r.setAltitude(l,G),u.vec3.subtract(n.pos,G,e.offset)}return e.updatePathVertexInformation(),i/e.vertices.length}function z(e,t,a,r){var i=e.stageObject,s=i.geometryRecords,o=s.length,n=0;B.spatialReference=a.spatialReference,O.spatialReference=r.spatialReference;for(var l=0;l<o;l++){var c=s[l].geometry,h=c.metadata,p=h.pathGeometry,d=p.builder.path,u=h.geometrySR;N.spatialReference=u,n+=L(d,t,a,r),"world"!==d.upVector&&I(d,h.upVectorAlignment,r),p.onPathChanged(),c.invalidateBoundingInfo(),i.geometryVertexAttrsUpdated(l)}return n/o}t.Graphics3DPathSymbolLayer=E;var O=y.makeDehydratedPoint(0,0,0,null),B=y.makeDehydratedPoint(0,0,0,null),N=y.makeDehydratedPoint(0,0,0,null),G=v.vec3f64.create(),M=m.vec3f32.create(),F=m.vec3f32.create();t.NUM_ROUND_JOIN_SUBDIVISIONS=3,t.NUM_ROUND_CAP_EXTRUSION_SUBDIVISIONS=3,t.NUM_CIRCLE_PROFILE_SUBDIVISIONS=10;var T={verticalDistanceToGround:0,sampledElevation:0};t.default=E}));