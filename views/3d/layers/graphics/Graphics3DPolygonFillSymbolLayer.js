// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../Color","../../../../Color","../../../../core/maybe","../../../../core/screenUtils","../../../../core/libs/earcut/earcut","../../../../core/libs/gl-matrix-2/mat4f64","../../../../geometry/support/aaBoundingBox","./ElevationAligners","./elevationAlignmentUtils","./Graphics3DDrapedGraphicLayer","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolLayer","./graphicUtils","./lineUtils","./polygonUtils","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/RenderGeometry","../../webgl-engine/lib/Util","../../webgl-engine/materials/ColorMaterial","../../webgl-engine/materials/lineStippleUtils","../../webgl-engine/materials/NativeLineMaterial","../../webgl-engine/materials/RibbonLineMaterial"],(function(e,t,i,r,a,n,o,l,s,u,p,c,h,d,m,y,g,_,f,v,b,x,O,D,S,C,P,E){Object.defineProperty(t,"__esModule",{value:!0});var A=function(e){function t(t,i,r,a){var n=e.call(this,t,i,r,a)||this;return n._hasOutline=!1,n}return i(t,e),t.prototype.doLoad=function(){return a(this,void 0,void 0,(function(){return r(this,(function(e){return[2]}))}))},t.prototype.ensureMaterials=function(){this.ensureFillMaterial(),this.ensureOutlineMaterial()},t.prototype.ensureFillMaterial=function(){if(!l.isSome(this._material)){var e=l.get(this.symbolLayer,"material","color"),t=this._getCombinedOpacityAndColor(e);this._material=new S({color:t,transparent:t[3]<1||this.needsDrivenTransparentPass,polygonOffset:!1,vertexColors:!0,slicePlaneEnabled:this._context.slicePlaneEnabled},this._getIdHint("_colormat")),this._context.stage.add(3,this._material)}},t.prototype.ensureOutlineMaterial=function(){var e=this,t=this.symbolLayer.outline;if(!l.isSome(this._outlineMaterial)&&this._isValidOutline(t)){this._hasOutline=!0;var i,r,a;this._outlineMaterial=(i=s.pt2px(t.size),r=t.stipplePattern?C.createStipplePattern(t.stipplePattern.map(s.pt2px)):null,a=t.stippleOffColor?o.toUnitRGBA(t.stippleOffColor):null,i>1.5?new E({width:i,color:e._getOutlineColor(),polygonOffset:!0,slicePlaneEnabled:e._context.slicePlaneEnabled,isClosed:!0,stipplePattern:r,stippleIntegerRepeats:!0,stippleOffColor:a},e._getIdHint("_outline_ribbonlinemat")):new P({color:e._getOutlineColor(),slicePlaneEnabled:e._context.slicePlaneEnabled,width:i,stipplePattern:r,stippleIntegerRepeats:!0,stippleOffColor:a},e._getIdHint("_outline_nativelinemat"))),this._context.stage.add(3,this._outlineMaterial)}},t.prototype._isValidOutline=function(e){return l.isSome(e)&&e.size&&e.size>0&&l.isSome(e.color)},t.prototype.destroy=function(){e.prototype.destroy.call(this),l.isSome(this._material)&&(this._context.stage.remove(3,this._material.id),this._material=null),l.isSome(this._outlineMaterial)&&(this._context.stage.remove(3,this._outlineMaterial.id),this._outlineMaterial=null)},t.prototype.createGraphics3DGraphic=function(e){var i=e.graphic;if(!this._validateGeometryType(i.geometry,t.validGeometryTypes,this.symbolLayer.type))return null;if(!this._validateGeometry(i.geometry))return null;var r="graphic"+i.uid,a=this._getVertexOpacityAndColor(e.renderingInfo,Uint8Array,255),n=this.getGraphicElevationContext(i);return this.ensureDrapedStatus("on-the-ground"===n.mode),this.ensureMaterials(),this.draped?this._createAsOverlay(i,a,r):this._createAs3DShape(i,a,n,r)},t.prototype.layerOpacityChanged=function(){if(l.isSome(this._material)){var e=this._material.getParameters().color,t=l.get(this.symbolLayer,"material","color"),i=this._getCombinedOpacity(t);this._material.setParameterValues({color:[e[0],e[1],e[2],i],transparent:i<1||this.needsDrivenTransparentPass})}if(l.isSome(this._outlineMaterial)){var r=this._outlineMaterial.getParameters().color;this._outlineMaterial.setParameterValues({color:[r[0],r[1],r[2],this._getOutlineOpacity()]})}return!0},t.prototype.layerElevationInfoChanged=function(e,i,r){var a=this._elevationContext.mode,n=d.elevationModeChangeUpdateType(t.elevationModeChangeTypes,r,a);if(n!==d.SymbolUpdateType.UPDATE)return n;var o=d.needsElevationUpdates2D(a);return this.updateGraphics3DGraphicElevationInfo(e,i,(function(){return o}))},t.prototype.slicePlaneEnabledChanged=function(){if(l.isSome(this._material)&&this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),l.isSome(this._outlineMaterial)){var e={slicePlaneEnabled:this._context.slicePlaneEnabled};this._outlineMaterial.setParameterValues(e)}return!0},t.prototype.physicalBasedRenderingChanged=function(){return!0},t.prototype.pixelRatioChanged=function(){return!0},t.prototype._createAs3DShape=function(e,t,i,r){var a=v.geometryAsPolygon(e.geometry);if(l.isNone(a))return null;if(M.renderData=v.geometryToRenderInfo(a,this._context.elevationProvider,this._context.renderCoordsHelper,i),M.idHint=r,M.color=t,M.outNum=0,M.outGeometries=[],M.outTransforms=[],M.outMaterials=[],this._createAs3DShapeFill(M),this._hasOutline&&this._createAs3DShapeOutline(M),this._logGeometryCreationWarnings(M.renderData,a.rings,"rings","FillSymbol3DLayer"),0===M.outNum)return null;var n=new x({geometries:M.outGeometries,materials:M.outMaterials,transformations:M.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:e.uid},idHint:r}),o=h.perVertexElevationAligner,s=new y(this,n,M.outGeometries,null,null,o,i);return s.alignedSampledElevation=M.renderData.sampledElevation,s.needsElevationUpdates=d.needsElevationUpdates2D(i.mode),s},t.prototype._createAs3DShapeFill=function(e){for(var t=e.renderData.polygons,i=0;i<t.length;++i){var r=t[i],a=r.position,n=r.mapPosition,o=r.holeIndices;if(!l.isSome(this._context.clippingExtent)||(c.empty(G),c.expandWithBuffer(G,n),c.intersectsClippingArea(G,this._context.clippingExtent))){var s=u.earcut(n,o,3);if(0!==s.length){var h=new Uint32Array(s),d=v.createColorGeometryData({indices:h,attributeData:{position:a,color:e.color,mapPosition:n}}),m=new b(d,e.idHint);e.outGeometries.push(m),e.outMaterials.push(l.expect(this._material)),e.outTransforms.push(p.mat4f64.IDENTITY),e.outNum++}}}},t.prototype._createAs3DShapeOutline=function(e){if(this._hasOutline)for(var t=e.renderData.outlines,i=this._outlineMaterial instanceof P,r=0;r<t.length;++r){var a=t[r],n=a.mapPosition,o=a.position;if(!l.isSome(this._context.clippingExtent)||(c.empty(G),c.expandWithBuffer(G,n),c.intersectsClippingArea(G,this._context.clippingExtent))){var s=f.createGeometryData({removeDuplicateStartEnd:i?0:1,attributeData:{position:o,mapPosition:n}}),u=s.vertexAttributes[D.VertexAttrConstants.POSITION];u.data===o&&(u.data=new Float64Array(o));var h=new b(s,e.idHint+"outline"+r);e.outGeometries.push(h),e.outMaterials.push(l.expect(this._outlineMaterial)),e.outTransforms.push(p.mat4f64.IDENTITY),e.outNum++}}},t.prototype._createAsOverlay=function(e,t,i){var r=v.geometryAsPolygon(e.geometry);return l.isNone(r)?null:(l.expect(this._material).renderPriority=this._renderPriority+this._renderPriorityDelta/2,l.isSome(this._outlineMaterial)&&(this._outlineMaterial.renderPriority=this._renderPriority),U.renderData=v.geometryToRenderInfoDraped(r,this._context.overlaySR),U.idHint=i,U.color=t,U.outNum=0,U.outGeometries=[],U.outBoundingBox=c.empty(),U.layerUid=this._context.layer.uid,U.graphicsUid=e.uid,this._createAsOverlayFill(U),this._hasOutline&&this._createAsOverlayOutline(U),this._logGeometryCreationWarnings(U.renderData,r.rings,"rings","FillSymbol3DLayer"),U.outNum>0?new m(this,U.outGeometries,U.outBoundingBox):null)},t.prototype._createAsOverlayFill=function(e){for(var t=e.renderData.polygons,i=0;i<t.length;++i){var r=t[i],a=r.position,n=r.holeIndices;if(c.empty(G),c.expandWithBuffer(G,a),c.intersectsClippingArea(G,this._context.clippingExtent)){var o=u.earcut(a,n,3);if(0!==o.length){c.expand(e.outBoundingBox,G);var s=new Uint32Array(o),p=v.createColorGeometryData({indices:s,attributeData:{position:a,color:e.color}}),h=new O(p);h.data.layerUid=e.layerUid,h.data.graphicUid=e.graphicsUid,h.material=l.expect(this._material);var d=G;h.center=[.5*(d[0]+d[3]),.5*(d[1]+d[4]),0],h.bsRadius=.5*Math.sqrt((d[3]-d[0])*(d[3]-d[0])+(d[4]-d[1])*(d[4]-d[1])),e.outGeometries.push(h),e.outNum++}}}},t.prototype._createAsOverlayOutline=function(e){if(this._hasOutline)for(var t=e.renderData.outlines,i=0;i<t.length;++i){var r=t[i].position;if(c.empty(G),c.expandWithBuffer(G,r),c.intersectsClippingArea(G,this._context.clippingExtent)){c.expand(e.outBoundingBox,G);var a=this._outlineMaterial instanceof P,n=f.createGeometryData({removeDuplicateStartEnd:a?0:1,attributeData:{position:r}}),o=new O(n);o.data.layerUid=e.layerUid,o.data.graphicUid=e.graphicsUid,o.material=l.expect(this._outlineMaterial);var s=G;o.center=[.5*(s[0]+s[3]),.5*(s[1]+s[4]),0],o.bsRadius=.5*Math.sqrt((s[3]-s[0])*(s[3]-s[0])+(s[4]-s[1])*(s[4]-s[1])),e.outGeometries.push(o),e.outNum++}}},t.prototype._getOutlineOpacity=function(){var e=l.get(this.symbolLayer,"outline","color");return(this.draped?1:this._getLayerOpacity())*(l.isSome(e)?e.a:0)},t.prototype._getOutlineColor=function(){var e=l.get(this.symbolLayer,"outline","color"),t=this._getOutlineOpacity();return _.mixinColorAndOpacity(l.isSome(e)?n.toUnitRGB(e):null,t)},Object.defineProperty(t.prototype,"test",{get:function(){var e=this;return{createAsOverlay:function(t,i,r){return e._createAsOverlay(t,i,r)},createAs3DShape:function(t,i,r,a){return e._createAs3DShape(t,i,r,a)}}},enumerable:!0,configurable:!0}),t.validGeometryTypes=["polyline","polygon","extent"],t.elevationModeChangeTypes={definedChanged:d.SymbolUpdateType.RECREATE,staysOnTheGround:d.SymbolUpdateType.NONE,onTheGroundChanged:d.SymbolUpdateType.RECREATE},t}(g.default);t.Graphics3DPolygonFillSymbolLayer=A;var G=c.create(),M={idHint:null,renderData:null,color:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null},U={idHint:null,renderData:null,color:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null};t.default=A}));