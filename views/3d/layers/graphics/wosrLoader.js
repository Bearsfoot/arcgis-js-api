// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../request","../../../../core/asyncUtils","../../../../core/Error","../../../../core/lang","../../../../core/Logger","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/Version","../../../../core/libs/gl-matrix-2/vec3f64","../../../../geometry/support/aaBoundingBox","../../support/imageUtils","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryData","../../webgl-engine/lib/Texture","../../webgl-engine/materials/DefaultMaterial"],(function(e,r,t,a,n,i,s,o,u,l,c,p,d,f,v,m,g,x,y,h){Object.defineProperty(r,"__esModule",{value:!0});var b=l.getLogger("esri.views.3d.layers.graphics.objectResourceUtils");function w(e,r){return n(this,void 0,void 0,(function(){var t,n;return a(this,(function(a){switch(a.label){case 0:return(t=c.isSome(r)&&r.streamDataRequester)?[2,A(e,t,r)]:[4,s.result(i(e,c.unwrap(r)))];case 1:return!0===(n=a.sent()).ok?[2,n.value.data]:(p.throwIfAbortError(n.error),U(n.error),[2,void 0])}}))}))}function A(e,r,t){return n(this,void 0,void 0,(function(){var n;return a(this,(function(a){switch(a.label){case 0:return[4,s.result(r.request(e,"json",t))];case 1:return!0===(n=a.sent()).ok?[2,n.value]:(p.throwIfAbortError(n.error),U(n.error.details.url),[2,void 0])}}))}))}function U(e){throw new o("","Request for object resource failed: "+e)}function I(e){var r=e.params,t=r.topology,a=!0;switch(r.vertexAttributes||(b.warn("Geometry must specify vertex attributes"),a=!1),r.topology){case"PerAttributeArray":break;case"Indexed":case null:case void 0:var n=r.faces;if(n){if(r.vertexAttributes)for(var i in r.vertexAttributes){var s=n[i];s&&s.values?(null!=s.valueType&&"UInt32"!==s.valueType&&(b.warn("Unsupported indexed geometry indices type '"+s.valueType+"', only UInt32 is currently supported"),a=!1),null!=s.valuesPerElement&&1!==s.valuesPerElement&&(b.warn("Unsupported indexed geometry values per element '"+s.valuesPerElement+"', only 1 is currently supported"),a=!1)):(b.warn("Indexed geometry does not specify face indices for '"+i+"' attribute"),a=!1)}}else b.warn("Indexed geometries must specify faces"),a=!1;break;default:b.warn("Unsupported topology '"+t+"'"),a=!1}e.params.material||(b.warn("Geometry requires material"),a=!1);var o=e.params.vertexAttributes;for(var u in o){o[u].values||(b.warn("Geometries with externally defined attributes are not yet supported"),a=!1)}return a}function M(e){var r=v.empty();return e.forEach((function(e){var t=e.boundingInfo;v.expand(r,t.getBBMin()),v.expand(r,t.getBBMax())})),r}function T(e,r){return n(this,void 0,void 0,(function(){var t,n,i,s,o,u,l,d;return a(this,(function(a){switch(a.label){case 0:for(i in t=[],n=function(a){var n=e[a],i=n.images[0].data;if(!i)return b.warn("Externally referenced texture data is not yet supported"),"continue";var s=n.encoding+";base64,"+i,o="/textureDefinitions/"+a,u={noUnpackFlip:!0,wrap:{s:10497,t:10497},preMultiplyAlpha:!0},l=c.isSome(r)&&r.disableTextures?p.resolve(null):m.requestImage(s,r);t.push(l.then((function(e){return{refId:o,image:e,params:u,alphaChannelUsage:"rgba"===n.channels?n.alphaChannelUsage||"transparency":"none"}})))},e)n(i);return[4,p.all(t)];case 1:for(s=a.sent(),o={},u=0,l=s;u<l.length;u++)d=l[u],o[d.refId]=d;return[2,o]}}))}))}function k(e){switch(e){case"mask":return"mask";case"maskAndTransparency":return"maskBlend";case"none":return"opaque";case"transparency":default:return"blend"}}function P(e){var r=e.params;return{id:1,material:r.material,texture:r.texture,region:r.texture}}function E(e){for(var r=new Uint32Array(e),t=0;t<e;t++)r[t]=t;return r}r.load=function(e,r){return n(this,void 0,void 0,(function(){var t,n;return a(this,(function(a){switch(a.label){case 0:return[4,w(e,r)];case 1:return[4,T((t=a.sent()).textureDefinitions,r)];case 2:return n=a.sent(),[2,{resource:t,textures:n}]}}))}))},r.processLoadResult=function(e,r){var t=[],a=[],n=[],i=[],s=e.resource,o=d.Version.parse(s.version||"1.0","wosr");q.validate(o);for(var l=s.model.name,p=s.model.geometries,v=s.materialDefinitions,m=e.textures,b=0,w=new Map,A=0;A<p.length;A++){var U=p[A];if(I(U)){var T=P(U),B=U.params.vertexAttributes,D={};for(var S in B){var C=B[S],G=C.values;D[S]={data:G,size:C.valuesPerElement}}var R={};if("PerAttributeArray"===U.params.topology){var O=E(D.position.data.length/D.position.size);for(var j in D)R[j]=O}else{var V=U.params.faces;for(var H in V)R[H]=new Uint32Array(V[H].values)}var L=m&&m[T.texture];if(L&&!w.has(T.texture)){var z=L.image,F=L.params,_=new y(z,l,F);i.push(_),w.set(T.texture,_)}var J=w.get(T.texture),K=J?J.id:void 0,N=n[T.material]?n[T.material][T.texture]:null;if(!N){var Q=v[T.material.substring(T.material.lastIndexOf("/")+1)].params;1===Q.transparency&&(Q.transparency=0);var W=L&&L.alphaChannelUsage,X=Q.transparency>0||"transparency"===W||"maskAndTransparency"===W,Y={ambient:f.vec3f64.fromArray(Q.diffuse),diffuse:f.vec3f64.fromArray(Q.diffuse),opacity:1-(Q.transparency||0),transparent:X,textureAlphaMode:L?k(L.alphaChannelUsage):void 0,textureAlphaCutoff:.33,textureId:K,initTextureTransparent:!0,doubleSided:!0,cullFace:0,colorMixMode:Q.externalColorMixMode||"tint",textureAlphaPremultiplied:!0};c.isSome(r)&&r.materialParamsMixin&&u.mixin(Y,r.materialParamsMixin),N=new h(Y,l),n[T.material]||(n[T.material]={}),n[T.material][T.texture]=N}a.push(N);var Z=new g(new x.GeometryData(D,R),l);b+=R.position?R.position.length:0,t.push(Z)}}return{name:l,stageResources:{textures:i,materials:a,geometries:t},pivotOffset:s.model.pivotOffset,boundingBox:M(t),numberOfVertices:b,lodThreshold:null}},r.createTextureResources=T;var q=new d.Version(1,2,"wosr")}));