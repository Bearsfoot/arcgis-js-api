// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../core/tsSupport/assignHelper","../../../../core/Error","../../../../core/maybe","../../../../core/libs/earcut/earcut","../../../../core/libs/gl-matrix-2/mat3","../../../../core/libs/gl-matrix-2/mat3f64","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../../../geometry/support/aaBoundingBox","../../../../layers/graphics/dehydratedFeatures","../../../../renderers/support/renderingInfoUtils","./elevationAlignmentUtils","./elevationAlignmentUtils","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolLayer","./graphicUtils","./polygonUtils","../support/edgeUtils","../../support/projectionUtils","../../support/buffer/BufferView","../../support/buffer/math/vec3","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryData","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/Util","../../webgl-engine/materials/DefaultMaterial"],(function(e,t,r,a,n,i,o,s,l,c,p,h,u,d,f,y,m,g,v,b,_,E,x,A,S,P,w,C,L,T,M,O,D){Object.defineProperty(t,"__esModule",{value:!0});var z=function(e){function t(t,r,a,n){var i=e.call(this,t,r,a,n)||this;return i.ensureDrapedStatus(!1),i}return r(t,e),t.prototype.doLoad=function(){return n(this,void 0,void 0,(function(){var e,t,r,n,i,l;return a(this,(function(a){if(!this._drivenProperties.size&&(e=x.validateSymbolLayerSize(this._getSymbolSize())))throw new o("graphics3dextrudesymbollayer:invalid-size",e);return t=s.get(this.symbolLayer,"material","color"),r=this._getCombinedOpacityAndColor(t),n=f.vec3f64.fromArray(r),i=r[3],l={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,diffuse:n,ambient:n,opacity:i,transparent:i<1||this.needsDrivenTransparentPass,vertexColors:!0,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!0},this._material=new D(l,this._getIdHint("_3dlinemat")),this._context.stage.add(3,this._material),[2]}))}))},t.prototype.destroy=function(){e.prototype.destroy.call(this),this._material&&this._context.stage.remove(3,this._material.id)},t.prototype.createGraphics3DGraphic=function(e){var r=e.graphic;if(!this._validateGeometryType(r.geometry,t.validGeometryTypes,this.symbolLayer.type))return null;if(!this._validateGeometry(r.geometry))return null;var a="graphic"+r.uid,n=this._getVertexOpacityAndColor(e.renderingInfo,Float32Array,255),i=this.getGraphicElevationContext(r);return this._createAs3DShape(r,e.renderingInfo,n,i,a,r.uid)},t.prototype.layerOpacityChanged=function(e,t){var r=this,a=s.get(this.symbolLayer,"material","color"),n=this._getCombinedOpacity(a),i=n<1||this.needsDrivenTransparentPass;this._material.setParameterValues({opacity:n,transparent:i});var o=this._getLayerOpacity();return e.forEach((function(e){var a=t(e);s.isSome(a)&&a.layerOpacityChanged(o,r._context.isAsync)})),!0},t.prototype.layerElevationInfoChanged=function(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,b.needsElevationUpdates3D)},t.prototype.slicePlaneEnabledChanged=function(e,t){var r=this;return this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),e.forEach((function(e){var a=t(e);s.isSome(a)&&a.slicePlaneEnabledChanged(r._context.slicePlaneEnabled,r._context.isAsync)})),!0},t.prototype.physicalBasedRenderingChanged=function(){return this._material.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0},t.prototype.pixelRatioChanged=function(){return!0},t.prototype._getExtrusionSize=function(e){var t;return t=e.size&&this._drivenProperties.size?g.getDriverAxisSizeValue(e.size,2):this._getSymbolSize(),t/=this._context.renderCoordsHelper.unitInMeters},t.prototype._getSymbolSize=function(){return this.symbolLayer.size||1},t.prototype._createAs3DShape=function(e,t,r,a,n,i){var o=A.geometryAsPolygon(e.geometry);if(s.isNone(o))return null;var d=new Array,m=new Array,g=new Array,v=y.create(),E="global"===this._context.renderCoordsHelper.type,S=this._getExtrusionSize(t),T=f.vec3f64.create();E||this._context.renderCoordsHelper.worldUpAtPosition(null,T);var O=A.geometryToRenderInfo(o,this._context.elevationProvider,this._context.renderCoordsHelper,a);if(this._logGeometryCreationWarnings(O,o.rings,"rings","ExtrudeSymbol3DLayer"),0===o.rings.length||!o.rings.some((function(e){return e.length>0})))return null;var D=x.computeCentroid(o);if(s.isNone(D))return null;var z=u.mat4f64.create();P.computeLinearTransformation(o.spatialReference,[D.x,D.y,0],z,this._context.renderCoordsHelper.spatialReference);var I=u.mat4f64.create();h.mat4.invert(I,z);var V=p.mat3f64.create();c.mat3.normalFromMat4(V,I);for(var G=O.polygons,R=O.mapPosition,U=O.position,N=U.length/3,H=new Float64Array(3*N*6),F=new Float64Array(3*N*6),j=new Float64Array(3*N*6),Y=new Float64Array(1*N*6),W=0,Z=0;Z<G.length;++Z){var q=G[Z],J=q.count;if(!this._context.clippingExtent||(y.empty(v),y.expandWithBuffer(v,q.mapPosition),y.intersectsClippingArea(v,this._context.clippingExtent))){var K=l.earcut(q.mapPosition,q.holeIndices,3);if(0!==K.length){var Q=3*J*2+2*K.length,X=new Uint32Array(Q),$=6*J,ee=3*H.BYTES_PER_ELEMENT,te=new w.BufferViewVec3f64(H.buffer,W*ee,ee,(W+$)*ee),re=3*F.BYTES_PER_ELEMENT,ae=new w.BufferViewVec3f64(F.buffer,W*re,re,(W+$)*re),ne=new Float64Array(j.buffer,3*W*j.BYTES_PER_ELEMENT,3*$),ie=new Float64Array(Y.buffer,1*W*Y.BYTES_PER_ELEMENT,1*$);B(U,R,K,q,te.typedBuffer,ne,ae.typedBuffer,ie,0,X,0,S,T,E),C.transformMat4(te,te,I),C.transformMat3(ae,ae,V),W+=6*J;var oe=this._createExtrudeGeometry(X,{positions:te.typedBuffer,elevation:ne,normals:ae.typedBuffer,heights:ie},r),se=new L(oe,n+"path"+Z);d.push(se),m.push(this._material),g.push(u.mat4f64.IDENTITY)}}}if(0===d.length)return null;var le=new M({geometries:d,materials:m,transformations:g,castShadow:!0,metadata:{layerUid:this._context.layer.uid,graphicUid:i,isElevationSource:!0},idHint:n});le.objectTransformation=z;var ce=k,pe=this._createEdgeMaterial(),he=s.isSome(pe)?{baseMaterial:this._material,edgeMaterials:[pe],slicePlaneEnabled:this._context.slicePlaneEnabled}:null,ue=new _(this,le,d,null,null,ce,a,he);return ue.alignedSampledElevation=O.sampledElevation,ue.needsElevationUpdates=b.needsElevationUpdates3D(a.mode),ue},t.prototype._createExtrudeGeometry=function(e,t,r){for(var a=e.length,n=e,i=new Uint32Array(a),o=0;o<a;o++)i[o]=0;var s={},l={};return s[O.VertexAttrConstants.POSITION]=n,s[O.VertexAttrConstants.NORMAL]=n,s[O.VertexAttrConstants.COLOR]=i,l[O.VertexAttrConstants.POSITION]={size:3,data:t.positions},l[O.VertexAttrConstants.NORMAL]={size:3,data:t.normals},l[O.VertexAttrConstants.COLOR]={size:4,data:r},l[O.VertexAttrConstants.SIZE]={size:1,data:t.heights},t.elevation&&(l.mapPos={size:3,data:t.elevation},s.mapPos=n),new T.GeometryData(l,s)},t.prototype._createEdgeMaterial=function(){var e={opacity:this._getLayerOpacity()};return S.createMaterial(this.symbolLayer,e)},t.validGeometryTypes=["polygon","extent"],t}(E.default);function B(e,t,r,a,n,i,o,s,l,c,p,h,u,f){var y=r.length/3,m=0;p+=2*a.count,function(e,t,r,a,n,i,o,s,l,c,p,h,u,f,y,m,g){d.vec3.copy(Z,m);for(var v=y>0?1:-1,b=3*r,_=h,E=3*_,x=h+a,A=3*x,S=0;S<a;++S)g&&(Z[0]=e[b+0],Z[1]=e[b+1],Z[2]=e[b+2],d.vec3.normalize(Z,Z)),s[E+0]=e[b+0],s[E+1]=e[b+1],s[E+2]=e[b+2],l[E+0]=t[b+0],l[E+1]=t[b+1],l[E+2]=t[b+2],c[E+0]=-v*Z[0],c[E+1]=-v*Z[1],c[E+2]=-v*Z[2],p[_]=0,s[A+0]=e[b+0]+y*Z[0],s[A+1]=e[b+1]+y*Z[1],s[A+2]=e[b+2]+y*Z[2],l[A+0]=t[b+0],l[A+1]=t[b+1],l[A+2]=t[b+2],c[A+0]=v*Z[0],c[A+1]=v*Z[1],c[A+2]=v*Z[2],p[x]=y,E+=3,A+=3,b+=3,_+=1,x+=1;b=3*i,E=3*f,A=3*(f+o),E=3*(f+o),A=3*f;var P=q,w=J;y<0&&(P=J,w=q);for(S=0;S<o;++S)u[E+0]=n[b+P[0]],u[E+1]=n[b+P[1]],u[E+2]=n[b+P[2]],u[A+0]=n[b+w[0]]+a,u[A+1]=n[b+w[1]]+a,u[A+2]=n[b+w[2]]+a,E+=3,A+=3,b+=3}(e,t,a.index,a.count,r,0,y,n,i,o,s,l,c,p,h,u,f),l+=2*a.count,p+=2*y,p-=2*a.count+2*y,G(n,i,s,o,m,a.pathLengths[0],a.count,l,c,p,h),l+=4*a.pathLengths[0],p+=2*a.pathLengths[0],m+=a.pathLengths[0];for(var g=1;g<a.pathLengths.length;++g)G(n,i,s,o,m,a.pathLengths[g],a.count,l,c,p,h),l+=4*a.pathLengths[g],p+=2*a.pathLengths[g],m+=a.pathLengths[g]}function I(e,t,r,a,n,i,o){a[i]=a[o],o*=3,e[(i*=3)+0]=e[o+0],e[i+1]=e[o+1],e[i+2]=e[o+2],t[i+0]=t[o+0],t[i+1]=t[o+1],t[i+2]=t[o+2],r[i+0]=n[0],r[i+1]=n[1],r[i+2]=n[2]}t.Graphics3DExtrudeSymbolLayer=z;var V=f.vec3f64.create();function G(e,t,r,a,n,i,o,s,l,c,p){var h=n,u=n+1,d=n+o,f=n+o+1,y=s,m=s+1,g=s+2*i,v=s+2*i+1;p<0&&(h=n+o+1,f=n),c*=3;for(var b=0;b<i;++b)b===i-1&&(p>0?(u=n,f=n+o):(u=n,h=n+o)),j(e,h,u,d,V),I(e,t,a,r,V,y,h),I(e,t,a,r,V,m,u),I(e,t,a,r,V,g,d),I(e,t,a,r,V,v,f),l[c++]=y,l[c++]=g,l[c++]=v,l[c++]=y,l[c++]=v,l[c++]=m,h++,u++,d++,f++,y+=2,m+=2,g+=2,v+=2}var R=f.vec3f64.create(),U=f.vec3f64.create(),N=f.vec3f64.create(),H=f.vec3f64.create(),F=f.vec3f64.create();function j(e,t,r,a,n){t*=3,r*=3,a*=3,d.vec3.set(R,e[t++],e[t++],e[t++]),d.vec3.set(U,e[r++],e[r++],e[r++]),d.vec3.set(N,e[a++],e[a++],e[a++]),d.vec3.subtract(H,U,R),d.vec3.subtract(F,N,R),d.vec3.cross(n,F,H),d.vec3.normalize(n,n)}var Y=f.vec3f64.create();function k(e,t,r,a){var n=e.stageObject;K.spatialReference=r.spatialReference;for(var i=n.geometryRecords,o=i.length,s="absolute-height"!==t.mode,l=0,c=n.objectTransformation,p=h.mat4.invert(u.mat4f64.create(),c),f=0;f<o;f++){var y=i[f].geometry;y.invalidateBoundingInfo();for(var m=y.data.getVertexAttr(),g=m[O.VertexAttrConstants.POSITION].data,b=m[O.VertexAttrConstants.SIZE].data,_=m.mapPos.data,E=g.length/3,x=0,A=0,S=!1,P=0,w=0;w<E;w++){K.x=_[A],K.y=_[A+1],K.z=_[A+2],Y[0]=g[x],Y[1]=g[x+1],Y[2]=g[x+2];var C=v.evaluateElevationAlignmentAtPoint(K,r,t,a,s?Q:null);s&&(P+=Q.sampledElevation),d.vec3.set(W,g[x+0],g[x+1],g[x+2]),d.vec3.transformMat4(W,W,c),a.setAltitude(C+b[x/3],W),d.vec3.transformMat4(W,W,p),g[x]=W[0],g[x+1]=W[1],g[x+2]=W[2];var L=.01/a.unitInMeters;(Math.abs(Y[0]-g[x])>L||Math.abs(Y[1]-g[x+1])>L||Math.abs(Y[2]-g[x+2])>L)&&(S=!0),A+=3,x+=3}S&&n.geometryVertexAttrsUpdated(f),l+=P/E}return l/o}var W=f.vec3f64.create(),Z=f.vec3f64.create(),q=[0,2,1],J=[0,1,2],K=m.makeDehydratedPoint(0,0,0,null),Q={verticalDistanceToGround:0,sampledElevation:0};t.default=z}));