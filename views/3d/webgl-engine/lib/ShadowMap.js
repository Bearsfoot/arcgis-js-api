// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../../core/mathUtils","../../../../core/libs/gl-matrix-2/mat3f64","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/vec2","../../../../core/libs/gl-matrix-2/vec2f64","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../../../core/libs/gl-matrix-2/vec4","../../../../core/libs/gl-matrix-2/vec4f64","./Camera","./DefaultTextureUnits","./glUtil3D","./Util","../../../webgl/FramebufferObject","../../../webgl/Texture","../../../webgl/Util"],(function(e,t,a,r,c,i,s,o,n,f,v,h,d,u,l,m,p,x,b){for(var y=function(){this.camera=new d.default,this.lightMat=i.mat4f64.create()},g=function(){function e(e){this.doShadowMapMipmapsWork=!1,this.textureRes=4096,this.numCascades=1,this.maxNumCascades=2,this.splitSchemeLambda=.1,this.warp=!0,this.cascadeDistances=[0,0,0,0,0],this.cascades=[],this.rctx=e,this.emptyTexture=l.createEmptyTexture(e);for(var t=0;t<4;++t)this.cascades.push(new y)}return e.prototype.dispose=function(){this.emptyTexture.dispose(),this.emptyTexture=null},Object.defineProperty(e.prototype,"textureResolution",{get:function(){return this.textureRes},set:function(e){this.textureRes=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"maxCascades",{get:function(){return this.maxNumCascades},set:function(e){this.maxNumCascades=a.clamp(Math.floor(e),1,4)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"enabled",{get:function(){return!!this.depthTexture},set:function(e){e?this.enable():this.disable()},enumerable:!0,configurable:!0}),e.prototype.getDepthTexture=function(){return this.depthTexture},e.prototype.getCascades=function(){for(var e=0;e<this.numCascades;++e)W[e]=this.cascades[e];return W.length=this.numCascades,W},e.prototype.prepare=function(e,t,r){m.assert(this.enabled),c.mat4.multiply(w,e.projectionMatrix,e.viewMatrix);var i=r.near,s=r.far;i<2&&(i=2),s<2&&(s=2),i>=s&&(i=2,s=4),this.numCascades=Math.min(1+Math.floor(m.logWithBase(s/i,4)),this.maxNumCascades);for(var o=(s-i)/this.numCascades,f=Math.pow(s/i,1/this.numCascades),h=i,d=i,u=0;u<this.numCascades+1;++u)this.cascadeDistances[u]=a.lerp(h,d,this.splitSchemeLambda),h*=f,d+=o;c.mat4.invert(T,w),c.mat4.lookAt(N,[0,0,0],[-t[0],-t[1],-t[2]],e.up);var l=e.viewMatrix,p=e.projectionMatrix;for(u=0;u<this.numCascades;++u){var x=this.cascades[u],b=-this.cascadeDistances[u],y=-this.cascadeDistances[u+1],g=(p[10]*b+p[14])/Math.abs(p[11]*b+p[15]),R=(p[10]*y+p[14])/Math.abs(p[11]*y+p[15]);m.assert(g<R);for(var W=0;W<8;++W){var k=W%4==0||W%4==3?-1:1,z=W%4==0||W%4==1?-1:1,G=W<4?g:R;v.vec4.set(D,k,z,G,1),v.vec4.transformMat4(C[W],D,T);for(var H=0;H<3;++H)C[W][H]/=C[W][3]}n.vec3.negate(q,C[0]),c.mat4.translate(M,N,q),x.camera.viewMatrix=M;for(W=0;W<8;++W)n.vec3.transformMat4(C[W],C[W],x.camera.viewMatrix);n.vec3.copy(U,C[0]),n.vec3.copy(j,C[0]);for(W=1;W<8;++W)for(H=0;H<3;++H)U[H]=Math.min(U[H],C[W][H]),j[H]=Math.max(j[H],C[W][H]);if(U[2]-=200,j[2]+=200,x.camera.near=-j[2],x.camera.far=-U[2],this.warp){i=1/C[0][3],s=1/C[4][3],m.assert(i<s);var L=i+Math.sqrt(i*s),B=Math.sin(a.acosClamped(l[2]*t[0]+l[6]*t[1]+l[10]*t[2]));Q(C,L/=B,B,O,P,S,A,F),te(O,P,A,F,x.camera.projectionMatrix),x.camera.projectionMatrix[10]=2/(U[2]-j[2]),x.camera.projectionMatrix[14]=-(U[2]+j[2])/(U[2]-j[2])}else c.mat4.ortho(x.camera.projectionMatrix,U[0],j[0],U[1],j[1],x.camera.near,x.camera.far);c.mat4.multiply(x.lightMat,x.camera.projectionMatrix,x.camera.viewMatrix);var E=this.textureRes/2;x.camera.viewport[0]=u%2==0?0:E,x.camera.viewport[1]=0===Math.floor(u/2)?0:E,x.camera.viewport[2]=E,x.camera.viewport[3]=E}this.lastOrigin=null,this.cascadeDistances[this.numCascades]=100*s;var V=this.rctx;V.bindFramebuffer(this.fbo),V.bindTexture(null,7),V.setClearColor(1,1,1,1),V.clearSafe(16640)},e.prototype.finish=function(e){m.assert(this.enabled),this.rctx.bindFramebuffer(e),this.doShadowMapMipmapsWork&&this.depthTexture.generateMipmap()},e.prototype.bind=function(e,t){var a=this.rctx,r=this.enabled;a.bindTexture(r?this.depthTexture:this.emptyTexture,t),a.bindProgram(e),e.setUniform1i("depthTex",t),e.setUniform1f("depthHalfPixelSz",r?.5/this.textureRes:-1),e.setUniform1i("shadowMapNum",this.numCascades),e.setUniform4f("shadowMapDistance",this.cascadeDistances[0],this.cascadeDistances[1],this.cascadeDistances[2],this.cascadeDistances[3])},e.prototype.bindToAllPrograms=function(e){for(var t=e.getProgramsUsingUniform("shadowMapDistance"),a=0;a<t.length;a++)this.bind(t[a],u.DefaultTextureUnits.SHADOW_MAP)},e.prototype.bindView=function(e,t){if(this.enabled){var a=this.lastOrigin;if(!(a&&a[0]===t[0]&&a[1]===t[1]&&a[2]===t[2])){this.lastOrigin=this.lastOrigin||f.vec3f64.create(),n.vec3.copy(this.lastOrigin,t);for(var r=0;r<this.numCascades;++r){c.mat4.translate(k,this.cascades[r].lightMat,t);for(var i=0;i<16;++i)z[16*r+i]=k[i]}}e.setUniformMatrix4fv("shadowMapMatrix",z)}},e.prototype.enable=function(){if(!this.enabled){var e={target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!0,width:this.textureRes,height:this.textureRes};this.depthTexture=new x(this.rctx,e),this.fbo=new p(this.rctx,{colorTarget:0,depthStencilTarget:1,width:this.textureRes,height:this.textureRes},this.depthTexture)}},e.prototype.disable=function(){this.enabled&&this.fbo&&(this.fbo.dispose(),this.fbo=null,this.depthTexture=null)},e.prototype.getGpuMemoryUsage=function(){return b.getGpuMemoryUsage(this.fbo)},e}(),M=i.mat4f64.create(),w=i.mat4f64.create(),T=i.mat4f64.create(),D=h.vec4f64.create(),C=[],R=0;R<8;++R)C.push(h.vec4f64.create());var U=f.vec3f64.create(),j=f.vec3f64.create(),O=o.vec2f64.create(),P=o.vec2f64.create(),S=o.vec2f64.create(),A=o.vec2f64.create(),F=o.vec2f64.create(),N=i.mat4f64.create(),q=f.vec3f64.create(),W=[],k=i.mat4f64.create(),z=new Float32Array(64),G=o.vec2f64.create(),H=o.vec2f64.create(),L=[o.vec2f64.create(),o.vec2f64.create(),o.vec2f64.create(),o.vec2f64.create()],B=o.vec2f64.create(),E=o.vec2f64.create(),V=o.vec2f64.create(),_=o.vec2f64.create(),I=o.vec2f64.create(),J=o.vec2f64.create(),K=o.vec2f64.create();function Q(e,t,a,r,c,i,o,n){s.vec2.set(G,0,0);for(var f=0;f<4;++f)s.vec2.add(G,G,e[f]);s.vec2.scale(G,G,.25),s.vec2.set(H,0,0);for(f=4;f<8;++f)s.vec2.add(H,H,e[f]);s.vec2.scale(H,H,.25),s.vec2.lerp(L[0],e[4],e[5],.5),s.vec2.lerp(L[1],e[5],e[6],.5),s.vec2.lerp(L[2],e[6],e[7],.5),s.vec2.lerp(L[3],e[7],e[4],.5);var v=0,h=s.vec2.squaredDistance(L[0],G);for(f=1;f<4;++f){var d=s.vec2.squaredDistance(L[f],G);d<h&&(h=d,v=f)}s.vec2.subtract(B,L[v],e[v+4]);var u,l,p=B[0];B[0]=-B[1],B[1]=p,s.vec2.subtract(E,H,G),s.vec2.lerp(B,B,E,a),s.vec2.normalize(B,B),u=l=s.vec2.dot(s.vec2.subtract(V,e[0],G),B);for(f=1;f<8;++f){var x=s.vec2.dot(s.vec2.subtract(V,e[f],G),B);x<u?u=x:x>l&&(l=x)}s.vec2.copy(r,G),s.vec2.scale(V,B,u-t),s.vec2.add(r,r,V);var b=-1,y=1,g=0,M=0;for(f=0;f<8;++f){s.vec2.subtract(_,e[f],r),s.vec2.normalize(_,_);var w=B[0]*_[1]-B[1]*_[0];w>0?w>b&&(b=w,g=f):w<y&&(y=w,M=f)}m.verify(b>0,"leftArea"),m.verify(y<0,"rightArea"),s.vec2.scale(I,B,u),s.vec2.add(I,I,G),s.vec2.scale(J,B,l),s.vec2.add(J,J,G),K[0]=-B[1],K[1]=B[0];var T=m.rayRay2D(r,e[M],J,s.vec2.add(V,J,K),1,c),D=m.rayRay2D(r,e[g],J,V,1,i),C=m.rayRay2D(r,e[g],I,s.vec2.add(V,I,K),1,o),R=m.rayRay2D(r,e[M],I,V,1,n);m.verify(T,"rayRay"),m.verify(D,"rayRay"),m.verify(C,"rayRay"),m.verify(R,"rayRay")}function X(e,t){return 3*t+e}var Y=o.vec2f64.create();function Z(e,t){return s.vec2.set(Y,e[t],e[t+3]),Y}var $=o.vec2f64.create(),ee=r.mat3f64.create();function te(e,t,a,r,c){s.vec2.subtract($,a,r),s.vec2.scale($,$,.5),ee[0]=$[0],ee[1]=$[1],ee[2]=0,ee[3]=$[1],ee[4]=-$[0],ee[5]=0,ee[6]=$[0]*$[0]+$[1]*$[1],ee[7]=$[0]*$[1]-$[1]*$[0],ee[8]=1,ee[X(0,2)]=-s.vec2.dot(Z(ee,0),e),ee[X(1,2)]=-s.vec2.dot(Z(ee,1),e);var i=s.vec2.dot(Z(ee,0),a)+ee[X(0,2)],o=s.vec2.dot(Z(ee,1),a)+ee[X(1,2)],n=s.vec2.dot(Z(ee,0),r)+ee[X(0,2)],f=s.vec2.dot(Z(ee,1),r)+ee[X(1,2)];i=-(i+n)/(o+f),ee[X(0,0)]+=ee[X(1,0)]*i,ee[X(0,1)]+=ee[X(1,1)]*i,ee[X(0,2)]+=ee[X(1,2)]*i,i=1/(s.vec2.dot(Z(ee,0),a)+ee[X(0,2)]),o=1/(s.vec2.dot(Z(ee,1),a)+ee[X(1,2)]),ee[X(0,0)]*=i,ee[X(0,1)]*=i,ee[X(0,2)]*=i,ee[X(1,0)]*=o,ee[X(1,1)]*=o,ee[X(1,2)]*=o,ee[X(2,0)]=ee[X(1,0)],ee[X(2,1)]=ee[X(1,1)],ee[X(2,2)]=ee[X(1,2)],ee[X(1,2)]+=1,i=-.5*((i=s.vec2.dot(Z(ee,1),t)+ee[X(1,2)])/(o=s.vec2.dot(Z(ee,2),t)+ee[X(2,2)])+(n=s.vec2.dot(Z(ee,1),a)+ee[X(1,2)])/(f=s.vec2.dot(Z(ee,2),a)+ee[X(2,2)])),ee[X(1,0)]+=ee[X(2,0)]*i,ee[X(1,1)]+=ee[X(2,1)]*i,ee[X(1,2)]+=ee[X(2,2)]*i,i=s.vec2.dot(Z(ee,1),t)+ee[X(1,2)],n=-(o=s.vec2.dot(Z(ee,2),t)+ee[X(2,2)])/i,ee[X(1,0)]*=n,ee[X(1,1)]*=n,ee[X(1,2)]*=n,c[0]=ee[0],c[1]=ee[1],c[2]=0,c[3]=ee[2],c[4]=ee[3],c[5]=ee[4],c[6]=0,c[7]=ee[5],c[8]=0,c[9]=0,c[10]=1,c[11]=0,c[12]=ee[6],c[13]=ee[7],c[14]=0,c[15]=ee[8]}return g}));