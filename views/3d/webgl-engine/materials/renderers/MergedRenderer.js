// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../../../core/MapUtils","../../../../../core/maybe","../../../../../core/libs/gl-matrix-2/mat4","../../../../../core/libs/gl-matrix-2/mat4f64","../../../support/buffer/glUtil","../../lib/DefaultVertexAttributeLocations","../../lib/IntervalUtilities","../../lib/ResizableFloat32Array","../../lib/Util","../WaterGLMaterial","./Instance","./utils","../../../../webgl/BufferObject","../../../../webgl/Util","../../../../webgl/VertexArrayObject"],(function(e,t,r,a,i,n,o,s,u,l,d,f,c,h,g,p,m){var y=function(){function e(e,t,r,a){void 0===a&&(a=s.Default3D),this.type="MergedRenderer",this._dataByOrigin=new Map,this._highlightCount=0,this._hasOccludees=!1,this._rctx=e,this._vertexAttributeLocations=a,this._material=r,this._materialRep=t,this._glMaterials=h.acquireMaterials(this._material,this._materialRep),this._bufferWriter=r.createBufferWriter()}return e.prototype.dispose=function(){h.releaseMaterials(this._material,this._materialRep)},Object.defineProperty(e.prototype,"isEmpty",{get:function(){return 0===this._dataByOrigin.size},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"hasHighlights",{get:function(){return this._highlightCount>0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"hasOccludees",{get:function(){return this._hasOccludees},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"hasWater",{get:function(){return!this.isEmpty&&r.someMap(this._glMaterials,(function(e){return e instanceof f.WaterGLMaterial}))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rendersOccluded",{get:function(){return!this.isEmpty&&1!==this._material.renderOccluded},enumerable:!0,configurable:!0}),e.prototype.modify=function(e){var t=this,r=R;r.clear(),this.updateGeometries(e.toUpdate,r),this.addAndRemoveGeometries(e.toAdd,e.toRemove,r),this.updateHighlightCount(),this.updateOccludeeFlag(),r.forEach((function(e){return t.updateDisplayedIndexRanges(e)}))},e.prototype.addAndRemoveGeometries=function(e,t,r){var a=this,i=this._bufferWriter,n=i.vertexBufferLayout,o=n.stride/4,s=this._dataByOrigin,u=function(e,t,r,a){for(var i=new Map,n=t.vertexBufferLayout.stride/4,o=function(r,a){var o=r.origin,s=e.get(o.id),u=i.get(o.id);null==u&&(u={optimalCount:null==s?0:s.optimalCount,sparseCount:null==s?0:s.buffer.size,toAdd:[],toRemove:[],origin:o.vec3},i.set(o.id,u));var l=t.elementCount(r.data)*n;a?(u.optimalCount+=l,u.sparseCount+=l,u.toAdd.push(r)):(u.optimalCount-=l,u.toRemove.push(r))},s=0,u=r;s<u.length;s++){var l=u[s];o(l,!0)}for(var d=0,f=a;d<f.length;d++){l=f[d];o(l,!1)}return i}(s,i,e,t);u.forEach((function(e,t){u.delete(t);var i=e.optimalCount,l=e.sparseCount,f=s.get(t);if(null==f&&(d.assert(i>0),f=a.createData(n,i,e.origin),s.set(t,f)),0===i)return f.vao.dispose(!0),f.vao=null,void s.delete(t);var c=i<e.sparseCount/2,h=c?i:l,g=v,p=f.buffer.size,m=f.buffer.array,y=f.buffer.resize(h,!1);c||y?a.removeAndRebuild(f,e.toRemove,o,m,g):e.toRemove.length>0?(a.removeByErasing(f,e.toRemove,o,g),e.toAdd.length>0&&(g.end=p)):(g.begin=p,g.end=p);var x=b;d.setMatrixTranslation3(x,-e.origin[0],-e.origin[1],-e.origin[2]),a.append(f,e.toAdd,o,x,g);var _=f.vao.vertexBuffers.geometry;if(_.byteSize!==f.buffer.array.buffer.byteLength)_.setData(f.buffer.array);else{var R=g.begin,O=g.end;if(R<O){var C=f.buffer.array,I=4*R,A=4*O;_.setSubData(C,I,I,A)}}(g.updatedDisplayedIndexRange||f.displayedIndexRanges)&&r.add(f)}))},e.prototype.updateGeometries=function(e,t){for(var r=this._bufferWriter,a=r.vertexBufferLayout.stride/4,i=0,n=e;i<n.length;i++){var o=n[i],s=o.updateType,u=o.renderGeometry,l=this._dataByOrigin.get(u.origin.id),f=l&&l.instances.get(u.uniqueName);if(!f)return;if(1&s&&(f.isHidden=h.checkIsHidden(u),t.add(l)),9&s&&(f.highlightedIndexRanges=h.generateRenderGeometryHighlightRanges(u),l.highlightCount=null),16&s&&(f.hasOccludees=!!u.instanceParameters.occludees),6&s){var c=l.buffer.array,g=l.vao;h.calculateTransformRelToOrigin(u,x,_),r.write({transformation:x,invTranspTransformation:_},u.data,r.vertexBufferLayout.createView(c.buffer),f.from),d.assert(f.from+r.elementCount(u.data)===f.to,"material VBO layout has changed"),g.vertexBuffers.geometry.setSubData(c,f.from*a*4,f.from*a*4,f.to*a*4)}}},e.prototype.updateDisplayedIndexRanges=function(e){e.displayedIndexRanges=[];var t=!0;e.instances.forEach((function(r){r.isHidden?t=!1:e.displayedIndexRanges.push([r.from,r.to-1])})),e.displayedIndexRanges=t?null:u.mergeIntervals(e.displayedIndexRanges)},e.prototype.updateHighlightCount=function(){var e=this;this._highlightCount=0,this._dataByOrigin.forEach((function(t){if(null==t.highlightCount){var r=0;t.instances.forEach((function(e){e.highlightedIndexRanges&&++r})),t.highlightCount=r}e._highlightCount+=t.highlightCount}))},e.prototype.updateOccludeeFlag=function(){this._hasOccludees=r.someMap(this._dataByOrigin,(function(e){return e.hasOccludees=r.someMap(e.instances,(function(e){return e.hasOccludees})),e.hasOccludees}))},e.prototype.updateLogic=function(e){return this._material.update(e)},e.prototype.render=function(e,t,r,a){var i=this,o=this._rctx,s=this._glMaterials.get(t.pass),u=4===t.pass,l=e;if(2===t.pass&&null===l&&(l=22),!s||2!==s.ensureResources(o)||null!=l&&!s.beginSlot(l)||u&&0===this._highlightCount)return!1;s.ensureParameters(r);var d=s.getTechnique(),f=s.getPipelineState(l,!1);o.setPipelineState(f),s.bind(o,r),d.program.setUniformMatrix4fv("model",n.mat4f64.IDENTITY),d.program.hasUniform("modelNormal")&&d.program.setUniformMatrix4fv("modelNormal",n.mat4f64.IDENTITY);var c=!1;return this._dataByOrigin.forEach((function(e){if(!u||0!==e.highlightCount)if(r.origin=e.origin,d.bindDraw(r),d.ensureAttributeLocations(e.vao),o.bindVAO(e.vao),u)c=i.renderHighlightPass(d,e,a)||c;else if(e.hasOccludees){var t=s.getPipelineState(l,!0);c=i.renderDefaultPassWithOccludees(d,e,f,t,a)||c}else c=i.renderDefaultPass(d,e,a)||c})),c},e.prototype.renderDefaultPass=function(e,t,r){var a=this._rctx,i=t.displayedIndexRanges;if(i&&0===i.length)return!1;if(i)h.drawArraysFaceRange(a,i,0,e.primitiveType,r);else{var n=4*t.buffer.size/p.getStride(t.vao.layout.geometry);h.drawArrays(a,e.primitiveType,0,n,r)}return!0},e.prototype.renderDefaultPassWithOccludees=function(e,t,r,a,i){var n=this._rctx,o=t.displayedIndexRanges;return(!o||0!==o.length)&&(t.instances.forEach((function(t){t.isHidden||(t.hasOccludees&&n.setPipelineState(a),h.drawArrays(n,e.primitiveType,t.from,t.to-t.from,i),t.hasOccludees&&n.setPipelineState(r))})),!0)},e.prototype.renderHighlightPass=function(e,t,r){var a=this._rctx,i=!1;return t.instances.forEach((function(t){var n=t.highlightedIndexRanges;if(n&&0!==n.length)for(var o=0;o<n.length;o++){var s=n[o],u=s?s[0]+t.from:t.from,l=s?s[1]-s[0]+1:t.to-t.from;h.drawArrays(a,e.primitiveType,u,l,r),i=!0}})),i},e.prototype.createData=function(e,t,r){return{instances:new Map,vao:new m(this._rctx,this._vertexAttributeLocations,{geometry:o.glLayout(e)},{geometry:g.createVertex(this._rctx,35044)}),buffer:new l.ResizableFloat32Array(t),optimalCount:0,origin:r,highlightCount:0,hasOccludees:!1}},e.prototype.removeAndRebuild=function(e,t,r,a,i){for(var n=0,o=t;n<o.length;n++){var s=o[n].uniqueName,u=e.instances.get(s);e.optimalCount-=(u.to-u.from)*r,e.instances.delete(s)}var l=0,d=e.buffer.array;i.begin=0,i.end=0;var f=-1,c=-1,h=0;e.instances.forEach((function(e){var t=e.from*r,i=e.to*r,n=i-t;f!==c&&c!==t?(d.set(a.subarray(f,c),h),h+=c-f,f=t):-1===f&&(f=t),c=i,e.from=l/r,l+=n,e.to=l/r})),f!==c&&d.set(a.subarray(f,c),h),i.end=l},e.prototype.removeByErasing=function(e,t,r,a){a.begin=1/0,a.end=-1/0;for(var i=-1,n=-1,o=0,s=t;o<s.length;o++){var u=s[o].uniqueName,l=e.instances.get(u),d=l.from*r,f=l.to*r;i!==n&&n!==d?(e.buffer.erase(i,n),i=d):-1===i&&(i=d),n=f,e.instances.delete(u),e.optimalCount-=f-d,d<a.begin&&(a.begin=d),f>a.end&&(a.end=f)}i!==n&&e.buffer.erase(i,n)},e.prototype.append=function(e,t,r,n,o){o.updatedDisplayedIndexRange=!1;for(var s=this._bufferWriter,u=0,l=t;u<l.length;u++){var f=l[u],g=f.data,p=a.isSome(f.transformation)?i.mat4.multiply(x,n,f.transformation):n;i.mat4.invert(_,p),i.mat4.transpose(_,_);var m=o.end;s.write({transformation:p,invTranspTransformation:_},g,s.vertexBufferLayout.createView(e.buffer.array.buffer),o.end/r);var y=s.elementCount(g)*r,v=m+y;d.assert(null==e.instances.get(f.uniqueName));var b=h.checkIsHidden(f),R=h.generateRenderGeometryHighlightRanges(f),O=!!f.instanceParameters.occludees;R&&(e.highlightCount=null),O&&(e.hasOccludees=e.hasOccludees||!0);var C=new c.Instance(m/r,v/r,b,R,O);e.instances.set(f.uniqueName,C),b&&(o.updatedDisplayedIndexRange=!0),e.optimalCount+=y,o.end+=y}},Object.defineProperty(e.prototype,"test",{get:function(){return{material:this._material}},enumerable:!0,configurable:!0}),e}();var v={updatedDisplayedIndexRange:!1,begin:0,end:0},b=n.mat4f64.create(),x=n.mat4f64.create(),_=n.mat4f64.create(),R=new Set;return y}));