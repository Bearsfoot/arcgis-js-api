// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/tsSupport/assignHelper","../../../../core/libs/gl-matrix-2/mat3f64","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../support/buffer/InterleavedLayout","../core/shaderLibrary/util/AlphaDiscard.glsl","../lib/GLMaterialTexture","../lib/intersectorUtils","../lib/Material","../lib/StencilUtils","../lib/Util","./internal/bufferWriterUtils","./internal/MaterialUtil","./renderers/MergedRenderer","../shaders/DefaultMaterialTechnique","../shaders/RealisticTreeTechnique","../../../webgl/renderState","../../../webgl/renderState"],(function(e,t,i,a,r,s,n,o,l,c,u,h,p,f,d,m,v,g,b,x,C){var y=f.assert,S=function(e){function t(i,a){var r=e.call(this,a)||this;return r.supportsEdges=!0,r.techniqueConfig=new g.DefaultMaterialTechniqueConfiguration,r.params=m.copyParameters(i,q),r.vertexBufferLayout=t.getVertexBufferLayout(r.params),r.instanceBufferLayout=i.instanced?t.getInstanceBufferLayout(r.params):null,r}return i(t,e),t.prototype.isVisibleInPass=function(e){return 3!==e||this.params.castShadows},t.prototype.isVisible=function(){var t=this.params;if(!e.prototype.isVisible.call(this)||0===t.layerOpacity)return!1;var i=t.instanced,a=t.vertexColors,r=t.symbolColors,s=!!i&&i.indexOf("color")>-1,n=t.vvColorEnabled,o="replace"===t.colorMixMode,l=t.opacity>0,c=t.externalColor&&t.externalColor[3]>0;return a&&(s||n||r)?!!o||l:a?o?c:l:s||n||r?!!o||l:o?c:l},t.prototype.setParameterValues=function(e){var t=this.params;for(var i in e)"instanced"===i&&y(e.instanced===t.instanced,"Can not change instanced attributes"),"textureId"===i&&y(t.textureId,"Can only change texture of material that already has a texture"),"vertexColors"===i&&!0===e[i]&&e[i]!==t[i]&&y(t.vertexColors,"Can not enable vertex colors after DefaultMaterial creation"),t[i]=e[i];this.parametersChanged()},t.prototype.getParameters=function(){return this.params},t.prototype.getTechniqueConfig=function(e){return this.techniqueConfig.output=e,this.techniqueConfig.hasNormalTexture=!!this.params.normalTextureId,this.techniqueConfig.hasColorTexture=!!this.params.textureId,this.techniqueConfig.vertexTangents=this.params.vertexTangents,this.techniqueConfig.instanced=!!this.params.instanced,this.techniqueConfig.instancedDoublePrecision=this.params.instancedDoublePrecision,this.techniqueConfig.vvSize=this.params.vvSizeEnabled,this.techniqueConfig.verticalOffset=null!==this.params.verticalOffset,this.techniqueConfig.screenSizePerspective=null!==this.params.screenSizePerspective,this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled,this.techniqueConfig.sliceHighlightDisabled=this.params.sliceHighlightDisabled,this.techniqueConfig.alphaDiscardMode="opaque"===this.params.textureAlphaMode?1:"mask"===this.params.textureAlphaMode?2:"maskBlend"===this.params.textureAlphaMode?3:0,this.techniqueConfig.normalsTypeDerivate="screenDerivative"===this.params.normals,0===e&&(this.techniqueConfig.vertexColors=this.params.vertexColors,this.techniqueConfig.symbolColors=this.params.symbolColors,this.params.treeRendering||(this.techniqueConfig.doubleSidedMode=this.params.doubleSided&&"normal"===this.params.doubleSidedType?1:this.params.doubleSided&&"winding-order"===this.params.doubleSidedType?2:0),this.techniqueConfig.instancedColor=!!this.params.instanced&&this.params.instanced.indexOf("color")>-1,this.techniqueConfig.receiveShadows=this.params.receiveShadows&&this.params.shadowMappingEnabled,this.techniqueConfig.receiveAmbientOcclusion=this.params.receiveSSAO,this.techniqueConfig.vvColor=this.params.vvColorEnabled,this.techniqueConfig.textureAlphaPremultiplied=!!this.params.textureAlphaPremultiplied,this.techniqueConfig.usePBR=this.params.usePBR,this.techniqueConfig.hasMetalnessAndRoughnessTexture=!!this.params.metallicRoughnessTextureId,this.techniqueConfig.hasEmissionTexture=!!this.params.emissiveTextureId,this.techniqueConfig.hasOcclusionTexture=!!this.params.occlusionTextureId,this.techniqueConfig.offsetBackfaces=!(!this.params.transparent||!this.params.offsetTransparentBackfaces),this.techniqueConfig.isSchematic=this.params.usePBR&&this.params.isSchematic),this.techniqueConfig},t.prototype.intersect=function(e,t,i,a,r,n,o){if(null!==this.params.verticalOffset){var l=a.camera;s.vec3.set(R,i[12],i[13],i[14]);var c=null;switch(a.viewingMode){case"global":c=s.vec3.normalize(D,R);break;case"local":c=s.vec3.copy(D,A)}var h=0;if(null!==this.params.verticalOffset){var p=s.vec3.subtract(L,R,l.eye),f=s.vec3.length(p),d=s.vec3.scale(p,p,1/f),v=null;this.params.screenSizePerspective&&(v=s.vec3.dot(c,d)),h+=m.verticalOffsetAtDistance(l,f,this.params.verticalOffset,v,this.params.screenSizePerspective)}s.vec3.scale(c,c,h),s.vec3.transformMat3(I,c,a.transform.inverseRotation),r=s.vec3.subtract(w,r,I),n=s.vec3.subtract(B,n,I)}m.intersectTriangleGeometry(e,t,a,r,n,u.getVerticalOffsetObject3D(a.verticalOffset),o)},t.prototype.getGLMaterial=function(e){if(0===e.output||1===e.output||2===e.output||3===e.output||4===e.output)return new P(e)},t.prototype.createRenderer=function(e,t){return new v(e,t,this)},t.prototype.createBufferWriter=function(){return new T(this.vertexBufferLayout,this.instanceBufferLayout)},t.getVertexBufferLayout=function(e){var t=e.textureId||e.normalTextureId||e.metallicRoughnessTextureId||e.emissiveTextureId||e.occlusionTextureId,i=o.newLayout().vec3f("position").vec3f("normal");return e.vertexTangents&&i.vec4f("tangent"),t&&i.vec2f("uv0"),e.vertexColors&&i.vec4u8("color"),e.symbolColors&&i.vec4u8("symbolColor"),i},t.getInstanceBufferLayout=function(e){var t=o.newLayout();return t=e.instancedDoublePrecision?t.vec3f("modelOriginHi").vec3f("modelOriginLo").mat3f("model").mat3f("modelNormal"):t.mat4f("model").mat4f("modelNormal"),e.instanced&&e.instanced.indexOf("color")>-1&&(t=t.vec4f("instanceColor")),e.instanced&&e.instanced.indexOf("featureAttribute")>-1&&(t=t.vec4f("instanceFeatureAttribute")),t},t}(h.Material),P=function(e){function t(t){var i=this,a=t.material;return(i=e.call(this,c.makeCtorParameters(t,a.getParameters()))||this).updateParameters(),i}return i(t,e),t.prototype.updateParameters=function(){this.selectPipelines(),this.selectSlot();var e=this.material.getParameters();this.updateTexture(e.textureId),this.technique=e.treeRendering?this.techniqueRep.acquireAndReleaseExisting(b.RealisticTreeTechnique,this.material.getTechniqueConfig(this.output),this.technique):this.techniqueRep.acquireAndReleaseExisting(g.DefaultMaterialTechnique,this.material.getTechniqueConfig(this.output),this.technique)},t.prototype.selectSlot=function(){this.slot=this.material.getParameters().transparent?this.material.getParameters().writeDepth?5:8:3},t.prototype.selectPipelines=function(){var e=this.material.getParameters(),t=0===this.output?M(e):null,i=function(i){return C.makePipelineState({blending:t,culling:O(e),depthTest:{func:513},depthWrite:e.writeDepth&&C.defaultDepthWriteParams,colorWrite:C.defaultColorWriteParams,stencilWrite:e.sceneHasOcludees?p.stencilWriteMaskOn:null,stencilTest:e.sceneHasOcludees?i?p.stencilToolMaskBaseParams:p.stencilBaseAllZerosParams:null})};this.pipelineState=i(!1),this.occludeePipelineState=i(!0)},t.prototype._updateShadowState=function(e){e.shadowMappingEnabled!==this.material.getParameters().shadowMappingEnabled&&(this.material.setParameterValues({shadowMappingEnabled:e.shadowMappingEnabled}),this.updateParameters())},t.prototype._updateOccludeeState=function(e){e.hasOccludees!==this.material.getParameters().sceneHasOcludees&&(this.material.setParameterValues({sceneHasOcludees:e.hasOccludees}),this.updateParameters())},t.prototype.ensureParameters=function(e){0===this.output&&(this._updateShadowState(e),this._updateOccludeeState(e))},t.prototype.bind=function(e,t){e.bindProgram(this.technique.program),this.technique.bindPass(e,this.material.getParameters(),t),this.bindTexture(e,this.technique.program)},t.prototype.beginSlot=function(e){return e===this.slot},t.prototype.getPipelineState=function(e,t){return t?this.occludeePipelineState:this.pipelineState},t}(c);!function(e){e.COLOR_GAMMA=2.1}(S||(S={}));var q={textureId:void 0,initTextureTransparent:!1,isSchematic:!1,usePBR:!1,normalTextureId:void 0,vertexTangents:!1,occlusionTextureId:void 0,emissiveTextureId:void 0,metallicRoughnessTextureId:void 0,emissiveFactor:[0,0,0],mrrFactors:[0,1,.5],ambient:[.2,.2,.2],diffuse:[.8,.8,.8],externalColor:[1,1,1,1],colorMixMode:"multiply",opacity:1,layerOpacity:1,vertexColors:!1,symbolColors:!1,doubleSided:!1,doubleSidedType:"normal",cullFace:void 0,instanced:void 0,instancedDoublePrecision:!1,normals:"default",receiveSSAO:!0,receiveShadows:!0,castShadows:!0,shadowMappingEnabled:!1,verticalOffset:null,screenSizePerspective:null,slicePlaneEnabled:!1,sliceHighlightDisabled:!1,offsetTransparentBackfaces:!1,vvSizeEnabled:!1,vvSizeMinSize:[1,1,1],vvSizeMaxSize:[100,100,100],vvSizeOffset:[0,0,0],vvSizeFactor:[1,1,1],vvSizeValue:[1,1,1],vvColorEnabled:!1,vvColorValues:[0,0,0,0,0,0,0,0],vvColorColors:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],vvSymbolAnchor:[0,0,0],vvSymbolRotationMatrix:r.mat3f64.create(),transparent:!1,writeDepth:!0,textureAlphaMode:"blend",textureAlphaCutoff:l.defaultMaskAlphaCutoff,textureAlphaPremultiplied:!1,sceneHasOcludees:!1},T=function(){function e(e,t){this.vertexBufferLayout=e,this.instanceBufferLayout=t}return e.prototype.allocate=function(e){return this.vertexBufferLayout.createBuffer(e)},e.prototype.elementCount=function(e){return e.indices.position.length},e.prototype.write=function(e,t,i,a){d.writeDefaultAttributes(t,this.vertexBufferLayout,e.transformation,e.invTranspTransformation,i,a)},e}(),M=function(e){return e.transparent&&x.separateBlendingParams(770,1,771,771)};var O=function(e){return function(e){return e.cullFace?0!==e.cullFace:!e.slicePlaneEnabled&&(!e.transparent&&!e.doubleSided)}(e)&&{face:1===e.cullFace?1028:1029,mode:2305}},w=n.vec3f64.create(),B=n.vec3f64.create(),A=n.vec3f64.fromValues(0,0,1),D=n.vec3f64.create(),I=n.vec3f64.create(),R=n.vec3f64.create(),L=n.vec3f64.create();return S}));