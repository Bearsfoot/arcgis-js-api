// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../support/buffer/BufferView","../../lib/Util"],(function(e,r,f,t){function a(e,r,f,t,a){var i=f.typedBuffer,s=f.typedBufferStride,o=e.length;if(t*=s,null==a||1===a)for(var u=0;u<o;++u){var n=2*e[u];i[t]=r[n],i[t+1]=r[n+1],t+=s}else for(u=0;u<o;++u){n=2*e[u];for(var l=0;l<a;++l)i[t]=r[n],i[t+1]=r[n+1],t+=s}}function i(e,r,f,t,a){var i=f.typedBuffer,s=f.typedBufferStride,o=e.length;if(t*=s,null==a||1===a)for(var u=0;u<o;++u){var n=3*e[u];i[t]=r[n],i[t+1]=r[n+1],i[t+2]=r[n+2],t+=s}else for(u=0;u<o;++u){n=3*e[u];for(var l=0;l<a;++l)i[t]=r[n],i[t+1]=r[n+1],i[t+2]=r[n+2],t+=s}}function s(e,r,f,t,a){var i=f.typedBuffer,s=f.typedBufferStride,o=e.length;if(t*=s,null==a||1===a)for(var u=0;u<o;++u){var n=4*e[u];i[t]=r[n],i[t+1]=r[n+1],i[t+2]=r[n+2],i[t+3]=r[n+3],t+=s}else for(u=0;u<o;++u){n=4*e[u];for(var l=0;l<a;++l)i[t]=r[n],i[t+1]=r[n+1],i[t+2]=r[n+2],i[t+3]=r[n+3],t+=s}}function o(e,r,f,t,a,s){if(f){var o=f,u=t.typedBuffer,n=t.typedBufferStride,l=e.length;if(a*=n,null==s||1===s)for(var d=0;d<l;++d){var v=r[V=3*e[d]],B=r[V+1],c=r[V+2];u[a]=o[0]*v+o[4]*B+o[8]*c+o[12],u[a+1]=o[1]*v+o[5]*B+o[9]*c+o[13],u[a+2]=o[2]*v+o[6]*B+o[10]*c+o[14],a+=n}else for(d=0;d<l;++d){v=r[V=3*e[d]],B=r[V+1],c=r[V+2];for(var V,p=o[0]*v+o[4]*B+o[8]*c+o[12],w=o[1]*v+o[5]*B+o[9]*c+o[13],y=o[2]*v+o[6]*B+o[10]*c+o[14],g=0;g<s;++g)u[a]=p,u[a+1]=w,u[a+2]=y,a+=n}}else i(e,r,t,a,s)}function u(e,r,f,t,a,s){if(f){var o=f,u=t.typedBuffer,n=t.typedBufferStride,l=e.length,d=o[0],v=o[1],B=o[2],c=o[4],V=o[5],p=o[6],w=o[8],y=o[9],g=o[10],h=Math.abs(1-d*d+c*c+w*w)>1e-5||Math.abs(1-v*v+V*V+y*y)>1e-5||Math.abs(1-B*B+p*p+g*g)>1e-5;if(a*=n,null==s||1===s)for(var b=0;b<l;++b){var z=d*(S=r[M=3*e[b]])+c*(O=r[M+1])+w*(x=r[M+2]),A=v*S+V*O+y*x,C=B*S+p*O+g*x;if(h)if((F=z*z+A*A+C*C)<1-1e-6&&F>1e-6)z/=N=Math.sqrt(F),A/=N,C/=N;u[a+0]=z,u[a+1]=A,u[a+2]=C,a+=n}else for(b=0;b<l;++b){var M,S,O,x,F,N,k=d*(S=r[M=3*e[b]])+c*(O=r[M+1])+w*(x=r[M+2]),L=v*S+V*O+y*x,R=B*S+p*O+g*x;if(h)if((F=k*k+L*L+R*R)<1-1e-6&&F>1e-6)k/=N=Math.sqrt(F),L/=N,R/=N;for(var q=0;q<s;++q)u[a+0]=k,u[a+1]=L,u[a+2]=R,a+=n}}else i(e,r,t,a,s)}function n(e,r,f,t,a,i){var s=t.typedBuffer,o=t.typedBufferStride,u=e.length;if(a*=o,null==i||1===i){if(4===f)for(var n=0;n<u;++n){var l=4*e[n];s[a]=r[l],s[a+1]=r[l+1],s[a+2]=r[l+2],s[a+3]=r[l+3],a+=o}else if(3===f)for(n=0;n<u;++n){l=3*e[n];s[a]=r[l],s[a+1]=r[l+1],s[a+2]=r[l+2],s[a+3]=255,a+=o}}else if(4===f)for(n=0;n<u;++n){l=4*e[n];for(var d=0;d<i;++d)s[a]=r[l],s[a+1]=r[l+1],s[a+2]=r[l+2],s[a+3]=r[l+3],a+=o}else if(3===f)for(n=0;n<u;++n)for(l=3*e[n],d=0;d<i;++d)s[a]=r[l],s[a+1]=r[l+1],s[a+2]=r[l+2],s[a+3]=255,a+=o}Object.defineProperty(r,"__esModule",{value:!0}),r.writeBufferVec2=a,r.writeBufferVec3=i,r.writeBufferVec4=s,r.writeBufferMat3f=function(e,r,f,t){var a=f.typedBuffer,i=f.typedBufferStride,s=e.length;t*=i;for(var o=0;o<s;++o){for(var u=9*e[o],n=0;n<9;++n)a[t+n]=r[u+n];t+=i}},r.writeBufferMat4f=function(e,r,f,t){var a=f.typedBuffer,i=f.typedBufferStride,s=e.length;t*=i;for(var o=0;o<s;++o){for(var u=16*e[o],n=0;n<16;++n)a[t+n]=r[u+n];t+=i}},r.writePosition=o,r.writeNormal=u,r.writeColor=n,r.writeMultipliedColor=function(e,r,f,t,a,i,s){var o=a.typedBuffer,u=a.typedBufferStride,n=e.length;if(i*=u,null==s||1===s){if(4===f)for(var l=0;l<n;++l){var d=4*e[l];o[i]=r[d]*t[0],o[i+1]=r[d+1]*t[1],o[i+2]=r[d+2]*t[2],o[i+3]=r[d+3]*t[3],i+=u}else if(3===f){var v=255*t[3];for(l=0;l<n;++l){d=3*e[l];o[i]=r[d]*t[0],o[i+1]=r[d+1]*t[1],o[i+2]=r[d+2]*t[2],o[i+3]=v,i+=u}}}else if(4===f)for(l=0;l<n;++l){d=4*e[l];for(var B=0;B<s;++B)o[i]=r[d]*t[0],o[i+1]=r[d+1]*t[1],o[i+2]=r[d+2]*t[2],o[i+3]=r[d+3]*t[3],i+=u}else if(3===f)for(v=255*t[3],l=0;l<n;++l)for(d=3*e[l],B=0;B<s;++B)o[i]=r[d]*t[0],o[i+1]=r[d+1]*t[1],o[i+2]=r[d+2]*t[2],o[i+3]=v,i+=u},r.writeDefaultAttributes=function(e,r,i,l,d,v){for(var B=0,c=r.fieldNames;B<c.length;B++){var V=c[B],p=e.vertexAttr[V],w=e.indices[V];if(p&&w)switch(V){case t.VertexAttrConstants.POSITION:t.assert(3===p.size);var y=d.getField(V,f.BufferViewVec3f);y&&o(w,p.data,i,y,v);break;case t.VertexAttrConstants.NORMAL:t.assert(3===p.size);var g=d.getField(V,f.BufferViewVec3f);g&&u(w,p.data,l,g,v);break;case t.VertexAttrConstants.UV0:t.assert(2===p.size);var h=d.getField(V,f.BufferViewVec2f);h&&a(w,p.data,h,v);break;case t.VertexAttrConstants.REGION:t.assert(4===p.size);var b=d.getField(V,f.BufferViewVec4u16);b&&s(w,p.data,b,v);break;case t.VertexAttrConstants.COLOR:t.assert(3===p.size||4===p.size);var z=d.getField(V,f.BufferViewVec4u8);z&&n(w,p.data,p.size,z,v);break;case t.VertexAttrConstants.SYMBOLCOLOR:t.assert(3===p.size||4===p.size);var A=d.getField(V,f.BufferViewVec4u8);A&&n(w,p.data,p.size,A,v);break;case t.VertexAttrConstants.TANGENT:t.assert(4===p.size);var C=d.getField(V,f.BufferViewVec4f);C&&s(w,p.data,C,v)}}}}));