// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/assignHelper","../../../../../core/mathUtils","../../../../../core/maybe","../../../../../core/libs/gl-matrix-2/mat4","../../../../../core/libs/gl-matrix-2/mat4f64","../../../../../core/libs/gl-matrix-2/vec3","../../../../../core/libs/gl-matrix-2/vec3f64","../../../../../core/libs/gl-matrix-2/vec4","../../../../../geometry/support/aaBoundingBox","../../lib/ComponentUtils","../../lib/screenSizePerspectiveUtils","../../lib/Util"],(function(e,t,r,i,n,a,o,c,f,s,v,l,u,m){Object.defineProperty(t,"__esModule",{value:!0});var p=o.mat4f64.create(),d=v.create(),g=m.VertexAttrConstants;t.intersectTriangleGeometry=function(e,t,r,i,a,o,c){var f=t&&t.componentVisibilities,s=r.tolerance;if(e.componentCount>1)!function(e,t,r,i,a,o,c){var f=B(r,i,x),s=e.componentCount,u=e.componentOffsets,m=e.getIndices(g.POSITION),p=e.getAttribute(g.POSITION),M=e.boundingInfo;if(M&&(v.setMin(d,M.getBBMin()),v.setMax(d,M.getBBMax()),n.isSome(o)&&o.applyToAABB(d),!T(d,r,f,a)))return;for(var b=0;b<s;b++)if(!t||l.getVisibility(t,b)){if(e.getComponentAABB){var I=e.getComponentAABB(b,d);if(n.isSome(o)&&o.applyToAABB(I),!T(I,r,f,a))continue}var A=u[b]/3,y=u[b+1]/3;h(r,i,A,y,m,p,void 0,o,c)}}(e,f,i,a,s,o,c);else if(!f||l.getVisibility(f,0))if(e.boundingInfo)m.assert("triangle"===e.data.primitiveType),function e(t,r,i,a,o,c){var f=B(r,i,x);v.setMin(d,t.getBBMin()),v.setMax(d,t.getBBMax()),n.isSome(o)&&o.applyToAABB(d);if(T(d,r,f,a)){var s=t.getPrimitiveIndices(),l=t.getIndices(),u=t.getPosition(),m=s?s.length:l.length/3;if(m>O){var p=t.getChildren();if(void 0!==p){for(var g=0;g<8;++g)void 0!==p[g]&&e(p[g],r,i,a,o,c);return}}h(r,i,0,m,l,u,s,o,c)}}(e.boundingInfo,i,a,s,o,c);else{var u=e.getIndices(g.POSITION),p=e.getAttribute(g.POSITION);h(i,a,0,u.length/3,u,p,void 0,o,c)}};var x=f.vec3f64.create();var M=Math.pow(2,-52),b=f.vec3f64.create();function h(e,t,r,i,a,o,c,f,s){var v,l,u;if(c)return function(e,t,r,i,a,o,c,f,s){for(var v,l,u,m=o.data,p=o.offsetIdx,d=o.strideIdx,g=e[0],x=e[1],h=e[2],I=t[0],A=t[1],B=t[2],T=I-g,S=A-x,P=B-h,O=r;O<i;++O){var V=c[O],N=3*V,C=p+d*a[N++],U=m[C++],D=m[C++],L=m[C];C=p+d*a[N++];var z=m[C++],E=m[C++],W=m[C];C=p+d*a[N];var q=m[C++],R=m[C++],_=m[C];n.isSome(f)&&(v=f.applyToVertex(U,D,L),U=v[0],D=v[1],L=v[2],l=f.applyToVertex(z,E,W),z=l[0],E=l[1],W=l[2],u=f.applyToVertex(q,R,_),q=u[0],R=u[1],_=u[2]);var j=z-U,w=E-D,G=W-L,H=q-U,X=R-D,Y=_-L,Z=S*Y-X*P,k=P*H-Y*T,F=T*X-H*S,J=j*Z+w*k+G*F;if(!(Math.abs(J)<=M)){var K=g-U,Q=x-D,$=h-L,ee=K*Z+Q*k+$*F;if(J>0){if(ee<0||ee>J)continue}else if(ee>0||ee<J)continue;var te=Q*G-w*$,re=$*j-G*K,ie=K*w-j*Q,ne=T*te+S*re+P*ie;if(J>0){if(ne<0||ee+ne>J)continue}else if(ne>0||ee+ne<J)continue;var ae=(H*te+X*re+Y*ie)/J;if(ae>=0){var oe=y(j,w,G,H,X,Y,b);s(ae,oe,V)}}}}(e,t,r,i,a,o,c,f,s);for(var m=o.data,p=o.offsetIdx,d=o.strideIdx,g=e[0],x=e[1],h=e[2],I=t[0]-g,A=t[1]-x,B=t[2]-h,T=r,S=3*r;T<i;++T){var P=p+d*a[S++],O=m[P++],V=m[P++],N=m[P];P=p+d*a[S++];var C=m[P++],U=m[P++],D=m[P];P=p+d*a[S++];var L=m[P++],z=m[P++],E=m[P];n.isSome(f)&&(O=(v=f.applyToVertex(O,V,N))[0],V=v[1],N=v[2],C=(l=f.applyToVertex(C,U,D))[0],U=l[1],D=l[2],L=(u=f.applyToVertex(L,z,E))[0],z=u[1],E=u[2]);var W=C-O,q=U-V,R=D-N,_=L-O,j=z-V,w=E-N,G=A*w-j*B,H=B*_-w*I,X=I*j-_*A,Y=W*G+q*H+R*X;if(!(Math.abs(Y)<=M)){var Z=g-O,k=x-V,F=h-N,J=Z*G+k*H+F*X;if(Y>0){if(J<0||J>Y)continue}else if(J>0||J<Y)continue;var K=k*R-q*F,Q=F*W-R*Z,$=Z*q-W*k,ee=I*K+A*Q+B*$;if(Y>0){if(ee<0||J+ee>Y)continue}else if(ee>0||J+ee<Y)continue;var te=(_*K+j*Q+w*$)/Y;if(te>=0)s(te,y(W,q,R,_,j,w,b),T)}}}t.intersectTriangles=h;var I=f.vec3f64.create(),A=f.vec3f64.create();function y(e,t,r,i,n,a,o){return c.vec3.set(I,e,t,r),c.vec3.set(A,i,n,a),c.vec3.cross(o,I,A),c.vec3.normalize(o,o),o}function B(e,t,r){return c.vec3.set(r,1/(t[0]-e[0]),1/(t[1]-e[1]),1/(t[2]-e[2]))}function T(e,t,r,i){return S(e,t,r,i,1/0)}function S(e,t,r,i,n){var a=(e[0]-i-t[0])*r[0],o=(e[3]+i-t[0])*r[0],c=Math.min(a,o),f=Math.max(a,o),s=(e[1]-i-t[1])*r[1],v=(e[4]+i-t[1])*r[1];if((f=Math.min(f,Math.max(s,v)))<0)return!1;if((c=Math.max(c,Math.min(s,v)))>f)return!1;var l=(e[2]-i-t[2])*r[2],u=(e[5]+i-t[2])*r[2];return!((f=Math.min(f,Math.max(l,u)))<0)&&(!((c=Math.max(c,Math.min(l,u)))>f)&&c<n)}function P(e){var t=[];return e.forEach((function(e){return t.push(e)})),t}t.computeNormal=y,t.computeInvDir=B,t.intersectAabbInvDir=T,t.intersectAabbInvDirBefore=S,t.transformToWorld=function(e,t,r){return s.vec4.set(r,e[0]-t[0],e[1]-t[1],e[2]-t[2],1)},t.transformToView=function(e,t,r,i){return a.mat4.translate(p,r,t),s.vec4.transformMat4(i,e,p)},t.transformToProjection=function(e,t,r,i){return i[0]=e[0]+r[0],i[1]=e[1]+r[1],i[2]=e[2]+r[2],i[3]=e[3],s.vec4.transformMat4(i,i,t)},t.transformToNDC=function(e,t){return s.vec4.scale(t,e,1/Math.abs(e[3]))},t.verticalOffsetAtDistance=function(e,t,r,n,a){var o=(r.screenLength||0)*e.pixelRatio;a&&(o=u.scale(o,n,t,a));var c=o*Math.tan(.5*e.fovY)/(.5*e.fullHeight);return i.glClamp(c*t,r.minWorldLength||0,null!=r.maxWorldLength?r.maxWorldLength:1/0)},t.acquireIfNotUndefined=function(e,t,r){if(void 0!==e)return t.acquire(e,r)},t.releaseIfNotUndefined=function(e,t){void 0!==e&&t.release(e)},t.bindScreenSizePerspective=function(e,t,r){if(void 0===r&&(r="screenSizePerspectiveAlignment"),e){var i=e.parameters,n=e.paddingPixelsOverride;t.setUniform4f(r,i.divisor,i.offset,i.minPixelSize,n)}},t.copyParameters=function e(t,r){var i=r?e(r):{};for(var n in t){var a=t[n];a&&a.forEach&&(a=P(a)),null==a&&n in i||(i[n]=a)}return i},t.updateParameters=function(e,t){var r=!1;for(var i in t){var n=t[i];void 0!==n&&(r=!0,Array.isArray(n)?e[i]=n.slice():e[i]=n)}return r},t.intersectDrapedRenderLineGeometry=function(e,t,r,n,a){if(t.options.selectionMode){for(var o=e.getAttribute(g.POSITION).data,c=e.getAttribute(g.SIZE),f=c&&c.data[0],s=r[0],v=r[1],l=((f+n)/2+4)*e.pixelRatio,u=Number.MAX_VALUE,m=0;m<o.length-5;m+=3){var p=o[m],d=o[m+1],x=s-p,M=v-d,b=o[m+3]-p,h=o[m+4]-d,I=b*x+h*M,A=b*b+h*h,y=i.clamp(I/A,0,1),B=b*y-x,T=h*y-M,S=B*B+T*T;S<u&&(u=S)}u<l*l&&a()}},t.colorMixModes={multiply:1,ignore:2,replace:3,tint:4};var O=1e3}));