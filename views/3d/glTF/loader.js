// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/awaiterHelper","../../../core/tsSupport/generatorHelper","../../../core/tsSupport/assignHelper","../../../core/maybe","../../../core/promiseUtils","../../../core/libs/gl-matrix-2/mat4f64","./DefaultErrorContext","./LoaderResult","./internal/Resource"],(function(e,t,r,s,o,a,n,i,l,u,c){Object.defineProperty(t,"__esModule",{value:!0});var d=0;function m(e){var t=e.json,r=null;return t.nodes.forEach((function(e){var t=e.extras;a.isSome(t)&&(t.ESRI_proxyEllipsoid||t.ESRI_lod)&&(r=t)})),r}function p(e,t){return r(this,void 0,void 0,(function(){function o(n,i){return r(this,void 0,void 0,(function(){var r,l,u,c,d,m,p,h;return s(this,(function(s){switch(s.label){case 0:if(r=a.nodes[n],l=e.getNodeTransform(n),x.warnUnsupportedIf(null!=r.weights,"Morph targets are not supported."),null==r.mesh)return[3,4];u=a.meshes[r.mesh],c=0,d=u.primitives,s.label=1;case 1:return c<d.length?(m=d[c],[4,t(m,l,i,u.name)]):[3,4];case 2:s.sent(),s.label=3;case 3:return c++,[3,1];case 4:p=0,h=r.children||[],s.label=5;case 5:return p<h.length?[4,o(h[p],i)]:[3,8];case 6:s.sent(),s.label=7;case 7:return p++,[3,5];case 8:return[2]}}))}))}var a,i,l,u,c,d,m,p,h,f;return s(this,(function(t){switch(t.label){case 0:a=e.json,i=a.scenes[a.scene||0],l=i.nodes,u=l.length>1,c=0,d=l,t.label=1;case 1:return c<d.length?(m=d[c],p=a.nodes[m],h=[o(m,0)],function(e){return e.extensions&&e.extensions.MSFT_lod&&Array.isArray(e.extensions.MSFT_lod.ids)}(p)&&!u&&(f=p.extensions.MSFT_lod.ids,h.push.apply(h,f.map((function(e,t){return o(e,t+1)})))),[4,n.all(h)]):[3,4];case 2:t.sent(),t.label=3;case 3:return c++,[3,1];case 4:return[2]}}))}))}function h(e){if(33071===e||33648===e||10497===e)return e;x.error("Unexpected TextureSampler WrapMode: "+e)}t.load=function(e,t,o){return void 0===o&&(o={}),r(this,void 0,void 0,(function(){var n,l,S,T,g=this;return s(this,(function(b){switch(b.label){case 0:return[4,c.Resource.load(e,x,t,o)];case 1:return n=b.sent(),l="gltf_"+d++,S={lods:[],materials:new Map,textures:new Map,meta:m(n)},T=!(!n.json.asset.extras||"symbolResource"!==n.json.asset.extras.ESRI_type),[4,p(n,(function(e,t,c,d){return r(g,void 0,void 0,(function(){var r,m,p,T,g,b,_,R,I,E,M;return s(this,(function(s){switch(s.label){case 0:return r=void 0!==e.mode?e.mode:4,m=function(e){switch(e){case 4:case 5:case 6:return e;default:return null}}(r),a.isNone(m)?(x.warnUnsupported("Unsupported primitive mode ("+v[r]+"). Skipping primitive."),[2]):n.hasPositions(e)?[4,n.getMaterial(e,o)]:(x.warn("Skipping primitive without POSITION vertex attribute."),[2]);case 1:return p=s.sent(),g={transform:i.mat4f64.clone(t)},b={},[4,n.getPositionData(e,o)];case 2:return g.attributes=(b.position=s.sent(),b.normal=null,b.texCoord0=null,b.color=null,b.tangent=null,b),[4,n.getIndexData(e,o)];case 3:return g.indices=s.sent(),g.primitiveType=m,g.material=function(e,t,r){var s=function(t){var s=r+"_tex_"+(t&&t.id)+(t&&t.name?"_"+t.name:"");if(t&&!e.textures.has(s)){var o=u.makeTextureSource(t.data,{wrap:{s:h(t.wrapS),t:h(t.wrapT)},mipmap:f.some((function(e){return e===t.minFilter})),noUnpackFlip:!0});e.textures.set(s,o)}return s},o=r+"_mat_"+t.id+"_"+t.name;if(!e.materials.has(o)){var a=u.makeMaterialParameters({color:[t.color[0],t.color[1],t.color[2]],opacity:t.color[3],alphaMode:t.alphaMode,alphaCutoff:t.alphaCutoff,doubleSided:t.doubleSided,colorMixMode:t.ESRI_externalColorMixMode,textureColor:t.colorTexture?s(t.colorTexture):void 0,textureNormal:t.normalTexture?s(t.normalTexture):void 0,textureOcclusion:t.occlusionTexture?s(t.occlusionTexture):void 0,textureEmissive:t.emissiveTexture?s(t.emissiveTexture):void 0,textureMetallicRoughness:t.metallicRoughnessTexture?s(t.metallicRoughnessTexture):void 0,emissiveFactor:[t.emissiveFactor[0],t.emissiveFactor[1],t.emissiveFactor[2]],metallicFactor:t.metallicFactor,roughnessFactor:t.roughnessFactor});e.materials.set(o,a)}return o}(S,p,l),T=g,n.hasNormals(e)?(_=T.attributes,[4,n.getNormalData(e,o)]):[3,5];case 4:_.normal=s.sent(),s.label=5;case 5:return n.hasTangents(e)?(R=T.attributes,[4,n.getTangentData(e,o)]):[3,7];case 6:R.tangent=s.sent(),s.label=7;case 7:return n.hasTextureCoordinates(e)?(I=T.attributes,[4,n.getTextureCoordinates(e,o)]):[3,9];case 8:I.texCoord0=s.sent(),s.label=9;case 9:return n.hasVertexColors(e)?(E=T.attributes,[4,n.getVertexColors(e,o)]):[3,11];case 10:E.color=s.sent(),s.label=11;case 11:return M=null,a.isSome(S.meta)&&a.isSome(S.meta.ESRI_lod)&&"screenSpaceRadius"===S.meta.ESRI_lod.metric&&(M=S.meta.ESRI_lod.thresholds[c]),S.lods[c]=S.lods[c]||{parts:[],name:d,lodThreshold:M},S.lods[c].parts.push(T),[2]}}))}))}))];case 2:return b.sent(),[2,{model:S,meta:{isEsriSymbolResource:T,uri:n.uri},customMeta:{}}]}}))}))};var x=new l.DefaultErrorContext,f=[9987,9985],v=["POINTS","LINES","LINE_LOOP","LINE_STRIP","TRIANGLES","TRIANGLE_STRIP","TRIANGLE_FAN"]}));