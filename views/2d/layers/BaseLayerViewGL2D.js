// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","../../../core/tsSupport/generatorHelper","../../../core/tsSupport/awaiterHelper","../../../core/accessorSupport/decorators","../../../core/libs/earcut/earcut","../../../geometry/support/aaBoundingRect","../../../geometry/support/coordsUtils","../../../layers/graphics/data/projectionSupport","../tiling","../engine/webgl/TurboLine","./LayerView2D","./graphics/graphicsUtils","./support/DisplayGL","./support/util","../../layers/LayerView","../../layers/RefreshableLayerView"],(function(e,t,r,n,i,o,s,c,a,u,l,p,f,h,d,y,v,x,g){var w=new Set,m=[],T=[],b=function(e,t,r,n,i,o,s,c,u){void 0===c&&(c=[0,0]),void 0===u&&(u=a.create()),this.id=e,this.level=t,this.row=r,this.col=n,this.world=i,this.resolution=o,this.scale=s,this.coords=c,this.bounds=u},O=function(e){function t(t){var r=e.call(this,t)||this;return r._tileMap=new Map,r.container=new y.default(r),r.layer=null,r.tiles=[],r._renderTarget={framebufferObject:null,viewport:[0,0,0,0]},r}return r(t,e),Object.defineProperty(t.prototype,"_tileInfoView",{get:function(){var e=this.layer&&this.layer.tileInfo;return e?new p.TileInfoView(e):null},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"context",{get:function(){return this.container&&this.container.stage&&this.container.stage.context.gl},enumerable:!0,configurable:!0}),t.prototype.attach=function(){},t.prototype.detach=function(){},t.prototype.requestRender=function(){this.container.requestRender()},t.prototype.doRefresh=function(){return o(this,void 0,void 0,(function(){return i(this,(function(e){return[2]}))}))},t.prototype.isUpdating=function(){return!1},t.prototype.update=function(e){var t=this._tileInfoView,r=this.tiles;if(t){var n=t.getTileCoverage(e.state,0),i=n.spans,o=n.lodInfo,s=o.level;if(i.length)for(var c=0,a=i;c<a.length;c++)for(var u=a[c],l=u.row,p=u.colFrom,f=u.colTo,h=p;h<=f;h++){var d=o.normalizeCol(h),y=o.getWorldForColumn(h),v=s+"/"+l+"/"+d+"/"+y;if(!this._tileMap.has(v)){var x=new b(v,s,l,d,y,o.resolution,o.scale);o.getTileCoords(x.coords,x,!1),o.getTileBounds(x.bounds,x,!0),this._tileMap.set(v,x),r.push(x),m.push(x)}w.add(v)}}for(var g=r.length-1;g>=0;g--){x=r[g];w.has(x.id)||(r.splice(g,1),T.push(x),this._tileMap.delete(x.id))}(m.length||T.length)&&(this.tilesChanged(m,T),m.length=T.length=0),w.clear(),this.requestRender()},t.prototype.moveStart=function(){},t.prototype.viewChange=function(){this.requestUpdate()},t.prototype.moveEnd=function(){},t.prototype.bindRenderTarget=function(){this.context.bindFramebuffer(this.context.FRAMEBUFFER,this._renderTarget.framebufferObject),this.context.viewport(this._renderTarget.viewport[0],this._renderTarget.viewport[1],this._renderTarget.viewport[2],this._renderTarget.viewport[3])},t.prototype.getRenderTarget=function(){return this._renderTarget},t.prototype.tessellateExtent=function(e){return o(this,void 0,void 0,(function(){var t,r,n;return i(this,(function(i){switch(i.label){case 0:return t={vertices:[],indices:[]},[4,this._projectAndNormalizeGeometry(e)];case 1:return r=i.sent(),n=t.vertices.length,t.vertices.push({x:r.xmin,y:r.ymin,xOffset:0,yOffset:0,uTexcoord:0,vTexcoord:0,distance:0}),t.vertices.push({x:r.xmax,y:r.ymin,xOffset:0,yOffset:0,uTexcoord:1,vTexcoord:0,distance:0}),t.vertices.push({x:r.xmin,y:r.ymax,xOffset:0,yOffset:0,uTexcoord:0,vTexcoord:1,distance:0}),t.vertices.push({x:r.xmax,y:r.ymax,xOffset:0,yOffset:0,uTexcoord:1,vTexcoord:1,distance:0}),t.indices.push(n+0,n+1,n+2,n+1,n+3,n+2),[2,t]}}))}))},t.prototype.tessellatePoint=function(e,t){return o(this,void 0,void 0,(function(){var r;return i(this,(function(n){switch(n.label){case 0:return[4,this._projectAndNormalizeGeometry(e)];case 1:return r=n.sent(),[2,this._tessellatePoints([r],t)]}}))}))},t.prototype.tessellateMultipoint=function(e,t){return o(this,void 0,void 0,(function(){var r,n;return i(this,(function(i){switch(i.label){case 0:return[4,this._projectAndNormalizeGeometry(e)];case 1:return r=i.sent(),n=r.points.map((function(e){return{x:e[0],y:e[1],spatialReference:r.spatialReference}})),[2,this._tessellatePoints(n,t)]}}))}))},t.prototype._tessellatePoints=function(e,t){return o(this,void 0,void 0,(function(){var r,n,o,s,c;return i(this,(function(i){for(r={vertices:[],indices:[]},n=0,o=e;n<o.length;n++)s=o[n],c=r.vertices.length,r.vertices.push({x:s.x,y:s.y,xOffset:t.x,yOffset:t.y+t.height,uTexcoord:0,vTexcoord:0,distance:0}),r.vertices.push({x:s.x,y:s.y,xOffset:t.x+t.width,yOffset:t.y+t.height,uTexcoord:1,vTexcoord:0,distance:0}),r.vertices.push({x:s.x,y:s.y,xOffset:t.x,yOffset:t.y,uTexcoord:0,vTexcoord:1,distance:0}),r.vertices.push({x:s.x,y:s.y,xOffset:t.x+t.width,yOffset:t.y,uTexcoord:1,vTexcoord:1,distance:0}),r.indices.push(c+0,c+1,c+2,c+1,c+3,c+2);return[2,r]}))}))},t.prototype.tessellatePolyline=function(e,t){return o(this,void 0,void 0,(function(){var r,n,o,s,c,a,u,l,p,h,d,y;return i(this,(function(i){switch(i.label){case 0:return r={vertices:[],indices:[]},[4,this._projectAndNormalizeGeometry(e)];case 1:if(n=i.sent(),!(o=n.paths)||!o.length)return[2,r];for(c=new f.StandardTessellationCallbacks((function(e,n,i,o,c,a,u,l,p){var f=r.vertices.length;return r.vertices.push({x:e,y:-n,xOffset:c*t/2,yOffset:a*t/2,uTexcoord:p/s,vTexcoord:(l+1)/2,distance:p}),f}),(function(e,t,n){r.indices.push(e,t,n)})),a=0,u=o;a<u.length;a++){for(l=u[a],s=0,p=1;p<l.length;++p)h=l[p][0]-l[p-1][0],d=l[p][1]-l[p-1][1],s+=Math.sqrt(h*h+d*d);y=l.map((function(e){return{x:e[0],y:-e[1]}})),f.tessellate(y,_,c)}return[2,r]}}))}))},t.prototype.tessellatePolygon=function(e){return o(this,void 0,void 0,(function(){var t,r,n,o,s,c,a,l,p,f,h,d,y,x=this;return i(this,(function(i){switch(i.label){case 0:return t={vertices:[],indices:[]},[4,this._projectAndNormalizeGeometry(e)];case 1:if(r=i.sent(),!(n=r.rings)||!n.length)return[2,t];for(u.closeRings(r),o=0,s=r.rings;o<s.length;o++)for(c=s[o],a=0,l=c;a<l.length;a++)(p=l[a])[1]=-p[1];return f=1/0,h=1/0,d=-1/0,y=-1/0,v.analyzeRings(r.rings,(function(){}),(function(e,t,r){for(var n=e;n<t;n+=2)f=Math.min(f,r[n]),h=Math.min(h,r[n+1]),d=Math.max(d,r[n]),y=Math.max(y,r[n+1])})),v.analyzeRings(r.rings,(function(){}),(function(e,r,n,i){x._invokeEarcut(t,e,r,n,i,[f,h,d,y])})),[2,t]}}))}))},t.prototype._invokeEarcut=function(e,t,r,n,i,o){for(var s=n.slice(t,r),a=c.earcut(s,i,2),u=e.vertices.length,l=0;l<s.length;l+=2){var p=s[l],f=s[l+1];e.vertices.push({x:p,y:-f,xOffset:0,yOffset:0,uTexcoord:(p-o[0])/(o[2]-o[0]),vTexcoord:1-(f-o[1])/(o[3]-o[1]),distance:0})}for(l=0;l<a.length;++l)e.indices.push(u+a[l])},t.prototype._projectAndNormalizeGeometry=function(e){return o(this,void 0,void 0,(function(){var t;return i(this,(function(r){switch(r.label){case 0:return[4,l.checkProjectionSupport(e.spatialReference,this.view.spatialReference)];case 1:return r.sent(),t=d.normalizeCentralMeridian(e),[2,l.project(t,e.spatialReference,this.view.spatialReference)]}}))}))},n([s.property({dependsOn:["layer.loaded"]})],t.prototype,"_tileInfoView",null),n([s.property()],t.prototype,"container",void 0),n([s.property()],t.prototype,"layer",void 0),n([s.property({dependsOn:["container.stage"]})],t.prototype,"context",null),t=n([s.subclass("esri.views.2d.layers.BaseLayerViewGL2D")],t)}(s.declared(g.RefreshableLayerView(h.LayerView2D(x)))),_={trackDistance:!0,wrapDistance:1e11,thin:!1,initialDistance:0,enableOuterBisectorSplit:!0,outerBisectorAutoSplitThreshold:1/3.8,enableInnerBisectorSplit:!0,innerBisectorAutoSplitThreshold:1/3.8};return O}));