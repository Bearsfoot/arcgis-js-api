// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/assignHelper","../../../../core/has","../../../../core/screenUtils","../../../../core/unitUtils","../../../../core/libs/rbush/rbush","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/contains","../../../../geometry/support/extentUtils","../../../../geometry/support/jsonUtils","../../../../geometry/support/normalizeUtils","./GraphicStoreItem","./graphicsUtils"],(function(e,t,r,i,o,n,s,u,a,l,p,d,h,c){Object.defineProperty(t,"__esModule",{value:!0});var m={minX:0,minY:0,maxX:0,maxY:0},g=u.create(),y=[];function f(e,t,r,i,o){return m.minX=t,m.minY=r,m.maxX=i,m.maxY=o,e.search(m)}var b=function(){function e(e,t,r,o,u,a){this._graphics=o,this._onAdd=u,this._onRemove=a,this._index=s(9,i("csp-restrictions")?function(e){return{minX:e.bounds[0],minY:e.bounds[1],maxX:e.bounds[2],maxY:e.bounds[3]}}:[".bounds[0]",".bounds[1]",".bounds[2]",".bounds[3]"]),this._itemByGraphic=new Map,this._currentLevel=-1/0,this._tileInfoView=e,this._uidFieldName=r;var l=e.getClosestInfoForScale(t);l&&(this._currentLevel=l.level,this._resolution=this._tileInfoView.getTileResolution(l.level)),this._metersPerUnit=n.getMetersPerUnit(e.spatialReference)}return e.prototype.hitTest=function(e,t,r,i,n){e=d.normalizeMapX(e,this._tileInfoView.spatialReference);var s=.5*i*r;g[0]=e-s,g[1]=t-s,g[2]=e+s,g[3]=t+s;var h=.5*i*(r+50),m=f(this._index,e-h,t-h,e+h,t+h);if(!m||0===m.length)return[];for(var y,b={x:e,y:t},_=[],v=0,x=m;v<x.length;v++){var G=x[v];if(G.graphic.visible)switch(p.getJsonType(G.geometry)){case"esriGeometryPoint":var B=G.symbol;if(!B)continue;var I=G.geometry,P=void 0;switch(B.type){case"text":P=c.getTextSymbolBounds(I.x,I.y,B,G.size,i,n);break;case"cim":case"expanded-cim":P=c.getCIMMarkerBounds(I.x,I.y,B,i,i*this._metersPerUnit,n);break;default:P=c.getMarkerSymbolBounds(I.x,I.y,B,i,i*this._metersPerUnit,n)}a.polygonContainsPoint(P,b)&&_.push(G);break;case"esriGeometryPolyline":var z=G.symbol;if(!z)continue;y=1.5*i*window.devicePixelRatio*o.pt2px(z.width),c.isPointOnPolyline(G.geometry,e,t,y)&&_.push(G);break;case"esriGeometryEnvelope":var w=G.geometry,T=u.fromValues(w.xmin,w.ymin,w.xmax,w.ymax);u.intersects(T,g)&&_.push(G);break;case"esriGeometryPolygon":if(a.polygonContainsPoint(G.geometry,b)){_.push(G);break}var U=l.getPolygonExtent(G.geometry);if(Math.abs(U.ymax-U.ymin)<5*i||Math.abs(U.xmax-U.xmin)<5*i){var k=u.fromValues(U.xmin,U.ymin,U.xmax,U.ymax);u.intersects(k,g)&&_.push(G)}break;case"esriGeometryMultipoint":var M=G.symbol;if(!M)continue;for(var R=G.geometry.points,V=void 0,A=0;A<R.length;A++){if("text"===M.type){var C=M;V=c.getTextSymbolBounds(R[A][0],R[A][1],C,G.size,i,n)}else V=c.getMarkerSymbolBounds(R[A][0],R[A][1],M,i,i*this._metersPerUnit,n);if(a.polygonContainsPoint(V,b)){_.push(G);break}}}}return _.sort((function(e,t){var r=c.graphicGeometryToNumber(e.graphic),i=c.graphicGeometryToNumber(t.graphic);return r===i?t.zorder-e.zorder:r-i})),_.map((function(e){return e.graphic}))},e.prototype.getGraphicsData=function(e,t,i){var o=f(this._index,t.bounds[0],t.bounds[1],t.bounds[2],t.bounds[3]);if(0===o.length||0===i.length)return[];o.sort((function(e,t){return e.zorder-t.zorder})),o[0].insertAfter=-1;for(var n=1;n<o.length;n++)o[n].insertAfter=o[n-1].graphic.uid;o.sort((function(e,t){return e.graphic.uid-t.graphic.uid})),i.sort((function(e,t){return e.uid-t.uid}));for(var s,u=0,a=0,l=[],p={originPosition:"upperLeft",scale:[t.resolution,t.resolution],translate:[t.bounds[0],t.bounds[3]]},d=0,c=i;d<c.length;d++){var m=c[d];for(a=-2;u<o.length;)if(s=o[u],u++,m.uid===s.graphic.uid){a=s.insertAfter;break}if(s.geometry&&-2!==a){var g=s.getGeometryQuantized(p),y=r({},s.graphic.attributes);y[this._uidFieldName]=m.uid,null==s.groupId&&(s.groupId=e.createTemplateGroup(s.symbol,null,null)),l.push({centroid:h.default.getCentroidQuantized(s,p),geometry:g,attributes:y,symbol:s.symbol,groupId:s.groupId,insertAfter:a})}}return l},e.prototype.getGraphicData=function(e,t,i){var o=this._itemByGraphic.get(i);if(!o)return null;var n=f(this._index,t.bounds[0],t.bounds[1],t.bounds[2],t.bounds[3]);n.sort((function(e,t){return e.zorder-t.zorder}));var s=n.indexOf(o),u=0===s||-1===s?-1:n[s-1].graphic.uid,a={originPosition:"upperLeft",scale:[t.resolution,t.resolution],translate:[t.bounds[0],t.bounds[3]]},l=o.getGeometryQuantized(a),p=r({},o.graphic.attributes);return p[this._uidFieldName]=i.uid,null==o.groupId&&(o.groupId=e.createTemplateGroup(o.symbol,null,null)),{centroid:h.default.getCentroidQuantized(o,a),geometry:l,attributes:p,symbol:o.symbol,groupId:o.groupId,insertAfter:u}},e.prototype.queryTileData=function(e,t){var r=50*t.resolution,i=u.pad(t.bounds,r,u.create()),o=f(this._index,i[0],i[1],i[2],i[3]),n=[];return this._createTileGraphics(n,e,o,{originPosition:"upperLeft",scale:[t.resolution,t.resolution],translate:[t.bounds[0],t.bounds[3]]}),n},e.prototype.has=function(e){return this._itemByGraphic.has(e)},e.prototype.getBounds=function(e){return this._itemByGraphic.has(e)?this._itemByGraphic.get(e).bounds:null},e.prototype.add=function(e,t,r){if(e){this._onAdd(e);var i=h.default.acquire(e,t,r,this._resolution,this._resolution*this._metersPerUnit,this._tileInfoView.spatialReference);return this._itemByGraphic.set(e,i),r&&this._index.insert(i),i.bounds}},e.prototype.remove=function(e){if(this._itemByGraphic.has(e)){this._onRemove(e);var t=this._itemByGraphic.get(e);this._index.remove(t),this._itemByGraphic.delete(e)}},e.prototype.updateZ=function(){for(var e,t,r=this._graphics.items,i=0;i<r.length;i++)t=r[i],(e=this._itemByGraphic.get(t))&&(e.zorder=i)},e.prototype.update=function(e,t,r){var i=this._itemByGraphic.get(e);i.groupId=null;var o=u.clone(i.bounds);return i.size[0]=i.size[1]=0,this._index.remove(i),i.set(e,t,r,this._resolution,this._resolution*this._metersPerUnit,this._tileInfoView.spatialReference),r&&this._index.insert(i),{oldBounds:o,newBounds:i.bounds}},e.prototype.updateLevel=function(e){var t=this;if(this._currentLevel!==e){this._currentLevel=e;var r=this._tileInfoView.getTileResolution(e);this._resolution=r,this._index.clear(),y.length=0,this._itemByGraphic.forEach((function(e){e.updateBounds(t._resolution,t._resolution*t._metersPerUnit,t._tileInfoView.spatialReference),e.geometry&&y.push(e)})),this._index.load(y)}},e.prototype.clear=function(){this._itemByGraphic.clear(),this._index.clear()},e.prototype._createTileGraphics=function(e,t,i,o){var n,s,u,a,l=this._uidFieldName;i.sort((function(e,t){return e.zorder-t.zorder}));for(var p=0;p<i.length;p++){n=(u=i[p]).graphic,s=u.getGeometryQuantized(o),a=0===p?-1:i[p-1].graphic.uid;var d=r({},u.graphic.attributes);d[l]=n.uid,null==u.groupId&&(u.groupId=t.createTemplateGroup(u.symbol,null,null)),e.push({centroid:h.default.getCentroidQuantized(u,o),geometry:s,attributes:d,symbol:u.symbol,groupId:u.groupId,insertAfter:a})}},e}();t.default=b}));