// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../core/tsSupport/assignHelper","../../../../core/Error","../../../../core/has","../../../../core/Logger","../../../../core/maybe","../../../../core/MD5","../../../../renderers/visualVariables/SizeVariable","../../../../renderers/visualVariables/support/SizeStop","../../engine"],(function(e,r,i,t,a,n,l,s,u,o,c,d,p){var f=this;Object.defineProperty(r,"__esModule",{value:!0});var v=s.getLogger("esri.views.2d.layers.support.clusterUtils");l.add("esri-cluster-arcade-enabled",1);var m=l("esri-cluster-arcade-enabled");function g(e,r,i){var t=o.createMD5Hash(r),a="mode"===i?"cluster_type_"+t:"cluster_avg_"+t;return e.some((function(e){return e.name===a}))||e.push({name:a,outStatistic:{onStatisticField:t,onStatisticValueExpression:r,statisticType:i}}),a}function b(e,r,i,t){var a=function(e,r,i){switch(e){case"avg":case"avg_angle":return"cluster_avg_"+r;case"mode":return"cluster_type_"+r;case"norm":var t=i,a=r.toLowerCase()+",norm:field,"+t.toLowerCase();return"cluster_avg_"+o.createMD5Hash(a)}}(i,r,t);return e.some((function(e){return e.name===a}))||("norm"===i?e.push({name:a,outStatistic:{onStatisticField:r,onStatisticNormalizationField:t,statisticType:i}}):e.push({name:a,outStatistic:{onStatisticField:r,statisticType:i}})),a}r.createClusterRenderer=function(e,a,n,l,s){return t(f,void 0,void 0,(function(){var t,a,o;return i(this,(function(i){if(t=n.clone(),!r.isClusterCompatibleRenderer(t))return[2,t];switch(a="visualVariables"in t&&t.visualVariables||[],o=r.findSizeVV(a),a.forEach((function(r){"rotation"===r.type?r.field?r.field=b(e,r.field,"avg_angle"):r.valueExpression&&(r.field=g(e,r.valueExpression,"avg_angle"),r.valueExpression=null):r.normalizationField?(r.field=b(e,r.field,"norm",r.normalizationField),r.normalizationField=null):r.field?r.field=b(e,r.field,"avg"):(r.field=g(e,r.valueExpression,"avg"),r.valueExpression=null)})),u.isNone(o)&&a.push(r.createClusterCountSizeVariable(l,s)),t.type){case"simple":break;case"unique-value":t.field?t.field=b(e,t.field,"mode"):t.valueExpression&&(t.field=g(e,t.valueExpression,"mode"),t.valueExpression=null);break;case"class-breaks":t.normalizationField?(t.field=b(e,t.field,"norm",t.normalizationField),t.normalizationField=null):t.field?t.field=b(e,t.field,"avg"):(t.field=g(e,t.valueExpression,"avg"),t.valueExpression=null)}return t.visualVariables=a,[2,t]}))}))},r.findSizeVV=function(e){for(var r=0,i=e;r<i.length;r++){var t=i[r];if("size"===t.type)return t}return null},r.getActiveSizeStops=function(e,r){var i=e.featuresTilingScheme.getClosestInfoForScale(e.scale).level;return r.levels?r.levels[i]:null},r.createClusterCountSizeVariable=function(e,r){var i=[new d({value:0,size:0}),new d({value:1})];if(u.isNone(r))return new c({field:"cluster_count",stops:i.concat([new d({value:2,size:0})])});var t=Object.keys(r).reduce((function(e,t){var n;return a({},e,((n={})[t]=i.concat([new d({value:Math.max(2,r[t].minValue),size:"12px"}),new d({value:Math.max(3,r[t].maxValue),size:"50px"})]),n))}),{});return new p.LevelDependentSizeVariable({field:"cluster_count",levels:t})},r.isClusterCompatibleRenderer=function(e){var r=function(r){return v.error(new n("Unsupported-renderer",r,{renderer:e}))};if("unique-value"===e.type){if(e.field2||e.field3)return r("FeatureReductionCluster does not support multi-field UniqueValueRenderers"),!1}else if("class-breaks"===e.type){if(e.normalizationField){var i=e.normalizationType;if("field"!==i)return r("FeatureReductionCluster does not support a normalizationType of "+i),!1}}else if("simple"!==e.type)return r("FeatureReductionCluster does not support renderers of type "+e.type),!1;if(!m){if("valueExpression"in e&&e.valueExpression)return r("FeatureReductionCluster does not currently support renderer.valueExpression. Support will be added in a future release"),!1;if(("visualVariables"in e&&e.visualVariables||[]).some((function(e){return!!("valueExpression"in e&&e.valueExpression)})))return r("FeatureReductionCluster does not currently support visualVariables with a valueExpression. Support will be added in a future release"),!1}return!0}}));