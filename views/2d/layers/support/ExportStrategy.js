// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/assignHelper","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../core/tsSupport/declareExtendsHelper","../../../../core/tsSupport/decorateHelper","../../../../core/Accessor","../../../../core/promiseUtils","../../../../core/accessorSupport/decorators","../../../../geometry/Extent","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/spatialReferenceUtils","../../../../layers/support/TileInfo","../../engine","../../viewStateUtils","../../tiling/TileInfoView","../../tiling/TileKey"],(function(e,t,r,o,i,n,p,a,s,u,l,c,d,h,g,m,f,y){var x=c.create(),v=[0,0],S=new y(0,0,0,0),_=2048,R=2048,M=!1,E=!1,w=!1;return function(e){function t(t){var r=e.call(this,t)||this;return r._imagePromise=null,r.hidpi=w,r.imageMaxWidth=_,r.imageMaxHeight=R,r.imageRotationSupported=M,r.imageNormalizationSupported=E,r.update=s.debounce((function(e,t){return i(r,void 0,void 0,(function(){var r,i,n,p,a,s,u,l,c,h=this;return o(this,(function(o){return r=e.state,i=d.getInfo(r.spatialReference),n=this.hidpi?e.pixelRatio:1,!e.stationary||this.destroyed?[2]:(this.imageRotationSupported?(v[0]=r.size[0],v[1]=r.size[1]):m.getOuterSize(v,r),p=Math.floor(v[0]*n)>this.imageMaxWidth||Math.floor(v[1]*n)>this.imageMaxHeight,a=i&&(r.extent.xmin<i.valid[0]||r.extent.xmax>i.valid[1]),s=!this.imageNormalizationSupported&&a,u=!p&&!s,l=this.imageRotationSupported?r.rotation:0,u?this._imagePromise=this._singleExport(r,v,l,n,t):(c=Math.min(this.imageMaxWidth,this.imageMaxHeight),s&&(c=Math.min(r.worldScreenWidth,c)),this._imagePromise=this._tiledExport(r,c,l,n,t)),[2,this._imagePromise.then((function(e){h._imagePromise=null;var t=h.container.children.slice();h.container.removeAllChildren(),e.forEach(h.container.addChild,h.container),h.disposeSource&&t.forEach((function(e){h.disposeSource(e.source)}),h)})).catch((function(e){throw h._imagePromise=null,e}))])}))}))}),5e3),r}return n(t,e),t.prototype.destroy=function(){},Object.defineProperty(t.prototype,"updating",{get:function(){return null!==this._imagePromise},enumerable:!0,configurable:!0}),t.prototype.updateExports=function(e){for(var t=0,r=this.container.children;t<r.length;t++){var o=r[t];if(!o.visible||!o.attached)return;e(o)?console.error("ExportStrategy.updateExports doesn't support promise yet"):(o.invalidateTexture(),o.requestRender())}},t.prototype._export=function(e,t,r,o,i,n){var p=this;return s.resolve().then((function(){return p.fetchSource(e,Math.floor(t*i),Math.floor(r*i),{rotation:o,pixelRatio:i,signal:n})})).then((function(r){var n=new g.Bitmap(r);return n.x=e.xmin,n.y=e.ymax,n.resolution=e.width/t,n.rotation=o,n.pixelRatio=i,n}))},t.prototype._singleExport=function(e,t,r,o,i){m.getBBox(x,e.center,e.resolution,t);var n=new l(x[0],x[1],x[2],x[3],e.spatialReference);return this._export(n,t[0],t[1],r,o,i).then((function(e){return[e]}))},t.prototype._tiledExport=function(e,t,r,o,i){var n=this,p=h.create({size:t,spatialReference:e.spatialReference,scales:[e.scale]}),a=new f(p),u=a.getTileCoverage(e);if(!u)return null;var c=[];return u.forEach((function(p,s,u,d){S.set(p,s,u,d),a.getTileBounds(x,S);var h=new l(x[0],x[1],x[2],x[3],e.spatialReference);c.push(n._export(h,t,t,r,o,i))})),s.all(c)},p([u.property()],t.prototype,"_imagePromise",void 0),p([u.property()],t.prototype,"container",void 0),p([u.property()],t.prototype,"disposeSource",void 0),p([u.property()],t.prototype,"fetchSource",void 0),p([u.property()],t.prototype,"hidpi",void 0),p([u.property()],t.prototype,"imageMaxWidth",void 0),p([u.property()],t.prototype,"imageMaxHeight",void 0),p([u.property()],t.prototype,"imageRotationSupported",void 0),p([u.property()],t.prototype,"imageNormalizationSupported",void 0),p([u.property()],t.prototype,"requestUpdate",void 0),p([u.property({dependsOn:["_imagePromise"]})],t.prototype,"updating",null),t=p([u.subclass("esri.views.2d.layers.support.ExportStrategy")],t)}(u.declared(a))}));