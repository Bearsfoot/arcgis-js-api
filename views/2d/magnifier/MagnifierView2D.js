// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/extendsHelper","../../../core/tsSupport/awaiterHelper","../../../core/tsSupport/generatorHelper","../../../request","../../../core/promiseUtils","../../webgl","../engine"],(function(e,t,r,i,a,s,o,n,u){Object.defineProperty(t,"__esModule",{value:!0});n.enums.DataType,n.enums.Usage,n.enums.TextureSamplingMode,n.enums.TextureType,n.enums.TextureWrapMode,n.enums.PrimitiveType,n.enums.PixelFormat,n.enums.PixelType;var l=u.enums.WGLDrawPhase,h=function(t){function h(){var e=t.call(this)||this;return e.visible=!1,e}return r(h,t),h.prototype.destroy=function(){this._readbackTexture&&(this._readbackTexture.dispose(),this._readbackTexture=null,this._maskTexture.dispose(),this._maskTexture=null,this._overlayTexture.dispose(),this._overlayTexture=null,this._vertexArrayObject.dispose(),this._vertexArrayObject=null,this._program.dispose(),this._program=null,this._resourcesPromise=null)},Object.defineProperty(h.prototype,"magnifier",{get:function(){return this._magnifier},set:function(e){var t=this;this._magnifier=e,this._handle&&this._handle.remove(),this._handle=e.watch("version",(function(){t.visible=e.visible})),this.visible=e.visible},enumerable:!0,configurable:!0}),h.prototype.doRender=function(t){var r=this.stage.context;if(this._resourcesPromise){if(t.drawPhase===l.MAP&&this._canRender()){this._updateResources(r);var i=this._magnifier,a=1/i.factor,s=Math.ceil(a*this.overlay.width),o=Math.ceil(a*this.overlay.height),n=t.state.size,u=t.pixelRatio,h=u*n[0],p=u*n[1],d=i.position||{x:.5*n[0],y:.5*n[1]},m=u*d.x,c=p-u*d.y,f=.5*s,g=.5*o;f>m?m=f:m>=h-f&&(m=h-f-1),g>c?c=g:c>=p-g&&(c=p-g-1);var _=m-f,y=c-g,x=this._readbackTexture;r.bindTexture(x,0),r.gl.copyTexImage2D(x.descriptor.target,0,x.descriptor.pixelFormat,_,y,s,o,0);var v=this.stage.background&&this.stage.background.color,b=v?[v.a*v.r/255,v.a*v.g/255,v.a*v.b/255,v.a]:[1,1,1,1],T=(m+i.offsetX)/h*2-1,w=(c-i.offsetY)/p*2-1,k=this.overlay.width/h*2,M=this.overlay.height/p*2,P=this._program;r.bindVAO(this._vertexArrayObject),r.bindTexture(this._overlayTexture,6),r.bindTexture(this._maskTexture,7),r.bindProgram(P),P.setUniform4fv("u_background",b),P.setUniform1i("u_readbackTexture",0),P.setUniform1i("u_overlyTexture",6),P.setUniform1i("u_maskTexture",7),P.setUniform2f("u_drawPos",T,w),P.setUniform1f("u_width",k),P.setUniform1f("u_height",M),r.setStencilTestEnabled(!1),r.drawArrays(5,0,4),r.bindVAO()}}else this._resourcesPromise=this._loadResources(e.toUrl("../../../images/magnifier/mask.png"),e.toUrl("../../../images/magnifier/overlay.png"))},h.prototype._canRender=function(){return this.mask&&this.overlay&&null!=this._magnifier},h.prototype._loadResources=function(e,t){return i(this,void 0,void 0,(function(){var r,i,n;return a(this,(function(a){switch(a.label){case 0:return[4,o.all([s(e,{responseType:"image"}),s(t,{responseType:"image"})])];case 1:return r=a.sent(),i=r[0].data,n=r[1].data,this.mask=i,this.overlay=n,this.requestRender(),[2]}}))}))},h.prototype._updateResources=function(e){if(!this._readbackTexture){var t=1/this._magnifier.factor,r=Math.ceil(t*this.overlay.width),i=Math.ceil(t*this.overlay.height);this._program=u.createMagnifierProgram(e);var a=new Uint16Array([0,1,0,0,1,1,1,0]),s=u.magnifier.attributes;this._vertexArrayObject=new n.VertexArrayObject(e,s,{geometry:[{name:"a_pos",count:2,type:5123,offset:0,stride:4,normalized:!1,divisor:0}]},{geometry:n.BufferObject.createVertex(e,35044,a)}),this._overlayTexture=new n.Texture(e,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!0},this.overlay),this._maskTexture=new n.Texture(e,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!0},this.mask),this._readbackTexture=new n.Texture(e,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1,width:r,height:i})}},h}(u.DisplayObject);t.default=h}));