// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/generatorHelper","../../core/tsSupport/awaiterHelper","../../Viewpoint","../../core/Collection","../../core/maybe","../../core/promiseUtils","../../core/unitUtils","../../core/wgs84Constants","../../core/libs/gl-matrix-2/common","../../core/libs/gl-matrix-2/mat2d","../../core/libs/gl-matrix-2/mat2df64","../../core/libs/gl-matrix-2/vec2","../../core/libs/gl-matrix-2/vec2f64","../../geometry/Extent","../../geometry/Geometry","../../geometry/Point","../../geometry/SpatialReference","../../geometry/support/spatialReferenceUtils","../../geometry/support/webMercatorUtils","../../geometry/support/webMercatorUtils"],(function(e,t,r,n,a,c,o,i,s,u,l,f,m,y,v,g,d,p,x,b,h,M){Object.defineProperty(t,"__esModule",{value:!0});var w,S,R,G,A,P,j,T,B,z,k,q=u.wgs84Radius,F=180/Math.PI;function N(e,t,r,n){return n&&r&&!n.equals(r)&&h.canProject(n,r)&&n.isWebMercator?n.isWebMercator?function(e,t){var r=t[1];return r>89.99999?r=89.99999:r<-89.99999&&(r=-89.99999),r=Math.sin(l.common.toRadian(r)),y.vec2.set(e,l.common.toRadian(t[0])*q,.5*q*Math.log((1+r)/(1-r)))}(e,t):function(e,t,r){var n=l.common.toDegree(t[0]/q);return y.vec2.set(e,r?n:n-360*Math.floor((n+180)/360),l.common.toDegree(.5*Math.PI-2*Math.atan(Math.exp(-1*t[1]/q))))}(e,t):y.vec2.copy(e,t)}function V(e){return e.wkid?e:e.spatialReference||x.WGS84}function W(e,t){return t.type?y.vec2.set(e,t.x,t.y):y.vec2.copy(e,t)}function I(e){return s.getMetersPerUnitForSR(e)}function O(e,t){return Math.max(e.width/t[0],e.height/t[1])*_(e.spatialReference)}function E(e,t,a,s){return n(this,void 0,void 0,(function(){var n,u,l,f,m,y,v,x,b,M,w,S,R,G,A,P,j,T,B,z,k,q,F,N,V,W,I;return r(this,(function(r){switch(r.label){case 0:if(!e)return[2,null];if(Array.isArray(e)&&!e.length)return[2,null];if(c.isCollection(e)&&(e=e.toArray()),!Array.isArray(e)||!e.length||"object"!=typeof e[0])return[3,7];if(u=e.every((function(e){return"attributes"in e})),l=e.some((function(e){return!e.geometry})),f=e,!(u&&l&&t&&t.allLayerViews))return[3,2];for(m=new Map,y=0,v=e;y<v.length;y++)B=v[y],x=B.layer,b=m.get(x)||[],null!=(M=B.attributes[x.objectIdField])&&b.push(M),m.set(x,b);return w=[],m.forEach((function(e,r){var n=t.allLayerViews.find((function(e){return e.layer.id===r.id}));if("queryFeatures"in n){var a=r.createQuery();a.objectIds=e,a.returnGeometry=!0,w.push(n.queryFeatures(a))}})),[4,i.all(w)];case 1:for(S=r.sent(),R=[],G=0,A=S;G<A.length;G++)if((P=A[G])&&P.features&&P.features.length)for(j=0,T=P.features;j<T.length;j++)B=T[j],o.isSome(B.geometry)&&R.push(B.geometry);f=R,r.label=2;case 2:z=0,k=f,r.label=3;case 3:return z<k.length?[4,E(k[z],t,a,s)]:[3,6];case 4:s=r.sent(),r.label=5;case 5:return z++,[3,3];case 6:return[2,s];case 7:return Array.isArray(e)&&2===e.length&&"number"==typeof e[0]&&"number"==typeof e[1]?(n=new p(e),[3,12]):[3,8];case 8:return e instanceof d?(n=e,[3,12]):[3,9];case 9:return"geometry"in e?e.geometry?(n=e.geometry,[3,12]):[3,10]:[3,12];case 10:return e.layer?(q=e.layer,"queryFeatures"in(F=t.allLayerViews.find((function(e){return e.layer.id===q.id})))?((N=q.createQuery()).objectIds=[e.attributes[q.objectIdField]],N.returnGeometry=!0,[4,F.queryFeatures(N)]):[3,12]):[3,12];case 11:V=r.sent(),n=o.get(V,"features",0,"geometry"),r.label=12;case 12:if(o.isNone(n))return[2,null];if(!(W="point"===n.type?new g({xmin:n.x,ymin:n.y,xmax:n.x,ymax:n.y,spatialReference:n.spatialReference}):n.extent))return[2,null];if(I=h.canProject(W,a),!W.spatialReference.equals(a)&&I)W=h.project(W,a);else if(!I)return[2,null];return[2,s=s?s.union(W):W.clone()]}}))}))}function U(e,t){return n(this,void 0,void 0,(function(){var n,c,o,i,s,u,l,f,m,y,d,x,b,w,S,R,G,A,P,j;return r(this,(function(r){switch(r.label){case 0:return e&&t?(n=t.spatialReference,c=t.constraints,o=t.padding,i=t.viewpoint,s=t.size,u=o?s[0]-o.left-o.right:s[0],l=o?s[1]-o.top-o.bottom:s[1],f=[u,l],m=null,e instanceof a?m=e:e.viewpoint?m=e.viewpoint:e.target&&"esri.Viewpoint"===e.target.declaredClass&&(m=e.target),y=null,m&&m.targetGeometry?(y=m.targetGeometry,[3,10]):[3,1]):[2,new a({targetGeometry:new p,scale:0,rotation:0})];case 1:return e instanceof g?(y=e,[3,10]):[3,2];case 2:return e||e&&("center"in e||"extent"in e||"target"in e)?[4,E(e.center,t,n)]:[3,10];case 3:return(b=r.sent())?[3,5]:[4,E(e.extent,t,n)];case 4:b=r.sent(),r.label=5;case 5:return(x=b)?[3,7]:[4,E(e.target,t,n)];case 6:x=r.sent(),r.label=7;case 7:return(d=x)?[3,9]:[4,E(e,t,n)];case 8:d=r.sent(),r.label=9;case 9:y=d,r.label=10;case 10:return!y&&i&&i.targetGeometry?y=i.targetGeometry:!y&&t.extent&&(y=t.extent),w=V(y),n||(n=V(t.spatialReference||t.extent||y)),M.canProject(y,n)||!w||w.equals(n)?(S=W(v.vec2f64.create(),y.center?y.center:y),R=new p(N(S,S,w,n),n),G=null,G=m&&m.targetGeometry&&"point"===m.targetGeometry.type?m.scale:e.hasOwnProperty("scale")&&e.scale?e.scale:e.hasOwnProperty("zoom")&&-1!==e.zoom&&c&&c.effectiveLODs?c.zoomToScale(e.zoom):Array.isArray(y)||"point"===y.type||"extent"===y.type&&0===y.width&&0===y.height?t.extent&&h.canProject(t.extent,n)?O(h.project(t.extent,n),f):t.extent?O(t.extent,f):i.scale:h.canProject(y.extent,n)?O(h.project(y.extent,n),f):O(y.extent,f),(A=function(e){if(e&&(!Array.isArray(e)||"number"!=typeof e[0])&&("object"==typeof e||Array.isArray(e)&&"object"==typeof e[0])){if("layer"in e&&e.layer&&e.layer.minScale&&e.layer.maxScale)return{min:(c=e.layer).minScale,max:c.maxScale};if(Array.isArray(e)&&e.length&&e.every((function(e){return"layer"in e}))){for(var t=0,r=0,n=0,a=e;n<a.length;n++){var c;(c=a[n].layer)&&c.minScale&&c.maxScale&&(t=c.minScale<t?c.minScale:t,r=c.maxScale>r?c.maxScale:r)}return t&&r?{min:t,max:r}:null}}}(e))&&(A.min&&A.min>G?G=A.min:A.max&&A.max<G&&(G=A.max)),P=0,m?P=m.rotation:e.hasOwnProperty("rotation")?P=e.rotation:i&&(P=i.rotation),j=new a({targetGeometry:R,scale:G,rotation:P}),c&&(j=c.fit(j),c.rotationEnabled||(j.rotation=P)),[2,j]):[2,null]}}))}))}function C(e,t){var r=e.targetGeometry,n=t.targetGeometry;return r.x=n.x,r.y=n.y,r.spatialReference=n.spatialReference,e.scale=t.scale,e.rotation=t.rotation,e}function L(e,t,r){return r?y.vec2.set(e,.5*(t[0]-r.right+r.left),.5*(t[1]-r.bottom+r.top)):y.vec2.scale(e,t,.5)}function D(e,t,r){var n=Q(t),a=Math.abs(Math.cos(n)),c=Math.abs(Math.sin(n));return y.vec2.set(e,Math.round(r[1]*c+r[0]*a),Math.round(r[1]*a+r[0]*c))}function H(e){return e.scale*(t=e.targetGeometry.spatialReference,b.isValid(t)?1/(39.37*I(t)*96):1);var t}function Q(e){return l.common.toRadian(e.rotation)||0}function _(e){return b.isValid(e)?39.37*I(e)*96:1}function J(e){if(e.isWrappable){var t=b.getInfo(e);return t.valid[1]-t.valid[0]}return 0}t.extentToScale=O,t.create=U,t.copy=C,t.getAnchor=L,t.getExtent=(w=v.vec2f64.create(),function(e,t,r){var n=t.targetGeometry;W(w,n);var a=.5*H(t);return e.xmin=w[0]-a*r[0],e.ymin=w[1]-a*r[1],e.xmax=w[0]+a*r[0],e.ymax=w[1]+a*r[1],e.spatialReference=n.spatialReference,e}),t.setExtent=function(e,r,n,a,c){return t.centerAt(e,r,n.center),e.scale=O(n,a),c&&c.constraints&&c.constraints.constrain(e),e},t.getOuterExtent=(S=v.vec2f64.create(),R=v.vec2f64.create(),function(e,t,r){W(S,t.targetGeometry),D(R,t,r);var n=.5*H(t),a=S[0]-n*R[0],c=S[1]-n*R[1],o=S[0]+n*R[0],i=S[1]+n*R[1],s=t.targetGeometry.spatialReference;return e.set({xmin:a,ymin:c,xmax:o,ymax:i,spatialReference:s}),e}),t.getOuterSize=D,t.getPaddingScreenTranslation=(G=v.vec2f64.create(),function(e,t,r){return y.vec2.sub(e,function(e,t){return y.vec2.scale(e,t,.5)}(e,t),L(G,t,r))}),t.getPaddingMapTranslation=function(){var e=m.mat2df64.create(),r=v.vec2f64.create();return function(n,a,c,o){var i=H(a),s=Q(a);return y.vec2.set(r,i,i),f.mat2d.fromScaling(e,r),f.mat2d.rotate(e,e,s),f.mat2d.translate(e,e,t.getPaddingScreenTranslation(r,c,o)),f.mat2d.translate(e,e,[0,o.top-o.bottom]),y.vec2.set(n,e[4],e[5])}}(),t.getResolution=H,t.getResolutionToScaleFactor=_,t.getMatrix=function(){var e=v.vec2f64.create(),t=v.vec2f64.create(),r=v.vec2f64.create();return function(n,a,c,o,i,s){return y.vec2.negate(e,a),y.vec2.scale(t,c,.5*s),y.vec2.set(r,1/o*s,-1/o*s),f.mat2d.identity(n),f.mat2d.translate(n,n,t),i&&f.mat2d.rotate(n,n,i),f.mat2d.scale(n,n,r),f.mat2d.translate(n,n,e),n}}(),t.getTransform=function(){var e=v.vec2f64.create();return function(r,n,a,c){var o=H(n),i=Q(n);return W(e,n.targetGeometry),t.getMatrix(r,e,a,o,i,c)}}(),t.getTransformNoRotation=function(){var e=v.vec2f64.create();return function(r,n,a,c){var o=H(n);return W(e,n.targetGeometry),t.getMatrix(r,e,a,o,0,c)}}(),t.getWorldWidth=J,t.getWorldScreenWidth=function(e,t){return Math.round(J(e)/t)},t.createAsync=function(e,t){return U(e,t)},t.angleBetween=(A=v.vec2f64.create(),P=v.vec2f64.create(),j=[0,0,0],function(e,t,r){y.vec2.subtract(A,e,t),y.vec2.normalize(A,A),y.vec2.subtract(P,e,r),y.vec2.normalize(P,P),y.vec2.cross(j,A,P);var n=Math.acos(y.vec2.dot(A,P)/(y.vec2.length(A)*y.vec2.length(P)))*F;return j[2]<0&&(n=-n),isNaN(n)&&(n=0),n}),t.addPadding=function(){var e=v.vec2f64.create();return function(r,n,a,c){var o=r.targetGeometry;return C(r,n),t.getPaddingMapTranslation(e,n,a,c),o.x+=e[0],o.y+=e[1],r}}(),t.removePadding=function(){var e=v.vec2f64.create();return function(r,n,a,c){var o=r.targetGeometry;return C(r,n),t.getPaddingMapTranslation(e,n,a,c),o.x-=e[0],o.y-=e[1],r}}(),t.centerAt=function(){var e=v.vec2f64.create();return function(t,r,n){C(t,r);var a=t.targetGeometry,c=V(n),o=V(a);return W(e,n),N(e,e,c,o),a.x=e[0],a.y=e[1],t}}(),t.pixelSize=function(e){return H(e)},t.resize=(T=v.vec2f64.create(),function(e,r,n,a,c){c||(c="center"),y.vec2.sub(T,n,a),y.vec2.scale(T,T,.5);var o=T[0],i=T[1];switch(c){case"center":y.vec2.set(T,0,0);break;case"left":y.vec2.set(T,-o,0);break;case"top":y.vec2.set(T,0,i);break;case"right":y.vec2.set(T,o,0);break;case"bottom":y.vec2.set(T,0,-i);break;case"top-left":y.vec2.set(T,-o,i);break;case"bottom-left":y.vec2.set(T,-o,-i);break;case"top-right":y.vec2.set(T,o,i);break;case"bottom-right":y.vec2.set(T,o,-i)}return t.translateBy(e,r,T),e}),t.rotateBy=function(e,t,r){return C(e,t),e.rotation+=r,e},t.rotateTo=function(e,t,r){return C(e,t),e.rotation=r,e},t.scaleBy=function(){var e=v.vec2f64.create();return function(r,n,a,c,o){return C(r,n),isNaN(a)||0===a||(t.toMap(e,c,n,o),r.scale=n.scale*a,t.toScreen(e,e,r,o),t.translateBy(r,r,y.vec2.set(e,e[0]-c[0],c[1]-e[1]))),r}}(),t.scaleTo=function(e,t,r){return C(e,t),e.scale=r,e},t.scaleAndRotateBy=function(){var e=v.vec2f64.create();return function(r,n,a,c,o,i){return C(r,n),isNaN(a)||0===a||(t.toMap(e,o,n,i),r.scale=n.scale*a,r.rotation+=c,t.toScreen(e,e,r,i),t.translateBy(r,r,y.vec2.set(e,e[0]-o[0],o[1]-e[1]))),r}}(),t.padAndScaleAndRotateBy=(B=v.vec2f64.create(),z=v.vec2f64.create(),function(e,r,n,a,c,o,i){return t.getPaddingScreenTranslation(z,o,i),y.vec2.add(B,c,z),a?t.scaleAndRotateBy(e,r,n,a,B,o):t.scaleBy(e,r,n,B,o)}),t.toMap=(k=m.mat2df64.create(),function(e,r,n,a){return y.vec2.transformMat2d(e,r,function(e,r,n,a){return t.getTransform(e,r,n,a),f.mat2d.invert(e,e)}(k,n,a,1))}),t.toScreen=function(){var e=m.mat2df64.create();return function(r,n,a,c){return y.vec2.transformMat2d(r,n,t.getTransform(e,a,c,1))}}(),t.translateBy=function(){var e=v.vec2f64.create(),t=m.mat2df64.create();return function(r,n,a){C(r,n);var c=H(n),o=r.targetGeometry;return f.mat2d.fromRotation(t,Q(n)),f.mat2d.scale(t,t,v.vec2f64.fromValues(c,c)),y.vec2.transformMat2d(e,a,t),o.x+=e[0],o.y+=e[1],r}}()}));