// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/assignHelper","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../request","../../../../core/has","../../../../core/ItemCache","../../../../core/maybe","../../../../core/MemCache","../../../../core/promiseUtils","../../../../core/workers","../../../../geometry/support/aaBoundingRect","../vectorTiles/VectorTile","./GeometryUtils","./GlyphMosaic","./GlyphSource","./SpriteMosaic","./TileIndex","../../tiling/TileKey"],(function(e,t,o,r,i,n,s,a,l,c,u,h,p,d,f,y,_,g,T,b){Object.defineProperty(t,"__esModule",{value:!0});var v=new a(10),m=new Map,M=function(){function e(e,t,o,r,i,n){this._vectorTileLayer=e,this.devicePixelRatio=t,this.allowUpdates=o,this._container=r,this._memCache=i,this._enableCachingWorkerTiles=n,this._spriteMosaic=null,this._glyphMosaic=null,this._connection=null,this._updateToAbortController=new Map,this._ongoingTileRequests=new Map,this._ongoingRequestToController=new Map}return e.prototype.destroy=function(){this._updateToAbortController&&this._updateToAbortController.forEach((function(e){return e.abort()})),this._ongoingTileRequests&&this.abortAll(),this._connection&&(this._connection.close(),this._connection=null),this._vectorTileLayer=null,this._spriteMosaic&&(this._spriteMosaic.dispose(),this._spriteMosaic=null),this._glyphMosaic&&(this._glyphMosaic.dispose(),this._glyphMosaic=null)},Object.defineProperty(e.prototype,"spriteMosaic",{get:function(){var e=this;return this._spriteSourcePromise.then((function(){return e._spriteMosaic}))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"glyphMosaic",{get:function(){return this._glyphMosaic},enumerable:!0,configurable:!0}),e.prototype.start=function(e){return i(this,void 0,void 0,(function(){var t,i,n,a,l,c=this;return r(this,(function(r){for(n in t=this._vectorTileLayer.sourceNameToSource,i=[],t)i.push(this._fetchTileMap(t[n],e));return this._spriteSourcePromise=this._vectorTileLayer.loadSpriteSource(this.devicePixelRatio,e),this._spriteSourcePromise.then((function(e){c._spriteMosaic=new g(1024,1024,250),c._spriteMosaic.setSpriteSource(e),s("stable-symbol-rendering")&&c._spriteMosaic.preloadSpriteItems()})),a=this._vectorTileLayer.styleRepository,l=new _(a.glyphs),this._glyphMosaic=new y(1024,1024,l),this._broadcastPromise=h.open("WorkerTileHandler",{client:this,scheduler:e.scheduler,signal:e.signal}).then((function(t){return c._connection=t,u.all(c._connection.broadcast("setLayers",{style:a.styleJSON,enableCachingTiles:c._enableCachingWorkerTiles},o({},e)))})),[2,u.all(i)]}))}))},e.prototype.updateStyle=function(){return i(this,void 0,void 0,(function(){var e,t=this;return r(this,(function(o){switch(o.label){case 0:return[4,this._broadcastPromise];case 1:return o.sent(),this._updateToAbortController.forEach((function(e){return e.abort()})),this._updateToAbortController.clear(),e=this._vectorTileLayer.styleRepository,this._broadcastPromise=u.create((function(o,r){u.all(t._connection.broadcast("updateStyle",e.styleJSON)).then(o,r)})),[2,this._broadcastPromise]}}))}))},e.prototype.abortTileUpdate=function(e){this._updateToAbortController.has(e)&&(this._updateToAbortController.get(e).abort(),this._updateToAbortController.delete(e))},e.prototype.updateTile=function(e,t){return i(this,void 0,void 0,(function(){var o,i,n,s,a=this;return r(this,(function(r){switch(r.label){case 0:return this.allowUpdates&&e.isReady?[4,this._broadcastPromise]:[2];case 1:return r.sent(),o=Math.round(f.degToByte(t.state.rotation)),e.rotation===o?[2,null]:(n=e.key,this._updateToAbortController.has(n.id)&&((i=this._updateToAbortController.get(n.id)).abort(),this._updateToAbortController.delete(n.id)),i=u.createAbortController(),e.rotation=o,s=e.client.invoke("updateSymbols",{key:e.id,rotation:o},{signal:i.signal}).then((function(t){a._updateToAbortController.delete(n.id),e.isReady&&e.updateSymbolData(t)})).catch((function(e){u.isAbortError(e)||a._updateToAbortController.delete(n.id)})),this._updateToAbortController.set(e.id,i),[2,s])}}))}))},e.prototype.updateTileData=function(e){for(var t,o=e.tileId,r=this._container.children,i=0;i<r.length;i++)if((t=r[i]).id===o){t.updateTileData(e.tileData);break}},e.prototype.getVectorTile=function(e,t,o,n){return i(this,void 0,void 0,(function(){var i,s,a,h,f,y,_;return r(this,(function(r){switch(r.label){case 0:return i=new b(e,t,o,0),l.isSome(this._memCache)&&(s=this._memCache.get(i.id))?(s.reference(),[2,s]):[4,this._getVectorTileData(i)];case 1:return a=r.sent(),u.throwIfAborted(n),l.isSome(this._memCache)&&(h=this._memCache.get(i.id))?(h.reference(),[2,h]):(f=this._vectorTileLayer.tileInfo,y=f.getTileBounds(p.create(),i),_=new d.VectorTile(i,this._vectorTileLayer.styleRepository,y,[512,512],0,!1),a&&a.tileData?(_.setData(a.tileData,a.client),l.isSome(this._memCache)&&(_.reference(),this._memCache.put(_.key.id,_,_.getMemoryUsage()*_.referenced,c.MIN_PRIORITY))):_.setData(null,null),[2,_])}}))}))},e.prototype.releaseVectorTile=function(e){l.isNone(this._memCache)||e.release()||this._memCache.updateSize(e.key.id,e,e.getMemoryUsage()*e.referenced)},e.prototype.fetchTileData=function(e,t){return i(this,void 0,void 0,(function(){var o,i,n,s;return r(this,(function(r){switch(r.label){case 0:return[4,this._getRefKeys(e,t)];case 1:for(s in o=r.sent(),i=this._vectorTileLayer.sourceNameToSource,n=[],i)n.push(s);return[2,this._getSourcesData(n,o,t)]}}))}))},e.prototype.parseTileData=function(e,t,n){return i(this,void 0,void 0,(function(){var i,a,l,c,u,h,p,d,y=this;return r(this,(function(r){switch(r.label){case 0:return(i=e&&e.data)?(a=i.sourceName2DataAndRefKey,l=i.transferList,0===Object.keys(a).length?[2,null]:[4,this._broadcastPromise]):[2,null];case 1:return r.sent(),c=Math.round(f.degToByte(t)),[4,(u=this._connection.getAvailableClient()).invoke("createTileAndParse",{key:e.key.id,rotation:c,cacheTile:this.allowUpdates,sourceName2DataAndRefKey:a},o({},n,{transferList:l})).catch((function(){return y._enableCachingWorkerTiles&&u.invoke("destructTileData",e.key.id).catch((function(){})),null}))];case 2:if(h=r.sent(),s("esri-vector-tiles-debug")){for(d in p={},a)p[d]=a[d].refKey;return[2,{tileData:h,client:u,refKeys:p}]}return[2,{tileData:h,client:u}]}}))}))},Object.defineProperty(e.prototype,"updating",{get:function(){return this._ongoingTileRequests.size>0},enumerable:!0,configurable:!0}),e.prototype.abortAll=function(){this._ongoingRequestToController.forEach((function(e){return e.abort()})),this._ongoingRequestToController.clear(),this._ongoingTileRequests.clear()},e.prototype.getSprites=function(e){return i(this,void 0,void 0,(function(){return r(this,(function(t){switch(t.label){case 0:return[4,this._spriteSourcePromise];case 1:return t.sent(),[2,this._spriteMosaic.getSpriteItems(e)]}}))}))},e.prototype.getGlyphs=function(e){return this._glyphMosaic.getGlyphItems(e.font,e.codePoints)},e.prototype.getStyleRepository=function(){return this._vectorTileLayer.styleRepository},e.prototype._getTilePayload=function(e,t,s){return i(this,void 0,void 0,(function(){var i,a,l,c;return r(this,(function(r){switch(r.label){case 0:return i=b.pool.acquire(e.id),a=this._vectorTileLayer.sourceNameToSource,l=a[t],c=l.getSourceTileUrl(i.level,i.row,i.col),b.pool.release(i),[4,n(c,o({responseType:"array-buffer"},s))];case 1:return[2,{protobuff:r.sent().data,sourceName:t}]}}))}))},e.prototype._fetchTileMap=function(e,t){if(e.capabilities.operations.supportsTileMap&&e.tileIndex)return u.resolve();if(!e.tileMapURL)return u.resolve();var o=v.get(e.tileMapURL);if(o)return e.tileIndex=o,u.resolve();if(m.has(e.tileMapURL))return m.get(e.tileMapURL).then((function(t){e.tileIndex=new T(t.data)}));var r=n(e.tileMapURL,t);return r.then((function(t){e.tileIndex=new T(t.data),m.delete(e.tileMapURL),v.put(e.tileMapURL,e.tileIndex)})),m.set(e.tileMapURL,r),r},e.prototype._getRefKeys=function(e,t){return i(this,void 0,void 0,(function(){var o,i,n,s,a;return r(this,(function(r){for(n in o=this._vectorTileLayer.sourceNameToSource,i=new Array,o)s=o[n],a=s.getRefKey(e,t),i.push(a);return[2,u.eachAlways(i)]}))}))},e.prototype._getSourcesData=function(e,t,o){return i(this,void 0,void 0,(function(){var i,n,s,a,l,c,h;return r(this,(function(r){switch(r.label){case 0:for(i=[],c=0;c<t.length;c++)null==t[c].value||null==e[c]?i.push(null):(n=this._getTilePayload(t[c].value,e[c],o),i.push(n));return[4,u.eachAlways(i)];case 1:for(s=r.sent(),a={},l=[],c=0;c<s.length;c++)s[c].value&&s[c].value&&s[c].value.protobuff&&s[c].value.protobuff.byteLength>0&&(h=t[c].value.id,a[s[c].value.sourceName]={refKey:h,protobuff:s[c].value.protobuff},l.push(s[c].value.protobuff));return[2,{sourceName2DataAndRefKey:a,transferList:l}]}}))}))},e.prototype._getVectorTileData=function(e){return i(this,void 0,void 0,(function(){var t,o,i,n,s=this;return r(this,(function(r){return t=e.id,this._ongoingTileRequests.has(t)?[2,this._ongoingTileRequests.get(t)]:(o=new AbortController,i={signal:o.signal},n=this._getParsedVectorTileData(e,i).then((function(e){return s._ongoingTileRequests.delete(t),s._ongoingRequestToController.delete(t),e})).catch((function(){return s._ongoingTileRequests.delete(t),s._ongoingRequestToController.delete(t),null})),this._ongoingTileRequests.set(t,n),this._ongoingRequestToController.set(t,o),[2,n])}))}))},e.prototype._getParsedVectorTileData=function(e,t){return i(this,void 0,void 0,(function(){var o;return r(this,(function(r){switch(r.label){case 0:return[4,this.fetchTileData(e,t)];case 1:return o=r.sent(),[2,this.parseTileData({key:e,data:o},0,t)]}}))}))},e}();t.TileHandler=M}));