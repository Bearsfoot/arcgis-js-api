// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","./Conflict","./GeometryUtils","../webgl/Geometry"],(function(t,e,n,o,i){Object.defineProperty(e,"__esModule",{value:!0});var a=function(t,e,n,o,i){void 0===n&&(n=0),void 0===o&&(o=-1),void 0===i&&(i=s),this.x=t,this.y=e,this.angle=n,this.segment=o,this.minzoom=i};e.Anchor=a;var r=function(t,e,n,i,a,r,l){void 0===a&&(a=!1),void 0===r&&(r=s),void 0===l&&(l=o.C_INFINITY),this.anchor=t,this.labelAngle=e,this.glyphAngle=n,this.page=i,this.upsideDown=a,this.minzoom=r,this.maxzoom=l},l=function(t,e,n,o,i,a,r,l,h,s){this.tl=t,this.tr=e,this.bl=n,this.br=o,this.mosaicRect=i,this.labelAngle=a,this.anchor=r,this.minzoom=l,this.maxzoom=h,this.page=s};e.PlacedSymbol=l;var h=function(t,e){this.footprint=t,this.shapes=e};e.Placement=h;var s=.5,p=function(){function t(){this.mapAngle=0,this._conflictEngine=new n.ConflictEngine}return t.prototype.reset=function(){this._conflictEngine.reset()},t.prototype.setAngle=function(t){this.mapAngle=t},t.prototype.getIconPlacement=function(t,e,a,r,p){var c=a.width/a.pixelRatio,g=a.height/a.pixelRatio,m=p.offset[0]-c/2,f=p.offset[1]-g/2,I=m+c,d=f+g,u=a.rect,x=2/a.pixelRatio,w=m-x,y=f-x,_=w+u.width/a.pixelRatio,v=y+u.height/a.pixelRatio,N=new i.Point(w,y),P=new i.Point(_,v),A=new i.Point(w,v),T=new i.Point(_,y),b=p.rotate*o.C_DEG_TO_RAD,E=1===p.rotationAlignment;if(t.segment>=0&&!E&&(b+=t.angle),0!==b){var C=Math.cos(b),M=Math.sin(b);N.rotate(C,M),P.rotate(C,M),A.rotate(C,M),T.rotate(C,M)}var z=8*p.padding,F=new i.Point(t.x,t.y),Y=new n.Footprint(this.mapAngle,z,E);Y.addBox(F,new n.Box(m,f,I,d),r,b,e,s,o.C_INFINITY);var B=new l(N,T,A,P,u,0,F,s,o.C_INFINITY,0),G=new h(Y,[B]),R=s;return p.allowOverlap||(R=this._conflictEngine.getMinZoom(G.footprint,R)),Y.minzoom=R,G},t.prototype.getTextPlacement=function(t,e,a,p,c,g,m){for(var f,I=new i.Point(t.x,t.y),d=m.rotate*o.C_DEG_TO_RAD,u=0===m.rotationAlignment,x=m.keepUpright,w=s,y=!u,_=y?0:t.angle,v=t.segment>=0&&u,N=8*m.padding,P=new n.Footprint(this.mapAngle,N,y),A=[],T=!v,b=Number.POSITIVE_INFINITY,E=Number.NEGATIVE_INFINITY,C=b,M=E,z=v?x:u&&x,F=0,Y=p;F<Y.length;F++){var B=Y[F],G=B.glyphMosaicItem;if(G&&!G.rect.isEmpty){var R=G.rect,O=G.metrics,D=G.page;T&&(f&&f!==B.y&&(P.addBox(I,new n.Box(b,C,E,M),c,d,e,s,o.C_INFINITY),C=b=Number.POSITIVE_INFINITY,M=E=Number.NEGATIVE_INFINITY),f=B.y);var q=[];if(v){var V=.5*G.metrics.width,S=(a.x+B.x+O.left-4+V)*c;if(w=this._placeGlyph(t,w,S,g,t.segment,1,D,q),x&&(w=this._placeGlyph(t,w,S,g,t.segment,-1,D,q)),w>=2)break}else q.push(new r(I,_,_,D)),u&&x&&q.push(new r(I,_+o.C_PI,_+o.C_PI,D,!0));for(var k=B.x+a.x+O.left,U=B.y+a.y-O.top,Z=k+O.width,j=U+O.height,H=new i.Point(k-4,U-4),J=new i.Point(H.x+R.width,H.y+R.height),K=new i.Point(H.x,J.y),L=new i.Point(J.x,H.y),Q=0,W=q;Q<W.length;Q++){var X=W[Q],$=H.clone(),tt=K.clone(),et=L.clone(),nt=J.clone(),ot=U,it=j,at=X.glyphAngle+d;if(0!==at){var rt=Math.cos(at),lt=Math.sin(at);$.rotate(rt,lt),nt.rotate(rt,lt),tt.rotate(rt,lt),et.rotate(rt,lt)}A.push(new l($,et,tt,nt,R,X.labelAngle,X.anchor,X.minzoom,X.maxzoom,X.page)),z&&!this._legible(X.labelAngle)||(T?(k<b&&(b=k),ot<C&&(C=ot),Z>E&&(E=Z),it>M&&(M=it)):X.minzoom<2&&P.addBox(X.anchor,new n.Box(k,ot,Z,it),c,at,e,X.minzoom,X.maxzoom))}}}if(w>=2)return null;T&&P.addBox(I,new n.Box(b,C,E,M),c,d,e,s,o.C_INFINITY);var ht=new h(P,A);return m.allowOverlap||(w=this._conflictEngine.getMinZoom(ht.footprint,w)),P.minzoom=w,ht},t.prototype.add=function(t){this._conflictEngine.add(t.footprint)},t.prototype._legible=function(t){var e=o.radToByte(t);return e<65||e>=193},t.prototype._placeGlyph=function(t,e,n,a,l,h,s,p){var c=h,g=c<0?o.positiveMod(t.angle+o.C_PI,o.C_2PI):t.angle,m=this._legible(g),f=0;n<0&&(c*=-1,n*=-1,f=o.C_PI),c>0&&++l;var I=new i.Point(t.x,t.y),d=a[l],u=o.C_INFINITY;if(a.length<=l)return u;for(;;){var x=d.x-I.x,w=d.y-I.y,y=Math.sqrt(x*x+w*w),_=Math.max(n/y,e),v=x/y,N=w/y,P=o.positiveMod(Math.atan2(N,v)+f,o.C_2PI);if(p.push(new r(I,g,P,s,m,_,u)),_<=e)return _;I=d.clone();do{if(l+=c,a.length<=l||l<0)return _;d=a[l]}while(I.isEqual(d));var A=d.x-I.x,T=d.y-I.y,b=Math.sqrt(A*A+T*T);A*=y/b,T*=y/b,I.x-=A,I.y-=T,u=_}},t}();e.PlacementEngine=p}));