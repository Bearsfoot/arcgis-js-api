// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/extendsHelper","../../../core/tsSupport/assignHelper","../../../core/Error","../../../core/events","../../../core/has","../../../core/promiseUtils","../../../core/scheduling","../../../core/watchUtils","../../../core/libs/gl-matrix-2/common","../../../core/libs/gl-matrix-2/mat2d","../../../core/libs/gl-matrix-2/mat2df64","../../../core/libs/gl-matrix-2/vec2","../../../core/libs/gl-matrix-2/vec2f64","../../webgl","./Container","./webgl/BitBlitRenderer","./webgl/definitions","./webgl/enums","./webgl/Painter","./webgl/Profiler","./webgl/WebGLDriverTest","./webgl/shaders/StencilPrograms","../support/Timeline","../../support/screenshotUtils"],(function(e,t,r,i,n,a,s,o,l,h,d,c,p,u,_,g,f,b,m,v,O,y,R,w,C,x){Object.defineProperty(t,"__esModule",{value:!0});g.enums.TargetType,g.enums.DepthStencilTargetType,g.enums.PixelFormat,g.enums.PixelType,g.enums.DataType,g.enums.Usage,g.enums.PrimitiveType,g.enums.CompareFunction,g.enums.StencilOperation,g.enums.TextureSamplingMode;var F=function(e){function t(t,r){var i=e.call(this)||this;i._renderParameters={drawPhase:0,state:i.state,pixelRatio:window.devicePixelRatio,stationary:!1,globalOpacity:1},i._clipData=new Float32Array(8),i._upperLeft=_.vec2f64.create(),i._upperRight=_.vec2f64.create(),i._lowerLeft=_.vec2f64.create(),i._lowerRight=_.vec2f64.create(),i._mat2=p.mat2df64.create(),i._clipRendererInitialized=!1,i._supersampleScreenshots=!0,i.dataUploadCounter=0,i.stage=i,i._stationary=!0,i.attached=!0;var o=r.canvas,h=void 0===o?document.createElement("canvas"):o,d=r.alpha,c=void 0===d||d,u=r.stencil,f=void 0===u||u,b=r.renderContext,m=void 0===b?"webgl":b,v=r.supersampleScreenshots,w=void 0===v||v,x=r.contextOptions,F=void 0===x?{}:x;i._canvas=h;var B={alpha:c,antialias:!1,depth:!0,stencil:f},S=g.createContextOrErrorHTML(h,B,m);return i.context=new g.RenderingContext(S,F),i.painter=new O.default(i.context,i),i._taskHandle=l.addFrameTask({render:function(){return i.renderFrame()}}),i._taskHandle.pause(),i._supersampleScreenshots=w,i._lostWebGLContextHandle=a.on(h,"webglcontextlost",(function(){i.emit("webgl-error",{error:new n("webgl-context-lost")})})),s("esri-2d-profiler")&&(i._debugOutput=document.createElement("div"),i._debugOutput.setAttribute("style","margin: 24px 64px; position: absolute; color: red;"),t.appendChild(i._debugOutput)),h.setAttribute("style","width: 100%; height:100%; display:block;"),i.profiler=new y.Profiler(i.context,i._debugOutput),i.renderingOptions=r.renderingOptions,i.timeline=r.timeline||new C.Timeline,i.driverTestResult=R.testWebGLDriver(i.context),t.appendChild(h),i}return r(t,e),t.prototype.destroy=function(){this.removeAllChildren(),this.renderFrame(),this._taskHandle.remove(),this._taskHandle=null,this._boundFBO=null,this._clipFBO&&(this._clipFBO.dispose(),this._clipFBO=null),this._blitRenderer&&(this._blitRenderer.dispose(),this._blitRenderer=null),this._clipVAO&&(this._clipVAO.dispose(),this._clipVAO=null,this._clipVBO=null),this._clipStencilProgram&&(this._clipStencilProgram.dispose(),this._clipStencilProgram=null),this._lostWebGLContextHandle&&(this._lostWebGLContextHandle.remove(),this._lostWebGLContextHandle=null),this._canvas.parentNode&&this._canvas.parentNode.removeChild(this._canvas),this._debugOutput&&this._debugOutput.parentNode&&this._debugOutput.parentNode.removeChild(this._debugOutput),this.painter.dispose(),this.context.dispose(),this._canvas=null},Object.defineProperty(t.prototype,"background",{get:function(){return this._background},set:function(e){this._background=e,this.requestRender()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"highlightOptions",{get:function(){return this._highlightOptions},set:function(e){var t=this;this._highlightOptionsHandle&&(this._highlightOptionsHandle.remove(),this._highlightOptionsHandle=null),this._highlightOptions=e,this._highlightOptions&&(this._highlightOptionsHandle=h.init(this._highlightOptions,"version",(function(){t.painter.setHighlightOptions(e),t.requestRender()})))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"renderingOptions",{get:function(){return this._renderingOptions},set:function(e){this._renderingOptions=e,this.requestRender()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"state",{get:function(){return this._state},set:function(e){this._state=e,this.requestRender()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"stationary",{get:function(){return this._stationary},set:function(e){this._stationary!==e&&(this._stationary=e,this.requestRender())},enumerable:!0,configurable:!0}),t.prototype.requestRender=function(){this._lastRenderRequestTime=Date.now(),this._taskHandle&&this._taskHandle.resume()},t.prototype.renderFrame=function(){Date.now()-this._lastRenderRequestTime>=m.MAX_ANIMATION_TIME_MS&&this._taskHandle.pause(),this._renderParameters.state=this._state,this._renderParameters.stationary=this.stationary,this._renderParameters.pixelRatio=window.devicePixelRatio,this._renderParameters.globalOpacity=1,this.processRender(this._renderParameters)},t.prototype.renderChildren=function(e){var t=this.context,r=this.children,i=e.children?e.children:r;this.profiler.recordStart("drawLayers"),this.dataUploadCounter=0,this.beforeRenderChildren(e),e.drawPhase=v.WGLDrawPhase.MAP,this.painter.beforeRenderLayers(t);for(var n=0,a=i;n<a.length;n++){(c=a[n]).attached&&c.processRender(e)}this.painter.renderLayers(t),e.drawPhase=v.WGLDrawPhase.LABEL,this.painter.beforeRenderLayers(t);for(var o=0,l=i;o<l.length;o++){(c=l[o]).attached&&c.processRender(e)}if(this.painter.renderLayers(t),s("esri-tiles-debug")){e.drawPhase=v.WGLDrawPhase.DEBUG,this.painter.beforeRenderLayers(t);for(var h=0,d=i;h<d.length;h++){var c;(c=d[h]).attached&&c.processRender(e)}this.painter.renderLayers(t)}this.profiler.recordEnd("drawLayers"),this.afterRenderChildren()},t.prototype.beforeRenderChildren=function(e){var t=this.context,r=this.painter,i=e.state,n=e.pixelRatio;if(r){t.enforceState();var a=i.size,s=i.rotation,o=Math.round(a[0]*n),l=Math.round(a[1]*n);if(this._boundFBO=t.getBoundFramebufferObject(),i.spatialReference&&(i.spatialReference._isWrappable?i.spatialReference._isWrappable():i.spatialReference.isWrappable)){var h=d.common.toRadian(s),p=Math.abs(Math.cos(h)),_=Math.abs(Math.sin(h)),f=Math.round(o*p+l*_),b=Math.round(i.worldScreenWidth);if(f<=b)this._clipFrame=!1;else{this._clipFBO&&this._clipFBO.width===o&&this._clipFBO.height===l||(this._clipFBO=new g.FramebufferObject(t,{colorTarget:0,depthStencilTarget:3,width:o,height:l}));var m=(this.state.padding.left-this.state.padding.right)/2,v=(this.state.padding.bottom-this.state.padding.top)/2,O=.5*o,y=.5*l,R=1/o,w=1/l,C=b*n*.5,x=.5*(o*_+l*p),F=this._upperLeft,B=this._upperRight,S=this._lowerLeft,E=this._lowerRight;u.vec2.set(F,-C,-x),u.vec2.set(B,C,-x),u.vec2.set(S,-C,x),u.vec2.set(E,C,x),c.mat2d.identity(this._mat2),c.mat2d.translate(this._mat2,this._mat2,[O+m,y+v]),0!==s&&c.mat2d.rotate(this._mat2,this._mat2,h),u.vec2.transformMat2d(F,F,this._mat2),u.vec2.transformMat2d(B,B,this._mat2),u.vec2.transformMat2d(S,S,this._mat2),u.vec2.transformMat2d(E,E,this._mat2);var P=this._clipData;P.set([2*S[0]*R-1,2*(l-S[1])*w-1,2*E[0]*R-1,2*(l-E[1])*w-1,2*F[0]*R-1,2*(l-F[1])*w-1,2*B[0]*R-1,2*(l-B[1])*w-1]),this._clipRendererInitialized||this._initializeClipRenderer(t),this._clipVBO.setData(P),this._boundFBO=t.getBoundFramebufferObject(),t.bindFramebuffer(this._clipFBO),t.setDepthWriteEnabled(!0),t.setStencilWriteMask(255),t.setClearColor(0,0,0,0),t.setClearDepth(1),t.setClearStencil(0),t.clear(t.gl.COLOR_BUFFER_BIT|t.gl.DEPTH_BUFFER_BIT|t.gl.STENCIL_BUFFER_BIT),t.setDepthWriteEnabled(!1),this._clipFrame=!0}}else this._clipFrame=!1}},t.prototype.afterRenderChildren=function(){var e=this.context;e.logIno(),this._clipFrame&&this._clipRendererInitialized&&(e.bindFramebuffer(this._boundFBO),this._boundFBO=null,e.bindVAO(this._clipVAO),e.bindProgram(this._clipStencilProgram),e.setDepthWriteEnabled(!1),e.setDepthTestEnabled(!1),e.setStencilTestEnabled(!0),e.setBlendingEnabled(!1),e.setColorMask(!1,!1,!1,!1),e.setStencilOp(7680,7680,7681),e.setStencilWriteMask(255),e.setStencilFunction(519,1,255),e.drawElements(4,6,5123,0),e.bindVAO(),e.setColorMask(!0,!0,!0,!0),e.setBlendingEnabled(!0),e.setStencilFunction(514,1,255),this._blitRenderer.render(e,this._clipFBO.colorTexture,9728,1),e.setStencilTestEnabled(!1))},t.prototype.doRender=function(t){var r=this.context,i=t.state,n=t.pixelRatio;if(this._resizeCanvas(t),this.context.enforceState(),r.setViewport(0,0,n*i.size[0],n*i.size[1]),r.setDepthWriteEnabled(!0),r.setStencilWriteMask(255),this.background&&this.background.color){var a=this.background.color,s=a.r,o=a.g,l=a.b,h=a.a;r.setClearColor(s/255,o/255,l/255,h)}else r.setClearColor(0,0,0,0);r.setClearDepth(1),r.setClearStencil(0),r.clear(r.gl.COLOR_BUFFER_BIT|r.gl.DEPTH_BUFFER_BIT|r.gl.STENCIL_BUFFER_BIT),r.setDepthWriteEnabled(!1),e.prototype.doRender.call(this,t)},t.prototype.takeScreenshot=function(e,t){var r=x.screenshotSuperSampleSettings(e,this._supersampleScreenshots,this._state.padding),i=r.framebufferWidth,n=r.framebufferHeight,a=this.context,s=e.layers,l={drawPhase:null,globalOpacity:1,stationary:!0,state:this._renderParameters.state.clone(),pixelRatio:r.pixelRatio};if(null!=e.rotation){var h=l.state.viewpoint;h.rotation=e.rotation,l.state.viewpoint=h}s.length>0&&(l.children=[],s.forEach((function(e){var r=t.find((function(t){return t.layer.id===e.id}));r&&"container"in r&&r.container&&r.attached&&l.children.push(r.container)})));var d=new g.FramebufferObject(a,{colorTarget:0,depthStencilTarget:3,width:i,height:n}),c=a.getBoundFramebufferObject(),p=a.getViewport();a.bindFramebuffer(d),a.setViewport(0,0,i,n);var u=a.gl;if(!e.ignoreBackground&&this.background&&this.background.color){var _=this.background.color,f=_.r,b=_.g,m=_.b,v=_.a;a.setClearColor(f/255,b/255,m/255,v)}else a.setClearColor(0,0,0,0);a.setClearDepth(1),a.setClearStencil(0),a.clear(u.COLOR_BUFFER_BIT|u.DEPTH_BUFFER_BIT|u.STENCIL_BUFFER_BIT),this.renderChildren(l);var O=this._readbackScreenshot(r);a.bindFramebuffer(c),a.setViewport(p.x,p.y,p.width,p.height),this.requestRender();var y=this._ensureScreenshotEncodeCanvas(),R=x.encodeResult(O,e,y,{flipY:!0,premultipliedAlpha:!0});return o.resolve(R)},t.prototype._ensureScreenshotEncodeCanvas=function(){return this._screenshotEncodeCanvas||(this._screenshotEncodeCanvas=document.createElement("canvas")),this._screenshotEncodeCanvas},t.prototype._readbackScreenshot=function(e){var t=e.framebufferWidth,r=e.framebufferHeight,i=e.region,n=e.resample,a=this.context.gl;if(n){var s=x.createEmptyImageData(t,r,this._ensureScreenshotEncodeCanvas());a.readPixels(0,0,t,r,6408,5121,new Uint8Array(s.data.buffer));var o=x.createEmptyImageData(i.width,i.height,this._ensureScreenshotEncodeCanvas());return x.resampleHermite(s,o,!0,n.region.x,r-(n.region.y+n.region.height),n.region.width,n.region.height)}s=x.createEmptyImageData(i.width,i.height,this._ensureScreenshotEncodeCanvas());return a.readPixels(i.x,r-(i.y+i.height),i.width,i.height,6408,5121,new Uint8Array(s.data.buffer)),s},t.prototype._resizeCanvas=function(e){var t=this._canvas,r=t.style,i=e.state.size,n=e.pixelRatio,a=i[0],s=i[1],o=Math.round(a*n),l=Math.round(s*n);t.width===o&&t.height===l||(t.width=o,t.height=l),r.width=a+"px",r.height=s+"px"},t.prototype._initializeClipRenderer=function(e){if(this._clipRendererInitialized)return!0;this._blitRenderer=new b.BitBlitRenderer;var t=w.stencil.attributes,r=g.createProgram(e,w.stencil);if(!r)return!1;var i=g.BufferObject.createVertex(e,35040,32),n=new Uint16Array([0,1,2,2,1,3]),a=g.BufferObject.createIndex(e,35044,n),s=new g.VertexArrayObject(e,t,{geometry:[{name:"a_pos",count:2,type:5126,offset:0,stride:8,normalized:!1,divisor:0}]},{geometry:i},a);return this._clipStencilProgram=r,this._clipVBO=i,this._clipVAO=s,this._clipRendererInitialized=!0,!0},t}(f.Container);t.Stage=F}));