// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/generatorHelper","../../../../../core/tsSupport/awaiterHelper","../../../../../core/tsSupport/assignHelper","../../../../../core/Error","../../../../../core/promiseUtils"],(function(t,e,r,i,s,a,o){Object.defineProperty(e,"__esModule",{value:!0});var n=249,h=254,p=255,l=1,u=44,d=59;function c(t){if(!t||0===t.byteLength)return!1;var e=t.constructor===Uint8Array?t:new Uint8Array(t);return 71===e[0]&&73===e[1]&&70===e[2]&&56===e[3]}e.isGIF=c,e.getGIFSize=function(t){var e=new Uint8ClampedArray(t),r=6;return[e[r++]+(e[r++]<<8),e[r++]+(e[r++]<<8)]},e.isAnimatedGIF=function(t){if(!t||0===t.byteLength)return!1;var e=new Uint8Array(t);if(!c(e))return!1;for(var r=0,i=0,s=e.length-9;i<s&&(0!==e[i]||33!==e[i+1]||249!==e[i+2]||4!==e[i+3]||0!==e[i+8]||44!==e[i+9]&&33!==e[i+9]||!(++r>1));++i);return r>1};var f=function(){function t(){this.paused=!1,this.playing=!1,this.waitTillDone=!0,this.loading=!1,this.firstFrameOnly=!1,this.frames=[],this.comment="",this.length=0,this.currentFrameNumber=0,this.frameCount=0,this.playSpeed=1,this.lastFrame=null,this.playOnLoad=!0,this.complete=!1,this.interlaceOffsets=[0,4,2,1],this.interlaceSteps=[8,8,4,2],this._lastUsedFrame=-1}return t.create=function(e,s){return i(this,void 0,void 0,(function(){var i,n;return r(this,(function(r){switch(r.label){case 0:i=new t,r.label=1;case 1:return r.trys.push([1,3,,4]),[4,i._load(e,s)];case 2:return r.sent(),[3,4];case 3:return n=r.sent(),o.isAbortError(n)?[3,4]:[2,new a("invalid-resource","Could not load PNG: "+n.message)];case 4:return[2,i]}}))}))},t.prototype.play=function(){this.playing||(this.paused=!1,this.playing=!0,this._play())},t.prototype.pause=function(){this.paused=!0,this.playing=!1,clearTimeout(this.timerID)},t.prototype.togglePlay=function(){this.paused||!this.playing?this.play():this.pause()},t.prototype.bindFrame=function(t,e,r){t.bindTexture(e,r);var i=this.frameChanged();if(i){var s=this.currentFrame,a=s.frameData;e.updateData(0,0,0,s.width,s.height,a),this.updateUsedFrame()}return i},t.prototype.seekFrame=function(t){clearTimeout(this.timerID),this.currentFrameNumber=t%this.frames.length,this.playing?this._play():this._setCurrentFrame(this.currentFrameNumber)},t.prototype.seek=function(t){clearTimeout(this.timerID),t<0&&(t=0),t*=1e3,t%=this.length;for(var e=0;t>this.frames[e].time+this.frames[e].delay&&e<this.frames.length;)e+=1;this.currentFrameNumber=e,this.playing?this._play():this._setCurrentFrame(this.currentFrameNumber)},t.prototype.frameChanged=function(){return this._lastUsedFrame!==this.currentFrameNumber},t.prototype.updateUsedFrame=function(){this._lastUsedFrame=this.currentFrameNumber},t.prototype._load=function(t,e){return i(this,void 0,void 0,(function(){var i;return r(this,(function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),this.loading=!0,[4,this._parse(t,e)];case 1:return r.sent(),this.loading=!1,this.play(),[3,3];case 2:return i=r.sent(),o.isAbortError(i)?[3,3]:[2,new a("invalid-resource","Could not parse gif!")];case 3:return[2]}}))}))},t.prototype._parse=function(t,e){var r=this,i=new m(t);i.pos+=6,this.width=i.data[i.pos++]+(i.data[i.pos++]<<8),this.height=i.data[i.pos++]+(i.data[i.pos++]<<8);var s=i.data[i.pos++];return this.globalColourCount=1<<1+(7&s),i.pos++,i.pos++,128&s&&(this.globalColourTable=this._parseColourTable(this.globalColourCount,i)),o.create((function(t,s){setTimeout((function(){return r._parseBlock(i,t,s,e)}),0)}))},t.prototype._parseBlock=function(t,e,s,a){return i(this,void 0,void 0,(function(){var i,n=this;return r(this,(function(r){if(a&&a.signal&&o.isAborted(a.signal))return s(o.createAbortError()),[2];if((i=t.data[t.pos++])===u){if(this._parseImg(t),this.firstFrameOnly)return this._finishedLoading(),e(),[2]}else{if(i===d)return this._finishedLoading(),e(),[2];this._parseExt(t)}return"function"==typeof this.onprogress&&this.onprogress({bytesRead:t.pos,totalBytes:t.data.length,frame:this.frames.length}),setTimeout((function(){return n._parseBlock(t,e,s,a)}),0),[2]}))}))},t.prototype._parseColourTable=function(t,e){for(var r=[],i=0;i<t;i++)r.push([e.data[e.pos++],e.data[e.pos++],e.data[e.pos++]]);return r},t.prototype._parseImg=function(t){var e=this,r={};this.frames.push(r),r.disposalMethod=this.disposalMethod,r.time=this.length,r.delay=10*this.delayTime,this.length+=r.delay,this.transparencyGiven?r.transparencyIndex=this.transparencyIndex:r.transparencyIndex=void 0,r.leftPos=t.data[t.pos++]+(t.data[t.pos++]<<8),r.topPos=t.data[t.pos++]+(t.data[t.pos++]<<8),r.width=t.data[t.pos++]+(t.data[t.pos++]<<8),r.height=t.data[t.pos++]+(t.data[t.pos++]<<8);var i=t.data[t.pos++];r.localColourTableFlag=!!(128&i),r.localColourTableFlag&&(r.localColourTable=this._parseColourTable(1<<1+(7&i),t)),this.pixelBufSize!==r.width*r.height&&(this.pixelBuf=new Uint8Array(r.width*r.height),this.pixelBufSize=r.width*r.height),this._lzwDecode(t.data[t.pos++],t.readSubBlocksB()),64&i?(r.interlaced=!0,function(t){var r=e.pixelBufSize/t;e.interlacedBufSize!==e.pixelBufSize&&(e.deinterlaceBuf=new Uint8Array(e.pixelBufSize),e.interlacedBufSize=e.pixelBufSize);for(var i=0,s=0;s<4;s++)for(var a=e.interlaceOffsets[s];a<r;a+=e.interlaceSteps[s])e.deinterlaceBuf.set(e.pixelBuf.subarray(i,i+t),a*t),i+=t}(r.width)):r.interlaced=!1,this._processFrame(r)},t.prototype._lzwDecode=function(t,e){var r,i,s,a,o,n,h,p,l,u,d;s=i=0;var c=[];for(o=(a=1<<t)+1,n=t+1,d=!1;!d;){for(p=h,h=0,r=0;r<n;r++)e[s>>3]&1<<(7&s)&&(h|=1<<r),s++;if(h===a){for(c=[],n=t+1,r=0;r<a;r++)c[r]=[r];c[a]=[],c[o]=null}else{if(h===o)return void(d=!0);for(h>=c.length?c.push(c[p].concat(c[p][0])):p!==a&&c.push(c[p].concat(c[h][0])),u=(l=c[h]).length,r=0;r<u;r++)this.pixelBuf[i++]=l[r];c.length===1<<n&&n<12&&n++}}},t.prototype._processFrame=function(t){t.image=document.createElement("canvas"),t.image.width=this.width,t.image.height=this.height,t.ctx=t.image.getContext("2d");var e=t.localColourTableFlag?t.localColourTable:this.globalColourTable;null===this.lastFrame&&(this.lastFrame=t);var r=2===this.lastFrame.disposalMethod||3===this.lastFrame.disposalMethod;r||t.ctx.drawImage(this.lastFrame.image,0,0,this.width,this.height);for(var i,s,a=t.ctx.getImageData(t.leftPos,t.topPos,t.width,t.height),o=t.transparencyIndex,n=a.data,h=t.interlaced?this.deinterlaceBuf:this.pixelBuf,p=h.length,l=0,u=0;u<p;u++)s=e[i=h[u]],o!==i?(n[l++]=s[0],n[l++]=s[1],n[l++]=s[2],n[l++]=255):r?(n[l+3]=0,l+=4):l+=4;t.ctx.putImageData(a,t.leftPos,t.topPos),this.lastFrame=t},t.prototype._parseExt=function(t){var e=t.data[t.pos++];e===n?this._parseGCExt(t):e===h?this.comment+=t.readSubBlocks():e===p?this._parseAppExt(t):(e===l&&(t.pos+=13),t.readSubBlocks())},t.prototype._parseAppExt=function(t){t.pos+=1,"NETSCAPE"===t.getString(8)?t.pos+=8:(t.pos+=3,t.readSubBlocks())},t.prototype._parseGCExt=function(t){var e;t.pos++,e=t.data[t.pos++],this.disposalMethod=(28&e)>>2,this.transparencyGiven=!!(1&e),this.delayTime=t.data[t.pos++]+(t.data[t.pos++]<<8),this.transparencyIndex=t.data[t.pos++],t.pos++},t.prototype._finishedLoading=function(){this.loading=!1,this.frameCount=this.frames.length,this.lastFrame=null,this.complete=!0,this.disposalMethod=void 0,this.transparencyGiven=void 0,this.delayTime=void 0,this.transparencyIndex=void 0,this.waitTillDone=void 0,this.pixelBuf=void 0,this.deinterlaceBuf=void 0,this.pixelBufSize=void 0,this.deinterlaceBuf=void 0,this.currentFrameNumber=0,this.frames.length>0&&this._setCurrentFrame(0),this.playOnLoad&&this.play()},t.prototype._play=function(){var t,e,r=this;0!==this.playSpeed?(this.playSpeed<0?(this.currentFrameNumber-=1,this.currentFrameNumber<0&&(this.currentFrameNumber=this.frames.length-1),e=this.currentFrameNumber,(e-=1)<0&&(e=this.frames.length-1),t=1*-this.frames[e].delay/this.playSpeed):(this.currentFrameNumber+=1,this.currentFrameNumber%=this.frames.length,t=1*this.frames[this.currentFrameNumber].delay/this.playSpeed),this._setCurrentFrame(this.currentFrameNumber),this.timerID=window.setTimeout((function(){return r._play()}),t)):this.pause()},t.prototype._setCurrentFrame=function(t){var e=this.frames[t];this.currentFrame={frameData:e.image,top:0,left:0,width:this.width,height:this.height}},t}();e.default=f;var m=function(){function t(t){this.pos=0,this.data=new Uint8ClampedArray(t),this.len=this.data.length}return t.prototype.getString=function(t){for(var e="";t--;)e+=String.fromCharCode(this.data[this.pos++]);return e},t.prototype.readSubBlocks=function(){var t,e,r="";do{for(e=t=this.data[this.pos++];e--;)r+=String.fromCharCode(this.data[this.pos++])}while(0!==t&&this.pos<this.len);return r},t.prototype.readSubBlocksB=function(){var t,e,r=[];do{for(e=t=this.data[this.pos++];e--;)r.push(this.data[this.pos++])}while(0!==t&&this.pos<this.len);return r},t}()}));