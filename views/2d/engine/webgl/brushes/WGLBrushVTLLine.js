// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/extendsHelper","../../../../../core/libs/gl-matrix-2/vec2f32","../../../../../core/libs/gl-matrix-2/vec4f32","../../../../webgl","../definitions","../enums","../number","./WGLBrush"],(function(e,t,r,i,a,n,o,s,l,u){Object.defineProperty(t,"__esModule",{value:!0});n.enums.DataType,n.enums.PrimitiveType,n.enums.TextureSamplingMode;t.C_DEG_TO_RAD=Math.PI/180;var f=[1,1,1,1],d=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._color=a.vec4f32.create(),t._dashArray=i.vec2f32.create(),t._programOptions={id:!1,dd:!1,pattern:!1},t._vertexAttributes={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:12,normalized:!1,divisor:0},{name:"a_offsetAndNormal",count:4,type:5120,offset:4,stride:12,normalized:!1,divisor:0},{name:"a_accumulatedDistance",count:2,type:5123,offset:8,stride:12,normalized:!1,divisor:0}]},t._vertexAttributesDD={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:20,normalized:!1,divisor:0},{name:"a_offsetAndNormal",count:4,type:5120,offset:4,stride:20,normalized:!1,divisor:0},{name:"a_accumulatedDistance",count:2,type:5122,offset:8,stride:20,normalized:!1,divisor:0},{name:"a_color",count:4,type:5121,offset:12,stride:20,normalized:!0,divisor:0},{name:"a_width",count:1,type:5126,offset:16,stride:20,normalized:!1,divisor:0}]},t}return r(t,e),t.prototype.dispose=function(){},t.prototype.drawMany=function(e,t){var r=e.context,i=e.displayLevel,a=e.state,n=e.drawPhase,u=e.styleLayerId,d=e.styleLayer,m=e.painter.getVectorTileProgramCach(),c=d.getPaintValue("line-translate",i),_=d.getPaintValue("line-translate-anchor",i),p=d.getPaintValue("line-pattern",i),y=void 0!==p,v=1/e.pixelRatio,g=d.getPaintValue("line-blur",i),h=d.hasDataDrivenColor?f:d.getPaintValue("line-color",i),D=d.hasDataDrivenOpacity?1:d.getPaintValue("line-opacity",i),V=d.hasDataDrivenWidth?1:d.getPaintValue("line-width",i),b=D*h[3];this._color[0]=b*h[0],this._color[1]=b*h[1],this._color[2]=b*h[2],this._color[3]=b;var x,A=d.hasDataDrivenLine,P=n===s.WGLDrawPhase.HITTEST;P&&(x=l.u32to4Xu8(u));var T=(P?1:0)<<2|(A?1:0)<<1|(y?1:0),U=this._programOptions;U.id=P,U.dd=A,U.pattern=y;var O=m.getProgram(3,T,U);if(r.bindProgram(O),O.setUniformMatrix3fv("u_displayViewMat3",a.displayViewMat3),O.setUniformMatrix3fv("u_displayMat3",1===_?a.displayMat3:a.displayViewMat3),O.setUniform2fv("u_lineTranslation",c),O.setUniform1f("u_depth",d.z),O.setUniform1f("u_blur",g),O.setUniform1f("u_antialiasing",v),O.setUniform4fv("u_color",this._color),O.setUniform1f("u_width",V),P&&O.setUniform4f("u_id",x[0],x[1],x[2],x[3]),y){var M=e.spriteMosaic,I=M.getMosaicItemPosition(p,!0);I&&(M.bind(r,9729,I.page,o.VTL_TEXTURE_BINDING_UNIT_SPRITES),O.setUniform2f("u_pattern_tl",I.tl[0],I.br[1]),O.setUniform2f("u_pattern_br",I.br[0],I.tl[1]),O.setUniform2f("u_spriteSize",8*I.size[0],I.size[1]),O.setUniform1i("u_texture",o.VTL_TEXTURE_BINDING_UNIT_SPRITES))}else{var w=d.getPaintValue("line-dasharray",i);w.length<2&&(w=[1,-1]);this._dashArray[0]=8*w[0],this._dashArray[1]=8*w[1],O.setUniform2fv("u_dasharray",this._dashArray)}for(var L=0,z=t;L<z.length;L++){var E=z[L];if(E.layerData[u]){var j=E.layerData[u],S=this._getLineVAO(r,E,A,m);S&&(r.bindVAO(S),O.setUniformMatrix3fv("u_dvsMat3",E.transforms.dvs),r.setStencilFunction(514,E.stencilRef,255),r.drawElements(4,j.triangleElementCount,5125,12*j.triangleElementStart),E.triangleCount+=j.triangleElementCount/3)}}},t.prototype._getLineVAO=function(e,t,r,i){if(r){if(t.lineDDVertexArrayObject)return t.lineDDVertexArrayObject;var a=t.lineDDVertexBuffer,o=t.lineIndexBuffer;return a&&o?(t.lineDDVertexArrayObject=new n.VertexArrayObject(e,i.getProgramAttributes(3),this._vertexAttributesDD,{geometry:a},o),t.lineDDVertexArrayObject):null}if(t.lineVertexArrayObject)return t.lineVertexArrayObject;var s=t.lineVertexBuffer,l=t.lineIndexBuffer;return s&&l?(t.lineVertexArrayObject=new n.VertexArrayObject(e,i.getProgramAttributes(3),this._vertexAttributes,{geometry:s},l),t.lineVertexArrayObject):null},t}(u.default);t.WGLBrushVTLLine=d}));