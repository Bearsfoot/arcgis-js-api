// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../core/Error","../../../../core/has","../../../../core/Logger","../../../../core/maybe","../../../../core/promiseUtils","../../../webgl","./definitions","./Utils","./util/debug","../../../webgl/FramebufferObject"],(function(t,e,i,r,n,o,a,s,u,d,h,p,l,T){Object.defineProperty(e,"__esModule",{value:!0});d.enums.TextureWrapMode,d.enums.PixelFormat,d.enums.PixelType,d.enums.TextureSamplingMode;var f=a.getLogger("esri.views.2d.engine.webgl.AttributeStoreView"),c=l.createDebugLogger(l.DEBUG_ATTR_UPDATES,f),_=function(t){return 2147483647&t},x=!1,g=function(){function t(t,e,i){this._texture=null,this._lastTexture=null,this._fbos={},this.texelSize=4;var r=t.buffer,n=t.pixelType,o=t.textureOnly,a=p.getPixelArrayCtor(n);this.shared=i,this.pixelType=n,this.size=e,this.textureOnly=o,o||(this.data=new a(s.expect(r))),this._resetRange()}return t.prototype.destroy=function(){s.andThen(this._texture,(function(t){return t.dispose()}));var t=function(t){s.andThen(e._fbos[t],(function(e){"0"===t&&e.detachColorTexture(),e.dispose()})),e._fbos[t]=null},e=this;for(var i in this._fbos)t(i);this._texture=null},Object.defineProperty(t.prototype,"_textureDesc",{get:function(){return{target:3553,wrapMode:33071,pixelFormat:6408,dataType:this.pixelType,samplingMode:9728,width:this.size,height:this.size}},enumerable:!0,configurable:!0}),t.prototype.setData=function(t,e,i){var r=_(t),a=s.expect(this.data),u=r*this.texelSize+e;!a||u>=a.length?o("esri-2d-debug")&&!x&&(f.error(new n("mapview-attributeStore","Attempted to set out of bounds index")),x=!0):(a[u]=i,this.dirtyStart=Math.min(this.dirtyStart,r),this.dirtyEnd=Math.max(this.dirtyEnd,r))},t.prototype.getData=function(t,e){if(s.isNone(this.data))return null;var i=_(t)*this.texelSize+e;return!this.data||i>=this.data.length?(o("esri-2d-debug")&&!x&&(f.error(new n("mapview-attributeStore","Attempted to read out of bounds index")),x=!0),null):this.data[i]},t.prototype.getTexture=function(t){var e=this;return s.unwrapOr(this._texture,(function(){return e._initTexture(t)}))},t.prototype.getFBO=function(t,e){if(void 0===e&&(e=0),s.isNone(this._fbos[e])){var i=0===e?this.getTexture(t):this._textureDesc;this._fbos[e]=new T(t,{colorTarget:0,depthStencilTarget:0},i)}return this._fbos[e]},Object.defineProperty(t.prototype,"locked",{get:function(){return!(5121!==this.pixelType||!this.shared||this.textureOnly||!o("esri-atomics")||!this.data)&&1===Atomics.load(this.data,0)},enumerable:!0,configurable:!0}),t.prototype.updateTexture=function(t){if(!this.locked)try{var e=this.dirtyStart,i=this.dirtyEnd;if(e>i)return;this._resetRange();var r=s.expect(this.data).buffer,o=this.getTexture(t),a=(e-e%this.size)/this.size,u=(i-i%this.size)/this.size,d=a,h=this.size,l=u,T=a*this.size*4,c=4*(h+l*this.size)-T,_=p.getPixelArrayCtor(this.pixelType),x=_.BYTES_PER_ELEMENT;try{new _(r,T*x,c)}catch(t){console.debug(t)}var g=new _(r,T*x,c),y=this.size,b=l-d+1;if(b>this.size)return void f.error(new n("mapview-webgl","Out-of-bounds index when updating AttributeData"));o.updateData(0,0,d,y,b,g)}catch(t){console.debug(t)}},t.prototype.update=function(t){var e=t.data,i=t.start,r=t.end;if(s.isSome(e))for(var n=this.data,o=i*this.texelSize,a=0;a<e.length;a++){var u=1<<a%this.texelSize;t.layout&u&&(n[o+a]=e[a])}this.dirtyStart=Math.min(this.dirtyStart,i),this.dirtyEnd=Math.max(this.dirtyEnd,r)},t.prototype.resize=function(t,e){var i=this.size;if(this.size=e,this.textureOnly)i!==this.size&&(this._lastTexture=this._texture,this._texture=null);else{var r=p.getPixelArrayCtor(this.pixelType);this.destroy(),this.data=new r(s.expect(t.buffer))}},t.prototype._resetRange=function(){this.dirtyStart=2147483647,this.dirtyEnd=0},t.prototype._initTexture=function(t){var e=new d.Texture(t,this._textureDesc,s.unwrapOr(this.data,void 0));if(s.isSome(this._lastTexture)&&this._fbos[0]){var i=this._lastTexture.descriptor.width,r=this._lastTexture.descriptor.height,n=this._lastTexture.descriptor.dataType,o=this._lastTexture.descriptor.pixelFormat,a=this.getFBO(t),u=p.getPixelBytes(n),h=new(p.getPixelArrayCtor(n))(new ArrayBuffer(i*r*u*this.texelSize)),l=t.getBoundFramebufferObject(),T=t.getViewport(),f=T.x,c=T.y,_=T.width,x=T.height;t.bindFramebuffer(a),a.readPixels(0,0,i,r,o,n,h),e.updateData(0,0,0,2*i,r/2,h),t.setViewport(f,c,_,x),t.bindFramebuffer(l)}return this.destroy(),this._texture=e,this._texture},t}(),y=function(){function t(){this._initialized=!1,this._forceNextUpload=!1,this._locked=!1}return t.prototype.initialize=function(t){var e=t.blocks,i=t.shared,r=t.size;if(this.shared=i,this.size=r,c("Initializing AttributeStoreView",t),s.isNone(this._data))this._data=s.mapMany(e,(function(t){return new g(t,r,i)}));else for(var n=0;n<this._data.length;n++){var o=this._data[n],a=e[n];s.isSome(a)&&(s.isNone(o)?this._data[n]=new g(a,r,i):o.resize(a,r))}this._initialized=!0},t.prototype.destroy=function(){s.andThen(this._data,(function(t){return s.mapMany(t,(function(t){return t.destroy()}))})),s.andThen(this._defaultTexture,(function(t){return t.dispose()}))},t.prototype.getBlock=function(t){return s.isNone(this._data)?null:this._data[t]},t.prototype.setLabelMinZoom=function(t,e){this.setData(t,0,1,e)},t.prototype.getLabelMinZoom=function(t){return this.getData(t,0,1,255)},t.prototype.getFilterFlags=function(t){return this.getData(t,0,0,0)},t.prototype.getVVSize=function(t){return this.getData(t,h.ATTRIBUTE_DATA_VV,0,0)},t.prototype.getData=function(t,e,i,r){if(!this._data)return 0;var n=s.expect(this._data)[e];if(s.isNone(n))return 0;var o=n.getData(t,i);return s.isSome(o)?o:r},t.prototype.setData=function(t,e,i,r){var n=s.expect(this._data)[e];s.expect(n).setData(t,i,r)},t.prototype.lockTextureUpload=function(){this._locked=!0},t.prototype.unlockTextureUpload=function(){this._locked=!1},t.prototype.forceTextureUpload=function(){this._forceNextUpload=!0},t.prototype.requestUpdate=function(t){return r(this,void 0,void 0,(function(){var e;return i(this,(function(i){return this._pendingAttributeUpdate?(f.error(new n("mapview-webgl","Tried to update attribute data with a pending update")),[2]):(e=u.createResolver(),c("AttributeStoreView Update Requested",t),this._pendingAttributeUpdate={data:t,resolver:e},[2,e.promise])}))}))},t.prototype.update=function(){if(this._initialized&&s.isSome(this._pendingAttributeUpdate)){for(var t=this._pendingAttributeUpdate,e=t.data,i=t.resolver,r=s.expect(this._data),n=function(t){var i=e.blocks[t],n=r[t];s.andThen(n,(function(e){return s.andThen(i,(function(i){c("Updating block "+t,i),e.update(i)}))}))},o=0;o<e.blocks.length;o++)n(o);this._pendingAttributeUpdate=null,i()}},t.prototype.bindTextures=function(t){this.update();var e=this._getDefaultTexture(t);if(!this._initialized)return t.bindTexture(e,h.TEXTURE_BINDING_ATTRIBUTE_DATA_0),t.bindTexture(e,h.TEXTURE_BINDING_ATTRIBUTE_DATA_1),t.bindTexture(e,h.TEXTURE_BINDING_ATTRIBUTE_DATA_2),void t.bindTexture(e,h.TEXTURE_BINDING_ATTRIBUTE_DATA_3);var i=s.expect(this._data);this._locked&&!this._forceNextUpload||(s.forEachSome(i,(function(e){return e.updateTexture(t)})),this._forceNextUpload=!1),t.bindTexture(s.mapOr(i[0],e,(function(e){return e.getTexture(t)})),h.TEXTURE_BINDING_ATTRIBUTE_DATA_0),t.bindTexture(s.mapOr(i[1],e,(function(e){return e.getTexture(t)})),h.TEXTURE_BINDING_ATTRIBUTE_DATA_1),t.bindTexture(s.mapOr(i[2],e,(function(e){return e.getTexture(t)})),h.TEXTURE_BINDING_ATTRIBUTE_DATA_2),t.bindTexture(s.mapOr(i[3],e,(function(e){return e.getTexture(t)})),h.TEXTURE_BINDING_ATTRIBUTE_DATA_3)},t.prototype._getDefaultTexture=function(t){if(s.isNone(this._defaultTexture)){this._defaultTexture=new d.Texture(t,{wrapMode:33071,pixelFormat:6408,dataType:5121,samplingMode:9728,width:1,height:1},new Uint8Array(4))}return this._defaultTexture},t}();e.AttributeStoreView=y}));