// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../../../../core/tsSupport/extendsHelper","../../../../../../core/Error","../../../../../../core/Logger","../../../../../../core/maybe","../../../../../../core/screenUtils","../../../../../../core/libs/gl-matrix-2/mat2d","../../../../../../core/libs/gl-matrix-2/mat2df32","../../../../../../core/libs/gl-matrix-2/vec2","../../../../../../core/libs/gl-matrix-2/vec2f32","../../../../../../symbols/cim/enums","../../color","../../number","../../materialKey/MaterialKey","./util","./WGLBaseMarkerTemplate","./WGLDynamicMeshTemplate","../../util/Result"],(function(t,e,i,r,a,o,s,n,c,l,h,f,p,m,u,_,y,d,M){Object.defineProperty(e,"__esModule",{value:!0});var g=h.vec2f32.create(),x=c.mat2df32.create(),v=a.getLogger("esri.views.2d.engine.webgl.WGLDynamicMarkerTemplate"),L=function(t){function e(e,i){var r=t.call(this,i)||this;if(r._cimMarkerLayer=i,_.isFunction(i.color)){r._dynamicPropertyMap.set("_fillColor",(function(t,e,r){return p.premultiplyAlphaRGBA(i.color(t,e,r))}))}else r._fillColor=p.premultiplyAlphaRGBA(i.color);if(_.isFunction(i.outlineColor)){r._dynamicPropertyMap.set("_outlineColor",(function(t,e,r){return p.premultiplyAlphaRGBA(i.outlineColor(t,e,r))}))}else r._outlineColor=p.premultiplyAlphaRGBA(i.outlineColor);if(_.isFunction(i.size)){r._dynamicPropertyMap.set("_size",(function(t,e,r){return s.pt2px(i.size(t,e,r))}))}else r._size=s.pt2px(i.size);if(_.isFunction(i.scaleX)?r._dynamicPropertyMap.set("_scaleX",i.scaleX):r._scaleX=i.scaleX,_.isFunction(i.offsetX)){r._dynamicPropertyMap.set("xOffset",(function(t,e,r){return s.pt2px(i.offsetX(t,e,r))}))}else r.xOffset=s.pt2px(i.offsetX);if(_.isFunction(i.offsetY)){r._dynamicPropertyMap.set("yOffset",(function(t,e,r){return s.pt2px(i.offsetY(t,e,r))}))}else r.yOffset=s.pt2px(i.offsetY);if(_.isFunction(i.outlineWidth)){r._dynamicPropertyMap.set("_outlineWidth",(function(t,e,r){return s.pt2px(i.outlineWidth(t,e,r))}))}else r._outlineWidth=s.pt2px(i.outlineWidth);return _.isFunction(i.rotation)?r._dynamicPropertyMap.set("_angle",i.rotation):r._angle=i.rotation,r._scaleFactor=o.unwrapOr(i.scaleFactor,1),r._bitSet=(i.alignment===f.Alignment.MAP?1:0)|(i.colorLocked?1:0)<<1|(i.scaleSymbolsProportionally?1:0)<<3,r._materialKey=u.createMaterialKey(r.geometryType,e,!1),r}return i(e,t),e.fromCIMMarker=function(t,i){return new e(t,i)},e.prototype.bindFeature=function(t,e,i){var a=this;this._dynamicPropertyMap.forEach((function(r,o){a[o]=r(t,e,i)}));var o=this._cimMarkerLayer.materialHash,c="function"==typeof o?o(t,e,i):o,f=this._materialCache.get(c);if(f&&M.ok(f.spriteMosaicItem)&&f.spriteMosaicItem){var p=f.spriteMosaicItem,_=this._cimMarkerLayer.sizeRatio,y=p.width/p.height*this._scaleX,d=this._cimMarkerLayer.rotateClockwise?this._angle:-this._angle,L=this._size,b=L*y,k=this.xOffset*this._scaleFactor,F=this.yOffset*this._scaleFactor,P=this._cimMarkerLayer.scaleSymbolsProportionally&&this._cimMarkerLayer.frameHeight?this._size/s.pt2px(this._cimMarkerLayer.frameHeight):1,w=this._outlineWidth*P,z=s.pt2px(this._cimMarkerLayer.referenceSize),A=0,B=0,R=this._cimMarkerLayer.anchorPoint;R&&(this._cimMarkerLayer.isAbsoluteAnchorPoint?this._size&&(A=-R.x/(this._size*y),B=R.y/this._size):(A=R.x,B=R.y)),this._sizeOutlineWidth=m.i8888to32(Math.round(Math.sqrt(256*b)),Math.round(Math.sqrt(256*L)),Math.round(Math.sqrt(256*w)),Math.round(Math.sqrt(256*z))),n.mat2d.identity(x),n.mat2d.translate(x,x,h.vec2f32.fromValues(k,-F)),d&&n.mat2d.rotate(x,x,3.14159265359/180*d);var C=p.rect.x,W=p.rect.y,O=C+p.rect.width,X=W+p.rect.height;A=.5-((.5+A)*p.width+1)/p.rect.width,B=.5-((.5+B)*p.height+1)/p.rect.height,b*=_,L*=_,b*=this._scaleFactor,L*=this._scaleFactor;var G=Math.round(64*_),K=(A-.5)*(b*=p.rect.width/p.width),S=(B-.5)*(L*=p.rect.height/p.height);this._bitestAndDistRatio=m.i8888to32(0,0,this._bitSet,G),l.vec2.set(g,K,S),l.vec2.transformMat2d(g,g,x),this._offsetUpperLeft=m.i1616to32(16*g[0],16*g[1]),this._texUpperLeft=m.i1616to32(C,W),l.vec2.set(g,K+b,S),l.vec2.transformMat2d(g,g,x),this._offsetUpperRight=m.i1616to32(16*g[0],16*g[1]),this._texUpperRight=m.i1616to32(O,W),l.vec2.set(g,K,S+L),l.vec2.transformMat2d(g,g,x),this._offsetBottomLeft=m.i1616to32(16*g[0],16*g[1]),this._texBottomLeft=m.i1616to32(C,X),l.vec2.set(g,K+b,S+L),l.vec2.transformMat2d(g,g,x),this._offsetBottomRight=m.i1616to32(16*g[0],16*g[1]),this._texBottomRight=m.i1616to32(O,X);var q=u.MarkerMaterialKey.load(this._materialKey);q.sdf=p.sdf,q.pattern=!0,q.textureBinding=p.textureBinding,this._materialKey=q.data}else v.error(new r("mapview-cim","Encountered an error when binding feature"))},e}(y.default(d.default));e.default=L}));