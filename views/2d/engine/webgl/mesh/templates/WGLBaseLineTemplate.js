// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../../../../core/tsSupport/extendsHelper","../../../../../../core/has","../../../../../../core/Logger","../../definitions","../../enums","../../number","../../TileClipper","../../TurboLine","../../WGLDisplayRecord","../../materialKey/MaterialKey"],(function(e,t,i,r,n,o,s,l,a,h,u,f){Object.defineProperty(t,"__esModule",{value:!0});var p=n.getLogger("esri.views.2d.engine.webgl.WGLLineTemplateBase"),c=o.TILE_SIZE+16,d=new a.TileClipper(0,0,0,1,16);d.setExtent(o.TILE_SIZE);var _=0,x=0,y=0;r("esri-tiles-performance")&&setInterval((function(){console.log("New (FL)","feat="+y,"secs="+_,"tris="+x,"tris/sec="+Math.round(x/_))}),1e4);var v=new Uint32Array(9),m=new Uint32Array(36),g=new Uint32Array(3),C=new Uint32Array(6),M=function(e){return function(t){var i=Math.ceil(1024*e._halfWidth),r=Math.ceil(1024*e._halfReferenceWidth);t.entry0=e.offset+e.vertexCount++;var n=l.i1616to32(t.distance,i),o=l.i8888to32(Math.round(31*t.prevNormal.x),Math.round(31*t.prevNormal.y),Math.round(0),Math.round(-31)),s=l.i8888to32(0,0,0,e._bitset);m[0]=l.i1616to32(t.currentVertex.x,t.currentVertex.y),m[1]=e.id,m[2]=e._fillColor,m[3]=o,m[4]=n,m[5]=e._tl,m[6]=e._br,m[7]=s,m[8]=l.i1616to32(r,0),t.entry2=e.offset+e.vertexCount++;n=l.i1616to32(t.distance,i),o=l.i8888to32(Math.round(31*-t.prevNormal.x),Math.round(31*-t.prevNormal.y),Math.round(0),Math.round(31)),s=l.i8888to32(0,0,0,e._bitset);m[9]=l.i1616to32(t.currentVertex.x,t.currentVertex.y),m[10]=e.id,m[11]=e._fillColor,m[12]=o,m[13]=n,m[14]=e._tl,m[15]=e._br,m[16]=s,m[17]=l.i1616to32(r,0),t.exit0=e.offset+e.vertexCount++;n=l.i1616to32(t.distance,i),o=l.i8888to32(Math.round(31*t.nextNormal.x),Math.round(31*t.nextNormal.y),Math.round(0),Math.round(-31)),s=l.i8888to32(0,0,0,e._bitset);m[18]=l.i1616to32(t.currentVertex.x,t.currentVertex.y),m[19]=e.id,m[20]=e._fillColor,m[21]=o,m[22]=n,m[23]=e._tl,m[24]=e._br,m[25]=s,m[26]=l.i1616to32(r,0),t.exit2=e.offset+e.vertexCount++;n=l.i1616to32(t.distance,i),o=l.i8888to32(Math.round(31*-t.nextNormal.x),Math.round(31*-t.nextNormal.y),Math.round(0),Math.round(31)),s=l.i8888to32(0,0,0,e._bitset);m[27]=l.i1616to32(t.currentVertex.x,t.currentVertex.y),m[28]=e.id,m[29]=e._fillColor,m[30]=o,m[31]=n,m[32]=e._tl,m[33]=e._br,m[34]=s,m[35]=l.i1616to32(r,0),e.geometryBuf.writeRegion(m)}},b=function(e){return function(t){C[0]=t.leftExit0,C[1]=t.rightEntry0,C[2]=t.leftExit2,C[3]=t.rightEntry0,C[4]=t.rightEntry2,C[5]=t.leftExit2,e.indexCount+=6,e.indexBuf.writeRegion(C)}},T=function(e){return function(t,i,r,n,o,s,a,h,u){var f=l.i1616to32(u,Math.ceil(1024*e._halfWidth)),p=l.i8888to32(Math.round(31*o),Math.round(31*s),Math.round(31*a),Math.round(31*h)),c=l.i8888to32(31*r,31*n,0,e._bitset);return v[0]=l.i1616to32(t,i),v[1]=e.id,v[2]=e._fillColor,v[3]=p,v[4]=f,v[5]=e._tl,v[6]=e._br,v[7]=c,v[8]=l.i1616to32(Math.ceil(1024*e._halfReferenceWidth),0),e.geometryBuf.writeRegion(v),e.offset+e.vertexCount++}},w=function(e){return function(t,i,r){g[0]=t,g[1]=i,g[2]=r,e.indexCount+=3,e.indexBuf.writeRegion(g)}};t.default=function(e){return function(e){function t(){for(var t=[],i=0;i<arguments.length;i++)t[i]=arguments[i];var r=e.apply(this,t)||this;return r.tessellationProperties={_fillColor:null,_tl:null,_br:null,_halfWidth:null,_bitset:null,_halfReferenceWidth:null,id:null,indexBuf:null,indexCount:null,geometryBuf:null,vertexCount:null,offset:null},r._tessellationOptions={},r.geometryType=s.WGLGeometryType.LINE,r}return i(t,e),t.prototype.writeMesh=function(e,t,i,r,n){var o=t.indexVector,s=t.get("geometry"),l=new u(r,this.geometryType,this._materialKey),a=t.getVector("geometry").vertexCount;switch(l.vertexFrom=a,l.indexFrom=o.length,i){case"esriGeometryPolyline":var h=n.geometry.paths;if(0===(f=this._clipLines(h)).length)return;return this._write(l,o,s,a,r,f),void e.push(l);case"esriGeometryPolygon":var f,c=n.geometry.rings;if(0===(f=this._clipLines(c)).length)return;return this._write(l,o,s,a,r,f),void e.push(l);default:p.error("Unable to handle geometryType: "+i)}},t.prototype._clipLines=function(e){for(var t=[],i=!1,r=0;r<e.length;){var n=[],o=e[r];d.reset(2);var s=o[0],l=s[0],a=s[1];if(i)d.moveTo(l,a);else{if(l<-16||l>c||a<-16||a>c){i=!0;continue}n.push({x:l,y:a})}for(var h=!1,u=o.length,f=1;f<u;++f)if(l+=o[f][0],a+=o[f][1],i)d.lineTo(l,a);else{if(l<-16||l>c||a<-16||a>c){h=!0;break}n.push({x:l,y:a})}if(h)i=!0;else{if(i){var p=d.resultWithStarts();if(p)for(var _=0,x=p;_<x.length;_++){var y=x[_];t.push(y)}}else t.push({line:n,start:0});r++,i=!1}}return t},t.prototype._write=function(e,t,i,n,o,s){var l;r("esri-tiles-performance")&&(l=performance.now()),this.tessellationProperties.id=o,this.tessellationProperties.indexBuf=t,this.tessellationProperties.indexCount=0,this.tessellationProperties.geometryBuf=i,this.tessellationProperties.vertexCount=0,this.tessellationProperties.offset=n;for(var a=0,u=s;a<u.length;a++){var f=u[a],p=f.line;p.length<2||(this._tessellationOptions.initialDistance=f.start%65535,this._tessellationCallbacks instanceof h.StandardTessellationCallbacks&&(this._tessellationCallbacks.capType=this._capType,this._tessellationCallbacks.joinType=this._joinType),h.tessellate(p,this._tessellationOptions,this._tessellationCallbacks),h.cleanup(),r("esri-tiles-performance")&&y++)}e.vertexCount=this.tessellationProperties.vertexCount,e.indexCount=this.tessellationProperties.indexCount,e.zOrder=this._zOrder,r("esri-tiles-performance")&&(_+=(performance.now()-l)/1e3,x+=e.indexCount/3)},t.prototype._initializeTessellator=function(e){var t=f.LineMaterialKey.load(this._materialKey);if(this._tessellationOptions.trackDistance=this._isDashed||this._hasPattern,this._tessellationOptions.thin=!e&&this.tessellationProperties._halfWidth<o.THIN_LINE_THRESHOLD/2&&!(t.vvSizeFieldStops||t.vvSizeMinMaxValue||t.vvSizeScaleStops||t.vvSizeUnitValue),this._tessellationOptions.wrapDistance=65535,this._tessellationOptions.outerBisectorAutoSplitThreshold=1/3.8,this._tessellationOptions.enableOuterBisectorSplit=this._isDashed||this._hasPattern,this._tessellationOptions.innerBisectorAutoSplitThreshold=1/3.8,this._tessellationOptions.enableInnerBisectorSplit=this._isDashed||this._hasPattern,this._tessellationOptions.thin)this._tessellationCallbacks={vertex:M(this.tessellationProperties),bridge:b(this.tessellationProperties)};else{var i=new h.StandardTessellationCallbacks(T(this.tessellationProperties),w(this.tessellationProperties));i.miterLimitCosine=this._miterLimitCosine,i.textured=this._isDashed||this._hasPattern,i.joinOnUTurn=this._joinOnUTurn,this._tessellationCallbacks=i}},t}(e)}}));