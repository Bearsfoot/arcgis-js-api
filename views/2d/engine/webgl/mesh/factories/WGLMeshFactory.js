// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../../../../core/tsSupport/extendsHelper","../../../../../../core/tsSupport/generatorHelper","../../../../../../core/tsSupport/awaiterHelper","../../../../../../core/Error","../../../../../../core/has","../../../../../../core/Logger","../../../../../../core/maybe","../../../../../../core/promiseUtils","../../../../../../geometry/support/jsonUtils","../../../../../../symbols/SimpleLineSymbol","../../definitions","../../enums","../../WGLDisplayObject","../MeshData","../VertexVector","../templates/WGLLabelTemplate","../templates/WGLLineTemplate","../templates/WGLMarkerTemplate","../templates/WGLTemplateStore"],(function(e,t,r,o,l,i,a,n,s,p,y,u,m,c,h,b,f,g,d,L,_){Object.defineProperty(t,"__esModule",{value:!0});var T=n.getLogger("esri.views.2d.engine.webgl.WGLMeshFactory"),G={esriGeometryPoint:["above-right","above-center","above-left","center-center","center-left","center-right","below-center","below-left","below-right"],esriGeometryPolygon:["always-horizontal"],esriGeometryPolyline:["center-along"],esriGeometryMultipoint:null,esriGeometryEnvelope:null},v=function(){function e(e,t,r,o,l,i){this._isDD=!1,this._labelsDebugTemplate=null,this._isDD=s.isSome(r)&&"dot-density"===r.type,this._geometryType=e,this._idField=t,this._templateStore=o,this._setLabelTemplates(l,r,i)}return e.prototype.update=function(e,t,r){this._isDD=s.isSome(t)&&"dot-density"===t.type,this._setLabelTemplates(e,t,r)},e.prototype._setLabelTemplates=function(e,t,r){e&&this._validateLabelingInfo(e)&&(this._labelTemplates=e.map((function(e){return g.default.fromLabelClass(t,e,r)})))},Object.defineProperty(e.prototype,"templates",{get:function(){return this._templateStore},enumerable:!0,configurable:!0}),e.prototype.createMeshData=function(e){var t=new Array(5),r=new Array,o=this._labelTemplates&&this._labelTemplates.length>0,l="esriGeometryPolyline"===this._geometryType?m.HEURISTIC_GLYPHS_PER_LINE:m.HEURISTIC_GLYPHS_PER_FEATURE;return t[c.WGLGeometryType.MARKER]=new f.VertexVectors(c.WGLGeometryType.MARKER,e),t[c.WGLGeometryType.FILL]=new f.VertexVectors(c.WGLGeometryType.FILL,e,this._isDD),t[c.WGLGeometryType.LINE]=new f.VertexVectors(c.WGLGeometryType.LINE,e),t[c.WGLGeometryType.TEXT]=new f.VertexVectors(c.WGLGeometryType.TEXT,e),t[c.WGLGeometryType.LABEL]=new f.VertexVectors(c.WGLGeometryType.LABEL,o?l:0),new b.MeshData(r,t)},e.prototype.analyze=function(e,t,r,i,a){return l(this,void 0,void 0,(function(){var l,n,y,u,m,c,h,b,f;return o(this,(function(o){switch(o.label){case 0:return l=e,p.isAborted(a)?[2,[]]:s.isSome(t)?[4,t.analyze(this._idField,e,r,i,a)]:[3,2];case 1:o.sent(),o.label=2;case 2:for(n=0,y=l;n<y.length;n++){if(u=y[n],null!=(m=u.groupId)&&-1!==m||(m=t.match(this._idField,u,this._geometryType,r,i)),_.isDynamicId(m))for(c=this._templateStore.getDynamicTemplateGroup(m),h=0,b=c;h<b.length;h++)(f=b[h])&&f.analyze&&f.analyze(this._templateStore,u,r,i);u.groupId=m}return[2,this._templateStore.finalize(a).then((function(){return l}))]}}))}))},e.prototype.write=function(e,t,r,o,l,i){var n=this._templateStore.getTemplateGroup(t.groupId),p=e,u=t.localId;if(null!=u){var m=new h(u);if(_.isDynamicId(t.groupId))for(var c=0,b=n;c<b.length;c++){(G=b[c]).bindFeature(t,r,o)}if(n&&(t.geometry||t.centroid)){var f=m.displayRecords,g=t.insertAfter;void 0!==g&&(m.insertAfter=g);var d=this._geometryType;d||(d=null!=t.centroid?"esriGeometryPolygon":y.getJsonType(t.geometry));for(var L=0,T=n;L<T.length;L++){var G=T[L],v=p.get(G.geometryType);G.writeMesh(f,v,d,u,t)}if(s.isSome(i)){var w=i&&this._findLabelRef(n);this._writeLabels(m,p,u,t,i,w,l)}p.pushDisplayObject(m)}}else a("esri-2d-debug")&&console.debug("Got null id for feature")},e.prototype._hasBadLabelClass=function(e,t){var r=e.labelPlacement,o=G[t];if(!e.symbol)return T.warn("No LabelClass symbol specified."),!0;if(!o)return T.error(new i("mapview-labeling:unsupported-geometry-type","Unable to create labels for Feature Layer, "+t+" is not supported")),!0;if(!o.some((function(e){return e===r}))){var l=o[0];r&&T.warn("Found invalid label placement type "+r+" for "+t+". Defaulting to "+l),e.labelPlacement=l}return!1},e.prototype._validateLabelingInfo=function(e){var t=this;return!e.some((function(e){return t._hasBadLabelClass(e,t._geometryType)}))},e.prototype._findLabelRef=function(e){for(var t=0,r=e;t<r.length;t++){var o=r[t];if(o instanceof L.default)return o}return null},e.prototype._writeLabels=function(e,t,r,o,l,i,a){for(var n=e.displayRecords,p=[],y=0,u=l;y<u.length;y++){var c=u[y];if(s.isSome(c)){var h=c.glyphs,b=c.rtl,f=c.classIndex,g=this._labelTemplates[f],d=t.get(g.geometryType);g.bindReferenceTemplate(i),g.bindTextInfo(h,b),g.writeMesh(n,d,this._geometryType,r,o,a,p)}}e.metrics=p,m.DEBUG_LABELS&&this._debugLabels(e,t)},e.prototype._debugLabels=function(e,t){for(var r=e.displayRecords,o=e.id,l=0,i=e.metrics;l<i.length;l++)for(var a=i[l],n=0,s=a.boxes?a.boxes.concat([a.bounds]):[a.bounds];n<s.length;n++){var p=s[n],y=a.anchor[0]+a.offsetX+p.center[0],u=a.anchor[1]+a.offsetY+p.center[1],m={geometry:{paths:[[[y-p.width/2,u+p.height/2],[0,-p.height],[p.width,0],[0,p.height],[-p.width,0]]]},attributes:{}},c=this._getLabelDebugTemplate(),h=t.get(c.geometryType);c.writeMesh(r,h,"esriGeometryPolyline",o,m)}},e.prototype._getLabelDebugTemplate=function(){return this._labelsDebugTemplate||(this._labelsDebugTemplate=this._createLabelsDebugTemplate()),this._labelsDebugTemplate},e.prototype._createLabelsDebugTemplate=function(){var e=new u({style:"solid",width:1,color:[255,0,0,1]});return d.default.fromSimpleLine(null,!1,e,null,!1)},e}();t.WGLMeshFactory=v}));