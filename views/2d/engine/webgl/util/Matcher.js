// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/extendsHelper","../../../../../core/tsSupport/generatorHelper","../../../../../core/tsSupport/awaiterHelper","../../../../../core/tsSupport/assignHelper","../../../../../core/Error","../../../../../core/Logger","../../../../../core/maybe","../../../../../core/promiseUtils","../../../../../support/arcadeOnDemand","../../../../../symbols/support/cimSymbolUtils","../../../arcade/utils"],(function(e,t,r,n,i,a,s,l,u,o,c,f,p){Object.defineProperty(t,"__esModule",{value:!0});var h=l.getLogger("esri/views/2d/engine/webgl/util/Matcher"),d=function(){function e(){this._defaultResult=null}return e.fromBasicRenderer=function(t,r,a){return i(this,void 0,void 0,(function(){var i,s,l;return n(this,(function(n){switch(n.label){case 0:return[4,f.expandSymbols(t.getSymbols(),t,a)];case 1:return i=n.sent(),s=new e,i.length?[4,r.createTemplateGroup(i[0],null,t)]:[3,3];case 2:l=n.sent(),s.setDefault(l),n.label=3;case 3:return[2,s]}}))}))},e.prototype.size=function(){return 1},e.prototype.getDefault=function(){return this._defaultResult},e.prototype.setDefault=function(e){this._defaultResult=e},e.prototype.match=function(e,t,r,n,i){return this.getDefault()},e.prototype.analyze=function(e,t,r,a,s){return i(this,void 0,void 0,(function(){return n(this,(function(e){return[2]}))}))},e}();t.FeatureMatcher=d;var m=function(e){function t(t,r,n,i){var a=e.call(this)||this;return a._intervals=[],a._isMaxInclusive=r,i?a._getValue=p.callWithFeature.bind(null,i):t&&t.length?"function"==typeof t?(a._field=null,a._getValue=t):(a._field=t,a._normalizationInfo=n,a._getValue=a._getValueFromField.bind(a)):a._field=null,a}return r(t,e),t.fromCBRenderer=function(e,r,a){return i(this,void 0,void 0,(function(){var s,l,u,p,h,d,m,_,v,y,b,g,z=this;return n(this,(function(w){switch(w.label){case 0:return s=e.isMaxInclusive,l=e.normalizationField,u=e.normalizationTotal,p=e.normalizationType,h=e.field,d={normalizationField:l,normalizationTotal:u,normalizationType:p},m=e.valueExpression,(_=m)?[4,c.createRendererExpression(m,a.spatialReference,a.fields)]:[3,2];case 1:_=w.sent(),w.label=2;case 2:return v=new t(h,s,d,_),[4,f.expandSymbol(e.backgroundFillSymbol,e,a)];case 3:return y=w.sent(),[4,o.all(e.classBreakInfos.map((function(t){return i(z,void 0,void 0,(function(){var i,s,l;return n(this,(function(n){switch(n.label){case 0:return[4,f.expandSymbol(t.symbol,e,a)];case 1:return i=n.sent(),[4,r.createTemplateGroup(i,y,e)];case 2:return s=n.sent(),l={min:t.minValue,max:t.maxValue},v.add(l,s),[2]}}))}))})))];case 4:return w.sent(),[4,f.expandSymbol(e.defaultSymbol,e,a)];case 5:return(b=w.sent())?[4,r.createTemplateGroup(b,y,e)]:[3,7];case 6:g=w.sent(),v.setDefault(g),w.label=7;case 7:return[2,v]}}))}))},t.prototype.add=function(e,t){this._intervals.push({interval:e,result:t}),this._intervals.sort((function(e,t){return e.interval.min-t.interval.min}))},t.prototype.size=function(){return e.prototype.size.call(this)+this._intervals.length},t.prototype.match=function(e,t,r,n,i){if(!this._getValue)return this.getDefault();var a=this._getValue(t,{$view:i},r,n);if(!a&&(null==a||isNaN(a)))return this.getDefault();for(var s=0;s<this._intervals.length;s++){var l=this._intervals[s],u=l.interval,o=l.result,c=a>=u.min,f=this._isMaxInclusive?a<=u.max:a<u.max;if(c&&f)return o}return this.getDefault()},t.prototype._needsNormalization=function(){var e=this._normalizationInfo;return e&&(e.normalizationField||e.normalizationTotal||e.normalizationType)},t.prototype._getValueFromField=function(e){var t=e.attributes[this._field];if(!this._needsNormalization())return t;var r=this._normalizationInfo,n=r.normalizationField,i=r.normalizationTotal,a=r.normalizationType,s=!!n&&e.attributes[n];if(a)switch(a){case"field":return s?t/s:void 0;case"log":return Math.log(t)*Math.LOG10E;case"percent-of-total":return t/i*100;default:return void h.error("Found unknown normalization type: "+a)}else h.error("Normalization is required, but no type was set!")},t}(d);t.IntervalMatcher=m;var _=function(e){function t(t,r,n){var i=e.call(this)||this;return i._nullResult=null,i._resultsMap=new Map,n?i._getValue=p.callWithFeature.bind(null,n):t&&t.length?"function"==typeof t[0]?(i._fields=null,i._getValue=t[0]):(i._fields=t,i._seperator=r||"",i._getValue=i._getValueFromFields.bind(i)):i._fields=null,i}return r(t,e),t.fromUVRenderer=function(e,r,a){return i(this,void 0,void 0,(function(){var s,l,u,p,h,d,m,_,v=this;return n(this,(function(y){switch(y.label){case 0:return s=e.uniqueValueInfos,l=e.fieldDelimiter,u=[e.field],p=e.valueExpression,e.field2&&u.push(e.field2),e.field3&&u.push(e.field3),[4,f.expandSymbol(e.backgroundFillSymbol,e,a)];case 1:return h=y.sent(),(d=p)?[4,c.createRendererExpression(p,a.spatialReference,a.fields)]:[3,3];case 2:d=y.sent(),y.label=3;case 3:return m=new t(u,l,d),[4,o.all(s.map((function(t){return i(v,void 0,void 0,(function(){var i,s;return n(this,(function(n){switch(n.label){case 0:return[4,f.expandSymbol(t.symbol,e,a)];case 1:return i=n.sent(),[4,r.createTemplateGroup(i,h,e)];case 2:return s=n.sent(),"<Null>"===t.value?m.setNullResult(s):m.add(t.value,s),[2]}}))}))})))];case 4:return y.sent(),[4,f.expandSymbol(e.defaultSymbol,e,a)];case 5:return y.sent()?[4,r.createTemplateGroup(e.defaultSymbol,h,e)]:[3,7];case 6:_=y.sent(),m.setDefault(_),y.label=7;case 7:return[2,m]}}))}))},t.prototype.setNullResult=function(e){this._nullResult=e},t.prototype.add=function(e,t){this._resultsMap.set(e.toString(),t)},t.prototype.size=function(){return e.prototype.size.call(this)+this._resultsMap.size},t.prototype.match=function(e,t,r,n,i){if(!this._getValue)return this.getDefault();var a=this._getValue(t,{$view:i},r,n);if(null!==this._nullResult&&(null==a||""===a||"<Null>"===a))return this._nullResult;if(!a&&null==a)return this.getDefault();var s=a.toString();return this._resultsMap.has(s)?this._resultsMap.get(s):this.getDefault()},t.prototype._getValueFromFields=function(e){for(var t=[],r=0,n=this._fields;r<n.length;r++){var i=n[r],a=e.attributes[i];t.push(a)}return t.join(this._seperator)},t}(d);function v(e,t){return i(this,void 0,void 0,(function(){var r,i;return n(this,(function(n){switch(n.label){case 0:return"number"==typeof(r=e||1)?[2,function(e,t,n){return r}]:[4,c.createRendererExpression(r,t.spatialReference,t.fields)];case 1:return i=n.sent(),[2,function(e,r,n){return p.callWithFeature(i,e,{$view:n},t.geometryType,r)||1}]}}))}))}t.MapMatcher=_;var y=function(e){function t(t,r,n,i){var a=e.call(this)||this;return a._fidToAttributeHash=new Map,a._attributeHashToGroup=new Map,a._renderer=t,a._fieldMap=t.fieldMap,a._templates=r,a._info=n,a._scaleFn=i,a}return r(t,e),t.fromDictionaryRenderer=function(e,r,a){return i(this,void 0,void 0,(function(){var i;return n(this,(function(n){switch(n.label){case 0:return e.fetchResources({spatialReference:a.spatialReference,fields:a.fields}),[4,v(e.scaleExpression,a)];case 1:return i=n.sent(),[2,new t(e,r,a,i)]}}))}))},t.prototype._analyzeFeature=function(e,t,r,l,u){return i(this,void 0,void 0,(function(){var i,o,c,p,d,m,_,v,y,b,g;return n(this,(function(n){switch(n.label){case 0:return i=e.attributes[t],o=this._fidToAttributeHash.get(i),c=this._hashAttributes(e),o===c?[2]:this._attributeHashToGroup.has(c)?[3,4]:(p=a({},l,{spatialReference:this._info.spatialReference,abortOptions:u,fields:this._info.fields}),d=this._scaleFn(e,r,l),[4,this._renderer.getSymbolAsync(e,p)]);case 1:return m=n.sent(),[4,f.expandSymbol(m,this._renderer,this._info,u)];case 2:if("expanded-cim"!==(_=n.sent()).type)return h.error(new s("mapview-bad-type","Found unexpected type "+_.type+" in dictionary response")),[2];for(v=0,y=_.layers;v<y.length;v++)(b=y[v]).scaleFactor=d,b.templateHash+="-"+d;return[4,this._templates.createTemplateGroup(_,null,this._renderer)];case 3:g=n.sent(),this._attributeHashToGroup.set(c,g),n.label=4;case 4:return this._fidToAttributeHash.set(i,c),[2]}}))}))},t.prototype.analyze=function(e,t,r,a,s){return i(this,void 0,void 0,(function(){var i,l=this;return n(this,(function(n){switch(n.label){case 0:return i=t.map((function(t){return l._analyzeFeature(t,e,r,a,s)})),[4,o.all(i)];case 1:return n.sent(),[2]}}))}))},t.prototype.match=function(e,t){var r=t.attributes[e],n=this._fidToAttributeHash.get(r);return this._attributeHashToGroup.get(n)},t.prototype._hashAttributes=function(e){var t="";for(var r in this._fieldMap)t+=". "+e.attributes[this._fieldMap[r]];return t},t}(d);t.DictionaryMatcher=y;var b=function(e){function t(t){var r=e.call(this)||this;return r._templates=t,r}return r(t,e),t.prototype.match=function(e,t){return u.isNone(t.symbol)?0:t.groupId?t.groupId:this._templates.createTemplateGroup(t.symbol,null,null)},t}(d);t.GraphicMatcher=b}));