// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/extendsHelper","../../../core/tsSupport/decorateHelper","../../../geometry","../../../core/arrayUtils","../../../core/lang","../../../core/maybe","../../../core/unitUtils","../../../core/libs/gl-matrix-2/mat2d","../../../core/libs/gl-matrix-2/mat2df64","../../../core/libs/gl-matrix-2/quat","../../../core/libs/gl-matrix-2/quatf64","../../../core/libs/gl-matrix-2/vec3","../../../core/libs/gl-matrix-2/vec3f64","../../../geometry/Circle","../../../geometry/geometryEngine","../../../geometry/support/coordsUtils","../../../geometry/support/spatialReferenceUtils"],(function(e,r,t,a,n,o,i,l,s,c,f,u,p,m,d,y,h,v,x){function g(e,r,t){return void 0===t&&(t=null),l.isSome(t)?[e,r,t]:[e,r]}function R(e,r,t){return void 0===t&&(t=null),l.isSome(t)?{x:e,y:r,z:t}:{x:e,y:r}}Object.defineProperty(r,"__esModule",{value:!0}),r.makeMapPoint=g,r.makeSurfacePoint=R;var M=function(){function e(e){this.spatialReference=e}return e.prototype.mapToLocalMultiple=function(e){var r=this;return e.map((function(e){return r.mapToLocal(e)}))},Object.defineProperty(e.prototype,"doUnnormalization",{get:function(){return!1},enumerable:!0,configurable:!0}),e}();r.SurfaceCoordinateSystem=M;var w=function(e){function r(r,t,a){void 0===a&&(a=null);var n=e.call(this,t)||this;return n.defaultZ=a,n.transform=f.mat2df64.create(),n.transformInv=f.mat2df64.create(),n.transform=f.mat2df64.clone(r),c.mat2d.invert(n.transformInv,n.transform),n}return t(r,e),r.prototype.makeMapPoint=function(e,r){return g(e,r,this.defaultZ)},r.prototype.mapToLocal=function(e){return R(this.transform[0]*e[0]+this.transform[2]*e[1]+this.transform[4],this.transform[1]*e[0]+this.transform[3]*e[1]+this.transform[5])},r.prototype.localToMap=function(e){return g(this.transformInv[0]*e.x+this.transformInv[2]*e.y+this.transformInv[4],this.transformInv[1]*e.x+this.transformInv[3]*e.y+this.transformInv[5],this.defaultZ)},r}(M);r.AffineCoordinateSystem=w;var S=function(e){function r(r,t){var a=e.call(this,r.spatialReference)||this;a.view=r,a.defaultZ=null,a.pWS=d.vec3f64.create(),a.tangentFrameUpWS=d.vec3f64.create(),a.tangentFrameRightWS=d.vec3f64.create(),a.tangentFrameForwardWS=d.vec3f64.create(),a.localFrameRightWS=d.vec3f64.create(),a.localFrameUpWS=d.vec3f64.create(),a.worldToLocalTransform=p.quatf64.create(),a.localToWorldTransform=p.quatf64.create(),a.scale=1,a.scale=r.resolution,a.referenceMapPoint=t,a.defaultZ=t.hasZ?t.z:null;var n=r.state.camera.viewRight;a.view.renderCoordsHelper.toRenderCoords(a.referenceMapPoint,a.pWS),a.view.renderCoordsHelper.worldBasisAtPosition(a.pWS,0,a.tangentFrameRightWS),a.view.renderCoordsHelper.worldBasisAtPosition(a.pWS,1,a.tangentFrameUpWS),a.view.renderCoordsHelper.worldBasisAtPosition(a.pWS,2,a.tangentFrameForwardWS);var o=d.vec3f64.create();return m.vec3.scale(o,a.tangentFrameForwardWS,m.vec3.dot(n,a.tangentFrameForwardWS)),m.vec3.subtract(a.localFrameRightWS,n,o),m.vec3.normalize(a.localFrameRightWS,a.localFrameRightWS),m.vec3.cross(a.localFrameUpWS,a.tangentFrameForwardWS,a.localFrameRightWS),u.quat.rotationTo(a.worldToLocalTransform,a.localFrameRightWS,a.tangentFrameRightWS),u.quat.invert(a.localToWorldTransform,a.worldToLocalTransform),a}return t(r,e),Object.defineProperty(r.prototype,"doUnnormalization",{get:function(){return"global"===this.view.viewingMode},enumerable:!0,configurable:!0}),r.prototype.makeMapPoint=function(e,r){return g(e,r,this.defaultZ)},r.prototype.mapToLocal=function(e){var r=d.vec3f64.create();this.view.renderCoordsHelper.toRenderCoords(new n.Point({x:e[0],y:e[1],spatialReference:this.spatialReference}),r),m.vec3.transformQuat(r,r,this.worldToLocalTransform);var t=this.view.renderCoordsHelper.fromRenderCoords(r,this.view.spatialReference);return R(t.x/this.scale,t.y/this.scale)},r.prototype.localToMap=function(e){var r=d.vec3f64.create();this.view.renderCoordsHelper.toRenderCoords(new n.Point({x:e.x*this.scale,y:e.y*this.scale,spatialReference:this.spatialReference}),r),m.vec3.transformQuat(r,r,this.localToWorldTransform);var t=this.view.renderCoordsHelper.fromRenderCoords(r,this.view.spatialReference);return g(t.x,t.y,this.defaultZ)},r}(M);function T(e,r){var t=new n.Point({x:e[0],y:e[1],spatialReference:r});return e.length>2&&(t.z=e[2]),t}function W(e,r,t,a){void 0===a&&(a=!0);var l=i.clone(e);l.forEach((function(e){var r=e[0],t=e[e.length-1];o.equals(r,t)||e.push(e[0])}));var s=new n.Polygon({rings:l,spatialReference:r});return s.rings.forEach((function(e){v.isClockwise(e,!1,!1)||e.reverse()})),t&&v.unnormalizeGeometryOnDatelineCrossing(s),a&&s.isSelfIntersecting&&x.isValid(r)&&(s=h.simplify(s)),s}r.SceneViewCoordinateSystem=S,r.createViewAlignedCoordinateSystem=function(e,r){if("2d"===e.type)return new w(e.state.transform,e.spatialReference,r.length>2?r[2]:null);if("3d"===e.type){var t=r.length>2?new n.Point({x:r[0],y:r[1],z:r[2],spatialReference:e.spatialReference}):new n.Point({x:r[0],y:r[1],spatialReference:e.spatialReference});return new S(e,t)}return null},r.createPoint=T,r.createMultipoint=function(e,r){return new n.Multipoint({points:e,spatialReference:r})},r.createPolyline=function(e,r,t){var a=new n.Polyline({paths:e,spatialReference:r});return t&&v.unnormalizeGeometryOnDatelineCrossing(a),a},r.createPolygon=W,r.createSquare=function(e,r,t){var a=r.mapToLocalMultiple(e),n=[],o={x:a[0].x,y:a[0].y},i=a[1].x,l=a[1].y,s=Math.round(i-o.x),c=Math.round(l-o.y),f=Math.max(Math.abs(s),Math.abs(c));if(t){var u={x:o.x+f,y:o.y+f},p={x:o.x-f,y:o.y-f};n.push(R(u.x,p.y),R(p.x,p.y),R(p.x,u.y),R(u.x,u.y))}else{var m={x:s>0?o.x+f:o.x-f,y:c>0?o.y+f:o.y-f};n.push(R(o.x,o.y),R(m.x,o.y),R(m.x,m.y),R(o.x,m.y))}return W([n.map((function(e){return r.localToMap(e)}))],r.spatialReference,r.doUnnormalization,!0)},r.createRectangle=function(e,r,t){var a=r.mapToLocalMultiple(e);if(1===a.length){var n=48,o=a[0];a=[R(o.x-n,o.y+n),R(o.x+n,o.y-n),R(o.x+n,o.y-n),R(o.x-n,o.y+n)]}var i=[],l={x:a[0].x,y:a[0].y},s={x:a[1].x,y:a[1].y};if(t){var c=Math.round(s.x-l.x),f=Math.round(s.y-l.y);i.push(R(l.x-c,l.y-f),R(s.x,l.y-f),R(s.x,s.y),R(l.x-c,s.y))}else i.push(R(l.x,l.y),R(s.x,l.y),R(s.x,s.y),R(l.x,s.y));return W([i.map((function(e){return r.localToMap(e)}))],r.spatialReference,r.doUnnormalization,!0)},r.createCircle=function(e,r,t){var a=r.mapToLocalMultiple(e),n=null,o=null;if(t)n=a[0],o=a[1];else{var i=a[0],l=a[1],c=Math.round(l.x-i.x),f=Math.round(l.y-i.y),u=Math.max(Math.abs(c),Math.abs(f));n=R(c>0?i.x+u/2:i.x-u/2,f>0?i.y+u/2:i.y-u/2),o=R(Math.abs(c)>Math.abs(f)?n.x-u/2:n.x,Math.abs(c)>Math.abs(f)?n.y:n.y-u/2)}var p=r.localToMap(n),m=r.localToMap(o);r.doUnnormalization&&v.unnormalizeVerticesOnDatelineCrossing([[p,m]],r.spatialReference);var d=T(p,r.spatialReference),x=T(m,r.spatialReference),g=s.getMetersPerUnitForSR(r.spatialReference)*h.distance(d,x,null),M=new y({center:d,radius:g,radiusUnit:"meters",spatialReference:r.spatialReference});return W(M.rings,M.spatialReference,!1)},r.createEllipse=function(e,r,t){for(var a=r.mapToLocalMultiple(e),n=a[0],o=a[1],i=Math.round(o.x-n.x),l=Math.round(o.y-n.y),s=R(t?n.x:n.x+i/2,t?n.y:n.y+l/2),c=t?i:i/2,f=t?l:l/2,u=[],p=2*Math.PI/60,m=0;m<60;m++){var d=Math.cos(m*p),y=Math.sin(m*p),h=R(c*d+s.x,f*y+s.y);u.push(h)}return u.push(u[0]),W([u.map((function(e){return r.localToMap(e)}))],r.spatialReference,r.doUnnormalization,!1)}}));