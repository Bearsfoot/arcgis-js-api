// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/decorateHelper","../../core/tsSupport/declareExtendsHelper","../../core/tsSupport/assignHelper","../../core/Accessor","../../core/compilerUtils","../../core/Evented","../../core/maybe","../../core/screenUtils","../../core/accessorSupport/decorators","../../core/accessorSupport/ensureType","../../core/libs/gl-matrix-2/mat3","../../core/libs/gl-matrix-2/mat3f64","../../core/libs/gl-matrix-2/mat4","../../core/libs/gl-matrix-2/mat4f64","../../core/libs/gl-matrix-2/vec2","../../core/libs/gl-matrix-2/vec2f32","../../core/libs/gl-matrix-2/vec3","../../core/libs/gl-matrix-2/vec3f64","../../geometry/support/aaBoundingRect","../../layers/graphics/dehydratedFeatures","../3d/support/ElevationProvider","../3d/support/geometryUtils","../3d/support/projectionUtils","../3d/support/stack","../3d/webgl-engine/lib/Intersector","../3d/webgl-engine/lib/intersectorUtils","../3d/webgl-engine/lib/Layer","../3d/webgl-engine/lib/Object3D"],(function(e,t,r,i,n,o,s,a,c,l,p,u,d,h,f,g,_,y,b,m,v,P,S,O,j,R,T,A,w,M){Object.defineProperty(t,"__esModule",{value:!0});var E=function(e){function t(t){var r=e.call(this,t)||this;return r.hideOnGrab=!1,r.moveOnDrag=!0,r.snapToPointer=!0,r.collisionType={type:"point"},r.collisionPriority=0,r.renderObjects=[],r.autoScaleRenderObjects=!0,r._radius=10,r._worldSized=!1,r._focusMultiplier=2,r._touchMultiplier=2.5,r.interactive=!0,r.selectable=!1,r.cursor=null,r.dragging=!1,r._areAnyEngineObjectsVisible=!1,r.events=new a({target:r}),r._position=m.vec3f64.create(),r._modelTransform=g.mat4f64.create(),r._dragOffset=null,r._dirtyScreenPoint=l.createScreenPoint(),r._dirtyScreenPointArray=l.createScreenPointArray(),r._dirtyRenderScreenPointArray=l.createRenderScreenPointArray3(),r._dirtyOriginScreenPointArray=l.createScreenPointArray(),r._dirtyScreenPixelSize=1,r._screenPositionDirty=!0,r._engineResourcesAddedToStage=!1,r._engineResources=null,r._attached=!1,r._engineLayerId=null,r._materialIdReferences=null,r._hitResult={onSurface:!1,surfaceType:"ground"},r}return i(t,e),t.prototype.initialize=function(){var e=this;this._intersector=new T.Intersector(this.view.viewingMode),this._mapPoint=P.makeDehydratedPoint(0,0,0,this.view.spatialReference),this.events.on("drag",(function(t){return e.drag(t)}))},t.prototype.destroy=function(){this._removeResourcesFromStage(),this._engineResources=null,this._set("view",null),this._camera=null},Object.defineProperty(t.prototype,"alignment",{get:function(){return this._get("alignment")},set:function(e){this._set("alignment",e),this.constructed&&this._refreshMapPoint()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"visible",{set:function(e){e!==this._get("visible")&&(this._set("visible",e),this._updateEngineObject())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"radius",{get:function(){return this._radius},set:function(e){e!==this._radius&&(this._radius=e,this._updateEngineObject())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"worldSized",{get:function(){return this._worldSized},set:function(e){e!==this._worldSized&&(this._worldSized=e,this._updateEngineObject())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"focusMultiplier",{get:function(){return this._focusMultiplier},set:function(e){this._focusMultiplier=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"touchMultiplier",{get:function(){return this._touchMultiplier},set:function(e){this._touchMultiplier=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"modelTransform",{get:function(){return this._modelTransform},set:function(e){I(e)&&(this._screenPositionDirty=!0),f.mat4.copy(this._modelTransform,e),this._updateEngineObject()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"position",{get:function(){return this._position},set:function(e){this.view.renderCoordsHelper.fromRenderCoords(e,this._mapPoint,this._mapPoint.spatialReference),this._refreshMapPoint()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"mapPoint",{get:function(){return this._mapPoint},set:function(e){P.clonePoint(e,this._mapPoint),this._refreshMapPoint()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"grabbing",{set:function(e){e!==this._get("grabbing")&&(this._set("grabbing",e),this._updateEngineObject()),e||(this._dragOffset=null)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hovering",{set:function(e){e!==this._get("hovering")&&(this._set("hovering",e),this._updateEngineObject())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"selected",{set:function(e){e!==this._get("selected")&&(this._set("selected",e),this._updateEngineObject())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"state",{set:function(e){e!==this._get("state")&&(this._set("state",e),this._updateEngineObject())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"areAnyEngineObjectsVisible",{get:function(){return this._areAnyEngineObjectsVisible},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"surfaceType",{get:function(){return this._hitResult.onSurface?this._hitResult.surfaceType:null},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"focused",{get:function(){return this._focused},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"_focused",{get:function(){return this._get("hovering")||this._get("grabbing")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"screenPoint",{get:function(){return this._updateScreenSpaceProperties(),this._dirtyScreenPoint},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"_screenPointArray",{get:function(){return this._updateScreenSpaceProperties(),this._dirtyScreenPointArray},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"_renderScreenPointArray",{get:function(){return this._updateScreenSpaceProperties(),this._dirtyRenderScreenPointArray},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"_originScreenPointArray",{get:function(){return this._updateScreenSpaceProperties(),this._dirtyOriginScreenPointArray},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"_screenPixelSize",{get:function(){return this._updateScreenSpaceProperties(),this._dirtyScreenPixelSize},enumerable:!0,configurable:!0}),t.prototype._updateScreenSpaceProperties=function(){if(this._screenPositionDirty){this._screenPositionDirty=!1,this._dirtyScreenPixelSize=this._camera.computeScreenPixelSizeAt(this._position);var e,t=I(this._modelTransform);if(t){var r=this._calculateModelTransformOffset(q);e=b.vec3.add(r,r,this._position)}else e=this._position;this._camera.projectPoint(e,this._dirtyRenderScreenPointArray),this._camera.renderToScreen(this._dirtyRenderScreenPointArray,this._dirtyScreenPointArray),l.screenPointArrayToObject(this._dirtyScreenPointArray,this._dirtyScreenPoint),t?(this._camera.projectPoint(this._position,z),this._camera.renderToScreen(z,this._dirtyOriginScreenPointArray)):_.vec2.copy(this._dirtyOriginScreenPointArray,this._dirtyScreenPointArray)}},t.prototype.intersectionDistance=function(e,t){if(!this._get("visible"))return null;var r=l.screenPointObjectToArray(e,D),i=this._getCollisionRadius(t),n=-1*this._get("collisionPriority");switch(this.collisionType.type){case"point":if(_.vec2.squaredDistance(this._screenPointArray,r)<i*i)return this._renderScreenPointArray[2]+n;break;case"line":for(var o=this.collisionType.paths,a=this._getWorldToScreenObjectScale(),c=this._calculateObjectTransform(a,F),p=i*this._screenPixelSize,u=O.ray.fromScreen(this._camera,r,L),h=0,f=o;h<f.length;h++){if(0!==(x=f[h]).length)for(var g=b.vec3.transformMat4(V,x[0],c),y=1;y<x.length;y++){var m=b.vec3.transformMat4(W,x[y],c);if(null!=(z=O.lineSegment.closestRayDistance2(O.lineSegment.fromPoints(g,m,k),u))&&z<p*p){var v=b.vec3.add(R.sv3d.get(),g,m);b.vec3.scale(v,v,.5);var P=l.castRenderScreenPointArray(R.sv3d.get());return this._camera.projectPoint(v,P),P[2]+n}b.vec3.copy(g,m)}}break;case"disc":var S=this.collisionType.direction,j=(a=this._getWorldToScreenObjectScale(),c=this._calculateObjectTransform(a,F),p=i*this._screenPixelSize,u=O.ray.fromScreen(this._camera,r,L),d.mat3.fromMat4(C,c)),T=b.vec3.transformMat3(G,S,j),A=this._calculateModelTransformPosition(U);O.plane.fromPositionAndNormal(A,T,H);var w=B;if(O.plane.intersectRay(H,u,w)&&b.vec3.squaredDistance(w,A)<p*p)return this._renderScreenPointArray[2]+n;break;case"ribbon":var M=this.collisionType;o=M.paths,S=M.direction,a=this._getWorldToScreenObjectScale(),c=this._calculateObjectTransform(a,F),p=i*this._camera.computeScreenPixelSizeAt(this._position),u=O.ray.fromScreen(this._camera,r,L),j=d.mat3.fromMat4(C,c),T=b.vec3.transformMat3(G,S,j),A=this._calculateModelTransformPosition(U);O.plane.fromPositionAndNormal(A,T,H);w=B;if(!O.plane.intersectRay(H,u,w))break;for(var E=0,I=o;E<I.length;E++){var x;if(0!==(x=I[E]).length)for(g=b.vec3.transformMat4(V,x[0],c),y=1;y<x.length;y++){var z;m=b.vec3.transformMat4(W,x[y],c);if(null!=(z=O.lineSegment.distance2(O.lineSegment.fromPoints(g,m,k),w))&&z<p*p){v=b.vec3.add(R.sv3d.get(),g,m);b.vec3.scale(v,v,.5);P=l.castRenderScreenPointArray(R.sv3d.get());return this._camera.projectPoint(v,P),P[2]+n}b.vec3.copy(g,m)}}break;default:s.neverReached(this.collisionType)}return null},t.prototype.drag=function(e){if(this.moveOnDrag){var t=l.screenPointObjectToArray(e.screenPoint,D);c.isNone(this._dragOffset)&&this.grabbing&&!this.snapToPointer&&(this._dragOffset=_.vec2.subtract(y.vec2f32.create(),t,this._originScreenPointArray)),c.isSome(this._dragOffset)&&_.vec2.subtract(t,t,this._dragOffset),this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(t,this._intersector,"on-the-ground"===this.alignment?x:null);var r=this._intersector.results.min,i=B;r.getIntersectionPoint(i)?(this.position=i,this._hitResult.onSurface=!0,this._hitResult.surfaceType="TerrainRenderer"===r.intersector?"ground":"feature"):this._hitResult.onSurface=!1}},t.prototype.attach=function(e){if(void 0===e&&(e={manipulator3D:{}}),this.view._stage){var t=e.manipulator3D;if(this._engineLayerId=t.engineLayerId,c.isNone(this._engineLayerId)){var r=new w("manipulator-3d",{isPickable:!1});this.view._stage.add(0,r),this.view._stage.addToViewContent([r.id]),this._engineLayerId=r.id,t.engineLayerId=r.id}t.engineLayerReferences=(t.engineLayerReferences||0)+1,this._materialIdReferences=t.materialIdReferences,c.isNone(this._materialIdReferences)&&(this._materialIdReferences=new Map,t.materialIdReferences=this._materialIdReferences),this._camera=this.view.state.camera,this._attached=!0,this._updateEngineObject(),j.canProject(this._mapPoint.spatialReference,this.view.spatialReference)||(this.mapPoint=P.makeDehydratedPoint(0,0,0,this.view.spatialReference))}},t.prototype.detach=function(e){void 0===e&&(e={manipulator3D:{}});var t=e.manipulator3D;t.engineLayerReferences--;var r=0===t.engineLayerReferences;r&&(t.engineLayerId=null),this._removeResourcesFromStage(r),this._engineResources=null,this._engineLayerId=null,this._materialIdReferences=null,this._camera=null,this._attached=!1},t.prototype.onViewChange=function(){this._camera=this.view.state.camera,this._screenPositionDirty=!0,this._updateEngineObject()},t.prototype.onElevationChange=function(e){this.view.renderCoordsHelper.fromRenderCoords(this.position,J,e.spatialReference)&&v.containsPoint(e.extent,J)&&this._refreshMapPoint(!0)},t.prototype._refreshMapPoint=function(e){switch(void 0===e&&(e=!1),this.alignment){case"none":break;case"on-the-ground":var t=S.getElevationAtPoint(this.view.elevationProvider,this.mapPoint,"ground");if(!(t!==this._mapPoint.z||!e))return;this._mapPoint.z=t;break;default:s.neverReached(this.alignment)}this._screenPositionDirty=!0,this._hitResult.onSurface=!1,this.view.renderCoordsHelper.toRenderCoords(this._mapPoint,this._position),this._updateEngineObject()},t.prototype._updateEngineObject=function(){if(this._areAnyEngineObjectsVisible=!1,this._attached)if(!1!==this._get("visible")){var e=this._getWorldToScreenObjectScale(),t=F;if(!0===this._get("autoScaleRenderObjects")){var r=this._getFocusedSize(this._radius,this._focused)*e;this._calculateObjectTransform(r,t)}else this._calculateObjectTransform(e,t);for(var i=this._ensureEngineResources().objectsByState,n=(this._focused?2:1)|(this._get("selected")?8:4),o=this._get("hideOnGrab")&&this._get("grabbing"),s=0,a=i;s<a.length;s++){var c=a[s],l=c.stateMask,p=c.objects;if(o)for(var u=0,d=p;u<d.length;u++){(m=d[u]).hide()}else{var h=!(0!=(15&l))||(n&l)==(15&l),f=!(0!=(65520&l))||(this._get("state")&l)==(65520&l);if(h&&f)for(var g=0,_=p;g<_.length;g++){(m=_[g]).unhide(),m.objectTransformation=t,this._areAnyEngineObjectsVisible=!0}else for(var y=0,b=p;y<b.length;y++){var m;(m=b[y]).hide()}}}}else this._removeResourcesFromStage()},t.prototype._ensureEngineResources=function(){if(c.isNone(this._engineResources)){var e=this.view._stage.getContent(0,c.expect(this._engineLayerId)),t=[],r=new Set;this.renderObjects.forEach((function(e){var i=e.material;r.has(i)||(t.push(i),r.add(i))}));var i=new Map;this.renderObjects.forEach((function(e){var t=new M({idHint:"manipulator"});!function(e,t){var r=t.geometry,i=t.material,n=t.transform;Array.isArray(r)?r.forEach((function(t){return e.addGeometry(t,i,n)})):e.addGeometry(r,i,n)}(t,e);var r=e.stateMask||0,n=i.get(r)||[];n.push(t),i.set(r,n)}));var n=[];i.forEach((function(e,t){n.push({stateMask:t,objects:e})})),this._engineResources={objectsByState:n,layer:e,materials:t}}return this._addResourcesToStage(),this._engineResources},t.prototype._addResourcesToStage=function(){var e=this;if(!this._engineResourcesAddedToStage&&!c.isNone(this._engineResources)){var t=this._engineResources,r=t.objectsByState,i=t.layer;t.materials.forEach((function(t){var r=c.expect(e._materialIdReferences),i=r.get(t.id)||0;0===i&&e.view._stage.add(3,t),r.set(t.id,i+1)})),r.forEach((function(t){t.objects.forEach((function(t){i.addObject(t),e.view._stage.add(1,t)}))})),this._engineResourcesAddedToStage=!0}},t.prototype._removeResourcesFromStage=function(e){var t=this;if(void 0===e&&(e=!1),this._engineResourcesAddedToStage&&!c.isNone(this._engineResources)){var r=this._engineResources,i=r.objectsByState,n=r.layer,o=r.materials;i.forEach((function(e){e.objects.forEach((function(e){n.removeObject(e),t.view._stage.remove(1,e.id)}))})),o.forEach((function(e){var r=c.expect(t._materialIdReferences),i=r.get(e.id);1===i?(t.view._stage.remove(3,e.id),r.delete(e.id)):r.set(e.id,i-1)})),e&&this.view._stage.remove(0,n.id),this._engineResourcesAddedToStage=!1}},t.prototype._getCollisionRadius=function(e){return this._getFocusedSize(this._radius,!0)*("touch"===e?this._touchMultiplier:1)},t.prototype._getFocusedSize=function(e,t){return e*(t?this._focusMultiplier:1)},t.prototype._getWorldToScreenObjectScale=function(){return this._worldSized?1:this._screenPixelSize},t.prototype._calculateModelTransformPosition=function(e){var t=this._getWorldToScreenObjectScale(),r=this._calculateObjectTransform(t,N);return b.vec3.set(e,r[12],r[13],r[14])},t.prototype._calculateModelTransformOffset=function(e){var t=this._calculateModelTransformPosition(e);return b.vec3.subtract(e,t,this._position)},t.prototype._calculateObjectTransform=function(e,t){return f.mat4.set(t,e,0,0,0,0,e,0,0,0,0,e,0,0,0,0,1),f.mat4.multiply(t,t,this._modelTransform),t[12]+=this._position[0],t[13]+=this._position[1],t[14]+=this._position[2],t[15]=1,t},r([p.property({constructOnly:!0,nonNullable:!0})],t.prototype,"view",void 0),r([p.property({value:"none",nonNullable:!0})],t.prototype,"alignment",null),r([p.property()],t.prototype,"hideOnGrab",void 0),r([p.property()],t.prototype,"moveOnDrag",void 0),r([p.property()],t.prototype,"snapToPointer",void 0),r([p.property()],t.prototype,"collisionType",void 0),r([p.property({type:u.Integer})],t.prototype,"collisionPriority",void 0),r([p.property({constructOnly:!0})],t.prototype,"renderObjects",void 0),r([p.property()],t.prototype,"autoScaleRenderObjects",void 0),r([p.property({value:!0})],t.prototype,"visible",null),r([p.property()],t.prototype,"radius",null),r([p.property()],t.prototype,"worldSized",null),r([p.property()],t.prototype,"focusMultiplier",null),r([p.property()],t.prototype,"touchMultiplier",null),r([p.property()],t.prototype,"interactive",void 0),r([p.property()],t.prototype,"selectable",void 0),r([p.property()],t.prototype,"cursor",void 0),r([p.property({value:!1})],t.prototype,"grabbing",null),r([p.property()],t.prototype,"dragging",void 0),r([p.property({value:!1})],t.prototype,"hovering",null),r([p.property({value:!1})],t.prototype,"selected",null),r([p.property({value:0})],t.prototype,"state",null),r([p.property({dependsOn:["hovering","grabbing"]})],t.prototype,"focused",null),t=r([p.subclass("esri.views.interactive.Manipulator3D")],t)}(p.declared(o));function I(e){return 0!==e[12]||0!==e[13]||0!==e[14]}t.Manipulator3D=E;var x={include:new Set};x.include.add(A.TERRAIN_ID);var D=l.createScreenPointArray(),z=l.createRenderScreenPointArray3(),k=O.lineSegment.create(),L=O.ray.create(),C=h.mat3f64.create(),N=g.mat4f64.create(),F=g.mat4f64.create(),H=O.plane.create(),V=m.vec3f64.create(),W=m.vec3f64.create(),B=m.vec3f64.create(),G=m.vec3f64.create(),U=m.vec3f64.create(),q=m.vec3f64.create(),J=m.vec3f64.create()}));