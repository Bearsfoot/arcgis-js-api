// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/decorateHelper","../../core/tsSupport/declareExtendsHelper","../../core/tsSupport/assignHelper","../../core/Accessor","../../core/Evented","../../core/Logger","../../core/maybe","../../core/screenUtils","../../core/accessorSupport/decorators","../../core/libs/gl-matrix-2/vec2","../../core/libs/gl-matrix-2/vec3","../../core/libs/gl-matrix-2/vec3f64","../../geometry/support/webMercatorUtils","../../support/elevationInfoUtils","../../symbols/support/defaults","../../symbols/support/ElevationInfo","../../views/support/drapedUtils"],(function(e,t,r,o,i,n,l,a,s,c,p,h,u,y,g,d,b,m,f){Object.defineProperty(t,"__esModule",{value:!0});var v=a.getLogger("esri.views.interactive.GraphicManipulator"),S=function(e){function t(t){var r=e.call(this,t)||this;return r.layer=null,r.interactive=!0,r.selectable=!1,r.dragging=!1,r.cursor=null,r.events=new l({target:r}),r._circleCollisionCache=null,r._graphicSymbolChangedHandle=null,r._originalSymbol=null,r}return o(t,e),Object.defineProperty(t.prototype,"graphic",{set:function(e){"mesh"!==s.get(e.geometry,"type")?(this._circleCollisionCache=null,this._originalSymbol=e.symbol,this._set("graphic",e),this.attachSymbolChanged()):v.error("Mesh geometries are not supported")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"elevationInfo",{get:function(){var e="elevationInfo"in this.graphic.layer&&this.graphic.layer.elevationInfo,t=d.getGraphicEffectiveElevationMode(this.graphic),r=e?e.offset:0;return new m({mode:t,offset:r})},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"focusedSymbol",{set:function(e){e!==this._get("focusedSymbol")&&(this._set("focusedSymbol",e),this._updateGraphicSymbol(),this._circleCollisionCache=null)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"grabbing",{set:function(e){e!==this._get("grabbing")&&(this._set("grabbing",e),this._updateGraphicSymbol())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hovering",{set:function(e){e!==this._get("hovering")&&(this._set("hovering",e),this._updateGraphicSymbol())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"selected",{set:function(e){e!==this._get("selected")&&(this._set("selected",e),this._updateGraphicSymbol(),this.events.emit("select-changed",{action:e?"select":"deselect"}))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"_focused",{get:function(){return this._get("hovering")||this._get("grabbing")},enumerable:!0,configurable:!0}),t.prototype.destroy=function(){this.detachSymbolChanged(),this._resetGraphicSymbol(),this._set("view",null)},t.prototype.intersectionDistance=function(e){var t=this._get("graphic");if(!1===t.visible)return null;var r=this._get("focusedSymbol"),o=s.isSome(r)?r:t.symbol,i=t.geometry;if(s.isNone(i))return null;var n=this._get("view");return"2d"===n.type?this._intersectDistance2D(e,n,i,o):this._intersectDistance3D(e,n,t)},t.prototype.attach=function(){this.attachSymbolChanged(),s.isSome(this.layer)&&this.layer.add(this.graphic)},t.prototype.detach=function(){this.detachSymbolChanged(),this._resetGraphicSymbol(),s.isSome(this.layer)&&this.layer.remove(this.graphic)},t.prototype.attachSymbolChanged=function(){var e=this;this.detachSymbolChanged(),this._graphicSymbolChangedHandle=this.graphic.watch("symbol",(function(t){s.isSome(t)&&t!==e.focusedSymbol&&t!==e._originalSymbol&&(e._originalSymbol=t,e._focused&&s.isSome(e.focusedSymbol)&&(e.graphic.symbol=e.focusedSymbol))}),!0)},t.prototype.detachSymbolChanged=function(){s.isSome(this._graphicSymbolChangedHandle)&&(this._graphicSymbolChangedHandle.remove(),this._graphicSymbolChangedHandle=null)},t.prototype._updateGraphicSymbol=function(){this.graphic.symbol=this._focused&&s.isSome(this.focusedSymbol)?this.focusedSymbol:this._originalSymbol},t.prototype._resetGraphicSymbol=function(){this.graphic.symbol=this._originalSymbol},t.prototype._intersectDistance2D=function(e,t,r,o){if(o=o||b.getDefaultSymbol2D(r),s.isNone(o))return null;var i=this._circleCollisionCache;if("point"!==r.type||"simple-marker"!==o.type){var n=f.intersectsDrapedGeometry(e,r,t);return s.isSome(n)?1:null}if(s.isNone(i)||!i.originalPoint.equals(r)){var l=r,a=t.spatialReference;if(g.canProject(l,a)){n=g.project(l,a);i={originalPoint:l.clone(),mapPoint:n,radiusPx:c.pt2px(o.size)},this._circleCollisionCache=i}}if(s.isSome(i)){var p=c.screenPointObjectToArray(e,C),u=t.state.toScreen(P,i.mapPoint.x,i.mapPoint.y),y=i.radiusPx;return h.vec2.squaredDistance(p,u)<y*y?1:null}return null},t.prototype._intersectDistance3D=function(e,t,r){var o=t.toMap(e,{include:[r]});if(!o)return null;var i=_;return t.renderCoordsHelper.toRenderCoords(o,i)?u.vec3.distance(i,t.state.camera.eye):null},r([p.property({constructOnly:!0,nonNullable:!0})],t.prototype,"graphic",null),r([p.property({readOnly:!0,dependsOn:["graphic"]})],t.prototype,"elevationInfo",null),r([p.property({constructOnly:!0,nonNullable:!0})],t.prototype,"view",void 0),r([p.property({value:null})],t.prototype,"focusedSymbol",null),r([p.property({constructOnly:!0})],t.prototype,"layer",void 0),r([p.property()],t.prototype,"interactive",void 0),r([p.property()],t.prototype,"selectable",void 0),r([p.property({value:!1})],t.prototype,"grabbing",null),r([p.property()],t.prototype,"dragging",void 0),r([p.property()],t.prototype,"hovering",null),r([p.property({value:!1})],t.prototype,"selected",null),r([p.property()],t.prototype,"cursor",void 0),t=r([p.subclass("esri.views.interactive.GraphicManipulator")],t)}(p.declared(n));t.GraphicManipulator=S;var _=y.vec3f64.create(),C=c.createScreenPointArray(),P=c.createScreenPointArray()}));