// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","../../../core/tsSupport/assignHelper","../../../core/tsSupport/generatorHelper","../../../core/tsSupport/awaiterHelper","../../../geometry","../../../Graphic","../../../core/Collection","../../../core/Error","../../../core/has","../../../core/Loadable","../../../core/Logger","../../../core/maybe","../../../core/Promise","../../../core/promiseUtils","../../../core/workers","../../../core/accessorSupport/decorators","../../../core/accessorSupport/ensureType","../../../tasks/operations/zscale","../../../tasks/support/FeatureSet"],(function(e,t,r,i,o,n,s,a,u,l,p,c,d,y,h,f,g,m,v,_,b,S){Object.defineProperty(t,"__esModule",{value:!0});var F=0,T=y.getLogger("esri.layers.graphics.sources.MemorySource"),R=function(e){function t(t){var r=e.call(this,t)||this;return r._idToClientGraphic=null,r.type="memory",r}return r(t,e),t.prototype.load=function(e){var t=h.isSome(e)?e.signal:null;return this.addResolvingPromise(this._startWorker(t)),g.resolve(this)},Object.defineProperty(t.prototype,"workerGeometryType",{get:function(){var e=this.layer&&this.layer.geometryType;return e?this._geometryTypeRequiresClientGraphicMapping(e)?"polygon":e:null},enumerable:!0,configurable:!0}),t.prototype.applyEdits=function(e){var t=this;return this.load().then((function(){return t._applyEdits(e)}))},t.prototype.openPorts=function(){var e=this;return this.load().then((function(){return e._connection.openPorts()}))},t.prototype.queryFeatures=function(e,t){return void 0===t&&(t={}),s(this,void 0,void 0,(function(){var r,i,o,s,a,u,l,p;return n(this,(function(n){switch(n.label){case 0:return[4,this.load(t)];case 1:return n.sent(),[4,this._connection.invoke("queryFeatures",e?e.toJSON():null,t)];case 2:if(r=n.sent(),b.applyFeatureSetZUnitScaling(e,this.layer.spatialReference,r),i=S.fromJSON(r),!this._requiresClientGraphicMapping())return[2,i];for(o=this.layer.objectIdField,s=0,a=i.features;s<a.length;s++)u=a[s],l=u.attributes[o],(p=this._idToClientGraphic.get(l))&&(u.geometry=p.geometry);return i.geometryType=this.layer.geometryType,[2,i]}}))}))},t.prototype.queryFeaturesJSON=function(e,t){return void 0===t&&(t={}),s(this,void 0,void 0,(function(){var r;return n(this,(function(i){switch(i.label){case 0:return this._requiresClientGraphicMapping()?[2,g.reject(new p("query-features-json:unsupported","Cannot query in JSON format for client only geometry types (mesh and extent)"))]:[4,this.load(t)];case 1:return i.sent(),[4,this._connection.invoke("queryFeatures",e?e.toJSON():null,t)];case 2:return r=i.sent(),b.applyFeatureSetZUnitScaling(e,this.layer.spatialReference,r),[2,r]}}))}))},t.prototype.queryFeatureCount=function(e,t){var r=this;return void 0===t&&(t={}),this.load(t).then((function(){return r._connection.invoke("queryFeatureCount",e?e.toJSON():null,t)}))},t.prototype.queryObjectIds=function(e,t){var r=this;return void 0===t&&(t={}),this.load(t).then((function(){return r._connection.invoke("queryObjectIds",e?e.toJSON():null,t)}))},t.prototype.queryExtent=function(e,t){var r=this;return void 0===t&&(t={}),this.load(t).then((function(){return r._connection.invoke("queryExtent",e?e.toJSON():null,t)})).then((function(e){return{count:e.count,extent:a.Extent.fromJSON(e.extent)}}))},t.prototype._applyEdits=function(e){var t=this;if(!this._connection)throw new p("feature-layer-source:edit-failure","Memory source not loaded");var r=this.layer.objectIdField,i=null,o=[],n=[],s=function(e){return"objectId"in e&&null!=e.objectId?e.objectId:"attributes"in e&&null!=e.attributes[r]?e.attributes[r]:null};if(e.addFeatures&&(i=this._prepareAddFeatures(e.addFeatures)),e.deleteFeatures)for(var a=0,u=e.deleteFeatures;a<u.length;a++){null!=(y=s(h=u[a]))&&o.push(y)}var l=e.updateFeatures&&this._idToClientGraphic?new Map:null;if(e.updateFeatures)for(var c=0,d=e.updateFeatures;c<d.length;c++){var y,h=d[c];if(n.push(this._serializeFeature(h)),l)null!=(y=s(h))&&l.set(y,h)}return b.unapplyEditsZUnitScaling(i?i.features:null,n,this.layer.spatialReference),this._connection.invoke("applyEdits",{adds:i?i.features:[],updates:n,deletes:o}).then((function(e){var r=e.fullExtent,o=e.featureEditResults;if(t.fullExtent=r,i&&i.finish(o.uidToObjectId),t._idToClientGraphic){if(l)for(var n=0,s=o.updateResults;n<s.length;n++){var a=s[n];if(a.success){var u=l.get(a.objectId);null!=u&&t._addIdToClientGraphic(u)}}for(var p=0,c=o.deleteResults;p<c.length;p++){var d=c[p];d.success&&t._idToClientGraphic.delete(d.objectId)}}return t._createEditsResult(o)}))},t.prototype._createEditsResult=function(e){return{addFeatureResults:e.addResults?e.addResults.map(this._createFeatureEditResult,this):[],updateFeatureResults:e.updateResults?e.updateResults.map(this._createFeatureEditResult,this):[],deleteFeatureResults:e.deleteResults?e.deleteResults.map(this._createFeatureEditResult,this):[],addAttachmentResults:[],updateAttachmentResults:[],deleteAttachmentResults:[]}},t.prototype._createFeatureEditResult=function(e){var t=!0===e.success?null:e.error||{code:void 0,description:void 0};return{objectId:e.objectId,globalId:e.globalId,error:t?new p("feature-layer-source:edit-failure",t.description,{code:t.code}):null}},t.prototype._prepareAddFeatures=function(e){for(var t=new Map,r=new Array(e.length),i=null,o=0;o<e.length;o++){var n=e[o],s=this._serializeFeature(n);!i&&h.isSome(n.geometry)&&(i=n.geometry.type),r[o]=s,t.set(""+s.uid,n)}var a=this;return{features:r,inferredGeometryType:i,finish:function(e){var r=a.sourceJSON.objectIdField;for(var i in e){var o=e[i],n=t.get(i);n&&(n.attributes||(n.attributes={}),-1===o?delete n.attributes[r]:n.attributes[r]=o,a._addIdToClientGraphic(n))}}}},t.prototype._addIdToClientGraphic=function(e){if(this._idToClientGraphic){var t=this.sourceJSON.objectIdField,r=e.attributes&&e.attributes[t];null!=r&&this._idToClientGraphic.set(r,e)}},t.prototype._requiresClientGraphicMapping=function(){var e=this.layer.geometryType||this.sourceJSON.geometryType;return this._geometryTypeRequiresClientGraphicMapping(e)},t.prototype._geometryRequiresClientGraphicMapping=function(e){return this._geometryTypeRequiresClientGraphicMapping(e.type)},t.prototype._geometryTypeRequiresClientGraphicMapping=function(e){return"mesh"===e||"multipatch"===e||"extent"===e},t.prototype._serializeFeature=function(e){var t=e.attributes,r=this._geometryForSerialization(e),i=(F++).toString();return r?{uid:i,geometry:r.toJSON(),attributes:t}:{uid:i,attributes:t}},t.prototype._geometryForSerialization=function(e){var t=e.geometry;return h.isNone(t)?null:this._geometryRequiresClientGraphicMapping(t)?a.Polygon.fromExtent(t.extent):t},t.prototype._startWorker=function(e){return s(this,void 0,void 0,(function(){var t,r,i,o,s,u,l,p,d,y,h,f,g,v,_,b;return n(this,(function(n){switch(n.label){case 0:return t=this,[4,m.open("MemorySourceWorker",{strategy:c("esri-workers-for-memory-layers")?"dedicated":"local",signal:e})];case 1:return t._connection=n.sent(),r=this.layer,i=r.fields,o=r.spatialReference,s=r.objectIdField,u=r.hasM,l=r.hasZ,p=r.timeInfo,d="defaults"===this.layer.originOf("spatialReference"),y=this._prepareAddFeatures(this.items),this.on("before-changes",(function(e){T.error("Source modifications will not propagate after layer has been loaded. Please use .applyEdits() instead"),e.preventDefault()})),h={features:y.features,fields:i&&i.map((function(e){return e.toJSON()})),geometryType:a.typeKebabDictionary.toJSON(this.workerGeometryType),hasM:u,hasZ:l,objectIdField:s,spatialReference:d?null:o&&o.toJSON(),timeInfo:p?p.toJSON():null},[4,this._connection.invoke("load",h,{signal:e})];case 2:for(f=n.sent(),g=0,v=f.warnings;g<v.length;g++)_=v[g],T.warn(_.message,{layer:this.layer,warning:_});return f.featureErrors.length&&T.warn("Encountered "+f.featureErrors.length+" validation errors while loading features",f.featureErrors),b=f.layerDefinition,this._geometryTypeRequiresClientGraphicMapping(y.inferredGeometryType)&&(b.geometryType=a.typeKebabDictionary.toJSON(y.inferredGeometryType)),this.sourceJSON=b,this._requiresClientGraphicMapping()&&(this._idToClientGraphic=new Map),y.finish(f.assignedObjectIds),[2]}}))}))},i([v.shared({Type:u,ensureType:_.ensureType(u)})],t.prototype,"itemType",void 0),i([v.property()],t.prototype,"type",void 0),i([v.property({constructOnly:!0})],t.prototype,"layer",void 0),i([v.property({readOnly:!0,dependsOn:["layer.geometryType"]})],t.prototype,"workerGeometryType",null),i([v.property()],t.prototype,"sourceJSON",void 0),t=i([v.subclass("esri.layers.graphics.sources.MemorySource")],t)}(v.declared(d.LoadableMixin(f.EsriPromiseMixin(l))));t.MemorySource=R,t.default=R}));