// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/generatorHelper","../../../core/tsSupport/awaiterHelper","../../../core/jsonMap","../../../core/maybe","../../../core/promiseUtils","../../../core/unitUtils","../../../geometry/support/extentUtils","../../../geometry/support/jsonUtils","../../../geometry/support/normalizeUtils","../../../geometry/support/spatialReferenceUtils","../centroid","../featureConversionUtils","../OptimizedGeometry","./projectionSupport","./spatialQuerySupport"],(function(e,t,r,i,o,n,s,a,u,l,c,m,p,f,y,d,g){Object.defineProperty(t,"__esModule",{value:!0});var h=new o.default({esriSRUnit_Meter:"meters",esriSRUnit_Kilometer:"kilometers",esriSRUnit_Foot:"feet",esriSRUnit_StatuteMile:"miles",esriSRUnit_NauticalMile:"nautical-miles",esriSRUnit_USNauticalMile:"us-nautical-miles"});t.QUERY_ENGINE_EMPTY_RESULT=Object.freeze({});var v=new y.default,S=new y.default,R=new y.default,M={esriGeometryPoint:f.convertToPoint,esriGeometryPolyline:f.convertToPolyline,esriGeometryPolygon:f.convertToPolygon,esriGeometryMultipoint:f.convertToMultipoint};function G(e,t,r,i,o){void 0===i&&(i=e.hasZ),void 0===o&&(o=e.hasM);var n=e.hasZ&&i,s=e.hasM&&o;if(r){var a=f.quantizeOptimizedGeometry(R,t,e.hasZ,e.hasM,"esriGeometryPoint",r,i,o);return f.convertToPoint(a,n,s)}return f.convertToPoint(t,n,s)}function U(e,o,s){return i(this,void 0,void 0,(function(){var i,a,m,p,f,y;return r(this,(function(r){switch(r.label){case 0:return e?(i=e.where,e.where=i=i&&i.trim(),(!i||/^1 *= *1$/.test(i)||o&&o===i)&&(e.where=null),e.geometry?[4,T(e)]:[2,e]):[2,null];case 1:return a=r.sent(),e.distance=0,e.units=null,"esriSpatialRelEnvelopeIntersects"===e.spatialRel&&(m=e.geometry.spatialReference,(a=u.getGeometryExtent(a)).spatialReference=m),e.geometry=a,[4,d.checkProjectionSupport(a.spatialReference,s)];case 2:return r.sent(),[4,c.normalizeCentralMeridian(l.fromJSON(a))];case 3:if(p=r.sent()[0],n.isNone(p))throw t.QUERY_ENGINE_EMPTY_RESULT;return f=p.toJSON(),[4,d.project(f,f.spatialReference,s)];case 4:if(!(y=r.sent()))throw t.QUERY_ENGINE_EMPTY_RESULT;return y.spatialReference=s,e.geometry=y,[2,e]}}))}))}function T(e){return i(this,void 0,void 0,(function(){var t,i,o,n,u,l,c,p,f;return r(this,(function(r){switch(r.label){case 0:return t=e.geometry,i=e.distance,o=e.units,null==i?[2,s.resolve(t)]:(n=t.spatialReference,u=o&&h.fromJSON(o)||a.getUnitString(n),n&&(m.isGeographic(n)||m.isWebMercator(n))?(c=t,[3,3]):[3,1]);case 1:return[4,d.checkProjectionSupport(n,m.WGS84).then((function(){return d.project(t,m.WGS84)}))];case 2:c=r.sent(),r.label=3;case 3:return l=c,[4,g.getGeodesicBufferOperator()];case 4:return p=r.sent(),[2,(f=p(l,i,u))?f.toJSON():null]}}))}))}t.transformCentroid=G,t.getCentroid=function(e,t,r){return"esriGeometryPolygon"===e.geometryType&&t&&(t.centroid||t.geometry)?(t.centroid||(t.centroid=p.getCentroidOptimizedGeometry(new y.default,t.geometry,e.hasZ,e.hasM)),G(e,t.centroid,r)):null},t.getGeometry=function(e,t,r,i,o,n){void 0===o&&(o=e.hasZ),void 0===n&&(n=e.hasM);var s=e.hasZ&&o,a=e.hasM&&n,u=t?"coords"in t?t:t.geometry:null;if(!u)return null;if(r){var l=f.generalizeOptimizedGeometry(S,u,e.hasZ,e.hasM,e.geometryType,r,o,n);return i&&(l=f.quantizeOptimizedGeometry(R,l,s,a,e.geometryType,i)),M[e.geometryType](l,s,a)}if(i){l=f.quantizeOptimizedGeometry(R,u,e.hasZ,e.hasM,e.geometryType,i,o,n);return M[e.geometryType](l,s,a)}return f.removeZMValues(v,u,e.hasZ,e.hasM,o,n),M[e.geometryType](v,s,a)},t.normalizeQuery=function(e,t,o){return i(this,void 0,void 0,(function(){var i,n,s,a,u;return r(this,(function(r){if(i=e.outFields,n=e.orderByFields,s=e.groupByFieldsForStatistics,a=e.outStatistics,i)for(u=0;u<i.length;u++)i[u]=i[u].trim();if(n)for(u=0;u<n.length;u++)n[u]=n[u].trim();if(s)for(u=0;u<s.length;u++)s[u]=s[u].trim();if(a)for(u=0;u<a.length;u++)a[u].onStatisticField&&(a[u].onStatisticField=a[u].onStatisticField.trim());return e.geometry&&!e.outSR&&(e.outSR=e.geometry.spatialReference),[2,U(e,t,o)]}))}))},t.normalizeFilter=function(e,t,o){return i(this,void 0,void 0,(function(){return r(this,(function(r){return[2,U(e,t,o)]}))}))},t.normalizeQueryLike=U,t.cleanFromGeometryEngine=function(e){return e&&E in e?JSON.parse(JSON.stringify(e,_)):e};var E="_geVersion",_=function(e,t){return e!==E?t:void 0}}));