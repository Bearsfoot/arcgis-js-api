// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/decorateHelper","../../core/tsSupport/declareExtendsHelper","dojo/i18n!./nls/DatePicker","../../intl","../../moment","../../core/events","../../core/accessorSupport/decorators","../Widget","./DatePickerViewModel","./Popover","./widget"],(function(e,t,r,a,i,o,s,n,c,d,l,h,u){var _="esri-date-picker",p="esri-date-picker__calendar",y="esri-date-picker__month-picker",v="esri-date-picker__day-picker",f="esri-date-picker__week-item",k="esri-date-picker__day-item--nearby-month",D="esri-date-picker__day-item--active",m="esri-date-picker__day-item--today",w="esri-date-picker__day-item--selected",b="esri-date-picker__day-item",g="esri-date-picker__day-item--header",P="esri-date-picker__year-picker",x="esri-date-picker__year-picker-item--selected",O="esri-date-picker__year-picker-item",M="esri-date-picker__month-dropdown",N="esri-date-picker__date",B="esri-date-picker__calendar-toggle",S="esri-icon-down-arrow",A="esri-icon-up-arrow",C="esri-icon-left",Y="esri-icon-right",T="esri-widget",F="esri-widget--button",H="esri-select",U={year:"numeric",month:"2-digit",day:"2-digit"},I=[" ","ArrowDown","ArrowLeft","ArrowRight","ArrowUp","End","Enter","Home","PageDown","PageUp"],E="onfocusout"in HTMLElement.prototype;return function(e){function t(t){var r=e.call(this,t)||this;return r._activeDate=null,r._calendarNode=null,r._calendarPopover=new h({owner:r,placement:"bottom-start",anchorElement:function(){return r._rootNode},renderContentFunction:r._renderCalendar}),r._closedByUserAction=!1,r._isOpen=!1,r._rootNode=null,r.value=null,r.commitOnMonthChange=!1,r.viewModel=new l,r._handleDatePickerBlur=E?null:r._handleDatePickerBlurOrFocusOut,r._handleDatePickerFocusOut=E?r._handleDatePickerBlurOrFocusOut:null,r}return a(t,e),t.prototype.destroy=function(){this._calendarPopover.destroy()},t.prototype.render=function(){var e,t=o.formatDate(this.viewModel.value.valueOf(),U),r=this._isOpen,a=((e={})[S]=!r,e[A]=r,e);return u.tsx("div",{afterCreate:u.storeNode,bind:this,class:this.classes(_,T),"data-node-ref":"_rootNode"},u.tsx("div",{afterUpdate:this._focusSelectedOrClosed,"aria-pressed":r.toString(),bind:this,class:this.classes(F,B),onclick:this._toggle,onkeydown:this._toggle,role:"button",tabIndex:0},u.tsx("span",{class:N},t),u.tsx("span",{"aria-hidden":"true",class:this.classes(a)})))},t.prototype._focusSelectedOrClosed=function(e){this._closedByUserAction&&(this._closedByUserAction=!1,e.focus())},t.prototype._handleDatePickerKeydown=function(e){"Escape"===n.eventKey(e)&&(this._closedByUserAction=!0,this._close(),e.preventDefault(),e.stopPropagation())},t.prototype._renderCalendar=function(){var e=this._activeDate,t=this.get("viewModel.value");return u.tsx("div",{afterCreate:u.storeNode,bind:this,class:this.classes(p,T),"data-node-ref":"_calendarNode",key:"esri-date-picker__calendar",onkeydown:this._handleDatePickerKeydown},this._renderMonthPicker(e),this._renderDayPicker(e,t),this._renderYearPicker(e))},t.prototype._handleDatePickerBlurOrFocusOut=function(e){if(!(e.currentTarget!==e.target)){var t=e.relatedTarget;this._calendarNode.contains(t)||this._rootNode.contains(t)||this._close()}},t.prototype._renderMonthPicker=function(e){var t=u.isRTL(),r=t?Y:C,a=t?C:Y,o=s.months().map((function(t,r){var a=e.month()===r;return u.tsx("option",{selected:a},t)}));return u.tsx("div",{class:y},u.tsx("div",{"aria-label":i.goToPreviousMonth,bind:this,class:F,onblur:this._handleDatePickerBlur,onclick:this._setPreviousMonth,onfocusout:this._handleDatePickerFocusOut,onkeydown:this._setPreviousMonth,role:"button",tabIndex:0,title:i.goToPreviousMonth},u.tsx("span",{"aria-hidden":"true",class:r})),u.tsx("select",{"aria-live":"assertive",bind:this,class:this.classes(M,H),id:this.id+"__month-picker",onblur:this._handleDatePickerBlur,onchange:this._setMonth,onfocusout:this._handleDatePickerFocusOut,onkeydown:this._setMonth},o),u.tsx("div",{"aria-label":i.goToNextMonth,bind:this,class:F,onblur:this._handleDatePickerBlur,onclick:this._setNextMonth,onfocusout:this._handleDatePickerFocusOut,onkeydown:this._setNextMonth,role:"button",tabIndex:0,title:i.goToNextMonth},u.tsx("span",{"aria-hidden":"true",class:a})))},t.prototype._renderDayPicker=function(e,t){var r=this,a=e.clone().day(s.localeData().firstDayOfWeek()),i=this._getWeekLabels(a),o=this._getDayId(e),n=this._renderMonth(e,t);return u.tsx("div",{afterCreate:this._handleDayPickerCreate,"aria-activedescendant":o,"aria-labelledby":this.id+"__month-picker "+this.id+"__selected-year",bind:this,class:v,id:this.id+"__day-picker",onblur:this._handleDatePickerBlur,onfocusout:this._handleDatePickerFocusOut,onkeydown:this._handleDayPickerKeydown,role:"grid",tabIndex:0},u.tsx("div",{class:f,role:"row"},i.map((function(e){return u.tsx("div",{"aria-label":e.name,class:r.classes(b,g),role:"columnheader",title:e.name},e.abbr)}))),n)},t.prototype._getDayId=function(e){return this.id+"__"+o.formatDate(e.valueOf(),U)},t.prototype._handleDayPickerCreate=function(e){e.focus()},t.prototype._getWeekLabels=function(e){for(var t=[],r={weekday:"long"},a={weekday:"narrow"},i=0;i<7;i++)t.push({name:o.formatDate(e.valueOf(),r),abbr:o.formatDate(e.valueOf(),a)}),e.add(1,"day");return t},t.prototype._handleDayPickerKeydown=function(e){var t=e.ctrlKey,r=e.shiftKey,a=n.eventKey(e),i=this._activeDate;if(-1!==I.indexOf(a)){if("ArrowLeft"===a)i.subtract(1,"day");else if("ArrowRight"===a)i.add(1,"day");else if("ArrowUp"===a)i.subtract(1,"week");else if("ArrowDown"===a)i.add(1,"week");else if("PageUp"===a){var o=r?"year":"month";i.subtract(1,o)}else if("PageDown"===a){o=r?"year":"month";i.add(1,o)}else if("Home"===a){o=t?"year":"month";i.startOf(o)}else if("End"===a){o=t?"year":"month";i.endOf(o)}else"Enter"!==a&&" "!==a||(this.viewModel.value=i.clone(),this._closedByUserAction=!0,this._close());e.preventDefault(),e.stopPropagation()}},t.prototype._renderMonth=function(e,t){for(var r,a=s(),i=e.clone().startOf("month"),o=e.clone().endOf("month"),n=i.clone().subtract(i.weekday(),"day"),c=[],d=0;d<6;d++){for(var l=[],h=0;h<7;h++){var _=n.date(),p=n.isSame(e,"day"),y=n.isSame(t,"day"),v=this._getDayId(n),g=((r={})[k]=!n.isBetween(i,o,null,"[]"),r[m]=n.isSame(a,"day"),r[D]=p,r[w]=y,r);l.push(u.tsx("div",{"aria-label":_.toString(),"aria-selected":p.toString(),bind:this,class:this.classes(b,g),"data-iso-date":n.toISOString(),id:v,onclick:this._handleSelectedDate,onkeydown:this._handleSelectedDate,role:"gridcell"},_)),n.add(1,"day")}c.push(u.tsx("div",{class:f,role:"row"},l))}return c},t.prototype._renderYearPicker=function(e){var t={year:"numeric"},r=e.clone(),a=o.formatDate(r.valueOf(),t),s=o.formatDate(r.add(1,"year").valueOf(),t),n=o.formatDate(r.subtract(2,"year").valueOf(),t);return u.tsx("div",{class:P},u.tsx("div",{"aria-label":i.goToPreviousYear,bind:this,class:O,onblur:this._handleDatePickerBlur,onclick:this._setPreviousYear,onfocusout:this._handleDatePickerFocusOut,onkeydown:this._setPreviousYear,tabIndex:0,title:i.goToPreviousYear},n),u.tsx("div",{class:this.classes(O,x),id:this.id+"__selected-year"},a),u.tsx("div",{"aria-label":i.goToNextYear,bind:this,class:O,onblur:this._handleDatePickerBlur,onclick:this._setNextYear,onfocusout:this._handleDatePickerFocusOut,onkeydown:this._setNextYear,tabIndex:0,title:i.goToNextYear},s))},t.prototype._toggle=function(){this._isOpen?this._close():this._open(this.viewModel.value.clone())},t.prototype._setMonth=function(e){var t=e.target.value;this._activeDate.month(t),this.commitOnMonthChange&&(this.viewModel.value=this._activeDate)},t.prototype._close=function(){this._activeDate=null,this._isOpen=!1,this._calendarPopover.open=!1},t.prototype._open=function(e){this._activeDate=e,this._isOpen=!0,this._calendarPopover.open=!0},t.prototype._setPreviousMonth=function(){this._activeDate.subtract(1,"month"),this.commitOnMonthChange&&(this.viewModel.value=this._activeDate)},t.prototype._setNextMonth=function(){this._activeDate.add(1,"month"),this.commitOnMonthChange&&(this.viewModel.value=this._activeDate)},t.prototype._setPreviousYear=function(){this._activeDate.subtract(1,"year")},t.prototype._setNextYear=function(){this._activeDate.add(1,"year")},t.prototype._handleSelectedDate=function(e){var t=e.target;this.viewModel.value=s(t.getAttribute("data-iso-date")),this._closedByUserAction=!0,this._close()},r([c.aliasOf("viewModel.value")],t.prototype,"value",void 0),r([c.property({type:l}),u.renderable("viewModel.value")],t.prototype,"viewModel",void 0),r([u.accessibleHandler()],t.prototype,"_toggle",null),r([u.accessibleHandler()],t.prototype,"_setPreviousMonth",null),r([u.accessibleHandler()],t.prototype,"_setNextMonth",null),r([u.accessibleHandler()],t.prototype,"_setPreviousYear",null),r([u.accessibleHandler()],t.prototype,"_setNextYear",null),r([u.accessibleHandler()],t.prototype,"_handleSelectedDate",null),t=r([c.subclass("esri.widgets.support.DatePicker")],t)}(c.declared(d))}));