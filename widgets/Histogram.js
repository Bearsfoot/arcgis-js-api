// COPYRIGHT © 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/assignHelper","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","dojo/i18n!./Histogram/nls/Histogram","../intl","../core/maybe","../core/accessorSupport/decorators","./Widget","./Histogram/HistogramViewModel","./support/widget"],(function(e,t,r,i,a,n,s,o,l,d,u,p){var h="esri-histogram",c="esri-histogram--horizontal",g="esri-histogram--vertical",v="esri-histogram__content",m="esri-histogram__svg",b="esri-histogram__bar",f="esri-histogram__bars",y="esri-histogram__label",_="esri-histogram__data-lines",x="esri-histogram__data-lines-subgroup",L="esri-histogram__data-line",w="esri-histogram__average-label",C="esri-histogram__average-data-line",M="esri-histogram__average-symbol",F="esri-widget",B="esri-disabled";return function(e){function t(t){var r=e.call(this,t)||this;return r._containerNode=null,r._defaultBarColor="#d8d8d8",r.average=null,r.barCreatedFunction=null,r.bins=null,r.dataLines=null,r.dataLineCreatedFunction=null,r.label=n.widgetLabel,r.labelFormatFunction=null,r.max=null,r.min=null,r.state=null,r.viewModel=new u,r}var r;return i(t,e),r=t,Object.defineProperty(t.prototype,"layout",{set:function(e){"vertical"!==e&&(e="horizontal"),this._set("layout",e)},enumerable:!0,configurable:!0}),t.fromHistogramResult=function(e){var t=e.bins,i=e.maxValue,a=e.minValue;return new r({bins:t,max:i,min:a})},t.prototype.render=function(){var e=this.label,t=this.layout,r=this.state,i=this.classes(h,F,"horizontal"===t?c:g,"disabled"===r?B:null);return p.tsx("div",{"aria-label":e,afterCreate:p.storeNode,bind:this,class:i,"data-node-ref":"_containerNode"},"ready"===r?this.renderContent():null)},t.prototype.renderContent=function(){if(this._containerNode)return p.tsx("div",{class:v},p.tsx("svg",{class:m,xmlns:"http://www.w3.org/2000/svg"},this.renderBarsGroup(),this.renderLinesGroup()))},t.prototype.renderBarsGroup=function(){return p.tsx("g",{class:this.classes(f)},this.renderBars())},t.prototype.renderBars=function(){var e=this,t=this.layout,r=this.viewModel,i=r.binRange,a=r.range;if(i&&a){var n=i/a,s=this._getContainerDimensions(),o=s[0],l=s[1];if(0!==o||0!==l){if(0!==o||0===l){var d="vertical"===t?[o*n,l]:[o,l*n],u=d[0],p=d[1];return this._getBarDimensions(u,p).map((function(t,r){var i=t[0],a=t[1];return e.renderBar(r,i,a)}))}this.scheduleRender()}}},t.prototype.renderBar=function(e,t,r){var i=this.bins,a=this.layout,o=this.max,l=this.viewModel.range,d=this._getContainerDimensions(),u=d[0],h=d[1],c=i.slice()[e],g=c.count,v=c.maxValue,m=c.minValue,f=o-v,y="vertical"===a?[0,f*(u/l)]:[h-r-f*(h/l),u-t],_=y[0],x=y[1],L=s.substitute(n.barLabel,{count:g,maxValue:v,minValue:m});return p.tsx("rect",{"aria-label":L,afterCreate:this._afterBarCreate,bind:this,class:b,"data-index":e,fill:this._defaultBarColor,height:t,role:"img","shape-rendering":"crispEdges","stroke-width":"0",width:r,x:_,y:x})},t.prototype.renderLinesGroup=function(){return p.tsx("g",{class:this.classes(_)},this.renderAverageLine(),this.renderCustomLines())},t.prototype.renderAverageLine=function(){var e=this.average;if(o.isSome(e)){var t=[p.tsx("tspan",{class:this.classes(M)},"x̄ "),p.tsx("tspan",{class:this.classes(w)},this.labelFormatFunction?this.labelFormatFunction(e,"average"):e)];return p.tsx("g",{afterCreate:this._afterLinesSubgroupCreate,bind:this,class:this.classes(x)},this.renderLine(e,this.classes(C)),this.renderLabel(e,t))}},t.prototype.renderCustomLines=function(){var e=this;if(this.dataLines&&this.dataLines.length)return this.dataLines.map((function(t,r){var i=t.value,a=t.label;return e.renderLineSubgroup(r,i,a)}))},t.prototype.renderLineSubgroup=function(e,t,r){return p.tsx("g",{afterCreate:this._afterLinesSubgroupCreate,bind:this,class:this.classes(x),"data-index":e},this.renderLine(t),this.renderLabel(t,r))},t.prototype.renderLine=function(e,t){var r=this._getLinePosition(e),i=r[0],a=r[1],n=r[2],s=r[3];return p.tsx("line",{class:this.classes(L,t),x1:i,x2:a,y1:n,y2:s,"shape-rendering":"crispEdges"})},t.prototype.renderLabel=function(e,t,r){var i=this._getLabelPosition(e),a=i[0],n=i[1];return p.tsx("text",{class:this.classes(y,r),"text-anchor":"end",transform:"horizontal"===this.layout?"rotate(270)":null,x:a,y:n-2},t)},t.prototype._afterBarCreate=function(e){if(this.barCreatedFunction){var t=e.dataset?parseInt(e.dataset.index,10):e.getAttribute("data-index")?parseInt(e.getAttribute("data-index"),10):null;this.barCreatedFunction(isNaN(t)?null:t,e)}},t.prototype._afterLinesSubgroupCreate=function(e){if(this.dataLineCreatedFunction){var t=e.dataset?parseInt(e.dataset.index,10):e.getAttribute("data-index")?parseInt(e.getAttribute("data-index"),10):null,r=e.childNodes[0],i=e.childNodes[1]?e.childNodes[1]:null;this.dataLineCreatedFunction(r,i,isNaN(t)?null:t)}},t.prototype._getContainerDimensions=function(){var e=this._containerNode;return e?[e.offsetHeight,e.offsetWidth]:[0,0]},t.prototype._getBarDimensions=function(e,t){var r=this.bins,i=this.layout,a=r?r.map((function(e){return e.count})):[],n=Math.max.apply(Math,a);return a.map((function(r){return"vertical"===i?[e/a.length,0!==n?r/n*t:0]:[0!==n?r/n*e:0,t/a.length]}))},t.prototype._getLinePosition=function(e){var t=this.layout,r=(e-this.min)/this.viewModel.range,i=this._getContainerDimensions(),a=i[0],n=[r*i[1],a-r*a],s=n[0],o=n[1];return"vertical"===t?[0,"100%",o,o]:[s,s,"100%",0]},t.prototype._getLabelPosition=function(e){var t=this.layout,r=(e-this.min)/this.viewModel.range,i=this._getContainerDimensions(),a=i[0],n=i[1];return"vertical"===t?[n,a-r*a]:[0,r*n]},a([l.aliasOf("viewModel.average")],t.prototype,"average",void 0),a([l.property(),p.renderable()],t.prototype,"barCreatedFunction",void 0),a([l.aliasOf("viewModel.bins")],t.prototype,"bins",void 0),a([l.property(),p.renderable()],t.prototype,"dataLines",void 0),a([l.property(),p.renderable()],t.prototype,"dataLineCreatedFunction",void 0),a([l.property()],t.prototype,"label",void 0),a([l.aliasOf("viewModel.labelFormatFunction")],t.prototype,"labelFormatFunction",void 0),a([l.property({value:"horizontal"})],t.prototype,"layout",null),a([l.aliasOf("viewModel.max")],t.prototype,"max",void 0),a([l.aliasOf("viewModel.min")],t.prototype,"min",void 0),a([l.aliasOf("viewModel.state")],t.prototype,"state",void 0),a([l.property(),p.renderable(["viewModel.average","viewModel.bins","viewModel.labelFormatFunction","viewModel.max","viewModel.min","viewModel.state"])],t.prototype,"viewModel",void 0),t=r=a([l.subclass("esri.widgets.Histogram")],t)}(l.declared(d))}));