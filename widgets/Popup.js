// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","../core/tsSupport/assignHelper","../core/tsSupport/generatorHelper","../core/tsSupport/awaiterHelper","dojo/i18n!../nls/common","dojo/i18n!./Popup/nls/Popup","../intl","../core/Collection","../core/deprecate","../core/events","../core/Handles","../core/Logger","../core/promiseUtils","../core/throttle","../core/watchUtils","../core/accessorSupport/decorators","./Spinner","./Widget","./Popup/PopupViewModel","./support/widget","./support/widgetUtils"],(function(e,t,o,i,n,r,s,a,l,p,u,d,c,h,f,g,_,v,b,y,w,m,M,k){var x="esri-icon-left-triangle-arrow",F="esri-icon-right-triangle-arrow",A="esri-icon-maximize",C="esri-icon-dock-bottom",O="esri-icon-dock-left",E="esri-icon-dock-right",N="esri-icon-close",P="esri-icon-minimize",I="esri-icon-check-mark",S="esri-icon-loading-indicator",W="esri-icon-default-action",D="esri-icon-handle-horizontal",T="esri-rotating",B="esri-popup",L="esri-widget",H="esri-popup__main-container",U="esri-popup__loading-container",V="esri-popup--is-collapsible",R="esri-popup--is-collapsed",K="esri-popup--shadow",z="esri-popup--is-docked",j="esri-popup--is-docked-top-left",q="esri-popup--is-docked-top-center",G="esri-popup--is-docked-top-right",J="esri-popup--is-docked-bottom-left",Q="esri-popup--is-docked-bottom-center",X="esri-popup--is-docked-bottom-right",Y="esri-popup--aligned-top-center",Z="esri-popup--aligned-bottom-center",$="esri-popup--aligned-top-left",ee="esri-popup--aligned-bottom-left",te="esri-popup--aligned-top-right",oe="esri-popup--aligned-bottom-right",ie="esri-popup--feature-menu-open",ne="esri-popup--actions-menu-open",re="esri-popup--feature-updated",se="esri-popup__header",ae="esri-popup__header-buttons",le="esri-popup__header-container",pe="esri-popup__header-container--button",ue="esri-popup__header-title",de="esri-popup__content",ce="esri-popup__footer",he="esri-popup__footer--has-pagination",fe="esri-popup__footer--has-actions",ge="esri-popup__footer--has-actions-menu",_e="esri-popup__button",ve="esri-popup__button--disabled",be="esri-popup__button--dock",ye="esri-popup__icon",we="esri-popup__icon--dock-icon",me="esri-popup__inline-actions-container",Me="esri-popup__actions-menu-button",ke="esri-popup__actions",xe="esri-popup__action",Fe="esri-popup__action-image",Ae="esri-popup__action-text",Ce="esri-popup__action-toggle",Oe="esri-popup__action-toggle--on",Ee="esri-popup__pointer",Ne="esri-popup__pointer-direction",Pe="esri-popup__navigation",Ie="esri-popup__pagination-previous",Se="esri-popup__pagination-next",We="esri-popup__pagination-previous-icon",De="esri-popup__pagination-previous-icon--rtl",Te="esri-popup__pagination-next-icon",Be="esri-popup__pagination-next-icon--rtl",Le="esri-popup__feature-menu",He="esri-popup__feature-menu-list",Ue="esri-popup__feature-menu-item",Ve="esri-popup__feature-menu-viewport",Re="esri-popup__feature-menu-header",Ke="esri-popup__feature-menu-item--selected",ze="esri-popup__feature-menu-button",je="esri-popup__feature-menu-title",qe={buttonEnabled:!0,position:"auto",breakpoint:{width:544}};function Ge(e,t){return void 0===t?"esri-popup__"+e:"esri-popup__"+e+"-"+t}function Je(){return s(this,void 0,void 0,(function(){return r(this,(function(t){return[2,g.create((function(t){e(["./Feature"],(function(e){t(e)}))}))]}))}))}var Qe=f.getLogger("esri.widgets.Popup"),Xe={closeButton:!0,featureNavigation:!0};return function(e){function t(t){var o=e.call(this,t)||this;return o._blurContainer=!1,o._containerNode=null,o._mainContainerNode=null,o._featureMenuNode=null,o._actionsMenuNode=null,o._focusContainer=!1,o._focusDockButton=!1,o._focusFeatureMenuButton=!1,o._focusActionsMenuButton=!1,o._focusFirstFeature=!1,o._focusFirstAction=!1,o._handles=new h,o._pointerOffsetInPx=16,o._spinner=null,o._displaySpinnerThrottled=_.throttle(o._displaySpinner,0),o.actions=null,o.alignment="auto",o.autoCloseEnabled=null,o.autoOpenEnabled=null,o.defaultPopupTemplateEnabled=null,o.content=null,o.collapsed=!1,o.collapseEnabled=!0,o.dockEnabled=!1,o.featureCount=null,o.featureMenuOpen=!1,o.features=null,o.goToOverride=null,o.highlightEnabled=null,o.location=null,o.featureWidgets=[],o.label=l.widgetLabel,o.maxInlineActions=3,o.promises=null,o.selectedFeature=null,o.selectedFeatureIndex=null,o.selectedFeatureWidget=null,o.spinnerEnabled=!0,o.title=null,o.updateLocationEnabled=null,o.view=null,o.viewModel=new m,o.visible=null,o.visibleElements=n({},Xe),o._addSelectedFeatureIndexHandle(),o.own([v.watch(o,"viewModel.screenLocation",(function(){return o._positionContainer()})),v.watch(o,["viewModel.visible","dockEnabled"],(function(){return o._toggleScreenLocationEnabled()})),v.watch(o,"viewModel.screenLocation",(function(e,t){!!e!=!!t&&o.reposition()})),v.watch(o,"viewModel.features",(function(){return o._updateFeatureWidgets()})),v.watch(o,["viewModel.view.padding","viewModel.view.size","viewModel.visible","viewModel.waitingForResult","viewModel.location","alignment"],(function(){return o.reposition()})),v.watch(o,"spinnerEnabled",(function(e){return o._spinnerEnabledChange(e)})),v.watch(o,"viewModel.view.size",(function(e,t){return o._updateDockEnabledForViewSize(e,t)})),v.watch(o,"viewModel.view",(function(e,t){return o._viewChange(e,t)})),v.watch(o,"viewModel.view.ready",(function(e,t){return o._viewReadyChange(e,t)})),v.watch(o,["viewModel.waitingForResult","viewModel.location"],(function(){return o._displaySpinnerThrottled()})),v.watch(o,["featureWidgets","viewModel.selectedFeatureIndex"],(function(){return o._updateFeatureWidget()})),v.watch(o,"selectedFeatureWidget.viewModel.title",(function(e){return o._setTitleFromFeatureWidget(e)})),v.watch(o,["selectedFeatureWidget.viewModel.content","selectedFeatureWidget.viewModel.waitingForContent"],(function(){return o._setContentFromFeatureWidget()})),v.whenFalse(o,"collapsed",(function(){"xsmall"===o.get("viewModel.view.widthBreakpoint")&&o.visible&&o.collapseEnabled&&o.viewModel.centerAtLocation()})),v.on(o,"viewModel.allActions","change",(function(){return o._watchActions()})),v.init(o,"viewModel.allActions",(function(){return o._watchActions()}))]),o}return o(t,e),t.prototype.destroy=function(){this._destroyFeatureWidgets(),this._destroySpinner(),this._handles&&this._handles.destroy(),this._handles=null},Object.defineProperty(t.prototype,"actionsMenuOpen",{get:function(){return!!this.viewModel.visible&&this._get("actionsMenuOpen")},set:function(e){this._set("actionsMenuOpen",!!e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"currentAlignment",{get:function(){return this._getCurrentAlignment()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"currentDockPosition",{get:function(){return this._getCurrentDockPosition()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"dockOptions",{get:function(){return this._get("dockOptions")||qe},set:function(e){var t=n({},qe),o=this.get("viewModel.view.breakpoints"),i={};o&&(i.width=o.xsmall,i.height=o.xsmall);var r=n({},t,e),s=n({},t.breakpoint,i),a=r.breakpoint;!0===a?r.breakpoint=s:"object"==typeof a&&(r.breakpoint=n({},s,a)),this._set("dockOptions",r),this._setCurrentDockPosition(),this.reposition()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"featureNavigationEnabled",{set:function(e){d.deprecatedProperty(Qe,"featureNavigationEnabled",{replacement:"visibleElements.featureNavigation",version:"4.15"}),this.visibleElements=n({},this.visibleElements,{featureNavigation:e})},enumerable:!0,configurable:!0}),t.prototype.castVisibleElements=function(e){return n({},Xe,e)},t.prototype.blur=function(){this.visible||Qe.warn("Popup cannot be blurred while visible is false"),this._blurContainer=!0,this.scheduleRender()},t.prototype.clear=function(){this.viewModel.clear()},t.prototype.close=function(){this.visible=!1},t.prototype.fetchFeatures=function(e,t){return this.viewModel.fetchFeatures(e,t)},t.prototype.focus=function(){this.visible||Qe.warn("Popup cannot be focused while visible is false"),this._focusContainer=!0,this.scheduleRender()},t.prototype.next=function(){return this.viewModel.next()},t.prototype.open=function(e){this._handles.remove("selected-index");var t=!!e&&!!e.featureMenuOpen,o=!!e&&!!e.actionsMenuOpen,i={collapsed:!!e&&!!e.collapsed,actionsMenuOpen:o,featureMenuOpen:t};"xsmall"===this.get("viewModel.view.widthBreakpoint")&&(i.collapsed=!0),this.set(i),this.viewModel.open(e),this._addSelectedFeatureIndexHandle()},t.prototype.previous=function(){return this.viewModel.previous()},t.prototype.reposition=function(){this.renderNow(),this._positionContainer(),this._setCurrentAlignment()},t.prototype.triggerAction=function(e){this.viewModel.triggerAction(e)},t.prototype.render=function(){var e,t,o,i,n,r,s,u=this,d=this,c=d.actionsMenuOpen,h=d.collapsed,f=d.collapseEnabled,g=d.dockEnabled,_=d.featureMenuOpen,v=d.featureWidgets,b=d.visible,y=d.visibleElements,w=y.featureNavigation,m=this.viewModel,I=m.content,W=m.featureCount,ve=m.pendingPromisesCount,xe=m.selectedFeatureIndex,Fe=m.title,Ae=b&&W>1&&w,Ce=this._getInlineActionCount(Ae),Oe=this._divideActions(Ce),He=Oe.inlineActions,Ue=Oe.menuActions,Ke=Ae&&_,je=Ue.length>1&&c,qe=Ae&&this._getPageText(W,xe),Je=this._renderContent(),Qe=k.isRTL(),Xe=!!(this.get("selectedFeatureWidget")?this.get("selectedFeatureWidget.viewModel.waitingForContent")||this.get("selectedFeatureWidget.viewModel.content"):Je),Ye=!!(f&&Fe&&Xe),Ze=Ye&&!Ke&&h,$e=this.get("viewModel.view.widthBreakpoint"),et=g?l.undock:l.dock,tt=this.currentAlignment,ot=this.currentDockPosition,it=ve?M.tsx("div",{key:Ge("loading-container"),role:"presentation",class:U,"aria-label":a.loading,title:a.loading},M.tsx("span",{"aria-hidden":"true",class:this.classes(ye,S,T)})):null,nt=((e={})[F]=Qe,e[De]=Qe,e[x]=!Qe,e[We]=!Qe,e),rt=M.tsx("span",{"aria-hidden":"true",class:this.classes(ye,nt)}),st=M.tsx("div",{role:"button",tabIndex:0,bind:this,onclick:this._previous,onkeydown:this._previous,class:this.classes(_e,Ie),"aria-label":l.previous,title:l.previous},rt),at=((t={})[x]=Qe,t[Be]=Qe,t[F]=!Qe,t[Te]=!Qe,t),lt=M.tsx("span",{"aria-hidden":"true",class:this.classes(ye,at)}),pt=M.tsx("div",{role:"button",tabIndex:0,bind:this,onclick:this._next,onkeydown:this._next,class:this.classes(_e,Se),"aria-label":l.next,title:l.next},lt),ut=k.cssTransition("enter",re),dt=this.id+"-feature-menu",ct=M.tsx("div",{role:"button",tabIndex:0,bind:this,onclick:this._toggleFeatureMenu,onkeydown:this._toggleFeatureMenu,afterCreate:this._focusFeatureMenuButtonNode,afterUpdate:this._focusFeatureMenuButtonNode,class:this.classes(_e,ze),"aria-haspopup":"true","aria-controls":dt,"aria-expanded":_,"aria-label":a.menu,title:a.menu},qe),ht=Ae?[st,it||ct,pt]:null,ft=this._wouldDockTo(),gt=((o={})[P]=g,o[we]=!g,o[E]=!g&&("top-right"===ft||"bottom-right"===ft),o[O]=!g&&("top-left"===ft||"bottom-left"===ft),o[A]=!g&&"top-center"===ft,o[C]=!g&&"bottom-center"===ft,o),_t=M.tsx("span",{"aria-hidden":"true",class:this.classes(gt,ye)}),vt="xsmall"!==$e&&this.get("dockOptions.buttonEnabled")?M.tsx("div",{role:"button","aria-label":et,title:et,tabIndex:0,bind:this,onclick:this._toggleDockEnabled,onkeydown:this._toggleDockEnabled,afterCreate:this._focusDockButtonNode,afterUpdate:this._focusDockButtonNode,class:this.classes(_e,be)},_t):null,bt=((i={})[pe]=Ye,i),yt=Ye?"button":"heading",wt=Ye?Ze?a.expand:a.collapse:"",mt=this.id+"-popup-title",Mt=Fe?M.tsx("div",{class:this.classes(le,bt),key:Fe,enterAnimation:ut,id:mt,role:yt,"aria-label":wt,title:wt,tabIndex:Ye?0:-1,bind:this,onclick:this._toggleCollapsed,onkeydown:this._toggleCollapsed},M.tsx("h2",{class:ue,innerHTML:Fe})):null,kt=M.tsx("span",{"aria-hidden":"true",class:this.classes(ye,N)}),xt=M.tsx("div",{role:"button",tabIndex:0,bind:this,onclick:this._close,onkeydown:this._close,class:_e,"aria-label":a.close,title:a.close},kt),Ft=M.tsx("header",{class:se},Mt,M.tsx("div",{class:ae},vt,y.closeButton?xt:null)),At=this.id+"-popup-content",Ct=!Xe||Ye&&Ze?null:M.tsx("article",{key:I,enterAnimation:ut,id:At,class:de},Je),Ot="bottom-left"===tt||"bottom-center"===tt||"bottom-right"===tt||"top-left"===ot||"top-center"===ot||"top-right"===ot,Et="top-left"===tt||"top-center"===tt||"top-right"===tt||"bottom-left"===ot||"bottom-center"===ot||"bottom-right"===ot,Nt=!!He.length,Pt=!!Ue.length,It=c?a.close:a.open,St=Pt?M.tsx("div",{key:Ge("actions-menu-button"),class:this.classes(_e,Me),role:"button",id:this.id+"-actions-menu-button","aria-haspopup":"true","aria-controls":c?this.id+"-actions-menu":null,tabIndex:0,bind:this,onclick:this._toggleActionsMenu,onkeydown:this._toggleActionsMenu,afterCreate:this._focusActionsMenuButtonNode,afterUpdate:this._focusActionsMenuButtonNode,"aria-label":It,title:It},M.tsx("span",{"aria-hidden":"true",class:D})):null,Wt=Nt&&He.toArray().map((function(e,t){return u._renderAction({action:e,index:t,type:"inline"})})),Dt=Pt&&c?M.tsx("ul",{id:this.id+"-actions-menu",role:"menu","aria-labelledby":this.id+"-actions-menu-button",key:Ge("actions"),class:ke,bind:this,onkeyup:this._handleActionMenuKeyup,afterCreate:this._actionsMenuNodeUpdated,afterUpdate:this._actionsMenuNodeUpdated},Ue.toArray().map((function(e,t){return u._renderAction({action:e,index:t+Ce,type:"menu-item"})}))):null,Tt=Nt||Pt?M.tsx("div",{key:"inline-actions-container","data-inline-actions":Nt.toString(),"data-menu-actions":Pt.toString(),class:me},Wt,St,Dt):null,Bt=Ae?M.tsx("section",{key:Ge("navigation"),class:this.classes(Pe)},ht):null,Lt=((n={})[he]=Ae,n[fe]=Nt,n[ge]=Pt,n),Ht=Ae||Nt?M.tsx("div",{key:Ge("feature-buttons"),class:this.classes(ce,Lt)},Tt,Bt):null,Ut=this._renderFeatureMenuNode(v,xe,dt),Vt=p.substitute(l.selectedFeatures,{total:v.length}),Rt=M.tsx("section",{key:Ge("menu"),class:Le},M.tsx("h2",{class:Re},Vt),M.tsx("nav",{class:Ve,afterCreate:this._featureMenuViewportNodeUpdated,afterUpdate:this._featureMenuViewportNodeUpdated},Ut)),Kt=g?null:M.tsx("div",{key:Ge("pointer"),class:Ee,role:"presentation"},M.tsx("div",{class:this.classes(Ne,K)})),zt=this.get("selectedFeature.layer.title"),jt=this.get("selectedFeature.layer.id"),qt=((r={})[K]=g,r[V]=Ye,r[R]=Ze,r),Gt=((s={})[Y]=b&&"top-center"===tt,s[Z]=b&&"bottom-center"===tt,s[$]=b&&"top-left"===tt,s[ee]=b&&"bottom-left"===tt,s[te]=b&&"top-right"===tt,s[oe]="bottom-right"===tt,s[z]=b&&g,s[K]=b&&!g,s[j]=b&&"top-left"===ot,s[q]=b&&"top-center"===ot,s[G]=b&&"top-right"===ot,s[J]=b&&"bottom-left"===ot,s[Q]=b&&"bottom-center"===ot,s[X]=b&&"bottom-right"===ot,s[ie]=b&&Ke,s[ne]=b&&je,s),Jt=Ot?Rt:null,Qt=Et?Rt:null,Xt=Ot?Ht:null,Yt=Et?Ht:null,Zt=M.tsx("div",{class:this.classes(H,L,qt),tabIndex:-1,role:"dialog","aria-labelledby":Mt?mt:"","aria-describedby":Ct?At:"",bind:this,onkeyup:this._handleMainKeyup,afterCreate:this._mainContainerNodeUpdated,afterUpdate:this._mainContainerNodeUpdated},Xt,Jt,Ft,Ct,Yt,Qt);return M.tsx("div",{key:Ge("base"),class:this.classes(B,Gt),role:"presentation","data-layer-title":zt,"data-layer-id":jt,bind:this,afterCreate:this._positionContainer,afterUpdate:this._positionContainer},b?[Zt,Kt]:null)},t.prototype._getInlineActionCount=function(e){var t=this.maxInlineActions;if("number"!=typeof t)return null;var o=Math.round(t);return Math.max(e?o-1:o,0)},t.prototype._watchActions=function(){var e=this,t=this.viewModel.allActions;this._handles.remove("actions"),t&&t.forEach((function(t){e._handles.add(v.watch(t,["active","className","disabled","id","title","image","visible"],(function(){return e.scheduleRender()})),"actions")}))},t.prototype._divideActions=function(e){var t=this.viewModel.allActions,o=null===e,i=0===e;return{inlineActions:o?t.slice(0):i?new u:t.slice(0,e),menuActions:o?new u:i?t.slice(0):t.slice(e)}},t.prototype._featureMenuOpenChanged=function(e){e?this._focusFirstFeature=!0:this._focusFeatureMenuButton=!0},t.prototype._actionsMenuOpenChanged=function(e){e?this._focusFirstAction=!0:this._focusActionsMenuButton=!0},t.prototype._setTitleFromFeatureWidget=function(e){this.selectedFeatureWidget&&(this.viewModel.title=e||"")},t.prototype._setContentFromFeatureWidget=function(){var e=this.selectedFeatureWidget;e&&(this.viewModel.content=e)},t.prototype._handleFeatureMenuKeyup=function(e){"Escape"===c.eventKey(e)&&(e.stopPropagation(),this._focusFeatureMenuButton=!0,this.featureMenuOpen=!1,this.scheduleRender())},t.prototype._handleActionMenuKeyup=function(e){"Escape"===c.eventKey(e)&&(e.stopPropagation(),this._focusActionsMenuButton=!0,this.actionsMenuOpen=!1,this.scheduleRender())},t.prototype._handleFeatureMenuItemKeyup=function(e){var t=c.eventKey(e),o=this._featureMenuNode,i=e.currentTarget["data-feature-index"];if(o){var n=o.querySelectorAll("li"),r=n.length;if("ArrowUp"===t)return e.stopPropagation(),void n[(i-1+r)%r].focus();if("ArrowDown"===t)return e.stopPropagation(),void n[(i+1+r)%r].focus();if("Home"===t)return e.stopPropagation(),void n[0].focus();if("End"===t)return e.stopPropagation(),void n[n.length-1].focus()}},t.prototype._handleActionMenuItemKeyup=function(e){var t=c.eventKey(e),o=this._actionsMenuNode,i=e.currentTarget["data-action-index"];if(o){var n=o.querySelectorAll("li"),r=n.length;if("ArrowUp"===t)return e.stopPropagation(),void n[(i-1+r)%r].focus();if("ArrowDown"===t)return e.stopPropagation(),void n[(i+1+r)%r].focus();if("Home"===t)return e.stopPropagation(),void n[0].focus();if("End"===t)return e.stopPropagation(),void n[n.length-1].focus()}},t.prototype._handleMainKeyup=function(e){var t=c.eventKey(e);"ArrowLeft"===t&&(e.stopPropagation(),this.previous()),"ArrowRight"===t&&(e.stopPropagation(),this.next())},t.prototype._spinnerEnabledChange=function(e){if(this._destroySpinner(),e){var t=this.get("viewModel.view");this._createSpinner(t)}},t.prototype._displaySpinner=function(){var e=this._spinner;if(e){var t=this.viewModel,o=t.location;t.waitingForResult?e.show({location:o}):e.hide()}},t.prototype._getIconStyles=function(e){return{"background-image":e?"url("+e+")":""}},t.prototype._renderAction=function(e){var t,o,i=e.action,n=e.index,r=e.type,s=this.get("selectedFeature.attributes"),a=i.title,l=i.className,u=i.image,d=u||l?l:W,c=a&&s?p.substitute(a,s):a,h=d&&s?p.substitute(d,s):d,f=u&&s?p.substitute(u,s):u,g=((t={})[S]=i.active,t[T]=i.active,t[ye]=!!d,t[Fe]=!i.active&&!!f,t);h&&(g[h]=!i.active);var _=((o={})[xe]="toggle"!==i.type,o[Ce]="toggle"===i.type,o[Oe]="toggle"===i.type&&i.value,o[ve]=i.disabled,o),v=M.tsx("span",{key:"text",class:Ae},c),b=[M.tsx("span",{key:"icon","aria-hidden":"true",class:this.classes(ye,g),styles:this._getIconStyles(f)}),v],y="menu-item"===r?M.tsx("li",{key:i,role:"menuitem",tabIndex:0,title:c,"aria-label":c,class:this.classes(_e,_),onkeyup:this._handleActionMenuItemKeyup,bind:this,"data-action-index":n,onclick:this._triggerAction,onkeydown:this._triggerAction},b):M.tsx("div",{key:i,role:"button",tabIndex:0,title:c,"aria-label":c,class:this.classes(_e,_),onkeyup:this._handleActionMenuItemKeyup,bind:this,"data-action-index":n,onclick:this._triggerAction,onkeydown:this._triggerAction},b);return i.visible?y:null},t.prototype._addSelectedFeatureIndexHandle=function(){var e=this,t=v.watch(this,"viewModel.selectedFeatureIndex",(function(t,o){return e._selectedFeatureIndexUpdated(t,o)}));this._handles.add(t,"selected-index")},t.prototype._selectedFeatureIndexUpdated=function(e,t){this.featureCount&&e!==t&&-1!==e&&(this.actionsMenuOpen=!1,this.featureMenuOpen=!1)},t.prototype._updateFeatureWidget=function(){var e=this.featureWidgets[this.viewModel.selectedFeatureIndex]||null;this._set("selectedFeatureWidget",e)},t.prototype._destroyFeatureWidgets=function(){this.featureWidgets.forEach((function(e){return e&&!e.destroyed&&e.destroy()})),this._set("featureWidgets",[])},t.prototype._updateFeatureWidgets=function(){return s(this,void 0,void 0,(function(){var e,t,o,i,s,a,l=this;return r(this,(function(r){switch(r.label){case 0:return t=(e=this).features,o=e.featureWidgets,t&&t.length?[4,Je()]:(this._destroyFeatureWidgets(),[2]);case 1:return i=r.sent(),s=o.slice(0),a=[],t.forEach((function(e,t){if(e){var o=null;if(s.some((function(t,i){return t&&t.graphic===e&&(o=t,s.splice(i,1)),!!o})),o)a[t]=o;else{var r=new i({defaultPopupTemplateEnabled:l.defaultPopupTemplateEnabled,graphic:e,spatialReference:l.get("view.spatialReference"),map:l.get("view.map")});r.visibleElements=n({},r.visibleElements,{title:!1}),a[t]=r}}})),s.forEach((function(e){return e&&!e.destroyed&&e.destroy()})),this._set("featureWidgets",a),[2]}}))}))},t.prototype._isScreenLocationWithinView=function(e,t){return e.x>-1&&e.y>-1&&e.x<=t.width&&e.y<=t.height},t.prototype._isOutsideView=function(e){var t=e.popupHeight,o=e.popupWidth,i=e.screenLocation,n=e.side,r=e.view;if(isNaN(o)||isNaN(t)||!r||!i)return!1;var s=r.padding;return"right"===n&&i.x+o/2>r.width-s.right||("left"===n&&i.x-o/2<s.left||("top"===n&&i.y-t<s.top||"bottom"===n&&i.y+t>r.height-s.bottom))},t.prototype._determineCurrentAlignment=function(){var e=this._pointerOffsetInPx,t=this._containerNode,o=this._mainContainerNode,i=this.viewModel,n=i.screenLocation,r=i.view;if(!n||!r||!t)return"top-center";if(!this._isScreenLocationWithinView(n,r))return this._get("currentAlignment")||"top-center";function s(e){return parseInt(e.replace(/[^-\d\.]/g,""),10)}var a=o?window.getComputedStyle(o,null):null,l=a?s(a.getPropertyValue("max-height")):0,p=a?s(a.getPropertyValue("height")):0,u=t.getBoundingClientRect(),d=u.height,c=u.width+e,h=Math.max(d,l,p)+e,f=this._isOutsideView({popupHeight:h,popupWidth:c,screenLocation:n,side:"right",view:r}),g=this._isOutsideView({popupHeight:h,popupWidth:c,screenLocation:n,side:"left",view:r}),_=this._isOutsideView({popupHeight:h,popupWidth:c,screenLocation:n,side:"top",view:r}),v=this._isOutsideView({popupHeight:h,popupWidth:c,screenLocation:n,side:"bottom",view:r});return g?_?"bottom-right":"top-right":f?_?"bottom-left":"top-left":_?v?"top-center":"bottom-center":"top-center"},t.prototype._getCurrentAlignment=function(){var e=this.alignment;return this.dockEnabled?null:"auto"===e?this._determineCurrentAlignment():"function"==typeof e?e.call(this):e},t.prototype._setCurrentAlignment=function(){this._set("currentAlignment",this._getCurrentAlignment())},t.prototype._setCurrentDockPosition=function(){this._set("currentDockPosition",this._getCurrentDockPosition())},t.prototype._getDockPosition=function(){var e=this.get("dockOptions.position");return"auto"===e?this._determineCurrentDockPosition():"function"==typeof e?e.call(this):e},t.prototype._getCurrentDockPosition=function(){return this.dockEnabled?this._getDockPosition():null},t.prototype._wouldDockTo=function(){return this.dockEnabled?null:this._getDockPosition()},t.prototype._renderFeatureMenuItemNode=function(e,t,o){var i,n=t===o,r=((i={})[Ke]=n,i),s=n?M.tsx("span",{key:Ge("feature-menu-selected-feature-"+o),title:l.selectedFeature,"aria-label":l.selectedFeature,class:I}):null,p=M.tsx("span",{innerHTML:e.title||a.untitled});return M.tsx("li",{role:"menuitem",tabIndex:-1,key:Ge("feature-menu-feature-"+o),class:this.classes(r,Ue),bind:this,"data-feature-index":t,onkeyup:this._handleFeatureMenuItemKeyup,onclick:this._selectFeature,onkeydown:this._selectFeature},M.tsx("span",{class:je},p,s))},t.prototype._renderFeatureMenuNode=function(e,t,o){var i=this;return e.length>1?M.tsx("ol",{class:He,id:o,bind:this,afterCreate:this._featureMenuNodeUpdated,afterUpdate:this._featureMenuNodeUpdated,onkeyup:this._handleFeatureMenuKeyup,role:"menu"},e.map((function(e,o){return i._renderFeatureMenuItemNode(e,o,t)}))):null},t.prototype._determineCurrentDockPosition=function(){var e=this.get("viewModel.view"),t=k.isRTL()?"top-left":"top-right";if(!e)return t;var o=e.padding||{left:0,right:0,top:0,bottom:0},i=e.width-o.left-o.right,n=e.get("breakpoints");return n&&i<=n.xsmall?"bottom-center":t},t.prototype._renderContent=function(){var e=this.get("viewModel.content");return e?"string"==typeof e?M.tsx("div",{key:e,innerHTML:e}):M.isWidget(e)&&!e.destroyed?M.tsx("div",{key:e},e.render()):e instanceof HTMLElement?M.tsx("div",{key:e,bind:e,afterCreate:this._attachToNode}):M.hasDomNode(e)?M.tsx("div",{key:e,bind:e.domNode,afterCreate:this._attachToNode}):void 0:null},t.prototype._attachToNode=function(e){e.appendChild(this)},t.prototype._positionContainer=function(e){if(void 0===e&&(e=this._containerNode),e&&(this._containerNode=e),e){var t=this.viewModel.screenLocation,o=e.getBoundingClientRect().width,i=this._calculatePositionStyle(t,o);i&&(e.style.top=i.top,e.style.left=i.left,e.style.bottom=i.bottom,e.style.right=i.right)}},t.prototype._calculateFullWidth=function(e){var t=this.currentAlignment,o=this._pointerOffsetInPx;return"top-left"===t||"bottom-left"===t||"top-right"===t||"bottom-right"===t?e+o:e},t.prototype._calculateAlignmentPosition=function(e,t,o,i){var n=this.currentAlignment,r=this._pointerOffsetInPx,s=i/2,a=o.height-t,l=o.width-e,p=this.view.padding;return"bottom-center"===n?{top:t+r-p.top,left:e-s-p.left}:"top-left"===n?{bottom:a+r-p.bottom,right:l+r-p.right}:"bottom-left"===n?{top:t+r-p.top,right:l+r-p.right}:"top-right"===n?{bottom:a+r-p.bottom,left:e+r-p.left}:"bottom-right"===n?{top:t+r-p.top,left:e+r-p.left}:"top-center"===n?{bottom:a+r-p.bottom,left:e-s-p.left}:void 0},t.prototype._calculatePositionStyle=function(e,t){var o=this.dockEnabled,i=this.view;if(i){if(o)return{left:"",top:"",right:"",bottom:""};if(e&&t){var n=this._calculateFullWidth(t),r=this._calculateAlignmentPosition(e.x,e.y,i,n);if(r)return{top:void 0!==r.top?r.top+"px":"auto",left:void 0!==r.left?r.left+"px":"auto",bottom:void 0!==r.bottom?r.bottom+"px":"auto",right:void 0!==r.right?r.right+"px":"auto"}}}},t.prototype._viewChange=function(e,t){e&&t&&(this.close(),this.clear())},t.prototype._viewReadyChange=function(e,t){if(e){var o=this.get("viewModel.view");this._wireUpView(o)}else t&&(this.close(),this.clear())},t.prototype._wireUpView=function(e){(this._destroySpinner(),e)&&(this.spinnerEnabled&&this._createSpinner(e),this._setDockEnabledForViewSize(this.dockOptions))},t.prototype._dockingThresholdCrossed=function(e,t,o){var i=e[0],n=e[1],r=t[0],s=t[1],a=o.width,l=o.height;return i<=a&&r>a||i>a&&r<=a||n<=l&&s>l||n>l&&s<=l},t.prototype._updateDockEnabledForViewSize=function(e,t){if(e&&t){var o=this.get("viewModel.view.padding")||{left:0,right:0,top:0,bottom:0},i=o.left+o.right,n=o.top+o.bottom,r=[],s=[];r[0]=e[0]-i,r[1]=e[1]-n,s[0]=t[0]-i,s[1]=t[1]-n;var a=this.dockOptions,l=a.breakpoint;this._dockingThresholdCrossed(r,s,l)&&this._setDockEnabledForViewSize(a),this._setCurrentDockPosition()}},t.prototype._focusDockButtonNode=function(e){this._focusDockButton&&(this._focusDockButton=!1,e.focus())},t.prototype._mainContainerNodeUpdated=function(e){return this._mainContainerNode=e,this._focusContainer?(this._focusContainer=!1,void e.focus()):this._blurContainer?(this._blurContainer=!1,void e.blur()):void 0},t.prototype._featureMenuNodeUpdated=function(e){if(this._featureMenuNode=e,e&&this._focusFirstFeature){this._focusFirstFeature=!1;var t=e.querySelectorAll("li");if(t.length)t[0].focus()}},t.prototype._actionsMenuNodeUpdated=function(e){if(this._actionsMenuNode=e,e&&this._focusFirstAction){this._focusFirstAction=!1;var t=e.querySelectorAll("li");if(t.length)t[0].focus()}},t.prototype._focusFeatureMenuButtonNode=function(e){this._focusFeatureMenuButton&&(this._focusFeatureMenuButton=!1,e.focus())},t.prototype._focusActionsMenuButtonNode=function(e){this._focusActionsMenuButton&&(this._focusActionsMenuButton=!1,e.focus())},t.prototype._featureMenuViewportNodeUpdated=function(e){e&&(e.scrollTop=0)},t.prototype._toggleScreenLocationEnabled=function(){var e=this.dockEnabled,t=this.visible,o=this.viewModel;if(o){var i=t&&!e;o.screenLocationEnabled=i}},t.prototype._shouldDockAtCurrentViewSize=function(e){var t=e.breakpoint,o=this.get("viewModel.view.ui"),i=o.width,n=o.height;if(isNaN(i)||isNaN(n))return!1;var r=t.hasOwnProperty("width")&&i<=t.width,s=t.hasOwnProperty("height")&&n<=t.height;return r||s},t.prototype._setDockEnabledForViewSize=function(e){e.breakpoint&&(this.dockEnabled=this._shouldDockAtCurrentViewSize(e))},t.prototype._getPageText=function(e,t){return p.substitute(l.pageText,{index:t+1,total:e})},t.prototype._destroySpinner=function(){var e=this._spinner,t=this.view;e&&(t&&t.ui&&t.ui.remove(this._spinner,"popup-spinner"),e.destroy(),this._spinner=null)},t.prototype._createSpinner=function(e){e&&(this._spinner=new y({view:e}),e.ui.add(this._spinner,{key:"popup-spinner",position:"manual"}))},t.prototype._toggleCollapsed=function(){this.collapsed=!this.collapsed},t.prototype._close=function(){this.close(),this.view&&this.view.focus()},t.prototype._toggleDockEnabled=function(){this.dockEnabled=!this.dockEnabled,this._focusDockButton=!0,this.scheduleRender()},t.prototype._toggleFeatureMenu=function(){var e=!this.featureMenuOpen;this._featureMenuOpenChanged(e),this.actionsMenuOpen=!1,this.featureMenuOpen=e},t.prototype._toggleActionsMenu=function(){var e=!this.actionsMenuOpen;this._actionsMenuOpenChanged(e),this.featureMenuOpen=!1,this.actionsMenuOpen=e},t.prototype._triggerAction=function(e){var t=e.currentTarget["data-action-index"],o=this.viewModel.allActions.getItemAt(t);o&&"toggle"===o.type&&(o.value=!o.value),this.actionsMenuOpen=!1,this.viewModel.triggerAction(t)},t.prototype._selectFeature=function(e){var t=e.currentTarget["data-feature-index"];isNaN(t)||(this.viewModel.selectedFeatureIndex=t),this.featureMenuOpen=!1,this._focusFeatureMenuButton=!0,this.scheduleRender()},t.prototype._next=function(){this.next()},t.prototype._previous=function(){this.previous()},i([b.aliasOf("viewModel.actions"),M.renderable()],t.prototype,"actions",void 0),i([b.property({dependsOn:["viewModel.visible"]}),M.renderable()],t.prototype,"actionsMenuOpen",null),i([b.property()],t.prototype,"alignment",void 0),i([b.aliasOf("viewModel.autoCloseEnabled")],t.prototype,"autoCloseEnabled",void 0),i([b.aliasOf("viewModel.autoOpenEnabled")],t.prototype,"autoOpenEnabled",void 0),i([b.aliasOf("viewModel.defaultPopupTemplateEnabled")],t.prototype,"defaultPopupTemplateEnabled",void 0),i([b.aliasOf("viewModel.content"),M.renderable()],t.prototype,"content",void 0),i([b.property(),M.renderable()],t.prototype,"collapsed",void 0),i([b.property(),M.renderable()],t.prototype,"collapseEnabled",void 0),i([b.property({readOnly:!0,dependsOn:["dockEnabled","alignment"]}),M.renderable()],t.prototype,"currentAlignment",null),i([b.property({readOnly:!0,dependsOn:["viewModel.view.ready","dockEnabled","dockOptions"]}),M.renderable()],t.prototype,"currentDockPosition",null),i([b.property(),M.renderable()],t.prototype,"dockOptions",null),i([b.property(),M.renderable()],t.prototype,"dockEnabled",void 0),i([b.aliasOf("viewModel.featureCount"),M.renderable()],t.prototype,"featureCount",void 0),i([b.property(),M.renderable()],t.prototype,"featureMenuOpen",void 0),i([b.aliasOf("viewModel.features"),M.renderable()],t.prototype,"features",void 0),i([b.property(),M.renderable()],t.prototype,"featureNavigationEnabled",null),i([b.aliasOf("viewModel.goToOverride")],t.prototype,"goToOverride",void 0),i([b.aliasOf("viewModel.highlightEnabled")],t.prototype,"highlightEnabled",void 0),i([b.aliasOf("viewModel.location"),M.renderable()],t.prototype,"location",void 0),i([b.property({readOnly:!0}),M.renderable()],t.prototype,"featureWidgets",void 0),i([b.property()],t.prototype,"label",void 0),i([b.property(),M.renderable()],t.prototype,"maxInlineActions",void 0),i([b.aliasOf("viewModel.promises")],t.prototype,"promises",void 0),i([b.aliasOf("viewModel.selectedFeature"),M.renderable()],t.prototype,"selectedFeature",void 0),i([b.aliasOf("viewModel.selectedFeatureIndex"),M.renderable()],t.prototype,"selectedFeatureIndex",void 0),i([b.property({readOnly:!0}),M.renderable()],t.prototype,"selectedFeatureWidget",void 0),i([b.property()],t.prototype,"spinnerEnabled",void 0),i([b.aliasOf("viewModel.title"),M.renderable()],t.prototype,"title",void 0),i([b.aliasOf("viewModel.updateLocationEnabled")],t.prototype,"updateLocationEnabled",void 0),i([b.aliasOf("viewModel.view")],t.prototype,"view",void 0),i([b.property({type:m}),M.renderable(["viewModel.view.widthBreakpoint","viewModel.allActions","viewModel.screenLocation","viewModel.screenLocationEnabled","viewModel.state","viewModel.pendingPromisesCount","viewModel.promiseCount","viewModel.waitingForResult"]),M.vmEvent(["triggerAction","trigger-action"])],t.prototype,"viewModel",void 0),i([b.aliasOf("viewModel.visible"),M.renderable()],t.prototype,"visible",void 0),i([b.property(),M.renderable()],t.prototype,"visibleElements",void 0),i([b.cast("visibleElements")],t.prototype,"castVisibleElements",null),i([M.accessibleHandler()],t.prototype,"_toggleCollapsed",null),i([M.accessibleHandler()],t.prototype,"_close",null),i([M.accessibleHandler()],t.prototype,"_toggleDockEnabled",null),i([M.accessibleHandler()],t.prototype,"_toggleFeatureMenu",null),i([M.accessibleHandler()],t.prototype,"_toggleActionsMenu",null),i([M.accessibleHandler()],t.prototype,"_triggerAction",null),i([M.accessibleHandler()],t.prototype,"_selectFeature",null),i([M.accessibleHandler()],t.prototype,"_next",null),i([M.accessibleHandler()],t.prototype,"_previous",null),t=i([b.subclass("esri.widgets.Popup")],t)}(b.declared(w))}));