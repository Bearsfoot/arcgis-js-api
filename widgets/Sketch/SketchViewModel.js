// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/assignHelper","../../core/tsSupport/declareExtendsHelper","../../core/tsSupport/decorateHelper","../../core/tsSupport/generatorHelper","../../core/tsSupport/awaiterHelper","../../geometry","../../Graphic","../../symbols","../../core/Collection","../../core/compilerUtils","../../core/Error","../../core/Evented","../../core/Handles","../../core/Logger","../../core/maybe","../../core/screenUtils","../../core/watchUtils","../../core/accessorSupport/decorators","../../geometry/support/coordsUtils","../../layers/GraphicsLayer","../../support/elevationInfoUtils","../../symbols/SimpleFillSymbol","../../symbols/SimpleLineSymbol","../../symbols/SimpleMarkerSymbol","../../views/DOMContainer","../../views/3d/interactive/editingTools/isSupportedGraphicUtils","../../views/3d/interactive/editingTools/graphicMove3D/isSupportedGraphic","../../views/3d/interactive/editingTools/graphicReshape3D/isSupportedGraphic","../../views/3d/interactive/editingTools/graphicTransform3D/isSupportedGraphic","../../views/draw/Draw","../../views/draw/support/createUtils","../../views/draw/support/layerUtils","../../views/input/InputManager","./support/OperationHandle","@dojo/framework/shim/Promise"],(function(e,t,r,o,i,a,n,p,s,c,l,h,d,u,v,y,m,f,g,_,G,w,b,S,E,x,T,C,I,A,P,H,O,k,L,D){var M=y.getLogger("esri.widgets.Sketch.SketchViewModel"),U={redoKey:"r",undoKey:"z",centerKey:"Alt",constraintKey:"Control",snappingKey:"Shift",cancelKey:"Escape",deleteKeys:["Backspace","Delete"]};function R(e,t){var r=e.history.undo.pop().updates,o=[];t.forEach((function(e,t){var i=r[t],a={};null!=i&&(m.isSome(i.geometry)&&(a.geometry=e.geometry,e.geometry=i.geometry),m.isSome(i.symbol)&&(a.symbol=e.symbol,e.symbol=i.symbol),o.push(a))})),e.history.redo.push({updates:o})}function V(e,t){var r=e.history.redo.pop().updates,o=[];t.forEach((function(e,t){var i=r[t],a={};null!=i&&(m.isSome(i.geometry)&&(a.geometry=e.geometry,e.geometry=i.geometry),m.isSome(i.symbol)&&(a.symbol=e.symbol,e.symbol=i.symbol),o.push(a))})),e.history.undo.push({updates:o})}function F(e){return{updates:e.map((function(e){return{geometry:e.geometry}}))}}function K(e){return{updates:e.map((function(e){return{symbol:e.symbol}}))}}function W(e){return"requireError"in e&&"aborted"===e.requireError}return(function(t){function u(e){var r=t.call(this,e)||this;return r._activeFillGraphic=null,r._activeLineGraphic=null,r._centerIndicatorGraphic=null,r._centerSymbol=new x({style:"cross",size:6,color:[255,255,255]}),r._defaultSegmentOffset=48,r._handles=new v,r._internalGraphicsLayer=new w({listMode:"hide"}),r._lineGraphic=null,r._operationHandle=null,r._vertexGraphics=[],r._viewHandles=new v,r._doUnnormalization=!1,r.activeFillSymbol=new S({style:"solid",color:[150,150,150,.2],outline:{color:[0,0,0,0]}}),r.activeLineSymbol=new E({color:[12,207,255,1],width:2,style:"dash"}),r.activePointSymbol=new x({style:"circle",size:6,color:[12,207,255],outline:{color:[50,50,50],width:1}}),r.activeVertexSymbol=new x({style:"circle",size:6,color:[12,207,255],outline:{color:[50,50,50],width:1}}),r.createGraphic=null,r.defaultCreateOptions={mode:"hybrid"},r.defaultUpdateOptions={enableMidpoints:!0,enableMoveAllGraphics:!0,enableRotation:!0,enableScaling:!0,multipleSelectionEnabled:!0,preserveAspectRatio:!1,toggleToolOnClick:!0,tool:"transform",enableZ:!0},r.layer=null,r.pointSymbol=new x({style:"circle",size:6,color:[255,255,255],outline:{color:[50,50,50],width:1}}),r.polygonSymbol=new S({color:[150,150,150,.2],outline:{color:[50,50,50],width:2}}),r.polylineSymbol=new E({color:[130,130,130,1],width:2}),r.updateGraphics=new l,r.updateOnGraphicClick=!0,r.updatePointSymbol=new x({size:10,color:[0,200,255,.5],outline:{color:"black",width:1}}),r.updatePolygonSymbol=new S({color:[12,207,255,.2],outline:{join:"round",color:[12,207,255],width:2}}),r.updatePolylineSymbol=new E({color:[12,207,255],width:2}),r.vertexSymbol=new x({style:"circle",size:6,color:[255,255,255],outline:{color:[50,50,50],width:1}}),r}return o(u,t),u.prototype.initialize=function(){var e=this;this._handles.add([g.watch(this,"layer",(function(){e.cancel(),e._internalGraphicsLayer.elevationInfo=m.isSome(e.layer)?e.layer.elevationInfo:null})),g.on(this,"view.map.layers","change",(function(t){t.removed.indexOf(e.layer)>=0&&e.cancel()})),g.on(this,"layer.graphics","change",(function(t){if(m.isSome(e._operationHandle))for(var r=0,o=t.removed;r<o.length;r++){var i=o[r];e.updateGraphics.includes(i)&&(e.updateGraphics.length>1?e._operationHandle.removeFromSelection(i):e._operationHandle.cancel())}})),g.init(this,"layer.elevationInfo",(function(){e.cancel(),e._internalGraphicsLayer.elevationInfo=m.isSome(e.layer)?e.layer.elevationInfo:null}),!0)])},u.prototype.destroy=function(){this.cancel(),this._handles.removeAll(),this._handles=null,this._viewHandles.removeAll(),this._viewHandles=null,this._removeDefaultLayer(),this._draw&&this._draw.destroy(),this._set("view",null),this.emit("destroy")},Object.defineProperty(u.prototype,"_defaultUpdateTool",{get:function(){return"3d"===this.view.type?"move":"transform"},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"_draw",{get:function(){return"ready"===this.state||"active"===this.state?new H({view:this.view}):null},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"activeTool",{get:function(){return this._operationHandle&&this._operationHandle.tool?this._operationHandle.tool:null},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"activeComponent",{get:function(){return this._operationHandle?this._operationHandle.activeComponent:null},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"state",{get:function(){var e=!(!this.get("view.ready")||!this.layer),t=this._operationHandle;return e&&t?"active":e?"ready":"disabled"},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"view",{get:function(){return this._get("view")},set:function(e){var t=this,r=this._get("view");if(r){var o=r.container,i=r.map;o&&(r.cursor=null),i&&i.remove(this._internalGraphicsLayer),this._viewHandles.removeAll(),this.cancel()}this._doUnnormalization=null!=e&&"3d"===e.type&&"global"===e.viewingMode;this._handles.remove("view-ready"),e&&this._handles.add(g.when(e,"ready",(function(r){t._viewHandles.removeAll(),r&&t._viewHandles.add(t._generateViewHandles(e))}),!0),"view-ready"),this._set("view",e)},enumerable:!0,configurable:!0}),u.prototype.cancel=function(){this._moduleLoaderAbortController&&(this._moduleLoaderAbortController.abort(),this._moduleLoaderAbortController=null),this._operationHandle&&this._operationHandle.cancel()},u.prototype.complete=function(){this._operationHandle&&this._operationHandle.complete()},u.prototype.delete=function(){var e=this.state,t=this.updateGraphics;if("active"===e&&t.length){var r=this.activeTool,o=this.layer,i=t.toArray();o.removeMany(i),this.cancel(),this._emitDeleteEvent({graphics:i,tool:r})}},u.prototype.create=function(e,t){var r=this;if("disabled"===this.state)return this.layer||this._logError("sketch:missing-property","Property 'layer' is missing on SketchViewModel."),void(this.view||this._logError("sketch:missing-property","Property 'view' is missing on SketchViewModel."));if(this.cancel(),e){var o=this._setupCreateOperation(e,t);if(!m.isNone(o)){k.addUniqueLayer(this.view,this._internalGraphicsLayer);o.on("complete",(function(){if(o===r._operationHandle){var t=r.createGraphic,i=r._operationHandle.cancelled;r._operationHandle.destroy(),r._operationHandle=null,r._set("createGraphic",null),r.view&&r.view.map&&r.view.map.remove(r._internalGraphicsLayer),o.cancelled||r.layer.add(t),r.emit("create",{graphic:t,state:i?"cancel":"complete",tool:e,toolEventInfo:null,type:"create"})}})),this._operationHandle=o,this.view.ready&&T.isDOMContainer(this.view)&&this.view.focus()}}else this._logError("sketch:missing-parameter","Missing parameter 'tool'.")},u.prototype.update=function(e,t){return n(this,void 0,void 0,(function(){var r,o,i,n,p,s,c=this;return a(this,(function(a){switch(a.label){case 0:return o=(r=this).layer,i=r.state,n=r.view,"disabled"===i?(o||this._logError("sketch:missing-property","Property 'layer' is missing on SketchViewModel."),n||this._logError("sketch:missing-property","Property 'view' is missing on SketchViewModel."),[2]):(this.cancel(),p=Array.isArray(e)?e:[e],null!=e&&p&&p.length?p.some((function(e){return e.layer!==o?(c._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics missing from the supplied GraphicsLayer."),!0):m.isNone(e.geometry)?(c._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics with an unsupported geometry."),!0):"2d"===n.type&&!n.spatialReference.equals(e.geometry.spatialReference)&&(c._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics with a spatial reference different from the supplied MapView."),!0)}))?[2]:[4,this._setupUpdateOperation(p,t)]:(this._logError("sketch:missing-parameter","Missing parameter 'graphics'."),[2]));case 1:return s=a.sent(),m.isNone(s)||W(s)?[2]:(k.addUniqueLayer(this.view,this._internalGraphicsLayer),this.emit("update",{graphics:p,state:"start",aborted:!1,tool:s.tool,toolEventInfo:null,type:"update"}),this._setUpdateOperationHandle(s),[2])}}))}))},u.prototype.undo=function(){this.canUndo()&&this._operationHandle.undo()},u.prototype.redo=function(){this.canRedo()&&this._operationHandle.redo()},u.prototype.canUndo=function(){return!(!this._operationHandle||!this._operationHandle.canUndo())},u.prototype.canRedo=function(){return!(!this._operationHandle||!this._operationHandle.canRedo())},u.prototype.toggleUpdateTool=function(){this._operationHandle&&this._operationHandle.toggleTool&&this._operationHandle.toggleTool()},Object.defineProperty(u.prototype,"snapToScene",{set:function(e){this._operationHandle&&this._operationHandle.setSnapToScene&&this._operationHandle.setSnapToScene(e),this._set("snapToScene",e)},enumerable:!0,configurable:!0}),u.prototype._getFirstHit=function(e){return n(this,void 0,void 0,(function(){var t;return a(this,(function(r){switch(r.label){case 0:return[4,this.view.hitTest(e)];case 1:return(t=r.sent()).results.length>0?[2,{screenPoint:e,results:[t.results[0]]}]:[2,{screenPoint:e,results:[]}]}}))}))},u.prototype._generateViewHandles=function(e){var t=this;return[e.on("immediate-click",(function(e){var o=t,i=o._operationHandle,a=o.defaultUpdateOptions,n=o.layer,p=o.state,s=o.updateGraphics,c=o.updateOnGraphicClick,l="active"===p&&"create"===i.type;"disabled"!==p&&!l&&c&&t._getFirstHit(f.createScreenPointFromEvent(e)).then((function(o){var i=o.results;i.length?i.some((function(e){if(e.graphic){var o=e.graphic;if(s.indexOf(o)>-1)return!0;if(o.layer===n)return t.update([o],r({},a)),!0}return!1}))&&e.stopPropagation():"active"===p&&t.cancel()}))}),L.ViewEventPriorities.WIDGET)]},u.prototype._setupCreateOperation=function(e,t){if(!e)return null;var o,i=r({hasZ:"3d"===this.view.type,defaultZ:0},this.defaultCreateOptions,t);switch(e){case"point":o=this._setupCreatePointOperation(e,i);break;case"multipoint":o=this._setupCreateMultipointOperation(e,null);break;case"polygon":case"polyline":o=this._setupCreatePolyOperation(e,i);break;case"rectangle":o=this._setupCreateRectangleOperation(e,i);break;case"circle":o=this._setupCreateCircleOperation(e,i)}return o},u.prototype._setupCreatePointOperation=function(e,t){var r=this,o={elevationInfo:this.layer.elevationInfo,hasZ:t.hasZ,defaultZ:t.defaultZ,interactiveUndoDisabled:!0},i=this._draw.create(e,o);i.snapToScene=this._getDefaultSnapToScene(o.elevationInfo);var a=[i.on("cursor-update",(function(e){m.isSome(e.coordinates)?r._displayCrosshairCursor():r._displayDefaultCursor()})),i.on("draw-complete",(function(e){var t=r.createPointFromVertex(e.coordinates),o=new s(t,r.pointSymbol);r._set("createGraphic",o),p&&p.complete()}))],n=[this.view.on("key-down",(function(e){e.key===U.cancelKey&&(p&&p.cancel(),e.stopPropagation())}),L.ViewEventPriorities.WIDGET)],p=this._operationHandleForCreateAction(i,a.concat(n),e);return p},u.prototype._setupCreateMultipointOperation=function(e,t){var o=this,i=r({},t,{undoDisabled:!0}),a=this._draw.create(e,i),n=null,p=[],s=this._operationHandleForCreateAction(a,p,e);return p.push(a.on("vertex-add",(function(t){var r=t.type,i=t.vertexIndex,a=t.vertices,p=a[i];n=t,o._drawMultipointGraphic(a,!0),o.emit("create",{graphic:o.createGraphic,state:1===a.length?"start":"active",tool:e,toolEventInfo:{added:p,vertices:[{coordinates:p,componentIndex:0,vertexIndex:i}],type:r},type:"create"})})),a.on("vertex-remove",(function(t){var r=t.type,i=t.vertexIndex,a=t.vertices,p=a[i];n=t,o._drawMultipointGraphic(a,!0),o.emit("create",{graphic:o.createGraphic,state:"active",tool:e,toolEventInfo:{removed:p,vertices:[{coordinates:p,componentIndex:0,vertexIndex:i}],type:r},type:"create"})})),a.on("vertex-update",(function(t){var r=t.type,i=t.vertexIndex,a=t.vertices,p=a[i];n=t,o._drawMultipointGraphic(a,!0),o.emit("create",{graphic:o.createGraphic,state:"active",tool:e,toolEventInfo:{type:r,updated:p,vertices:[{coordinates:p,componentIndex:0,vertexIndex:i}]},type:"create"})})),a.on("cursor-update",(function(e){n=e})),a.on("draw-complete",(function(e){var t=e.vertices.slice(0),r=O.createMultipoint(t,o.view.spatialReference);r&&o.createGraphic&&(o.createGraphic.geometry=r),s&&s.complete()})),a.on("undo",(function(e){var t=e.vertices,r=n&&"cursor-update"!==n.type;o._resetCreateOperationGraphics(),t.length&&o._drawMultipointGraphic(t,r)})),a.on("redo",(function(e){var t=e.vertices,r=n&&"cursor-update"!==n.type;o._resetCreateOperationGraphics(),t.length&&o._drawMultipointGraphic(t,r)}))),p.push(this.view.on("pointer-move",(function(){return o._displayCrosshairCursor()}),L.ViewEventPriorities.WIDGET),this.view.on("key-down",(function(e){return o._getCommonUpdateOperationKeyDownHandlers(s,e)}),L.ViewEventPriorities.WIDGET)),s},u.prototype._snapToScene3D=function(e,t){var r=this.view.toMap(e,{exclude:[this._internalGraphicsLayer]});return m.isSome(r)&&"3d"===this.view.type&&(r.z=b.getZForElevationMode(r,this.view,t)),r},u.prototype._getDefaultSnapToScene=function(e){var t=this;if("2d"===this.view.type)return null;return(m.isSome(this.snapToScene)?this.snapToScene:!m.isSome(e)||"absolute-height"===e.mode)?function(e,r){return t._snapToScene3D(e,r)}:null},u.prototype._setupCreatePolyOperation=function(e,t){var o=this,i=r({},t,{elevationInfo:this.layer.elevationInfo,interactiveUndoDisabled:!0}),a=null;"polyline"===e?a=this._draw.create(e,i):"polygon"===e&&(a=this._draw.create(e,i));var n=new p.Point,s=null,c=!1;a.snapToScene=this._getDefaultSnapToScene(i.elevationInfo);var l=[a.on("vertex-add",(function(t){var r=t.type,i=t.vertexIndex,a=t.vertices,n=a[i];o._snap(e,a,c),s=t,o._drawVertexGraphics(e,a,{userClicked:!0}),o.emit("create",{graphic:o.createGraphic,state:1===a.length?"start":"active",tool:e,toolEventInfo:{added:n,vertices:[{coordinates:n,componentIndex:0,vertexIndex:i}],type:r},type:"create"})})),a.on("vertex-remove",(function(t){var r=t.type,i=t.vertexIndex,a=t.vertices,n=a[i];o._snap(e,a,c),s=t,o._drawVertexGraphics(e,a,{userClicked:!0}),o.emit("create",{graphic:o.createGraphic,state:"active",tool:e,toolEventInfo:{removed:n,vertices:[{coordinates:n,componentIndex:0,vertexIndex:i}],type:r},type:"create"})})),a.on("vertex-update",(function(t){var r=t.type,i=t.vertexIndex,a=t.vertices,n=a[i];o._snap(e,a,c),s=t,o._drawVertexGraphics(e,a,{userClicked:!0}),o.emit("create",{graphic:o.createGraphic,state:"active",tool:e,toolEventInfo:{type:r,updated:n,vertices:[{coordinates:n,componentIndex:0,vertexIndex:i}]},type:"create"})})),a.on("cursor-update",(function(t){var r=t.type,i=t.vertices;if(t.mapPoint&&(o._snap(e,i,c),s=t,n=t.mapPoint,o._drawVertexGraphics(e,i,{userClicked:!1}),i.length>1)){var a=i[i.length-1];o.emit("create",{graphic:o.createGraphic,state:"active",tool:e,toolEventInfo:{coordinates:a,type:r},type:"create"})}})),a.on("draw-complete",(function(t){var r=t.vertices.slice(0),i=null;"polyline"===e?i=O.createPolyline([r],o.view.spatialReference,o._doUnnormalization):"polygon"===e&&(i=O.createPolygon([r],o.view.spatialReference,o._doUnnormalization,!0)),i&&(o.createGraphic.geometry=i),v&&v.complete()})),a.on("undo",(function(t){var r=t.vertices,i=s&&"cursor-update"!==s.type;o._resetCreateOperationGraphics(),o._snap(e,r,c),r.length&&o._drawVertexGraphics(e,r,{userClicked:i})})),a.on("redo",(function(t){var r=t.vertices,i=s&&"cursor-update"!==s.type;o._resetCreateOperationGraphics(),o._snap(e,r,c),r.length&&o._drawVertexGraphics(e,r,{userClicked:i})}))],h=[this.view.on("pointer-move",(function(e){o.view.toMap(f.createScreenPoint(e.x,e.y))?o._displayCrosshairCursor():o._displayDefaultCursor()}),L.ViewEventPriorities.WIDGET),this.view.on("key-down",(function(t){var r=a.vertices.slice(0),i=s&&"cursor-update"!==s.type;t.key===U.constraintKey?"2d"===o.view.type&&(c||(c=!0,o._snap(e,r,!i),o._drawVertexGraphics(e,r,{userClicked:i}))):t.key===U.undoKey&&v&&v.canUndo()?(t.stopPropagation(),v.undo()):t.key===U.redoKey&&v&&v.canRedo()?(t.stopPropagation(),v.redo()):t.key===U.cancelKey&&v&&v.cancel()}),L.ViewEventPriorities.WIDGET),this.view.on("key-up",(function(t){var r=a.vertices.slice(0),i=s&&"cursor-update"!==s.type;t.key===U.constraintKey&&c&&(i||(r.pop(),r.push([n.x,n.y]),o._drawVertexGraphics(e,r,{userClicked:i})),c=!1)}),L.ViewEventPriorities.WIDGET)];if("polygon"===e){var d=function(e,t,r){if(!e||!e.layer||!e.visible)return!1;var i=o.view.toScreen(e.geometry);return o._isWithinScreenDistance(i,t,r)},u=!1;h.push(this.view.on("pointer-move",(function(){u=!1}),L.ViewEventPriorities.WIDGET),this.view.on("pointer-down",(function(e){if(function(e){if(!(o._vertexGraphics.length<=2))return d(o._vertexGraphics[0],e,o._getVertexIntersectDistance())}(e))return u=!0,void e.stopPropagation();o._vertexGraphics.some((function(t){return d(t,e,o._getVertexIntersectDistance())}))&&e.stopPropagation()}),L.ViewEventPriorities.WIDGET),this.view.on("pointer-up",(function(e){u&&(e.stopPropagation(),a.complete())})))}var v=this._operationHandleForCreateAction(a,l.concat(h),e);return v},u.prototype._setupCreateCircleOperation=function(e,t){var o=this,i=r({},t,{elevationInfo:this.layer.elevationInfo,interactiveUndoDisabled:!0}),a=this._draw.create(e,i),n=!1,p=!0;a.snapToScene=this._getDefaultSnapToScene(i.elevationInfo);var c=[a.on("vertex-add",(function(t){var r=t.type,i=t.vertexIndex,s=t.vertices,c=s[i];o._drawSegmentGraphic(e,s,{centered:p,constrained:n},a.viewAlignedCoordinateSystem),o.emit("create",{graphic:o.createGraphic,state:1===s.length?"start":"active",tool:e,toolEventInfo:{added:c,vertices:[{coordinates:c,componentIndex:0,vertexIndex:i}],type:r},type:"create"})})),a.on("cursor-update",(function(t){var r=t.type,i=t.vertices;if(o._drawSegmentGraphic(e,i,{centered:p,constrained:n},a.viewAlignedCoordinateSystem),2===i.length){var s=i[i.length-1];o.emit("create",{graphic:o.createGraphic,state:"active",tool:e,toolEventInfo:{coordinates:s,type:r},type:"create"})}})),a.on("draw-complete",(function(e){var t=e.vertices.slice(0),r=null;1===t.length?(t.push(a.viewAlignedCoordinateSystem.makeMapPoint(t[0][0]+o._defaultSegmentOffset*o.view.resolution,t[0][1])),r=O.createCircle(t,a.viewAlignedCoordinateSystem,!0)):r=n?O.createEllipse(t,a.viewAlignedCoordinateSystem,p):O.createCircle(t,a.viewAlignedCoordinateSystem,p),o.createGraphic?o.createGraphic.geometry=r:(o._removeCreateGraphic(),o._set("createGraphic",new s(r,o.polygonSymbol))),h&&h.complete()}))],l=[this.view.on("pointer-move",(function(e){m.isSome(a.getCoordsFromScreenPoint(f.createScreenPoint(e.x,e.y)))?o._displayCrosshairCursor():o._displayDefaultCursor()}),L.ViewEventPriorities.WIDGET),this.view.on("key-down",(function(t){t.key===U.constraintKey?n||(n=!0,o._drawSegmentGraphic(e,a.vertices,{centered:p,constrained:n},a.viewAlignedCoordinateSystem)):t.key===U.centerKey?p&&(p=!1,o._drawSegmentGraphic(e,a.vertices,{centered:p,constrained:n},a.viewAlignedCoordinateSystem)):t.key===U.cancelKey&&h&&h.cancel()}),L.ViewEventPriorities.WIDGET),this.view.on("key-up",(function(t){t.key===U.constraintKey?(n=!1,o._drawSegmentGraphic(e,a.vertices,{centered:p,constrained:n},a.viewAlignedCoordinateSystem)):t.key===U.centerKey&&(p=!0,o._drawSegmentGraphic(e,a.vertices,{centered:p,constrained:n},a.viewAlignedCoordinateSystem))}),L.ViewEventPriorities.WIDGET)],h=this._operationHandleForCreateAction(a,c.concat(l),e);return h},u.prototype._setupCreateRectangleOperation=function(e,t){var o=this,i=r({},t,{elevationInfo:this.layer.elevationInfo,interactiveUndoDisabled:!0}),a=this._draw.create(e,i),n=!1,p=!1;a.snapToScene=this._getDefaultSnapToScene(i.elevationInfo);var c=[a.on("vertex-add",(function(t){var r=t.type,i=t.vertexIndex,s=t.vertices,c=s[i];o._drawSegmentGraphic(e,s,{centered:p,constrained:n},a.viewAlignedCoordinateSystem),o.emit("create",{graphic:o.createGraphic,state:1===s.length?"start":"active",tool:e,toolEventInfo:{added:c,vertices:[{coordinates:c,componentIndex:0,vertexIndex:i}],type:r},type:"create"})})),a.on("cursor-update",(function(t){var r=t.type,i=t.vertices;if(o._drawSegmentGraphic(e,i,{centered:p,constrained:n},a.viewAlignedCoordinateSystem),2===i.length){var s=i[i.length-1];o.emit("create",{graphic:o.createGraphic,state:"active",tool:e,toolEventInfo:{coordinates:s,type:r},type:"create"})}})),a.on("draw-complete",(function(e){var t,r=e.vertices.slice(0);1===r.length&&(n=!1,p=!1),t=n?O.createSquare(r,a.viewAlignedCoordinateSystem,p):O.createRectangle(r,a.viewAlignedCoordinateSystem,p),o.createGraphic?o.createGraphic.geometry=t:(o._removeCreateGraphic(),o._set("createGraphic",new s(t,o.polygonSymbol))),h&&h.complete()}))],l=[this.view.on("pointer-move",(function(e){m.isSome(a.getCoordsFromScreenPoint(f.createScreenPoint(e.x,e.y)))?o._displayCrosshairCursor():o._displayDefaultCursor()}),L.ViewEventPriorities.WIDGET),this.view.on("key-down",(function(t){t.key===U.constraintKey?n||(n=!0,o._drawSegmentGraphic(e,a.vertices,{centered:p,constrained:n},a.viewAlignedCoordinateSystem)):t.key===U.centerKey?p||(p=!0,o._drawSegmentGraphic(e,a.vertices,{centered:p,constrained:n},a.viewAlignedCoordinateSystem)):t.key===U.cancelKey&&h&&h.cancel()}),L.ViewEventPriorities.WIDGET),this.view.on("key-up",(function(t){t.key===U.constraintKey?(n=!1,o._drawSegmentGraphic(e,a.vertices,{centered:p,constrained:n},a.viewAlignedCoordinateSystem)):t.key===U.centerKey&&(p=!1,o._drawSegmentGraphic(e,a.vertices,{centered:p,constrained:n},a.viewAlignedCoordinateSystem))}),L.ViewEventPriorities.WIDGET)],h=this._operationHandleForCreateAction(a,c.concat(l),e);return h},u.prototype._setupUpdateOperation=function(e,t){return n(this,void 0,void 0,(function(){var o,i,n,p,s,c,l,h,d,u,v,y;return a(this,(function(a){for(i=(o=this)._defaultUpdateTool,n=o.defaultUpdateOptions,p=o.layer,s=o.view,c=r({},n,t),l=c.tool||i,h=0,d=e;h<d.length;h++)v=d[h],p.remove(v),p.add(v);if("3d"===s.type){if(0===e.length)return[2,null];switch(l){case"move":return[2,this._setupMove3DOperation(e,c,s,l)];case"reshape":return e.length>1?(this._logError("sketch:reshape-multiple","Reshape operation does not support multiple graphics."),[2,null]):0===(u=A.isSupportedGraphic(e[0]))?[2,this._setupReshape3DOperation(e[0],c,s)]:(this._logError("sketch:reshape","Reshape operation not supported for provided graphic(s) ("+C.isSupportedGraphicResultMessage(u)+")."),[2,null]);case"transform":return 1===e.length&&0===P.isSupportedGraphic(e[0])?[2,this._setupPointTransform3DOperation(e[0],c,s)]:[2,this._setupMove3DOperation(e,c,s,l)]}return[2,null]}if("move"===l)return[2,this._setupMoveOperation(e,c,s)];if(e.length>1)return"reshape"===l?(this._logError("sketch:reshape-multiple","Reshape operation does not support multiple graphics."),[2,null]):[2,this._setupTransformOrReshapeOperation(e,l,c,s)];if(1===e.length){if(v=e[0],"point"===(y=m.get(v.geometry,"type"))||"multipoint"===y)return[2,this._setupMoveOperation(e,c,s)];if("transform"===l||"reshape"===l)return[2,this._setupTransformOrReshapeOperation(e,l,c,s)]}return[2,null]}))}))},u.prototype._setupMove3DOperation=function(t,r,o,i,p){return void 0===p&&(p=!1),n(this,void 0,void 0,(function(){var s,c,l,h,d,u,v,y,m=this;return a(this,(function(f){switch(f.label){case 0:for(s=0,c=t;s<c.length;s++)if(l=c[s],0!==(h=I.isSupportedGraphic(l)))return this._logError("sketch:move","Move operation not supported for provided graphic(s) ("+C.isSupportedGraphicResultMessage(h)+")."),[2,null];return[4,this._requireModule(new Promise((function(t,r){e(["../../views/3d/interactive/editingTools"],t,r)})))];case 1:return W(d=f.sent())?[2,d]:(u=new d.module.GraphicMove3DTool({view:o,enableZ:r.enableZ}),this.view.tools.add(u),u.graphics.addMany(t),p||this.updateGraphics.addMany(t),v=[],y=new D.OperationHandle({activeComponent:u,tool:i,type:"update",onEnd:function(){v.forEach((function(e){return e.remove()})),v.length=0,m.view.tools.remove(u),u.destroyed||u.destroy()},undo:function(){R(y,m.updateGraphics.toArray()),m._emitUndoEvent({graphics:m.updateGraphics.toArray(),tool:i})},redo:function(){V(y,m.updateGraphics.toArray()),m._emitRedoEvent({graphics:m.updateGraphics.toArray(),tool:i})},addToSelection:function(e){m.updateGraphics.push(e),u.graphics.push(e),m.emit("update",{graphics:m.updateGraphics.toArray(),state:"active",aborted:!1,tool:m.activeTool,toolEventInfo:{added:[e],type:"selection-change"},type:"update"})},removeFromSelection:function(e){var t=m.updateGraphics.indexOf(e);y.history.undo.forEach((function(e){return e.updates.splice(t,1)})),y.history.redo.forEach((function(e){return e.updates.splice(t,1)})),m.updateGraphics.remove(e),0!==m.updateGraphics.length?u.graphics.remove(e):y.complete()},toggleTool:function(){return n(m,void 0,void 0,(function(){var e,t;return a(this,(function(a){switch(a.label){case 0:return 1!==this.updateGraphics.length||!1===r.toggleToolOnClick?[2]:"transform"!==i?[2]:(e=this.updateGraphics.getItemAt(0),0!==A.isSupportedGraphic(e)?[2]:[4,this._setupReshape3DOperation(e,r,o,!0)]);case 1:return W(t=a.sent())?[2]:(y.onEnd(),y.destroy(),this._setUpdateOperationHandle(t),[2])}}))}))}}),v.push.apply(v,this._getHandlesForComponent(y,r).concat([this.view.on("immediate-click",(function(e){return m._getCommonUpdateOperationClickHandlers(y,e)}),L.ViewEventPriorities.WIDGET),this.view.on("key-down",(function(e){return m._getCommonUpdateOperationKeyDownHandlers(y,e)}),L.ViewEventPriorities.WIDGET)])),[2,y])}}))}))},u.prototype._setupPointTransform3DOperation=function(t,r,o){return n(this,void 0,void 0,(function(){var i,p,s,c,l,h,d,u,v=this;return a(this,(function(y){switch(y.label){case 0:return i="transform",p=r.enableRotation,s=r.enableScaling,c=r.enableZ,[4,this._requireModule(new Promise((function(t,r){e(["../../views/3d/interactive/editingTools"],t,r)})))];case 1:return W(l=y.sent())?[2,l]:(h=new l.module.GraphicTransform3DTool({graphic:t,view:o,enableRotation:p,enableScaling:s,enableZ:c,snapToScene:this.snapToScene}),this.view.tools.add(h),this.updateGraphics.add(t),d=[],u=new D.OperationHandle({activeComponent:h,tool:i,type:"update",onEnd:function(){d.forEach((function(e){return e.remove()})),d.length=0,v.view.tools.remove(h),h.destroyed||h.destroy()},undo:function(){R(u,v.updateGraphics.toArray()),v._emitUndoEvent({graphics:v.updateGraphics.toArray(),tool:i})},redo:function(){V(u,v.updateGraphics.toArray()),v._emitRedoEvent({graphics:v.updateGraphics.toArray(),tool:i})},addToSelection:function(e){return n(v,void 0,void 0,(function(){var t;return a(this,(function(i){switch(i.label){case 0:return this.updateGraphics.add(e),[4,this._setupMove3DOperation(this.updateGraphics.toArray(),r,o,"transform",!0)];case 1:return W(t=i.sent())?[2]:(u.onEnd(),u.destroy(),this._setUpdateOperationHandle(t),[2])}}))}))},setSnapToScene:function(e){h.snapToScene=e}}),d.push.apply(d,this._getHandlesForComponent(u,r).concat([this.view.on("immediate-click",(function(e){return v._getCommonUpdateOperationClickHandlers(u,e)}),L.ViewEventPriorities.WIDGET),this.view.on("key-down",(function(e){return v._getCommonUpdateOperationKeyDownHandlers(u,e)}),L.ViewEventPriorities.WIDGET)])),[2,u])}}))}))},u.prototype._setupMoveOperation=function(e,t,r){return n(this,void 0,void 0,(function(){var o,i,n,p,c,l,h=this;return a(this,(function(a){switch(a.label){case 0:return o=[],i="move",e.forEach((function(e){o.push(new s(e.geometry,e.symbol,e.attributes)),e.symbol=h._getUpdateSymbol(e.geometry)})),this.updateGraphics.addMany(e),[4,this._getGraphicMover(e,t,r)];case 1:return W(n=a.sent())?[2,n]:(p=new D.OperationHandle({activeComponent:n,tool:i,type:"update",onEnd:function(){l.forEach((function(e){return e.remove()})),c.forEach((function(e){return e.remove()})),l=[],c=[],n.destroy(),h._internalGraphicsLayer&&h._internalGraphicsLayer.removeMany(h.updateGraphics.toArray()),h.updateGraphics.forEach((function(e,t){e.symbol=o[t].symbol}))},undo:function(){R(p,h.updateGraphics.toArray()),h._emitUndoEvent({graphics:h.updateGraphics.toArray(),tool:i})},redo:function(){V(p,h.updateGraphics.toArray()),h._emitRedoEvent({graphics:h.updateGraphics.toArray(),tool:i})},addToSelection:function(e){o.push(new s(e.geometry,e.symbol,e.attributes)),e.symbol=h._getUpdateSymbol(e.geometry),h.updateGraphics.push(e),n.graphics=h.updateGraphics.toArray(),h.emit("update",{graphics:h.updateGraphics.toArray(),state:"active",aborted:!1,tool:h.activeTool,toolEventInfo:{added:[e],type:"selection-change"},type:"update"})},removeFromSelection:function(e){var t=h.updateGraphics.indexOf(e);p.history.undo.forEach((function(e){return e.updates.splice(t,1)})),p.history.redo.forEach((function(e){return e.updates.splice(t,1)}));var r=o.splice(t,1)[0];e.symbol=r.symbol,h.updateGraphics.remove(e),0!==h.updateGraphics.length?n.graphics=h.updateGraphics.toArray():p.complete()}}),c=[r.on("immediate-click",(function(e){return h._getCommonUpdateOperationClickHandlers(p,e,t)}),L.ViewEventPriorities.WIDGET),r.on("key-down",(function(e){h._getCommonUpdateOperationKeyDownHandlers(p,e),e.key!==U.constraintKey||e.repeat||(n.enableMoveAllGraphics=!n.enableMoveAllGraphics)}),L.ViewEventPriorities.WIDGET),r.on("key-up",(function(e){e.key===U.constraintKey&&(n.enableMoveAllGraphics=!n.enableMoveAllGraphics)}),L.ViewEventPriorities.WIDGET)],l=this._getHandlesForComponent(p,t),[2,p])}}))}))},u.prototype._setupReshape3DOperation=function(t,r,o,i){return void 0===i&&(i=!1),n(this,void 0,void 0,(function(){var p,s,c,l,h,d=this;return a(this,(function(u){switch(u.label){case 0:return p="reshape",[4,this._requireModule(new Promise((function(t,r){e(["../../views/3d/interactive/editingTools"],t,r)})))];case 1:return W(s=u.sent())?[2,s]:(c=new s.module.GraphicReshape3DTool({view:o,graphic:t,enableZ:r.enableZ}),o.tools.add(c),i||this.updateGraphics.add(t),l=[],h=new D.OperationHandle({activeComponent:c,tool:p,type:"update",onEnd:function(){l.forEach((function(e){return e.remove()})),l.length=0,o.tools.remove(c),c.destroyed||c.destroy()},undo:function(){R(h,d.updateGraphics.toArray()),d._emitUndoEvent({graphics:d.updateGraphics.toArray(),tool:p})},redo:function(){V(h,d.updateGraphics.toArray()),d._emitRedoEvent({graphics:d.updateGraphics.toArray(),tool:p})},addToSelection:function(e){return n(d,void 0,void 0,(function(){var t;return a(this,(function(i){switch(i.label){case 0:return this.updateGraphics.add(e),[4,this._setupMove3DOperation(this.updateGraphics.toArray(),r,o,"transform",!0)];case 1:return W(t=i.sent())?[2]:(h.onEnd(),h.destroy(),this._setUpdateOperationHandle(t),[2])}}))}))},toggleTool:function(){return n(d,void 0,void 0,(function(){var e;return a(this,(function(t){switch(t.label){case 0:return!1===r.toggleToolOnClick?[2]:[4,this._setupMove3DOperation(this.updateGraphics.toArray(),r,o,"transform",!0)];case 1:return W(e=t.sent())?[2]:(h.onEnd(),h.destroy(),this._setUpdateOperationHandle(e),[2])}}))}))}}),l.push.apply(l,this._getHandlesForComponent(h,r).concat([o.on("immediate-click",(function(e){return d._getCommonUpdateOperationClickHandlers(h,e)}),L.ViewEventPriorities.WIDGET),o.on("key-down",(function(e){return d._getCommonUpdateOperationKeyDownHandlers(h,e)}),L.ViewEventPriorities.WIDGET)])),[2,h])}}))}))},u.prototype._setupTransformOrReshapeOperation=function(e,t,r,o){return n(this,void 0,void 0,(function(){var i,p,c,l,h,d,u,v,y,g,_=this;return a(this,(function(G){switch(G.label){case 0:return i=r.multipleSelectionEnabled,p=void 0===i||i,c=r.toggleToolOnClick,l=void 0===c||c,h=[],e.forEach((function(e){h.push(new s(e.geometry,e.symbol,e.attributes)),e.symbol=_._getUpdateSymbol(e.geometry)})),this.updateGraphics.addMany(e),"transform"!==t?[3,2]:[4,this._getBox(e,r,o)];case 1:return u=G.sent(),[3,4];case 2:return[4,this._getReshape(e,r,o)];case 3:u=G.sent(),G.label=4;case 4:return W(d=u)?[2,d]:(v=new D.OperationHandle({activeComponent:d,type:"update",onEnd:function(){g.forEach((function(e){return e.remove()})),y.forEach((function(e){return e.remove()})),g=[],y=[],v.activeComponent&&!v.activeComponent.destroyed&&v.activeComponent.destroy(),_._internalGraphicsLayer.removeMany(_.updateGraphics.toArray()),_.updateGraphics.forEach((function(e,t){h[t]&&h[t].symbol&&(e.symbol=h[t].symbol)}))},undo:function(){R(v,_.updateGraphics.toArray()),v.refreshComponent(),_._emitUndoEvent({graphics:_.updateGraphics.toArray(),tool:v.tool})},redo:function(){V(v,_.updateGraphics.toArray()),v.refreshComponent(),_._emitRedoEvent({graphics:_.updateGraphics.toArray(),tool:v.tool})},addToSelection:function(e){var t=v.activeComponent;h.push(new s(e.geometry,e.symbol,e.attributes)),e.symbol=_._getUpdateSymbol(e.geometry),_.updateGraphics.add(e),t.graphics=_.updateGraphics.toArray(),t.refresh(),v.resetHistory(),_.emit("update",{graphics:_.updateGraphics.toArray(),state:"active",aborted:!1,tool:_.activeTool,toolEventInfo:{added:[e],type:"selection-change"},type:"update"})},removeFromSelection:function(e){var t=v.activeComponent,r=_.updateGraphics.indexOf(e);v.history.undo.forEach((function(e){return e.updates.splice(r,1)})),v.history.redo.forEach((function(e){return e.updates.splice(r,1)}));var o=h.splice(r,1)[0];e.symbol=o.symbol,_.updateGraphics.remove(e),0!==_.updateGraphics.length?t.graphics=_.updateGraphics.toArray():v.complete()},toggleTool:function(){return n(_,void 0,void 0,(function(){var t;return a(this,(function(i){switch(i.label){case 0:return this.updateGraphics.length>1?[2]:(t=null,"transform"!==v.tool?[3,2]:[4,this._getReshape(e,r,o)]);case 1:return t=i.sent(),[3,4];case 2:return"reshape"!==v.tool?[3,4]:[4,this._getBox(e,r,o)];case 3:t=i.sent(),i.label=4;case 4:return W(t)?[2]:(v.activeComponent.destroy(),v.activeComponent=t,v.activeComponent&&(g.forEach((function(e){return e.remove()})),g=this._getHandlesForComponent(v,r)),[2])}}))}))}}),y=[o.on("immediate-click",(function(e){_._getFirstHit(f.createScreenPointFromEvent(e)).then((function(t){if(v){var r=t.results;if(r.length){var o=v.activeComponent,i=e.native&&e.native.shiftKey;r.some((function(e){if(e.graphic){var t=e.graphic;if(p&&i&&o&&"box"===o.type&&!o.isUIGraphic(t))return v.addToSelection(t),!0;if(o&&"box"===o.type&&o.isUIGraphic(t)){if(!1!==l&&1===_.updateGraphics.length){var r=_.updateGraphics.getItemAt(0).geometry;"extent"===m.get(r,"type")?_._logError("sketch:reshape-extent","Reshape operation does not support graphics with geometry of type 'extent'."):v.toggleTool()}return!0}if(o&&"reshape"===o.type){if(t===o.graphic)return!1!==l&&v.toggleTool(),!0;if(o.isUIGraphic(t))return!0;if(t.layer===_._internalGraphicsLayer)return!0}else t.layer===_.layer&&v.complete()}return!1}))&&e.stopPropagation()}else v.complete()}}))}),L.ViewEventPriorities.WIDGET),o.on("key-down",(function(e){if(_._getCommonUpdateOperationKeyDownHandlers(v,e),e.key===U.constraintKey&&!e.repeat&&v){var t=v.activeComponent;t&&"box"===t.type&&(t.preserveAspectRatio=!t.preserveAspectRatio)}}),L.ViewEventPriorities.WIDGET),o.on("key-up",(function(e){if(e.key===U.constraintKey&&v){var t=v.activeComponent;t&&"box"===t.type&&(t.preserveAspectRatio=!t.preserveAspectRatio)}}),L.ViewEventPriorities.WIDGET)],g=this._getHandlesForComponent(v,r),[2,v])}}))}))},u.prototype._getGraphicMover=function(t,r,o){return n(this,void 0,void 0,(function(){var i,n,p,s=this;return a(this,(function(a){switch(a.label){case 0:return i=r.enableMoveAllGraphics,n=void 0===i||i,[4,this._requireModule(new Promise((function(t,r){e(["../../views/draw/support/GraphicMover"],t,r)})))];case 1:return W(p=a.sent())?[2,p]:[2,new p.module({enableMoveAllGraphics:n,graphics:t,view:o,callbacks:{onGraphicMoveStart:function(e){var t=e.dx,r=e.dy,o=e.graphic;return s.emit("update",{graphics:s.updateGraphics.toArray(),state:"active",aborted:!1,tool:s.activeTool,toolEventInfo:{dx:t,dy:r,mover:o,type:"move-start"},type:"update"})},onGraphicMove:function(e){var t=e.dx,r=e.dy,o=e.graphic;return s.emit("update",{graphics:s.updateGraphics.toArray(),state:"active",aborted:!1,tool:s.activeTool,toolEventInfo:{dx:t,dy:r,mover:o,type:"move"},type:"update"})},onGraphicMoveStop:function(e){var t=e.dx,r=e.dy,o=e.graphic;return s.emit("update",{graphics:s.updateGraphics.toArray(),state:"active",aborted:!1,tool:s.activeTool,toolEventInfo:{dx:t,dy:r,mover:o,type:"move-stop"},type:"update"})},onGraphicPointerOver:function(){return s._displayDefaultCursor()},onGraphicPointerOut:function(){return s._displayDefaultCursor()}}})]}}))}))},u.prototype._getBox=function(t,o,i){return n(this,void 0,void 0,(function(){var n,p,s,c,l,h,d,u=this;return a(this,(function(a){switch(a.label){case 0:return n=o.enableRotation,p=void 0===n||n,s=o.enableScaling,c=void 0===s||s,l=o.preserveAspectRatio,h=void 0!==l&&l,[4,this._requireModule(new Promise((function(t,r){e(["../../views/draw/support/Box"],t,r)})))];case 1:return W(d=a.sent())?[2,d]:[2,new d.module({graphics:t,enableRotation:p,enableScaling:c,preserveAspectRatio:h,layer:this._internalGraphicsLayer,view:i,callbacks:{onMoveStart:function(e){return u.emit("update",{graphics:u.updateGraphics.toArray(),state:"active",aborted:!1,tool:u.activeTool,toolEventInfo:r({},e),type:"update"})},onMove:function(e){return u.emit("update",{graphics:u.updateGraphics.toArray(),state:"active",aborted:!1,tool:u.activeTool,toolEventInfo:r({},e),type:"update"})},onMoveStop:function(e){return u.emit("update",{graphics:u.updateGraphics.toArray(),state:"active",aborted:!1,tool:u.activeTool,toolEventInfo:r({},e),type:"update"})},onScaleStart:function(e){return u.emit("update",{graphics:u.updateGraphics.toArray(),state:"active",aborted:!1,tool:u.activeTool,toolEventInfo:r({},e),type:"update"})},onScale:function(e){return u.emit("update",{graphics:u.updateGraphics.toArray(),state:"active",aborted:!1,tool:u.activeTool,toolEventInfo:r({},e),type:"update"})},onScaleStop:function(e){return u.emit("update",{graphics:u.updateGraphics.toArray(),state:"active",aborted:!1,tool:u.activeTool,toolEventInfo:r({},e),type:"update"})},onRotateStart:function(e){return u.emit("update",{graphics:u.updateGraphics.toArray(),state:"active",aborted:!1,tool:u.activeTool,toolEventInfo:r({},e),type:"update"})},onRotate:function(e){return u.emit("update",{graphics:u.updateGraphics.toArray(),state:"active",aborted:!1,tool:u.activeTool,toolEventInfo:r({},e),type:"update"})},onRotateStop:function(e){return u.emit("update",{graphics:u.updateGraphics.toArray(),state:"active",aborted:!1,tool:u.activeTool,toolEventInfo:r({},e),type:"update"})}}})]}}))}))},u.prototype._getReshape=function(t,o,i){return n(this,void 0,void 0,(function(){var n,p,s,c=this;return a(this,(function(a){switch(a.label){case 0:return n=o.enableMidpoints,p=void 0===n||n,[4,this._requireModule(new Promise((function(t,r){e(["../../views/draw/support/Reshape"],t,r)})))];case 1:return W(s=a.sent())?[2,s]:[2,new s.module({enableMidpoints:p,graphic:t[0],layer:this._internalGraphicsLayer,view:i,callbacks:{onReshapeStart:function(e){return c.emit("update",{graphics:c.updateGraphics.toArray(),state:"active",aborted:!1,tool:c.activeTool,toolEventInfo:r({},e),type:"update"})},onReshape:function(e){return c.emit("update",{graphics:c.updateGraphics.toArray(),state:"active",aborted:!1,tool:c.activeTool,toolEventInfo:r({},e),type:"update"})},onReshapeStop:function(e){var t=e.mover,r=e.type;return c.emit("update",{graphics:c.updateGraphics.toArray(),state:"active",aborted:!1,tool:c.activeTool,toolEventInfo:{mover:t,type:r},type:"update"})},onMoveStart:function(e){var t=e.dx,r=e.dy,o=e.mover,i=e.type;return c.emit("update",{graphics:c.updateGraphics.toArray(),state:"active",aborted:!1,tool:c.activeTool,toolEventInfo:{dx:t,dy:r,mover:o,type:i},type:"update"})},onMove:function(e){var t=e.dx,r=e.dy,o=e.mover,i=e.type;return c.emit("update",{graphics:c.updateGraphics.toArray(),state:"active",aborted:!1,tool:c.activeTool,toolEventInfo:{dx:t,dy:r,mover:o,type:i},type:"update"})},onMoveStop:function(e){var t=e.dx,r=e.dy,o=e.mover,i=e.type;return c.emit("update",{graphics:c.updateGraphics.toArray(),state:"active",aborted:!1,tool:c.activeTool,toolEventInfo:{dx:t,dy:r,mover:o,type:i},type:"update"})},onVertexAdd:function(e){var t=e.added,r=e.type,o=e.vertices,i=t.map((function(e){return G.geometryToCoordinates(e.geometry)}));c.emit("update",{graphics:c.updateGraphics.toArray(),state:"active",aborted:!1,tool:c.activeTool,toolEventInfo:{added:i,vertices:o,type:r},type:"update"})},onVertexRemove:function(e){var t=e.removed,r=e.type,o=e.vertices,i=t.map((function(e){return G.geometryToCoordinates(e.geometry)}));c.emit("update",{graphics:c.updateGraphics.toArray(),state:"active",aborted:!1,tool:c.activeTool,toolEventInfo:{removed:i,vertices:o,type:r},type:"update"})}}})]}}))}))},u.prototype._getHandlesForComponent=function(e,t){var r=this,o=e.activeComponent;switch(o.type){case"graphic-mover":return[o.on("graphic-move-start",(function(t){return e.addToHistory(F(t.allGraphics))}))];case"box":return[o.on("move-start",(function(t){return e.addToHistory(F(t.graphics))})),o.on("rotate-start",(function(t){return e.addToHistory(F(t.graphics))})),o.on("scale-start",(function(t){return e.addToHistory(F(t.graphics))}))];case"reshape":return[o.on("move-start",(function(t){return e.addToHistory(F([t.mover]))})),o.on("reshape-start",(function(t){return e.addToHistory(F([t.graphic]))})),o.on("vertex-add",(function(t){return e.addToHistory(F([t.oldGraphic]))})),o.on("vertex-remove",(function(t){return e.addToHistory(F([t.oldGraphic]))}))];case"move-3d":return[o.on("graphic-move-start",(function(t){e.addToHistory(F(t.allGraphics)),r.emit("update",{graphics:r.updateGraphics.toArray(),state:"active",aborted:!1,tool:r.activeTool,toolEventInfo:{dx:0,dy:0,mover:t.allGraphics.length>0?t.allGraphics[0]:null,type:"move-start"},type:"update"})})),o.on("graphic-move",(function(e){r.emit("update",{graphics:r.updateGraphics.toArray(),state:"active",aborted:!1,tool:r.activeTool,toolEventInfo:{dx:e.dx,dy:e.dy,mover:e.allGraphics.length>0?e.allGraphics[0]:null,type:"move"},type:"update"})})),o.on("graphic-move-stop",(function(e){r.emit("update",{graphics:r.updateGraphics.toArray(),state:"active",aborted:!1,tool:r.activeTool,toolEventInfo:{dx:0,dy:0,mover:e.allGraphics.length>0?e.allGraphics[0]:null,type:"move-stop"},type:"update"})})),o.on("immediate-click",(function(o){o.shiftKey?r._toggleSelection([o.graphic],e,t):e.toggleTool()}))];case"transform-3d":return[o.on("graphic-translate-start",(function(t){e.addToHistory(F([t.graphic])),r.emit("update",{graphics:r.updateGraphics.toArray(),state:"active",aborted:!1,tool:r.activeTool,toolEventInfo:{mover:t.graphic,dx:t.dxScreen,dy:t.dyScreen,type:"move-start"},type:"update"})})),o.on("graphic-translate-stop",(function(e){r.emit("update",{graphics:r.updateGraphics.toArray(),state:"active",aborted:!1,tool:r.activeTool,toolEventInfo:{mover:e.graphic,dx:e.dxScreen,dy:e.dyScreen,type:"move-stop"},type:"update"})})),o.on("graphic-rotate-start",(function(t){e.addToHistory(K([t.graphic])),r.emit("update",{graphics:r.updateGraphics.toArray(),state:"active",aborted:!1,tool:r.activeTool,toolEventInfo:{mover:t.graphic,angle:t.angle,type:"rotate-start"},type:"update"})})),o.on("graphic-rotate-stop",(function(e){r.emit("update",{graphics:r.updateGraphics.toArray(),state:"active",aborted:!1,tool:r.activeTool,toolEventInfo:{mover:e.graphic,angle:e.angle,type:"rotate-stop"},type:"update"})})),o.on("graphic-scale-start",(function(t){e.addToHistory(K([t.graphic])),r.emit("update",{graphics:r.updateGraphics.toArray(),state:"active",aborted:!1,tool:r.activeTool,toolEventInfo:{mover:t.graphic,xScale:t.scale,yScale:t.scale,type:"scale-start"},type:"update"})})),o.on("graphic-scale-stop",(function(e){r.emit("update",{graphics:r.updateGraphics.toArray(),state:"active",aborted:!1,tool:r.activeTool,toolEventInfo:{mover:e.graphic,xScale:e.scale,yScale:e.scale,type:"scale-stop"},type:"update"})})),o.on("graphic-translate",(function(e){r.emit("update",{graphics:r.updateGraphics.toArray(),state:"active",aborted:!1,tool:r.activeTool,toolEventInfo:{mover:e.graphic,dx:e.dxScreen,dy:e.dyScreen,type:"move"},type:"update"})})),o.on("graphic-rotate",(function(e){r.emit("update",{graphics:r.updateGraphics.toArray(),state:"active",aborted:!1,tool:r.activeTool,toolEventInfo:{mover:e.graphic,angle:e.angle,type:"rotate"},type:"update"})})),o.on("graphic-scale",(function(e){r.emit("update",{graphics:r.updateGraphics.toArray(),state:"active",aborted:!1,tool:r.activeTool,toolEventInfo:{mover:e.graphic,xScale:e.scale,yScale:e.scale,type:"scale"},type:"update"})}))];case"reshape-3d":return[o.on("reshape",(function(t){"reshape-start"===t.type&&e.addToHistory(F([t.mover])),r.emit("update",{graphics:r.updateGraphics.toArray(),state:"active",aborted:!1,tool:r.activeTool,toolEventInfo:t,type:"update"})})),o.on("move",(function(t){"move-start"===t.type&&e.addToHistory(F([t.mover])),r.emit("update",{graphics:r.updateGraphics.toArray(),state:"active",aborted:!1,tool:r.activeTool,toolEventInfo:t,type:"update"})})),o.on("vertex-add",(function(e){r.emit("update",{graphics:r.updateGraphics.toArray(),state:"active",aborted:!1,tool:r.activeTool,toolEventInfo:e,type:"update"})})),o.on("vertex-remove",(function(e){r.emit("update",{graphics:r.updateGraphics.toArray(),state:"active",aborted:!1,tool:r.activeTool,toolEventInfo:e,type:"update"})})),o.on("immediate-click",(function(){return e.toggleTool()}))];case"draw":return null;default:return void h.neverReached(o)}},u.prototype._setUpdateOperationHandle=function(e){var t=this;this._operationHandle=e;var r=this.view,o=r.map,i=r.popup,a=!0;i&&(a=i.autoOpenEnabled,i.autoOpenEnabled=!1);e.on("complete",(function(){if(e===t._operationHandle){var r=t.updateGraphics.toArray(),n=t._operationHandle.tool;t._operationHandle.destroy(),t._operationHandle=null,t._internalGraphicsLayer.removeMany(t.updateGraphics.toArray()),t.updateGraphics.removeAll(),o&&o.remove(t._internalGraphicsLayer),i&&(i.autoOpenEnabled=a),t.emit("update",{graphics:r,state:"complete",aborted:e.cancelled,tool:n,toolEventInfo:null,type:"update"})}}))},u.prototype._getCommonUpdateOperationClickHandlers=function(e,t,r){var o=this,i=f.createScreenPointFromEvent(t);this._getFirstHit(i).then((function(i){var a=i.results;a.length?t.native.shiftKey&&o._toggleSelection(a.map((function(e){return e.graphic})),e,r)?t.stopPropagation():a.some((function(e){return e.graphic&&o.updateGraphics.indexOf(e.graphic)>-1}))?t.stopPropagation():e.complete():e.complete()}))},u.prototype._toggleSelection=function(e,t,r){var o=this,i=!r||!!r.multipleSelectionEnabled;return e.some((function(e){return null!=e&&(!(!i||e.layer!==o.layer)&&(-1===o.updateGraphics.indexOf(e)?t.addToSelection(e):t.removeFromSelection(e),!0))}))},u.prototype._getCommonUpdateOperationKeyDownHandlers=function(e,t){if(e){var r=t.key;r===U.undoKey&&e.canUndo()?(t.stopPropagation(),e.undo()):r===U.redoKey&&e.canRedo()?(t.stopPropagation(),e.redo()):r===U.cancelKey?(t.stopPropagation(),e.cancel()):U.deleteKeys.indexOf(r)>=0&&this._onDeleteKey(t)}},u.prototype._onDeleteKey=function(e){if(this._operationHandle&&"update"===this._operationHandle.type){var t=this.activeComponent;if(t&&"reshape"!==t.type&&"reshape-3d"!==t.type){e.stopPropagation();var r=this.updateGraphics.toArray();this.layer.removeMany(r),this._emitDeleteEvent({graphics:r,tool:this.activeTool})}}},u.prototype._getCreateSymbol=function(e,t){void 0===t&&(t=!1);var r="3d"!==this.view.type&&t;switch(e.type){case"point":case"multipoint":return r?this.activePointSymbol:this.pointSymbol;case"polyline":return r?this.activeLineSymbol:this.polylineSymbol;case"polygon":return r?this.activeFillSymbol:this.polygonSymbol}return null},u.prototype._getUpdateSymbol=function(e){if(m.isNone(e))return null;switch(e.type){case"point":case"multipoint":return this.updatePointSymbol;case"polyline":return this.updatePolylineSymbol;case"polygon":case"extent":return this.updatePolygonSymbol}return null},u.prototype._drawMultipointGraphic=function(e,t){var r=null;if(!t&&e.length>1){var o=e.slice(0);o.pop(),r=O.createMultipoint(o,this.view.spatialReference)}else r=O.createMultipoint(e,this.view.spatialReference);this.createGraphic?this.createGraphic.geometry=r:this._set("createGraphic",new s(r,this.pointSymbol)),t&&1===e.length&&this._internalGraphicsLayer.add(this.createGraphic)},u.prototype._drawVertexGraphics=function(e,t,r){var o=!(!r||!r.userClicked),i="polygon"===e,a=i?this.polygonSymbol:this.polylineSymbol;if(1===t.length){this._removeLineGraphic(),this._removeActiveLineGraphic();var n=this.createPointFromVertex(t[0]),p=i?O.createPolygon([t],this.view.spatialReference,this._doUnnormalization,!0):O.createPolyline([t],this.view.spatialReference,this._doUnnormalization);this._vertexGraphics.length?this._vertexGraphics[0].geometry=n:this._vertexGraphics.push(new s(n,this.activeVertexSymbol)),this.createGraphic?this.createGraphic.geometry=p:this._set("createGraphic",new s(p,a)),o&&this._internalGraphicsLayer.add(this._vertexGraphics[0])}else if(2===t.length){var c=this.createPointFromVertex(t[1]),l=this.vertexSymbol,h=O.createPolyline([t],this.view.spatialReference,this._doUnnormalization);p=i?O.createPolygon([t],this.view.spatialReference,this._doUnnormalization,!0):O.createPolyline([t],this.view.spatialReference,this._doUnnormalization);if(!this._vertexGraphics.length){n=this.createPointFromVertex(t[0]);var d=new s(n,l);this._vertexGraphics.push(d)}if(1===this._vertexGraphics.length){var u=this._vertexGraphics[0],v=new s(c,l);this._removeLineGraphic(),this._removeActiveFillGraphic(),this._vertexGraphics.push(v),this._internalGraphicsLayer.remove(u),this._internalGraphicsLayer.add(u)}else this._vertexGraphics[1].geometry=c;this._showActiveLineGraphic(h);var y=this._vertexGraphics[0];o&&(this._activeLineGraphic.symbol=this.polylineSymbol,y.symbol=this.vertexSymbol,this._internalGraphicsLayer.add(this._vertexGraphics[1])),this.createGraphic?this.createGraphic.geometry=p:this._set("createGraphic",new s(p,this.polygonSymbol)),this._internalGraphicsLayer.remove(y),this._internalGraphicsLayer.add(y)}else if(t.length>2){p=i?O.createPolygon([t],this.view.spatialReference,this._doUnnormalization,!0):O.createPolyline([t],this.view.spatialReference,this._doUnnormalization);"polygon"===e&&this._showFillGraphic(p);var m=t.map((function(e){return e.slice()})),f=m.pop(),g=[m[m.length-1],f],_=O.createPolyline([m],this.view.spatialReference,this._doUnnormalization),G=O.createPolyline([g],this.view.spatialReference,this._doUnnormalization);this._showLineGraphic(_),this._showActiveLineGraphic(G);for(var w=0;w<m.length;w++){var b=this._vertexGraphics[w];if(b)o||w!==this._vertexGraphics.length-1?b.symbol=this.vertexSymbol:b.symbol=this.activeVertexSymbol;else{var S=this.createPointFromVertex(t[w]);this._showVertexGraphic(S)}}if(o){this._activeLineGraphic.symbol=this.polylineSymbol;w=t.length-1,S=this.createPointFromVertex(t[w]);this._showVertexGraphic(S)}else this._activeLineGraphic.symbol=this.activeLineSymbol;this.createGraphic?this.createGraphic.geometry=p:(this._removeCreateGraphic(),this._set("createGraphic",new s(p,a)));for(var E=0,x=this._vertexGraphics;E<x.length;E++){d=x[E];this._internalGraphicsLayer.remove(d),this._internalGraphicsLayer.add(d)}}},u.prototype._drawSegmentGraphic=function(e,t,r,o){if(t.length){var i=!(!r||!r.centered),a=!(!r||!r.constrained),n=null;1===t.length?this._removeCenterIndicatorGraphic():("rectangle"===e?n=a?O.createSquare(t,o,i):O.createRectangle(t,o,i):"circle"===e&&(n=a?O.createEllipse(t,o,i):O.createCircle(t,o,i)),n.extent&&n.extent.center&&this._showCenterIndicatorGraphic(n.extent.center)),n?this.createGraphic?this.createGraphic.geometry=n:(this._removeCreateGraphic(),this._set("createGraphic",new s(n,this.polygonSymbol)),this._internalGraphicsLayer.add(this.createGraphic)):this._removeCreateGraphic()}},u.prototype._showCenterIndicatorGraphic=function(e){this._centerIndicatorGraphic?this._centerIndicatorGraphic.geometry=e:(this._centerIndicatorGraphic=new s(e,this._centerSymbol),this._internalGraphicsLayer.add(this._centerIndicatorGraphic))},u.prototype._removeCenterIndicatorGraphic=function(){this._centerIndicatorGraphic&&(this._internalGraphicsLayer.remove(this._centerIndicatorGraphic),this._centerIndicatorGraphic.destroy(),this._centerIndicatorGraphic=null)},u.prototype._showActiveLineGraphic=function(e){this._activeLineGraphic?this._activeLineGraphic.geometry=e:(this._activeLineGraphic=new s(e,this.activeLineSymbol),this._internalGraphicsLayer.graphics.add(this._activeLineGraphic,0))},u.prototype._showFillGraphic=function(e){this._activeFillGraphic?this._activeFillGraphic.geometry=e:(this._activeFillGraphic=new s(e,this._getCreateSymbol(e,!0)),this._internalGraphicsLayer.add(this._activeFillGraphic))},u.prototype._showLineGraphic=function(e){this._lineGraphic?this._lineGraphic.geometry=e:(this._lineGraphic=new s(e,this.polylineSymbol),this._internalGraphicsLayer.graphics.add(this._lineGraphic,0))},u.prototype._showVertexGraphic=function(e,t){var r=t?this.activeVertexSymbol:this.vertexSymbol,o=new s(e,r);this._vertexGraphics.push(o),this._internalGraphicsLayer.add(o)},u.prototype._resetCreateOperationGraphics=function(){this._removeActiveFillGraphic(),this._removeLineGraphic(),this._removeActiveLineGraphic(),this._removeVertexGraphics()},u.prototype._removeCreateGraphic=function(){this.createGraphic&&(this._internalGraphicsLayer.remove(this.createGraphic),this._set("createGraphic",null))},u.prototype._removeCreateOperationGraphics=function(){this._removeCenterIndicatorGraphic(),this._removeActiveLineGraphic(),this._removeActiveFillGraphic(),this._removeLineGraphic(),this._removeVertexGraphics()},u.prototype._removeActiveLineGraphic=function(){this._activeLineGraphic&&(this._internalGraphicsLayer.remove(this._activeLineGraphic),this._activeLineGraphic.destroy(),this._activeLineGraphic=null)},u.prototype._removeActiveFillGraphic=function(){this._activeFillGraphic&&(this._internalGraphicsLayer.remove(this._activeFillGraphic),this._activeFillGraphic.destroy(),this._activeFillGraphic=null)},u.prototype._removeLineGraphic=function(){this._lineGraphic&&(this._internalGraphicsLayer.remove(this._lineGraphic),this._lineGraphic.destroy(),this._lineGraphic=null)},u.prototype._removeVertexGraphics=function(){this._vertexGraphics.length&&(this._internalGraphicsLayer.removeMany(this._vertexGraphics),this._vertexGraphics.forEach((function(e){return e.destroy()})),this._vertexGraphics=[])},u.prototype._removeDefaultLayer=function(){this._internalGraphicsLayer&&(this.view&&this.view.map&&this.view.map.remove(this._internalGraphicsLayer),this._internalGraphicsLayer.destroy(),this._internalGraphicsLayer=null)},u.prototype._operationHandleForCreateAction=function(e,t,r){var o=this;return new D.OperationHandle({activeComponent:this._draw,tool:r,type:"create",onEnd:function(){t.forEach((function(e){return e.remove()})),t.length=0,o._removeCreateOperationGraphics(),o._internalGraphicsLayer&&o._internalGraphicsLayer.remove(o.createGraphic),o._displayDefaultCursor()},undo:function(){e.undo(),o._emitUndoEvent({graphics:[o.createGraphic],tool:r})},redo:function(){e.redo(),o._emitRedoEvent({graphics:[o.createGraphic],tool:r})},canUndo:function(){return e&&e.canUndo()},canRedo:function(){return e&&e.canRedo()},setSnapToScene:function(t){e.snapToScene=t?function(e,t){return o._snapToScene3D(e,t)}:null}})},u.prototype._snap=function(e,t,r){r&&this._snapLastVertexToAxis(t),"polygon"===e&&this._snapLastPolygonVertexToFirst(t)},u.prototype._snapLastPolygonVertexToFirst=function(e){if(!(e.length<=2)){var t=e[0],r=e[e.length-1],o=this.view.toScreen(new p.Point(t[0],t[1],this.view.spatialReference)),i=this.view.toScreen(new p.Point(r[0],r[1],this.view.spatialReference));this._isWithinScreenDistance(o,i,this._getVertexIntersectDistance())&&(r[0]=t[0],r[1]=t[1])}},u.prototype._getVertexIntersectDistance=function(){return this.vertexSymbol&&"simple-marker"===this.vertexSymbol.type?f.pt2px(this.vertexSymbol.size)/2+3:3},u.prototype._isWithinScreenDistance=function(e,t,r){var o=e.x-t.x,i=e.y-t.y;return Math.sqrt(o*o+i*i)<=r},u.prototype._snapLastVertexToAxis=function(e){if(!(e.length<2)){var t=e.pop(),r=e[e.length-1],o=O.createViewAlignedCoordinateSystem(this.view,r),i=o.mapToLocal(r),a=o.mapToLocal(t),n=Math.abs(a.x-i.x),p=Math.abs(a.y-i.y),s=o.localToMap(O.makeSurfacePoint(n>p?a.x:i.x,n>p?i.y:a.y));e.push(s)}},u.prototype._displayCrosshairCursor=function(){this.view&&this.view.container&&"crosshair"!==this.view.cursor&&(this.view.cursor="crosshair")},u.prototype._displayDefaultCursor=function(){this.view&&this.view.container&&null!==this.view.cursor&&(this.view.cursor=null)},u.prototype._logError=function(e,t,r){M.error(new d(e,t,r))},u.prototype._requireModule=function(e){return n(this,void 0,void 0,(function(){var t,r;return a(this,(function(o){switch(o.label){case 0:return t=new AbortController,this._moduleLoaderAbortController=t,[4,e];case 1:return r=o.sent(),this._moduleLoaderAbortController!==t||t.signal.aborted?[2,{requireError:"aborted"}]:[2,{module:r}]}}))}))},u.prototype._emitUndoEvent=function(e){this.emit("undo",r({},e,{type:"undo"}))},u.prototype._emitRedoEvent=function(e){this.emit("redo",r({},e,{type:"redo"}))},u.prototype._emitDeleteEvent=function(e){this.emit("delete",r({},e,{type:"delete"}))},u.prototype.createPointFromVertex=function(e){return e.length>2?new p.Point(e[0],e[1],e[2],this.view.spatialReference):new p.Point(e[0],e[1],this.view.spatialReference)},i([_.property({dependsOn:["state"],readOnly:!0})],u.prototype,"_draw",null),i([_.property()],u.prototype,"_operationHandle",void 0),i([_.property({dependsOn:["_operationHandle","_operationHandle.tool"],readOnly:!0})],u.prototype,"activeTool",null),i([_.property()],u.prototype,"activeFillSymbol",void 0),i([_.property()],u.prototype,"activeLineSymbol",void 0),i([_.property()],u.prototype,"activePointSymbol",void 0),i([_.property()],u.prototype,"activeVertexSymbol",void 0),i([_.property({readOnly:!0})],u.prototype,"createGraphic",void 0),i([_.property()],u.prototype,"defaultCreateOptions",void 0),i([_.property()],u.prototype,"defaultUpdateOptions",void 0),i([_.property()],u.prototype,"layer",void 0),i([_.property({types:c.symbolTypes})],u.prototype,"pointSymbol",void 0),i([_.property({types:c.symbolTypes})],u.prototype,"polygonSymbol",void 0),i([_.property({types:c.symbolTypes})],u.prototype,"polylineSymbol",void 0),i([_.property({dependsOn:["view.ready","layer","_operationHandle"],readOnly:!0})],u.prototype,"state",null),i([_.property({readOnly:!0})],u.prototype,"updateGraphics",void 0),i([_.property()],u.prototype,"updateOnGraphicClick",void 0),i([_.property({types:c.symbolTypes})],u.prototype,"updatePointSymbol",void 0),i([_.property({types:c.symbolTypes})],u.prototype,"updatePolygonSymbol",void 0),i([_.property({types:c.symbolTypes})],u.prototype,"updatePolylineSymbol",void 0),i([_.property({types:c.symbolTypes})],u.prototype,"vertexSymbol",void 0),i([_.property({value:null})],u.prototype,"view",null),i([_.property()],u.prototype,"cancel",null),i([_.property()],u.prototype,"complete",null),i([_.property()],u.prototype,"delete",null),i([_.property()],u.prototype,"create",null),i([_.property()],u.prototype,"update",null),i([_.property()],u.prototype,"undo",null),i([_.property()],u.prototype,"redo",null),i([_.property()],u.prototype,"canUndo",null),i([_.property()],u.prototype,"canRedo",null),i([_.property()],u.prototype,"toggleUpdateTool",null),i([_.property({value:null})],u.prototype,"snapToScene",null),u=i([_.subclass("esri.widgets.Sketch.SketchViewModel")],u)}(_.declared(u.EventedAccessor)))}));