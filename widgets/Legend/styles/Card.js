// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","../../../core/tsSupport/assignHelper","dojo/i18n!../../../nls/common","dojo/i18n!../../Legend/nls/Legend","../../../intl","../../../core/Handles","../../../core/screenUtils","../../../core/accessorSupport/decorators","../../../symbols/support/svgUtils","../../Widget","./support/utils","../support/styleUtils","../../support/colorUtils","../../support/widget"],(function(e,t,s,r,i,a,n,o,l,c,d,h,p,y,g,u,_){var v="esri-legend--card__carousel-indicator--activated",m="esri-legend--card esri-widget",f="esri-legend--stacked",b="esri-legend--card__carousel-title",x="esri-legend--card__carousel-indicator",w="esri-legend--card__interval-separator",L="esri-legend--card__imagery-layer-image--stretched",I="esri-legend--card__image-label",S="esri-legend--card__layer-caption",k="esri-legend--card__label-element",N="esri-legend--card__layer-row",R="esri-legend--card__label-cell",T="esri-legend--card__message",z="esri-legend--card__ramp-label",F="esri-legend--card__section",E="esri-legend--card__relationship-section",O="esri-legend--card__service-caption-text",C="esri-legend--card__service-content",U="esri-legend--card__service",A="esri-legend--card__group-layer",M="esri-legend--card__group-layer-child",H="esri-legend--card__symbol",j="esri-legend--card__size-ramp-row",B="esri-legend--card__symbol-row",P="esri-legend--card__symbol-cell",W="esri-legend--card__carousel-indicator-container",Z="esri-legend--card__interval-separators-container",q="esri-legend--card__relationship-label-container",G="esri-legend--card__label-container",V="esri-legend--card__service-caption-container",D="esri-legend--card__symbol-container",J="esri-legend--card__size-ramp-container",K="esri-widget__heading",Q="esri-legend--card__",X=window.devicePixelRatio;return function(e){function t(t){var s=e.call(this,t)||this;return s._handles=new l,s._hasIndicators=!1,s._selectedSectionName=null,s._sectionNames=[],s._sectionMap=new Map,s.activeLayerInfos=null,s.layout="stack",s.type="card",s.view=null,s}return s(t,e),t.prototype.postInitialize=function(){var e=this;this.own([this.watch("activeLayerInfos",(function(t){e._handles.removeAll(),e._watchForSectionChanges(t)}))])},t.prototype.destroy=function(){this._handles.destroy(),this._handles=null},t.prototype.render=function(){var e,t=this;this._hasIndicators="auto"===this.layout&&this.view.container.clientWidth<=768||"stack"===this.layout;var s=this.activeLayerInfos,r=s&&s.toArray().map((function(e){return t._renderLegendForLayer(e)})).filter((function(e){return!!e}));this._hasIndicators?this._selectedSectionName&&-1!==this._sectionNames.indexOf(this._selectedSectionName)||(this._selectedSectionName=this._sectionNames&&this._sectionNames[0]):this._selectedSectionName=null;var i=this._sectionNames.length,l=this._sectionNames.map((function(e,s){var r,n=o.substitute(a.pagination.pageText,{index:s+1,total:i});return _.tsx("div",{key:e,"aria-label":n,title:n,tabIndex:0,onclick:t._selectSection,onkeydown:t._selectSection,bind:t,class:t.classes(x,(r={},r[v]=t._selectedSectionName===e,r)),"data-section-name":e})})),c=this._hasIndicators&&i>1?_.tsx("div",{class:W,key:"carousel-navigation"},l):null,d=this._hasIndicators?this._sectionMap.get(this._selectedSectionName):r&&r.length?r:null,h=((e={})[f]=this._hasIndicators,e);return _.tsx("div",{class:this.classes(m,h)},c,d||_.tsx("div",{class:T},n.noLegend))},t.prototype._selectSection=function(e){var t=e.target.getAttribute("data-section-name");t&&(this._selectedSectionName=t)},t.prototype._watchForSectionChanges=function(e){var t=this;if(this._generateSectionNames(),e){e.forEach((function(e){var s="activeLayerInfo-"+e.layer.uid+"-version-change";t._handles.remove(s),t._watchForSectionChanges(e.children),t._handles.add(e.watch("version",(function(){return t._generateSectionNames()})),s)}));var s="activeLayerInfos-collection-change";this._handles.remove(s),this._handles.add(e.on("change",(function(){return t._watchForSectionChanges(e)})),s)}},t.prototype._generateSectionNames=function(){this._sectionNames.length=0,this.activeLayerInfos&&this.activeLayerInfos.forEach(this._generateSectionNamesForActiveLayerInfo,this)},t.prototype._generateSectionNamesForActiveLayerInfo=function(e){var t=this;e.children.forEach(this._generateSectionNamesForActiveLayerInfo,this),e.legendElements&&e.legendElements.forEach((function(s,r){t._sectionNames.push(""+Q+e.layer.uid+"-type-"+s.type+"-"+r)}))},t.prototype._renderLegendForLayer=function(e){var t,s=this;if(!e.ready)return null;if(e.children.length){var r=e.children.map((function(e){return s._renderLegendForLayer(e)})).toArray();return _.tsx("div",{key:e.layer.uid,class:this.classes(U,A)},_.tsx("div",{class:V},e.title),r)}var i=e.legendElements;if(i&&!i.length)return null;var a=i.some((function(e){return"relationship-ramp"===e.type})),n=i.map((function(t,r){return s._renderLegendForElement(t,e,r,a)})).filter((function(e){return!!e}));if(!n.length)return null;var o=((t={})[M]=!!e.parent,t);return _.tsx("div",{key:e.layer.uid,class:this.classes(U,o)},_.tsx("div",{class:V},_.tsx("div",{class:O},e.title)),_.tsx("div",{class:C},n))},t.prototype._renderLegendForElement=function(e,t,s,r){var i,a=this;void 0===r&&(r=!1);var n="color-ramp"===e.type,o="opacity-ramp"===e.type,l="size-ramp"===e.type,c=t.layer,d=e.title,h=null;if("string"==typeof d)h=d;else if(d){var p=g.getTitle(d,n||o);h=d.title?d.title+" ("+p+")":p}var u=""+Q+c.uid+"-type-"+e.type+"-"+s,v=this._hasIndicators?_.tsx("div",null,_.tsx("h3",{class:this.classes(K,b)},t.title),_.tsx("h4",{class:this.classes(K,S)},h)):h?_.tsx("h4",{class:this.classes(K,S)},h):null,m=null;if("symbol-table"===e.type){var f=e.infos.map((function(s,r){return a._renderLegendForElementInfo(s,t,e.legendType,r)})).filter((function(e){return!!e}));if(f.length){var x=f[0].properties.classes&&f[0].properties.classes[B],w=((i={})[G]=!x&&!r,i[q]=r,i);m=_.tsx("div",{key:u,class:F},v,_.tsx("div",{class:this.classes(w)},f))}}else"color-ramp"===e.type||"opacity-ramp"===e.type||"heatmap-ramp"===e.type?m=_.tsx("div",{key:u,class:F},v,this._renderLegendForRamp(e,c.opacity)):l?m=_.tsx("div",{key:u,class:F},v,this._renderSizeRamps(e,c.opacity)):"relationship-ramp"===e.type&&(m=_.tsx("div",{key:u,class:this.classes(F,E)},v,y.renderRelationshipRamp(e,this.id,c.opacity)));return m?(this._sectionMap.set(u,m),m):null},t.prototype._renderLegendForElementInfo=function(e,t,s,r){var i,a,n,o=t.layer;if(e.type)return this._renderLegendForElement(e,t,r);var l=g.isImageryStretchedLegend(o,s);if(e.symbol&&e.preview){if(-1===e.symbol.type.indexOf("simple-fill")){if(!e.label)return _.tsx("div",{key:r,bind:e.preview,afterCreate:g.attachToNode});var c=((i={})[P]=this._hasIndicators,i);return _.tsx("div",{key:r,class:this.classes(N,(a={},a[B]=this._hasIndicators,a))},_.tsx("div",{class:this.classes(c),bind:e.preview,afterCreate:g.attachToNode}),_.tsx("div",{class:this.classes(I,(n={},n[R]=this._hasIndicators,n))},g.getTitle(e.label,!1)||""))}var d=255,h=255,p=255,y=0,v=255,m=255,f=255,b=0,x=e.symbol.color&&e.symbol.color.a,w=e.symbol.outline&&e.symbol.outline.color&&e.symbol.outline.color.a;x&&(d=e.symbol.color.r,h=e.symbol.color.g,p=e.symbol.color.b,y=e.symbol.color.a*o.opacity),w&&(v=e.symbol.outline.color.r,m=e.symbol.outline.color.g,f=e.symbol.outline.color.b,b=e.symbol.outline.color.a*o.opacity);var L=!e.symbol.color||u.isBright(e.symbol.color),S=L?"rgba(255, 255, 255, .6)":"rgba(0, 0, 0, .6)",T={background:x?"rgba("+d+", "+h+", "+p+", "+y+")":"none",color:L?"black":"white",textShadow:"-1px -1px 0 "+S+",\n                                              1px -1px 0 "+S+",\n                                              -1px 1px 0 "+S+",\n                                              1px 1px 0 "+S,border:w?"1px solid rgba("+v+", "+m+", "+f+", "+b+")":"none"};return _.tsx("div",{key:r,class:N},_.tsx("div",{class:k,styles:T}," ",e.label," "))}if(e.src){var z=this._renderImage(e,o,l);return _.tsx("div",{key:r,class:N},z,_.tsx("div",{class:I},e.label||""))}},t.prototype._renderImage=function(e,t,s){var r,i=e.label,a=e.src,n=e.opacity,o=((r={})[L]=s,r[H]=!s,r),l={opacity:""+(null!=n?n:t.opacity)};return _.tsx("img",{alt:g.getTitle(i,!1),src:a,border:0,width:e.width,height:e.height,class:this.classes(o),styles:l})},t.prototype._drawImageOnSizeRamp=function(e,t,s){var r=s.x,i=s.y,a=s.width,n=s.height,o=new Image;o.src=t,o.onload=function(){e.drawImage(o,r,i,a,n),URL.revokeObjectURL(t)}},t.prototype._attachSizeRampToNode=function(e){var t=e["data-layer-opacity"];null!=t&&(e.style.opacity=t.toString());var s,r,i=e["data-legend-element"].infos,a=i[0],n=i[i.length-1],o=a.symbol,l=n.symbol,d="picture-marker"===o.type,h=function(e){if(e){if(e.type.indexOf("3d")>-1){var t=e.symbolLayers&&e.symbolLayers.length;if(!t)return;var s=e.symbolLayers.getItemAt(t-1).get("resource.primitive");return"triangle"===s||"cone"===s||"tetrahedron"===s}return"triangle"===e.style}}(o),p=function(e){if(e){if(e.type.indexOf("3d")>-1){var t=e.symbolLayers&&e.symbolLayers.length;if(!t)return;var s=e.symbolLayers.getItemAt(t-1),r=s.resource&&s.resource.primitive;return"circle"===r||"cross"===r||"kite"===r||"sphere"===r||"cube"===r||"diamond"===r}var i=e.style;return"circle"===i||"diamond"===i||"cross"===i}}(o);if(d)s=o.url,r=l.url;else{if(a.preview){var y=new Blob([a.preview.innerHTML],{type:"image/svg+xml"});s=URL.createObjectURL(y)}if(n.preview){var g=new Blob([n.preview.innerHTML],{type:"image/svg+xml"});r=URL.createObjectURL(g)}}var u=c.pt2px(a.size+a.outlineSize)*X,_=c.pt2px(n.size+n.outlineSize)*X,v=this._hasIndicators?u:u+100*X,m=this._hasIndicators?v+50*X:u,f=document.createElement("canvas");f.width=v,f.height=m,f.style.width=f.width/X+"px",f.style.height=f.height/X+"px";var b=f.getContext("2d");if(this._hasIndicators){this._drawImageOnSizeRamp(b,s,{x:0,y:0,width:u,height:u}),this._drawImageOnSizeRamp(b,r,{x:v/2-_/2,y:m-_,width:_,height:_}),b.beginPath();var x=p?v/2:v,w=v/2-_/2,L=m-(h?0:p?_/2:_);b.moveTo(0,x),b.lineTo(w,L);var I=v,S=p?v/2:v,k=v/2+_/2,N=m-(h?0:p?_/2:_);b.moveTo(I,S),b.lineTo(k,N)}else{this._drawImageOnSizeRamp(b,s,{x:v-u,y:0,width:u,height:u}),this._drawImageOnSizeRamp(b,r,{x:0,y:m/2-_/2,width:_,height:_}),b.beginPath();var R=_-(p||h?_/2:0),T=m/2-_/2,z=v-(p||h?u/2:u);b.moveTo(R,T),b.lineTo(z,0);var F=_-(p?_/2:0),E=m/2+_/2,O=v-(p?u/2:u),C=m;b.moveTo(F,E),b.lineTo(O,C)}b.strokeStyle="#ddd",b.stroke(),e.appendChild(f)},t.prototype._renderSizeRamps=function(e,t){var s,r=e.infos,i=r[0].label,a=r[r.length-1].label;return _.tsx("div",{class:this.classes(N,(s={},s[j]=this._hasIndicators,s))},_.tsx("div",{class:z},this._hasIndicators?i:a),_.tsx("div",{class:J},_.tsx("div",{bind:this,"data-layer-opacity":t,"data-legend-element":e,afterCreate:this._attachSizeRampToNode})),_.tsx("div",{class:z},this._hasIndicators?a:i))},t.prototype._renderLegendForRamp=function(e,t){var s=e.infos,r="heatmap-ramp"===e.type,i=s.length-1,a=i>2&&!r?25*i:100,o=a+20,l=s.slice(0).reverse();l.forEach((function(e,t){e.offset=r?e.ratio:t/i}));var c=l.length-1,d=l.length%2!=0&&l[l.length/2|0],p=d&&_.tsx("div",{class:Z},_.tsx("div",{class:w},"|"),_.tsx("div",{class:z},d.label)),y=s[s.length-1].label,g=s[0].label,u=null;null!=t&&(u="opacity: "+t);var v=[[{shape:{type:"path",path:"M0 12.5 L10 0 L10 25 Z"},fill:l[0].color,stroke:{width:0}},{shape:{type:"rect",x:10,y:0,width:a,height:25},fill:{type:"linear",x1:10,y1:0,x2:a+10,y2:0,colors:l},stroke:{width:0}},{shape:{type:"path",path:"M"+(a+10)+" 0 L"+o+" 12.5 L"+(a+10)+" 25 Z"},fill:l[c].color,stroke:{width:0}}]],m=h.renderSVG(v,o,25);return _.tsx("div",{class:N},_.tsx("div",{class:z},r?n[y]:y),_.tsx("div",{class:D},_.tsx("div",{style:u},m),p),_.tsx("div",{class:z},r?n[g]:g))},r([_.renderable(),d.property()],t.prototype,"activeLayerInfos",void 0),r([d.property()],t.prototype,"layout",void 0),r([d.property({readOnly:!0})],t.prototype,"type",void 0),r([d.property()],t.prototype,"view",void 0),r([_.accessibleHandler()],t.prototype,"_selectSection",null),t=r([d.subclass("esri.widgets.Legend.styles.Card")],t)}(d.declared(p))}));