// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/assignHelper","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","../../../core/tsSupport/awaiterHelper","../../../core/tsSupport/generatorHelper","dojo/i18n!../../Legend/nls/Legend","../../../Color","../../../request","../../../symbols","../../../core/Accessor","../../../core/arrayUtils","../../../core/Collection","../../../core/Handles","../../../core/Logger","../../../core/maybe","../../../core/promiseUtils","../../../core/urlUtils","../../../core/watchUtils","../../../core/accessorSupport/decorators","../../../layers/support/ExportImageParameters","../../../layers/support/fieldUtils","../../../renderers/support/jsonUtils","../../../renderers/visualVariables/SizeVariable","../../../symbols/support/symbolUtils","../../../symbols/support/utils","../../../views/MapView","../../../views/2d/layers/support/clusterUtils","./colorRampUtils","./heatmapRampUtils","./relationshipRampUtils","./sizeRampUtils","./utils","@dojo/framework/shim/Promise"],(function(e,t,r,n,l,i,s,a,o,u,c,d,p,y,h,f,m,b,g,v,S,_,L,w,E,R,C,I,F,T,V,z,x,D){var M=f.getLogger("esri.widgets.Legend.support.ActiveLayerInfo"),P=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i,O=new c.SimpleMarkerSymbol({size:6,outline:{color:[128,128,128,.5],width:.5}}),A=new c.SimpleFillSymbol({style:"solid"});function U(e){return"raster-colormap"===e.type}function B(e){return"raster-stretch"===e.type}function k(e){return"esri.renderers.SimpleRenderer"===e.declaredClass}function N(e){return"esri.renderers.ClassBreaksRenderer"===e.declaredClass}function W(e){return"esri.renderers.UniqueValueRenderer"===e.declaredClass}function j(e){return"esri.renderers.HeatmapRenderer"===e.declaredClass}function H(e){return"esri.renderers.PointCloudClassBreaksRenderer"===e.declaredClass}function q(e){return"esri.renderers.PointCloudStretchRenderer"===e.declaredClass}function J(e){return"esri.renderers.PointCloudUniqueValueRenderer"===e.declaredClass}function G(e){return"esri.renderers.DotDensityRenderer"===e.declaredClass}function $(e){return"esri.layers.MapImageLayer"===e.declaredClass}function Z(e){return"esri.layers.ImageryLayer"===e.declaredClass}var Q=new c.SimpleMarkerSymbol({style:"path",path:"M10,5 L5,0 0,5 M5,0 L5,15",size:15,outline:{width:1,color:[85,85,85,1]}});return function(t){function c(e){var r=t.call(this,e)||this;return r._handles=new h,r._hasColorRamp=!1,r._hasOpacityRamp=!1,r._hasSizeRamp=!1,r._legendResponse={},r._webStyleSymbolCache=new Map,r._dotDensityUrlCache=new Map,r._scaleDrivenSizeVariable=null,r.children=new y,r.layer=null,r.legendElements=[],r.parent=null,r.respectLayerVisibility=!0,r.sublayerIds=[],r.title=null,r.view=null,r}return n(c,t),c.prototype.initialize=function(){var e=this,t=function(){return e.notifyChange("ready")};this._handles.add([v.on(this,"children","change",(function(r){var n=r.added,l=r.removed,i=e._handles;n.map((function(e){var r="activeLayerInfo-ready-watcher-"+e.layer.uid;i.add(v.init(e,"ready",t),r)})),l.forEach((function(e){return i.remove(e.layer.uid)})),t()}))])},c.prototype.destroy=function(){this._handles.destroy(),this._handles=null,this._legendResponse=null,this._webStyleSymbolCache=null,this._dotDensityUrlCache=null,this._scaleDrivenSizeVariable=null},Object.defineProperty(c.prototype,"ready",{get:function(){return null===this.layer||(this.children.length>0?this._isGroupActive():this.legendElements.length>0)},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"scale",{get:function(){return this.view&&this.view.scale},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"isScaleDriven",{get:function(){var e=this,t=this.layer;if(null===t)return!1;if("featureReduction"in t&&t.featureReduction&&"cluster"===t.featureReduction.type)return!0;if("renderer"in t&&t.renderer){if("dot-density"===t.renderer.type)return!0;var r=t.get("renderer.valueExpression");if(P.test(r))return!0;var n=t.get("renderer.visualVariables");if(n)return n.some((function(t){return e._isScaleDrivenSizeVariable(t)}))}return this._isLayerScaleDriven(this.layer)},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"version",{get:function(){return this._get("version")+1},enumerable:!0,configurable:!0}),c.prototype.buildLegendElementsForFeatureCollections=function(e){return i(this,void 0,void 0,(function(){var t,r=this;return s(this,(function(n){return this.legendElements=[],t=e.map((function(e){if("esri.layers.FeatureLayer"===e.declaredClass)return r._buildRendererLegendElements(e.renderer,{title:e.title,mode:0});if(e.featureSet&&e.featureSet.features.length){var t=e.layerDefinition,n=t&&t.drawingInfo,l=n&&w.fromJSON(n.renderer);return l?r._buildRendererLegendElements(l,{title:e.name,mode:0}):(M.warn("drawingInfo not available!"),null)}return null})),[2,b.eachAlways(t).then((function(){}))]}))}))},c.prototype.buildLegendElementsForRenderer=function(e){return i(this,void 0,void 0,(function(){return s(this,(function(t){return[2,this._buildRendererLegendElements(e)]}))}))},c.prototype.buildLegendElementsForTools=function(){return i(this,void 0,void 0,(function(){var e,t=this;return s(this,(function(r){switch(r.label){case 0:return function(e){return"esri.layers.WMTSLayer"===e.declaredClass}(e=this.layer)?(this._constructLegendElementsForWMTSlayer(),[3,6]):[3,1];case 1:return function(e){return"esri.layers.WMSLayer"===e.declaredClass}(e)?(this._constructLegendElementsForWMSSublayers(),[3,6]):[3,2];case 2:return $(e)||function(e){return"esri.layers.TileLayer"===e.declaredClass}(e)?[4,this._constructLegendElementsForSublayers()]:[3,4];case 3:return r.sent(),[3,6];case 4:return this._handles.remove("imageryLayers-watcher"),[4,this._getLegendLayers().then((function(r){t.legendElements=[],r.forEach((function(r){if(Z(e)){var n=e.watch("renderingRule, bandIds",(function(){t._legendResponse.default=null,t.buildLegendElementsForTools()}));t._handles.add(n,"imageryLayers-watcher")}var l=t._generateSymbolTableElementForLegendLayer(r);l&&l.infos.length&&(Z(e)&&(l.title=e.title),t.legendElements.push(l)),t.notifyChange("ready")})),t.notifyChange("ready")})).catch((function(e){M.warn("Request to server for legend has failed!",e)}))];case 5:r.sent(),r.label=6;case 6:return[2]}}))}))},c.prototype._isGroupActive=function(){var e=this.children;return!!e.length&&e.some((function(e){return e.ready}))},c.prototype._isScaleDrivenSizeVariable=function(e){if(e&&"size"!==e.type)return!1;var t=e,r=t.minSize,n=t.maxSize;return"object"==typeof r&&r?this._isScaleDrivenSizeVariable(r):"object"==typeof n&&n?this._isScaleDrivenSizeVariable(n):!!t.expression||P.test(t.valueExpression)},c.prototype._isLayerScaleDriven=function(e){var t=this;if("minScale"in e&&e.minScale>0||"maxScale"in e&&e.maxScale>0)return!0;if("sublayers"in e&&e.sublayers)return e.sublayers.some((function(e){return t._isLayerScaleDriven(e)}));var r=e.parent;if(!1===e.loaded&&$(r)&&"source"in e&&e.source&&"map-layer"===e.source.type)for(var n=0,l=r.sourceJSON.layers;n<l.length;n++){var i=l[n];if(i.id===e.source.mapLayerId&&(i.minScale>0||i.maxScale>0))return!0}return!1},c.prototype._buildRendererLegendElements=function(e,t){return void 0===t&&(t={}),i(this,void 0,void 0,(function(){var r,n;return s(this,(function(l){switch(l.label){case 0:return l.trys.push([0,2,,3]),[4,this._getRendererLegendElements(e,{title:t.title})];case 1:return r=l.sent(),0===t.mode?Array.prototype.push.apply(this.legendElements,r):this.legendElements=r,this.notifyChange("ready"),[3,3];case 2:return n=l.sent(),M.warn("error while building legend for layer!",n),[3,3];case 3:return[2]}}))}))},c.prototype._constructLegendElementsForWMTSlayer=function(){this.legendElements=[],this._handles.remove("wmts-activeLayer-watcher");var e=this.layer,t=e.activeLayer;if(this._handles.add(v.watch(this.layer,"activeLayer",this._constructLegendElementsForWMTSlayer.bind(this)),"wmts-activeLayer-watcher"),t.styleId&&t.styles){var r=null;t.styles.some((function(e){return t.styleId===e.id&&(r=e.legendUrl,!0)})),r&&(this.legendElements=[{type:"symbol-table",title:t.title,infos:[{src:r,opacity:e.opacity}]}])}this.notifyChange("ready")},c.prototype._constructLegendElementsForWMSSublayers=function(){this.legendElements=[],this._handles.remove("wms-sublayers-watcher");var e=this.layer,t=null;(e.customParameters||e.customLayerParameters)&&(t=r({},e.customParameters,e.customLayerParameters)),this._handles.add(v.watch(this.layer,"sublayers",this._constructLegendElementsForWMSSublayers.bind(this)),"wms-sublayers-watcher"),this.legendElements=this._generateLegendElementsForWMSSublayers(e.sublayers,t),this.notifyChange("ready")},c.prototype._generateLegendElementsForWMSSublayers=function(e,t){var r=this,n=[];return this._handles.add(e.on("change",this._constructLegendElementsForWMSSublayers.bind(this)),"wms-sublayers-watcher"),e.forEach((function(e){var l=e.watch("title, visible, legendEnabled",(function(){return r._constructLegendElementsForWMSSublayers()}));if(r._handles.add(l,"wms-sublayers-watcher"),e.visible&&e.legendEnabled){var i=r._generateSymbolTableElementForWMSSublayer(e,t);i&&i.infos.length&&n.unshift(i)}})),n},c.prototype._generateSymbolTableElementForWMSSublayer=function(e,t){if(!e.legendUrl&&e.sublayers){var r=this._generateLegendElementsForWMSSublayers(e.sublayers,t).filter((function(e){return e}));return{type:"symbol-table",title:e.title,infos:r}}return this._generateSymbolTableElementForLegendUrl(e,t)},c.prototype._generateSymbolTableElementForLegendUrl=function(e,t){var r=e.legendUrl;if(r){var n={type:"symbol-table",title:e.title||e.name||e.id&&e.id+"",infos:[]};return t&&(r+="?"+g.objectToQuery(t)),n.infos.push({src:r,opacity:e.layer&&e.layer.opacity}),n}},c.prototype._getLegendLayers=function(e){var t=this,r=e&&e.hasDynamicLayers?e.dynamicLayers:null,n=r||"default",l=this._legendResponse&&this._legendResponse[n];return l?b.resolve(l):this._legendRequest(r).then((function(e){var r=e.layers;return t._legendResponse[n]=r,r}))},c.prototype._legendRequest=function(e){var t=this.layer,n={f:"json",dynamicLayers:e};if(Z(t)){var l=t;if(l.renderingRule&&(n.renderingRule=JSON.stringify(l.renderingRule.toJSON())),l.bandIds&&(n.bandIds=l.bandIds.join()),l.raster||l.viewId){var i=l.raster,s=l.viewId;n=r({raster:i,viewId:s},n)}}var a=t.url.replace(/(\/)+$/,"");if("version"in t&&t.version>=10.01){var o=a.indexOf("?");o>-1?a=a.substring(0,o)+"/legend"+a.substring(o):a+="/legend"}else{var c=a.toLowerCase().indexOf("/rest/"),d=a.substring(0,c)+a.substring(c+5,a.length);a="https://utility.arcgis.com/sharing/tools/legend?soapUrl="+encodeURI(d)+"&returnbytes=true"}return u(a,{query:n}).then((function(e){return e.data}))},c.prototype._constructLegendElementsForSublayers=function(){return i(this,void 0,void 0,(function(){var e,t,r;return s(this,(function(n){switch(n.label){case 0:this.legendElements=[],this._handles.remove("sublayers-watcher"),e=this.layer,this._handles.add(v.watch(e,"sublayers",this._constructLegendElementsForSublayers.bind(this)),"sublayers-watcher"),n.label=1;case 1:return n.trys.push([1,3,,4]),t=this,[4,this._generateLegendElementsForSublayers(e.sublayers,e.opacity)];case 2:return t.legendElements=n.sent(),this.notifyChange("ready"),[3,4];case 3:return r=n.sent(),M.warn("Request to server for legend has failed!",r),[3,4];case 4:return[2]}}))}))},c.prototype._generateLegendElementsForSublayers=function(e,t,r){return i(this,void 0,void 0,(function(){var n,l,i,a,o,u,c,d,p,y,h,f=this;return s(this,(function(s){switch(s.label){case 0:n=[],this._handles.add(e.on("change",this._constructLegendElementsForSublayers.bind(this)),"sublayers-watcher"),l=e.toArray(),!r&&this.sublayerIds&&this.sublayerIds.length&&(i=this.layer,l=this.sublayerIds.map((function(e){return i.findSublayerById(e)})).filter(Boolean)),a=0,o=l,s.label=1;case 1:return a<o.length?(u=o[a],c=u.watch("renderer, opacity, title, visible, legendEnabled",(function(){return f._constructLegendElementsForSublayers()})),this._handles.add(c,"sublayers-watcher"),u.visible&&u.legendEnabled?(d=u&&null!=u.opacity?u.opacity:null,p=null!=d?d*t:t,!u.renderer||u.sublayers?[3,5]:this.respectLayerVisibility&&!this._isSublayerInScale(u)?[3,4]:[4,u.load()]):[3,7]):[3,8];case 2:return s.sent(),[4,this._getRendererLegendElements(u.renderer,{title:u.title,opacity:p,sublayer:u})];case 3:y=s.sent(),Array.prototype.unshift.apply(n,y),s.label=4;case 4:return[3,7];case 5:return[4,this._generateSymbolTableElementForSublayer(u,p,r)];case 6:(h=s.sent())&&n.unshift(h),s.label=7;case 7:return a++,[3,1];case 8:return[2,n.filter((function(e){return e&&e.infos.length>0}))]}}))}))},c.prototype._generateSymbolTableElementForSublayer=function(e,t,r){return i(this,void 0,void 0,(function(){var n,l,i;return s(this,(function(s){switch(s.label){case 0:if(r)return[3,4];r=new Map,n=new _.ExportImageParameters({layer:this.layer}),s.label=1;case 1:return s.trys.push([1,,3,4]),[4,this._getLegendLayers(n)];case 2:return s.sent().forEach((function(e){return r.set(e.layerId,e)})),[3,4];case 3:return n.destroy(),[7];case 4:return(l=r.get(e.id))||!e.sublayers?[3,6]:[4,this._generateLegendElementsForSublayers(e.sublayers,t,r)];case 5:return i=s.sent(),[2,{type:"symbol-table",title:e.title,infos:i}];case 6:return[2,this._generateSymbolTableElementForLegendLayer(l,e,t)]}}))}))},c.prototype._generateSymbolTableElementForLegendLayer=function(e,t,r){var n=this;if(!e||!e.legend||this.respectLayerVisibility&&!this._isLegendLayerInScale(e,t))return null;var l=t&&t.renderer,i=t&&t.title||e.layerName;if(l){var s=t&&t.title||this._getRendererTitle(l,t);s&&(i&&(s.title=i),i=s)}var a={type:"symbol-table",title:i,infos:[]};e.legendType&&(a.legendType=e.legendType);var o=t?this._sanitizeLegendForSublayer(e.legend.slice(),t):e.legend;return a.infos=o.map((function(t){var l=t.url;if(t.imageData&&t.imageData.length>0)l="data:image/png;base64,"+t.imageData;else{if(0===l.indexOf("http"))return null;l=g.addTokenParameter(n.layer.url+"/"+e.layerId+"/images/"+l)}return{label:t.label,src:l,opacity:null==r?n.layer.opacity:r,width:t.width,height:t.height}})).filter((function(e){return!!e})),a.infos.length?a:null},c.prototype._isSublayerInScale=function(e){var t=e.minScale||0,r=e.maxScale||0;return!(t>0&&t<this.scale||r>this.scale)},c.prototype._isLegendLayerInScale=function(e,t){var r=t||this.layer,n=null,l=null,i=!0;return!r.minScale&&0!==r.minScale||!r.maxScale&&0!==r.maxScale?(0===e.minScale&&r.tileInfo&&(n=r.tileInfo.lods[0].scale),0===e.maxScale&&r.tileInfo&&(l=r.tileInfo.lods[r.tileInfo.lods.length-1].scale)):(n=Math.min(r.minScale,e.minScale)||r.minScale||e.minScale,l=Math.max(r.maxScale,e.maxScale)),(n>0&&n<this.scale||l>this.scale)&&(i=!1),i},c.prototype._sanitizeLegendForSublayer=function(e,t){if("version"in this.layer&&this.layer.version<10.1||0===e.length)return e;var r=t.renderer,n=e.some((function(e){return e.values})),l=null,i=null;return n&&e.some((function(e,t){return e.values||(l=t,(i=e).label||(i.label="others")),null!=i})),r?"unique-value"===r.type?i&&(e.splice(l,1),e.push(i)):"class-breaks"===r.type&&(i&&e.splice(l,1),e.reverse(),i&&e.push(i)):i&&(e.splice(l,1),e.push(i)),e},c.prototype._getRendererLegendElements=function(e,t){return void 0===t&&(t={}),i(this,void 0,void 0,(function(){return s(this,(function(r){return function(e){return k(e)||N(e)||W(e)||B(e)||U(e)||j(e)||H(e)||q(e)||J(e)||G(e)}(e)?function(e){return H(e)||q(e)||J(e)||function(e){return"esri.renderers.PointCloudRGBRenderer"===e.declaredClass}(e)}(e)?[2,this._constructPointCloudRendererLegendElements(e,t)]:G(e)?[2,this._constructDotDensityRendererLegendElements(e)]:[2,this._constructRendererLegendElements(e,t)]:(M.warn("Renderer not supported!"),[2,[]])}))}))},c.prototype._getPointCloudRendererTitle=function(e){return e.legendOptions&&e.legendOptions.title||e.field},c.prototype._constructPointCloudRendererLegendElements=function(e,t){var r=this;void 0===t&&(t={});var n=t.title,l=[],i=null,s=null;if(H(e))i={type:"symbol-table",title:n||this._getPointCloudRendererTitle(e),infos:[]},e.colorClassBreakInfos.forEach((function(e){i.infos.unshift({label:e.label||e.minValue+" - "+e.maxValue,value:[e.minValue,e.maxValue],symbol:r._getAppliedCloneSymbol(O,e.color)})}));else if(q(e)){var a=e.stops,o=null;if(a.length&&(1===a.length&&(o=a[0].color),!o)){var u=a[0].value,c=a[a.length-1].value;if(null!=u&&null!=c){var d=u+(c-u)/2;o=T.getColorFromPointCloudStops(d,a)}}i={type:"symbol-table",title:null,infos:[{label:null,value:null,symbol:this._getAppliedCloneSymbol(O,o||O.color)}]};var p=T.getRampStopsForPointCloud(e.stops);s={type:"color-ramp",title:n||this._getPointCloudRendererTitle(e),infos:p,preview:R.renderColorRampPreviewHTML(p.map((function(e){return e.color})))}}else J(e)&&(i={type:"symbol-table",title:n||this._getPointCloudRendererTitle(e),infos:[]},e.colorUniqueValueInfos.forEach((function(e){i.infos.push({label:e.label||e.values.join(", "),value:e.values.join(", "),symbol:r._getAppliedCloneSymbol(O,e.color)})})));i&&i.infos.length&&l.push(i),s&&s.infos.length&&l.push(s);var y=l.reduce((function(e,t){return e.concat(t.infos)}),[]).filter((function(e){return!!e.symbol})).map((function(e){return r._getSymbolPreview(e,r.layer.opacity)}));return b.eachAlways(y).then((function(){return l}))},c.prototype._getElementInfoForDotDensity=function(e,t){var r=e.backgroundColor,n=e.outline,l=e.dotSize+"-"+t+"-"+r+"-"+(n&&JSON.stringify(n.toJSON())),i=this._dotDensityUrlCache,s=i.has(l)?i.get(l):R.renderDotDensityPreviewHTML(e,t);return i.set(l,s),{opacity:1,src:s.src,preview:s,width:s.width,height:s.height}},c.prototype._constructDotDensityRendererLegendElements=function(e){var t=this,r=e.calculateDotValue(this.view.scale),n=e.legendOptions&&e.legendOptions.unit,l={type:"symbol-table",title:{value:r&&Math.round(r),unit:n||""},infos:[]};return e.attributes.forEach((function(r){var n=t._getElementInfoForDotDensity(e,r.color);n.label=r.label||r.valueExpressionTitle||r.field,l.infos.push(n)})),b.resolve([l])},c.prototype._constructRendererLegendElements=function(e,t){return void 0===t&&(t={}),i(this,void 0,void 0,(function(){var r,n,l,i,a,o,u,c,d,p,y,h,f,g,v,S,_,L,w,E,C,I,F,T,x,D,M,P,O,H,q,J,G,$,Z,X,K,Y,ee=this;return s(this,(function(s){switch(s.label){case 0:return r=t.title,n=t.sublayer,l=n||this.layer,[4,this._loadRenderer(e)];case 1:return i=s.sent(),this._hasColorRamp=!1,this._hasOpacityRamp=!1,this._hasSizeRamp=!1,this._scaleDrivenSizeVariable=null,[4,this._getVisualVariableLegendElements(i,l)];case 2:return a=s.sent()||[],o={type:"symbol-table",title:r||this._getRendererTitle(i,l),infos:[]},u=null,c=!1,j(i)?(d=V.getHeatmapRampStops(i),a.push({type:"heatmap-ramp",title:r,infos:d,preview:R.renderColorRampPreviewHTML(d.map((function(e){return e.color})))}),[3,12]):[3,3];case 3:if(!W(i))return[3,4];if(p=i&&i.authoringInfo,p&&"relationship"===p.type){if(y=p.focus,h=p.numClasses,f=p.field1,g=p.field2,h&&f&&g){for(v=[f,g],S=z.getRotationAngleForFocus(y)||0,_=0,L=v;_<L.length;_++)E=(w=L[_]).field,C=w.normalizationField,I={field:this._getFieldAlias(E,l),normField:C&&this._getFieldAlias(C,l)},(F=Q.clone()).angle=S,o.infos.push({label:I,symbol:F}),S+=90;T=z.getRelationshipRampElement({focus:y,numClasses:h,infos:i.uniqueValueInfos}),a.unshift(T)}}else x=i.field,i.uniqueValueInfos.forEach((function(e){e.symbol&&o.infos.push({label:e.label||ee._getDomainName(x,e.value,l)||e.value,value:e.value,symbol:e.symbol})}));return i.defaultSymbol&&(o.infos.push({label:i.defaultLabel||"others",symbol:i.defaultSymbol}),c=!0),[3,12];case 4:return N(i)?(u=this._isUnclassedRenderer(i),(!u||!this._hasSizeRamp)&&(i.classBreakInfos.forEach((function(e){e.symbol&&o.infos.unshift({label:e.label||(u?null:e.minValue+" - "+e.maxValue),value:[e.minValue,e.maxValue],symbol:e.symbol})})),u&&(o.title=null),this._updateInfosforClassedSizeRenderer(i,o.infos)),i.defaultSymbol&&!u&&(o.infos.push({label:i.defaultLabel||"others",symbol:i.defaultSymbol}),c=!0),[3,12]):[3,5];case 5:return B(i)?function(e){return"esri.layers.TileImageryLayer"===e.declaredClass}(this.layer)?(D=this._constructTileImageryStretchRendererElements(i),"stretch-ramp"===D.type?a.push(D):o.infos=D,[3,10]):[3,6]:[3,11];case 6:return M=this.layer,P=void 0,O=void 0,i.statistics&&i.statistics.length&&(P=i.statistics[0].min||i.statistics[0][0],O=i.statistics[0].max||i.statistics[0][1]),H=[],J=m.unwrap,M.renderingRule?[4,M.generateRasterInfo(M.renderingRule)]:[3,8];case 7:return G=s.sent(),[3,9];case 8:G=M.serviceRasterInfo,s.label=9;case 9:q=J.apply(void 0,[G]),$=q.keyProperties.BandProperties,1===q.bandCount?(P=P||q.statistics&&q.statistics[0].min,O=O||q.statistics&&q.statistics[0].max,P||O?a.push(this._getStretchLegendElements(i,{min:P,max:O})):this.buildLegendElementsForTools()):M.bandIds&&1===M.bandIds.length?(P=P||q.statistics&&q.statistics[M.bandIds[0]].min,O=O||q.statistics&&q.statistics[M.bandIds[0]].max,P||O?a.push(this._getStretchLegendElements(i,{min:P,max:O})):this.buildLegendElementsForTools()):q.bandCount>=3?$&&$.length>=q.bandCount?M.bandIds&&3===M.bandIds.length?(H=M.bandIds.map((function(e){return $[e].BandName})),o.infos=this._createSymbolTableElementMultiBand(H)):"lerc"===M.format?(H=[0,1,2].map((function(e){return $[e].BandName})),o.infos=this._createSymbolTableElementMultiBand(H)):this.buildLegendElementsForTools():"lerc"===M.format?(H=["band0","band1","band2"],o.infos=this._createSymbolTableElementMultiBand(H)):this.buildLegendElementsForTools():this.buildLegendElementsForTools(),s.label=10;case 10:return[3,12];case 11:U(i)?i.colormapInfos.forEach((function(e){o.infos.push({label:e.label,value:e.value,symbol:ee._getAppliedCloneSymbol(A,e.color)})})):k(i)&&i.symbol&&!this._hasSizeRamp&&o.infos.push({label:i.label,symbol:i.symbol}),s.label=12;case 12:return!(Z=i.defaultSymbol)||c||k(i)||u&&!this._hasColorRamp&&!this._hasSizeRamp&&!this._hasOpacityRamp||a.push({type:"symbol-table",infos:[{label:i.defaultLabel||"others",symbol:Z}]}),o.infos.length&&a.unshift(o),X=null==t.opacity?l.opacity:t.opacity,K=this._getSymbolConfig("visualVariables"in i&&i.visualVariables),Y=a.reduce((function(e,t){return e.concat(t.infos)}),[]).filter((function(e){return!(!e||!e.symbol)})).map((function(e){return ee._getSymbolPreview(e,X,K)})),i=null,[4,b.eachAlways(Y)];case 13:return s.sent(),[2,a]}}))}))},c.prototype._constructTileImageryStretchRendererElements=function(e){var t,r,n=this.layer,l=n.rasterInfo,i=l.bandCount||e.statistics.length,s=[],a=l.keyProperties&&l.keyProperties.BandProperties;return e.statistics&&e.statistics.length&&(t=void 0!==e.statistics[0].min?e.statistics[0].min:e.statistics[0][0],r=e.statistics[0].max||e.statistics[0][1]),1===l.bandCount?this._getStretchLegendElements(e,{min:t,max:r}):(s=a&&a.length>=l.bandCount?n.bandIds&&n.bandIds.length===i?n.bandIds.map((function(e){return a[e].BandName})):[0,1,2].map((function(e){return a[e].BandName||"band"+e})):["band0","band1","band2"],i<3&&s.length<3?s.push(s[1]):i>3&&s.length>3&&s.splice(3),this._createSymbolTableElementMultiBand(s))},c.prototype._getStretchLegendElements=function(e,t){var r=e.colorRamp,n=T.getStrectchRampStops(r,t);return{type:"stretch-ramp",title:"",infos:n,preview:R.renderColorRampPreviewHTML(n.map((function(e){return e.color})))}},c.prototype._createSymbolTableElementMultiBand=function(e){var t=[],r=["red","green","blue"];return e.forEach((function(e,n){t.push({label:{colorName:r[n],bandName:e},src:D.RGB_IMG_SOURCE[n],opacity:1})})),t},c.prototype._updateInfosforClassedSizeRenderer=function(e,t){var r=e.authoringInfo&&"class-breaks-size"===e.authoringInfo.type,n=e.classBreakInfos.some((function(e){return C.isVolumetricSymbol(e.symbol)}));if(r&&n){var l=x.REAL_WORLD_MAX_SIZE,i=x.REAL_WORLD_MIN_SIZE,s=e.classBreakInfos.length,a=(l-i)/(s>1?s-1:s);t.forEach((function(e,t){e.size=l-a*t}))}},c.prototype._getSymbolConfig=function(e){var t=!1,r=!1;if(e)for(var n=0;n<e.length&&(!t||!r);n++){var l=e[n];"size"===l.type&&("height"===l.axis&&(t=!0),"width-and-depth"===l.axis&&(r=!0))}return t&&r?"tall":null},c.prototype._getSymbolPreview=function(t,r,n){return i(this,void 0,void 0,(function(){var l,i;return s(this,(function(s){switch(s.label){case 0:return l=t.size,this._scaleDrivenSizeVariable?[4,new Promise((function(t,r){e(["../../../renderers/visualVariables/support/visualVariableUtils"],t,r)}))]:[3,2];case 1:i=s.sent().getSize,l=i(this._scaleDrivenSizeVariable,null,{view:this.view,scale:this.scale,shape:"simple-marker"===t.symbol.type?t.symbol.style:null}),s.label=2;case 2:return[2,R.renderPreviewHTML(t.symbol,{size:l,opacity:r,symbolConfig:n,rotation:t.symbol.angle}).then((function(e){return t.preview=e,t})).catch((function(){return t.preview=null,t}))]}}))}))},c.prototype._loadRenderer=function(e){return i(this,void 0,void 0,(function(){var t,r,n,l,i=this;return s(this,(function(s){switch(s.label){case 0:return t=[],e=e.clone(),[4,this._getMedianColor(e)];case 1:return r=s.sent(),(N(e)||W(e))&&(n=e.classBreakInfos||e.uniqueValueInfos,l=n.map((function(e){return i._fetchSymbol(e.symbol,r).then((function(t){e.symbol=t})).catch((function(){e.symbol=null}))})),Array.prototype.push.apply(t,l)),t.push(this._fetchSymbol(e.symbol||e.defaultSymbol,e.defaultSymbol?null:r).then((function(t){i._applySymbolToRenderer(e,t,k(e))})).catch((function(){i._applySymbolToRenderer(e,null,k(e))}))),[2,b.eachAlways(t).then((function(){return e}))]}}))}))},c.prototype._applySymbolToRenderer=function(e,t,r){r?e.symbol=t:e.defaultSymbol=t},c.prototype._getMedianColor=function(t){return i(this,void 0,void 0,(function(){var r,n,l,i;return s(this,(function(s){switch(s.label){case 0:if(!("visualVariables"in t&&t.visualVariables))return[2,null];if(!(r=p.find(t.visualVariables,(function(e){return"color"===e.type}))))return[2,null];if(n=null,l=null,r.stops){if(1===r.stops.length)return[2,r.stops[0].color];n=r.stops[0].value,l=r.stops[r.stops.length-1].value}return i=n+(l-n)/2,[4,new Promise((function(t,r){e(["../../../renderers/visualVariables/support/visualVariableUtils"],t,r)}))];case 1:return[2,(0,s.sent().getColor)(r,i)]}}))}))},c.prototype._fetchSymbol=function(e,t){var r=this;if(!e)return b.reject();if("web-style"===e.type){var n=e.portal,l=n&&n.url,i=n&&n.user&&n.user.username,s=e.name+"-"+e.styleName+"-"+e.styleUrl+"-"+l+"-"+i,a=this._webStyleSymbolCache;return a.has(s)||(this.view instanceof I?a.set(s,e.fetchCIMSymbol()):a.set(s,e.fetchSymbol())),a.get(s).then((function(e){return r._getAppliedCloneSymbol(e,t)})).catch((function(){return M.warn("Fetching web-style failed!"),b.reject()}))}return b.resolve(this._getAppliedCloneSymbol(e,t))},c.prototype._getAppliedCloneSymbol=function(e,t){if(!e)return e;var r=e.clone(),n=r.type.indexOf("3d")>-1,l=t&&t.toRgba();return n?this._applyColorTo3dSymbol(r,l):r.color&&(r.color=new o(l||r.color)),r},c.prototype._applyColorTo3dSymbol=function(e,t){t&&e.symbolLayers.forEach((function(e){e&&(e.material||(e.material={}),e.material.color=new o(t))}))},c.prototype._createClusterSizeVariable=function(e){var t=F.getActiveSizeStops(this.view,e);return new E({field:e.field,legendOptions:{title:a.clusterCountTitle},minSize:t[2].size,minDataValue:t[2].value,maxSize:t[3].size,maxDataValue:t[3].value})},c.prototype._getVisualVariableLegendElements=function(e,t){return i(this,void 0,void 0,(function(){var r,n,l,a,o,u,c,d,p,y=this;return s(this,(function(h){switch(h.label){case 0:return"visualVariables"in e&&e.visualVariables?(r=e.visualVariables,n=[],l=[],a=[],r.forEach((function(e){"color"===e.type?n.push(e):"size"===e.type?("levels"in e&&e.levels&&(e=y._createClusterSizeVariable(e)),l.push(e)):"opacity"===e.type&&a.push(e)})),o=n.concat(l,a),0===n.length&&N(e)&&e.classBreakInfos&&1===e.classBreakInfos.length&&(d=e.classBreakInfos[0],u=d&&d.symbol),0===n.length&&k(e)&&(u=e.symbol),u&&(u.type.indexOf("3d")>-1?"water"===(p=u.symbolLayers.getItemAt(0)).type?m.isSome(p.color)&&(c=p.color):m.isSome(p.material)&&m.isSome(p.material.color)&&(c=p.material.color):u.url||(c=u.color)),[4,b.all(o.map((function(r){return i(y,void 0,void 0,(function(){var n,l,i,a,o,u,d,p;return s(this,(function(s){switch(s.label){case 0:return r.legendOptions&&!1===r.legendOptions.showLegend?[3,10]:(n=this._getRampTitle(r,t),l=null,i="getField"in t&&t.getField&&t.getField(r.field),a=i&&L.isDateField(i),"color"!==r.type?[3,2]:[4,T.getRampStops(r,null,a)]);case 1:return p=s.sent(),l={type:"color-ramp",title:n,infos:p,preview:R.renderColorRampPreviewHTML(p.map((function(e){return e.color})))},this._hasColorRamp||(this._hasColorRamp=!(null==l.infos||!l.infos.length)),[3,9];case 2:return"size"!==r.type||"outline"===r.target?[3,7]:P.test(r.valueExpression)?(this._scaleDrivenSizeVariable=r,[3,6]):[3,3];case 3:return o={type:"size-ramp",title:n},u=x.getRampStops,d=[e,r],[4,this._getMedianColor(e)];case 4:return[4,u.apply(void 0,d.concat([s.sent(),this.scale,this.view,a]))];case 5:o.infos=s.sent(),l=o,this._hasSizeRamp||(this._hasSizeRamp=!(null==l.infos||!l.infos.length)),s.label=6;case 6:return[3,9];case 7:return"opacity"!==r.type?[3,9]:[4,T.getRampStops(r,c,a)];case 8:p=s.sent(),l={type:"opacity-ramp",title:n,infos:p,preview:R.renderColorRampPreviewHTML(p.map((function(e){return e.color})))},this._hasOpacityRamp||(this._hasOpacityRamp=!(null==l.infos||!l.infos.length)),s.label=9;case 9:return[2,l&&l.infos?l:null];case 10:return[2,void 0]}}))}))})))]):[2,null];case 1:return[2,h.sent().filter((function(e){return!!e}))]}}))}))},c.prototype._getDomainName=function(e,t,r){if(e&&"function"!=typeof e){var n="getField"in r&&r.getField&&r.getField(e),l=n&&"getFieldDomain"in r&&r.getFieldDomain?r.getFieldDomain(n.name):null;return l&&"coded-value"===l.type?l.getName(t):null}return null},c.prototype._getRampTitle=function(e,t){var r=e.field,n=e.normalizationField,l=!1,i=!1,s=!1,a=null;if(r="function"==typeof r?null:r,n="function"==typeof n?null:n,null!=(e.legendOptions&&e.legendOptions.title))a=e.legendOptions.title;else if(e.valueExpressionTitle)a=e.valueExpressionTitle;else{if("renderer"in t&&t.renderer&&"authoringInfo"in t.renderer&&t.renderer.authoringInfo&&t.renderer.authoringInfo.visualVariables)for(var o=t.renderer.authoringInfo.visualVariables,u=0;u<o.length;u++){var c=o[u];if("color"===c.type){if("ratio"===c.style){l=!0;break}if("percent"===c.style){i=!0;break}if("percent-of-total"===c.style){s=!0;break}}}a={field:r&&this._getFieldAlias(r,t),normField:n&&this._getFieldAlias(n,t),ratio:l,ratioPercent:i,ratioPercentTotal:s}}return a},c.prototype._getRendererTitle=function(e,t){var r=e;if(r.legendOptions&&r.legendOptions.title)return r.legendOptions.title;if(r.valueExpressionTitle)return r.valueExpressionTitle;var n=r.field,l=null,i=null;N(r)&&(l=r.normalizationField,i="percent-of-total"===r.normalizationType),l="function"==typeof l?null:l;var s=null;return((n="function"==typeof n?null:n)||l)&&(s={field:n&&this._getFieldAlias(n,t),normField:l&&this._getFieldAlias(l,t),normByPct:i}),s},c.prototype._getFieldAlias=function(e,t){var r="popupTemplate"in t&&t.popupTemplate,n=r&&r.fieldInfos,l=null;n&&n.some((function(t){return e===t.fieldName&&(l=t,!0)}));var i=null;"getField"in t&&t.getField?i=t.getField(e):"fieldsIndex"in t&&t.fieldsIndex&&(i=t.fieldsIndex.get(e));var s=l||i,a=null;return s&&(a=l&&l.label||i&&i.alias||"name"in s&&s.name||"fieldName"in s&&s.fieldName),a},c.prototype._isUnclassedRenderer=function(e){var t=e.visualVariables,r=!1;return N(e)&&e.classBreakInfos&&1===e.classBreakInfos.length&&t&&(r=e.field?t.some((function(t){return!(!t||e.field!==t.field||(e.normalizationField||t.normalizationField)&&e.normalizationField!==t.normalizationField)})):!!t.length),r},l([S.property()],c.prototype,"children",void 0),l([S.property()],c.prototype,"layer",void 0),l([S.property()],c.prototype,"legendElements",void 0),l([S.property()],c.prototype,"parent",void 0),l([S.property({readOnly:!0})],c.prototype,"ready",null),l([S.property()],c.prototype,"respectLayerVisibility",void 0),l([S.property({dependsOn:["view.scale"],readOnly:!0})],c.prototype,"scale",null),l([S.property()],c.prototype,"sublayerIds",void 0),l([S.property({dependsOn:["layer.renderer?.valueExpression?","layer.renderer?.visualVariables?","layer.featureReduction?","scale"],readOnly:!0})],c.prototype,"isScaleDriven",null),l([S.property()],c.prototype,"title",void 0),l([S.property({dependsOn:["ready"],readOnly:!0,value:0})],c.prototype,"version",null),l([S.property()],c.prototype,"view",void 0),c=l([S.subclass("esri.widgets.Legend.support.ActiveLayerInfo")],c)}(S.declared(d))}));