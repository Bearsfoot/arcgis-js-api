// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/awaiterHelper","../../../core/tsSupport/generatorHelper","../../../symbols","../../../core/promiseUtils","../../../renderers/support/numberUtils","../../../symbols/support/utils","./utils","@dojo/framework/shim/Promise"],(function(e,r,n,t,l,i,s,u,o){Object.defineProperty(r,"__esModule",{value:!0}),r.REAL_WORLD_MAX_SIZE=30,r.REAL_WORLD_MIN_SIZE=12;var a=[255,255,255],c=[200,200,200],f=[128,128,128];function m(r,l,i,u){return n(this,void 0,void 0,(function(){var n,o,a,c,f;return t(this,(function(t){switch(t.label){case 0:return[4,new Promise((function(r,n){e(["../../../renderers/visualVariables/support/visualVariableUtils"],r,n)}))];case 1:if(n=t.sent().getSizeRangeAtScale(r,i,u),o=n&&function(e){for(var r=e.minSize,n=e.maxSize,t=(n-r)/4,l=[],i=0;i<5;i++)l.push(r+t*i);return l}(n),!n&&!o)return[2,void 0];a=o.map((function(e){return function(e,r,n){var t=n.minSize,l=n.maxSize,i=r.minDataValue,s=r.maxDataValue,u=null;if(e<=t)u=i;else if(e>=l)u=s;else{u=(e-t)/(l-t)*(s-i)+i}return u}(e,r,n)})),a=s.round(a),c=1,t.label=2;case 2:return c<a.length-1?[4,p(r,l,a[c],a[c-1],i,u)]:[3,5];case 3:(f=t.sent())&&(a[c]=f[0],o[c]=f[1]),t.label=4;case 4:return c++,[3,2];case 5:return[2,a]}}))}))}function p(e,r,l,i,u,o){return n(this,void 0,void 0,(function(){var n,a,c,f,m,p,h,y,d,v,S,g,w,z,L,_,V,D,x,E,M,O;return t(this,(function(t){switch(t.label){case 0:return[4,b(e,r,l,u,o)];case 1:return a=t.sent(),[4,b(e,r,i,u,o)];case 2:c=t.sent(),f=s.numDigits(l),m=f.fractional,p=20,h=f.integer,y=null,d=null,l>0&&l<1&&(y=Math.pow(10,m),l*=y,h=s.numDigits(l).integer),v=h-1,t.label=3;case 3:return v>=0?(S=Math.pow(10,v),g=Math.floor(l/S)*S,w=Math.ceil(l/S)*S,null!=y&&(g/=y,w/=y),z=(g+w)/2,n=s.round([g,z,w],{indexes:[1]}),z=n[1],[4,b(e,r,g,u,o)]):[3,8];case 4:return L=t.sent(),[4,b(e,r,w,u,o)];case 5:return _=t.sent(),[4,b(e,r,z,u,o)];case 6:if(V=t.sent(),D=s.percentChange(a,L,c,null),x=s.percentChange(a,_,c,null),E=s.percentChange(a,V,c,null),M=D.previous<=p,O=x.previous<=p,M&&O&&(D.previous<=x.previous?(M=!0,O=!1):(O=!0,M=!1)),M?d=[g,L]:O?d=[w,_]:E.previous<=p&&(d=[z,V]),d)return[3,8];t.label=7;case 7:return v--,[3,3];case 8:return[2,d]}}))}))}function b(r,l,i,s,u){return n(this,void 0,void 0,(function(){return t(this,(function(n){switch(n.label){case 0:return[4,new Promise((function(r,n){e(["../../../renderers/visualVariables/support/visualVariableUtils"],r,n)}))];case 1:return[2,(0,n.sent().getSize)(r,i,{scale:s,view:u,shape:"simple-marker"===l.type?l.style:null})]}}))}))}r.getRampStops=function(e,p,h,y,d,v){return n(this,void 0,void 0,(function(){var S,g,w,z,L,_,V,D,x,E,M,O,R,I,k,A,C=this;return t(this,(function(P){switch(P.label){case 0:return S=p.legendOptions,g=S&&S.customValues,w=function(e,r){var n=null,t=null;if("simple"===e.type)n=e.symbol;else if("class-breaks"===e.type){var i=e.classBreakInfos;n=i&&i[0]&&i[0].symbol,t=i.length>1}else if("unique-value"===e.type){i=e.uniqueValueInfos;n=i&&i[0]&&i[0].symbol,t=i.length>1}if(!n||function(e){if(e){return l.isSymbol3D(e)?!!e.symbolLayers&&e.symbolLayers.some((function(e){return e&&"fill"===e.type})):-1!==e.type.indexOf("fill")}return!1}(n))return null;n=n.clone(),(r||t)&&(n.type.indexOf("3d")>-1?function(e){u.isVolumetricSymbol(e)||("line-3d"===e.type?e.symbolLayers.forEach((function(e){e.material={color:f}})):e.symbolLayers.forEach((function(e){"icon"!==e.type||e.resource&&e.resource.href?e.material={color:c}:(e.material={color:a},e.outline={color:f,size:1.5})})))}(n):function(e){-1!==e.type.indexOf("line")?e.color=f:(e.color=a,"simple-marker"===e.type&&(e.outline={color:f,width:1.5}))}(n));return n}(e,h),z=!!w,L=!!g,_=null!=p.minSize&&null!=p.maxSize,V=p.stops&&p.stops.length>1,D=!!p.target,z&&(L||_||V&&!D)?(x=u.isVolumetricSymbol(w),E=null,M=null,O=null,!x||V?[3,1]:(M=s.round([p.minDataValue,p.maxDataValue]),[3,4])):[2,void 0];case 1:return(R=g)?[3,3]:[4,m(p,w,y,d)];case 2:R=P.sent(),P.label=3;case 3:M=R,P.label=4;case 4:return!M&&V&&(M=p.stops.map((function(e){return e.value})),(E=p.stops.some((function(e){return!!e.label})))&&(O=p.stops.map((function(e){return e.label})))),x&&M&&M.length>2&&(M=[M[0],M[M.length-1]]),M?(I=[r.REAL_WORLD_MIN_SIZE,r.REAL_WORLD_MAX_SIZE],k=u.getSymbolOutlineSize(w),A=E?null:function(e,r){var n=e.length-1;return e.map((function(e,t){return o.createStopLabel(e,t,n,r)}))}(M,v),[4,i.all(M.map((function(e,r){return n(C,void 0,void 0,(function(){var n,i,s,o;return t(this,(function(t){switch(t.label){case 0:return x?(s=I[r],[3,3]):[3,1];case 1:return[4,b(p,w,e,y,d)];case 2:s=t.sent(),t.label=3;case 3:return i=function(e,r){var n=e.clone();if(l.isSymbol3D(n))u.isVolumetricSymbol(n)||n.symbolLayers.forEach((function(e){"fill"!==e.type&&(e.size=r)}));else if("esri.symbols.SimpleMarkerSymbol"===n.declaredClass)n.size=r;else if(function(e){return"esri.symbols.PictureMarkerSymbol"===e.declaredClass}(n)){var t=n.width,i=n.height;n.height=r,n.width=r*(t/i)}else!function(e){return"esri.symbols.SimpleLineSymbol"===e.declaredClass}(n)?function(e){return"esri.symbols.TextSymbol"===e.declaredClass}(n)&&n.font&&(n.font.size=r):n.width=r;return n}(w,n=s),o=E?O[r]:A[r],[2,{value:e,symbol:i,label:o,size:n,outlineSize:k}]}}))}))})))]):[2,null];case 5:return[2,P.sent().reverse()]}}))}))}}));