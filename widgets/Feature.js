// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","../core/tsSupport/assignHelper","../core/tsSupport/generatorHelper","../core/tsSupport/awaiterHelper","dojo/i18n!./Feature/nls/Feature","../intl","../core/events","../core/throttle","../core/watchUtils","../core/accessorSupport/decorators","./Attachments","./Widget","./Feature/FeatureViewModel","./support/chartUtils","./support/uriUtils","./support/widget","./support/widgetUtils"],(function(e,t,i,r,a,n,s,o,l,d,c,u,p,h,f,m,_,v,y,g){var x="esri-icon-font-fallback-text",M="esri-icon-loading-indicator esri-rotating",b="esri-icon-left-triangle-arrow",w="esri-icon-right-triangle-arrow",C="esri-widget__table",T="esri-widget",I="esri-feature",E="esri-feature__size-container",k="esri-feature__title",A="esri-feature__main-container",L="esri-feature__button",R="esri-feature__icon",F="esri-feature__content-element",K="esri-feature__text",S="esri-feature__last-edited-info",P="esri-feature--media-pagination-visible",H="esri-feature__attachments",U="esri-feature__fields",N="esri-feature__field-header",W="esri-feature__field-data",z="esri-feature__field-data--date",O="esri-feature__media",V="esri-feature__media-container",X="esri-feature__media-item-container",B="esri-feature__media-item",Y="esri-feature__media-item-title",D="esri-feature__media-item-caption",j="esri-feature__media-previous",q="esri-feature__media-previous-icon",G="esri-feature__media-previous-icon--rtl",J="esri-feature__media-next",Q="esri-feature__media-next-icon",Z="esri-feature__media-next-icon--rtl",$="esri-feature__media-chart",ee="esri-feature__loading-container",te="esri-feature__loading-spinner",ie={title:!0,content:!0,lastEditedInfo:!0};return function(e){function t(t){var i=e.call(this,t)||this;return i._chartUIds=new Map,i._contentElementCharts=new Map,i._activeMediaMap=new Map,i._refreshTimers=new Map,i._mediaInfo=new Map,i._renderChartThrottled=c.throttle((function(e){return i._renderChart(e)}),100),i._attachmentsWidgets=[],i.graphic=null,i.defaultPopupTemplateEnabled=!1,i.label=o.widgetLabel,i.spatialReference=null,i.title=null,i.visibleElements=a({},ie),i.map=null,i.view=null,i.viewModel=new m,i._addTargetToAnchors=function(e){e.querySelectorAll("a").forEach((function(e){i._shouldOpenInNewTab(e.href)&&!e.hasAttribute("target")&&e.setAttribute("target","_blank")}))},i}return i(t,e),t.prototype.postInitialize=function(){var e=this;this.own(u.init(this,"viewModel.content",(function(){e._setupMediaRefreshTimers(),e._setupAttachmentWidgets()})),u.init(this,"viewModel.graphic",(function(){return e._disposeCharts()})))},t.prototype.destroy=function(){this._clearMediaRefreshTimers(),this._activeMediaMap.clear(),this._activeMediaMap=null,this._destroyAttachmentWidgets(),this._disposeCharts()},t.prototype.castVisibleElements=function(e){return a({},ie,e)},t.prototype.render=function(){var e=y.tsx("div",{key:"loading-container",class:ee},y.tsx("span",{class:this.classes(M,te)})),t=this.visibleElements,i=this.viewModel,r=i.waitingForContent,a=i.title,n=t.title?y.tsx("h4",{class:k,innerHTML:a}):null,s=t.content?y.tsx("div",{class:A},[this._renderContent(),this._renderLastEditInfo()]):null;return y.tsx("div",{class:this.classes(I,T)},y.tsx("div",{class:E},n,r?e:s))},t.prototype.goToMedia=function(e,t){this._setContentElementMedia(e,t)},t.prototype.nextMedia=function(e){this._pageContentElementMedia(e,"next")},t.prototype.previousMedia=function(e){this._pageContentElementMedia(e,"previous")},t.prototype._buildKey=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];var r=this.get("viewModel.graphic.uid")||"0",a=t.join("-");return e+"__"+r+"-"+a},t.prototype._disposeCharts=function(){return s(this,void 0,void 0,(function(){return n(this,(function(e){return this._chartUIds.forEach((function(e){return e.dispose()})),this._chartUIds.clear(),this._contentElementCharts.forEach((function(e){return e.dispose()})),this._contentElementCharts.clear(),[2]}))}))},t.prototype._renderContent=function(){var e=this.viewModel.content;return e?"string"==typeof e?y.tsx("div",{key:"content-string",innerHTML:e}):y.isWidget(e)?y.tsx("div",{key:"content-widget"},e.render()):e instanceof HTMLElement?y.tsx("div",{key:"content-html-element",bind:e,afterCreate:this._attachToNode}):y.hasDomNode(e)?y.tsx("div",{key:"content-dijit",bind:e.domNode,afterCreate:this._attachToNode}):Array.isArray(e)&&e.length?y.tsx("div",{key:"content-content-elements"},e.map(this._renderContentElement,this)):null:null},t.prototype._renderContentElement=function(e,t){var i=this.visibleElements;if("boolean"!=typeof i.content&&!i.content[e.type])return null;switch(e.type){case"attachments":return this._renderAttachments(t);case"fields":return this._renderFields(e,t);case"media":return this._renderMedia(e,t);case"text":return this._renderText(e,t);default:return null}},t.prototype._renderAttachments=function(e){var t=this._attachmentsWidgets[e];if(!t||t.destroyed)return null;var i=t.viewModel,r=i.state,a=i.attachmentInfos;return"loading"===r||a.length>0?y.tsx("div",{key:this._buildKey("attachments-element",e),class:this.classes(H,F)},y.tsx("h2",null,o.attach),t.render()):null},t.prototype._forceLTR=function(e){return"&lrm;"+e},t.prototype._renderFieldInfo=function(e,t){var i,r=this.viewModel.formattedAttributes,a=r?r.content[t]||r.global:null,n=e.fieldName,s=e.label||n,o=a?null==a[n]?"":a[n]:"",l=!(!e.format||!e.format.dateFormat),d="number"==typeof o&&!l?this._forceLTR(o):v.autoLink(o),c=((i={})[z]=l,i);return y.tsx("tr",{key:this._buildKey("fields-element-info-row",t)},y.tsx("th",{key:this._buildKey("fields-element-info-row-header",t),class:N,innerHTML:s}),y.tsx("td",{key:this._buildKey("fields-element-info-row-data",t),class:this.classes(W,c),innerHTML:d}))},t.prototype._renderFields=function(e,t){var i=this,r=e.fieldInfos;return r?y.tsx("div",{key:this._buildKey("fields-element",t),class:this.classes(U,F)},y.tsx("table",{class:C,summary:o.fieldsSummary,key:this._buildKey("fields-element-table",t)},y.tsx("tbody",{key:this._buildKey("fields-element-table-body",t)},r.map((function(e){return i._renderFieldInfo(e,t)}))))):null},t.prototype._shouldOpenInNewTab=function(e){if(void 0===e&&(e=""),e){return!/^(?:mailto:|tel:)/.test(e.trim().toLowerCase())}},t.prototype._clearMediaRefreshTimers=function(){this._refreshTimers.forEach((function(e){return clearTimeout(e)})),this._refreshTimers.clear()},t.prototype._clearMediaRefreshTimer=function(e){var t=this._refreshTimers.get(e);t&&(clearTimeout(t),this._refreshTimers.delete(e))},t.prototype._getImageSource=function(e,t){var i=-1!==e.indexOf("?")?"&":"?",r=e.split("#"),a=r[0],n=r[1],s=void 0===n?"":n;return""+a+i+"timestamp="+t+(s?"#":"")+s},t.prototype._setupMediaRefreshTimer=function(e){var t=this.get("viewModel.content");if(Array.isArray(t)){var i=t[e];if(i&&"media"===i.type){var r=this._activeMediaMap.get(e);isNaN(r)&&(r=0);var a=i.mediaInfos[r];a&&"image"===a.type&&a.refreshInterval&&this._setRefreshTimeout(e,a)}}},t.prototype._destroyAttachmentWidgets=function(){this._attachmentsWidgets.forEach((function(e){return e&&!e.destroyed&&e.destroy()})),this._attachmentsWidgets=[]},t.prototype._setupAttachmentWidgets=function(){var e=this;this._destroyAttachmentWidgets();var t=this.get("viewModel.content");if(Array.isArray(t)){var i=this.viewModel.attachmentsViewModel;t.forEach((function(t,r){"attachments"===t.type&&(e._attachmentsWidgets[r]=new h({displayType:t.displayType,viewModel:i}))}),this),this.scheduleRender()}},t.prototype._setupMediaRefreshTimers=function(){var e=this;this._clearMediaRefreshTimers();var t=this.get("viewModel.content");Array.isArray(t)&&t.forEach((function(t,i){return e._setupMediaRefreshTimer(i)}))},t.prototype._updateMediaInfoTimestamp=function(e,t){var i=Date.now();this._mediaInfo.set(t,{timestamp:i,sourceURL:this._getImageSource(e,i)}),this.scheduleRender()},t.prototype._setRefreshTimeout=function(e,t){var i=this,r=t.refreshInterval,a=t.value;if(r){var n=6e4*r;this._updateMediaInfoTimestamp(a.sourceURL,e);var s=setInterval((function(){i._updateMediaInfoTimestamp(a.sourceURL,e)}),n);this._refreshTimers.set(e,s)}},t.prototype._renderMediaInfoType=function(e){var t=e.mediaInfo,i=e.contentElementIndex,r=e.activeMediaIndex,a=t.title,n=void 0===a?"":a;if("image"===t.type){var s=t,o=s.value,l=s.refreshInterval,d=o.sourceURL,c=o.linkURL,u=this._shouldOpenInNewTab(c)?"_blank":"_self",p="_blank"===u?"noreferrer":"",h=l?this._mediaInfo.get(i):null,f=h?h.timestamp:0,m=h?h.sourceURL:d,_=y.tsx("img",{alt:n,key:this._buildKey("media-image",i,r,f),src:m}),v=c?y.tsx("a",{title:n,href:c,rel:p,target:u},_):null;return v||_}if(-1!==t.type.indexOf("chart"))return y.tsx("div",{key:this._buildKey("media-chart",i,r),bind:this,"data-media-info":t,"data-content-element-index":i,class:$,afterCreate:this._getChartDependencies,afterRemoved:this._disposeChartByNode})},t.prototype._getChartDependencies=function(e){var t=this,i=e["data-media-info"],r=e["data-content-element-index"];this._disposeChartByNode(e),this._disposeChartByContgentElementIndex(r);var a=i.value,n=i.type;_.loadChartsModule().then((function(i){return t._renderChartThrottled({chartDiv:e,contentElementIndex:r,type:n,value:a,chartsModule:i})}))},t.prototype._disposeChartByContgentElementIndex=function(e){var t=this._contentElementCharts.get(e);t&&t.dispose()},t.prototype._disposeChartByNode=function(e){var t=e.getAttribute("data-chart-uid"),i=this._chartUIds.get(t);i&&i.dispose()},t.prototype._customizeChartTooltip=function(e,t){e.label.wrap=!0,e.label.maxWidth=200,e.autoTextColor=!1,e.getFillFromObject=!1,e.label.fill=t.color("#ffffff"),e.background.fill=t.color({r:0,g:0,b:0,a:.7})},t.prototype._createPieChart=function(e){var t=e.chartDiv,i=e.chartsModule,r=i.am4core,a=i.am4charts,n=r.create(t,a.PieChart);n.rtl=g.isRTL();var s=n.series.push(new a.PieSeries);return s.labels.template.disabled=!0,s.ticks.template.disabled=!0,s.dataFields.value="y",s.dataFields.category="x",this._customizeChartTooltip(s.tooltip,r),n},t.prototype._getMinSeriesValue=function(e){var t=0;return e.forEach((function(e){return t=Math.min(e.x,t)})),t},t.prototype._createXYChart=function(e){var t=e.chartDiv,i=e.type,r=e.value,a=e.chartsModule,n=a.am4core,s=a.am4charts,o=n.create(t,s.XYChart);o.rtl=g.isRTL();var l=r.series.length>15;if("column-chart"===i){var d=o.xAxes.push(new s.CategoryAxis);d.dataFields.category="x",d.renderer.labels.template.disabled=!0,this._customizeChartTooltip(d.tooltip,n),d.tooltip.events.on("sizechanged",(function(){d.tooltip.dy=-d.tooltip.contentHeight}));var c=(h=o.yAxes.push(new s.ValueAxis)).renderer.labels.template;h.renderer.minLabelPosition=.05,h.renderer.maxLabelPosition=.95,h.min=this._getMinSeriesValue(r.series),this._customizeChartTooltip(h.tooltip,n),c.wrap=!0,(f=o.series.push(new s.ColumnSeries)).dataFields.valueY="y",f.dataFields.categoryX="x",o.cursor=new s.XYCursor,l&&(o.scrollbarX=new n.Scrollbar)}if("bar-chart"===i){var u=o.yAxes.push(new s.CategoryAxis);u.dataFields.category="x",u.renderer.inversed=!0,u.renderer.labels.template.disabled=!0,this._customizeChartTooltip(u.tooltip,n),u.tooltip.events.on("sizechanged",(function(){u.tooltip.dx=u.tooltip.contentWidth}));c=(h=o.xAxes.push(new s.ValueAxis)).renderer.labels.template;h.renderer.minLabelPosition=.05,h.renderer.maxLabelPosition=.95,h.min=this._getMinSeriesValue(r.series),this._customizeChartTooltip(h.tooltip,n),c.wrap=!0,(f=o.series.push(new s.ColumnSeries)).dataFields.valueX="y",f.dataFields.categoryY="x",o.cursor=new s.XYCursor,l&&(o.scrollbarY=new n.Scrollbar)}if("line-chart"===i){var p=o.xAxes.push(new s.CategoryAxis);p.dataFields.category="x",p.renderer.labels.template.disabled=!0,this._customizeChartTooltip(p.tooltip,n),p.tooltip.events.on("sizechanged",(function(){p.tooltip.dy=-p.tooltip.contentHeight}));var h,f;c=(h=o.yAxes.push(new s.ValueAxis)).renderer.labels.template;h.renderer.minLabelPosition=.05,h.renderer.maxLabelPosition=.95,h.min=this._getMinSeriesValue(r.series),this._customizeChartTooltip(h.tooltip,n),c.wrap=!0,(f=o.series.push(new s.LineSeries)).dataFields.categoryX="x",f.dataFields.valueY="y",o.cursor=new s.XYCursor,l&&(o.scrollbarX=new n.Scrollbar)}return o},t.prototype._renderChart=function(e){var t=e.type,i=e.contentElementIndex,r=e.value,a=e.chartsModule,n=e.chartDiv;a.am4core.useTheme(a.am4themes_animated);var s="pie-chart"===t?this._createPieChart(e):this._createXYChart(e);this._chartUIds.set(s.uid,s),this._contentElementCharts.set(i,s),n.setAttribute("data-chart-uid",s.uid),s.data=r.series.map((function(e){return{x:e.tooltip,y:e.y}}))},t.prototype._renderMediaInfo=function(e){var t=e.mediaInfo,i=e.contentElementIndex,r=e.activeMediaIndex,a=this._renderMediaInfoType({mediaInfo:t,contentElementIndex:i,activeMediaIndex:r}),n=t.title?y.tsx("div",{key:this._buildKey("media-title",i),class:Y,innerHTML:t.title}):null,s=t.caption?y.tsx("div",{key:this._buildKey("media-caption",i),class:D,innerHTML:t.caption}):null;return y.tsx("div",{key:this._buildKey("media-container",i),class:X},n,s,y.tsx("div",{key:this._buildKey("media-item-container",i),class:B},a))},t.prototype._renderMediaPageButton=function(e,t){var i="previous"===e,r=i?o.previous:o.next,a=i?this.classes(L,j):this.classes(L,J),n=i?this.classes(R,q,b):this.classes(R,Q,w),s=i?this.classes(R,G,w):this.classes(R,Z,b),l=i?"media-previous":"media-next",d=i?this._previousClick:this._nextClick;return y.tsx("div",{key:this._buildKey(l,t),title:r,tabIndex:0,role:"button",class:a,"data-content-element-index":t,bind:this,onkeydown:d,onclick:d},y.tsx("span",{"aria-hidden":"true",class:n}),y.tsx("span",{"aria-hidden":"true",class:s}),y.tsx("span",{class:x},r))},t.prototype._handleMediaKeyup=function(e){var t=e.currentTarget["data-content-element-index"],i=d.eventKey(e);"ArrowLeft"===i&&(e.stopPropagation(),this.previousMedia(t)),"ArrowRight"===i&&(e.stopPropagation(),this.nextMedia(t))},t.prototype._renderMedia=function(e,t){var i,r=e.mediaInfos,a=r&&r.length||0,n=((i={})[P]=a>1,i),s=this._renderMediaPageButton("previous",t),o=this._renderMediaPageButton("next",t),l=this._activeMediaMap.get(t);return isNaN(l)&&(this._activeMediaMap.set(t,0),l=0),a?y.tsx("div",{key:this._buildKey("media-element",t),"data-content-element-index":t,bind:this,onkeyup:this._handleMediaKeyup,class:this.classes(O,F,n)},y.tsx("div",{key:this._buildKey("media-element-container",t),class:V},s,this._renderMediaInfo({mediaInfo:r[l],contentElementIndex:t,activeMediaIndex:l}),o)):null},t.prototype._renderLastEditInfo=function(){var e=this.visibleElements,t=this.viewModel.lastEditInfo;if(!t||!e.lastEditedInfo)return null;var i=t.date,r=t.user,a="edit"===t.type?r?o.lastEditedByUser:o.lastEdited:r?o.lastCreatedByUser:o.lastCreated,n=l.substitute(a,{date:i,user:r});return y.tsx("div",{key:"edit-info-element",class:this.classes(S,F)},n)},t.prototype._renderText=function(e,t){return e.text?y.tsx("div",{key:this._buildKey("text-element",t),innerHTML:e.text,afterCreate:this._addTargetToAnchors,class:this.classes(K,F)}):null},t.prototype._attachToNode=function(e){e.appendChild(this)},t.prototype._setContentElementMedia=function(e,t){this._clearMediaRefreshTimer(e);var i=this.viewModel.content,r=i&&i[e],a=r&&r.mediaInfos;if(a&&a.length){var n=(t+a.length)%a.length;this._activeMediaMap.set(e,n),this._setupMediaRefreshTimer(e),this.scheduleRender()}},t.prototype._pageContentElementMedia=function(e,t){var i="previous"===t?-1:1,r=this._activeMediaMap.get(e)+i;this._setContentElementMedia(e,r)},t.prototype._previousClick=function(e){var t=e.currentTarget["data-content-element-index"];this.previousMedia(t)},t.prototype._nextClick=function(e){var t=e.currentTarget["data-content-element-index"];this.nextMedia(t)},r([p.aliasOf("viewModel.graphic")],t.prototype,"graphic",void 0),r([p.aliasOf("viewModel.defaultPopupTemplateEnabled")],t.prototype,"defaultPopupTemplateEnabled",void 0),r([p.property()],t.prototype,"label",void 0),r([p.aliasOf("viewModel.spatialReference")],t.prototype,"spatialReference",void 0),r([p.aliasOf("viewModel.title")],t.prototype,"title",void 0),r([p.property(),y.renderable()],t.prototype,"visibleElements",void 0),r([p.cast("visibleElements")],t.prototype,"castVisibleElements",null),r([p.aliasOf("viewModel.map")],t.prototype,"map",void 0),r([p.aliasOf("viewModel.view")],t.prototype,"view",void 0),r([p.property({type:m}),y.renderable(["viewModel.waitingForContent","viewModel.content","viewModel.lastEditInfo"])],t.prototype,"viewModel",void 0),r([y.accessibleHandler()],t.prototype,"_previousClick",null),r([y.accessibleHandler()],t.prototype,"_nextClick",null),t=r([p.subclass("esri.widgets.Feature")],t)}(p.declared(f))}));