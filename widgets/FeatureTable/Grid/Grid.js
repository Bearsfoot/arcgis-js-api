// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/assignHelper","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","dojo/i18n!../../FeatureTable/nls/FeatureTable","../../../core/Collection","../../../core/events","../../../core/HandleOwner","../../../core/maybe","../../../core/watchUtils","../../../core/accessorSupport/decorators","../../Widget","./GridViewModel","../../support/widget","@dojo/framework/shim/Promise","./../../../libs/vaadin-grid/webcomponents"],(function(e,t,r,i,o,n,s,d,l,a,c,p,u,h,m){new Promise((function(t,r){e(["./../../../libs/vaadin-grid/index"],t,r)}));var f={selectionColumn:!0},v="esri-grid",g="esri-grid__content",y="esri-grid__grid",w="esri-widget";return function(e){function t(t){var i=e.call(this,t)||this;return i._grid=null,i.cellClassNameGenerator=null,i.columnReorderingEnabled=!0,i.dataProvider=null,i.label=n.widgetLabel,i.pageSize=50,i.selectedItems=new s,i.size=null,i.rowDetailsRenderer=null,i.store=null,i.viewModel=new h,i.visibleElements=r({},f),i}return i(t,e),t.prototype.postInitialize=function(){var e=this;this.handles.add([c.on(this,"viewModel.columns","change",(function(){return e.scheduleRender()})),c.watch(this,"viewModel.size",(function(){return e._updateGridSize()})),c.watch(this,"store.orderByFields",this._clearSelection)])},t.prototype.castVisibleElements=function(e){return r({},f,e)},t.prototype.render=function(){return m.tsx("div",{bind:this,class:this.classes(v,w)},m.tsx("div",{bind:this,class:g},this.renderGrid()))},t.prototype.renderGrid=function(){return m.tsx("vaadin-grid",r({},this.getGridProps()),this.renderAllColumns())},t.prototype.renderAllColumns=function(){if("disabled"!==this.viewModel.state&&this.columns&&this.columns.length)return[this.renderSelectionColumn(),this.renderColumns()]},t.prototype.renderSelectionColumn=function(){return m.tsx("vaadin-grid-selection-column",{bind:this,afterCreate:this._afterSelectionColumnCreate,hidden:!this.visibleElements.selectionColumn,sortable:!1,frozen:!m.isRTL()})},t.prototype.renderColumns=function(){var e=this;return this.columns.items.map((function(t,i){return m.tsx("vaadin-grid-column",r({},e.getColumnProps(t,i)))}))},t.prototype.getGridProps=function(){var e=this.columnReorderingEnabled,t=this.id,r=this.pageSize,i=this.size;return{class:y,id:t+"_grid",theme:"compact column-borders",ref:"grid",bind:this,afterCreate:this._afterGridCreate,afterUpdate:this._afterGridUpdate,columnReorderingAllowed:e,pageSize:r,size:i}},t.prototype.getColumnProps=function(e,t){var r=this.id,i=e.autoWidth,o=e.flexGrow,n=e.frozen,s=e.header,d=e.hidden,l=e.path,c=e.resizable,p=e.textAlign,u=e.width;return{autoWidth:i,flexGrow:o,frozen:n,header:s,hidden:d,key:r+"_"+name+"_"+(a.isSome(t)?t:l),path:l,resizable:c,"text-align":p,width:"number"==typeof u?u+"px":u,bind:this,afterCreate:this._afterColumnCreateOrUpdate,afterUpdate:this._afterColumnCreateOrUpdate}},t.prototype.clearSelection=function(){this._clearSelection(),this.scheduleRender()},t.prototype.findColumn=function(e){return this.viewModel&&this.viewModel.findColumn(e)},t.prototype.hideColumn=function(e){this.viewModel&&this.viewModel.hideColumn(e),this.scheduleRender()},t.prototype.showColumn=function(e){this.viewModel&&this.viewModel.showColumn(e),this.scheduleRender()},t.prototype.generateCellClassNames=function(){this._grid&&this._grid.generateCellClassNames()},t.prototype.refreshCache=function(){this._grid&&this._grid.clearCache()},t.prototype.refresh=function(){var e=this;this._clearSelection(),this.store&&(this.store.reset(),this.store.load().then((function(){return e.refreshCache()})))},t.prototype.recalculateColumnWidths=function(){this._grid&&this._grid.recalculateColumnWidths()},t.prototype.notifyResize=function(){this._grid&&this._grid.notifyResize()},t.prototype.sort=function(e){this._sort(e)},t.prototype.selectRow=function(e){var t=this.viewModel.getRowItemAt(e);t&&this._selectRowByItem(t)},t.prototype.deselectRow=function(e){var t=this.viewModel.getRowItemAt(e);t&&this._deselectRowByItem(t)},t.prototype._afterGridCreate=function(e){var t=this,r=this.cellClassNameGenerator,i=this.dataProvider,o=this.rowDetailsRenderer;e.cellClassNameGenerator=r,e.dataProvider=i,e.rowDetailsRenderer=o,this._grid=e,customElements.whenDefined("vaadin-grid").then((function(){t._appendStyles(),t._addGridEventListeners()}))},t.prototype._afterGridUpdate=function(e){this._grid||(this._grid=e)},t.prototype._afterColumnCreateOrUpdate=function(e){this._syncColumnRenderers(e)},t.prototype._afterSelectionColumnCreate=function(e){e.setAttribute("auto-select","true"),e.headerRenderer=function(e){e.innerHTML=null}},t.prototype._appendStyles=function(){var e=this._grid.shadowRoot,t=document.createElement("style");t.textContent='\n      :host { font-family: "Avenir Next W00", "Helvetica Neue", Helvetica, Arial, sans-serif !default; font-size: 1em; }\n      [part~="row"]:hover [part~="body-cell"] { background: #e8f1fe; }\n    ',e&&e.appendChild(t)},t.prototype._updateGridSize=function(){this._grid&&(this._grid.size=this.size||0,this.scheduleRender())},t.prototype._addGridEventListeners=function(){var e=this,t=this._grid;this.handles.add([d.on(t,"click",(function(t){return e._onRowClick(t)})),d.on(t,"selected-items-changed",(function(t){return e._onSelectionChange(t)})),d.on(t,"sorter-changed",(function(t){return e._syncSortProps(t)}))])},t.prototype._onRowClick=function(e){var t=this._grid.getEventContext(event),r=t.item,i=t.section;r&&i&&"details"!==i&&"header"!==i&&this.emit("row-click",{context:t,native:e})},t.prototype._selectRowByItem=function(e){this._grid&&this._grid.selectItem(e)},t.prototype._deselectRowByItem=function(e){this._grid&&this._grid.deselectItem(e)},t.prototype._clearSelection=function(){var e=this;this._grid&&this._grid.selectedItems&&(this._grid.selectedItems.slice().forEach((function(t){return e._deselectRowByItem(t)})),this._updateSelectionProps())},t.prototype._sort=function(e){var t=e.path,r=e.direction,i=this.viewModel.findColumn(t);i&&i.sortElement&&(r?i.sortElement.setAttribute("direction",r):i.sortElement.removeAttribute("direction"))},t.prototype._onSelectionChange=function(e){var t=e;if(this._updateSelectionProps(),"selectedItems.splices"===t.detail.path){var r=t.detail.value.indexSplices[0],i=r.removed,o=r.index,n=r.object;this.emit("selection-change",{index:o,added:n,removed:i})}},t.prototype._updateSelectionProps=function(){this.selectedItems.length&&this.selectedItems.removeAll(),this._grid&&this.selectedItems.addMany(this._grid.selectedItems)},t.prototype._syncSortProps=function(e){var t=e.target,r=t.direction,i=t.path;this.viewModel.sortColumn(i,r)},t.prototype._syncColumnRenderers=function(e){var t=e.path,r=this.viewModel.findColumn(t);r&&(r.renderFunction&&(e.renderer=function(e,t,i){return r.renderFunction({root:e,column:t,rowData:i})}),r.footerRenderFunction&&(e.footerRenderer=function(e,t){return r.footerRenderFunction({root:e,column:t})}),r.headerRenderFunction&&(e.headerRenderer=function(e,t){return r.headerRenderFunction({root:e,column:t})}))},o([p.property()],t.prototype,"_grid",void 0),o([p.aliasOf("viewModel.cellClassNameGenerator")],t.prototype,"cellClassNameGenerator",void 0),o([p.aliasOf("viewModel.columns")],t.prototype,"columns",void 0),o([p.aliasOf("viewModel.columnReorderingEnabled")],t.prototype,"columnReorderingEnabled",void 0),o([p.aliasOf("viewModel.dataProvider")],t.prototype,"dataProvider",void 0),o([p.property()],t.prototype,"label",void 0),o([p.aliasOf("viewModel.pageSize")],t.prototype,"pageSize",void 0),o([p.property({readOnly:!0}),m.renderable()],t.prototype,"selectedItems",void 0),o([p.aliasOf("viewModel.size")],t.prototype,"size",void 0),o([p.aliasOf("viewModel.rowDetailsRenderer")],t.prototype,"rowDetailsRenderer",void 0),o([p.aliasOf("viewModel.store")],t.prototype,"store",void 0),o([p.property(),m.renderable(["viewModel.cellClassNameGenerator","viewModel.columnReorderingEnabled","viewModel.columns","viewModel.dataProvider","viewModel.pageSize","viewModel.rowDetailsRenderer","viewModel.size","viewModel.state","viewModel.store"])],t.prototype,"viewModel",void 0),o([p.property(),m.renderable()],t.prototype,"visibleElements",void 0),o([p.cast("visibleElements")],t.prototype,"castVisibleElements",null),t=o([p.subclass("esri.widgets.FeatureTable.Grid.Grid")],t)}(p.declared(l.HandleOwnerMixin(u)))}));