// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","../../../core/tsSupport/generatorHelper","../../../core/tsSupport/awaiterHelper","../../../Graphic","../../../core/Accessor","../../../core/arrayUtils","../../../core/arrayUtils","../../../core/Collection","../../../core/Error","../../../core/lang","../../../core/Logger","../../../core/promiseUtils","../../../core/accessorSupport/decorators","../../../tasks/support/AttachmentQuery","../../../tasks/support/Query"],(function(e,t,r,n,o,i,u,a,s,p,c,h,l,y,d,f,g,_){var v="esri.widgets.FeatureTable.support.FeatureStore",m=y.getLogger(v);function b(e,t,r){m.error(new h(e,t,r))}return function(e){function t(t){var r=e.call(this,t)||this;return r._loaded=!1,r._loadError=!1,r._loading=!1,r._editOperationQueue=[],r._queryOperationQueue=[],r.attachmentsEnabled=!1,r.count=0,r.failures=new c,r.itemCache=new c,r.relatedRecordsEnabled=!1,r}return r(t,e),t.prototype.destroy=function(){this.layer=null,this.itemCache&&this.itemCache.destroy(),this.failures&&this.failures.destroy(),this._set("itemCache",null)},Object.defineProperty(t.prototype,"layer",{get:function(){return this._get("layer")||null},set:function(e){this._reset(),this._set("layer",e),this.notifyChange("state")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"orderByFields",{get:function(){return this._get("orderByFields")||[]},set:function(e){var t=this.orderByFields;p.equals(e,t)||(this.itemCache.removeAll(),this._set("orderByFields",e))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"querying",{get:function(){return this._queryOperationQueue.length>0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"state",{get:function(){var e=this.layer,t=this._loaded,r=this._loadError,n=this._loading;return r?"error":!e||this.get("layer.loadError")?"disabled":n?"loading":"loaded"===this.get("layer.loadStatus")&&t?"loaded":"ready"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"syncing",{get:function(){return this._editOperationQueue.length>0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"where",{get:function(){return this._get("where")||null},set:function(e){this._reset(),this._set("where",e),this.notifyChange("state")},enumerable:!0,configurable:!0}),t.prototype.load=function(){return i(this,void 0,void 0,(function(){var e,t;return o(this,(function(r){switch(r.label){case 0:if(this._reset(),!(e=this.layer))return[2,d.resolve()];this._loading=!0,this.notifyChange("state"),r.label=1;case 1:return r.trys.push([1,4,,5]),[4,e.when()];case 2:return r.sent(),[4,this._setCount()];case 3:return r.sent(),this._loading=!1,this._loaded=!0,this.notifyChange("state"),[3,5];case 4:throw t=r.sent(),this._reset(),this._loadError=!0,this.notifyChange("state"),b("store:load-error","An error ocurred.",{error:t}),t;case 5:return[2]}}))}))},t.prototype.query=function(e){return i(this,void 0,void 0,(function(){var t,r,n,i;return o(this,(function(o){switch(o.label){case 0:return r=(t=this).layer,n=t.state,r&&"loaded"===n?(this.notifyChange("querying"),[4,this._query(e)]):[2,d.resolve([])];case 1:return i=o.sent(),this.notifyChange("state"),[2,i]}}))}))},t.prototype.update=function(e){return i(this,void 0,void 0,(function(){return o(this,(function(t){return[2,this._update(e)]}))}))},t.prototype.reset=function(){this._reset()},t.prototype.getItemByObjectId=function(e){var t=this.itemCache,r=this.layer.objectIdField;return t.find((function(t){return t.feature.attributes[r]===e}))},t.prototype.getItemAt=function(e){return this.itemCache.getItemAt(e)},t.prototype.getIndexForObjectId=function(e){var t=this.itemCache,r=this.layer.objectIdField;return t.findIndex((function(t){return t.feature.attributes[r]===e}))},t.prototype._reset=function(){this.itemCache.removeAll(),this.failures.removeAll(),this._editOperationQueue=[],this._queryOperationQueue=[],this._loading=!1,this._loaded=!1,this._loadError=!1,this._set("count",0),this.notifyChange("querying"),this.notifyChange("syncing"),this.notifyChange("state")},t.prototype._getIdsFromFeatures=function(e){var t=this;return e.map((function(e){return e.attributes[t.layer.objectIdField]}))},t.prototype._toFeatureData=function(e,t){var r=this.layer.objectIdField;return e.map((function(e){var n=e.attributes[r];return{feature:e,attachments:t?t[n]:null,relatedRecords:null}}))},t.prototype._update=function(e){var t=this,r=this.layer;if(!r.capabilities.operations.supportsUpdate)return d.reject(new h("store:update-error","Update is not supported."));var n=e.objectId,o=e.name,i=e.value,a=this.getItemByObjectId(n).feature;if(!a)return d.reject(new h("store:update-error","Feature with provided 'objectId' not found."));var p=l.clone(a.attributes);p[o]=i;var c=new u({attributes:p}),y=r.applyEdits({updateFeatures:[c]}).then((function(e){var r=e.updateFeatureResults;return!s.find(r,(function(e){return!!e.error}))&&t._editOperationQueue.indexOf((function(){return y}))>-1&&r&&r.length&&(a.attributes=p),e}));return this._queueEditOperation((function(){return y}))},t.prototype._query=function(e){var t=this;return!0===e.refresh?(this.itemCache.removeAll(),this._setCount().then((function(){return t._queryFeatureData(e)}))):this._queryFeatureData(e)},t.prototype._queryFeatureData=function(e){return i(this,void 0,void 0,(function(){var t=this;return o(this,(function(r){return[2,this._queueQueryOperation((function(){return i(t,void 0,void 0,(function(){var t,r,n;return o(this,(function(o){switch(o.label){case 0:return[4,this._queryFeatures(e)];case 1:return t=o.sent().features,r=this._getIdsFromFeatures(t),[4,this._queryAttachments(r)];case 2:return n=o.sent(),[2,this._toFeatureData(t,n)||[]]}}))}))}))]}))}))},t.prototype._setCount=function(){var e=this;return this._queryCount().then((function(t){e._set("count",t)}))},t.prototype._queryCount=function(){return this.layer.queryFeatureCount(new _({returnGeometry:!1,where:this._getWhere()}))},t.prototype._queryFeatures=function(e){var t=this.layer,r=t.capabilities,n=r.operations.supportsQuery,o=r.query.supportsOrderBy;if(!n)return d.reject(new h("store:query-error","Layer does not support query operation."));var i=e.start,u=e.num,a=this.orderByFields,s=new _({returnGeometry:!1,outFields:["*"],start:i,num:u,where:this._getWhere()});return o&&(s.orderByFields=a),t.queryFeatures(s)},t.prototype._queryAttachments=function(e){var t=this.attachmentsEnabled,r=this.layer,n=this.where,o=r.capabilities,i=o.data.supportsAttachment,u=o.operations.supportsQueryAttachments;return t?i&&u?r.queryAttachments(new g({objectIds:e,where:n})):(b("store:query-error","Attachments are not supported."),d.resolve(null)):d.resolve(null)},t.prototype._queueQueryOperation=function(e){var t=this;return this._queryOperationQueue.push(e),this.notifyChange("querying"),e().then((function(r){return t._queryOperationQueue.indexOf(e)>-1?(t.itemCache.addMany(r),r):[]})).catch((function(r){b("store:query-error","An error ocurred.",{error:r});var n={error:r,retry:function(){t.failures.remove(n),t._queueQueryOperation(e)},cancel:function(){return t.failures.remove(n)}};return t.failures.add(n),[]})).then((function(r){return s.remove(t._queryOperationQueue,e),t.notifyChange("querying"),r}))},t.prototype._queueEditOperation=function(e){var t=this;return this._editOperationQueue.push(e),this.notifyChange("syncing"),e().then((function(e){var t=e.updateFeatureResults,r=s.find(t,(function(e){return!!e.error}));if(r)throw r.error})).catch((function(r){b("store:edit-error","An error ocurred.",{error:r});var n={error:r,retry:function(){t.failures.remove(n),t._queueEditOperation(e)},cancel:function(){return t.failures.remove(n)}};t.failures.add(n)})).then((function(){s.remove(t._editOperationQueue,e),t.notifyChange("syncing")}))},t.prototype._getWhere=function(){return this.where||this.layer.definitionExpression||"1=1"},n([f.property()],t.prototype,"attachmentsEnabled",void 0),n([f.property({readOnly:!0})],t.prototype,"count",void 0),n([f.property({readOnly:!0})],t.prototype,"failures",void 0),n([f.property({readOnly:!0})],t.prototype,"itemCache",void 0),n([f.property()],t.prototype,"layer",null),n([f.property()],t.prototype,"orderByFields",null),n([f.property({readOnly:!0})],t.prototype,"querying",null),n([f.property()],t.prototype,"relatedRecordsEnabled",void 0),n([f.property({readOnly:!0,dependsOn:["layer","layer.loadError","layer.loadStatus"]})],t.prototype,"state",null),n([f.property({readOnly:!0})],t.prototype,"syncing",null),n([f.property()],t.prototype,"where",null),t=n([f.subclass(v)],t)}(f.declared(a))}));