// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/declareExtendsHelper","../../core/tsSupport/decorateHelper","../../core/tsSupport/assignHelper","../../core/tsSupport/generatorHelper","../../core/tsSupport/awaiterHelper","../../core/arrayUtils","../../core/Collection","../../core/HandleOwner","../../core/watchUtils","../../core/accessorSupport/decorators","../../layers/FeatureLayer","./AttachmentsColumn","./FieldColumn","./Grid/Grid","./Grid/GridViewModel","./support/FeatureStore"],(function(e,t,r,n,o,a,i,s,l,d,u,c,p,h,f,y,m,g){return function(e){function t(t){var r=e.call(this,t)||this;r._defaultHiddenFields=["CreationDate","Creator","EditDate","Editor","GlobalID"],r.attachmentsEnabled=!1,r.cellClassNameGenerator=function(e,t){return e.path||null},r.dataProvider=function(e,t){return i(r,void 0,void 0,(function(){var r,n,o,i,s,l;return a(this,(function(a){switch(a.label){case 0:return r=this.store,n=e.page,o=e.pageSize,i=e.sortOrders,s=this._sortOrdersToLayerOrderByFields(i),t?r?[4,r.set({orderByFields:s})]:(t&&t([]),[2]):[2];case 1:return a.sent(),"loaded"===r.state||"loading"===r.state?[3,3]:[4,r.load()];case 2:a.sent(),a.label=3;case 3:return t?(l=t,[4,r.query({start:n*o,num:o})]):[3,5];case 4:l.apply(void 0,[a.sent()]),a.label=5;case 5:return[2]}}))}))},r.grid=new y({viewModel:r}),r.hiddenFields=new l,r.relatedRecordsEnabled=!1,r.store=new g;var n=r,o=n.attachmentsEnabled,s=n.relatedRecordsEnabled;return r.store.set({attachmentsEnabled:o,relatedRecordsEnabled:s}),r.hiddenFields.addMany(r._defaultHiddenFields),r.handles.add([u.watch(r,"attachmentsEnabled",(function(e){return r.store.attachmentsEnabled=e})),u.watch(r,"relatedRecordsEnabled",(function(e){return r.store.relatedRecordsEnabled=e})),u.watch(r,"layer.loaded",(function(e){return e&&r._generateColumns()})),u.watch(r,"layer.definitionExpression",(function(e,t){return(e||t)&&r.grid.refresh()}))]),r}return r(t,e),t.prototype.destroy=function(){this.handles.removeAll(),this.layer=null},Object.defineProperty(t.prototype,"fieldConfigs",{set:function(e){this._set("fieldConfigs",e),this.get("layer.loaded")&&this._generateColumns()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"layer",{set:function(e){this._set("layer",e),this.store.set("layer",e),this.store.load(),e&&e.load(),this.notifyChange("state")},enumerable:!0,configurable:!0}),t.prototype.getValue=function(e,t){var r=this.store.getItemByObjectId(e),n=r&&r.feature;return n&&n.attributes?n.attributes[t]:null},t.prototype.updateValue=function(e,t,r){return i(this,void 0,void 0,(function(){var n=this;return a(this,(function(o){return[2,this.store.update({objectId:e,name:t,value:r}).then((function(){return n.grid.refreshCache()}))]}))}))},t.prototype._generateColumns=function(){var e=this._createFieldColumns();this.attachmentsEnabled&&e.push(this._createAttachmentsColumn()),this.columns.removeAll(),e.length&&this.columns.addMany(e)},t.prototype._createFieldColumns=function(){return this.fieldConfigs&&this.fieldConfigs.length?this._createColumnsFromConfigs():this._createColumnsFromFields()},t.prototype._createColumnsFromConfigs=function(){var e=this.fieldConfigs,t=this.hiddenFields,r=this.layer,n=this.get("layer.fields")||[];return e.map((function(e){var o=s.find(n||[],(function(t){return e.name===t.name})),a=t.indexOf(o.name)>-1;return new f({direction:e?e.direction:null,hidden:a,config:e,field:o,layer:r})}))},t.prototype._createColumnsFromFields=function(){var e=this.hiddenFields,t=this.layer;return(this.get("layer.fields")||[]).map((function(r){var n=e.indexOf(r.name)>-1;return new f({config:null,hidden:n,field:r,layer:t})}))},t.prototype._createAttachmentsColumn=function(){return new h},t.prototype._sortOrdersToLayerOrderByFields=function(e){return e&&e.length?e.filter((function(e,t,r){return r.map((function(e){return e.path})).indexOf(e.path)===t})).map((function(e){var t=e.direction;return e.path+" "+t.toUpperCase()})):[]},n([c.property()],t.prototype,"attachmentsEnabled",void 0),n([c.property()],t.prototype,"cellClassNameGenerator",void 0),n([c.property()],t.prototype,"dataProvider",void 0),n([c.property()],t.prototype,"fieldConfigs",null),n([c.property({readOnly:!0})],t.prototype,"grid",void 0),n([c.property()],t.prototype,"hiddenFields",void 0),n([c.property({type:p})],t.prototype,"layer",null),n([c.property()],t.prototype,"relatedRecordsEnabled",void 0),n([c.property({type:g})],t.prototype,"store",void 0),t=n([c.subclass("esri.widgets.FeatureTable.FeatureTableViewModel")],t)}(c.declared(d.HandleOwnerMixin(m)))}));