// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","dojo/i18n!./Print/nls/Print","../core/Collection","../core/events","../core/Logger","../core/urlUtils","../core/watchUtils","../core/accessorSupport/decorators","../tasks/support/PrintTemplate","./Widget","./Print/FileLink","./Print/PrintViewModel","./Print/TemplateOptions","./support/widget"],(function(t,e,i,a,s,n,o,l,r,p,d,c,u,h,_,b,v){var y=n.ofType(h),x="esri-print esri-widget esri-widget--panel",f="esri-print__header-title",m="esri-print__input-text",g="esri-print__layout-tab-list",O="esri-print__layout-tab",w="esri-print__layout-section",T="esri-print__map-only-section",L="esri-print__scale-input",k="esri-print__loader",I="esri-print__advanced-options-button",M="esri-print__advanced-options-button-container",S="esri-print__advanced-options-button-title",F="esri-print__advanced-options-button-icon--opened",V="esri-print__advanced-options-button-icon--closed",C="esri-print__advanced-options-button-icon--closed-rtl",E="esri-print__refresh-button",P="esri-print__swap-button",N="esri-print__export-button",U="esri-print__form-section-container",A="esri-print__advanced-options-section",R="esri-print__advanced-options-container",D="esri-print__author-info-container",H="esri-print__copyright-info-container",q="esri-print__export-panel-container",Y="esri-print__export-title",z="esri-print__exported-file",K="esri-widget__anchor esri-print__exported-file-link",j="esri-print__exported-file-link-title",W="esri-print__height-container",B="esri-print__legend-info-container",G="esri-print__container",J="esri-print__panel-container",Q="esri-print__scale-info-container",X="esri-print__scale-input-container",Z="esri-print__size-container",$="esri-print__width-container",tt="esri-widget--button",et="esri-button",it="esri-select",at="esri-widget__heading",st="esri-input",nt="esri-widget__anchor--disabled",ot="esri-button--disabled",lt="esri-print__panel--error",rt="esri-print__exported-file--error",pt="esri-rotating",dt="esri-icon-download",ct="esri-icon-launch-link-external",ut="esri-icon-error",ht="esri-icon-right-triangle-arrow",_t="esri-icon-left-triangle-arrow",bt="esri-icon-down-arrow",vt="esri-icon-refresh",yt="esri-icon-loading-indicator",xt="esri-icon-swap",ft="esri-icon-printer",mt=l.getLogger("esri.widgets.Print");return function(t){function e(e){var i=t.call(this,e)||this;return i._activeTabFocusRequested=!1,i._advancedOptionsVisibleForLayout=!1,i._advancedOptionsVisibleForMapOnly=!1,i._awaitingServerResponse=!1,i._exportedFileNameMap={},i._layoutTabSelected=!0,i._pendingExportScroll=!1,i._rootNode=null,i.allowedFormats=null,i.allowedLayouts=null,i.exportedLinks=new y,i.iconClass=ft,i.label=s.widgetLabel,i.templateOptions=new b,i.printServiceUrl=null,i.view=null,i.viewModel=new _,i._focusOnTabChange=i._focusOnTabChange.bind(i),i}return i(e,t),e.prototype.postInitialize=function(){var t=this;this.own([p.init(this,"viewModel.templatesInfo",(function(e){var i=t.templateOptions,a=i.format,s=i.layout;if(e){var n=s===e.layout.defaultValue||s&&"MAP_ONLY"===s.toUpperCase()||e.layout.choiceList&&e.layout.choiceList.indexOf(s)>-1,o=a===e.format.defaultValue||e.format.choiceList&&e.format.choiceList.indexOf(a)>-1;n||(s&&mt.warn("User sets an invalid layout, resetting it to the default valid one..."),t.templateOptions.layout=e.layout.defaultValue),o||(a&&mt.warn("User sets an invalid format, resetting it to the default valid one..."),t.templateOptions.format=e.format.defaultValue),s&&"MAP_ONLY"===s.toUpperCase()&&(t._layoutTabSelected=!1)}})),p.init(this,"templateOptions.format",(function(e){var i=t.viewModel.templatesInfo;if(i&&e){var a=!1;i.format.choiceList&&i.format.choiceList.forEach((function(i){i.toUpperCase()===e.toUpperCase()&&(t.templateOptions.format=i,a=!0)})),a||(t.templateOptions.format=i.format.defaultValue,mt.warn("User sets an invalid format, resetting it to the default valid one...")),t.scheduleRender()}})),p.init(this,"templateOptions.layout",(function(e){var i=t.viewModel.templatesInfo;if(i&&e){t._layoutTabSelected="MAP_ONLY"!==e.toUpperCase();var a=!t._layoutTabSelected;a||i.layout.choiceList&&i.layout.choiceList.forEach((function(i){i.toUpperCase()===e.toUpperCase()&&(t.templateOptions.layout=i,a=!0)})),a||(t.templateOptions.layout=i.layout.defaultValue,mt.warn("User sets an invalid layout, resetting it to the default valid one...")),t.scheduleRender()}})),p.init(this,"templateOptions.dpi",(function(e){e<=0?t.templateOptions.dpi=1:t.scheduleRender()})),p.init(this,"viewModel.view.scale",(function(e){var i=t.templateOptions,a=i.scale;i.scaleEnabled&&a||(t.templateOptions.scale=e)})),p.whenOnce(this,"printServiceUrl",(function(){var e=setTimeout((function(){t._awaitingServerResponse=!0,t.scheduleRender()}),500);t.viewModel.load().then((function(){return clearTimeout(e)}))}))]);var e=this.templateOptions,i=e.height,a=e.width;this.templateOptions.width=a||800,this.templateOptions.height=i||1100},e.prototype.render=function(){var t,e=this.templateOptions,i=e.attributionEnabled,a=e.author,n=e.copyright,o=e.dpi,l=e.format,r=e.height,p=e.layout,d=e.legendEnabled,c=e.scaleEnabled,u=e.scale,h=e.width,_="ready"!==this.get("viewModel.state"),b=this.renderTitleOrFileNameSection(),y=this.get("viewModel.templatesInfo.format.choiceList")||[],k=y.length>0?y.map((function(t){var e=t===l;return v.tsx("option",{key:t,selected:e,value:t},t.toUpperCase())})):v.tsx("option",{key:"format-default-option"},s.formatDefaultOption),z=v.tsx("div",{class:U},v.tsx("label",null,s.fileFormatTitle,v.tsx("select",{class:it,onchange:this._updateFromOption,"data-target-property":"format",bind:this},k))),K=this.get("viewModel.templatesInfo.layout.choiceList")||[],j=K.length>0?K.map((function(t){var e=t===p,i=s[t]||t;return v.tsx("option",{key:t,selected:e,value:t},i)})):v.tsx("option",{key:"layout-default-option"},s.layoutDefaultOption),nt=v.tsx("div",{class:U},v.tsx("label",null,s.layoutTitle,v.tsx("select",{class:it,onchange:this._updateFromOption,"data-target-property":"layout",bind:this},j))),rt=v.tsx("div",{class:U},v.tsx("label",null,s.dpi,v.tsx("input",{type:"number",class:this.classes(m,st),"data-input-name":"dpi",oninput:this._updateInputValue,value:""+o,min:"1",tabIndex:0,bind:this}))),pt=v.tsx("div",{class:this.classes(Q,U)},v.tsx("label",null,v.tsx("input",{"data-option-name":"scaleEnabled",checked:c,type:"checkbox",tabIndex:0,onchange:this._toggleInputValue,bind:this}),s.scale),v.tsx("div",{class:X},v.tsx("input",{"aria-label":s.scaleLabel,"aria-valuenow":""+u,role:"spinbutton",type:"number",class:this.classes(m,st,L),tabIndex:0,"data-input-name":"scale",oninput:this._updateInputValue,disabled:!c,value:""+u,bind:this}),v.tsx("button",{role:"button","aria-label":s.reset,class:this.classes(tt,E,vt),tabIndex:0,onclick:this._resetToCurrentScale,bind:this}))),dt=this._advancedOptionsVisibleForLayout?v.tsx("div",{"aria-labelledby":this.id+"__advancedOptionsForLayout",class:R},pt,v.tsx("div",{class:this.classes(D,U)},v.tsx("label",null,s.author,v.tsx("input",{type:"text",value:a,class:this.classes(m,st),tabIndex:0,"data-input-name":"author",oninput:this._updateInputValue,bind:this}))),v.tsx("div",{class:this.classes(H,U)},v.tsx("label",null,s.copyright,v.tsx("input",{type:"text",class:this.classes(m,st),tabIndex:0,value:n,"data-input-name":"copyright",oninput:this._updateInputValue,bind:this}))),rt,v.tsx("div",{class:this.classes(B,U)},v.tsx("label",null,v.tsx("input",{type:"checkbox","data-option-name":"legendEnabled",tabIndex:0,checked:d,onchange:this._toggleInputValue,bind:this}),s.legend))):null,ct=this._advancedOptionsVisibleForMapOnly?v.tsx("div",{"aria-labelledby":this.id+"__advancedOptionsForMapOnly",class:R},pt,rt,v.tsx("div",{class:U},v.tsx("label",null,v.tsx("input",{"data-option-name":"attributionEnabled",type:"checkbox",onchange:this._toggleInputValue,tabIndex:0,checked:i,bind:this}),s.attribution))):null,ut=this._layoutTabSelected?v.tsx("section",{key:"esri-print__layoutContent",id:this.id+"__layoutContent","aria-labelledby":this.id+"__layoutTab",class:w,role:"tabpanel","aria-selected":this._layoutTabSelected},v.tsx("div",{class:J},b,nt,this._layoutTabSelected?z:null),v.tsx("div",{class:this.classes(J,A)},v.tsx("button",{"aria-label":s.advancedOptions,"aria-expanded":this._advancedOptionsVisibleForLayout?"true":"false",role:"button",class:I,onclick:this._showAdvancedOptions,bind:this},v.tsx("div",{class:M},v.tsx("span",{"aria-hidden":"true",class:this.classes(ht,V)}),v.tsx("span",{"aria-hidden":"true",class:this.classes(_t,C)}),v.tsx("span",{"aria-hidden":"true",class:this.classes(bt,F)}),v.tsx("span",{class:S},s.advancedOptions))),dt)):v.tsx("section",{key:"esri-print__mapOnlyContent",id:this.id+"__mapOnlyContent","aria-selected":!this._layoutTabSelected,"aria-labelledby":this.id+"__mapOnlyTab",class:T,role:"tabpanel"},v.tsx("div",{class:J},b,this._layoutTabSelected?null:z,v.tsx("div",{class:this.classes(Z,U)},v.tsx("div",{class:$},v.tsx("label",null,s.width,v.tsx("input",{type:"text",class:this.classes(m,st),"data-input-name":"width",onchange:this._updateInputValue,value:""+h,tabIndex:0,bind:this}))),v.tsx("div",{class:W},v.tsx("label",null,s.height,v.tsx("input",{type:"text",class:this.classes(m,st),"data-input-name":"height",onchange:this._updateInputValue,value:""+r,tabIndex:0,bind:this}))),v.tsx("button",{role:"button","aria-label":s.swap,class:this.classes(tt,P,xt),onclick:this._switchInput,tabIndex:0,bind:this})),v.tsx("div",{class:this.classes(J,A)},v.tsx("button",{"aria-label":s.advancedOptions,"aria-expanded":this._advancedOptionsVisibleForMapOnly?"true":"false",role:"button",class:I,onclick:this._showAdvancedOptions,bind:this},v.tsx("div",{class:M},v.tsx("span",{"aria-hidden":"true",class:this.classes(ht,V)}),v.tsx("span",{"aria-hidden":"true",class:this.classes(_t,C)}),v.tsx("span",{"aria-hidden":"true",class:this.classes(bt,F)}),v.tsx("span",{class:S},s.advancedOptions))),ct))),yt=this.exportedLinks.toArray(),ft=this._renderExportedLink(yt),mt=((t={})[ot]=_||!p&&!l,t),gt=null!=this.get("view")&&"2d"!==this.get("view.type"),Ot=v.tsx("div",{class:lt},gt?s.sceneViewError:s.serviceError),wt=v.tsx("div",null,v.tsx("ul",{class:g,role:"tablist",onclick:this._toggleLayoutPanel,onkeydown:this._handleLayoutPanelKeyDown,bind:this},v.tsx("li",{afterCreate:this._focusOnTabChange,afterUpdate:this._focusOnTabChange,id:this.id+"__layoutTab","data-tab-id":"layoutTab",class:O,role:"tab",tabIndex:0,"aria-selected":""+this._layoutTabSelected},s.layoutTab),v.tsx("li",{afterCreate:this._focusOnTabChange,afterUpdate:this._focusOnTabChange,id:this.id+"__mapOnlyTab","data-tab-id":"mapOnlyTab",class:O,role:"tab",tabIndex:0,"aria-selected":""+!this._layoutTabSelected},s.mapOnlyTab)),ut,v.tsx("button",{"aria-label":s.exportDescription,role:"button",class:this.classes(N,et,mt),disabled:_,tabIndex:0,onclick:this._handlePrintMap,bind:this},s.export),v.tsx("div",{class:q,afterUpdate:this._scrollExportIntoView,onclick:this._removeLink,bind:this},v.tsx("h3",{class:this.classes(Y,at)},s.exportText),yt.length>0?null:v.tsx("div",null,v.tsx("div",null,s.exportHint)),ft)),Tt=v.tsx("div",null,v.tsx("div",{class:G},v.tsx("header",{class:f},s.export),this.error||!this.printServiceUrl||gt||!this.view?Ot:wt)),Lt="initializing"===this.get("viewModel.state")?this._renderLoader():Tt;return v.tsx("div",{afterCreate:v.storeNode,bind:this,class:x,"data-node-ref":"_rootNode"},Lt)},e.prototype.renderTitleOrFileNameSection=function(){var t,e,i,a,n=this.templateOptions;return this._layoutTabSelected?(t=s.title,e=s.titlePlaceHolder,i=n.title,a="title"):(t=s.fileName,e=s.fileNamePlaceHolder,i=n.fileName,a="fileName"),v.tsx("div",{class:U,key:a},v.tsx("label",null,t,v.tsx("input",{type:"text",tabIndex:0,placeholder:e,class:this.classes(m,st),value:i,"data-input-name":a,oninput:this._updateInputValue,bind:this})))},e.prototype._focusOnTabChange=function(t){if(this._activeTabFocusRequested){var e=t.getAttribute("data-tab-id");("layoutTab"===e&&this._layoutTabSelected||"mapOnlyTab"===e&&!this._layoutTabSelected)&&(t.focus(),this._activeTabFocusRequested=!1)}},e.prototype._renderLoader=function(){var t,e=((t={})[k]=this._awaitingServerResponse,t);return v.tsx("div",{class:this.classes(e),key:"loader"})},e.prototype._createFileLink=function(t,e){var i=e||s.untitled,a=t.format.toLowerCase(),n=a.indexOf("png")>-1?"png":a,o=i+n;return void 0!==this._exportedFileNameMap[o]?this._exportedFileNameMap[o]++:this._exportedFileNameMap[o]=0,new h({name:i,extension:n,count:this._exportedFileNameMap[o]})},e.prototype._toPrintTemplate=function(t){var e=t.attributionEnabled,i=t.author,a=t.copyright,s=t.dpi,n=t.forceFeatureAttributes,o=t.format,l=t.height,r=t.layout,p=t.legendEnabled,d=t.title,u=t.scale,h=t.width,_=new c({attributionVisible:e,layoutOptions:{authorText:i||"",copyrightText:a||"",titleText:d||""},forceFeatureAttributes:n,format:o,layout:r,outScale:u});return h&&(_.exportOptions.width=h),l&&(_.exportOptions.height=l),s&&(_.exportOptions.dpi=s),p||(_.layoutOptions.legendLayers=[]),_},e.prototype._resetToCurrentScale=function(){this.templateOptions.scale=this.viewModel.view.scale},e.prototype._updateInputValue=function(t){var e=t.target,i=e.getAttribute("data-input-name");this.templateOptions[i]=e.value},e.prototype._handlePrintMap=function(){var t=this;this._pendingExportScroll=!0;var e=this.templateOptions,i=this._toPrintTemplate(e),a=this._layoutTabSelected?i.layoutOptions.titleText:e.fileName,s=this._createFileLink(i,a);this.exportedLinks.add(s),this.viewModel.print(i).then((function(t){s.set({url:t&&t.url,state:"ready"})})).catch((function(){s.set({state:"error"})})).then((function(){return t.scheduleRender()}))},e.prototype._updateFromOption=function(t){var e=t.target,i=e.selectedOptions?e.selectedOptions.item(0).value:e.options[e.selectedIndex].value,a=e.getAttribute("data-target-property");this.templateOptions[a]=i},e.prototype._switchInput=function(){var t;t=[this.templateOptions.height,this.templateOptions.width],this.templateOptions.width=t[0],this.templateOptions.height=t[1]},e.prototype._showAdvancedOptions=function(){this._layoutTabSelected?this._advancedOptionsVisibleForLayout=!this._advancedOptionsVisibleForLayout:this._advancedOptionsVisibleForMapOnly=!this._advancedOptionsVisibleForMapOnly},e.prototype._scrollExportIntoView=function(){if(this._pendingExportScroll){this._pendingExportScroll=!1;var t=this._rootNode,e=this._rootNode,i=e.clientHeight,a=e.scrollHeight-i;a>0&&(t.scrollTop=a)}},e.prototype._toggleInputValue=function(t){var e=t.target,i=e.getAttribute("data-option-name");this.templateOptions[i]=e.checked,"scaleEnabled"===i&&(this.viewModel.scaleEnabled=this.templateOptions.scaleEnabled,this.templateOptions[i]||this._resetToCurrentScale())},e.prototype._removeLink=function(t){var e=t.target["data-item"];e&&"error"===e.state&&this.exportedLinks.remove(e)},e.prototype._renderExportedLink=function(t){var e=this;return t.map((function(t){var i,a,n,o=((i={})[nt]="pending"===t.state||"error"===t.state,i),l=""===t.url?null:t.url;l&&(l=r.addProxy(l));var p,d=r.hasSameOrigin(t.url,location.href),c=((a={})[yt]="pending"===t.state,a[pt]="pending"===t.state,a[dt]=d&&"ready"===t.state,a[ct]=!d&&"ready"===t.state,a[ut]="error"===t.state,a[rt]="error"===t.state,a),u=((n={})[rt]="error"===t.state,n);return p="pending"===t.state?s.pending:"ready"===t.state?s.ready:s.error,v.tsx("div",{"aria-label":p,key:t.formattedName,class:z},v.tsx("a",{"aria-label":t.formattedName+". "+s.linkReady,download:t.formattedName,href:l,rel:"noreferrer",tabIndex:0,target:"_blank",class:e.classes(K,o)},v.tsx("span",{"data-item":t,class:e.classes(c)}),v.tsx("span",{"data-item":t,class:e.classes(j,u)},t.formattedName)))}))},e.prototype._toggleLayoutPanel=function(t){var e=t.target;this._toggleTab(e.getAttribute("data-tab-id"))},e.prototype._toggleTab=function(t){if(this._layoutTabSelected="layoutTab"===t,this._layoutTabSelected){var e=this.get("viewModel.templatesInfo.layout.choiceList");this.templateOptions.layout=e&&e[0]}else this.templateOptions.layout="MAP_ONLY";this._activeTabFocusRequested=!0},e.prototype._handleLayoutPanelKeyDown=function(t){var e=o.eventKey(t),i=t.target.getAttribute("data-tab-id");if("Enter"===e||" "===e)return this._toggleTab(i),t.preventDefault(),void t.stopPropagation();"ArrowLeft"!==e&&"ArrowRight"!==e||(this._toggleTab("layoutTab"===i?"mapOnlyTab":"layoutTab"),t.preventDefault(),t.stopPropagation())},a([d.aliasOf("viewModel.allowedFormats")],e.prototype,"allowedFormats",void 0),a([d.aliasOf("viewModel.allowedLayouts")],e.prototype,"allowedLayouts",void 0),a([d.property({type:y}),v.renderable()],e.prototype,"exportedLinks",void 0),a([d.property()],e.prototype,"iconClass",void 0),a([d.property()],e.prototype,"label",void 0),a([v.renderable(),d.property({type:b})],e.prototype,"templateOptions",void 0),a([d.aliasOf("viewModel.error")],e.prototype,"error",void 0),a([d.aliasOf("viewModel.printServiceUrl")],e.prototype,"printServiceUrl",void 0),a([d.aliasOf("viewModel.view"),v.renderable()],e.prototype,"view",void 0),a([d.property({type:_}),v.renderable(["viewModel.templatesInfo","viewModel.state"])],e.prototype,"viewModel",void 0),e=a([d.subclass("esri.widgets.Print")],e)}(d.declared(u))}));