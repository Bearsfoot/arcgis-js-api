// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/decorateHelper","../core/tsSupport/declareExtendsHelper","../core/tsSupport/assignHelper","dojo/i18n!./ScaleRangeSlider/nls/ScaleRangeSlider","../intl","../core/domUtils","../core/events","../core/HandleOwner","../core/watchUtils","../core/accessorSupport/decorators","./Slider","./Widget","./ScaleRangeSlider/scalePreviewUtils","./ScaleRangeSlider/ScaleRanges","./ScaleRangeSlider/ScaleRangeSliderViewModel","./support/Popover","./support/widget"],(function(e,t,l,a,n,i,r,o,s,c,u,d,p,m,v,S,_,h,g){var f="esri-scale-range-slider",M="esri-scale-range-slider__scale-indicator",y="esri-scale-range-slider__scale-indicator-icon",w="esri-scale-range-slider__scale-indicator-container",b="esri-scale-range-slider__scale-menu-container",x="esri-scale-range-slider__scale-menu-toggle",T="esri-scale-range-slider__scale-menu-toggle-icon",R="esri-scale-range-slider__scale-menu-toggle--active",C="esri-scale-range-slider__scale-menu",I="esri-scale-range-slider__scale-menu-list",P="esri-scale-range-slider__scale-menu-item",L="esri-scale-range-slider__scale-menu-scroller",k="esri-scale-range-slider__scale-item-label",N="esri-scale-range-slider__scale-item-value",O="esri-scale-range-slider__scale-item-value--editable",A="esri-scale-range-slider__scale-preview",E="esri-scale-range-slider__scale-preview-thumbnail",V="esri-icon-down",D="esri-disabled",F="esri-widget",B={preview:!0},H={maximumFractionDigits:0},K=function(e){return"1:"+r.formatNumber(e,H)};return function(e){function t(t){var l=e.call(this,t)||this;return l._activeMenu=null,l._activeMenuNode=null,l._activeMenuToggleNode=null,l._activeThumb=null,l._customMaxScale=-1,l._customMinScale=-1,l._focusedMenuItemIndex=-1,l._previewAutoCloseTimeoutId=null,l._previewPopover=new h({owner:l,placement:"top",anchorElement:function(){return 0===l._activeThumb?l._minThumbNode:l._maxThumbNode},renderContentFunction:l.renderScalePreview}),l._maxScaleMenuPopover=new h({owner:l,placement:"bottom-end",anchorElement:function(){return l._activeMenuToggleNode},renderContentFunction:l.renderMaxScaleMenu}),l._minScaleMenuPopover=new h({owner:l,placement:"bottom-start",anchorElement:function(){return l._activeMenuToggleNode},renderContentFunction:l.renderMinScaleMenu}),l._scaleMenuNode=null,l._slider=new p({thumbCreatedFunction:function(e,t,a){0===e&&(l._minThumbNode=a),1===e&&(l._maxThumbNode=a),l.own([s.on(a,"mouseenter",(function(){var t=l.visibleElements.preview;l._activeThumb=e,l._previewPopover.open=t,l.scheduleRender()})),s.on(a,"mouseleave",(function(){l._previewAutoCloseTimeoutId||(l._activeThumb=null,l._previewPopover.open=!1,l.scheduleRender())}))])}}),l.disabled=!1,l.label=i.widgetLabel,l.layer=null,l.maxScale=null,l.maxScaleLimit=null,l.minScale=null,l.minScaleLimit=null,l.region="US",l.view=null,l.viewModel=new _,l.visibleElements=B,l._handleScaleMenuToggleClick=function(e){var t=e.currentTarget,a=t.getAttribute("data-type"),n="menu-closing-click-handle";if(l.handles.remove(n),a===l._activeMenu)return l._setActiveMenu(null),void(l._activeMenuToggleNode=null);l._setActiveMenu(a),l._activeMenuToggleNode=t,l.handles.add(s.on(document,"mousedown",(function(e){var t=e.target,a=o.closest(t,"."+x),i=a&&a.getAttribute("data-type");a&&i===l._activeMenu||!i&&l._scaleMenuNode&&!l._scaleMenuNode.contains(t)&&(l._setActiveMenu(null),l.handles.remove(n),l.scheduleRender())})),n)},l._afterMenuListCreate=function(e){l._activeMenuNode=e,e.children[0].focus({preventScroll:!0})},l._handleCustomScaleEntry=function(e){l._setScaleFromMenuSelection(e),l._customMaxScale=-1,l._customMinScale=-1},l._handleCustomScaleInputBlur=function(){"max"===l._activeMenu?l._customMaxScale=-1:l._customMinScale=-1},l.handleCustomScaleInputKeyDown=function(e){var t,a,n=e.currentTarget,i=n["data-render-props"].handleCustomScaleSelect,r=e.key,o=e.ctrlKey,s=e.metaKey,c=l.viewModel.scaleRanges;if("Enter"===r){var u=(t=n.value,a=t.replace(/.*\(/,"").replace(/\).*$/,"").replace(/.*:/,"").replace(/[^\d.\s]/g,""),parseFloat(a));return i(isNaN(u)?-1:c.clampScale(u)),e.preventDefault(),void e.stopPropagation()}if(!(r.length>1||o||s)){/[:,.\d]/.test(r)||(e.preventDefault(),e.stopPropagation())}},l._handleScaleMenuKeyDown=function(e){var t=s.eventKey(e);if("Escape"===t||"Tab"===t)return l._setActiveMenu(null),void l._activeMenuToggleNode.focus();if("ArrowUp"===t||"ArrowDown"===t){var a=l._activeMenuNode.children,n=l._focusedMenuItemIndex,i="ArrowUp"===t?(0===n?a.length:n)-1:(n+1)%a.length;e.preventDefault(),e.stopPropagation(),a[i].focus(),l._focusedMenuItemIndex=i}},l}return a(t,e),t.prototype.postInitialize=function(){var e=this;this.own([u.init(this,"viewModel",(function(t){return e._slider.viewModel=t?t.sliderViewModel:null})),u.init(this,"_interactive",(function(t){e._slider.disabled=!t,t||e._setActiveMenu(null)})),this._slider.on("thumb-drag",(function(t){var l=t.index,a=e.visibleElements.preview;e._activeThumb=l,e._previewPopover.open=a,clearTimeout(e._previewAutoCloseTimeoutId);e._previewAutoCloseTimeoutId=setTimeout((function(){e._previewAutoCloseTimeoutId=null,e._activeThumb=null,e._previewPopover.open=!1,e.scheduleRender()}),250)})),u.whenTrue(this,"view.stationary",(function(){return e.scheduleRender()}))])},t.prototype.destroy=function(){this._previewPopover.destroy(),this._previewPopover=null,this._maxScaleMenuPopover.destroy(),this._maxScaleMenuPopover=null,this._minScaleMenuPopover.destroy(),this._minScaleMenuPopover=null,this._slider.destroy(),this._slider=null},Object.defineProperty(t.prototype,"_effectiveMaxScale",{get:function(){return 0===this.maxScale?this.maxScaleLimit:this.maxScale},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"_effectiveMinScale",{get:function(){return 0===this.minScale?this.minScaleLimit:this.minScale},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"_interactive",{get:function(){return"disabled"!==this.get("viewModel.state")&&!this.disabled},enumerable:!0,configurable:!0}),t.prototype.castVisibleElements=function(e){return n({},B,e)},t.prototype.render=function(){var e=this,t=e._interactive,l=e._slider,a=e.label,n=e.view,r=e.viewModel,o=r.scaleRanges,s=r.state,c=i.scaleRangeLabels[o.findScaleRangeByIndex(l.values[0]).id],u=i.scaleRangeLabels[o.findScaleRangeByIndex(l.values[1]).id];return l.layout=g.isRTL()?"horizontal-reversed":"horizontal",g.tsx("div",{"aria-label":a,class:this.classes(f,F,t?null:D)},"ready"===s&&n?this.renderCurrentScaleIndicator():null,l.render(),g.tsx("div",{class:b,key:"scale-menu-toggles"},this.renderScaleMenuToggle("min",c),this.renderScaleMenuToggle("max",u)))},t.prototype.renderMinScaleMenu=function(){var e=this._effectiveMaxScale,t=this.minScaleLimit,l=this.view,a=this.viewModel.scaleRanges,n=l?l.scale:void 0;return this.renderScaleMenu({type:"min",min:t,max:a.findScaleRange(e).minScale,map:n})},t.prototype.renderMaxScaleMenu=function(){var e=this._effectiveMinScale,t=this.maxScaleLimit,l=this.view,a=this.viewModel.scaleRanges,n=l?l.scale:void 0;return this.renderScaleMenu({type:"max",min:a.findScaleRange(e).maxScale,max:t,map:n})},t.prototype.renderScalePreview=function(){var e=this._activeThumb,t=this._slider,l=this.region,a=this.viewModel.scaleRanges,n=0===e?t.values[0]:t.values[1],i=Object.keys(S.RecommendedScales).indexOf(a.findScaleRangeByIndex(n).id),r={backgroundImage:v.getScalePreviewSource(l),backgroundPosition:v.getScalePreviewSpriteBackgroundPosition(i)};return g.tsx("div",{class:A},g.tsx("div",{class:E,styles:r}))},t.prototype.renderScaleMenu=function(e){var t=this,l=e.map,a=e.min,n=e.max,r=e.type,o=S.fromScaleRange({minScale:a,maxScale:n}),s=i.featuredScaleLabels,c=S.RecommendedScales,u=Object.keys(c).filter((function(e){return o.contains(c[e])})).map((function(e){return t.renderScaleMenuItem({scaleLabel:s[e],scaleValue:c[e],valueVisible:"world"!==e,handleNamedScaleSelect:t._handleRecommendedScaleClick})})),d=this._customMaxScale,p=this._customMinScale,m="max"===r?d:p;return g.tsx("div",{bind:this,class:C,"data-type":r,id:this.id+"__scale-menu--"+r,key:r+"-scale-menu",afterCreate:g.storeNode,"data-node-ref":"_scaleMenuNode",onkeydown:this._handleScaleMenuKeyDown},g.tsx("div",{class:L},g.tsx("ul",{class:I,afterCreate:this._afterMenuListCreate},this.renderScaleMenuItem({scaleValue:m,scaleLabel:i.featuredScaleLabels.custom,valueVisible:!1,handleNamedScaleSelect:this._handleScaleSelection,handleCustomScaleSelect:this._handleCustomScaleEntry}),null!=l?this.renderScaleMenuItem({scaleValue:l,scaleLabel:i.featuredScaleLabels.current,valueVisible:!0,handleNamedScaleSelect:this._handleRecommendedScaleClick}):null,u)))},t.prototype._handleScaleSelection=function(){"max"===this._activeMenu?this._customMaxScale=this._effectiveMaxScale:this._customMinScale=this._effectiveMinScale},t.prototype.renderScaleMenuToggle=function(e,t){var l=this._activeMenu,a=this._interactive,n=l===e;return g.tsx("button",{"aria-controls":n?this.id+"__scale-menu--"+e:"","aria-pressed":n?"true":"false",class:this.classes(x,n?R:null),"data-type":e,key:e+"-scale-menu-toggle",onclick:this._handleScaleMenuToggleClick,disabled:!a},t,g.tsx("span",{class:this.classes(T,V),"aria-hidden":"true"}))},t.prototype.renderScaleMenuItem=function(e){var t=e.scaleValue,l=e.scaleLabel,a=e.valueVisible,n=e.handleNamedScaleSelect,i=e.handleCustomScaleSelect,r=void 0===i?null:i,o=this.id+"__custom-scale-input";return g.tsx("li",{bind:this,class:P,"data-scale":t,key:l,onclick:n,onkeydown:n,tabIndex:-1},g.tsx("label",{class:k,for:o},l),t>-1?r?g.tsx("input",{afterCreate:this.focusAndSelectInputOnCreate,class:this.classes(N,O),"data-render-props":e,id:o,key:"value",value:K(t),onkeydown:this.handleCustomScaleInputKeyDown,onblur:this._handleCustomScaleInputBlur}):a?g.tsx("div",{class:N,key:"value"},K(t)):null:null)},t.prototype.focusAndSelectInputOnCreate=function(e){e.focus(),e.select()},t.prototype.renderCurrentScaleIndicator=function(){var e=this._slider,t=this.view,l=this.viewModel.scaleRanges,a=l.clampScale(t.scale),n=this.viewModel.mapScaleToSlider(a),o=n/e.max,s=i.scaleRangeLabels[l.findScaleRangeByIndex(n).id],c=r.substitute(i.currentScaleTooltip,{scaleLabel:s});return g.tsx("div",{class:w,key:"scale-indicator"},g.tsx("div",{"aria-label":c,class:M,styles:{left:(g.isRTL()?-1:1)*o*100+"%"},title:c},this.renderCurrentScaleIndicatorIcon()))},t.prototype.renderCurrentScaleIndicatorIcon=function(){return g.tsx("svg",{class:y,height:"8",width:"8",viewBox:"0 0 8 8",version:"1.1",xmlns:"http://www.w3.org/2000/svg"},g.tsx("polygon",{points:"4 0 8 8 0 8"}))},t.prototype._handleRecommendedScaleClick=function(e){var t=e.currentTarget,l=Number(t["data-scale"]);this._setScaleFromMenuSelection(l)},t.prototype._setScaleFromMenuSelection=function(e){"max"===this._activeMenu?this.maxScale=Math.min(e,this._effectiveMinScale-1):this.minScale=Math.max(e,this._effectiveMaxScale+1),this._setActiveMenu(null)},t.prototype._setActiveMenu=function(e){this._activeMenu=e,this._maxScaleMenuPopover.open="max"===e,this._minScaleMenuPopover.open="min"===e,this._focusedMenuItemIndex=e?0:-1},l([d.property()],t.prototype,"_slider",void 0),l([d.property({dependsOn:["viewModel.maxScaleLimit","viewModel.maxScale"]})],t.prototype,"_effectiveMaxScale",null),l([d.property({dependsOn:["viewModel.minScaleLimit","viewModel.minScale"]})],t.prototype,"_effectiveMinScale",null),l([d.property({dependsOn:["disabled","viewModel.state"],readOnly:!0})],t.prototype,"_interactive",null),l([d.property(),g.renderable()],t.prototype,"disabled",void 0),l([d.property()],t.prototype,"label",void 0),l([d.property({aliasOf:"viewModel.layer"})],t.prototype,"layer",void 0),l([d.property({aliasOf:"viewModel.maxScale"})],t.prototype,"maxScale",void 0),l([d.property({aliasOf:"viewModel.maxScaleLimit"})],t.prototype,"maxScaleLimit",void 0),l([d.property({aliasOf:"viewModel.minScale"})],t.prototype,"minScale",void 0),l([d.property({aliasOf:"viewModel.minScaleLimit"})],t.prototype,"minScaleLimit",void 0),l([d.property(),g.renderable()],t.prototype,"region",void 0),l([d.property({aliasOf:"viewModel.view"})],t.prototype,"view",void 0),l([d.property(),g.renderable("viewModel.state")],t.prototype,"viewModel",void 0),l([d.property(),g.renderable()],t.prototype,"visibleElements",void 0),l([d.cast("visibleElements")],t.prototype,"castVisibleElements",null),l([g.accessibleHandler()],t.prototype,"_handleScaleMenuToggleClick",void 0),l([g.accessibleHandler()],t.prototype,"_handleScaleSelection",null),l([g.accessibleHandler()],t.prototype,"_handleRecommendedScaleClick",null),t=l([d.subclass("esri.widgets.ScaleRangeSlider")],t)}(d.declared(c.HandleOwnerMixin(m)))}));