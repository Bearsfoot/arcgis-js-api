// COPYRIGHT © 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","../core/tsSupport/assignHelper","dojo/i18n!../nls/common","dojo/i18n!./TimeSlider/nls/TimeSlider","../TimeInterval","../core/arrayUtils","../core/Collection","../core/compilerUtils","../core/Error","../core/events","../core/mathUtils","../core/maybe","../core/throttle","../core/accessorSupport/decorators","../intl/date","../layers/support/timeUtils","./Slider","./Widget","./TimeSlider/TimeSliderViewModel","./support/widget"],(function(e,t,i,n,r,s,a,o,l,u,m,c,d,v,p,f,h,w,y,_,x,b,g){var k="esri-icon-time-clock",T="esri-widget",S="esri-widget--button",j="esri-button--disabled",M="esri-time-slider",E="esri-time-slider__mode--",D="esri-time-slider__layout--",O="esri-time-slider__row",C="esri-time-slider__animation",V="esri-time-slider__animation-button",F="esri-icon-play",H="esri-icon-pause",R="esri-time-slider__time-extent",I="esri-time-slider__time-extent-group",L="esri-time-slider__time-extent-date",U="esri-time-slider__time-extent-time",P="esri-time-slider__time-extent-separator",W="esri-time-slider__min",q="esri-time-slider__min-date",z="esri-time-slider__slider",A="majorTick",N="minorTick",B="esri-time-slider__max",G="esri-time-slider__max-date",J="esri-time-slider__previous",K="esri-time-slider__previous-button",Q="esri-icon-reverse",X="esri-time-slider__next",Y="esri-time-slider__next-button",Z="esri-icon-forward",$=new u([{minor:new o({value:100,unit:"milliseconds"}),major:new o({value:1,unit:"seconds"}),format:{second:"numeric"}},{minor:new o({value:500,unit:"milliseconds"}),major:new o({value:5,unit:"seconds"}),format:{second:"numeric"}},{minor:new o({value:1,unit:"seconds"}),major:new o({value:20,unit:"seconds"}),format:{minute:"numeric",second:"numeric"}},{minor:new o({value:2,unit:"seconds"}),major:new o({value:30,unit:"seconds"}),format:{minute:"numeric",second:"numeric"}},{minor:new o({value:10,unit:"seconds"}),major:new o({value:1,unit:"minutes"}),format:{minute:"numeric"}},{minor:new o({value:15,unit:"seconds"}),major:new o({value:5,unit:"minutes"}),format:{hour:"numeric",minute:"numeric"}},{minor:new o({value:1,unit:"minutes"}),major:new o({value:20,unit:"minutes"}),format:{hour:"numeric",minute:"numeric"}},{minor:new o({value:5,unit:"minutes"}),major:new o({value:2,unit:"hours"}),format:{hour:"numeric",minute:"numeric"}},{minor:new o({value:15,unit:"minutes"}),major:new o({value:6,unit:"hours"}),format:{hour:"numeric",minute:"numeric"}},{minor:new o({value:1,unit:"hours"}),major:new o({value:1,unit:"days"}),format:{day:"numeric",month:"short"}},{minor:new o({value:6,unit:"hours"}),major:new o({value:1,unit:"weeks"}),format:{day:"numeric",month:"short"}},{minor:new o({value:1,unit:"days"}),major:new o({value:1,unit:"months"}),format:{month:"long"}},{minor:new o({value:2,unit:"days"}),major:new o({value:1,unit:"months"}),format:{month:"short"}},{minor:new o({value:3,unit:"days"}),major:new o({value:1,unit:"months"}),format:{month:"short"}},{minor:new o({value:4,unit:"days"}),major:new o({value:3,unit:"months"}),format:{month:"short",year:"numeric"}},{minor:new o({value:1,unit:"weeks"}),major:new o({value:1,unit:"years"}),format:{year:"numeric"}},{minor:new o({value:1,unit:"months"}),major:new o({value:1,unit:"years"}),format:{year:"numeric"}},{minor:new o({value:2,unit:"months"}),major:new o({value:2,unit:"years"}),format:{year:"numeric"}},{minor:new o({value:1,unit:"years"}),major:new o({value:1,unit:"decades"}),format:{year:"numeric"}},{minor:new o({value:2,unit:"years"}),major:new o({value:5,unit:"decades"}),format:{year:"numeric"}},{minor:new o({value:5,unit:"decades"}),major:new o({value:10,unit:"centuries"}),format:{era:"short",year:"numeric"}},{minor:new o({value:1,unit:"centuries"}),major:new o({value:10,unit:"centuries"}),format:{era:"short",year:"numeric"}},{minor:new o({value:2,unit:"centuries"}),major:new o({value:20,unit:"centuries"}),format:{era:"short",year:"numeric"}},{minor:new o({value:5,unit:"centuries"}),major:new o({value:50,unit:"centuries"}),format:{era:"short",year:"numeric"}},{minor:new o({value:10,unit:"centuries"}),major:new o({value:100,unit:"centuries"}),format:{era:"short",year:"numeric"}},{minor:new o({value:20,unit:"centuries"}),major:new o({value:200,unit:"centuries"}),format:{era:"short",year:"numeric"}},{minor:new o({value:50,unit:"centuries"}),major:new o({value:500,unit:"centuries"}),format:{era:"short",year:"numeric"}},{minor:new o({value:100,unit:"centuries"}),major:new o({value:1e3,unit:"centuries"}),format:{era:"short",year:"numeric"}},{minor:new o({value:200,unit:"centuries"}),major:new o({value:1e3,unit:"centuries"}),format:{era:"short",year:"numeric"}},{minor:new o({value:500,unit:"centuries"}),major:new o({value:5e3,unit:"centuries"}),format:{era:"short",year:"numeric"}},{minor:new o({value:1e3,unit:"centuries"}),major:new o({value:1e4,unit:"centuries"}),format:{era:"short",year:"numeric"}}]);return function(e){function t(t){var i=e.call(this,t)||this;return i._slider=null,i._tickFormat=null,i.effectiveStops=null,i.fullTimeExtent=null,i.iconClass=k,i.label=a.widgetLabel,i.loop=!0,i.playRate=1e3,i.mode="time-window",i.stops={count:10},i.timeExtent=null,i.timeVisible=!1,i.values=null,i.view=null,i.viewModel=new b,i}return i(t,e),t.prototype.postInitialize=function(){var e=this;this._slider=new _({precision:0,visibleElements:{rangeLabels:!1},rangeLabelInputsEnabled:!1});var t=f.throttle((function(){return e.scheduleRender()}),100);this.own([this._slider.watch("values",(function(t){e.set("values",t.map((function(e){return new Date(e)})))})),d.on(window,"resize",t),this.watch("effectiveStops",(function(){e._updateSliderSteps()})),this.watch(["stops","fullTimeExtent"],(function(){e._createDefaultValues()}))]),this._updateSliderSteps(),this._createDefaultValues(),this._validateTimeExtent()},t.prototype.destroy=function(){this.view=null,this._slider.destroy(),this._tickFormat=null},t.prototype.next=function(){},t.prototype.play=function(){},t.prototype.previous=function(){},t.prototype.stop=function(){return null},t.prototype.render=function(){var e=this,t=e.domNode,i=e.fullTimeExtent,n=e.mode,r=e._slider,a=e.effectiveStops,o=e.timeVisible,u=e.values,m=e.viewModel;if(null!=i){var c=i.start,d=i.end;if(null==c||null==d)return;var v=c.getTime(),f=d.getTime(),h=r.min!==v||r.max!==f;h&&(r.min=v,r.max=f);var y=(f-v)/(r.trackElement?r.trackElement.offsetWidth:400),_=$.find((function(e){return e.minor.toMilliseconds()>3*y})),x=this._tickFormat!==_&&null!=_;if(x&&(this._tickFormat=_),h||x){var b={mode:"position",values:this._getTickPositions(_.minor),labelsVisible:!1,tickCreatedFunction:function(e,t){t.classList.add(N)}},k={mode:"position",values:this._getTickPositions(_.major),labelsVisible:!0,tickCreatedFunction:function(e,t){t.classList.add(A)},labelFormatFunction:function(e){return w.formatDate(e,_.format)}};r.tickConfigs=[b,k]}}var ee=u?u.map((function(e){return e.getTime()})):null;l.equals(r.values,ee)||(r.values=ee);var te=i&&i.start,ie=p.isSome(te)?this._formateDate(te):null,ne=o&&p.isSome(te)?this._formateTime(te):null,re=i&&i.end,se=p.isSome(re)?this._formateDate(re):null,ae=o&&p.isSome(re)?this._formateTime(re):null,oe=null,le=null,ue=null,me=null;if(u&&u.length>0){var ce=u[0];oe=this._formateDate(ce),o&&(le=this._formateTime(ce))}if("time-window"===n&&u&&u.length>1){ce=u[1];ue=this._formateDate(ce),o&&(me=this._formateTime(ce))}var de=m.state,ve="ready"===de,pe="playing"===de,fe="disabled"===de||0===a.length,he=g.tsx("div",{class:C},g.tsx("button",{"aria-disabled":fe?"true":"false","aria-label":pe?s.control.stop:s.control.play,bind:this,class:this.classes(S,V,fe&&j),disabled:fe,title:pe?s.control.stop:s.control.play,onclick:this._playOrStopClick},g.tsx("div",{class:this.classes((ve||fe)&&F,pe&&H)}))),we=g.tsx("div",{class:R},p.isSome(oe)&&g.tsx("div",{key:"start-date-group",class:I},g.tsx("div",{key:"start-date",class:L},oe),p.isSome(le)&&g.tsx("div",{key:"start-time",class:U},le)),p.isSome(ue)&&g.tsx("div",{key:"separator",class:P},"–"),p.isSome(oe)&&g.tsx("div",{key:"end-date-group",class:I},g.tsx("div",{key:"end-date",class:L},ue),p.isSome(me)&&g.tsx("div",{key:"end-time",class:U},me))),ye=g.tsx("div",{class:W},p.isSome(ie)&&g.tsx("div",{key:"min-date",class:q},ie),p.isSome(ne)&&g.tsx("div",{key:"min-time"},ne)),_e=g.tsx("div",{class:z},r.render()),xe=g.tsx("div",{class:B},p.isSome(se)&&g.tsx("div",{key:"max-date",class:G},se),p.isSome(ae)&&g.tsx("div",{key:"max-time"},ae)),be=g.tsx("div",{class:J},g.tsx("button",{"aria-disabled":fe?"true":"false","aria-label":s.pagination.previous,bind:this,class:this.classes(S,K,(pe||fe)&&j),disabled:fe,title:s.pagination.previous,onclick:this._previousClick},g.tsx("div",{class:Q}))),ge=g.tsx("div",{class:X},g.tsx("button",{"aria-disabled":fe?"true":"false","aria-label":s.pagination.next,bind:this,class:this.classes(S,Y,(pe||fe)&&j),disabled:fe,title:s.pagination.next,onclick:this._nextClick},g.tsx("div",{class:Z}))),ke=t.clientWidth<858?"compact":"wide";return g.tsx("div",{class:this.classes(M,T,""+E+n,""+D+ke)},"wide"===ke&&g.tsx("div",{class:O},[he,we,ye,_e,xe,be,ge]),"compact"===ke&&[g.tsx("div",{key:"time-slider-row-1",class:O},[we]),g.tsx("div",{key:"time-slider-row-2",class:O},[_e]),g.tsx("div",{key:"time-slider-row-3",class:O},[ye,be,he,ge,xe])])},t.prototype._createDefaultValues=function(){var e=this.fullTimeExtent,t=this.effectiveStops,i=this.mode,n=this.values;e&&t&&i&&!n&&(this.values="time-window"===i?t.length>1?[t[0],t[1]]:null:t.length>0?[t[0]]:null)},t.prototype._getTickPositions=function(e){for(var t=this.fullTimeExtent,i=t.start,n=t.end,r=[],s=e.value,a=e.unit,o=y.truncateDate(i,a);o.getTime()<=n.getTime();)o.getTime()>=i.getTime()&&r.push(o.getTime()),o=y.offsetDate(o,s,a);return r},t.prototype._formateDate=function(e){return w.formatDate(e,w.convertDateFormatToIntlOptions("short-date"))},t.prototype._formateTime=function(e){return w.formatDate(e,w.convertDateFormatToIntlOptions("long-time"))},t.prototype._updateSliderSteps=function(){this._slider.steps=this.effectiveStops.length>0?this.effectiveStops.map((function(e){return e.getTime()})):null},t.prototype._validateTimeExtent=function(){var e=this;if(this.fullTimeExtent&&this.mode&&this.values){if(!Array.isArray(this.values))throw new c("time-slider:invalid-values","Values must be an array of dates.");if(0===this.values.length||this.values.some((function(e){return!(e instanceof Date)})))throw new c("time-slider:invalid-values","Values must be an array of dates.");switch(this.values=this.values.map((function(t){var i=t.getTime(),n=v.clamp(i,e.fullTimeExtent.start.getTime(),e.fullTimeExtent.end.getTime());return new Date(n)})),this.mode){case"instant":case"cumulative-from-start":case"cumulative-from-end":this.values.length>1&&this.values.splice(1);break;case"time-window":1===this.values.length?this.values.push(this.fullTimeExtent.end):this.values.length>2&&this.values.splice(2),this.values.sort((function(e,t){return e.getTime()-t.getTime()}));break;default:m.neverReached(this.mode)}}},t.prototype._playOrStopClick=function(){switch(this.viewModel.state){case"ready":this.viewModel.play();break;case"playing":this.viewModel.stop();break;case"disabled":break;default:m.neverReached(this.viewModel.state)}},t.prototype._previousClick=function(){this.viewModel.previous()},t.prototype._nextClick=function(){this.viewModel.next()},n([h.aliasOf("viewModel.effectiveStops"),g.renderable()],t.prototype,"effectiveStops",void 0),n([h.aliasOf("viewModel.fullTimeExtent"),g.renderable()],t.prototype,"fullTimeExtent",void 0),n([h.property()],t.prototype,"iconClass",void 0),n([h.property()],t.prototype,"label",void 0),n([h.aliasOf("viewModel.loop")],t.prototype,"loop",void 0),n([h.aliasOf("viewModel.playRate")],t.prototype,"playRate",void 0),n([h.aliasOf("viewModel.mode"),g.renderable()],t.prototype,"mode",void 0),n([h.aliasOf("viewModel.stops")],t.prototype,"stops",void 0),n([h.aliasOf("viewModel.timeExtent")],t.prototype,"timeExtent",void 0),n([h.property({nonNullable:!0}),g.renderable()],t.prototype,"timeVisible",void 0),n([h.aliasOf("viewModel.values"),g.renderable()],t.prototype,"values",void 0),n([h.aliasOf("viewModel.view")],t.prototype,"view",void 0),n([h.property({type:b}),g.renderable(["viewModel.state"])],t.prototype,"viewModel",void 0),n([h.aliasOf("viewModel.next")],t.prototype,"next",null),n([h.aliasOf("viewModel.play")],t.prototype,"play",null),n([h.aliasOf("viewModel.previous")],t.prototype,"previous",null),n([h.aliasOf("viewModel.stop")],t.prototype,"stop",null),n([g.accessibleHandler()],t.prototype,"_playOrStopClick",null),n([g.accessibleHandler()],t.prototype,"_previousClick",null),n([g.accessibleHandler()],t.prototype,"_nextClick",null),t=n([h.subclass("esri.widgets.TimeSlider")],t)}(h.declared(x))}));