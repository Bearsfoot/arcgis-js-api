// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","../core/tsSupport/assignHelper","dojo/i18n!../nls/common","dojo/i18n!./LayerList/nls/LayerList","../core/Collection","../core/deprecate","../core/events","../core/Handles","../core/has","../core/Logger","../core/watchUtils","../core/accessorSupport/decorators","../libs/sortablejs/Sortable","./Widget","./LayerList/LayerListViewModel","./LayerList/ListItem","./support/widget"],(function(e,t,i,r,s,n,o,l,a,c,d,u,p,y,g,h,_,b,v,m){function f(e,t,i){e.splice(i,0,e.splice(t,1)[0])}var I=l.ofType(v),w="esri-layer-list esri-widget esri-widget--panel",A="esri-layer-list--new-ui",x="esri-layer-list__no-items",k="esri-layer-list__list",S="esri-layer-list__list--root",C="esri-layer-list__list--exclusive",L="esri-layer-list__list--inherited",E="esri-layer-list__list--independent",O="esri-layer-list__item",U="esri-layer-list__item--error",P="esri-layer-list__item--invisible",T="esri-layer-list__item--invisible-at-scale",N="esri-layer-list__item--updating",M="esri-layer-list__item--has-children",V="esri-layer-list__item--selectable",R="esri-layer-list__item-container",H="esri-layer-list__item-actions-menu",B="esri-layer-list__item-actions-menu-item",K="esri-layer-list__item-actions-menu-item--active",j="esri-layer-list__item-actions",D="esri-layer-list__item-actions-list",F="esri-layer-list__item-action",z="esri-layer-list__item-action-icon",q="esri-layer-list__item-action-image",W="esri-layer-list__item-action-title",G="esri-layer-list__action-toggle",J="esri-layer-list__action-toggle--on",Q="esri-layer-list__item-label",X="esri-layer-list__item-error-message",Y="esri-layer-list__item-title",Z="esri-layer-list__item-toggle",$="esri-layer-list__item-toggle-icon",ee="esri-layer-list__item-toggle-icon",te="esri-layer-list__item-radio-icon",ie="esri-layer-list__child-toggle",re="esri-layer-list__child-toggle--open",se="esri-layer-list__child-toggle-icon--opened",ne="esri-layer-list__child-toggle-icon--closed",oe="esri-layer-list__child-toggle-icon--closed-rtl",le="esri-disabled",ae="esri-disabled-element",ce="esri-hidden",de="esri-rotating",ue="esri-icon-handle-horizontal",pe="esri-icon-visible",ye="esri-icon-non-visible",ge="esri-icon-radio-checked",he="esri-icon-radio-unchecked",_e="esri-icon-notice-triangle",be="esri-icon-down-arrow",ve="esri-icon-right-triangle-arrow",me="esri-icon-left-triangle-arrow",fe="esri-icon-loading-indicator",Ie="esri-icon-default-action",we="esri-icon-layers",Ae="actions",xe="action-section",ke="items",Se="exclusive",Ce="inherited";var Le=p.getLogger("esri.widgets.LayerList"),Ee={statusIndicators:!0};return function(e){function t(t){var i=e.call(this,t)||this;return i._handles=new d,i._sortable=null,i._sortableNode=null,i._focusSortUid=null,i._newUI=u("esri-layerlist-new-ui"),i.iconClass=we,i.label=o.widgetLabel,i.listItemCreatedFunction=null,i.multipleSelectionEnabled=!1,i.operationalItems=null,i.selectionEnabled=!1,i.selectedItems=new I,i.view=null,i.viewModel=new b,i.visibleElements=s({},Ee),i}return i(t,e),t.prototype.postInitialize=function(){var e=this,t=this.operationalItems;this.own(y.on(this,"operationalItems","change",(function(){return e._itemsChanged(t)})),y.init(this,"selectionEnabled",(function(){return e._toggleSorting()})))},t.prototype.destroy=function(){this._destroySortable(),this._handles.destroy(),this._handles=null},Object.defineProperty(t.prototype,"statusIndicatorsVisible",{set:function(e){a.deprecatedProperty(Le,"statusIndicatorsVisible",{replacement:"visibleElements.statusIndicators",version:"4.15"}),this.visibleElements=s({},this.visibleElements,{statusIndicators:e})},enumerable:!0,configurable:!0}),t.prototype.castVisibleElements=function(e){return s({},Ee,e)},t.prototype.triggerAction=function(e,t){this.viewModel.triggerAction(e,t)},t.prototype.render=function(){var e,t=this,i=this._getItems(),r=this.get("viewModel.state"),s=0===i.length?m.tsx("div",{class:x},o.noItemsToDisplay):m.tsx("ul",{"aria-label":o.widgetLabel,role:this.selectionEnabled?"listbox":void 0,afterCreate:this._sortNodeCreated,afterRemoved:this._destroySortable,"data-node-ref":"_sortableNode",bind:this,class:this.classes(k,S,E)},i.map((function(e){return t._renderItem(e,null)}))),n=((e={})[A]=this._newUI,e[ce]="loading"===r,e[le]="disabled"===r,e);return m.tsx("div",{class:this.classes(w,n)},s)},t.prototype._destroySortable=function(){var e=this._sortable;e&&e.destroy(),this._sortable=null},t.prototype._toggleSorting=function(){var e=this,t=this._sortable,i=this._sortableNode,r=this.selectionEnabled;if(i)if(t)t.option("disabled",!r);else{var s=h.create(i,{dataIdAttr:"data-layer-uid",group:"root-layers",fallbackTolerance:4,disabled:!r,onSort:function(){return e._sortLayersToItems(s.toArray())}});this._sortable=s}},t.prototype._sortNodeCreated=function(e){this._sortableNode=e,this._toggleSorting()},t.prototype._sortLayersToItems=function(e){var t=this.get("view.map.layers");t&&t.sort((function(t,i){var r=e.indexOf(t.uid),s=e.indexOf(i.uid);return r>s?-1:r<s?1:0}))},t.prototype._getItems=function(){var e=this;return this.operationalItems.toArray().filter((function(t){return e.errorsVisible||!t.error}))},t.prototype._getSingleActionButton=function(e){return e.actionsSections.reduce((function(e){return e})).filter((function(e){return e&&"button"===e.type})).getItemAt(0)},t.prototype._renderItem=function(e,t){var i,r,l,a,c,d,u=this,p=this.id+"_"+e.uid,y=p+"_actions",g=p+"__list",h=p+"__title",_=this._newUI,b=e.children.length,v=!!e.error,f=!!b&&!v,I=v?o.layerError:"",w=e.visibilityMode,A=e.children&&e.children.toArray(),x=Se,S=Ce,j=((i={})[C]=w===x,i[L]=w===S,i[E]=w!==S&&w!==x,i),D=((r={})[M]=f,r[U]=!!v,r[N]=e.updating&&!t&&this.visibleElements.statusIndicators,r[P]=_&&!e.visible,r[T]=!e.visibleAtCurrentScale,r[V]=this.selectionEnabled,r),F=this._countActions(e.actionsSections),z=e.panel,q=z&&z.open?z.render():null,W=z&&z.visible?this._renderPanelButton(z):null,G=((l={})[K]=e.actionsOpen,l),J=e.actionsOpen?n.close:n.open,Q=1===F&&this._getSingleActionButton(e),Y=Q?this._renderAction({item:e,action:Q,singleAction:!0}):null,Z=!Q&&F?m.tsx("div",{key:"actions-menu-toggle","data-item":e,bind:this,onclick:this._toggleActionsOpen,onkeydown:this._toggleActionsOpen,class:this.classes(B,G),tabindex:"0",role:"button","aria-controls":y,"aria-label":J,title:J},m.tsx("span",{"aria-hidden":"true",class:ue})):null,$=Z||W||Y?m.tsx("div",{key:"esri-layer-list__actions-menu",class:H},W,Y,Z):null,ee=F?this._renderActionsSections(e,e.actionsSections,y):null,te=f?m.tsx("ul",{key:"esri-layer-list__list-items",id:g,class:this.classes(k,j),"aria-expanded":e.open?"true":"false",role:w===x?"radiogroup":"group",hidden:!e.open||null},A.map((function(t){return u._renderItem(t,e)}))):null,le=((a={})[re]=e.open,a),ae=e.open?n.collapse:n.expand,ce=f?m.tsx("span",{onclick:this._toggleChildrenClick,onkeydown:this._toggleChildrenClick,"data-item":e,key:"esri-layer-list__toggle-children",class:this.classes(ie,le),tabindex:"0",role:"button","aria-controls":g,"aria-label":ae,title:ae},m.tsx("span",{"aria-hidden":"true",class:this.classes(ne,ve)}),m.tsx("span",{"aria-hidden":"true",class:this.classes(se,be)}),m.tsx("span",{"aria-hidden":"true",class:this.classes(oe,me)})):null,de=this._createLabelNode(e,t,h),pe=v?m.tsx("div",{key:"esri-layer-list__error",class:X,role:"alert"},m.tsx("span",null,I)):null,ye=this.selectedItems.indexOf(e)>-1,ge=t?null:e.get("layer.uid"),he=this.selectionEnabled?((c={bind:this,onclick:this._toggleSelection,onkeydown:this._selectionKeydown,"data-item":e,tabIndex:0,"aria-selected":ye?"true":"false",role:"option","aria-labelledby":h})["data-layer-uid"]=ge,c):((d={bind:void 0,onclick:void 0,onkeydown:void 0,"data-item":void 0,tabIndex:void 0,"aria-selected":void 0,role:void 0,"aria-labelledby":void 0})["data-layer-uid"]=void 0,d);return m.tsx("li",s({key:e,bind:this,afterCreate:this._focusListItem,afterUpdate:this._focusListItem,class:this.classes(O,D),"aria-labelledby":h},he),m.tsx("div",{key:"esri-layer-list__list-item-container",class:R},ce,de,$),pe,ee,q,te)},t.prototype._focusListItem=function(e){var t=this._focusSortUid;e&&t&&(e.dataset.layerUid===t&&(e.focus(),this._focusSortUid=null))},t.prototype._createLabelNode=function(e,t,i){var r,n=this.selectionEnabled,l=this._newUI,a=Se,c=Ce,d=t&&t.visibilityMode,u=((r={})[$]=l,r[ee]=l&&d!==a,r[te]=l&&d===a,r[ge]=d===a&&e.visible,r[he]=d===a&&!e.visible,r[pe]=d!==a&&!l&&e.visible,r[ye]=d!==a&&(l||!e.visible),r),p=d===a?"radio":"switch",y=e.title||o.untitledLayer,g=e.visibleAtCurrentScale?y:y+" ("+o.layerInvisibleAtScale+")",h=m.tsx("span",{key:"layer-title-container",id:i,title:g,"aria-label":g,class:Y},y),_=m.tsx("span",{class:this.classes(u),"aria-hidden":"true"}),b={bind:this,onclick:this._toggleVisibility,onkeydown:this._toggleVisibility,"data-item":e,"data-parent-visibility":d,tabIndex:0,"aria-checked":e.visible?"true":"false",role:p,"aria-labelledby":i},v={bind:void 0,onclick:void 0,onkeydown:void 0,"data-item":void 0,"data-parent-visibility":void 0,tabIndex:void 0,"aria-checked":void 0,role:void 0,"aria-labelledby":void 0},f=n?b:v,I=n?v:b,w=[m.tsx("span",s({class:Z},f),_),h];l&&w.reverse();var A=m.tsx("div",s({key:e,class:Q},I),w),x=!!e.error,k=x?m.tsx("span",{key:"notice-triangle","aria-hidden":"true",class:_e}):null;return d===c||x?m.tsx("div",{key:e,class:Q},k,h):A},t.prototype._renderPanelButton=function(e){var t,i,r=e.className,s=e.open,n=e.title,o=e.image||r?r:Ie,l=this._getIconImageStyles(e),a=((t={})[K]=s,t),c=((i={})[q]=!!l["background-image"],i);return o&&(c[o]=!!o),m.tsx("div",{key:e,bind:this,"data-panel":e,onclick:this._triggerPanel,onkeydown:this._triggerPanel,class:this.classes(B,a),role:"button",tabindex:"0",title:n,"aria-label":n},m.tsx("span",{class:this.classes(c),styles:l}))},t.prototype._watchActionSectionChanges=function(e,t){var i=this,r=xe+t;this._handles.add(e.on("change",this.scheduleRender.bind(this)),r),e.forEach((function(e){return i._renderOnActionChanges(e,t)}))},t.prototype._renderOnActionChanges=function(e,t){var i=this,r=Ae+t;"toggle"!==e.type?"slider"!==e.type?this._handles.add([y.init(e,["className","image","id","title","visible"],(function(){return i.scheduleRender()}))],r):this._handles.add([y.init(e,["className","id","title","visible","value","displayValueEnabled","max","min","step"],(function(){return i.scheduleRender()}))],r):this._handles.add([y.init(e,["className","image","id","title","visible","value"],(function(){return i.scheduleRender()}))],r)},t.prototype._renderOnItemChanges=function(e){var t=this,i=e.uid,r=ke+i;this._handles.add([y.init(e,["actionsOpen","visible","open","updating","title","visibleAtCurrentScale","error","visibilityMode","panel","panel.title","panel.content","panel.className"],(function(){return t.scheduleRender()})),e.actionsSections.on("change",(function(){return t.scheduleRender()})),e.children.on("change",(function(){return t.scheduleRender()}))],r),e.children.forEach((function(e){return t._renderOnItemChanges(e)})),e.actionsSections.forEach((function(e){return t._watchActionSectionChanges(e,i)}))},t.prototype._itemsChanged=function(e){var t=this;this._handles.removeAll(),e.forEach((function(e){return t._renderOnItemChanges(e)})),this.scheduleRender()},t.prototype._renderActionsSections=function(e,t,i){var r=this,s=t.toArray().map((function(t){return m.tsx("ul",{key:t,class:D},r._renderActionSection(e,t))}));return m.tsx("div",{role:"group","aria-expanded":e.actionsOpen?"true":"false",key:"esri-layer-list__actions-section",id:i,class:j,hidden:!e.actionsOpen||null},s)},t.prototype._renderActionSection=function(e,t){var i=this;return(t&&t.toArray()).map((function(t){return i._renderAction({item:e,action:t})}))},t.prototype._renderAction=function(e){var t,i,r=e.item,s=e.action,n=e.singleAction,o=this._getIconImageStyles(s),l=s.active,a=s.className,c=s.disabled,d=s.title,u="button"!==s.type||s.image||a?a:Ie,p=((t={})[B]=n&&"button"===s.type,t[F]=!n&&"toggle"!==s.type,t[G]="toggle"===s.type,t[J]="toggle"===s.type&&s.value,t[ae]=c,t),y=((i={})[q]=!l&&!!o["background-image"],i[fe]=l,i[de]=l,i);u&&(y[u]=!0);var g=[m.tsx("span",{key:"action-icon","aria-hidden":"true",class:this.classes(z,y),styles:o}),n?null:m.tsx("span",{key:"action-title",class:W},d)];return n?m.tsx("div",{bind:this,"data-item":r,"data-action":s,role:"button",key:s,onclick:this._triggerAction,onkeydown:this._triggerAction,classes:p,tabindex:"0",title:d,"aria-label":d},g):m.tsx("li",{bind:this,"data-item":r,"data-action":s,key:s,onclick:this._triggerAction,onkeydown:this._triggerAction,classes:p,tabindex:"0",role:"button",title:d,"aria-label":d},g)},t.prototype._countActions=function(e){return e.reduce((function(e,t){return e+t.length}),0)},t.prototype._getIconImageStyles=function(e){var t="esri.widgets.LayerList.ListItemPanel"===e.declaredClass||"esri.support.Action.ActionButton"===e.declaredClass||"esri.support.Action.ActionToggle"===e.declaredClass?e.image:null;return{"background-image":t?'url("'+t+'")':null}},t.prototype._selectionKeydown=function(e){var t=c.eventKey(e);if(-1!==["ArrowDown","ArrowUp"].indexOf(t)){e.stopPropagation();var i=e.currentTarget["data-item"],r=this._sortable,s=this.selectedItems.indexOf(i)>-1,n=r.toArray(),o=e.target,l=n.indexOf(o.dataset.layerUid);if(-1!==l){if("ArrowDown"===t){if((a=l+1)>=n.length)return;s?(f(n,l,a),r.sort(n),this._sortLayersToItems(r.toArray()),this._focusSortUid=n[a]):(this._focusSortUid=n[a],this.scheduleRender())}if("ArrowUp"===t){var a;if((a=l-1)<=-1)return;s?(f(n,l,a),r.sort(n),this._sortLayersToItems(r.toArray()),this._focusSortUid=n[a]):(this._focusSortUid=n[a],this.scheduleRender())}}}else this._toggleSelection(e)},t.prototype._toggleActionsOpen=function(e){var t=e.currentTarget["data-item"],i=!t.actionsOpen;i&&this.operationalItems.forEach((function(e){return function e(t){var i=t.actionsOpen,r=t.children;i&&(t.actionsOpen=!1),r.forEach((function(t){return e(t)}))}(e)})),t.actionsOpen=i,e.stopPropagation()},t.prototype._triggerPanel=function(e){var t=e.currentTarget["data-panel"];t&&(t.open=!t.open),e.stopPropagation()},t.prototype._triggerAction=function(e){var t=e.currentTarget,i=t["data-action"],r=t["data-item"];"toggle"===i.type&&(i.value=!i.value),this.triggerAction(i,r),e.stopPropagation()},t.prototype._toggleVisibility=function(e){var t=e.currentTarget,i=t.getAttribute("data-parent-visibility"),r=t["data-item"];i===Se&&r.visible||(r.visible=!r.visible),e.stopPropagation()},t.prototype._toggleChildrenClick=function(e){var t=e.currentTarget["data-item"];t.open=!t.open,e.stopPropagation()},t.prototype._toggleSelection=function(e){e.stopPropagation();var t=this.multipleSelectionEnabled,i=this.selectedItems,r=t&&(e.metaKey||e.ctrlKey),s=e.currentTarget["data-item"],n=i.indexOf(s)>-1,o=i.length;if(!r)return o&&!(n&&1===o)?(i.removeAll(),void i.add(s)):void(n?i.remove(s):i.add(s));n?i.remove(s):i.add(s)},r([g.property()],t.prototype,"iconClass",void 0),r([g.property(),m.renderable()],t.prototype,"errorsVisible",void 0),r([g.property()],t.prototype,"label",void 0),r([g.aliasOf("viewModel.listItemCreatedFunction"),m.renderable()],t.prototype,"listItemCreatedFunction",void 0),r([g.property()],t.prototype,"multipleSelectionEnabled",void 0),r([g.aliasOf("viewModel.operationalItems"),m.renderable()],t.prototype,"operationalItems",void 0),r([g.property(),m.renderable()],t.prototype,"selectionEnabled",void 0),r([g.property(),m.renderable()],t.prototype,"selectedItems",void 0),r([g.property(),m.renderable()],t.prototype,"statusIndicatorsVisible",null),r([g.aliasOf("viewModel.view"),m.renderable()],t.prototype,"view",void 0),r([m.vmEvent("trigger-action"),g.property({type:b}),m.renderable("viewModel.state")],t.prototype,"viewModel",void 0),r([g.property(),m.renderable()],t.prototype,"visibleElements",void 0),r([g.cast("visibleElements")],t.prototype,"castVisibleElements",null),r([g.aliasOf("viewModel.triggerAction")],t.prototype,"triggerAction",null),r([m.accessibleHandler()],t.prototype,"_toggleActionsOpen",null),r([m.accessibleHandler()],t.prototype,"_triggerPanel",null),r([m.accessibleHandler()],t.prototype,"_triggerAction",null),r([m.accessibleHandler()],t.prototype,"_toggleVisibility",null),r([m.accessibleHandler()],t.prototype,"_toggleChildrenClick",null),r([m.accessibleHandler()],t.prototype,"_toggleSelection",null),t=r([g.subclass("esri.widgets.LayerList")],t)}(g.declared(_))}));