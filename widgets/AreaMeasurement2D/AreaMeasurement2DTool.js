// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/declareExtendsHelper","../../core/tsSupport/decorateHelper","../../Graphic","../../core/Handles","../../core/promiseUtils","../../core/watchUtils","../../core/accessorSupport/decorators","../../geometry/geometryEngine","../../geometry/Point","../../geometry/Polygon","../../geometry/Polyline","../../geometry/projection","../../geometry/SpatialReference","../../geometry/support/geodesicUtils","../../layers/GraphicsLayer","../../symbols/SimpleMarkerSymbol","../../views/2d/draw/Draw","../../views/2d/interactive/dragUtils/dragHandlers","../../views/interactive/GraphicManipulator","../../views/interactive/InteractiveToolBase"],(function(e,t,r,i,o,s,a,n,l,c,p,h,d,u,y,v,m,f,g,_,w,L){return function(e){function t(t){var r=e.call(this,t)||this;return r._drawActive=!1,r._handles=new s,r._graphicsLayer=new m({listMode:"hide"}),r._manipulatorLayer=new m({listMode:"hide"}),r._vertices=[],r.deferCreation=!0,r}var L;return r(t,e),L=t,t.prototype.initialize=function(){var e=this,t=this.view;this._draw=new g({view:t}),t.map.addMany([this._graphicsLayer,this._manipulatorLayer]),t.focus(),this._handles.add([this.watch("viewModel.unit",(function(){e._vertices.length>0&&e._updateGraphics()}))]),n.init(this,"view.spatialReference",(function(t){L.isProjectionEngineRequired({spatialReference:t})&&e._loadProjectionEngine()}))},t.prototype.destroy=function(){this.detach(),this._handles.removeAll(),this._graphicsLayer.removeAll();var e=this.viewModel,t=e.view.map;t.remove(this._graphicsLayer),t.remove(this._manipulatorLayer),e.measurement=null,this._draw&&(this._draw.destroy(),this._draw=null),this._handles&&(this._handles.destroy(),this._handles=null),this._graphicsLayer&&(this._graphicsLayer.destroy(),this._graphicsLayer=null),this._manipulatorLayer&&(this._manipulatorLayer.destroy(),this._manipulatorLayer=null)},Object.defineProperty(t.prototype,"editable",{set:function(e){this._set("editable",e),e||this._draw.reset()},enumerable:!0,configurable:!0}),t.prototype.activate=function(){this._drawActive||0!==this._vertices.length||this._startSketch()},t.prototype.onShow=function(){this._graphicsLayer.visible=!0},t.prototype.onHide=function(){this._graphicsLayer.visible=!1},t.prototype.reset=function(){this._vertices=[],this._graphicsLayer.removeAll(),this.viewModel.measurement=null,this._draw.reset(),this._drawActive=!1,this._updateSketch([])},t.updateViewModelAndCreateGraphics=function(e,t){var r=t.geodesicDistanceThreshold,i=t.palette,s=t.view.spatialReference,a=i.fillColor,n=i.pathColor,l=i.pathWidth;if(2===e.length){var p=new d({paths:e,spatialReference:s}),m=void 0;if(s.isGeographic)if(v.isSupported(s))m=v.geodesicDensify(p,1e5);else{var f=u.project(p,y.WGS84),g=v.geodesicDensify(f,1e5);m=u.project(g,s)}else if(s.isWebMercator)m=c.geodesicDensify(p,1e5,"meters");else if((G=c.planarLength(p,"meters"))>=r){f=u.project(p,y.WGS84),g=v.geodesicDensify(f,1e5);m=u.project(g,s)}else m=p;return[new o({geometry:m,symbol:{type:"simple-line",color:n,width:l}})]}e.push(e[0]);var _,w,L=new d({paths:[e],spatialReference:s}),S=new h({rings:[e],spatialReference:s}),A=null,b=null;if(s.isGeographic)if(v.isSupported(s)){if(A=v.geodesicDensify(L,1e5),b=v.geodesicDensify(S,1e5),!(b=c.simplify(b)))return null;_=v.geodesicLengths([L],"meters")[0],w=v.geodesicAreas([b],"square-meters")[0]}else{f=y.WGS84;var j=u.project(L,f),M=u.project(S,f);if(A=v.geodesicDensify(j,1e5),b=v.geodesicDensify(M,1e5),!(b=c.simplify(b)))return null;_=v.geodesicLengths([j],"meters")[0],w=v.geodesicAreas([b],"square-meters")[0],A=u.project(A,s),b=u.project(b,s)}else if(s.isWebMercator){if(A=c.geodesicDensify(L,1e5,"meters"),b=c.geodesicDensify(S,1e5,"meters"),!(b=c.simplify(b)))return null;_=c.geodesicLength(L,"meters"),w=c.geodesicArea(b,"square-meters")}else{var G;if((G=c.planarLength(L,"meters"))>=r){f=y.WGS84,j=u.project(L,f),M=u.project(S,f);if(A=v.geodesicDensify(j,1e5),b=v.geodesicDensify(M,1e5),!(b=c.simplify(b)))return null;_=v.geodesicLengths([j],"meters")[0],w=v.geodesicAreas([b],"square-meters")[0],A=u.project(A,s),b=u.project(b,s)}else{if(A=L,!(b=c.simplify(S)))return null;_=G,w=c.planarArea(b,"square-meters")}}return t.measurement={geometry:b,area:w,perimeter:_},[new o({geometry:b,symbol:{type:"simple-fill",color:a,outline:{type:"simple-line",width:0}}}),new o({geometry:A,symbol:{type:"simple-line",color:n,width:l}}),new o({geometry:b.centroid,symbol:{type:"text",color:[255,255,255,1],haloColor:[0,0,0,.5],haloSize:2,text:t.measurementLabel.area,font:{size:14,family:"sans-serif"}}})]},t.isProjectionEngineRequired=function(e){if(!e)return!1;var t=e.spatialReference;if(!t)return!1;var r=t.isGeographic,i=t.isWebMercator,o=t.isWGS84;return r&&!o&&!v.isSupported(t)||!r&&!i},t.isProjectionEngineSupported=function(){return u.isSupported()},t.prototype.onInputEvent=function(e){"pointer-move"===e.type&&this._updateCursor()},t.prototype._loadProjectionEngine=function(){return L.isProjectionEngineSupported()&&!u.isLoaded()?u.load():a.resolve()},t.prototype._startSketch=function(){var e=this;this._drawActive=!0;var t=this._draw.create("polyline",{mode:"click"});t.on(["vertex-add","vertex-update","vertex-remove","cursor-update","undo","redo"],(function(t){return e._updateSketch(t.vertices)})),t.on("draw-complete",(function(){return e._stopSketch()}))},t.prototype._stopSketch=function(){if(this._vertices.length<3)return this.reset(),void this._startSketch();this.manipulators.forEach((function(e){e.manipulator.interactive=!0})),this._drawActive=!1,this.complete()},t.prototype._updateSketch=function(e){var t=this;if(!L.isProjectionEngineRequired(this.view)||u.isLoaded()){if(e.length<2)return this._vertices=[],this.manipulators.removeAll(),void this._graphicsLayer.removeAll();this.create();for(var r=this.view.spatialReference;this._vertices.length>e.length;){var i=this._vertices.pop().manipulatorId;this.manipulators.remove(i)}for(var s=function(i){var s=e[i],n=s[0],l=s[1],c=function(e,t,r,i){var s=new f({style:"circle",color:i.handleColor,size:i.handleWidth,outline:{type:"simple-line",width:0}}),a=new f({style:"circle",color:i.handleColor,size:1.5*i.handleWidth,outline:{type:"simple-line",width:0}}),n=new o({geometry:e,symbol:s});return new w.GraphicManipulator({view:t,layer:r,graphic:n,focusedSymbol:a})}(new p({x:n,y:l,spatialReference:r}),a.view,a._manipulatorLayer,a.viewModel.palette),h=a.manipulators.add(c);_.createGraphicManipulatorDragHandler2D(a.view,c,(function(){var e=c.graphic.geometry;t._vertices[i].coord=[e.x,e.y],t._updateGraphics()})),a._vertices.push({manipulatorId:h,coord:[n,l]})},a=this,n=this._vertices.length;n<e.length;n++)s(n);var l=this._vertices.length-1,c=this._vertices[l],h=e[l],d=h[0],y=h[1];if(c.coord[0]!==d||c.coord[1]!==y){c.coord=[d,y];var v=new p({x:d,y:y,spatialReference:r});this.manipulators.findById(c.manipulatorId).graphic.geometry=v}var m=this._drawActive?this._vertices[l].manipulatorId:null;this.manipulators.forEach((function(e){e.manipulator.interactive=null==m||e.id!==m})),this._updateGraphics()}},t.prototype._updateCursor=function(){this.cursor=this._drawActive?"crosshair":null},t.prototype._updateGraphics=function(){this._graphicsLayer.removeAll();var e=this.viewModel,t=this._vertices.map((function(e){return e.coord})),r=L.updateViewModelAndCreateGraphics(t,e);r&&this._graphicsLayer.addMany(r)},i([l.property({constructOnly:!0})],t.prototype,"view",void 0),i([l.property({constructOnly:!0})],t.prototype,"viewModel",void 0),i([l.property()],t.prototype,"cursor",void 0),i([l.property({value:!0})],t.prototype,"editable",null),t=L=i([l.subclass("esri.widgets.AreaMeasurement2D.AreaMeasurement2DTool")],t)}(l.declared(L.InteractiveToolBase))}));