// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/declareExtendsHelper","../../core/tsSupport/decorateHelper","../../core/tsSupport/assignHelper","../../core/tsSupport/generatorHelper","../../core/tsSupport/awaiterHelper","../../core/arrayUtils","../../core/Collection","../../core/Error","../../core/Evented","../../core/HandleOwner","../../core/Logger","../../core/watchUtils","../../core/accessorSupport/decorators","../../layers/GraphicsLayer","../../layers/graphics/editingSupport","../Attachments/AttachmentsViewModel","./CreateWorkflow","./UpdateWorkflow","../FeatureForm/FeatureFormViewModel","../FeatureTemplates/FeatureTemplatesViewModel","../Sketch/SketchViewModel","../Spinner/SpinnerViewModel"],(function(e,t,r,o,n,i,a,s,u,c,l,d,p,f,w,h,y,v,k,b,g,m,W,_){var O=p.getLogger("esri.widgets.Editor.EditorViewModel"),V=["create","update"];function M(e,t,r){O.error(new c(e,t,r))}function I(e){return e&&y.isEditableLayer(e.layer)}return function(e){function t(t){var r=e.call(this,t)||this;return r._sketchGraphicsLayer=new h({listMode:"hide"}),r.activeWorkflow=null,r.activityQueue=[],r.failures=[],r.attachmentsViewModel=new v({abilities:{editing:!0}}),r.featureFormViewModel=new g,r.featureTemplatesViewModel=new m,r.layerInfos=null,r.sketchViewModel=new W({layer:r._sketchGraphicsLayer}),r.spinnerViewModel=new _,r}return r(t,e),t.prototype.initialize=function(){var e=this;this.handles.add([f.on(this,"activeWorkflow","cancel",(function(){return e.emit("workflow-cancel")})),f.on(this,"activeWorkflow","commit",(function(){return e.emit("workflow-commit")})),f.on(this,"view.allLayerViews","change",(function(){return e.notifyChange("editableItems")})),f.watch(this,"editableItems",(function(){var t=e.activeWorkflow;if(t){var r=t.stepId;if("create"===t.type)return e.refreshCreationTemplates(),void("awaiting-feature-creation-info"!==r||e.canCreate||e._cancelWorkflow());"update"===t.type&&("awaiting-feature-to-update"===r&&!e.canUpdate||"awaiting-update-feature-candidate"===r&&!t.data.candidates.some((function(t){var r=e.editableItems.find((function(e){return e.layer===t.layer}));return r&&r.supports.indexOf("update")>-1})))&&e._cancelWorkflow()}}))])},t.prototype.destroy=function(){this.view=null,this._cancelWorkflow()},Object.defineProperty(t.prototype,"allowedWorkflows",{get:function(){return this._get("allowedWorkflows")},set:function(e){e&&0!==e.length||(e=V.slice()),this._set("allowedWorkflows",e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"canCreate",{get:function(){return this.editableItems.some((function(e){return e.supports.indexOf("create")>-1}))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"canUpdate",{get:function(){return this.editableItems.some((function(e){return e.supports.indexOf("update")>-1}))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"editableItems",{get:function(){var e=this,t=this.get("view.allLayerViews");if(!t)return new u;this.handles.remove("layer-view-property-watchers");var r=function(){return e.notifyChange("editableItems")};return t.filter(I).map((function(t){e.handles.add(f.watch(t,["suspended","suspendInfo"],r),"layer-view-property-watchers");var o=t.layer,n=t.suspendInfo,i=[],a=e.allowedWorkflows,u=o.capabilities,c=u.data,l=u.operations,d=function(e,t){return e&&s.find(e,(function(e){return e.layer===t}))}(e.layerInfos,o),p=c.supportsAttachment&&(!d||!1!==d.allowAttachments),w=a.filter((function(e){return!d||!1!==d.enabled&&("create"===e&&!1!==d.addEnabled||"update"===e&&!1!==d.updateEnabled)})),h=n.layerInvisible||n.layerNotLoaded||n.outsideScaleRange||n.viewNotReady;return!h&&s.find(w,(function(e){return"create"===e}))&&l.supportsAdd&&i.push("create"),!h&&s.find(w,(function(e){return"update"===e}))&&l.supportsUpdate&&i.push("update"),!h&&!1!==(d&&d.deleteEnabled)&&l.supportsDelete&&i.push("delete"),{hasAttachments:p,layer:o,supports:i}})).reverse()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"state",{get:function(){if(!this.get("view.ready")||0===this.editableItems.length)return"disabled";var e=this.attachmentsViewModel.mode;if("add"===e)return"adding-attachment";if("edit"===e)return"editing-attachment";var t=this.activeWorkflow;return t?t.stepId:"ready"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"syncing",{get:function(){return this.activityQueue.length>0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"view",{set:function(e){this.sketchViewModel.view=e,this.spinnerViewModel.view=e,this._set("view",e)},enumerable:!0,configurable:!0}),t.prototype.startCreateWorkflowAtFeatureTypeSelection=function(){return a(this,void 0,void 0,(function(){var e;return i(this,(function(t){switch(t.label){case 0:return this.canCreate?[4,this._cancelWorkflow()]:(M("editing:unsupported-workflow","Create workflow is unsupported or disabled."),[2]);case 1:return t.sent(),[4,(e=this._createCreateWorkflow()).start()];case 2:return t.sent(),this._set("activeWorkflow",e),[2]}}))}))},t.prototype.startCreateWorkflowAtFeatureCreation=function(e){return a(this,void 0,void 0,(function(){var t;return i(this,(function(r){switch(r.label){case 0:return this.canCreate?[4,this._cancelWorkflow()]:(M("editing:unsupported-workflow","Update workflow is unsupported or disabled."),[2]);case 1:return r.sent(),(t=this._createCreateWorkflow("awaiting-feature-to-create")).data.creationInfo=e,[4,t.start()];case 2:return r.sent(),this._set("activeWorkflow",t),[2]}}))}))},t.prototype.startCreateWorkflowAtFeatureEdit=function(e){return a(this,void 0,void 0,(function(){var t;return i(this,(function(r){switch(r.label){case 0:return this.canCreate?[4,this._cancelWorkflow()]:(M("editing:unsupported-workflow","Update workflow is unsupported or disabled."),[2]);case 1:return r.sent(),(t=this._createCreateWorkflow("editing-new-feature")).data.edits.feature=e,[4,t.start()];case 2:return r.sent(),this._set("activeWorkflow",t),[2]}}))}))},t.prototype.startUpdateWorkflowAtFeatureSelection=function(){return a(this,void 0,void 0,(function(){var e;return i(this,(function(t){switch(t.label){case 0:return this.canUpdate?[4,this._cancelWorkflow()]:(M("editing:unsupported-workflow","Update workflow is unsupported or disabled."),[2]);case 1:return t.sent(),[4,(e=this._createUpdateWorkflow()).start()];case 2:return t.sent(),this._set("activeWorkflow",e),[2]}}))}))},t.prototype.startUpdateWorkflowAtMultipleFeatureSelection=function(e){return a(this,void 0,void 0,(function(){var t;return i(this,(function(r){switch(r.label){case 0:return this.canUpdate?[4,this._cancelWorkflow()]:(M("editing:unsupported-workflow","Update workflow is unsupported or disabled."),[2]);case 1:return r.sent(),(t=this._createUpdateWorkflow("awaiting-update-feature-candidate")).data.candidates=e,[4,t.start()];case 2:return r.sent(),this._set("activeWorkflow",t),[2]}}))}))},t.prototype.startUpdateWorkflowAtFeatureEdit=function(e){return a(this,void 0,void 0,(function(){var t;return i(this,(function(r){switch(r.label){case 0:return this.canUpdate?[4,this._cancelWorkflow()]:(M("editing:unsupported-workflow","Update workflow is unsupported or disabled."),[2]);case 1:return r.sent(),(t=this._createUpdateWorkflow("editing-existing-feature")).data.edits.feature=e,[4,t.start()];case 2:return r.sent(),this._set("activeWorkflow",t),[2]}}))}))},t.prototype.deleteFeatureFromWorkflow=function(){return a(this,void 0,void 0,(function(){var e;return i(this,(function(t){switch(t.label){case 0:return(e=this.activeWorkflow)&&"create"!==e.type?[4,this._delete(e.data.edits.feature)]:(M("editing:unsupported-workflow","Deleting requires an active update workflow."),[2]);case 1:return t.sent(),[4,e.reset()];case 2:return t.sent(),[2]}}))}))},t.prototype.cancelWorkflow=function(e){return a(this,void 0,void 0,(function(){return i(this,(function(t){return[2,this._cancelWorkflow(n({warn:!0},e))]}))}))},t.prototype.refreshCreationTemplates=function(){this.featureTemplatesViewModel.layers=this.editableItems.filter((function(e){return e.supports.indexOf("create")>-1})).map((function(e){return e.layer})).toArray()},t.prototype._cancelWorkflow=function(e){return a(this,void 0,void 0,(function(){var t;return i(this,(function(r){switch(r.label){case 0:return(t=this.activeWorkflow)?!e||!1!==e.force?(this.emit("workflow-cancel"),this._set("activeWorkflow",null),[4,t.cancel(e)]):[3,2]:(e&&e.warn&&M("editing:no-active-workflow","There is no active workflow to cancel."),[2]);case 1:return r.sent(),[2];case 2:return[4,t.cancel(e)];case 3:return r.sent(),this._set("activeWorkflow",null),[2]}}))}))},t.prototype._createCreateWorkflow=function(e){var t=this;return k.create(this,e,(function(e){return t._create(e)}))},t.prototype._createUpdateWorkflow=function(e){var t=this;return b.create(this,e,(function(e){return t._update(e)}))},t.prototype._create=function(e){return a(this,void 0,void 0,(function(){return i(this,(function(t){switch(t.label){case 0:return[4,this._applyEdits(e.layer,{addFeatures:[e]})];case 1:return t.sent(),[2]}}))}))},t.prototype._delete=function(e){return a(this,void 0,void 0,(function(){return i(this,(function(t){switch(t.label){case 0:return[4,this._applyEdits(e.layer,{deleteFeatures:[e]})];case 1:return t.sent(),[2]}}))}))},t.prototype._update=function(e){return a(this,void 0,void 0,(function(){return i(this,(function(t){switch(t.label){case 0:return[4,this._applyEdits(e.layer,{updateFeatures:[e]})];case 1:return t.sent(),[2]}}))}))},t.prototype._applyEdits=function(e,t){return a(this,void 0,void 0,(function(){var r;return i(this,(function(o){switch(o.label){case 0:return[4,this._queueOperation((function(){return e.applyEdits(t)}))];case 1:return o.sent(),[4,this.view.whenLayerView(e)];case 2:return r=o.sent(),[4,f.whenFalseOnce(r,"updating")];case 3:return o.sent(),[2]}}))}))},t.prototype._queueOperation=function(e){var t=this;this.activityQueue.push(e),this.notifyChange("syncing");var r=function(e,t){var r=t.indexOf(e);r>-1&&t.splice(r,1)};return e().then((function(e){var t=e.addFeatureResults,r=e.deleteFeatureResults,o=e.updateFeatureResults,n=s.find(t,(function(e){return!!e.error}))||s.find(o,(function(e){return!!e.error}))||s.find(r,(function(e){return!!e.error}));if(n)throw n.error})).catch((function(o){M("editing:operation-error","An error occurred.",{error:o});var n={error:o,retry:function(){return r(n,t.failures),t._queueOperation(e)},cancel:function(){r(n,t.failures)}};t._set("failures",t.failures.concat([n]))})).then((function(){r(e,t.activityQueue),t.notifyChange("syncing")}))},o([w.property({readOnly:!0})],t.prototype,"activeWorkflow",void 0),o([w.property({readOnly:!0})],t.prototype,"activityQueue",void 0),o([w.property({value:V.slice()})],t.prototype,"allowedWorkflows",null),o([w.property({readOnly:!0,dependsOn:["editableItems"]})],t.prototype,"canCreate",null),o([w.property({readOnly:!0,dependsOn:["editableItems"]})],t.prototype,"canUpdate",null),o([w.property({dependsOn:["allowedWorkflows","layerInfos","view.allLayerViews","view.ready"],readOnly:!0})],t.prototype,"editableItems",null),o([w.property({readOnly:!0})],t.prototype,"failures",void 0),o([w.property()],t.prototype,"attachmentsViewModel",void 0),o([w.property()],t.prototype,"featureFormViewModel",void 0),o([w.property()],t.prototype,"featureTemplatesViewModel",void 0),o([w.property()],t.prototype,"layerInfos",void 0),o([w.property()],t.prototype,"sketchViewModel",void 0),o([w.property()],t.prototype,"spinnerViewModel",void 0),o([w.property({dependsOn:["attachmentsViewModel.mode","editableItems","activeWorkflow.stepId","view.ready"]})],t.prototype,"state",null),o([w.property({readOnly:!0})],t.prototype,"syncing",null),o([w.property()],t.prototype,"view",null),t=o([w.subclass("esri.widgets.Editor.EditorViewModel")],t)}(w.declared(d.HandleOwnerMixin(l.EventedAccessor)))}));