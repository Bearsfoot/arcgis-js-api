// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/generatorHelper","../../core/tsSupport/awaiterHelper","../../core/tsSupport/assignHelper","../../core/arrayUtils","../../core/compilerUtils","../../core/maybe","../../core/promiseUtils","../../core/screenUtils","../../core/accessorSupport/diffUtils","../../layers/support/fieldUtils","../../renderers/support/clickToleranceUtils","../../renderers/support/utils","../../renderers/visualVariables/support/sizeVariableUtils","../../renderers/visualVariables/support/visualVariableUtils","../../symbols/support/symbolConversion","../../symbols/support/symbolLayerUtils","../../symbols/support/symbolUtils","../../views/support/drapedUtils"],(function(e,t,r,n,i,a,u,s,l,o,c,f,d,p,v,y,h,b,m,g){function w(e,t){var r="heading"===(e.axis||"heading")&&"arithmetic"===e.rotationType?-1:1,n=e.field,i=t.fields&&t.fields.filter((function(e){return e.name===n})),a=i&&1===i.length?i[0].type:"double",u={initial:0,current:0};return{field:n,getDefault:function(){return l.resolve(0)},getValue:function(e){return u.current=u.initial-r*e,z((u.current+360)%360,a)},initValue:function(e){u.initial=null!=e?e:u.current,u.current=0},isUpdatingInteractively:!1}}function I(e,t){switch(t){case"width":return e[0];case"depth":return e[1];case"height":return e[2];default:return e[2]||e[1]||e[0]}}function V(e,i,a){return n(this,void 0,void 0,(function(){var n,l,o,c,f,d;return r(this,(function(r){switch(r.label){case 0:if(s.isNone(i))return[2,0];if(n=h.to3D(i).symbol,s.isNone(n)||"web-style"===n.type)return[2,0];if(!(l=n.symbolLayers.getItemAt(0)))return[2,0];switch(l.type){case"icon":return[3,1];case"text":return[3,4];case"line":return[3,5];case"object":return[3,6];case"path":case"extrude":return[3,8];case"fill":case"water":return[3,9]}return[3,10];case 1:return(o=l.size)?[3,3]:(f=(c=Math).min,d=[t.sizeDefaults.icon],[4,b.computeIconLayerResourceSize(l,t.sizeDefaults.icon)]);case 2:o=f.apply(c,d.concat([r.sent()[0]])),r.label=3;case 3:return[2,o||t.sizeDefaults.icon];case 4:return[2,l.size||t.sizeDefaults.text];case 5:return[2,l.size||t.sizeDefaults.line];case 6:return[4,b.computeObjectLayerResourceSize(l,e.scale/t.sizeDefaults.viewScaleSizeFactor)];case 7:return[2,I(r.sent(),a)];case 8:return[2,l.size||e.scale/t.sizeDefaults.viewScaleSizeFactor];case 9:return[2,0];case 10:return u.neverReached(l),[2,0]}}))}))}function U(e,t){var i,a=this,u=e.field,s=e.axis,l=t.fields&&t.fields.filter((function(e){return e.name===u})),o=l&&1===l.length?l[0].type:"double",c={updating:!1,initial:0,current:0},f=p.meterIn[e.valueUnit];return i="area"===e.valueRepresentation?function(e){return Math.pow(e*f/2,2)*Math.PI}:"radius"===e.valueRepresentation||"distance"===e.valueRepresentation?function(e){return e*f/2}:function(e){return e*f},{field:u,getDefault:function(e,t){return n(a,void 0,void 0,(function(){var n,a;return r(this,(function(r){switch(r.label){case 0:return n=z,a=i,[4,V(t,e,s)];case 1:return[2,n.apply(void 0,[a.apply(void 0,[r.sent()]),o])]}}))}))},getValue:function(e,t){return c.initial||(c.initial=t.pixelSizeAt(t.center)),c.current=c.initial*e,z(c.current,o)},initValue:function(e){c.initial=null!=e?e:c.current,c.current=0},isUpdatingInteractively:!1}}function z(e,t){switch(t){case"small-integer":case"integer":case"long":return Math.round(e);case"double":case"single":return e;default:return 0}}function S(e){return n(this,void 0,void 0,(function(){var t,n;return r(this,(function(r){switch(r.label){case 0:return[4,m.getDisplayedSymbol(e,{ignoreGraphicSymbol:!0})];case 1:return t=r.sent(),n=c.diff(e.symbol,t),s.isSome(n)&&(e.symbol=t),[2]}}))}))}function F(e,t,i){return n(this,void 0,void 0,(function(){var n,a;return r(this,(function(r){switch(r.label){case 0:return 0===e.length?[2,[]]:[4,t.hitTest(i)];case 1:return 0===(n=r.sent()).results.length?[2,[]]:(a=new Map,n.results.forEach((function(e){var t=e.graphic,r=t.layer;a.has(r)||a.set(r,[]),a.get(r).push(t)})),[2,l.eachAlways(e.items.filter((function(e){var t=e.layer;return e.supports.indexOf("update")>-1&&a.has(t)})).map((function(e){var t=e.layer,r=t.objectIdField,n=t.displayField,i=[r];f.hasField(t.fields,n)&&i.push(n);var u=a.get(t);if(!!u.some((function(e){return i.some((function(t){return!(t in e.attributes)}))}))){var s=t.createQuery();return s.outFields=i,s.returnGeometry=!1,s.objectIds=u.map((function(e){return e.getObjectId()})),t.queryFeatures(s).then((function(e){return e.features}))}return l.resolve(u)})))])}}))}))}function x(e,t,i){return n(this,void 0,void 0,(function(){var n,a;return r(this,(function(r){switch(r.label){case 0:return 0===e.length?[2,[]]:[4,t.hitTest(i)];case 1:return 0===(n=r.sent()).results.length?[2,[]]:(a=new Set,n.results.forEach((function(e){var t=e.graphic;return a.add(t.layer)})),[2,l.eachAlways(e.items.filter((function(e){var t=e.layer;return e.supports.indexOf("update")>-1&&a.has(t)})).map((function(e){var r=e.layer,n=r.objectIdField,a=r.displayField,u=[n];f.hasField(r.fields,a)&&u.push(a);var s=r.createQuery();s.outFields=u,s.returnGeometry=!1;var l=d.calculateTolerance({renderer:r.renderer,event:i});return s.geometry=g.createQueryGeometry(i.mapPoint,l,t),r.queryFeatures(s).then((function(e){return e.features}))})))])}}))}))}Object.defineProperty(t,"__esModule",{value:!0}),t.getVisualVariableAttributes=function(e){var t=e.layer,r=function(e){switch(e.type){case"class-breaks":case"simple":case"unique-value":case"dot-density":case"dictionary":return!0;default:return!1}}(t.renderer)&&y.getVisualVariableValues(t.renderer,e),n=r?r.map((function(e){return e.variable})):[],i=n.filter((function(e){return"rotation"===e.type&&(!e.axis||"heading"===e.axis)})),a=i[0],u=1===i.length&&a.field&&!a.valueExpression,s=n.filter((function(e){return"size"===e.type})),l=s[0],o=1===s.length&&"real-world-size"===v.getTransformationType(l)&&l.field&&!l.useSymbolValue&&!l.valueExpression;return{rotation:u&&w(a,t),size:o&&U(l,t)}},t.setUpFeatureAdd=function(e,t,a,u,s){var l=this,o=t.layer;e.layer.elevationInfo=o.elevationInfo,e.create(o.geometryType,{hasZ:o.capabilities.data.supportsZ});var c=e.on("create",(function(a){var c=a.state,f=a.graphic;return n(l,void 0,void 0,(function(){var n;return r(this,(function(r){switch(r.label){case 0:return"cancel"===c?(s(),[2]):"complete"!==c?[3,2]:((n=f.clone()).attributes=i({},t.template.prototype.attributes),n.layer=o,e.layer.remove(f),[4,S(n)]);case 1:r.sent(),u(n),r.label=2;case 2:return[2]}}))}))}));return a.map.add(e.layer),{remove:function(){c.remove(),a.map.remove(e.layer),e.cancel()}}},t.findLayerInfo=function(e,t){return e&&a.find(e,(function(e){return e.layer===t}))},t.fetchCandidates=function(e,t,i){return n(this,void 0,void 0,(function(){return r(this,(function(r){switch(t.type){case"3d":return[2,F(e,t,i)];case"2d":return[2,x(e,t,i)];default:return u.neverReached(t),[2,null]}return[2]}))}))},t.fetchFullFeature=function(e,t,r){var n=e.layer,i=n.createQuery();return i.objectIds=[e.getAttribute(n.objectIdField)],i.outFields=["*"],i.outSpatialReference=t.spatialReference,i.returnM=n.capabilities.data.supportsM,i.returnZ=n.capabilities.data.supportsZ,n.queryFeatures(i,r).then((function(e){return e.features[0]}))},t.setUpGeometryUpdate=function(e,t,i,a,u){return n(this,void 0,void 0,(function(){var s,l,o,c,f,d,p,v,y,h=this;return r(this,(function(b){switch(b.label){case 0:return[4,S(s=e.clone())];case 1:return b.sent(),i.layer.add(s),s.sourceLayer=e.layer,l=function(){var t=e.layer;if("graphics"===t.type)return{remove:function(){}};var r=t.objectIdField,n=e.attributes[r],i=a.whenLayerView(t);return i.then((function(e){return e.setVisibility(n,!1)})),{remove:function(){i.then((function(e){return e.setVisibility(n,!0)}))}}}(),o=e.layer,c=t.size,f=t.rotation,d={multipleSelectionEnabled:!1},"point"===o.geometryType&&(d.enableRotation=!!f,d.enableScaling=!!c),i.layer.elevationInfo=o.elevationInfo,i.update(s,d),p=(!!c||!!f)&&e.watch("attributes",(function(e){return n(h,void 0,void 0,(function(){var t,n,i;return r(this,(function(r){switch(r.label){case 0:for(n in t=!1,e)(i=e[n])!==s.attributes[n]&&(s.setAttribute(n,i),t=!0,c&&!c.isUpdatingInteractively&&c.field===n&&c.initValue(i),f&&!f.isUpdatingInteractively&&f.field===n&&f.initValue(i));return t&&"3d"===a.type?[4,S(s)]:[3,2];case 1:r.sent(),r.label=2;case 2:return[2]}}))}))})),[f,c].forEach((function(t){return n(h,void 0,void 0,(function(){var n,i;return r(this,(function(r){switch(r.label){case 0:return t?null==(n=e.attributes[t.field])?[3,1]:(t.initValue(n),[3,4]):[2];case 1:return[4,t.getDefault(s.symbol,a)];case 2:return i=r.sent(),t.initValue(i),s.setAttribute(t.field,i),"3d"!==a.type?[3,4]:[4,S(s)];case 3:r.sent(),r.label=4;case 4:return[2]}}))}))})),v=i.on("update",(function(e){return n(h,void 0,void 0,(function(){var t,n,l,o,p,v,y,h,b;return r(this,(function(r){switch(r.label){case 0:return t=e.graphics[0],n=e.state,l=e.aborted,o=e.toolEventInfo,"complete"===n&&l?(i.update(t,d),[2]):(p=o,f&&p&&(y=f.field,h=f.getValue,b=f.initValue,"rotate-stop"===p.type?(f.isUpdatingInteractively=!1,b()):null!=p.angle&&(f.isUpdatingInteractively=!0,s.attributes[y]=h(p.angle/Math.PI*180,a))),v=o,c&&v&&(y=c.field,h=c.getValue,b=c.initValue,"scale-stop"===v.type?(c.isUpdatingInteractively=!1,b()):null!=v.xScale&&(c.isUpdatingInteractively=!0,s.attributes[y]=h(v.xScale,a))),"3d"!==a.type?[3,2]:[4,S(s)]);case 1:r.sent(),r.label=2;case 2:return u(t.clone()),[2]}}))}))})),a.map.add(i.layer),y=function(){},[2,{interactive:{remove:function(){v.remove(),i.cancel(),p&&p.remove(),this.remove=y}},visual:{remove:function(){l.remove(),a.map.remove(i.layer),i.layer.removeAll(),this.remove=y}}}]}}))}))},t.sizeDefaults={icon:o.px2pt(24),text:o.px2pt(12),line:o.px2pt(1),viewScaleSizeFactor:100}}));