// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/assignHelper","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","dojo/i18n!./HistogramRangeSlider/nls/HistogramRangeSlider","../Color","../core/watchUtils","../core/accessorSupport/decorators","../core/accessorSupport/ensureType","./Histogram","./Slider","./Widget","./HistogramRangeSlider/HistogramRangeSliderViewModel","./smartMapping/support/utils","./support/widget"],(function(e,t,a,r,i,n,o,l,s,d,u,p,c,h,v,g){var m="esri-histogram-range-slider",b="esri-histogram-range-slider__slider-container",y="esri-histogram-range-slider__histogram-container",_="esri-histogram-range-slider__range-type--",w="esri-widget",f="esri-disabled";return function(e){function t(t){var a=e.call(this,t)||this;return a._barElements=[],a._histogram=null,a._slider=null,a.average=null,a.barCreatedFunction=null,a.bins=null,a.dataLines=null,a.dataLineCreatedFunction=null,a.excludedBarColor=new o("#d7e5f0"),a.hasTimeData=null,a.includedBarColor=new o("#599dd4"),a.label=n.widgetLabel,a.labelFormatFunction=null,a.max=null,a.min=null,a.precision=4,a.rangeType=null,a.standardDeviation=null,a.standardDeviationCount=1,a.values=null,a.viewModel=new h,a}return r(t,e),t.prototype.postInitialize=function(){var e=this,t=this,a=t.average,r=t.bins,i=t.hasTimeData,n=t.max,o=t.min,s=t.viewModel;this._updateBarFill=this._updateBarFill.bind(this),this._histogram=new u({average:a,bins:r,barCreatedFunction:function(t,a){0===t&&(e._barElements=[]),e._barElements.push(a),e._updateBarFill(t,a),e.barCreatedFunction&&e.barCreatedFunction(t,a)},dataLines:this._getDataLines(),dataLineCreatedFunction:function(t,a){e.dataLineCreatedFunction&&e.dataLineCreatedFunction(t,a)},labelFormatFunction:this.labelFormatFunction,layout:"horizontal",max:n,min:o}),this._slider=new p({labelFormatFunction:this.labelFormatFunction,layout:"horizontal",visibleElements:{labels:!0,rangeLabels:!0},rangeLabelInputsEnabled:!i,viewModel:s}),this.own(this._slider.on(["max-change","min-change"],(function(t){return e.emit(t.type,t)})),this._slider.on(["segment-drag","thumb-change","thumb-drag"],(function(t){e._updateBarFills(),e.emit(t.type,t)})),l.watch(this,"bins",(function(){var t=e,a=t._histogram,r=t.bins;if(r&&a.bins){var i=a.bins.length-r.length;e._barElements.splice(-i,i)}else e._barElements=[];a.set({bins:r}),e._updateBarFills(),e.scheduleRender()})),l.watch(this,["max","min","rangeType","values"],(function(){var t=e,a=t._histogram,r=t.max,i=t.min;a.set({max:r,min:i}),e._updateBarFills(),e.scheduleRender()})),l.watch(this,["average","dataLines","standardDeviation","standardDeviationCount"],(function(){var t=e,a=t._histogram,r=t.average;a.set({average:r,dataLines:e._getDataLines()})})),l.watch(this,"labelFormatFunction",(function(){var t=e,a=t._histogram,r=t.labelFormatFunction;a.set({labelFormatFunction:r})})),l.watch(this,"hasTimeData",(function(){e._slider.set({rangeLabelInputsEnabled:!e.hasTimeData})})))},t.prototype.generateWhereClause=function(e){return this.viewModel.generateWhereClause(e)},t.prototype.render=function(){var e=this.rangeType,t=this.viewModel,a=this.label,r=this.classes(m,w,""+_+e,"disabled"===t.state?f:null);return g.tsx("div",{"aria-label":a,class:r},"disabled"===t.state?null:this.renderContent())},t.prototype.renderContent=function(){return[this.renderHistogram(),this.renderSlider()]},t.prototype.renderSlider=function(){return g.tsx("div",{key:this.id+"-slider-container",class:b},this._slider.render())},t.prototype.renderHistogram=function(){return g.tsx("div",{class:y},this._histogram.render())},t.prototype._getDataLines=function(){return this._getStandardDeviationDataLines().concat(this.dataLines||[])},t.prototype._getStandardDeviationDataLines=function(){var e=this.average,t=this.standardDeviation,a=this.standardDeviationCount;return v.getDeviationValues(t,e,a).map((function(e){return{value:e}}))},t.prototype._updateBarFills=function(){var e=this;this._barElements.forEach((function(t,a){return e._updateBarFill(a,t)}))},t.prototype._updateBarFill=function(e,t){t.setAttribute("fill",this._getFillForBar(e).toHex())},t.prototype._getFillForBar=function(e){var t=this.bins,a=this.rangeType,r=this.values;if(!(t&&t.length&&a&&r.length))return null;var i=t[e];if(!i)return null;var n=i.maxValue,o=i.minValue,l=n-o;switch(a){case"equal":case"not-equal":return this.includedBarColor;case"less-than":case"at-most":return r[0]>o&&r[0]<n?this._getBlendedColor((r[0]-o)/l):o<r[0]?this.includedBarColor:this.excludedBarColor;case"greater-than":case"at-least":return r[0]>o&&r[0]<n?this._getBlendedColor(1-(r[0]-o)/l):o>r[0]?this.includedBarColor:this.excludedBarColor;case"between":if(2===r.length)return r[0]>o&&r[0]<n?this._getBlendedColor(1-(r[0]-o)/l):r[1]>o&&r[1]<n?this._getBlendedColor((r[1]-o)/l):o>=r[0]&&n<=r[1]?this.includedBarColor:this.excludedBarColor;case"not-between":if(2===r.length)return r[0]>o&&r[0]<n?this._getBlendedColor((r[0]-o)/l):r[1]>o&&r[1]<n?this._getBlendedColor(1-(r[1]-o)/l):o>r[0]&&n<r[1]?this.excludedBarColor:this.includedBarColor;default:return this.includedBarColor}},t.prototype._getBlendedColor=function(e){return o.blendColors(this.excludedBarColor,this.includedBarColor,e)},i([s.aliasOf("viewModel.average")],t.prototype,"average",void 0),i([s.property(),g.renderable()],t.prototype,"barCreatedFunction",void 0),i([s.aliasOf("viewModel.bins")],t.prototype,"bins",void 0),i([s.property(),g.renderable()],t.prototype,"dataLines",void 0),i([s.property(),g.renderable()],t.prototype,"dataLineCreatedFunction",void 0),i([s.property({type:o,json:{type:[d.Integer],write:!0}})],t.prototype,"excludedBarColor",void 0),i([s.aliasOf("viewModel.hasTimeData")],t.prototype,"hasTimeData",void 0),i([s.property({type:o,json:{type:[d.Integer],write:!0}})],t.prototype,"includedBarColor",void 0),i([s.property()],t.prototype,"label",void 0),i([s.aliasOf("viewModel.labelFormatFunction")],t.prototype,"labelFormatFunction",void 0),i([s.aliasOf("viewModel.max")],t.prototype,"max",void 0),i([s.aliasOf("viewModel.min")],t.prototype,"min",void 0),i([s.aliasOf("viewModel.precision")],t.prototype,"precision",void 0),i([s.aliasOf("viewModel.rangeType")],t.prototype,"rangeType",void 0),i([s.aliasOf("viewModel.standardDeviation")],t.prototype,"standardDeviation",void 0),i([s.property(),g.renderable()],t.prototype,"standardDeviationCount",void 0),i([g.renderable(),s.aliasOf("viewModel.values")],t.prototype,"values",void 0),i([s.property(),g.renderable(["viewModel.average","viewModel.hasTimeData","viewModel.labelFormatFunction","viewModel.max","viewModel.min","viewModel.precision","viewModel.rangeType","viewModel.standardDeviation","viewModel.values"])],t.prototype,"viewModel",void 0),t=i([s.subclass("esri.widgets.HistogramRangeSlider")],t)}(s.declared(c))}));