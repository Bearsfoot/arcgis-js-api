// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","../core/tsSupport/assignHelper","../core/tsSupport/generatorHelper","../core/tsSupport/awaiterHelper","../Color","../request","../core/Error","../core/lang","../core/Logger","../core/LRUCache","../core/maybe","../core/promiseUtils","../core/SetUtils","../core/accessorSupport/decorators","../layers/support/fieldUtils","./Renderer","./mixins/VisualVariablesMixin","../support/arcadeOnDemand","../symbols/CIMSymbol"],(function(e,t,r,i,s,n,o,l,a,u,c,p,h,f,y,d,m,b,g,v,S,_){var w=p.getLogger("esri.renderers.DictionaryRenderer");return function(e){function t(t){var r=e.call(this,t)||this;return r._ongoingRequests=new Map,r._symbolCache=new h(100),r.config=null,r.description=null,r.fieldMap=null,r.label=null,r.scaleExpression=null,r.url=null,r.type="dictionary",r}var p;return r(t,e),p=t,t.prototype.clone=function(){return new p({config:c.clone(this.config),scaleExpression:c.clone(this.scaleExpression),description:c.clone(this.description),fieldMap:c.clone(this.fieldMap),label:c.clone(this.label),url:c.clone(this.url),visualVariables:c.clone(this.visualVariables)})},t.prototype.getSymbolAsync=function(e,t){return o(this,void 0,void 0,(function(){var r,i,s,o,a,u,c,p,h,f,d,m,b,g,v,S,_,w,R,M,j,x,N,q,C,O,P=this;return n(this,(function(n){switch(n.label){case 0:this._dictionaryPromise||(this._dictionaryPromise=this.fetchResources(t)),n.label=1;case 1:return n.trys.push([1,3,,4]),[4,this._dictionaryPromise];case 2:return r=n.sent(),[3,4];case 3:return i=n.sent(),y.isAbortError(i)?(this._dictionaryPromise=null,[2,null]):[3,4];case 4:for(s={},o=0,a=this._symbolAttributes;o<a.length;o++)u=a[o],(c=this.fieldMap[u])&&null!==e.attributes[c]&&void 0!==e.attributes[c]?(p=""+e.attributes[c],s[u]=p):s[u]="";if(!(h=r(s,t))||"string"!=typeof h)return[2,null];for(f=h.split(";"),d=[],m=[],b=0,g=f;b<g.length;b++)if((v=g[b])&&0!==v.length)if(-1===v.indexOf("po:"))if(-1!==v.indexOf("|"))for(j=0,x=v.split("|");j<x.length;j++)N=x[j],this._itemNames.has(N)&&d.push(N);else this._itemNames.has(v)&&d.push(v);else 3===(S=v.substr(3).split("|")).length&&(_=S[0],w=S[1],R=S[2],"DashTemplate"===w?R=R.split(" ").map((function(e){return Number(e)})):"Color"===w?(M=new l(R).toRgba(),R=[M[0],M[1],M[2],255*M[3]]):R=Number(R),m.push({primitiveName:_,propertyName:w,value:R}));return q=d.join(";")+m.map((function(e){return e.primitiveName+";"+e.propertyName+";"+e.value})),(C=this._symbolCache.get(q))?(C.catch((function(){P._symbolCache.pop(q)})),[2,C]):(O=this._cimPartsToCIMSymbol(d,m,t),this._symbolCache.put(q,O,1),[2,O])}}))}))},t.prototype.collectRequiredFields=function(e,t){return o(this,void 0,void 0,(function(){var r,i;return n(this,(function(s){switch(s.label){case 0:return[4,this.collectVVRequiredFields(e,t)];case 1:return s.sent(),this.scaleExpression?[4,b.collectArcadeFieldNames(e,t,this.scaleExpression)]:[3,3];case 2:s.sent(),s.label=3;case 3:for(i in r=t.map((function(e){return e.name})),this.fieldMap)r.indexOf(this.fieldMap[i])<0||e.add(this.fieldMap[i]);return[2]}}))}))},Object.defineProperty(t.prototype,"arcadeRequired",{get:function(){return!0},enumerable:!0,configurable:!0}),t.prototype.fetchResources=function(e){return o(this,void 0,void 0,(function(){var t,r,i,o,l,c,p,h,m,b,g,v,_,R,M,j,x;return n(this,(function(n){switch(n.label){case 0:return this.url?(t=f.isSome(e)?e.abortOptions:null,r=a(this.url+"/resources/styles/dictionary-info.json",s({responseType:"json",query:{f:"json"}},t)),[4,y.all([r,S.loadArcade()])]):(w.error("no valid URL!"),[2,void 0]);case 1:if(!(i=n.sent()[0].data))throw new u("esri.renderers.DictionaryRenderer","Bad dictionary data!");if(o=i.expression,l=i.authoringInfo,this._refSymbolUrlTemplate=this.url+"/"+i.cimRefTemplateUrl,this._itemNames=d.createSetFromValues(i.itemsNames),this._symbolAttributes=l.symbol,c={},this.config)for(M in p=this.config)c[M]=p[M];for(h=0,m=l.configuration;h<m.length;h++)M=m[h],c.hasOwnProperty(M.name)||(c[M.name]=M.value);if(b=[],f.isSome(e)&&e.fields)for(g=function(t){var r=v.fieldMap[t],i=e.fields.filter((function(e){return e.name===r}));i.length>0&&b.push(s({},i[0],{name:t}))},v=this,_=0,R=this._symbolAttributes;_<R.length;_++)M=R[_],g(M);return[4,S.createDictionaryExpression(o,f.isSome(e)?e.spatialReference:null,b,c)];case 2:return j=n.sent(),x={scale:0},[2,function(e,t){var r=j.repurposeFeature({geometry:null,attributes:e});return x.scale=f.isSome(t)?t.scale:void 0,j.evaluate({$feature:r,$view:x})}]}}))}))},t.prototype.getSymbol=function(){return null},t.prototype.getSymbols=function(){return[]},t.prototype.getAttributeHash=function(){return this.visualVariables&&this.visualVariables.reduce((function(e,t){return e+t.getAttributeHash()}),"")},t.prototype.getMeshHash=function(){return this.url+"-"+JSON.stringify(this.fieldMap)},t.prototype._getSymbolPart=function(e,t){return o(this,void 0,void 0,(function(){var r,i,o;return n(this,(function(n){switch(n.label){case 0:if(this._ongoingRequests.has(e))return[2,this._ongoingRequests.get(e).then((function(e){return e.data}))];r=this._refSymbolUrlTemplate.replace(/\{itemName\}/gi,e),i=a(r,s({responseType:"json",query:{f:"json"}},t)),this._ongoingRequests.set(e,i),n.label=1;case 1:return n.trys.push([1,3,,4]),[4,i];case 2:return[2,n.sent().data];case 3:return o=n.sent(),this._ongoingRequests.delete(e),[2,y.reject(o)];case 4:return[2]}}))}))},t.prototype._combineSymbolParts=function(e,t){var r;if(!e||0===e.length)return null;if(1===e.length)return{type:"CIMSymbolReference",symbol:e[0],primitiveOverrides:t};var i=s({},e[0]);i.symbolLayers=[];for(var n=0,o=e;n<o.length;n++){var l=o[n];(r=i.symbolLayers).unshift.apply(r,l.symbolLayers)}return{type:"CIMSymbolReference",symbol:i,primitiveOverrides:t}},t.prototype._cimPartsToCIMSymbol=function(e,t,r){return o(this,void 0,void 0,(function(){var i,s,o;return n(this,(function(n){switch(n.label){case 0:for(i=new Array(e.length),s=0;s<e.length;s++)i[s]=this._getSymbolPart(e[s],r);return[4,y.all(i)];case 1:return o=n.sent(),[2,new _({data:this._combineSymbolParts(o,t)})]}}))}))},i([m.property({type:Object,json:{write:!0}})],t.prototype,"config",void 0),i([m.property({type:String,json:{write:!0}})],t.prototype,"description",void 0),i([m.property({type:Object,json:{write:!0}})],t.prototype,"fieldMap",void 0),i([m.property({type:String,json:{write:!0}})],t.prototype,"label",void 0),i([m.property({type:String,json:{write:!0}})],t.prototype,"scaleExpression",void 0),i([m.property({type:String,json:{write:!0}})],t.prototype,"url",void 0),t=p=i([m.subclass("esri.renderers.DictionaryRenderer")],t)}(m.declared(v.VisualVariablesMixin(g)))}));