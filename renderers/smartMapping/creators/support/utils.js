// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/assignHelper","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../Color","../../../../symbols","../../../../core/compilerUtils","../../../../core/Error","../../../../core/maybe","../../../../core/promiseUtils","../../../../intl/date","../../heuristics/outline","../../statistics/classBreaks","../../statistics/summaryStatistics","../../support/utils","../../../support/numberUtils","../../../support/pointCloud/PointSizeSplatAlgorithm","../../../../views/support/colorUtils"],(function(e,t,n,r,i,o,l,a,s,u,c,m,d,f,y,p,h,v,g){Object.defineProperty(t,"__esModule",{value:!0});var b=/^(\d+(\.\d+)?)\s*(%)$/i,w=[0,0,0,.4],S=["hours","minutes","seconds"],D=[].concat(p.defaultBasemapGroups.light).concat(p.defaultBasemapGroups.dark);function z(e,t){return new s(e,t)}function x(e,t,n){var r,i,o=function(e){var t,n,r=e&&e.statistics;r||(r={});if(null==r.min)if(e.isDate){var i=L();t=i[0],n=i[1]}else t=0,n=100;else if(r.min===r.max)if(e.isDate){var o=L(r.min);t=o[0],n=o[1]}else r.min<0?(t=2*r.min,n=0):r.min>0?(t=0,n=2*r.min):(t=0,n=100);return{min:null!=t?t:r.min,max:null!=n?n:r.max,defaultValuesUsed:null!=t||null!=n}}({statistics:e,isDate:t});return o.defaultValuesUsed?(r=o.min,i=o.max):!n||null!=e.avg&&e.stddev||(r=e.min,i=e.max),null!=r?[r,i]:null}function L(e){var t=("number"==typeof e?new Date(e):new Date).getUTCFullYear(),n=Date.UTC(t,0,1,12,0,0,0),r=Date.UTC(t,11,31,12,0,0,0);return"number"==typeof e&&(e<n&&(n=e),e>r&&(r=e)),[n,r]}t.formatDate=function(e,t,n){if("string"==typeof e){var r=n.getField(e);if(r&&"date"===r.type)return r.alias||r.name}else if("number"==typeof e||e instanceof Date){var i=S.indexOf(t)>-1?"short-date-short-time":"short-date";return m.formatDate(e,m.convertDateFormatToIntlOptions(i))}return e},t.createError=z,t.getDefaultDataRange=x,t.createColors=function(e,t){for(var n=[],r=e.length,i=0;i<t;i++)n.push(new o(e[i%r]));return n},t.createStopValues=function(e,t){void 0===t&&(t=!0);var n=e.avg,r=n-e.stddev,i=n+e.stddev;r<e.min&&(r=e.min),i>e.max&&(i=e.max),t&&(n=r+(i-r)/2);var o=h.round([r,i],{strictBounds:!0});return o=[r=o[0],r+(n-r)/2,n,n+((i=o[1])-n)/2,i],h.round(o,{strictBounds:!0})},t.getSymbolSizeFromScheme=function(e,t,n){switch(t){case"point":case"multipoint":return n?"noDataSize"in e?e.noDataSize:null:"size"in e?e.size:null;case"polyline":return n?"noDataWidth"in e?e.noDataWidth:null:"width"in e?e.width:null;case"polygon":return"size"in e?e.size:null;case"mesh":return;default:return void a.neverReached(t)}},t.getSymbolOutlineFromScheme=function(e,t,n){switch(t){case"point":case"multipoint":case"polygon":if(!("outline"in e))return null;var r={color:e.outline.color,width:e.outline.width};if(null!=n&&r.color){var i=r.color.clone();i.a=n,r.color=i}return r;case"polyline":case"mesh":return;default:return void a.neverReached(t)}},t.createSymbol=function(e,t){var n,r=t.type,i=t.size,o=t.color,a=t.outline;switch(e){case"point":case"multipoint":if("2d"===r)n=new l.SimpleMarkerSymbol({color:o,size:i,outline:{color:a.color,width:a.width}});else if("3d-flat"===r)n=new l.PointSymbol3D({symbolLayers:[new l.IconSymbol3DLayer({size:i,resource:{primitive:"circle"},material:{color:o},outline:{color:a.color,size:a.width}})]});else if(r.indexOf("3d-volumetric")>-1){var s="3d-volumetric-uniform"===r,u=s?"sphere":"cylinder",c=new l.ObjectSymbol3DLayer({height:i,resource:{primitive:u},material:{color:o}});s||(c.width=t.widthAndDepth,c.depth=t.widthAndDepth),n=new l.PointSymbol3D({symbolLayers:[c]})}break;case"polyline":"2d"===r?n=new l.SimpleLineSymbol({color:o,width:i}):"3d-flat"===r?n=new l.LineSymbol3D({symbolLayers:[new l.LineSymbol3DLayer({size:i,material:{color:o}})]}):"3d-volumetric"===r&&(n=new l.LineSymbol3D({symbolLayers:[new l.PathSymbol3DLayer({size:i,material:{color:o}})]}));break;case"polygon":"2d"===r?n=new l.SimpleFillSymbol({color:o,outline:{color:a.color,width:a.width}}):"3d-flat"===r?n=new l.PolygonSymbol3D({symbolLayers:[new l.FillSymbol3DLayer({material:{color:o},outline:{color:a.color,size:a.width}})]}):"3d-volumetric"===r&&(n=new l.PolygonSymbol3D({symbolLayers:[new l.ExtrudeSymbol3DLayer({size:i,material:{color:o}})]}));break;case"mesh":var m=t.meshInfo&&t.meshInfo.colorMixMode,d=t.meshInfo&&t.meshInfo.edgesType;n=new l.MeshSymbol3D({symbolLayers:[new l.FillSymbol3DLayer({material:{color:o,colorMixMode:m},edges:null==d||"none"===d?null:{type:d,color:w}})]})}return n},t.verifyBasicFieldValidity=function(e,t,n){var r=function(e){var t=e.layer;return e.fields.filter((function(e){return!t.getField(e)}))}({layer:e,fields:t});if(r.length)return z(n,"Unknown fields: "+r.join(", ")+". You can only use fields defined in the layer schema");var i=function(e){var t=e.layer;return e.fields.filter((function(e){var n=t.getFieldUsageInfo(e);return!n||!n.supportsRenderer}))}({layer:e,fields:t});return i.length?z(n,"Unsupported fields: "+i.join(", ")+". You can only use fields that are accessible to the renderer i.e. FieldUsageInfo.supportsRenderer must be true"):void 0},t.getClassBreaks=function(e,t){return i(this,void 0,void 0,(function(){var i,o,l,a,s,u;return r(this,(function(r){switch(r.label){case 0:return i={layer:e.layer,view:e.view,signal:e.signal},[4,c.all([f(e),t?d(i):null])];case 1:return o=r.sent(),l=o[0],a=o[1],(s=x({min:l.minValue,max:l.maxValue,avg:null,stddev:null},!1,!1))?[4,f(n({},e,{classificationMethod:"equal-interval",numClasses:1,analyzeData:!1,minValue:s[0],maxValue:s[1],normalizationTotal:s[0]+s[1]}))]:[3,3];case 2:return u=r.sent(),[3,4];case 3:u=l,r.label=4;case 4:return[2,{result:u,defaultValuesUsed:!!s,outlineResult:a}]}}))}))},t.getSummaryStatistics=function(e){return y(e)},t.getSizeRangeForAxis=function(e,t){var n=e.minSize,r=e.maxSize;if("height"===t){n=((r-n)/2+n)/4.6,r*=2}return{minSize:n,maxSize:r}},t.isValidPointSize=function(e){return b.test(e)},t.getPointSizeAlgorithm=function(e){var t=e.match(b),n=Number(t[1]);if("%"===t[3])return new v.default({scaleFactor:n/100})},t.updateAgeRendererAuthoringInfoVV=function(e,t,n,r){e.startTime=t instanceof Date?t.getTime():t,e.endTime=n instanceof Date?n.getTime():n,e.units=r,e.field="string"==typeof t?t:"string"==typeof n?n:null},t.getBasemapInfo=function(e,t){return i(this,void 0,void 0,(function(){var n,i,o;return r(this,(function(r){switch(r.label){case 0:return n=null,i=null,e||t?(!e&&t&&(e=t&&t.get("map.basemap")),e&&(n=p.getBasemapId(e,D,!1))&&(o=p.getBasemapGroup(n),u.isSome(o)&&(i=o)),n||!t?[3,2]:[4,g.getBackgroundColorTheme(t)]):[2,{basemapId:n,basemapTheme:i}];case 1:i=r.sent(),u.isSome(i)&&(n="dark"===i?"dark-gray":"gray"),r.label=2;case 2:return[2,{basemapId:n,basemapTheme:i}]}}))}))}}));