// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/assignHelper","../../../core/tsSupport/generatorHelper","../../../core/tsSupport/awaiterHelper","dojo/i18n!../../nls/smartMapping","../../../core/Error","../../../core/maybe","../../../core/promiseUtils","./size","./type","./support/utils","../heuristics/outline","../statistics/predominantCategories","../statistics/summaryStatistics","../statistics/support/predominanceUtils","../support/utils","../symbology/predominance","../../support/AuthoringInfo","../../support/AuthoringInfoVisualVariable","../../support/numberUtils","../../visualVariables/OpacityVariable"],(function(e,i,a,n,r,l,s,t,o,p,u,m,d,c,y,b,f,h,v,g,w,S){function V(e){return r(this,void 0,void 0,(function(){var i,r,l,o,p,u,d,c;return n(this,(function(n){switch(n.label){case 0:if(!(e&&e.layer&&e.view&&e.fields&&e.fields.length))throw new s("predominance-renderer:missing-parameters","'layer', 'view' and 'fields' parameters are required");if(e.fields.length<2)throw new s("predominance-renderer:invalid-parameters","Minimum 2 fields are required");if(e.fields.length>10)throw new s("predominance-renderer:invalid-parameters","Maximum 10 fields are supported");if((i=a({},e)).symbolType=i.symbolType||"2d",i.defaultSymbolEnabled=null==i.defaultSymbolEnabled||i.defaultSymbolEnabled,i.includeOpacityVariable=e.includeOpacityVariable||!1,i.includeSizeVariable=e.includeSizeVariable||!1,i.sortBy=null==i.sortBy?"count":i.sortBy,r=[0,2,1,3],l=f.createLayerAdapter(i.layer,r),i.layer=l,!l)throw new s("predominance-renderer:invalid-parameters","'layer' must be one of these types: "+f.getLayerTypeLabels(r).join(", "));return o=t.isSome(i.signal)?{signal:i.signal}:null,[4,l.load(o)];case 1:if(n.sent(),p=l.geometryType,u=i.symbolType.indexOf("3d")>-1,i.outlineOptimizationEnabled="polygon"===p&&i.outlineOptimizationEnabled,i.includeSizeVariable||(i.sizeOptimizationEnabled=("point"===p||"multipoint"===p||"polyline"===p)&&i.sizeOptimizationEnabled),"mesh"===p)i.symbolType="3d-volumetric",i.colorMixMode=i.colorMixMode||"replace",i.edgesType=i.edgesType||"none",i.sizeOptimizationEnabled=!1;else{if(u&&("polyline"===p||"polygon"===p))throw new s("predominance-renderer:not-supported","3d symbols are not supported for polyline and polygon layers");if(i.symbolType.indexOf("3d-volumetric")>-1&&(!i.view||"3d"!==i.view.type))throw new s("predominance-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or '3d-volumetric-uniform'")}if(d=i.fields.map((function(e){return e.name})),c=m.verifyBasicFieldValidity(l,d,"predominance-renderer:invalid-parameters"))throw c;return[2,i]}}))}))}function z(e){return r(this,void 0,void 0,(function(){var i,a,r,l,s;return n(this,(function(n){switch(n.label){case 0:return i=e.predominanceScheme,a=null,r=null,[4,m.getBasemapInfo(e.basemap,e.view)];case 1:return l=n.sent(),a=t.isSome(l.basemapId)?l.basemapId:null,r=t.isSome(l.basemapTheme)?l.basemapTheme:null,i?[2,{scheme:h.cloneScheme(i),basemapId:a,basemapTheme:r}]:((s=h.getSchemes({basemap:a,basemapTheme:r,geometryType:e.geometryType,numColors:e.numColors,theme:e.theme,worldScale:e.worldScale,view:e.view}))&&(i=s.primaryScheme,a=s.basemapId,r=s.basemapTheme),[2,{scheme:i,basemapId:a,basemapTheme:r}])}}))}))}Object.defineProperty(i,"__esModule",{value:!0}),i.createRenderer=function(e){return r(this,void 0,void 0,(function(){var i,a,s,t,f,h,T,E,x,O,I,M,q,C,B,A;return n(this,(function(F){switch(F.label){case 0:return[4,V(e)];case 1:return i=F.sent(),a=i.layer,[4,z({basemap:i.basemap,geometryType:a.geometryType,numColors:i.fields.length,predominanceScheme:i.predominanceScheme,worldScale:i.symbolType.indexOf("3d-volumetric")>-1,view:i.view})];case 2:return s=F.sent(),t=s.scheme,f=i.fields.map((function(e){return e.name})),h=b.getPredominanceExpressions(a,f),T=function(e,i,a,s){return r(this,void 0,void 0,(function(){var r,t,p,y,b,f,h,g,w,S,V,z,T,E,x,O,I,M,q,C,B,A,F,U;return n(this,(function(n){switch(n.label){case 0:return r=e.layer,t={layer:e.layer,view:e.view,signal:e.signal},[4,o.all([c({layer:r,fields:s,view:e.view,signal:e.signal}),e.outlineOptimizationEnabled?d(t):null])];case 1:return p=n.sent(),y=p[0],b=p[1],f=y,y&&y.predominantCategoryInfos||(f={predominantCategoryInfos:s.map((function(e){return{value:e,count:0}}))}),h=b&&b.opacity,[4,u.createRenderer({layer:r,basemap:e.basemap,valueExpression:i.valueExpression,valueExpressionTitle:l.predominantCategory,numTypes:-1,defaultSymbolEnabled:e.defaultSymbolEnabled,sortBy:e.sortBy,typeScheme:a,statistics:{uniqueValueInfos:f.predominantCategoryInfos},legendOptions:e.legendOptions,outlineOptimizationEnabled:!1,sizeOptimizationEnabled:(!e.includeSizeVariable||!e.sizeOptimizationEnabled)&&e.sizeOptimizationEnabled,symbolType:e.symbolType,colorMixMode:e.colorMixMode,edgesType:e.edgesType,view:e.view,signal:e.signal})];case 2:for(g=n.sent(),w=g.renderer,S=g.basemapId,V=g.basemapTheme,z=g.uniqueValueInfos,T=g.excludedUniqueValueInfos,E=w.uniqueValueInfos,x={},O=0,I=e.fields;O<I.length;O++)M=I[O],q=r.getField(M.name),x[q.name]=M.label||q&&q.alias||M.name;return E.forEach((function(e,i){var a=x[e.value];e.label=a,z[i].label=a})),e.includeSizeVariable&&(C=r.geometryType,B=null,"polygon"===C?(A=a.sizeScheme,F=A.background,w.backgroundFillSymbol=m.createSymbol(C,{type:e.symbolType,color:F.color,outline:m.getSymbolOutlineFromScheme(F,C,h)}),B=A.marker.size,C="point"):B="polyline"===C?a.width:a.size,U=m.createColors(a.colors,E.length),E.forEach((function(i,n){var r=m.createSymbol(C,{type:e.symbolType,color:U[n],size:B,outline:m.getSymbolOutlineFromScheme(a,C,h),meshInfo:{colorMixMode:e.colorMixMode,edgesType:e.edgesType}});i.symbol=r,z[n].symbol=r.clone()}))),b&&b.visualVariables&&b.visualVariables.length&&(w.visualVariables=b.visualVariables.map((function(e){return e.clone()}))),w.authoringInfo=new v({type:"predominance",fields:s.slice()}),[2,{renderer:w,predominantCategoryInfos:z,excludedCategoryInfos:T,predominanceScheme:a,basemapId:S,basemapTheme:V}]}}))}))}(i,h.predominantCategory,t,f),E=i.includeSizeVariable?function(e,i,a){return p.createVisualVariables({layer:e.layer,basemap:e.basemap,valueExpression:i.valueExpression,sqlExpression:i.statisticsQuery.sqlExpression,sqlWhere:i.statisticsQuery.sqlWhere,sizeScheme:a,sizeOptimizationEnabled:e.sizeOptimizationEnabled,worldScale:e.symbolType.indexOf("3d-volumetric")>-1,legendOptions:{title:l.sumOfCategories},view:e.view,signal:e.signal})}(i,h.size,t.sizeScheme):null,x=i.includeOpacityVariable?function(e,i){return r(this,void 0,void 0,(function(){var a,r,s,t,o,p,u,m;return n(this,(function(n){switch(n.label){case 0:return[4,y({layer:e.layer,valueExpression:i.valueExpression,sqlExpression:i.statisticsQuery.sqlExpression,sqlWhere:i.statisticsQuery.sqlWhere,view:e.view,signal:e.signal})];case 1:return a=n.sent(),r=null==a.avg||null==a.stddev,s=1/e.fields.length*100,(t=r?100:a.avg+1.285*a.stddev)>100&&(t=100),o=w.round([s,t],{strictBounds:!0}),p=new S({valueExpression:i.valueExpression,stops:[{value:o[0],opacity:.15},{value:o[1],opacity:1}],legendOptions:{title:l.strengthOfPredominance}}),u=new g({type:"opacity",minSliderValue:a.min,maxSliderValue:a.max}),m=new v({visualVariables:[u]}),[2,{visualVariable:p,statistics:a,defaultValuesUsed:r,authoringInfo:m}]}}))}))}(i,h.opacity):null,[4,o.all([T,E,x])];case 3:return O=F.sent(),I=O[0],M=O[1],q=O[2],C=[],B=[],M&&(Array.prototype.push.apply(C,M.visualVariables.map((function(e){return e.clone()}))),delete M.sizeScheme,I.size=M,Array.prototype.push.apply(B,M.authoringInfo.visualVariables.map((function(e){return e.clone()})))),q&&(C.push(q.visualVariable.clone()),I.opacity=q,Array.prototype.push.apply(B,q.authoringInfo.visualVariables.map((function(e){return e.clone()})))),C.length&&(A=I.renderer.visualVariables||[],Array.prototype.push.apply(A,C),I.renderer.visualVariables=A,I.renderer.authoringInfo.visualVariables=B),[2,I]}}))}))}}));