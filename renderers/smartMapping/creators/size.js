// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/assignHelper","../../../core/tsSupport/generatorHelper","../../../core/tsSupport/awaiterHelper","dojo/i18n!../../nls/smartMapping","../..","../../../core/Error","../../../core/maybe","../../../core/promiseUtils","../../../core/screenUtils","../../../intl/substitute","./support/utils","../heuristics/ageUnit","../heuristics/outline","../heuristics/sizeRange","../statistics/support/ageUtils","../support/utils","../symbology/size","../../support/AuthoringInfo","../../support/AuthoringInfoVisualVariable","../../support/utils","../../visualVariables/SizeVariable"],(function(e,i,a,n,r,l,s,t,o,u,m,d,p,c,y,b,f,v,h,w,g,z,S){Object.defineProperty(i,"__esModule",{value:!0});var x=Math.pow(2,53)-1;function T(e){return r(this,void 0,void 0,(function(){var i,r,l,s,u,m,d;return n(this,(function(n){switch(n.label){case 0:if(!(e&&e.layer&&(e.field||e.valueExpression||e.sqlExpression)))throw new t("size-visual-variable:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(e.valueExpression&&!e.sqlExpression&&!e.view)throw new t("size-visual-variable:missing-parameters","View is required when 'valueExpression' is specified");if(i=a({},e),r=[0,2,1,3],l=v.createLayerAdapter(i.layer,r),i.layer=l,!l)throw new t("size-visual-variable:invalid-parameters","'layer' must be one of these types: "+v.getLayerTypeLabels(r).join(", "));return"height"===i.axis&&(i.sizeOptimizationEnabled=!1),s=o.isSome(i.signal)?{signal:i.signal}:null,[4,l.load(s)];case 1:if(n.sent(),"mesh"===(u=l.geometryType))throw new t("size-visual-variable:invalid-parameters","Size visualization is not applicable to layers with 'mesh' geometry type");if(i.worldScale){if("polyline"===u||"polygon"===u)throw new t("size-visual-variable:not-supported","'worldScale' sizing is not supported for polyline and polygon layers");if(!i.view||"3d"!==i.view.type)throw new t("size-visual-variable:invalid-parameters","'view' parameter should be an instance of SceneView when 'worldScale' parameter is true")}return[4,v.getFieldsList({field:i.field,normalizationField:i.normalizationField,valueExpression:i.valueExpression})];case 2:if(m=n.sent(),d=p.verifyBasicFieldValidity(l,m,"size-visual-variable:invalid-parameters"))throw d;return[2,i]}}))}))}function E(e){return r(this,void 0,void 0,(function(){var i,r,l,s,u,m,d,c;return n(this,(function(n){switch(n.label){case 0:if(!(e&&e.layer&&(e.field||e.valueExpression||e.sqlExpression)))throw new t("size-continuous-renderer:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(e.valueExpression&&!e.sqlExpression&&!e.view)throw new t("size-continuous-renderer:missing-parameters","View is required when 'valueExpression' is specified");if((i=a({},e)).symbolType=i.symbolType||"2d",i.defaultSymbolEnabled=null==i.defaultSymbolEnabled||i.defaultSymbolEnabled,r=[0,2,1,3],l=v.createLayerAdapter(i.layer,r),i.layer=l,!l)throw new t("size-continuous-renderer:invalid-parameters","'layer' must be one of these types: "+v.getLayerTypeLabels(r).join(", "));return s=o.isSome(i.signal)?{signal:i.signal}:null,[4,l.load(s)];case 1:if(n.sent(),u=l.geometryType,m=i.symbolType.indexOf("3d")>-1,i.outlineOptimizationEnabled="polygon"===u&&i.outlineOptimizationEnabled,"mesh"===u)throw new t("size-continuous-renderer:invalid-parameters","Size visualization is not applicable to layers with 'mesh' geometry type");if(m&&("polyline"===u||"polygon"===u))throw new t("size-continuous-renderer:not-supported","3d symbols are not supported for polyline and polygon layers");if(i.symbolType.indexOf("3d-volumetric")>-1&&(!i.view||"3d"!==i.view.type))throw new t("size-continuous-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or 3d-volumetric-uniform");return[4,v.getFieldsList({field:i.field,normalizationField:i.normalizationField,valueExpression:i.valueExpression})];case 2:if(d=n.sent(),c=p.verifyBasicFieldValidity(l,d,"size-continuous-renderer:invalid-parameters"))throw c;return[2,i]}}))}))}function V(e){return r(this,void 0,void 0,(function(){var i,r,l,s,u,m,d,c;return n(this,(function(n){switch(n.label){case 0:if(!e||!e.layer||!e.field&&!e.valueExpression)throw new t("size-class-breaks-renderer:missing-parameters","'layer' and 'field' or 'valueExpression' parameters are required");if(e.valueExpression&&!e.view)throw new t("size-class-breaks-renderer:missing-parameters","View is required when 'valueExpression' is specified");if((i=a({},e)).symbolType=i.symbolType||"2d",i.defaultSymbolEnabled=null==i.defaultSymbolEnabled||i.defaultSymbolEnabled,i.classificationMethod=i.classificationMethod||"equal-interval",i.normalizationType=v.getNormalizationType(i),r=[0,2,1,3],l=v.createLayerAdapter(i.layer,r),i.layer=l,!l)throw new t("size-class-breaks-renderer:invalid-parameters","'layer' must be one of these types: "+v.getLayerTypeLabels(r).join(", "));if(!(null!=i.minValue&&null!=i.maxValue)&&(null!=i.minValue||null!=i.maxValue))throw new t("size-class-breaks-renderer:missing-parameters","Both 'minValue' and 'maxValue' are required when specifying custom data range");return s=o.isSome(i.signal)?{signal:i.signal}:null,[4,l.load(s)];case 1:if(n.sent(),u=l.geometryType,m=i.symbolType.indexOf("3d")>-1,i.outlineOptimizationEnabled="polygon"===u&&i.outlineOptimizationEnabled,"mesh"===u)throw new t("size-class-breaks-renderer:invalid-parameters","Size visualization is not applicable to layers with 'mesh' geometry type");if(m&&("polyline"===u||"polygon"===u))throw new t("size-class-breaks-renderer:not-supported","3d symbols are not supported for polyline and polygon layers");if(i.symbolType.indexOf("3d-volumetric")>-1&&(!i.view||"3d"!==i.view.type))throw new t("size-class-breaks-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or 3d-volumetric-uniform");return[4,v.getFieldsList({field:i.field,normalizationField:i.normalizationField})];case 2:if(d=n.sent(),c=p.verifyBasicFieldValidity(l,d,"size-class-breaks-renderer:invalid-parameters"))throw c;return[2,i]}}))}))}function O(e){var i=a({},e);delete i.basemap,delete i.sizeScheme,delete i.legendOptions,delete i.symbolType,delete i.defaultSymbolEnabled;var n=i;return n.analyzeData=!(null!=i.minValue&&null!=i.maxValue),n}function F(e){var i=a({},e),n=i.symbolType.indexOf("3d-volumetric")>-1,r=i;return r.worldScale=n,n&&(r.axis="3d-volumetric-uniform"===i.symbolType?"all":"height"),delete i.symbolType,delete i.defaultSymbolEnabled,r}function k(e){return r(this,void 0,void 0,(function(){var i,r,l,s,u,m,d;return n(this,(function(n){switch(n.label){case 0:if(!(e&&e.layer&&e.view&&e.startTime&&e.endTime))throw new t("size-age-renderer:missing-parameters","'layer', 'view', 'startTime', 'endTime' parameters are required");if((i=a({},e)).symbolType=i.symbolType||"2d",i.defaultSymbolEnabled=null==i.defaultSymbolEnabled||i.defaultSymbolEnabled,r=[0,2,1,3],l=v.createLayerAdapter(i.layer,r),i.layer=l,!l)throw new t("size-age-renderer:invalid-parameters","'layer' must be one of these types: "+v.getLayerTypeLabels(r).join(", "));return s=o.isSome(i.signal)?{signal:i.signal}:null,[4,l.load(s)];case 1:if(n.sent(),u=l.geometryType,m=i.symbolType.indexOf("3d")>-1,i.outlineOptimizationEnabled="polygon"===u&&i.outlineOptimizationEnabled,"mesh"===u)throw new t("size-age-renderer:invalid-parameters","Size visualization is not applicable to layers with 'mesh' geometry type");if(m&&("polyline"===u||"polygon"===u))throw new t("size-age-renderer:not-supported","3d symbols are not supported for polyline and polygon layers");if(i.symbolType.indexOf("3d-volumetric")>-1&&(!i.view||"3d"!==i.view.type))throw new t("size-age-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or 3d-volumetric-uniform");if(d=f.verifyDates(l,i.startTime,i.endTime,"size-age-renderer:invalid-parameters"))throw d;if(i.unit&&-1===f.supportedAgeUnits.indexOf(i.unit))throw new t("size-age-renderer:invalid-unit","Supported units are: "+f.supportedAgeUnits.join(", "));return[2,i]}}))}))}function I(e){return r(this,void 0,void 0,(function(){var i,a,r,l,s;return n(this,(function(n){switch(n.label){case 0:return i=e.sizeScheme,a=null,r=null,[4,p.getBasemapInfo(e.basemap,e.view)];case 1:return l=n.sent(),a=o.isSome(l.basemapId)?l.basemapId:null,r=o.isSome(l.basemapTheme)?l.basemapTheme:null,i?[2,{scheme:h.cloneScheme(i),basemapId:a,basemapTheme:r}]:((s=h.getSchemes({basemap:a,basemapTheme:r,geometryType:e.geometryType,worldScale:e.worldScale,view:e.view}))&&(i=s.primaryScheme,a=s.basemapId,r=s.basemapTheme),[2,{scheme:i,basemapId:a,basemapTheme:r}])}}))}))}function q(e,i){var a;switch(i){case"point":case"multipoint":var n=e;a=[n.minSize,n.maxSize];break;case"polyline":var r=e;a=[r.minWidth,r.maxWidth];break;case"polygon":var l=e;a=[l.marker.minSize,l.marker.maxSize]}return a}function L(e,i,a,l){return r(this,void 0,void 0,(function(){var r,s,o,u,m,d,c,y,b,f,v,z,x,T,E,V,O,F,k,L;return n(this,(function(n){switch(n.label){case 0:return r=l.layer,s=l.field,o="function"==typeof s,u=s&&!o?r.getField(s):null,m=u&&"date"===u.type,d=r.geometryType,[4,I({basemap:l.basemap,geometryType:d,sizeScheme:l.sizeScheme,worldScale:l.worldScale,view:l.view})];case 1:if(c=n.sent(),!(y=c.scheme))throw new t("size-visual-variable:insufficient-info","Unable to find size scheme");return b=i&&[i.minSize,i.maxSize],f=b||q(y,d),v=p.getDefaultDataRange(e,m,!1),z=v||[e.min,e.max],x=[],T="height"===l.axis,E=T?l.axis:void 0,V=f[0],O=f[1],T&&"number"==typeof V&&"number"==typeof O&&(F=p.getSizeRangeForAxis({minSize:V,maxSize:O},E),x.push(new S({axis:"width-and-depth",minSize:F.minSize})),O=F.maxSize),x.unshift(new S({field:s,valueExpression:l.valueExpression,valueExpressionTitle:l.valueExpressionTitle,valueUnit:"unknown",normalizationField:a,axis:E,minSize:V,maxSize:O,minDataValue:z[0],maxDataValue:z[1],legendOptions:l.legendOptions})),k=new g({type:"size",minSliderValue:null!=l.minValue?l.minValue:e.min,maxSliderValue:null!=l.maxValue?l.maxValue:e.max}),L=new w({visualVariables:[k]}),[2,{basemapId:c.basemapId,basemapTheme:c.basemapTheme,visualVariables:x,statistics:e,defaultValuesUsed:!!v,sizeScheme:h.cloneScheme(y),authoringInfo:L}]}}))}))}function A(e,i,a,n,r){var t=r.layer,o=r.field,u=t.geometryType,m=r.defaultSymbolEnabled,d=h.cloneScheme(e.sizeScheme),c="polygon"===u,y=c?d.marker:d,b=c?d.background:null,f=c?"point":u,v=i&&i.opacity,w=e.visualVariables.map((function(e){return e.clone()}));return i&&i.visualVariables&&i.visualVariables.length&&w.push.apply(w,i.visualVariables.map((function(e){return e.clone()}))),{renderer:new s.ClassBreaksRenderer({backgroundFillSymbol:b&&p.createSymbol(u,{type:r.symbolType,color:b.color,outline:p.getSymbolOutlineFromScheme(b,u,v)}),classBreakInfos:[{minValue:-x,maxValue:x,symbol:p.createSymbol(f,{type:r.symbolType,color:y.color,size:p.getSymbolSizeFromScheme(y,f),outline:p.getSymbolOutlineFromScheme(y,f,v)})}],defaultLabel:m?l.other:null,defaultSymbol:m?p.createSymbol(f,{type:r.symbolType,color:y.noDataColor,size:p.getSymbolSizeFromScheme(y,f,!0),outline:p.getSymbolOutlineFromScheme(y,f,v)}):null,field:o,normalizationField:n,normalizationType:a,valueExpression:r.valueExpression,valueExpressionTitle:r.valueExpressionTitle,visualVariables:w,authoringInfo:e.authoringInfo&&e.authoringInfo.clone()}),visualVariables:e.visualVariables.map((function(e){return e.clone()})),statistics:e.statistics,defaultValuesUsed:e.defaultValuesUsed,sizeScheme:h.cloneScheme(e.sizeScheme),basemapId:e.basemapId,basemapTheme:e.basemapTheme}}function B(e,i){return r(this,void 0,void 0,(function(){var a,r,t,o,u,d,c,y,b,f,v,g,S,x,T,E,V,O,F,k;return n(this,(function(n){switch(n.label){case 0:return a=e.layer,r=e.defaultSymbolEnabled,t=a.geometryType,o="polygon"===t,u=e.symbolType.indexOf("3d-volumetric")>-1,[4,I({basemap:e.basemap,geometryType:t,sizeScheme:e.sizeScheme,worldScale:u,view:e.view})];case 1:return d=n.sent(),c=d.scheme,y=i.result,b=i.outlineResult,f=y.classBreakInfos,v=e.classificationMethod,g=e.normalizationType,S=o?c.marker:c,x=o?c.background:null,E=q(S,T=o?"point":t),V=u&&p.getSizeRangeForAxis({minSize:E[0],maxSize:E[1]},"height"),O=function(e,i){for(var a=m.toPt(e.minSize),n=(m.toPt(e.maxSize)-a)/(i>=4?i-1:i),r=[],l=0;l<i;l++)r.push(a+n*l);return r}({minSize:E[0],maxSize:u?V.maxSize:E[1]},f.length),F=b&&b.opacity,k=new s.ClassBreaksRenderer({backgroundFillSymbol:x&&p.createSymbol(t,{type:e.symbolType,color:x.color,outline:p.getSymbolOutlineFromScheme(x,t,F)}),classBreakInfos:f.map((function(i,a){return{minValue:i.minValue,maxValue:i.maxValue,symbol:p.createSymbol(T,{type:e.symbolType,color:S.color,size:O[a],widthAndDepth:V&&V.minSize,outline:p.getSymbolOutlineFromScheme(S,T,F)}),label:i.label}})),defaultLabel:r?l.other:null,defaultSymbol:r?p.createSymbol(T,{type:e.symbolType,color:S.noDataColor,size:p.getSymbolSizeFromScheme(S,T,!0),widthAndDepth:V&&V.minSize,outline:p.getSymbolOutlineFromScheme(S,T,F)}):null,field:e.field,valueExpression:e.valueExpression,valueExpressionTitle:e.valueExpressionTitle,normalizationType:g,normalizationField:e.normalizationField,normalizationTotal:"percent-of-total"===g?y.normalizationTotal:void 0,legendOptions:e.legendOptions,authoringInfo:new w({type:"class-breaks-size",classificationMethod:v,standardDeviationInterval:e.standardDeviationInterval})}),"standard-deviation"!==v&&z.setLabelsForClassBreaks({classBreakInfos:k.classBreakInfos,classificationMethod:v,normalizationType:g,round:!0}),b&&b.visualVariables&&b.visualVariables.length&&(k.visualVariables=b.visualVariables.map((function(e){return e.clone()}))),[2,{renderer:k,sizeScheme:h.cloneScheme(c),classBreaksResult:y,defaultValuesUsed:i.defaultValuesUsed,basemapId:d.basemapId,basemapTheme:d.basemapTheme}]}}))}))}function D(e){return r(this,void 0,void 0,(function(){var i,a,r,l,s,t,o,m,d;return n(this,(function(n){switch(n.label){case 0:return[4,T(e)];case 1:return i=n.sent(),a=i.view,r=i.layer,l=i.normalizationField,s=i.signal,t=l?"field":void 0,[4,u.all([i.statistics?i.statistics:p.getSummaryStatistics({layer:r,field:i.field,valueExpression:i.valueExpression,sqlExpression:i.sqlExpression,sqlWhere:i.sqlWhere,normalizationType:t,normalizationField:l,minValue:i.minValue,maxValue:i.maxValue,view:a,signal:s}),i.sizeOptimizationEnabled?b({view:a,layer:r,signal:s}):null])];case 2:return o=n.sent(),m=o[0],d=o[1],[2,L(m,d,l,i)]}}))}))}i.createVisualVariables=D,i.createContinuousRenderer=function(e){return r(this,void 0,void 0,(function(){var i,a,r,l,s,t;return n(this,(function(n){switch(n.label){case 0:return[4,E(e)];case 1:return i=n.sent(),a={layer:i.layer,view:i.view,signal:i.signal},[4,u.all([D(F(i)),i.outlineOptimizationEnabled?y(a):null])];case 2:return r=n.sent(),l=r[0],s=r[1],t=i.normalizationField,[2,A(l,s,t?"field":void 0,t,i)]}}))}))},i.createClassBreaksRenderer=function(e){return r(this,void 0,void 0,(function(){var i,a;return n(this,(function(n){switch(n.label){case 0:return[4,V(e)];case 1:return i=n.sent(),[4,p.getClassBreaks(O(i),i.outlineOptimizationEnabled)];case 2:return a=n.sent(),[2,B(i,a)]}}))}))},i.createAgeRenderer=function(e){return r(this,void 0,void 0,(function(){var i,r,s,t,o,m,b,v,h,w,g,z,S,x,T,E,V,O,I,q,L,B,U;return n(this,(function(n){switch(n.label){case 0:return[4,k(e)];case 1:return i=n.sent(),r=i.defaultSymbolEnabled,s=i.view,t=i.startTime,o=i.endTime,m=i.symbolType,b=i.minValue,v=i.maxValue,h=i.signal,w=i.layer,g={layer:i.layer,view:i.view,signal:h},E=(T=u).all,i.unit?(V={unit:i.unit,statistics:null,valueExpression:null},[3,4]):[3,2];case 2:return[4,c({view:s,layer:w,startTime:t,endTime:o,minValue:b,maxValue:v,signal:h})];case 3:V=n.sent(),n.label=4;case 4:return[4,E.apply(T,[[V,i.outlineOptimizationEnabled?y(g):null]])];case 5:return z=n.sent(),S=z[0],x=z[1],O=S.unit,I=S.statistics,q=f.getAgeExpressions({layer:w,startTime:t,endTime:o,unit:O}).valueExpression,L=d.substitute(l["ageInfo_"+O],{unit:O,startTime:p.formatDate(t,O,w),endTime:p.formatDate(o,O,w)}),[4,D(F({layer:w,basemap:i.basemap,valueExpression:q,symbolType:m,statistics:I,legendOptions:{title:L},sizeScheme:i.sizeScheme,sizeOptimizationEnabled:i.sizeOptimizationEnabled,view:i.view,minValue:b,maxValue:v,signal:h}))];case 6:return B=n.sent(),U=A(B,x,null,null,{layer:w,valueExpression:q,defaultSymbolEnabled:r,symbolType:m}),U.renderer.authoringInfo.visualVariables.forEach((function(e){return p.updateAgeRendererAuthoringInfoVV(e,t,o,O)})),[2,a({},U,{unit:O})]}}))}))}}));