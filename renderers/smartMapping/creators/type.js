// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/assignHelper","../../../core/tsSupport/generatorHelper","../../../core/tsSupport/awaiterHelper","dojo/i18n!../../nls/smartMapping","../..","../../../pointCloudRenderers","../../../core/Error","../../../core/lang","../../../core/maybe","../../../core/promiseUtils","./support/utils","../heuristics/outline","../heuristics/sizeRange","../statistics/uniqueValues","../support/utils","../symbology/type","../../support/LegendOptions","../../support/utils"],(function(e,l,i,r,n,t,a,s,o,u,c,d,p,m,y,f,b,v,h,g){Object.defineProperty(l,"__esModule",{value:!0});function w(e){return n(this,void 0,void 0,(function(){var l,n,t,a,s,d,m;return r(this,(function(r){switch(r.label){case 0:if(!e||!e.layer||!e.field&&!e.valueExpression)throw new o("type-renderer:missing-parameters","'layer' and 'field' or 'valueExpression' parameters are required");if(e.valueExpression&&!e.view)throw new o("type-renderer:missing-parameters","View is required when 'valueExpression' is specified");if((l=i({},e)).symbolType=l.symbolType||"2d",l.numTypes=null==l.numTypes?10:l.numTypes,l.defaultSymbolEnabled=null==l.defaultSymbolEnabled||l.defaultSymbolEnabled,l.sortBy=null==l.sortBy?"count":l.sortBy,l.sortEnabled=null==l.sortEnabled||l.sortEnabled,l.statistics=u.clone(l.statistics),n=[0,2,1,3],t=b.createLayerAdapter(l.layer,n),l.layer=t,!t)throw new o("type-renderer:invalid-parameters","'layer' must be one of these types: "+b.getLayerTypeLabels(n).join(", "));return a=c.isSome(l.signal)?{signal:l.signal}:null,[4,t.load(a)];case 1:if(r.sent(),s=t.geometryType,l.outlineOptimizationEnabled="polygon"===s&&l.outlineOptimizationEnabled,l.sizeOptimizationEnabled=("point"===s||"multipoint"===s||"polyline"===s)&&l.sizeOptimizationEnabled,"mesh"===s)l.symbolType="3d-volumetric",l.colorMixMode=l.colorMixMode||"replace",l.edgesType=l.edgesType||"none";else{if("3d-volumetric-uniform"===l.symbolType&&"point"!==s)throw new o("type-renderer:not-supported","3d-volumetric-uniform symbols are supported for point layers only");if(l.symbolType.indexOf("3d-volumetric")>-1&&(!l.view||"3d"!==l.view.type))throw new o("type-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or '3d-volumetric-uniform'")}return[4,b.getFieldsList({field:l.field,valueExpression:l.valueExpression})];case 2:if(d=r.sent(),m=p.verifyBasicFieldValidity(t,d,"type-renderer:invalid-parameters"))throw m;return[2,l]}}))}))}function T(e){return n(this,void 0,void 0,(function(){var l,n,t,a,s,d;return r(this,(function(r){switch(r.label){case 0:if(!(e&&e.layer&&e.field))throw new o("type-point-cloud-class-renderer:missing-parameters","'layer' and 'field' parameters are required");if((l=i({},e)).statistics=u.clone(l.statistics),n=[4],t=b.createLayerAdapter(l.layer,n),l.layer=t,l.density=l.density||25,l.size=l.size||"100%",!p.isValidPointSize(l.size))throw new o("type-point-cloud-class-renderer:invalid-parameters","Invalid 'size' parameter. It should be a string of the form '100%'");if(!t)throw new o("type-point-cloud-class-renderer:invalid-parameters","'layer' must be one of these types: "+b.getLayerTypeLabels(n).join(", "));return a=c.isSome(l.signal)?{signal:l.signal}:null,[4,t.load(a)];case 1:return r.sent(),[4,b.getFieldsList({field:l.field})];case 2:if(s=r.sent(),d=p.verifyBasicFieldValidity(t,s,"type-point-cloud-class-renderer:invalid-parameters"))throw d;return[2,l]}}))}))}function S(e){return n(this,void 0,void 0,(function(){var l,i,n,t,a;return r(this,(function(r){switch(r.label){case 0:return l=e.typeScheme,i=null,n=null,[4,p.getBasemapInfo(e.basemap,e.view)];case 1:return t=r.sent(),i=c.isSome(t.basemapId)?t.basemapId:null,n=c.isSome(t.basemapTheme)?t.basemapTheme:null,l?[2,{scheme:v.cloneScheme(l),basemapId:i,basemapTheme:n}]:((a=v.getSchemes({basemap:i,basemapTheme:n,geometryType:e.geometryType,theme:e.theme,worldScale:e.worldScale,view:e.view}))&&(l=a.primaryScheme,i=a.basemapId,n=a.basemapTheme),[2,{scheme:l,basemapId:i,basemapTheme:n}])}}))}))}function E(e,l){return e.label<l.label?-1:e.label>l.label?1:0}function V(e,l){return e.value<l.value?-1:e.value>l.value?1:0}function x(e,l){var i=l.count-e.count;return 0===i&&(i=E(e,l)),i}function z(e,l){var i=l.count-e.count;return 0===i&&(i=V(e,l)),i}function I(e,l,i){var r;"count"===l?(r=z,i&&i.codedValues&&(r=x)):"value"===l&&(r=V,i&&i.codedValues&&(r=E)),r&&e.sort(r)}function M(e,l,s,o){return n(this,void 0,void 0,(function(){var n,u,c,d,m,y,f,b,w,T,E,V,x,z,M,q,O,L,C,F,U,B,P;return r(this,(function(r){switch(r.label){case 0:return n=e.uniqueValueInfos,u=l.layer,c=l.field,d=c?u.getField(c):null,m=d?u.getFieldDomain(d.name):null,y=-1===l.numTypes?n.length:l.numTypes,f=u.geometryType,[4,S({basemap:l.basemap,geometryType:f,typeScheme:l.typeScheme,worldScale:l.symbolType.indexOf("3d-volumetric")>-1,view:l.view})];case 1:for(b=r.sent(),w=b.scheme,T=new a.UniqueValueRenderer({field:c}),E=-1,x={value:null,domain:m,fieldInfo:d},n.forEach((function(e,l){x.value=e.value,e.label=g.createUniqueValueLabel(x),null===e.value&&(E=l)})),E>-1&&(V=n.splice(E,1)[0]),!1!==l.sortEnabled&&I(n,l.sortBy,m),d&&"date"===d.type&&(z=n.filter((function(e,l){return l<y})),M=z.map((function(e){return e.value})),x.dateFormatInterval=g.calculateDateFormatInterval(M)),q=s&&s.opacity,O=p.createColors(w.colors,n.length),L=p.getSymbolSizeFromScheme(w,f),C=p.getSymbolOutlineFromScheme(w,f,q),n.forEach((function(e,i){x.value=e.value,e.label=g.createUniqueValueLabel(x),e.symbol=p.createSymbol(f,{type:l.symbolType,color:O[i],size:L,outline:C,meshInfo:{colorMixMode:l.colorMixMode,edgesType:l.edgesType}})})),l.valueExpression&&(T.valueExpression=l.valueExpression,T.valueExpressionTitle=l.valueExpressionTitle),l.legendOptions&&(T.legendOptions=new h.LegendOptions(l.legendOptions)),O=p.createColors(w.colors,y),P=0;P<y;P++)(F=n[P])&&T.addUniqueValueInfo({value:F.value,label:F.label,symbol:p.createSymbol(f,{type:l.symbolType,color:O[P],size:L,outline:C,meshInfo:{colorMixMode:l.colorMixMode,edgesType:l.edgesType}})});if(l.defaultSymbolEnabled&&(T.defaultSymbol=p.createSymbol(f,{type:l.symbolType,color:w.noDataColor,size:L,outline:C,meshInfo:{colorMixMode:l.colorMixMode,edgesType:l.edgesType}}),T.defaultLabel=t.other),V&&(V.symbol=p.createSymbol(f,{type:l.symbolType,color:w.noDataColor,size:L,outline:C,meshInfo:{colorMixMode:l.colorMixMode,edgesType:l.edgesType}}),n.push(V)),U=[],(B=T.uniqueValueInfos.length===n.length?-1:T.uniqueValueInfos.length)>-1)for(P=B;P<n.length;P++)U.push(i({},n[P]));return s&&s.visualVariables&&s.visualVariables.length&&(T.visualVariables=s.visualVariables.map((function(e){return e.clone()}))),o&&o.minSize&&(T.visualVariables?T.visualVariables.push(o.minSize):T.visualVariables=[o.minSize]),[2,{renderer:T,uniqueValueInfos:n,excludedUniqueValueInfos:U,typeScheme:v.cloneScheme(w),basemapId:b.basemapId,basemapTheme:b.basemapTheme}]}}))}))}function q(e,l){return n(this,void 0,void 0,(function(){var i,n,t,a,s;return r(this,(function(r){switch(r.label){case 0:return i=e.uniqueValueInfos,[4,S({basemap:"gray",theme:"point-cloud-class",geometryType:"point",typeScheme:l})];case 1:return n=r.sent(),t=n&&n.scheme,a="point-cloud-class"===t.theme,s=a?t.colors:p.createColors(t.colors,i.length),I(i,"value"),[2,i.map((function(e,l){var i=e.value,r=null;return a?(r=s[i])||(r=s[s.length-1]):r=s[l],{values:[i],color:r,label:e.label}}))]}}))}))}l.createRenderer=function(e){return n(this,void 0,void 0,(function(){var l,i,n,t,a,s,o,u,c;return r(this,(function(r){switch(r.label){case 0:return[4,w(e)];case 1:return l=r.sent(),i=l.layer,n=l.view,t=l.signal,a={layer:i,field:l.field,valueExpression:l.valueExpression,returnAllCodedValues:l.returnAllCodedValues,view:n,signal:t},[4,d.all([null!=l.statistics?l.statistics:f(a),l.outlineOptimizationEnabled?m({layer:i,view:n,signal:t}):null,l.sizeOptimizationEnabled?y({layer:i,view:n,signal:t}):null])];case 2:return s=r.sent(),o=s[0],u=s[1],c=s[2],[2,M(o,l,u,c)]}}))}))},l.createPCClassRenderer=function(e){return n(this,void 0,void 0,(function(){var l,i,n,t,a;return r(this,(function(r){switch(r.label){case 0:return[4,T(e)];case 1:return null==(l=r.sent()).statistics?[3,2]:(n=l.statistics,[3,4]);case 2:return[4,f({layer:l.layer,field:l.field,signal:l.signal})];case 3:n=r.sent(),r.label=4;case 4:return i=n,t=s.PointCloudUniqueValueRenderer.bind,a={field:l.field,pointsPerInch:l.density,pointSizeAlgorithm:p.getPointSizeAlgorithm(l.size)},[4,q(i,l.typeScheme)];case 5:return[2,{renderer:new(t.apply(s.PointCloudUniqueValueRenderer,[void 0,(a.colorUniqueValueInfos=r.sent(),a)]))}]}}))}))}}));