// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/generatorHelper","../../../core/tsSupport/awaiterHelper","../../../core/tsSupport/assignHelper","../..","../../../core/Error","../../../core/maybe","../../../core/promiseUtils","../../../geometry/support/scaleUtils","./support/dotDensityUtils","./support/utils","../heuristics/outline","../statistics/spatialStatistics","../statistics/summaryStatisticsForAttributes","../statistics/support/attributeDensity","../support/utils","../symbology/dotDensity","../../support/AuthoringInfo"],(function(e,t,i,n,r,a,s,l,o,u,d,c,p,m,y,b,f,g,v){Object.defineProperty(t,"__esModule",{value:!0});function h(e){return n(this,void 0,void 0,(function(){var t,n,a,u;return i(this,(function(i){switch(i.label){case 0:if(!(e&&e.layer&&e.view&&e.attributes&&e.attributes.length))throw new s("dot-density-renderer:missing-parameters","'layer', 'view' and 'attributes' parameters are required");if(e.attributes.length>8)throw new s("dot-density-renderer:invalid-parameters","Dot density renderer does not support more than 8 attributes");if(t=r({},e),n=[2,1],a=f.createLayerAdapter(t.layer,n),t.layer=a,t.dotBlendingEnabled=null==t.dotBlendingEnabled||t.dotBlendingEnabled,t.dotValueOptimizationEnabled=null==t.dotValueOptimizationEnabled||t.dotValueOptimizationEnabled,!a)throw new s("dot-density-renderer:invalid-parameters","'layer' must be one of these types: "+f.getLayerTypeLabels(n).join(", "));return u=l.isSome(t.signal)?{signal:t.signal}:null,[4,o.all([t.view.when(),a.load(u)])];case 1:if(i.sent(),"polygon"!==a.geometryType)throw new s("dot-density-renderer:not-supported","Dot density renderer is supported for polygon layers only");return[2,t]}}))}))}function w(e){return n(this,void 0,void 0,(function(){var t,n,r,a,s;return i(this,(function(i){switch(i.label){case 0:return t=e.dotDensityScheme,n=null,r=null,[4,c.getBasemapInfo(e.basemap,e.view)];case 1:return a=i.sent(),n=l.isSome(a.basemapId)?a.basemapId:null,r=l.isSome(a.basemapTheme)?a.basemapTheme:null,t?[2,{scheme:g.cloneScheme(t),basemapId:n,basemapTheme:r}]:((s=g.getSchemes({basemap:n,numColors:e.attributes.length,basemapTheme:r}))&&(t=s.primaryScheme,n=s.basemapId,r=s.basemapTheme),[2,{scheme:t,basemapId:n,basemapTheme:r}])}}))}))}function S(e){return n(this,void 0,void 0,(function(){var t,n,r,a,l,c,p,b,f,g,v,h;return i(this,(function(i){switch(i.label){case 0:return t=e.view,n=e.layer,r=e.attributes,a=e.signal,[4,n.getSampleFeatures({view:t,sampleSize:500,returnGeometry:!0,signal:a})];case 1:return l=i.sent(),[4,o.all([m({features:l,geometryType:n.geometryType}),y({layer:n,attributes:r,includeZeros:!1,includeNegatives:!1,view:t,signal:a})])];case 2:if(c=i.sent(),p=c[0],b=c[1],f="avgSize"in p&&p.avgSize,g=b.avg,!f)throw new s("dot-density-renderer:insufficient-info","Average polygon size is invalid");if(!g)throw new s("dot-density-renderer:insufficient-info","Average attribute value is invalid");return v=u.getResolutionForScale(t.scale,t.spatialReference),h=f*f/(v*v)*.1,[2,{dotValue:d.roundValue(g/h)||1,referenceScale:t.scale,minSliderValue:1,maxSliderValue:d.roundValue(g)}]}}))}))}function V(e){return n(this,void 0,void 0,(function(){var t,n,r,a,l,o,c,p,m,y,g,v,h,w,S,V;return i(this,(function(i){switch(i.label){case 0:t=e.view,n=e.layer,r=e.attributes,a=e.signal,l=[],o=0,c=r,i.label=1;case 1:return o<c.length?(p=c[o],[4,f.getFieldsList({field:p.field,valueExpression:p.valueExpression})]):[3,4];case 2:m=i.sent(),l.push.apply(l,m),i.label=3;case 3:return o++,[3,1];case 4:return[4,n.getSampleFeatures({view:t,sampleSize:500,requiredFields:l,returnGeometry:!0,signal:a})];case 5:return y=i.sent(),[4,b({features:y,attributes:r,includeZeros:!1,includeNegatives:!1,view:t})];case 6:if(!(g=i.sent()).avgDensity||!g.minDensity||!g.maxDensity)throw new s("dot-density-renderer:insufficient-info","Invalid density values");return v=u.getResolutionForScale(t.scale,t.spatialReference),h=v*v,w=d.roundValue(g.minDensity*h),S=d.roundValue(g.maxDensity*h),10,(V=d.roundValue(g.avgDensity*h*10)||1)>S&&(V=S),[2,{dotValue:V,referenceScale:t.scale,minSliderValue:w,maxSliderValue:S}]}}))}))}t.createRenderer=function(e){return n(this,void 0,void 0,(function(){var t,n,r,l,u,d,m,y,b,f,g,E,D,T,x,I,z;return i(this,(function(i){switch(i.label){case 0:return[4,h(e)];case 1:return t=i.sent(),n=t.layer,r=n.geometryType,[4,w(t)];case 2:if(l=i.sent(),!(u=l&&l.scheme))throw new s("dot-density-renderer:insufficient-info","Unable to find dot-density scheme");return d={layer:n,view:t.view,attributes:t.attributes,signal:t.signal},m={layer:t.layer,view:t.view,signal:t.signal},[4,o.all([t.trueDensity?V(d):S(d),t.outlineOptimizationEnabled?p(m):null])];case 3:return y=i.sent(),b=y[0],f=y[1],g=b.dotValue,E=b.referenceScale,D=b.minSliderValue,T=b.maxSliderValue,x=c.createColors(u.colors,t.attributes.length),I=t.attributes.map((function(e,t){return{field:e.field,valueExpression:e.valueExpression,label:e.label,valueExpressionTitle:e.valueExpressionTitle,color:x[t]}})),z=new a.DotDensityRenderer({attributes:I,dotBlendingEnabled:t.dotBlendingEnabled,outline:f?c.getSymbolOutlineFromScheme(u,r,f.opacity):null,dotValue:g,referenceScale:t.dotValueOptimizationEnabled?E:null,legendOptions:t.legendOptions}),f&&f.visualVariables&&f.visualVariables.length&&(z.visualVariables=f.visualVariables.map((function(e){return e.clone()}))),z.authoringInfo=new v({type:"dot-density",minSliderValue:D,maxSliderValue:T}),[2,{renderer:z,dotDensityScheme:u,basemapId:l.basemapId,basemapTheme:l.basemapTheme}]}}))}))}}));