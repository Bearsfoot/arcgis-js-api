// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/generatorHelper","../../../core/tsSupport/awaiterHelper","dojo/i18n!../../nls/smartMapping","../../../PopupTemplate","../../../core/Error","../../../intl/substitute","../../../popup/ExpressionInfo","../../../popup/FieldInfo","./support/utils","../statistics/support/predominanceUtils"],(function(e,n,t,i,o,r,f,s,a,l,d,p){Object.defineProperty(n,"__esModule",{value:!0});var u=o.predominantCategory,m=o.predominantCategoryValue,I=o.predominantCategoryWithChart,c=o.predominantCategoryWithTotal,x=o.predominantCategoryWithTotalAndStrength,g=o.strengthOfPredominance,b=o.marginOfVictory,v=o.listOfCategories,y=o.sumOfCategories,N=o.orderedListOfValues,h=o.basicSummary,w=o.competingFields;function C(e){return e.legendOptions&&e.legendOptions.title?e.legendOptions.title:w}function T(e){return{fieldInfo:new l({fieldName:"expression/predominant-category"}),expressionInfo:new a({name:"predominant-category",title:u,expression:p.getArcadeForPredominantCategoryAlias(e)})}}function O(e){var n=e.map((function(e){return e.fieldName}));return{fieldInfo:new l({fieldName:"expression/predominant-value",format:{digitSeparator:!0,places:1}}),expressionInfo:new a({name:"predominant-value",title:m,expression:p.getArcadeForPredominantCategoryValue(n),returnType:"number"})}}function S(e){var n=e.map((function(e){return e.fieldName}));return{fieldInfo:new l({fieldName:"expression/predominant-strength",format:{digitSeparator:!0,places:0}}),expressionInfo:new a({name:"predominant-strength",title:g,expression:p.getArcadeForStrengthOfPredominance(n),returnType:"number"})}}function F(e){return{fieldInfo:new l({fieldName:"expression/predominant-categories-list"}),expressionInfo:new a({name:"predominant-categories-list",title:v,expression:p.getArcadeForOrderedFields(e)})}}function V(e){var n=e.map((function(e){return e.fieldName}));return{fieldInfo:new l({fieldName:"expression/predominant-total",format:{digitSeparator:!0,places:0}}),expressionInfo:new a({name:"predominant-total",title:y,expression:p.getArcadeForSumOfFields(n),returnType:"number"})}}function A(e){var n=T(e.fieldInfos),t=new r({expressionInfos:[n.expressionInfo],fieldInfos:[n.fieldInfo],content:s.substitute(o.predominantCategoryContent,{expression:"<b>{"+n.fieldInfo.fieldName+"}</b>"})});return{name:"predominant-category",title:u,value:t}}function P(e){var n=e.fieldInfos,t=T(n),i=O(n),f=new r({expressionInfos:[i.expressionInfo,t.expressionInfo],fieldInfos:[i.fieldInfo,t.fieldInfo],content:s.substitute(o.predominantCategoryValueContent,{expression1:"<b>{"+t.fieldInfo.fieldName+"}</b>",expression2:"<b>{"+i.fieldInfo.fieldName+"}</b>"})});return{name:"predominant-category-value",title:m,value:f}}function M(e){var n=e.fieldInfos,t=T(n),i=O(n),f=function(e){var n=e.map((function(e){return e.fieldName}));return{fieldInfo:new l({fieldName:"expression/predominant-margin",format:{digitSeparator:!0,places:0}}),expressionInfo:new a({name:"predominant-margin",title:b,expression:p.getArcadeForPredominanceMargin(n),returnType:"number"})}}(n),d=new r({expressionInfos:[i.expressionInfo,t.expressionInfo,f.expressionInfo],fieldInfos:[i.fieldInfo,t.fieldInfo,f.fieldInfo],title:s.substitute(o.mostCommon,{expression:"{expression/predominant-category}"}),content:s.substitute(o.predominantCategoryValueMarginContent,{expression1:"<b>{"+t.fieldInfo.fieldName+"}</b>",expression2:"<b>{"+i.fieldInfo.fieldName+"}</b>",expression3:"<b>{"+f.fieldInfo.fieldName+"}</b>"})});return{name:"predominant-category-value-margin",title:b,value:d}}function z(e){var n=e.renderer,t=e.fieldInfos,i=T(t),f=O(t),a=S(t),l=new r({expressionInfos:[f.expressionInfo,i.expressionInfo,a.expressionInfo],fieldInfos:[f.fieldInfo,i.fieldInfo,a.fieldInfo],content:s.substitute(o.predominantCategoryStrengthContent,{title:C(n),expression1:"{"+f.fieldInfo.fieldName+"}",expression2:"<b>{"+i.fieldInfo.fieldName+"}</b>",expression3:"<b>{"+a.fieldInfo.fieldName+"}%</b>"})});return{name:"predominant-category-strength",title:g,value:l}}function W(e){var n=e.renderer,t=F(e.fieldInfos),i=new r({expressionInfos:[t.expressionInfo],fieldInfo:[t.fieldInfo],title:C(n),content:"{"+t.fieldInfo.fieldName+"}"});return{name:"predominant-categories-list",title:N,value:i}}function j(e){var n=e.fieldInfos,t=T(n),i=F(n),o=new r({expressionInfos:[t.expressionInfo,i.expressionInfo],fieldInfos:[t.fieldInfo,i.fieldInfo],content:[{type:"text",text:'<div><b><font size="3">{'+t.fieldInfo.fieldName+"}</font></b></div>"},{type:"text",text:"{"+i.fieldInfo.fieldName+"}"}]});return{name:"predominant-basic-summary",title:h,value:o}}function E(e){var n=e.renderer,t=e.fieldInfos,i=T(t),f=O(t),a=V(t),l=new r({expressionInfos:[f.expressionInfo,i.expressionInfo,a.expressionInfo],fieldInfos:[f.fieldInfo,i.fieldInfo,a.fieldInfo],content:s.substitute(o.predominantCategoryTotalContent,{title:C(n),expression1:"{"+f.fieldInfo.fieldName+"}",expression2:"<b>{"+i.fieldInfo.fieldName+"}</b>",expression3:"{"+a.fieldInfo.fieldName+"}"})});return{name:"predominant-category-total",title:c,value:l}}function H(e){var n=e.renderer,t=e.fieldInfos,i=T(t),f=O(t),a=S(t),l=V(t),d=new r({expressionInfos:[f.expressionInfo,i.expressionInfo,l.expressionInfo,a.expressionInfo],fieldInfos:[f.fieldInfo,i.fieldInfo,l.fieldInfo,a.fieldInfo],content:s.substitute(o.predominantCategoryTotalStrengthContent,{title:C(n),expression1:"{"+f.fieldInfo.fieldName+"}",expression2:"<b>{"+i.fieldInfo.fieldName+"}</b>",expression3:"<b>{"+a.fieldInfo.fieldName+"}%</b>",expression4:"{"+l.fieldInfo.fieldName+"}"})});return{name:"predominant-category-total-strength",title:x,value:d}}function _(e){var n=e.renderer,t=e.fieldInfos,i=T(t),o=new r({expressionInfos:[i.expressionInfo],fieldInfos:[i.fieldInfo],content:[{type:"text",text:'<div><b><font size="3">{'+i.fieldInfo.fieldName+"}</font></b></div>"},{type:"media",mediaInfos:{type:"pie-chart",title:C(n),value:{fields:t.map((function(e){return e.fieldName}))}}}]});return{name:"predominant-category-chart",title:I,value:o}}function q(e){return i(this,void 0,void 0,(function(){var n,i,o;return t(this,(function(t){switch(t.label){case 0:return n=e.renderer,[4,(i=e.layer).load()];case 1:return t.sent(),o=function(e,n){var t=e.authoringInfo,i="predominance"===t.type?t.fields:[];if(!i||!i.length)throw new f("predominance-popup:insufficient-info","unable to find input fields in authoringInfo");return i.map((function(e){return d.getFieldInfo(n,{type:"field",field:e})}))}(n,i),[2,{renderer:n,fieldInfos:o}]}}))}))}function L(e){return i(this,void 0,void 0,(function(){var n;return t(this,(function(t){switch(t.label){case 0:return[4,q(e)];case 1:return[2,[A(n=t.sent()),P(n),M(n),H(n),W(n),j(n),E(n),z(n),_(n)]]}}))}))}n.getAllTemplates=L,n.getTemplates=function(e){return i(this,void 0,void 0,(function(){var n,i,o,r,f,s;return t(this,(function(t){switch(t.label){case 0:return n=e.renderer,[4,q(e)];case 1:return i=t.sent(),o=n.hasVisualVariables("size",!1),r=n.hasVisualVariables("opacity"),f=A(i),o&&r&&(f=H(i)),o&&!r&&(f=E(i)),!o&&r&&(f=z(i)),[4,L(e)];case 2:return s=t.sent(),[2,{primaryTemplate:f,secondaryTemplates:s.filter((function(e){return e.name!==f.name}))}]}}))}))}}));