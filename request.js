// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","./core/tsSupport/assignHelper","./core/tsSupport/awaiterHelper","./core/tsSupport/generatorHelper","./config","./kernel","./core/Error","./core/global","./core/has","./core/lang","./core/promiseUtils","./core/string","./core/urlUtils","./support/requestUtils","@dojo/framework/shim/Promise"],(function(e,r,t,n,s,o,a,i,u,c,l,d,h,p,f){function m(e,r){var a=d.createAbortController();return d.create((function(i,u){(function(e,r,a){return n(this,void 0,void 0,(function(){var n,i,u,l,h,f,m;return s(this,(function(s){switch(s.label){case 0:return n=p.isDataProtocol(r),(i=p.isBlobProtocol(r))||n||(r=p.normalize(r)),u={url:r,requestOptions:t({},a)},(l=p.getInterceptor(r))?[4,C(l,u)]:[3,2];case 1:if(null!=(h=s.sent()))return[2,{data:h,getHeader:q,requestOptions:u.requestOptions,url:u.url}];l.after||l.error||(l=null),s.label=2;case 2:if(r=u.url,"image"===(a=u.requestOptions).responseType){if(c("host-webworker")||c("host-node"))throw T("request:invalid-parameters",new Error("responseType 'image' is not supported in Web Workers or Node environment"),u)}else if(n)throw T("request:invalid-parameters",new Error("Data URLs are not supported for responseType = "+a.responseType),u);if("head"===a.method){if(a.body)throw T("request:invalid-parameters",new Error("body parameter cannot be set when method is 'head'"),u);if(n||i)throw T("request:invalid-parameters",new Error("data and blob URLs are not supported for method 'head'"),u)}return[4,O()];case 3:return s.sent(),b?[2,b.execute(r,a)]:(f=d.createAbortController(),d.onAbort(e,(function(){return f.abort()})),d.onAbort(a,(function(){return f.abort()})),[4,L({controller:f,credential:null,credentialToken:null,fetchOptions:null,hasToken:!1,interceptor:l,params:u,redoRequest:!1,useIdentity:o.request.useIdentity,useProxy:!1,useSSL:!1,withCredentials:!1})]);case 4:return m=s.sent(),l&&l.after&&l.after(m),[2,m]}}))}))})(a.signal,e,r).then(i).catch(u)}),(function(){a.abort()}))}var b,g="FormData"in u,y=[499,498,403,401],w=["COM_0056","COM_0057","SB_0008"],v=[/\/arcgis\/tokens/i,/\/sharing(\/rest)?\/generatetoken/i,/\/rest\/info/i],q=function(){return null};function T(e,r,t,n){var s="Error",o={url:t.url,requestOptions:t.requestOptions,getHeader:q,ssl:!1};if(r instanceof i)return r.details?(r.details=l.clone(r.details),r.details.url=t.url,r.details.requestOptions=t.requestOptions):r.details=o,r;if(r){var a=n&&function(e){return n.headers.get(e)},u=n&&n.status,c=r.message;c&&(s=c),a&&(o.getHeader=a),o.httpStatus=(null!=r.httpCode?r.httpCode:r.code)||u||0,o.subCode=r.subcode,o.messageCode=r.messageCode,"string"==typeof r.details?o.messages=[r.details]:o.messages=r.details}var d=new i(e,s,o);return r&&"cancel"===r.dojoType&&(d.dojoType="cancel"),d}function O(){return n(this,void 0,void 0,(function(){var r;return s(this,(function(t){switch(t.label){case 0:return c("host-webworker")?b?[3,2]:[4,new Promise((function(r,t){e(["./core/workers/request"],r,t)}))]:[3,3];case 1:b=t.sent(),t.label=2;case 2:return[3,6];case 3:return m._abortableFetch?[3,6]:!c("esri-abortable-fetch")||!c("esri-native-promise")&&(c("safari")<13||c("ios")<13)?[3,4]:(m._abortableFetch=u.fetch.bind(u),[3,6]);case 4:return r=m,[4,new Promise((function(r,t){e(["whatwg-fetch"],r,t)}))];case 5:r._abortableFetch=t.sent().fetch,t.label=6;case 6:return[2]}}))}))}function S(){return n(this,void 0,void 0,(function(){return s(this,(function(r){switch(r.label){case 0:return a.id?[3,2]:[4,new Promise((function(r,t){e(["./identity/IdentityManager"],r,t)}))];case 1:r.sent(),r.label=2;case 2:return[2]}}))}))}function k(e){return n(this,void 0,void 0,(function(){var r,t,n,o,i,c,l,h;return s(this,(function(s){switch(s.label){case 0:return r=e.params.url,t=e.params.requestOptions,n=e.controller.signal,o=t.body,i=null,c=null,l=null,g&&"HTMLFormElement"in u&&(o instanceof FormData?i=o:o instanceof HTMLFormElement&&(c=o,i=new FormData(c))),"string"==typeof o&&(l=o),e.fetchOptions={cache:t.cacheBust&&!m._abortableFetch.polyfill?"no-cache":"default",credentials:"same-origin",headers:t.headers||{},method:"head"===t.method?"HEAD":"GET",mode:"cors",redirect:"follow",signal:n},(i||l)&&(e.fetchOptions.body=i||l),"anonymous"===t.authMode&&(e.useIdentity=!1),e.hasToken=!!(/token=/i.test(r)||t.query&&t.query.token||i&&i.get&&i.get("token")||c&&c.elements.token),!e.useIdentity||e.hasToken||e.credentialToken||x(r)||d.isAborted(n)?[3,11]:(h=void 0,"immediate"!==t.authMode?[3,3]:[4,S()]);case 1:return s.sent(),[4,a.id.getCredential(r,{signal:n})];case 2:return h=s.sent(),e.credential=h,[3,10];case 3:return"no-prompt"!==t.authMode?[3,9]:[4,S()];case 4:s.sent(),s.label=5;case 5:return s.trys.push([5,7,,8]),[4,a.id.getCredential(r,{prompt:!1,signal:n})];case 6:return h=s.sent(),e.credential=h,[3,8];case 7:return s.sent(),[3,8];case 8:return[3,10];case 9:a.id&&(h=a.id.findCredential(r)),s.label=10;case 10:h&&(e.credentialToken=h.token,e.useSSL=!!h.ssl),s.label=11;case 11:return[2]}}))}))}function x(e){return v.some((function(r){return r.test(e)}))}function P(e){return n(this,void 0,void 0,(function(){var r,n,i,u,l,f,b,y,w,v,q,O,S,k,x,P,C,L,U,F,I,_;return s(this,(function(s){switch(s.label){case 0:if(r=e.params.url,n=e.params.requestOptions,i=e.fetchOptions,u=p.isBlobProtocol(r)||p.isDataProtocol(r),l=n.responseType||"json",f=u?0:null!=n.timeout?n.timeout:o.request.timeout,b=!1,!u){if(e.useSSL&&(r=p.toHTTPS(r)),n.cacheBust&&"default"===i.cache&&(r=p.addQueryParameter(r,"request.preventCache",Date.now())),y=t({},n.query),e.credentialToken&&(y.token=e.credentialToken),w=p.objectToQuery(y),c("esri-url-encodes-apostrophe")&&(w=w.replace(/'/g,"%27")),v=r.length+1+w.length,q=void 0,b="post"===n.method||!!n.body||v>o.request.maxUrlLength,(O=n.useProxy||!!p.getProxyRule(r))&&(S=p.getProxyUrl(r),q=S.path,!b&&q.length+1+v>o.request.maxUrlLength&&(b=!0),S.query&&(y=t({},S.query,y))),"HEAD"===i.method&&(b||O)){if(b){if(v>o.request.maxUrlLength)throw T("request:invalid-parameters",new Error("URL exceeds maximum length"),e.params);throw T("request:invalid-parameters",new Error("cannot use POST request when method is 'head'"),e.params)}if(O)throw T("request:invalid-parameters",new Error("cannot use proxy when method is 'head'"),e.params)}b?(i.method="POST",n.body?r=p.addQueryParameters(r,y):(i.body=p.objectToQuery(y),i.headers["Content-Type"]="application/x-www-form-urlencoded")):r=p.addQueryParameters(r,y),O&&(e.useProxy=!0,r=q+"?"+r),y.token&&g&&i.body instanceof FormData&&((k=i.body).set?k.set("token",y.token):k.append("token",y.token)),n.hasOwnProperty("withCredentials")?e.withCredentials=n.withCredentials:p.isTrustedServer(r)?e.withCredentials=!0:a.id&&(x=a.id.findServerInfo(r))&&x.webTierAuth&&(e.withCredentials=!0),e.withCredentials&&(i.credentials="include")}P=0,C=!1,f>0&&(P=setTimeout((function(){C=!0,e.controller.abort()}),f)),s.label=1;case 1:return s.trys.push([1,18,19,20]),"image"!==n.responseType||"default"!==i.cache||"GET"!==i.method||b||function(e){if(e)for(var r=0,t=Object.getOwnPropertyNames(e);r<t.length;r++){var n=t[r];if(e[n])return!0}return!1}(n.headers)||!u&&!e.useProxy&&o.request.proxyUrl&&(j=r,(A=p.getOrigin(j))&&!h.endsWith(A,".arcgis.com")&&-1===m._corsServers.indexOf(A)&&!p.isTrustedServer(A))?[3,3]:[4,D(r,e)];case 2:return U=s.sent(),[3,17];case 3:return[4,m._abortableFetch(r,i)];case 4:if(L=s.sent(),e.useProxy||function(e){if(!p.isBlobProtocol(e)&&!p.isDataProtocol(e)){var r=p.getOrigin(e);r&&-1===m._corsServers.indexOf(r)&&m._corsServers.push(r)}}(r),!L.ok||"HEAD"===i.method)return[3,17];switch(l){case"array-buffer":return[3,5];case"blob":case"image":return[3,7]}return[3,9];case 5:return[4,L.arrayBuffer()];case 6:return U=s.sent(),[3,11];case 7:return[4,L.blob()];case 8:return U=s.sent(),[3,11];case 9:return[4,L.text()];case 10:return U=s.sent(),[3,11];case 11:if(P&&(clearTimeout(P),P=0),"json"===l||"xml"===l||"document"===l)if(U)switch(l){case"json":U=JSON.parse(U);break;case"xml":U=E(U,"application/xml");break;case"document":U=E(U,"text/html")}else U=null;if(F=L.headers.get("Content-Type"),!/application\/json|text\/plain/i.test(F)||!(U instanceof ArrayBuffer&&U.byteLength<=750||U instanceof Blob&&U.size<=750))return[3,15];s.label=12;case 12:return s.trys.push([12,14,,15]),[4,new Response(U).json()];case 13:return(I=s.sent()).error&&(U=I),[3,15];case 14:return s.sent(),[3,15];case 15:return"image"===l&&U instanceof Blob?[4,D(URL.createObjectURL(U),e,!0)]:[3,17];case 16:U=s.sent(),s.label=17;case 17:return[3,20];case 18:if("AbortError"===(_=s.sent()).name){if(C)throw new Error("Timeout exceeded");throw d.createAbortError("Request canceled")}if(!(!L&&_ instanceof TypeError&&o.request.proxyUrl)||n.body||"post"===n.method||"head"===n.method||e.useProxy)throw _;return(e.redoRequest=!0,p.addProxyRule({proxyUrl:o.request.proxyUrl,urlPrefix:p.removeFile(p.urlToObject(r).path)}),[3,20]);case 19:return P&&clearTimeout(P),[7];case 20:return[2,[L,U]]}var j,A}))}))}function C(e,r){return n(this,void 0,void 0,(function(){var n,o,a;return s(this,(function(s){switch(s.label){case 0:if(null!=e.responseData)return[2,e.responseData];if(e.headers&&(r.requestOptions.headers=t({},r.requestOptions.headers,e.headers)),e.query&&(r.requestOptions.query=t({},r.requestOptions.query,e.query)),!e.before)return[3,5];n=void 0,o=void 0,s.label=1;case 1:return s.trys.push([1,3,,4]),[4,e.before(r)];case 2:return o=s.sent(),[3,4];case 3:return a=s.sent(),n=T("request:interceptor",a,r),[3,4];case 4:if((o instanceof Error||o instanceof i)&&(n=T("request:interceptor",o,r)),n)throw e.error&&e.error(n),n;return[2,o];case 5:return[2]}}))}))}function E(e,r){var t;try{t=(new DOMParser).parseFromString(e,r)}catch(e){}if(!t||t.getElementsByTagName("parsererror").length)throw new SyntaxError("XML Parse error");return t}function L(e){return n(this,void 0,void 0,(function(){var r,t,n,i,u,c,l,d,h,f,m;return s(this,(function(s){switch(s.label){case 0:return[4,k(e)];case 1:s.sent(),s.label=2;case 2:s.trys.push([2,8,,9]),s.label=3;case 3:return[4,P(e)];case 4:r=s.sent(),t=r[0],n=r[1],s.label=5;case 5:return[4,U(e,t,n)];case 6:if(!s.sent())return[3,3];s.label=7;case 7:return[3,9];case 8:throw i=s.sent(),(u=T("request:server",i,e.params,t)).details.ssl=e.useSSL,e.interceptor&&e.interceptor.error&&e.interceptor.error(u),u;case 9:return c=e.params.url,/\/sharing\/rest\/(accounts|portals)\/self/i.test(c)&&!e.hasToken&&!e.credentialToken&&n&&n.user&&n.user.username&&!p.isTrustedServer(c)&&(l=p.getOrigin(c,!0))&&o.request.trustedServers.push(l),(d=e.credential)&&a.id&&(h=a.id.findServerInfo(d.server),(f=h&&h.owningSystemUrl)&&(f=f.replace(/\/?$/,"/sharing"),(m=a.id.findCredential(f,d.userId))&&-1===a.id._getIdenticalSvcIdx(f,m)&&m.resources.unshift(f))),[2,{data:n,getHeader:t?function(e){return t.headers.get(e)}:q,requestOptions:e.params.requestOptions,ssl:e.useSSL,url:e.params.url}]}}))}))}function U(e,r,t){return n(this,void 0,void 0,(function(){var n,o,i,u,c,d,h;return s(this,(function(s){switch(s.label){case 0:if(e.redoRequest)return e.redoRequest=!1,[2,!1];if(!r)return[2,!0];if(!r.ok)throw new Error("Unable to load "+r.url+" status: "+r.status);return t&&t.error&&(n=l.mixin(new Error,t.error)),n&&(o=Number(n.code),i=n.hasOwnProperty("subcode")?Number(n.subcode):null,u=(u=n.messageCode)&&u.toUpperCase()),c=e.params.requestOptions.authMode,403===o&&(4===i||n.message&&n.message.toLowerCase().indexOf("ssl")>-1&&-1===n.message.toLowerCase().indexOf("permission"))?e.useSSL?[3,6]:(e.useSSL=!0,[2,!1]):[3,1];case 1:return!e.useIdentity||"no-prompt"===c&&498!==o||-1===y.indexOf(o)||x(e.params.url)||!(403!==o||-1===w.indexOf(u)&&(null==i||2===i&&e.credentialToken))?[3,6]:[4,S()];case 2:s.sent(),s.label=3;case 3:return s.trys.push([3,5,,6]),[4,a.id.getCredential(e.params.url,{error:T("request:server",n,e.params),prompt:"no-prompt"!==c,signal:e.controller.signal,token:e.credentialToken})];case 4:return d=s.sent(),e.credential=d,e.credentialToken=d.token,e.useSSL=e.useSSL||d.ssl,[2,!1];case 5:return h=s.sent(),"no-prompt"===c?(e.credential=null,e.credentialToken=null,[2,!1]):(n=h,[3,6]);case 6:if(n)throw n;return[2,!0]}}))}))}function D(e,r,t){void 0===t&&(t=!1);var n=r.controller.signal,s=new Image;return r.withCredentials?s.crossOrigin="use-credentials":s.crossOrigin="anonymous",s.alt="",s.src=e,f.loadImageAsync(s,e,t,n)}return m._abortableFetch=null,m._corsServers=["https://server.arcgisonline.com","https://services.arcgisonline.com"],m}));